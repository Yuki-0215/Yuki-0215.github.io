
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Project documentation with Markdown.">
      
      
        <meta name="author" content="Li">
      
      
        <link rel="canonical" href="https://yuki-0215.github.io/2.k8s/monitoring/2025-12-24-Prometheus_Learning_Notes/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-8.0.0">
    
    
      
        <title>kubernetes 监控学习笔记 - Kubernetes 进阶训练营</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.ad626c1e.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/custom.css">
    
    <script>function __md_scope(e,t,_){return new URL(_||(t===localStorage?"../../..":"../../.."),location).pathname+"."+e}function __md_get(e,t=localStorage,_){return JSON.parse(t.getItem(__md_scope(e,t,_)))}function __md_set(e,t,_=localStorage,o){try{_.setItem(__md_scope(e,_,o),JSON.stringify(t))}catch(e){}}</script>
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prometheus" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="Kubernetes 进阶训练营" class="md-header__button md-logo" aria-label="Kubernetes 进阶训练营" data-md-component="logo">
      
  <img src="../../../material/logo.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kubernetes 进阶训练营
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              kubernetes 监控学习笔记
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换暗色主题"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="切换暗色主题" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="切换亮色主题"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="切换亮色主题" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Yuki-0215/Yuki-0215.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      首页
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../0.Internet/2024-02-20-Tcp-ip-docs/" class="md-tabs__link">
        0、网络基础
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../1.Linux/hardware/1-2025-04-03-Hardware-cpu-benchmark-report-doc/" class="md-tabs__link">
        1、Linux
      </a>
    </li>
  

  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%91%E5%8E%9F%E7%94%9F/" class="md-tabs__link md-tabs__link--active">
        2、kubernetes
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../3.develop/python/2024-02-20-1-python-base-doc/" class="md-tabs__link">
        3、运维开发
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../4.database/mysql/2024-02-20-1-mysql-base-doc/" class="md-tabs__link">
        4、数据库
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../5.Storage/2024-02-20-disk-ssd-docs/" class="md-tabs__link">
        5、存储服务
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../6.Devops/2024-9-26-Git-docs/" class="md-tabs__link">
        6、Devops
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../7.Web/http/1-2025-03-30-http-web-doc/" class="md-tabs__link">
        7、Web
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-case1/" class="md-tabs__link">
        8、运维自动化
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../9.other/rustdesk/2026-01-06-%E8%87%AA%E5%BB%BARustDesk%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%99%E7%A8%8B/" class="md-tabs__link">
        9、其他
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../10.Ai-tools/cursor/2024-02-27-cursor-latest-features/" class="md-tabs__link">
        10、Ai
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../20.mylife/2024-9-24-myblog-life-docs/" class="md-tabs__link">
        关于我
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Kubernetes 进阶训练营" class="md-nav__button md-logo" aria-label="Kubernetes 进阶训练营" data-md-component="logo">
      
  <img src="../../../material/logo.jpg" alt="logo">

    </a>
    Kubernetes 进阶训练营
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Yuki-0215/Yuki-0215.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        首页
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" data-md-state="indeterminate" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          0、网络基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="0、网络基础" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          0、网络基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-Tcp-ip-docs/" class="md-nav__link">
        网络 Tcp/IP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-5g-docs/" class="md-nav__link">
        网络 思科设备
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-IB-ET-docs/" class="md-nav__link">
        网络 网卡模式调整
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-ZeroTier/" class="md-nav__link">
        ZeroTier组网
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-frp/" class="md-nav__link">
        frp 内网穿透
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-3-network-docs/" class="md-nav__link">
        kubernetes 网络组件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-4-network-docs/" class="md-nav__link">
        科学上网
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/asus/asus-docs.md" class="md-nav__link">
        华硕服务器
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" data-md-state="indeterminate" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          1、Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="1、Linux" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          1、Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" data-md-state="indeterminate" type="checkbox" id="__nav_3_1" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Linux 服务器验收
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux 服务器验收" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Linux 服务器验收
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/1-2025-04-03-Hardware-cpu-benchmark-report-doc/" class="md-nav__link">
        Linux 服务器 CPU性能测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/2-2025-04-04-Hardware-memary-report-doc/" class="md-nav__link">
        Linux 服务器 内存性能验收
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/3-2025-04-04-Hareware-disk-benchmark-report-doc/" class="md-nav__link">
        Linux 服务器 硬盘性能验收
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/4-2025-04-04-Hardware-GPU-benchmark-report-doc/" class="md-nav__link">
        Linux 服务器 GPU性能验收
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/5-2025-04-04-Hareware-H100-report-doc/" class="md-nav__link">
        Linux 服务器 H100服务器验收
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/6-2025-04-04-Hardware-FAQ-disk-report-doc/" class="md-nav__link">
        Linux 服务器 FAQ:为什么系统显示的磁盘大小会比实际小?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/7-2025-04-06-Hardware-FAQ-no-network-debug-doc/" class="md-nav__link">
        Linux 服务器 无网络环境调试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" data-md-state="indeterminate" type="checkbox" id="__nav_3_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Linux系统管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux系统管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Linux系统管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-kjc-doc/" class="md-nav__link">
        Linux 云计算手册大纲
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/2024-02-20-cpu-doc/" class="md-nav__link">
        Linux 硬件 CPU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-bmc-doc/" class="md-nav__link">
        Linux 带外管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-install-doc/" class="md-nav__link">
        Linux 系统安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/2025-03-27-linux-SM-doc-01/" class="md-nav__link">
        Linux 系统管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/2025-03-27-linux-SM-doc-02/" class="md-nav__link">
        Linux 系统管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-mirror-doc/" class="md-nav__link">
        Linux 国内apt源
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-nvme-doc/" class="md-nav__link">
        Linux nvme磁盘管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-parted-doc/" class="md-nav__link">
        Linux parted磁盘管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-reboot-doc/" class="md-nav__link">
        Linux 系统强制重启
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-disk-doc/" class="md-nav__link">
        Linux 磁盘管理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" data-md-state="indeterminate" type="checkbox" id="__nav_3_3" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_3">
          Linux服务管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux服务管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Linux服务管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-network-doc/" class="md-nav__link">
        Linux 网络服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/2024-9-25-ssh-proxy-docs/" class="md-nav__link">
        Linux SSH 转发代理实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ekgc/1-2025-04-11-rsync-to-ceph-doc/" class="md-nav__link">
        Linux rsync 实现ceph文件同步
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" data-md-state="indeterminate" type="checkbox" id="__nav_3_4" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_4">
          Windows 系统服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Windows 系统服务" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Windows 系统服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/windows/1-2025-04-16-windows-jumpserver-doc/" class="md-nav__link">
        Windows 跳板机
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5" data-md-state="indeterminate" type="checkbox" id="__nav_3_5" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_5">
          笔记-SRE运维
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="笔记-SRE运维" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          笔记-SRE运维
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/1-2025-04-04-linux-basic-introduction-doc.md" class="md-nav__link">
        Linux基础入门
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/2-2025-04-04-shell-script-programming-doc.md" class="md-nav__link">
        Shell脚本编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/6-文本处理工具和正则表达式/6-2025-04-04-linux-file-io-redirect-doc.md" class="md-nav__link">
        文本处理工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/4-2025-04-04-regular-expressions-doc.md" class="md-nav__link">
        正则表达式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/5-2025-04-04-filesystem-management-doc.md" class="md-nav__link">
        文件系统管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/6-2025-04-04-package-management-doc.md" class="md-nav__link">
        软件包管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/7-2025-04-04-ACL-user-group-doc/" class="md-nav__link">
        用户和组权限管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/8-2025-04-04-process-management-doc.md" class="md-nav__link">
        进程管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/9-2025-04-04-memory-management-doc.md" class="md-nav__link">
        内存管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/10-2025-04-04-scheduled-tasks-doc.md" class="md-nav__link">
        计划任务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/31%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/31-2025-04-04-linux-log-management-doc/" class="md-nav__link">
        日志服务管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/11-2025-04-04-network-basics-doc.md" class="md-nav__link">
        网络基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/12-2025-04-04-network-configuration-doc.md" class="md-nav__link">
        网络配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/13-2025-04-04-dns-service-doc.md" class="md-nav__link">
        DNS服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/14-2025-04-04-ftp-service-doc.md" class="md-nav__link">
        FTP服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/15-2025-04-04-nfs-service-doc.md" class="md-nav__link">
        NFS服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/16-2025-04-04-samba-service-doc.md" class="md-nav__link">
        Samba服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/17-2025-04-04-dhcp-service-doc.md" class="md-nav__link">
        DHCP服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/18-2025-04-04-apache-service-doc.md" class="md-nav__link">
        Apache服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/19-2025-04-04-nginx-service-doc.md" class="md-nav__link">
        Nginx服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/20-2025-04-04-mysql-basics-doc.md" class="md-nav__link">
        MySQL基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/21-2025-04-04-mysql-management-doc.md" class="md-nav__link">
        MySQL管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/22-2025-04-04-mysql-optimization-doc.md" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/23-2025-04-04-mysql-backup-recovery-doc.md" class="md-nav__link">
        MySQL备份恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/24-2025-04-04-mysql-master-slave-doc.md" class="md-nav__link">
        MySQL主从复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/25-2025-04-04-mysql-high-availability-doc.md" class="md-nav__link">
        MySQL高可用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/26-2025-04-04-lvs-load-balancing-doc.md" class="md-nav__link">
        LVS负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/27-2025-04-04-keepalived-ha-doc.md" class="md-nav__link">
        Keepalived高可用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/28-2025-04-04-haproxy-load-balancing-doc.md" class="md-nav__link">
        HAProxy负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/29-2025-04-04-shell-advanced-programming-doc.md" class="md-nav__link">
        Shell高级编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/30-2025-04-04-python-basics-doc.md" class="md-nav__link">
        Python基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/31-2025-04-04-python-advanced-doc.md" class="md-nav__link">
        Python进阶
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/32-2025-04-04-python-network-programming-doc.md" class="md-nav__link">
        Python网络编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/33-2025-04-04-python-web-development-doc.md" class="md-nav__link">
        Python Web开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/34-2025-04-04-django-framework-doc.md" class="md-nav__link">
        Django框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/35-2025-04-04-devops-platform-development-doc.md" class="md-nav__link">
        运维平台开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/36-2025-04-04-jenkins-ci-doc.md" class="md-nav__link">
        Jenkins持续集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/37-2025-04-04-git-version-control-doc.md" class="md-nav__link">
        Git版本控制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/38-2025-04-04-docker-container-tech-doc.md" class="md-nav__link">
        Docker容器技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/39-2025-04-04-kubernetes-basics-doc.md" class="md-nav__link">
        Kubernetes基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/40-2025-04-04-elk-log-analysis-doc.md" class="md-nav__link">
        ELK日志分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/41-2025-04-04-prometheus-monitoring-doc.md" class="md-nav__link">
        Prometheus监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/42-2025-04-04-redis-caching-tech-doc.md" class="md-nav__link">
        Redis缓存技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/43-2025-04-04-redis-master-slave-recovery-doc/" class="md-nav__link">
        Redis主从复制故障恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/44-2025-04-04-redis-data-migration-cluster-doc/" class="md-nav__link">
        Redis数据迁移与集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/45-2025-04-04-zabbix-enterprise-monitor1-doc/" class="md-nav__link">
        Zabbix分布式监控(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/46-2025-04-04-zabbix-enterprise-monitor2-doc/" class="md-nav__link">
        Zabbix分布式监控(二)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_6" data-md-state="indeterminate" type="checkbox" id="__nav_3_6" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_6">
          笔记-SRE-CTO
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="笔记-SRE-CTO" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_6">
          <span class="md-nav__icon md-icon"></span>
          笔记-SRE-CTO
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/01-2025-04-04-nginx-basic-introduction-doc/" class="md-nav__link">
        Nginx基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/02-2025-04-04-haproxy-basic-introduction-doc/" class="md-nav__link">
        HAProxy基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/03-2025-04-04-keepalived-basic-introduction-doc/" class="md-nav__link">
        Keepalived基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/04-2025-04-04-kvm-virtualization-doc/" class="md-nav__link">
        KVM虚拟化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/05-2025-04-04-vmware-vsphere-introduction-doc/" class="md-nav__link">
        VMware vSphere
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/06-2025-04-04-docker-container-doc/" class="md-nav__link">
        Docker容器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/07-2025-04-04-jumpserver-introduction-doc/" class="md-nav__link">
        JumpServer跳板机
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/08-2025-04-04-kubernetes-basic-doc/" class="md-nav__link">
        Kubernetes基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/09-2025-04-04-redis-distributed-storage-doc/" class="md-nav__link">
        Redis分布式存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/10-2025-04-04-zabbix-distributed-monitor-doc/" class="md-nav__link">
        Zabbix分布式监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/11-2025-04-04-jenkins-gitlab-cicd-doc/" class="md-nav__link">
        Jenkins与GitLab CI/CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/12-2025-04-04-message-queue-microservice-doc/" class="md-nav__link">
        消息队列与微服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/13-2025-04-04-elk-log-collection-doc/" class="md-nav__link">
        ELK日志收集
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/14-2025-04-04-ceph-distributed-storage-doc/" class="md-nav__link">
        Ceph分布式存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/15-2025-04-04-interview-notes-questions-doc/" class="md-nav__link">
        面试注意事项
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/16-2025-04-04-kubernetes-production-cases-doc/" class="md-nav__link">
        Kubernetes生产案例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/17-2025-04-04-aliyun-cloud-platform-doc/" class="md-nav__link">
        阿里云平台
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_7" data-md-state="indeterminate" type="checkbox" id="__nav_3_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_7">
          笔记-云原生
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="笔记-云原生" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_7">
          <span class="md-nav__icon md-icon"></span>
          笔记-云原生
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/01-2025-04-04-computer-basics-doc/" class="md-nav__link">
        计算机基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/02-2025-04-04-basic-regular-expression-doc/" class="md-nav__link">
        基本正则表达式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/03-2025-04-04-docker-practice1-doc/" class="md-nav__link">
        Docker实践(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/04-2025-04-04-docker-practice2-doc/" class="md-nav__link">
        Docker实践(二)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/05-2025-04-04-docker-practice3-doc/" class="md-nav__link">
        Docker实践(三)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/06-2025-04-04-docker-compose-examples-doc/" class="md-nav__link">
        Docker-Compose示例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/07-2025-04-04-docker-practice4-doc/" class="md-nav__link">
        Docker实践(四)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/08-2025-04-04-docker-practice5-doc/" class="md-nav__link">
        Docker实践(五)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/09-2025-04-04-docker-basic-doc/" class="md-nav__link">
        Docker基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/10-2025-04-04-docker-k8s-integration-doc/" class="md-nav__link">
        Docker与K8s集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/11-2025-04-04-kubernetes-practice1-doc/" class="md-nav__link">
        Kubernetes实践(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/12-2025-04-04-kubernetes-practice2-doc/" class="md-nav__link">
        Kubernetes实践(二)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/13-2025-04-04-kubernetes-practice3-doc/" class="md-nav__link">
        Kubernetes实践(三)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/14-2025-04-04-network-communication-doc/" class="md-nav__link">
        网络通信详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/15-2025-04-04-rbac-access-control-doc/" class="md-nav__link">
        RBAC权限控制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/16-2025-04-04-kubernetes-basic-doc/" class="md-nav__link">
        Kubernetes基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/17-2025-04-04-prometheus-deployment-doc/" class="md-nav__link">
        Prometheus部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/18-2025-04-04-monitoring-metrics-storage-doc/" class="md-nav__link">
        监控指标存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/19-2025-04-04-chain-tracking-skywalking-doc/" class="md-nav__link">
        链路追踪Skywalking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/20-2025-04-04-ceph-deployment-maintenance-doc/" class="md-nav__link">
        Ceph部署维护
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/21-2025-04-04-ceph-basic-doc/" class="md-nav__link">
        Ceph基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/22-2025-04-04-microservice-envoy1-doc/" class="md-nav__link">
        微服务与Envoy实战(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/23-2025-04-04-envoy-practice2-doc/" class="md-nav__link">
        Envoy实战(二)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/24-2025-04-04-microservice-envoy3-doc/" class="md-nav__link">
        微服务与Envoy实战(三)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/25-2025-04-04-service-mesh-istio-doc/" class="md-nav__link">
        服务网格Istio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/26-2025-04-04-istio-traffic-management-doc/" class="md-nav__link">
        Istio流量管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/27-2025-04-04-istio-security-auth-doc/" class="md-nav__link">
        Istio遥测与安全认证
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/28-2025-04-04-istio-authorization-deployment-doc/" class="md-nav__link">
        Istio授权机制与部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/29-2025-04-04-serverless-knative1-doc/" class="md-nav__link">
        Serverless与Knative
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/31-2025-04-04-gitops-tekton-doc/" class="md-nav__link">
        GitOps之Tekton
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/32-2025-04-04-gitops-argocd1-doc/" class="md-nav__link">
        GitOps之ArgoCD(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/33-2025-04-04-gitops-argocd2-doc/" class="md-nav__link">
        GitOps之ArgoCD(二)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/34-2025-04-04-kubernetes-high-availability-doc/" class="md-nav__link">
        Kubernetes高可用实现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_8" data-md-state="indeterminate" type="checkbox" id="__nav_3_8" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_8">
          虚拟化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="虚拟化" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_8">
          <span class="md-nav__icon md-icon"></span>
          虚拟化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/promox/1-2025-03-29-promox-doc/" class="md-nav__link">
        Proxmox虚拟化
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          2、kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="2、kubernetes" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          2、kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%91%E5%8E%9F%E7%94%9F/" class="md-nav__link">
        什么是云原生
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/cncf-docs/" class="md-nav__link">
        云原生简介及CNCF
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2025-03-27-containerd-cli-docs/" class="md-nav__link">
        Containerd 基本管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/containerd/2024-04-08-containerd-remove-none-tag-image-doc/" class="md-nav__link">
        Containerd 镜像管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2024-02-20-docker-docs/" class="md-nav__link">
        Docker 基本管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/lxcfs.md" class="md-nav__link">
        lxcfs 介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2024-02-20-docker-images-docs/" class="md-nav__link">
        docker 镜像构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2024-02-20-docker-proxy-docs/" class="md-nav__link">
        docker proxy代理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2024-02-20-docker-image-clash-docs/" class="md-nav__link">
        docker Clash代理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../base/k8s-overview/" class="md-nav__link">
        kubernetes 简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-3-k8s-systeminit-docs/" class="md-nav__link">
        kubernetes 集群部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2025-12-2-k8s-delete-namespace-docs/" class="md-nav__link">
        kubernetes 强制删除namespace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-9-19-k8s-update/" class="md-nav__link">
        kubernetes 集群升级
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-pod-base-docs/" class="md-nav__link">
        kubernetes pod 基础原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-pod-hook-docs/" class="md-nav__link">
        kubernetes pod 生命周期
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/6-kubernetes-etcd-docs/" class="md-nav__link">
        kubernetes etcd 简介与实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/7-kubernetes-coredns-docs/" class="md-nav__link">
        kubernetes coredns 简介与实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-calico-docs/" class="md-nav__link">
        kubernetes calico 网络
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2025-12-10-k8s-secret-docs/" class="md-nav__link">
        kubernetes secret 管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../yaml/yaml/" class="md-nav__link">
        kubernetes 资源清单
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../base/k8s-limit-docs/" class="md-nav__link">
        kubernetes 资源限制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-configmap-docs/" class="md-nav__link">
        kubernetes 配置管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/5-kubernetes-UI-docs/" class="md-nav__link">
        Kubernetes UI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-deploy-sts-ds-docs/" class="md-nav__link">
        kubernetes 控制器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../network/ingress-%E6%B5%81%E9%87%8F/" class="md-nav__link">
        Ingress 流量
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../network/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" class="md-nav__link">
        服务发现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../network/gateway-api/" class="md-nav__link">
        Gateway API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../network/dns-%E4%BC%98%E5%8C%96/" class="md-nav__link">
        DNS 优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../network/ingress-nginx/" class="md-nav__link">
        ingress-nginx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../network/service-profiles/" class="md-nav__link">
        Service Profiles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../network/4-network-docs.md" class="md-nav__link">
        科学上网
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-pv-rep/" class="md-nav__link">
        kubernetes pv/pvc简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-mon-docs/" class="md-nav__link">
        kubernetes 监控服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-logs-docs/" class="md-nav__link">
        kubernetes 日志管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-istio-docs/" class="md-nav__link">
        kubernetes 服务网格
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ui/rancher-update-docs/" class="md-nav__link">
        kubernetes Rancher 升级
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/7-kubernetes-update-docs/" class="md-nav__link">
        kubernetes 节点维护
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../other/k8s-ca-docs/" class="md-nav__link">
        kubernetes 处理k8s证书过期
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/" class="md-nav__link">
        kubernete 日志架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/" class="md-nav__link">
        kubernetes EFK日志系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/3.k8s/7.logging/fluentd.md" class="md-nav__link">
        kubernete 日志fluentd
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/loki/" class="md-nav__link">
        kubernete Loki
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        kubernetes 日志读写分离模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        kubernetes 日志微服务模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" class="md-nav__link">
        kubernetes 日志配置文件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E6%97%A5%E5%BF%97%E6%8A%A5%E8%AD%A6/" class="md-nav__link">
        kubernetes 日志报警
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/logql/" class="md-nav__link">
        kubernetes 日志 Logql
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ansible-install-k8s-docs.md" class="md-nav__link">
        kubernetes 自动化安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-4-ansible-install-k8s/" class="md-nav__link">
        kubernetes 项目一
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/9-install-keepalived-cluster/" class="md-nav__link">
        kubernetes 项目二
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_51" data-md-state="indeterminate" type="checkbox" id="__nav_4_51" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_51">
          kubernetes 网络管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="kubernetes 网络管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_51">
          <span class="md-nav__icon md-icon"></span>
          kubernetes 网络管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../network/2025-12-24-kubernetes-network-learning_Notes/" class="md-nav__link">
        kubernetes 网络学习笔记
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_52" type="checkbox" id="__nav_4_52" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_52">
          kubernetes 监控管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="kubernetes 监控管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_52">
          <span class="md-nav__icon md-icon"></span>
          kubernetes 监控管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          kubernetes 监控学习笔记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        kubernetes 监控学习笔记
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    一、Introduction (简介)
  </a>
  
    <nav class="md-nav" aria-label="一、Introduction (简介)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-overview" class="md-nav__link">
    1.1 Overview (概览)
  </a>
  
    <nav class="md-nav" aria-label="1.1 Overview (概览)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus_1" class="md-nav__link">
    什么是 Prometheus?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    主要特性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    什么是指标（Metrics）？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    组件架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    架构图
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    适用场景
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-first-steps" class="md-nav__link">
    1.2 First Steps (入门步骤)
  </a>
  
    <nav class="md-nav" aria-label="1.2 First Steps (入门步骤)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus_2" class="md-nav__link">
    下载 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_3" class="md-nav__link">
    配置 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_4" class="md-nav__link">
    启动 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    使用表达式浏览器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    使用图形界面
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    监控其他目标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-comparison" class="md-nav__link">
    1.3 Comparison (与其他监控系统对比)
  </a>
  
    <nav class="md-nav" aria-label="1.3 Comparison (与其他监控系统对比)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-graphite" class="md-nav__link">
    Prometheus vs. Graphite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-influxdb" class="md-nav__link">
    Prometheus vs. InfluxDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-opentsdb" class="md-nav__link">
    Prometheus vs. OpenTSDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-nagios" class="md-nav__link">
    Prometheus vs. Nagios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-sensu" class="md-nav__link">
    Prometheus vs. Sensu
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concepts" class="md-nav__link">
    二、Concepts (核心概念)
  </a>
  
    <nav class="md-nav" aria-label="二、Concepts (核心概念)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-data-model" class="md-nav__link">
    2.1 Data Model (数据模型)
  </a>
  
    <nav class="md-nav" aria-label="2.1 Data Model (数据模型)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    时间序列数据
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    指标名称和标签
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samples" class="md-nav__link">
    样本（Samples）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notation" class="md-nav__link">
    表示法（Notation）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-metric-types" class="md-nav__link">
    2.2 Metric Types (指标类型)
  </a>
  
    <nav class="md-nav" aria-label="2.2 Metric Types (指标类型)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#counter" class="md-nav__link">
    Counter (计数器)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gauge" class="md-nav__link">
    Gauge (仪表)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#histogram" class="md-nav__link">
    Histogram (直方图)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary (摘要)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-jobs-and-instances" class="md-nav__link">
    2.3 Jobs and Instances (任务与实例)
  </a>
  
    <nav class="md-nav" aria-label="2.3 Jobs and Instances (任务与实例)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    基本概念
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    自动生成的标签和时间序列
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    自动生成的指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server" class="md-nav__link">
    三、Server (服务器)
  </a>
  
    <nav class="md-nav" aria-label="三、Server (服务器)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-getting-started" class="md-nav__link">
    3.1 Getting Started (快速开始)
  </a>
  
    <nav class="md-nav" aria-label="3.1 Getting Started (快速开始)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus_5" class="md-nav__link">
    下载和运行 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_6" class="md-nav__link">
    配置 Prometheus 监控自身
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_7" class="md-nav__link">
    启动 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    使用表达式浏览器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    使用图形界面
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    启动示例目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_8" class="md-nav__link">
    配置 Prometheus 监控示例目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    配置聚合规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    重新加载配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    优雅关闭实例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-installation" class="md-nav__link">
    3.2 Installation (安装)
  </a>
  
    <nav class="md-nav" aria-label="3.2 Installation (安装)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    安装方式概览
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    方式一：使用预编译二进制文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    方式二：从源码编译
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    方式三：使用 Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker_1" class="md-nav__link">
    Docker 高级配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker_2" class="md-nav__link">
    Docker 部署完整示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    安装方式对比
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    总结
  </a>
  
    <nav class="md-nav" aria-label="总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#33-configuration" class="md-nav__link">
    3.3 Configuration (配置详解)
  </a>
  
    <nav class="md-nav" aria-label="3.3 Configuration (配置详解)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    配置文件基础
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    配置文件结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    通用占位符说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#global" class="md-nav__link">
    Global 全局配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtime" class="md-nav__link">
    Runtime 运行时配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scrape-configs" class="md-nav__link">
    Scrape Configs 抓取配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-config-http" class="md-nav__link">
    HTTP Config HTTP 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-discovery" class="md-nav__link">
    服务发现 (Service Discovery)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relabel-configs" class="md-nav__link">
    Relabel Configs 重新标记配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alerting" class="md-nav__link">
    Alerting 告警配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-writeread" class="md-nav__link">
    Remote Write/Read 远程写入/读取
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage" class="md-nav__link">
    Storage 存储配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    完整配置示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    总结
  </a>
  
    <nav class="md-nav" aria-label="总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#34-recording-rules" class="md-nav__link">
    3.4 Recording Rules (记录规则)
  </a>
  
    <nav class="md-nav" aria-label="3.4 Recording Rules (记录规则)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    规则配置基础
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    规则文件结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recording-rule" class="md-nav__link">
    Recording Rule 语法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    记录规则命名最佳实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    规则组配置选项
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    规则评估性能优化
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-alerting-rules" class="md-nav__link">
    3.5 Alerting Rules (告警规则)
  </a>
  
    <nav class="md-nav" aria-label="3.5 Alerting Rules (告警规则)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    告警规则语法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    告警规则示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    告警状态转换
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    告警模板化
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    告警最佳实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    查看告警状态
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alertmanager" class="md-nav__link">
    集成 Alertmanager
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36-template-examples" class="md-nav__link">
    3.6 Template Examples (模板示例)
  </a>
  
    <nav class="md-nav" aria-label="3.6 Template Examples (模板示例)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    告警字段模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    简单迭代
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    显示单个值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#url" class="md-nav__link">
    使用控制台 URL 参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    高级迭代示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    定义可重用模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    常用模板函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    实用模板示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    模板调试技巧
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-querying" class="md-nav__link">
    4. Querying (查询)
  </a>
  
    <nav class="md-nav" aria-label="4. Querying (查询)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-basics" class="md-nav__link">
    4.1 Basics (基础)
  </a>
  
    <nav class="md-nav" aria-label="4.1 Basics (基础)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#promql" class="md-nav__link">
    PromQL 查询类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    表达式数据类型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-querying_1" class="md-nav__link">
    4. Querying (查询)
  </a>
  
    <nav class="md-nav" aria-label="4. Querying (查询)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-basics_1" class="md-nav__link">
    4.1 Basics (基础)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-operators" class="md-nav__link">
    4.2 Operators (操作符)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-functions" class="md-nav__link">
    4.3 Functions (函数)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-examples" class="md-nav__link">
    4.4 Examples (示例)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#promql_1" class="md-nav__link">
    PromQL 最佳实践
  </a>
  
    <nav class="md-nav" aria-label="PromQL 最佳实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#45-api-http-api" class="md-nav__link">
    4.5 API (HTTP API)
  </a>
  
    <nav class="md-nav" aria-label="4.5 API (HTTP API)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    API 响应格式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-api" class="md-nav__link">
    1. 表达式查询 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-api" class="md-nav__link">
    2. 元数据查询 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3. 目标和规则查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-api" class="md-nav__link">
    4. 状态和配置 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-api-webenable-admin-api" class="md-nav__link">
    5. 管理 API (需启用 --web.enable-admin-api)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-api" class="md-nav__link">
    6. 实用工具 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-api" class="md-nav__link">
    7. 常用 API 调用示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-api" class="md-nav__link">
    8. API 使用最佳实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9. 编程语言客户端示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api_1" class="md-nav__link">
    API 快速参考
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-storage" class="md-nav__link">
    5. Storage (存储)
  </a>
  
    <nav class="md-nav" aria-label="5. Storage (存储)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1 本地存储
  </a>
  
    <nav class="md-nav" aria-label="5.1 本地存储">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    磁盘布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wal-write-ahead-log" class="md-nav__link">
    WAL (Write-Ahead Log)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compaction" class="md-nav__link">
    压缩 (Compaction)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    存储配置参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    容量规划
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    保留策略
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    数据完整性
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2 远程存储集成
  </a>
  
    <nav class="md-nav" aria-label="5.2 远程存储集成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    四种集成方式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    协议特性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-write-receiver" class="md-nav__link">
    Remote Write Receiver
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-read" class="md-nav__link">
    Remote Read 限制
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-backfilling" class="md-nav__link">
    5.3 数据回填 (Backfilling)
  </a>
  
    <nav class="md-nav" aria-label="5.3 数据回填 (Backfilling)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openmetrics" class="md-nav__link">
    OpenMetrics 格式回填
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recording-rules" class="md-nav__link">
    Recording Rules 回填
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-federation" class="md-nav__link">
    6. Federation (联邦)
  </a>
  
    <nav class="md-nav" aria-label="6. Federation (联邦)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1 使用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-federation" class="md-nav__link">
    6.2 配置 Federation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-management-api-api" class="md-nav__link">
    7. Management API (管理 API)
  </a>
  
    <nav class="md-nav" aria-label="7. Management API (管理 API)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-api" class="md-nav__link">
    7.1 健康检查 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-api" class="md-nav__link">
    7.2 配置管理 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73" class="md-nav__link">
    7.3 使用场景
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-command-line" class="md-nav__link">
    8. Command Line (命令行工具)
  </a>
  
    <nav class="md-nav" aria-label="8. Command Line (命令行工具)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-prometheus" class="md-nav__link">
    8.1 Prometheus 命令
  </a>
  
    <nav class="md-nav" aria-label="8.1 Prometheus 命令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    基本用法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    核心启动参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    存储配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    查询配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    规则和告警配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_65" class="md-nav__link">
    特性标志
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_66" class="md-nav__link">
    日志配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    Agent 模式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_67" class="md-nav__link">
    完整启动示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-promtool" class="md-nav__link">
    8.2 Promtool 工具
  </a>
  
    <nav class="md-nav" aria-label="8.2 Promtool 工具">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_68" class="md-nav__link">
    基本用法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_69" class="md-nav__link">
    常用命令列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-check-" class="md-nav__link">
    1. Check 命令 - 验证配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-query-" class="md-nav__link">
    2. Query 命令 - 执行查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-test-" class="md-nav__link">
    3. Test 命令 - 单元测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-tsdb-" class="md-nav__link">
    4. TSDB 命令 - 数据库操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-debug-" class="md-nav__link">
    5. Debug 命令 - 调试信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-push-" class="md-nav__link">
    6. Push 命令 - 推送数据
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-promql-" class="md-nav__link">
    7. PromQL 命令 - 格式化 (实验性)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell" class="md-nav__link">
    实用 Shell 脚本示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_70" class="md-nav__link">
    命令行工具最佳实践
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-migration" class="md-nav__link">
    9. Migration (迁移指南)
  </a>
  
    <nav class="md-nav" aria-label="9. Migration (迁移指南)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus-30" class="md-nav__link">
    Prometheus 3.0 迁移指南
  </a>
  
    <nav class="md-nav" aria-label="Prometheus 3.0 迁移指南">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_71" class="md-nav__link">
    已移除的特性标志
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_72" class="md-nav__link">
    配置变更
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promql_2" class="md-nav__link">
    PromQL 变更
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_73" class="md-nav__link">
    抓取协议变更
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_74" class="md-nav__link">
    其他重要变更
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-feature-flags" class="md-nav__link">
    10. Feature Flags (特性标志)
  </a>
  
    <nav class="md-nav" aria-label="10. Feature Flags (特性标志)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_75" class="md-nav__link">
    可用特性标志
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-security" class="md-nav__link">
    11. Security (安全)
  </a>
  
    <nav class="md-nav" aria-label="11. Security (安全)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_76" class="md-nav__link">
    安全模型概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_77" class="md-nav__link">
    安全假设
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api_2" class="md-nav__link">
    管理 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_78" class="md-nav__link">
    组件安全
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_79" class="md-nav__link">
    认证、授权和加密
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api_3" class="md-nav__link">
    API 安全
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_80" class="md-nav__link">
    秘密管理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dos" class="md-nav__link">
    DoS 防护
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_81" class="md-nav__link">
    漏洞报告
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-overview" class="md-nav__link">
    12. Overview (概览)
  </a>
  
    <nav class="md-nav" aria-label="12. Overview (概览)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus_9" class="md-nav__link">
    什么是 Prometheus?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_82" class="md-nav__link">
    主要特性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_83" class="md-nav__link">
    什么是指标?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_84" class="md-nav__link">
    组件生态
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_85" class="md-nav__link">
    架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_86" class="md-nav__link">
    适用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_87" class="md-nav__link">
    不适用场景
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-alertmanager" class="md-nav__link">
    13. Alertmanager (告警管理器)
  </a>
  
    <nav class="md-nav" aria-label="13. Alertmanager (告警管理器)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_88" class="md-nav__link">
    核心功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_89" class="md-nav__link">
    核心概念
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-grouping" class="md-nav__link">
    1. Grouping (分组)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-inhibition" class="md-nav__link">
    2. Inhibition (抑制)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-silences" class="md-nav__link">
    3. Silences (静默)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_90" class="md-nav__link">
    高可用性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_91" class="md-nav__link">
    配置示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_92" class="md-nav__link">
    通知接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_93" class="md-nav__link">
    最佳实践
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-alerting-configuration-alertmanager" class="md-nav__link">
    14. Alerting Configuration (Alertmanager 配置)
  </a>
  
    <nav class="md-nav" aria-label="14. Alerting Configuration (Alertmanager 配置)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#141" class="md-nav__link">
    14.1 配置文件基础
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#142" class="md-nav__link">
    14.2 全局配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#143-route" class="md-nav__link">
    14.3 路由配置 (Route)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#144-time-intervals" class="md-nav__link">
    14.4 时间间隔 (Time Intervals)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#145-inhibition" class="md-nav__link">
    14.5 抑制规则 (Inhibition)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#146-matchers" class="md-nav__link">
    14.6 标签匹配器 (Matchers)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#147-receivers" class="md-nav__link">
    14.7 接收器 (Receivers)
  </a>
  
    <nav class="md-nav" aria-label="14.7 接收器 (Receivers)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#email" class="md-nav__link">
    Email 接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slack" class="md-nav__link">
    Slack 接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pagerduty" class="md-nav__link">
    PagerDuty 接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webhook" class="md-nav__link">
    Webhook 接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_94" class="md-nav__link">
    其他接收器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#148-http" class="md-nav__link">
    14.8 HTTP 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#149" class="md-nav__link">
    14.9 完整配置示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1410" class="md-nav__link">
    14.10 模板变量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1411" class="md-nav__link">
    14.11 验证和测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1412" class="md-nav__link">
    14.12 最佳实践
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_95" class="md-nav__link">
    配置快速参考
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-notification-examples" class="md-nav__link">
    15. Notification Examples (通知示例)
  </a>
  
    <nav class="md-nav" aria-label="15. Notification Examples (通知示例)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#151-slack" class="md-nav__link">
    15.1 自定义 Slack 通知
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#152-annotations" class="md-nav__link">
    15.2 访问注解 (Annotations)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#153" class="md-nav__link">
    15.3 遍历所有告警
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#154" class="md-nav__link">
    15.4 定义可复用模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#155" class="md-nav__link">
    15.5 更多实用模板示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#156" class="md-nav__link">
    15.6 模板函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#157" class="md-nav__link">
    15.7 完整模板文件示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-alertmanager-management-api" class="md-nav__link">
    16. Alertmanager Management API
  </a>
  
    <nav class="md-nav" aria-label="16. Alertmanager Management API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#161" class="md-nav__link">
    16.1 健康检查
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#162" class="md-nav__link">
    16.2 就绪检查
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#163" class="md-nav__link">
    16.3 重载配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#164" class="md-nav__link">
    16.4 自动化脚本示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#165-api" class="md-nav__link">
    16.5 API 使用最佳实践
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_96" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-practices" class="md-nav__link">
    17. Practices (最佳实践)
  </a>
  
    <nav class="md-nav" aria-label="17. Practices (最佳实践)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#171-naming" class="md-nav__link">
    17.1 Naming (命名规范)
  </a>
  
    <nav class="md-nav" aria-label="17.1 Naming (命名规范)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_97" class="md-nav__link">
    指标名称规范
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_98" class="md-nav__link">
    为什么在名称中包含单位和类型?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_99" class="md-nav__link">
    标签规范
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_100" class="md-nav__link">
    基础单位
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#172-instrumentation" class="md-nav__link">
    17.2 Instrumentation (埋点)
  </a>
  
    <nav class="md-nav" aria-label="17.2 Instrumentation (埋点)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_101" class="md-nav__link">
    如何埋点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_102" class="md-nav__link">
    三种服务类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_103" class="md-nav__link">
    子系统埋点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_104" class="md-nav__link">
    需要注意的事项
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#173-histograms" class="md-nav__link">
    17.3 Histograms (直方图)
  </a>
  
    <nav class="md-nav" aria-label="17.3 Histograms (直方图)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#count-sum" class="md-nav__link">
    Count 和 Sum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apdex" class="md-nav__link">
    Apdex 分数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantiles" class="md-nav__link">
    Quantiles (分位数)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_105" class="md-nav__link">
    选择建议
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_106" class="md-nav__link">
    分位数误差
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#174-alerting" class="md-nav__link">
    17.4 Alerting (告警最佳实践)
  </a>
  
    <nav class="md-nav" aria-label="17.4 Alerting (告警最佳实践)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_107" class="md-nav__link">
    核心原则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_108" class="md-nav__link">
    告警命名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_109" class="md-nav__link">
    告警内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_110" class="md-nav__link">
    容量告警
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metamonitoring" class="md-nav__link">
    元监控 (Metamonitoring)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#175-recording-rules" class="md-nav__link">
    17.5 Recording Rules (记录规则)
  </a>
  
    <nav class="md-nav" aria-label="17.5 Recording Rules (记录规则)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_111" class="md-nav__link">
    命名约定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_112" class="md-nav__link">
    命名规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_113" class="md-nav__link">
    聚合规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_114" class="md-nav__link">
    完整示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#176-pushing-metrics" class="md-nav__link">
    17.6 Pushing Metrics (推送指标)
  </a>
  
    <nav class="md-nav" aria-label="17.6 Pushing Metrics (推送指标)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pushgateway" class="md-nav__link">
    何时使用 Pushgateway?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pushgateway_1" class="md-nav__link">
    Pushgateway 的问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_115" class="md-nav__link">
    唯一有效用例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_116" class="md-nav__link">
    替代策略
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_117" class="md-nav__link">
    最佳实践总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practices" class="md-nav__link">
    Practices 快速参考
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-exporters" class="md-nav__link">
    18. Exporters (导出器列表)
  </a>
  
    <nav class="md-nav" aria-label="18. Exporters (导出器列表)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#databases" class="md-nav__link">
    Databases (数据库)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware-related" class="md-nav__link">
    Hardware Related (硬件相关)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#issue-trackers-cicd" class="md-nav__link">
    Issue Trackers &amp; CI/CD (问题跟踪 &amp; 持续集成)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#messaging-systems" class="md-nav__link">
    Messaging Systems (消息系统)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage_1" class="md-nav__link">
    Storage (存储)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-http" class="md-nav__link">
    HTTP (HTTP 服务器)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apis-api" class="md-nav__link">
    APIs (API 服务)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging (日志)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finops" class="md-nav__link">
    FinOps (成本管理)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#miscellaneous" class="md-nav__link">
    Miscellaneous (其他)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#golang-exporter" class="md-nav__link">
    附录: Golang Exporter 完整示例
  </a>
  
    <nav class="md-nav" aria-label="附录: Golang Exporter 完整示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_118" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_119" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_120" class="md-nav__link">
    使用说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_121" class="md-nav__link">
    代码要点解析
  </a>
  
    <nav class="md-nav" aria-label="代码要点解析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-gauge-collector" class="md-nav__link">
    1. Gauge 指标 (自定义 Collector)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-histogram" class="md-nav__link">
    2. Histogram 指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_10" class="md-nav__link">
    Prometheus 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promql_3" class="md-nav__link">
    PromQL 查询示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_122" class="md-nav__link">
    最佳实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_123" class="md-nav__link">
    扩展示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_124" class="md-nav__link">
    故障排查
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_125" class="md-nav__link">
    总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pushgateway-golang" class="md-nav__link">
    附录: Pushgateway Golang 示例
  </a>
  
    <nav class="md-nav" aria-label="附录: Pushgateway Golang 示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_126" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_127" class="md-nav__link">
    适用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_128" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_129" class="md-nav__link">
    使用说明
  </a>
  
    <nav class="md-nav" aria-label="使用说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-pushgateway" class="md-nav__link">
    1. 启动 Pushgateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-go" class="md-nav__link">
    2. 安装 Go 依赖
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    3. 运行示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4. 查看推送的指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_130" class="md-nav__link">
    核心概念
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-push-vs-add-vs-delete" class="md-nav__link">
    1. Push vs Add vs Delete
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-grouping-labels" class="md-nav__link">
    2. 分组标签 (Grouping Labels)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-registry" class="md-nav__link">
    3. Registry 使用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_131" class="md-nav__link">
    实际应用场景
  </a>
  
    <nav class="md-nav" aria-label="实际应用场景">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-cron-job" class="md-nav__link">
    场景 1: Cron Job 批处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    场景 2: 数据处理脚本
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_2" class="md-nav__link">
    场景 3: 定期推送 (长期运行脚本)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_11" class="md-nav__link">
    Prometheus 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promql_4" class="md-nav__link">
    PromQL 查询示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_132" class="md-nav__link">
    最佳实践
  </a>
  
    <nav class="md-nav" aria-label="最佳实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-add-push" class="md-nav__link">
    1. 使用 Add 而非 Push (多指标场景)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    2. 任务结束时删除指标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_3" class="md-nav__link">
    3. 添加时间戳指标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_1" class="md-nav__link">
    4. 错误处理和重试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_133" class="md-nav__link">
    安全性
  </a>
  
    <nav class="md-nav" aria-label="安全性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-basic-auth" class="md-nav__link">
    1. 使用 Basic Auth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-tls" class="md-nav__link">
    2. TLS 加密
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_134" class="md-nav__link">
    常见问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pushgateway_2" class="md-nav__link">
    监控 Pushgateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_135" class="md-nav__link">
    总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#textfile-collector" class="md-nav__link">
    附录: Textfile Collector 示例
  </a>
  
    <nav class="md-nav" aria-label="附录: Textfile Collector 示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_136" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_137" class="md-nav__link">
    适用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_138" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_139" class="md-nav__link">
    使用说明
  </a>
  
    <nav class="md-nav" aria-label="使用说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-node-exporter" class="md-nav__link">
    1. 安装 Node Exporter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-go_1" class="md-nav__link">
    2. 安装 Go 依赖
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_4" class="md-nav__link">
    3. 运行示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-prom" class="md-nav__link">
    4. 生成的 .prom 文件内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5. 访问指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api_4" class="md-nav__link">
    核心 API 详解
  </a>
  
    <nav class="md-nav" aria-label="核心 API 详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-registrygather" class="md-nav__link">
    1. registry.Gather()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-expfmtmetricfamilytotext" class="md-nav__link">
    2. expfmt.MetricFamilyToText()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_140" class="md-nav__link">
    实际应用场景
  </a>
  
    <nav class="md-nav" aria-label="实际应用场景">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    场景 1: 备份任务指标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_2" class="md-nav__link">
    场景 2: 磁盘配额监控
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-shell" class="md-nav__link">
    场景 3: Shell 脚本生成指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_141" class="md-nav__link">
    最佳实践
  </a>
  
    <nav class="md-nav" aria-label="最佳实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    1. 使用原子写入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_3" class="md-nav__link">
    2. 添加文件修改时间指标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_5" class="md-nav__link">
    3. 错误处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_2" class="md-nav__link">
    4. 文件权限
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_12" class="md-nav__link">
    Prometheus 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promql_5" class="md-nav__link">
    PromQL 查询示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#textfile-collector_1" class="md-nav__link">
    监控 Textfile Collector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_142" class="md-nav__link">
    常见问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_143" class="md-nav__link">
    性能考虑
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_144" class="md-nav__link">
    总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python-shell" class="md-nav__link">
    附录: Python &amp; Shell 完整示例
  </a>
  
    <nav class="md-nav" aria-label="附录: Python &amp; Shell 完整示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-http-exporter" class="md-nav__link">
    Python HTTP Exporter
  </a>
  
    <nav class="md-nav" aria-label="Python HTTP Exporter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_145" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_146" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_147" class="md-nav__link">
    安装和运行
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-pushgateway" class="md-nav__link">
    Python Pushgateway
  </a>
  
    <nav class="md-nav" aria-label="Python Pushgateway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_148" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_149" class="md-nav__link">
    运行
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-textfile-collector" class="md-nav__link">
    Python Textfile Collector
  </a>
  
    <nav class="md-nav" aria-label="Python Textfile Collector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_150" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crontab" class="md-nav__link">
    Crontab 配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell-textfile-collector" class="md-nav__link">
    Shell Textfile Collector
  </a>
  
    <nav class="md-nav" aria-label="Shell Textfile Collector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_151" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_152" class="md-nav__link">
    使用方法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_153" class="md-nav__link">
    对比总结
  </a>
  
    <nav class="md-nav" aria-label="对比总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_154" class="md-nav__link">
    语言选择
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_155" class="md-nav__link">
    模式选择
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_156" class="md-nav__link">
    最佳实践
  </a>
  
    <nav class="md-nav" aria-label="最佳实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#http-exporter" class="md-nav__link">
    HTTP Exporter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pushgateway_3" class="md-nav__link">
    Pushgateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#textfile-collector_2" class="md-nav__link">
    Textfile Collector
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_13" class="md-nav__link">
    Prometheus 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_157" class="md-nav__link">
    总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_53" data-md-state="indeterminate" type="checkbox" id="__nav_4_53" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_53">
          kubernetes 证书管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="kubernetes 证书管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_53">
          <span class="md-nav__icon md-icon"></span>
          kubernetes 证书管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cert-manager/1-2025-03-29-cert-manager-install-doc/" class="md-nav__link">
        kubernetes Cert-manager 安装
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_54" data-md-state="indeterminate" type="checkbox" id="__nav_4_54" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_54">
          kubernetes 网络管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="kubernetes 网络管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_54">
          <span class="md-nav__icon md-icon"></span>
          kubernetes 网络管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../calico/5-2025-04-07-calico-FAQ-doc/" class="md-nav__link">
        kubernetes calico 网络管理containerd 运行时导致的 calico  driver 无法启动FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_55" data-md-state="indeterminate" type="checkbox" id="__nav_4_55" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_55">
          K8s 认证
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="K8s 认证" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_55">
          <span class="md-nav__icon md-icon"></span>
          K8s 认证
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cks/cka/" class="md-nav__link">
        kubernetes CKA考题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cks/cks/" class="md-nav__link">
        kubernetes CKS考题
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_56" data-md-state="indeterminate" type="checkbox" id="__nav_4_56" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_56">
          Helm
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Helm" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_56">
          <span class="md-nav__icon md-icon"></span>
          Helm
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/0-2025-3-21-helm-install-doc/" class="md-nav__link">
        kubernetes Helm 实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/1-2025-3-21-helm-cli-doc/" class="md-nav__link">
        kubernetes Helm CLI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/2-2025-3-21-helm-chart-doc/" class="md-nav__link">
        kubernetes Helm chart包
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_57" data-md-state="indeterminate" type="checkbox" id="__nav_4_57" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_57">
          Helm FAQ
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Helm FAQ" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_57">
          <span class="md-nav__icon md-icon"></span>
          Helm FAQ
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/FAQ/0-2025-4-10-helm-repo-update-warning-FAQ-doc/" class="md-nav__link">
        kubernetes Helm repo update 警告关闭FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_58" data-md-state="indeterminate" type="checkbox" id="__nav_4_58" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_58">
          Helmfile
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Helmfile" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_58">
          <span class="md-nav__icon md-icon"></span>
          Helmfile
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/5-2025-04-10-helmfile-docs/" class="md-nav__link">
        kubernetes Helmfile 文件
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_59" data-md-state="indeterminate" type="checkbox" id="__nav_4_59" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_59">
          k3s
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="k3s" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_59">
          <span class="md-nav__icon md-icon"></span>
          k3s
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../k3s/1-2025-03-29-k3s-docs/" class="md-nav__link">
        k3s 大纲介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../k3s/2-2025-03-29-k3s-install-docs/" class="md-nav__link">
        k3s 边缘计算
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_60" data-md-state="indeterminate" type="checkbox" id="__nav_4_60" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_60">
          dragonfly
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="dragonfly" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_60">
          <span class="md-nav__icon md-icon"></span>
          dragonfly
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2025-05-22-dragonfly-axiom-doc/" class="md-nav__link">
        dragonfly 原理剖析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" data-md-state="indeterminate" type="checkbox" id="__nav_5" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5">
          3、运维开发
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="3、运维开发" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          3、运维开发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" data-md-state="indeterminate" type="checkbox" id="__nav_5_1" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5_1">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Python" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2024-02-20-1-python-base-doc/" class="md-nav__link">
        开发-基础语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2024-02-20-2-python-interaction-doc/" class="md-nav__link">
        开发-用户交互
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2024-03-06-3-python-pip-offline-doc/" class="md-nav__link">
        pip-离线安装软件包
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/6-2025-08-06-python-types-doc/" class="md-nav__link">
        数据类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/7-2025-08-06-python-input-doc/" class="md-nav__link">
        用户输入
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/8-2025-08-06-python-list-tuple-doc/" class="md-nav__link">
        列表元组
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/14-2025-08-07-python-except-doc/" class="md-nav__link">
        异常处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2024-02-21-4-python-module-doc/" class="md-nav__link">
        模块
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2025-04-15-python-package-doc/" class="md-nav__link">
        包管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2025-04-15-python-standard-library-doc.md" class="md-nav__link">
        标准库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2025-03-27-5-python-poetry-doc/" class="md-nav__link">
        Poetry 环境配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/24-2025-07-15-python-oop-object-docs/" class="md-nav__link">
        面向对象编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/25-2025-07-16-python-py-oop2-doc/" class="md-nav__link">
        继承和多态
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/26-2025-07-17-python-property-doc/" class="md-nav__link">
        property
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/28-2025-07-17-python-py-concurrency-doc/" class="md-nav__link">
        并发编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/32-2025-07-17-python-py-venv-doc/" class="md-nav__link">
        虚拟环境
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/33-2025-07-17-python-py-action-base-doc/" class="md-nav__link">
        项目分析与简单实现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" data-md-state="indeterminate" type="checkbox" id="__nav_5_2" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5_2">
          GO
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="GO" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          GO
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/go/2024-02-20-1-go-base-doc/" class="md-nav__link">
        开发-环境安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/go/2024-02-20-2-go-operator-doc/" class="md-nav__link">
        开发-操作符和表达式
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" data-md-state="indeterminate" type="checkbox" id="__nav_6" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6">
          4、数据库
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="4、数据库" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          4、数据库
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" data-md-state="indeterminate" type="checkbox" id="__nav_6_1" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6_1">
          MySQL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MySQL" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          MySQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/2024-02-20-1-mysql-base-doc/" class="md-nav__link">
        基础配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/2024-02-20-2-mysql-operator-doc/" class="md-nav__link">
        Operator 部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/2024-02-20-3-mysql-backup-doc/" class="md-nav__link">
        备份恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/4-2025-04-09-mysql-port-forward-doc/" class="md-nav__link">
        客户端通过port-forward连接mysql-server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/5-2025-04-10-mysql-Beekeeper-studio-doc/" class="md-nav__link">
        Mysql 客户端 Beekeeper-studio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/2024-02-20-4-mysql-backup-error-FAQ-doc/" class="md-nav__link">
        Mysql 数据恢复FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" data-md-state="indeterminate" type="checkbox" id="__nav_6_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6_2">
          Redis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Redis" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/redis/2024-02-20-1-redis-outline-doc/" class="md-nav__link">
        大纲
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/redis/2024-02-20-2-redis-persistence-doc/" class="md-nav__link">
        持久化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/redis/2024-02-20-3-redis-cluster-doc/" class="md-nav__link">
        集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/redis/2024-02-20-4-redis-base-doc/" class="md-nav__link">
        基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" data-md-state="indeterminate" type="checkbox" id="__nav_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7">
          5、存储服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="5、存储服务" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          5、存储服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-disk-ssd-docs/" class="md-nav__link">
        存储分类
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-base/" class="md-nav__link">
        ceph 基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-03-05-rook-ceph/" class="md-nav__link">
        ceph 分布式存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-rbd-docs/" class="md-nav__link">
        ceph RBD使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-cephfs-docs/" class="md-nav__link">
        ceph 文件系统使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-cli-docs/" class="md-nav__link">
        ceph 命令用法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-osd/" class="md-nav__link">
        ceph 性能测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-bucket/" class="md-nav__link">
        ceph 对象存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-s3-client-docs/" class="md-nav__link">
        ceph s3cmd管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-5-dev-docs/" class="md-nav__link">
        ceph 存储修复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-expand-docs/" class="md-nav__link">
        ceph 存储扩容
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-tools/" class="md-nav__link">
        ceph 外部环境连接集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-clean-ceph-docs/" class="md-nav__link">
        ceph 集群清理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-error/" class="md-nav__link">
        ceph 错误指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-6-ceph-crush-docs/" class="md-nav__link">
        ceph 高级参数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-03-05-Juicefs/" class="md-nav__link">
        Juicefs存储方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-juicefs-update/" class="md-nav__link">
        Juicefs版本升级
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_18" data-md-state="indeterminate" type="checkbox" id="__nav_7_18" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7_18">
          rook-ceph
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="rook-ceph" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_18">
          <span class="md-nav__icon md-icon"></span>
          rook-ceph
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/rook-ceph/1-2024-04-08-rook-ceph-crd-doc/" class="md-nav__link">
        rook-ceph CRD 详细说明
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" data-md-state="indeterminate" type="checkbox" id="__nav_8" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8">
          6、Devops
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="6、Devops" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          6、Devops
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2024-9-26-Git-docs/" class="md-nav__link">
        Git Commit 问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2025-3-21-Gitignore-doc/" class="md-nav__link">
        Gitignore 特定文件忽略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2025-3-31-Git-rebase-error-docs.md" class="md-nav__link">
        Git rebase报错指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2025-07-16-git-merger-commit-doc/" class="md-nav__link">
        Git 合并两个 commit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/github/" class="md-nav__link">
        Github
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2024-10-10-Github-rsync-Gitee/" class="md-nav__link">
        Github Rysnc 同步 Gitee
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/4-github-gitee-doc/" class="md-nav__link">
        Github仓库同步至Gitee
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/3-github-docs/" class="md-nav__link">
        Google 浏览器扩展
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Devops/2025-3-27-conda-libmamba-solver-error-solution.md" class="md-nav__link">
        Conda conda-libmamba-solver Bug 修复
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" data-md-state="indeterminate" type="checkbox" id="__nav_9" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_9">
          7、Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="7、Web" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          7、Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../7.Web/http/1-2025-03-30-http-web-doc/" class="md-nav__link">
        Http 协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../7.Web/nginx/2025-3-27-certbot_ssl_doc/" class="md-nav__link">
        Nginx 配置Cerbot
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" data-md-state="indeterminate" type="checkbox" id="__nav_10" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_10">
          8、运维自动化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="8、运维自动化" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          8、运维自动化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-case1/" class="md-nav__link">
        Ansible 应用基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-docs2/" class="md-nav__link">
        Ansible 高级用法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-install-docs/" class="md-nav__link">
        Ansible 安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-playbook/" class="md-nav__link">
        Ansible playbook
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" data-md-state="indeterminate" type="checkbox" id="__nav_11" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11">
          9、其他
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="9、其他" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          9、其他
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_1" data-md-state="indeterminate" type="checkbox" id="__nav_11_1" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_1">
          远程访问
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="远程访问" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_1">
          <span class="md-nav__icon md-icon"></span>
          远程访问
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/rustdesk/2026-01-06-%E8%87%AA%E5%BB%BARustDesk%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%99%E7%A8%8B/" class="md-nav__link">
        自建RustDesk远程服务器教程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_2" data-md-state="indeterminate" type="checkbox" id="__nav_11_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_2">
          Macos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Macos" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_2">
          <span class="md-nav__icon md-icon"></span>
          Macos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/1-2025-03-29-mac-kubeconfig-doc/" class="md-nav__link">
        kubeconfig 实践应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/2-2025-03-29-mac-k9s-doc/" class="md-nav__link">
        k9s 实践应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/3-2025-03-29-mac-usb-system-doc/" class="md-nav__link">
        Mac 制作ubuntu系统盘
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/4-2025-03-29-mac-vscode-doc/" class="md-nav__link">
        Mac vscode使用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/5-2025-03-27-mac-vscode-ssh-plugin-doc/" class="md-nav__link">
        Mac vscode ssh插件使用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/9-2025-05-06-mac-font-family-doc/" class="md-nav__link">
        Mac vscode字体设置设置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/6-2024-02-20-mac-mkdocs-docs/" class="md-nav__link">
        如何利用Mac 写博客文章
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/10-2025-6-11-mac-ncdu-cli-doc/" class="md-nav__link">
        Mac 磁盘分析命令 ncdu
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/11-2025-07-15-mac-cursor-disable-Tabnine-doc/" class="md-nav__link">
        Mac cursor 禁用 Tabnine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/12-2025-07-16-mac-crontab-caffeinate-doc/" class="md-nav__link">
        Macbook 显示器定时禁止自动休眠
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/13-2025-8-25-mac-iso-doc/" class="md-nav__link">
        Macos 制作 iso 镜像文件
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_3" data-md-state="indeterminate" type="checkbox" id="__nav_11_3" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_3">
          Mac 小知识
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Mac 小知识" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_3">
          <span class="md-nav__icon md-icon"></span>
          Mac 小知识
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/7-2025-04-11-mac-item2-ssh-doc/" class="md-nav__link">
        (第一期)Mac item2 SSH连接服务器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/8-2025-04-11-mac-item2-use-doc/" class="md-nav__link">
        (第二期)Mac item2 使用技巧
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_4" data-md-state="indeterminate" type="checkbox" id="__nav_11_4" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_4">
          运维小知识
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="运维小知识" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_4">
          <span class="md-nav__icon md-icon"></span>
          运维小知识
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Opsdaily/1-2025-03-27-ops-screen-docs/" class="md-nav__link">
        (第一期:)screen 使用技巧
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_5" data-md-state="indeterminate" type="checkbox" id="__nav_11_5" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_5">
          办公
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="办公" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_5">
          <span class="md-nav__icon md-icon"></span>
          办公
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/2024-03-07-office-docs/" class="md-nav__link">
        正版Office全家桶永久免费使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/2024-02-20-google-docs/" class="md-nav__link">
        高效利用谷歌来搜索
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/2024-02-20-discord-docs/" class="md-nav__link">
        Discord 新手教程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_6" data-md-state="indeterminate" type="checkbox" id="__nav_11_6" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_6">
          其他
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="其他" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_6">
          <span class="md-nav__icon md-icon"></span>
          其他
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/2025-03-27-usb-wifi-doc/" class="md-nav__link">
        Ubuntu-USB 无线无线网卡使用说明书
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" data-md-state="indeterminate" type="checkbox" id="__nav_12" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12">
          10、Ai
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="10、Ai" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          10、Ai
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_1" data-md-state="indeterminate" type="checkbox" id="__nav_12_1" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_1">
          Cursor
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cursor" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_1">
          <span class="md-nav__icon md-icon"></span>
          Cursor
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/cursor/2024-02-27-cursor-latest-features/" class="md-nav__link">
        Cursor 使用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/cursor/2024-02-27-cursor-model-performance/" class="md-nav__link">
        Cursor 模型性能排行
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_2" data-md-state="indeterminate" type="checkbox" id="__nav_12_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_2">
          vLLM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="vLLM" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_2">
          <span class="md-nav__icon md-icon"></span>
          vLLM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-03-03-vllm-Qwen2.5-VL/" class="md-nav__link">
        vLLM 部署 Qwen2.5-VL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-03-03-vllm-Qwen2.5-VL-72B/" class="md-nav__link">
        vLLM 部署 Qwen2.5-VL-72B
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-03-13-vllm-docs-2/" class="md-nav__link">
        vLLM 模型启动参数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-02-28-vllm-chatglm3-6b-doc/" class="md-nav__link">
        vLLM 部署 ChatGLM3-6B
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-02-28-vllm-docs/" class="md-nav__link">
        vLLM 基础文档
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_3" data-md-state="indeterminate" type="checkbox" id="__nav_12_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_3">
          NVIDIA
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="NVIDIA" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_3">
          <span class="md-nav__icon md-icon"></span>
          NVIDIA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/Nvidia-gpu-compare/" class="md-nav__link">
        NVIDIA显卡对比
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/2025-12-17-NVIDIA-driver-install-doc/" class="md-nav__link">
        NVIDIA驱动安装和清理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/fake-gpu-operator-doc/" class="md-nav__link">
        fake-gpu-operator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/Nvidia-k8s-rdma/" class="md-nav__link">
        RDMA在Kubernetes中的应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/2025-12-03-%E5%A6%82%E4%BD%95%E6%A3%80%E6%9F%A5CUDA%E6%98%AF%E5%90%A6%E5%8F%AF%E7%94%A8/" class="md-nav__link">
        NVIDIA 如何检查CUDA是否正常
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/LiteLLM-Proxy-doc/" class="md-nav__link">
        LiteLLM-Proxy
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_4" data-md-state="indeterminate" type="checkbox" id="__nav_12_4" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_4">
          ChatGPT
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ChatGPT" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_4">
          <span class="md-nav__icon md-icon"></span>
          ChatGPT
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/chatgpt/2024-02-20-chatgpt-docs/" class="md-nav__link">
        注册chatgpt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/chatgpt/2024-02-20-chatgpt-pulgin-docs/" class="md-nav__link">
        ChatGPT插件使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/chatgpt/2024-02-20-gpts-docs/" class="md-nav__link">
        如何使用Chatgpt来制作专属gpt
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_5" data-md-state="indeterminate" type="checkbox" id="__nav_12_5" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_5">
          OpenBayes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OpenBayes" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_5">
          <span class="md-nav__icon md-icon"></span>
          OpenBayes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/2-2024-03-27-wan-openbayes-deploy.md" class="md-nav__link">
        OpenBayes部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/1-2025-03-29-tju-gpu-error-FAQ-doc/" class="md-nav__link">
        Openbayes 天津大学GPU异常FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/2-2025-03-29-tju-gpu-ps-FAQ-doc/" class="md-nav__link">
        Openbayes GPU异常图文FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/3-2025-03-29-dev-cluster-FAQ-doc/" class="md-nav__link">
        Openbayes Dev环境集群FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/4-2025-03-29-delete-prometheus-db-FAQ-doc/" class="md-nav__link">
        Openbayes 误删除监控数据FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/5-2025-03-29-kubernetes-pvc-ubound-FAQ-doc/" class="md-nav__link">
        Openbayes Kubernetes pvc ubound FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/6-2025-03-29-dns-file-permission-FAQ-doc/" class="md-nav__link">
        Openbayes dns 文件权限调整FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/7-2025-03-29-osd-disk-expansion-FAQ-doc/" class="md-nav__link">
        Openbayes osd 磁盘扩容FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_6" data-md-state="indeterminate" type="checkbox" id="__nav_12_6" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_6">
          Langfuse
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Langfuse" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_6">
          <span class="md-nav__icon md-icon"></span>
          Langfuse
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/Langfuse/2024-03-17-langfuse-deployment-guide/" class="md-nav__link">
        Langfuse部署指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/Langfuse/2024-03-14-opentelemetry-doc/" class="md-nav__link">
        OpenTelemetry文档
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_7" data-md-state="indeterminate" type="checkbox" id="__nav_12_7" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_7">
          Midjourney
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Midjourney" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_7">
          <span class="md-nav__icon md-icon"></span>
          Midjourney
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/2024-03-06-mj-doc/" class="md-nav__link">
        Midjourney文档
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" data-md-state="indeterminate" type="checkbox" id="__nav_13" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_13">
          关于我
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="关于我" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          关于我
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2024-9-24-myblog-life-docs/" class="md-nav__link">
        我的博客
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2021-life-docs/" class="md-nav__link">
        我的2021
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2022-life-docs/" class="md-nav__link">
        我的2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2023-life-docs/" class="md-nav__link">
        我的2023
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2024-life-docs/" class="md-nav__link">
        我的2024
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_6" data-md-state="indeterminate" type="checkbox" id="__nav_13_6" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_13_6">
          我的2025
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="我的2025" data-md-level="2">
        <label class="md-nav__title" for="__nav_13_6">
          <span class="md-nav__icon md-icon"></span>
          我的2025
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2025-life-docs/" class="md-nav__link">
        我的2025
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2025/2025-life-qianguize-doc/" class="md-nav__link">
        一个很脏但是很现实的男女潜规则
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2025-learning-docs/" class="md-nav__link">
        我的学习
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    一、Introduction (简介)
  </a>
  
    <nav class="md-nav" aria-label="一、Introduction (简介)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-overview" class="md-nav__link">
    1.1 Overview (概览)
  </a>
  
    <nav class="md-nav" aria-label="1.1 Overview (概览)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus_1" class="md-nav__link">
    什么是 Prometheus?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    主要特性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    什么是指标（Metrics）？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    组件架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    架构图
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    适用场景
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-first-steps" class="md-nav__link">
    1.2 First Steps (入门步骤)
  </a>
  
    <nav class="md-nav" aria-label="1.2 First Steps (入门步骤)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus_2" class="md-nav__link">
    下载 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_3" class="md-nav__link">
    配置 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_4" class="md-nav__link">
    启动 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    使用表达式浏览器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    使用图形界面
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    监控其他目标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-comparison" class="md-nav__link">
    1.3 Comparison (与其他监控系统对比)
  </a>
  
    <nav class="md-nav" aria-label="1.3 Comparison (与其他监控系统对比)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-graphite" class="md-nav__link">
    Prometheus vs. Graphite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-influxdb" class="md-nav__link">
    Prometheus vs. InfluxDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-opentsdb" class="md-nav__link">
    Prometheus vs. OpenTSDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-nagios" class="md-nav__link">
    Prometheus vs. Nagios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-vs-sensu" class="md-nav__link">
    Prometheus vs. Sensu
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concepts" class="md-nav__link">
    二、Concepts (核心概念)
  </a>
  
    <nav class="md-nav" aria-label="二、Concepts (核心概念)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-data-model" class="md-nav__link">
    2.1 Data Model (数据模型)
  </a>
  
    <nav class="md-nav" aria-label="2.1 Data Model (数据模型)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    时间序列数据
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    指标名称和标签
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samples" class="md-nav__link">
    样本（Samples）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notation" class="md-nav__link">
    表示法（Notation）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-metric-types" class="md-nav__link">
    2.2 Metric Types (指标类型)
  </a>
  
    <nav class="md-nav" aria-label="2.2 Metric Types (指标类型)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#counter" class="md-nav__link">
    Counter (计数器)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gauge" class="md-nav__link">
    Gauge (仪表)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#histogram" class="md-nav__link">
    Histogram (直方图)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary (摘要)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-jobs-and-instances" class="md-nav__link">
    2.3 Jobs and Instances (任务与实例)
  </a>
  
    <nav class="md-nav" aria-label="2.3 Jobs and Instances (任务与实例)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    基本概念
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    自动生成的标签和时间序列
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    自动生成的指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server" class="md-nav__link">
    三、Server (服务器)
  </a>
  
    <nav class="md-nav" aria-label="三、Server (服务器)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-getting-started" class="md-nav__link">
    3.1 Getting Started (快速开始)
  </a>
  
    <nav class="md-nav" aria-label="3.1 Getting Started (快速开始)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus_5" class="md-nav__link">
    下载和运行 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_6" class="md-nav__link">
    配置 Prometheus 监控自身
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_7" class="md-nav__link">
    启动 Prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    使用表达式浏览器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    使用图形界面
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    启动示例目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_8" class="md-nav__link">
    配置 Prometheus 监控示例目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    配置聚合规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    重新加载配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    优雅关闭实例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-installation" class="md-nav__link">
    3.2 Installation (安装)
  </a>
  
    <nav class="md-nav" aria-label="3.2 Installation (安装)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    安装方式概览
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    方式一：使用预编译二进制文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    方式二：从源码编译
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    方式三：使用 Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker_1" class="md-nav__link">
    Docker 高级配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker_2" class="md-nav__link">
    Docker 部署完整示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    安装方式对比
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    总结
  </a>
  
    <nav class="md-nav" aria-label="总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#33-configuration" class="md-nav__link">
    3.3 Configuration (配置详解)
  </a>
  
    <nav class="md-nav" aria-label="3.3 Configuration (配置详解)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    配置文件基础
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    配置文件结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    通用占位符说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#global" class="md-nav__link">
    Global 全局配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtime" class="md-nav__link">
    Runtime 运行时配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scrape-configs" class="md-nav__link">
    Scrape Configs 抓取配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-config-http" class="md-nav__link">
    HTTP Config HTTP 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-discovery" class="md-nav__link">
    服务发现 (Service Discovery)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relabel-configs" class="md-nav__link">
    Relabel Configs 重新标记配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alerting" class="md-nav__link">
    Alerting 告警配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-writeread" class="md-nav__link">
    Remote Write/Read 远程写入/读取
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage" class="md-nav__link">
    Storage 存储配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    完整配置示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    总结
  </a>
  
    <nav class="md-nav" aria-label="总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#34-recording-rules" class="md-nav__link">
    3.4 Recording Rules (记录规则)
  </a>
  
    <nav class="md-nav" aria-label="3.4 Recording Rules (记录规则)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    规则配置基础
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    规则文件结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recording-rule" class="md-nav__link">
    Recording Rule 语法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    记录规则命名最佳实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    规则组配置选项
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    规则评估性能优化
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-alerting-rules" class="md-nav__link">
    3.5 Alerting Rules (告警规则)
  </a>
  
    <nav class="md-nav" aria-label="3.5 Alerting Rules (告警规则)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    告警规则语法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    告警规则示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    告警状态转换
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    告警模板化
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    告警最佳实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    查看告警状态
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alertmanager" class="md-nav__link">
    集成 Alertmanager
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36-template-examples" class="md-nav__link">
    3.6 Template Examples (模板示例)
  </a>
  
    <nav class="md-nav" aria-label="3.6 Template Examples (模板示例)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    告警字段模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    简单迭代
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    显示单个值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#url" class="md-nav__link">
    使用控制台 URL 参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    高级迭代示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    定义可重用模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    常用模板函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    实用模板示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    模板调试技巧
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-querying" class="md-nav__link">
    4. Querying (查询)
  </a>
  
    <nav class="md-nav" aria-label="4. Querying (查询)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-basics" class="md-nav__link">
    4.1 Basics (基础)
  </a>
  
    <nav class="md-nav" aria-label="4.1 Basics (基础)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#promql" class="md-nav__link">
    PromQL 查询类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    表达式数据类型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-querying_1" class="md-nav__link">
    4. Querying (查询)
  </a>
  
    <nav class="md-nav" aria-label="4. Querying (查询)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-basics_1" class="md-nav__link">
    4.1 Basics (基础)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-operators" class="md-nav__link">
    4.2 Operators (操作符)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-functions" class="md-nav__link">
    4.3 Functions (函数)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-examples" class="md-nav__link">
    4.4 Examples (示例)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#promql_1" class="md-nav__link">
    PromQL 最佳实践
  </a>
  
    <nav class="md-nav" aria-label="PromQL 最佳实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#45-api-http-api" class="md-nav__link">
    4.5 API (HTTP API)
  </a>
  
    <nav class="md-nav" aria-label="4.5 API (HTTP API)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    API 响应格式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-api" class="md-nav__link">
    1. 表达式查询 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-api" class="md-nav__link">
    2. 元数据查询 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3. 目标和规则查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-api" class="md-nav__link">
    4. 状态和配置 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-api-webenable-admin-api" class="md-nav__link">
    5. 管理 API (需启用 --web.enable-admin-api)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-api" class="md-nav__link">
    6. 实用工具 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-api" class="md-nav__link">
    7. 常用 API 调用示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-api" class="md-nav__link">
    8. API 使用最佳实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9. 编程语言客户端示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api_1" class="md-nav__link">
    API 快速参考
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-storage" class="md-nav__link">
    5. Storage (存储)
  </a>
  
    <nav class="md-nav" aria-label="5. Storage (存储)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1 本地存储
  </a>
  
    <nav class="md-nav" aria-label="5.1 本地存储">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    磁盘布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wal-write-ahead-log" class="md-nav__link">
    WAL (Write-Ahead Log)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compaction" class="md-nav__link">
    压缩 (Compaction)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    存储配置参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    容量规划
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    保留策略
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    数据完整性
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2 远程存储集成
  </a>
  
    <nav class="md-nav" aria-label="5.2 远程存储集成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    四种集成方式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    协议特性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-write-receiver" class="md-nav__link">
    Remote Write Receiver
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-read" class="md-nav__link">
    Remote Read 限制
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-backfilling" class="md-nav__link">
    5.3 数据回填 (Backfilling)
  </a>
  
    <nav class="md-nav" aria-label="5.3 数据回填 (Backfilling)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openmetrics" class="md-nav__link">
    OpenMetrics 格式回填
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recording-rules" class="md-nav__link">
    Recording Rules 回填
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-federation" class="md-nav__link">
    6. Federation (联邦)
  </a>
  
    <nav class="md-nav" aria-label="6. Federation (联邦)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1 使用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-federation" class="md-nav__link">
    6.2 配置 Federation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-management-api-api" class="md-nav__link">
    7. Management API (管理 API)
  </a>
  
    <nav class="md-nav" aria-label="7. Management API (管理 API)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-api" class="md-nav__link">
    7.1 健康检查 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-api" class="md-nav__link">
    7.2 配置管理 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73" class="md-nav__link">
    7.3 使用场景
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-command-line" class="md-nav__link">
    8. Command Line (命令行工具)
  </a>
  
    <nav class="md-nav" aria-label="8. Command Line (命令行工具)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-prometheus" class="md-nav__link">
    8.1 Prometheus 命令
  </a>
  
    <nav class="md-nav" aria-label="8.1 Prometheus 命令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    基本用法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    核心启动参数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    存储配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    查询配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    规则和告警配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_65" class="md-nav__link">
    特性标志
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_66" class="md-nav__link">
    日志配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    Agent 模式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_67" class="md-nav__link">
    完整启动示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-promtool" class="md-nav__link">
    8.2 Promtool 工具
  </a>
  
    <nav class="md-nav" aria-label="8.2 Promtool 工具">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_68" class="md-nav__link">
    基本用法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_69" class="md-nav__link">
    常用命令列表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-check-" class="md-nav__link">
    1. Check 命令 - 验证配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-query-" class="md-nav__link">
    2. Query 命令 - 执行查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-test-" class="md-nav__link">
    3. Test 命令 - 单元测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-tsdb-" class="md-nav__link">
    4. TSDB 命令 - 数据库操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-debug-" class="md-nav__link">
    5. Debug 命令 - 调试信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-push-" class="md-nav__link">
    6. Push 命令 - 推送数据
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-promql-" class="md-nav__link">
    7. PromQL 命令 - 格式化 (实验性)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell" class="md-nav__link">
    实用 Shell 脚本示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_70" class="md-nav__link">
    命令行工具最佳实践
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-migration" class="md-nav__link">
    9. Migration (迁移指南)
  </a>
  
    <nav class="md-nav" aria-label="9. Migration (迁移指南)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus-30" class="md-nav__link">
    Prometheus 3.0 迁移指南
  </a>
  
    <nav class="md-nav" aria-label="Prometheus 3.0 迁移指南">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_71" class="md-nav__link">
    已移除的特性标志
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_72" class="md-nav__link">
    配置变更
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promql_2" class="md-nav__link">
    PromQL 变更
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_73" class="md-nav__link">
    抓取协议变更
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_74" class="md-nav__link">
    其他重要变更
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-feature-flags" class="md-nav__link">
    10. Feature Flags (特性标志)
  </a>
  
    <nav class="md-nav" aria-label="10. Feature Flags (特性标志)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_75" class="md-nav__link">
    可用特性标志
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-security" class="md-nav__link">
    11. Security (安全)
  </a>
  
    <nav class="md-nav" aria-label="11. Security (安全)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_76" class="md-nav__link">
    安全模型概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_77" class="md-nav__link">
    安全假设
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api_2" class="md-nav__link">
    管理 API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_78" class="md-nav__link">
    组件安全
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_79" class="md-nav__link">
    认证、授权和加密
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api_3" class="md-nav__link">
    API 安全
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_80" class="md-nav__link">
    秘密管理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dos" class="md-nav__link">
    DoS 防护
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_81" class="md-nav__link">
    漏洞报告
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-overview" class="md-nav__link">
    12. Overview (概览)
  </a>
  
    <nav class="md-nav" aria-label="12. Overview (概览)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prometheus_9" class="md-nav__link">
    什么是 Prometheus?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_82" class="md-nav__link">
    主要特性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_83" class="md-nav__link">
    什么是指标?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_84" class="md-nav__link">
    组件生态
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_85" class="md-nav__link">
    架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_86" class="md-nav__link">
    适用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_87" class="md-nav__link">
    不适用场景
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-alertmanager" class="md-nav__link">
    13. Alertmanager (告警管理器)
  </a>
  
    <nav class="md-nav" aria-label="13. Alertmanager (告警管理器)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_88" class="md-nav__link">
    核心功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_89" class="md-nav__link">
    核心概念
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-grouping" class="md-nav__link">
    1. Grouping (分组)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-inhibition" class="md-nav__link">
    2. Inhibition (抑制)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-silences" class="md-nav__link">
    3. Silences (静默)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_90" class="md-nav__link">
    高可用性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_91" class="md-nav__link">
    配置示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_92" class="md-nav__link">
    通知接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_93" class="md-nav__link">
    最佳实践
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-alerting-configuration-alertmanager" class="md-nav__link">
    14. Alerting Configuration (Alertmanager 配置)
  </a>
  
    <nav class="md-nav" aria-label="14. Alerting Configuration (Alertmanager 配置)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#141" class="md-nav__link">
    14.1 配置文件基础
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#142" class="md-nav__link">
    14.2 全局配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#143-route" class="md-nav__link">
    14.3 路由配置 (Route)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#144-time-intervals" class="md-nav__link">
    14.4 时间间隔 (Time Intervals)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#145-inhibition" class="md-nav__link">
    14.5 抑制规则 (Inhibition)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#146-matchers" class="md-nav__link">
    14.6 标签匹配器 (Matchers)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#147-receivers" class="md-nav__link">
    14.7 接收器 (Receivers)
  </a>
  
    <nav class="md-nav" aria-label="14.7 接收器 (Receivers)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#email" class="md-nav__link">
    Email 接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slack" class="md-nav__link">
    Slack 接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pagerduty" class="md-nav__link">
    PagerDuty 接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webhook" class="md-nav__link">
    Webhook 接收器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_94" class="md-nav__link">
    其他接收器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#148-http" class="md-nav__link">
    14.8 HTTP 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#149" class="md-nav__link">
    14.9 完整配置示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1410" class="md-nav__link">
    14.10 模板变量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1411" class="md-nav__link">
    14.11 验证和测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1412" class="md-nav__link">
    14.12 最佳实践
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_95" class="md-nav__link">
    配置快速参考
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-notification-examples" class="md-nav__link">
    15. Notification Examples (通知示例)
  </a>
  
    <nav class="md-nav" aria-label="15. Notification Examples (通知示例)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#151-slack" class="md-nav__link">
    15.1 自定义 Slack 通知
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#152-annotations" class="md-nav__link">
    15.2 访问注解 (Annotations)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#153" class="md-nav__link">
    15.3 遍历所有告警
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#154" class="md-nav__link">
    15.4 定义可复用模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#155" class="md-nav__link">
    15.5 更多实用模板示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#156" class="md-nav__link">
    15.6 模板函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#157" class="md-nav__link">
    15.7 完整模板文件示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-alertmanager-management-api" class="md-nav__link">
    16. Alertmanager Management API
  </a>
  
    <nav class="md-nav" aria-label="16. Alertmanager Management API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#161" class="md-nav__link">
    16.1 健康检查
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#162" class="md-nav__link">
    16.2 就绪检查
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#163" class="md-nav__link">
    16.3 重载配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#164" class="md-nav__link">
    16.4 自动化脚本示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#165-api" class="md-nav__link">
    16.5 API 使用最佳实践
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_96" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-practices" class="md-nav__link">
    17. Practices (最佳实践)
  </a>
  
    <nav class="md-nav" aria-label="17. Practices (最佳实践)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#171-naming" class="md-nav__link">
    17.1 Naming (命名规范)
  </a>
  
    <nav class="md-nav" aria-label="17.1 Naming (命名规范)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_97" class="md-nav__link">
    指标名称规范
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_98" class="md-nav__link">
    为什么在名称中包含单位和类型?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_99" class="md-nav__link">
    标签规范
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_100" class="md-nav__link">
    基础单位
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#172-instrumentation" class="md-nav__link">
    17.2 Instrumentation (埋点)
  </a>
  
    <nav class="md-nav" aria-label="17.2 Instrumentation (埋点)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_101" class="md-nav__link">
    如何埋点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_102" class="md-nav__link">
    三种服务类型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_103" class="md-nav__link">
    子系统埋点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_104" class="md-nav__link">
    需要注意的事项
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#173-histograms" class="md-nav__link">
    17.3 Histograms (直方图)
  </a>
  
    <nav class="md-nav" aria-label="17.3 Histograms (直方图)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#count-sum" class="md-nav__link">
    Count 和 Sum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apdex" class="md-nav__link">
    Apdex 分数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quantiles" class="md-nav__link">
    Quantiles (分位数)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_105" class="md-nav__link">
    选择建议
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_106" class="md-nav__link">
    分位数误差
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#174-alerting" class="md-nav__link">
    17.4 Alerting (告警最佳实践)
  </a>
  
    <nav class="md-nav" aria-label="17.4 Alerting (告警最佳实践)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_107" class="md-nav__link">
    核心原则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_108" class="md-nav__link">
    告警命名
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_109" class="md-nav__link">
    告警内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_110" class="md-nav__link">
    容量告警
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metamonitoring" class="md-nav__link">
    元监控 (Metamonitoring)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#175-recording-rules" class="md-nav__link">
    17.5 Recording Rules (记录规则)
  </a>
  
    <nav class="md-nav" aria-label="17.5 Recording Rules (记录规则)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_111" class="md-nav__link">
    命名约定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_112" class="md-nav__link">
    命名规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_113" class="md-nav__link">
    聚合规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_114" class="md-nav__link">
    完整示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#176-pushing-metrics" class="md-nav__link">
    17.6 Pushing Metrics (推送指标)
  </a>
  
    <nav class="md-nav" aria-label="17.6 Pushing Metrics (推送指标)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pushgateway" class="md-nav__link">
    何时使用 Pushgateway?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pushgateway_1" class="md-nav__link">
    Pushgateway 的问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_115" class="md-nav__link">
    唯一有效用例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_116" class="md-nav__link">
    替代策略
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_117" class="md-nav__link">
    最佳实践总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practices" class="md-nav__link">
    Practices 快速参考
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-exporters" class="md-nav__link">
    18. Exporters (导出器列表)
  </a>
  
    <nav class="md-nav" aria-label="18. Exporters (导出器列表)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#databases" class="md-nav__link">
    Databases (数据库)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware-related" class="md-nav__link">
    Hardware Related (硬件相关)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#issue-trackers-cicd" class="md-nav__link">
    Issue Trackers &amp; CI/CD (问题跟踪 &amp; 持续集成)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#messaging-systems" class="md-nav__link">
    Messaging Systems (消息系统)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage_1" class="md-nav__link">
    Storage (存储)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-http" class="md-nav__link">
    HTTP (HTTP 服务器)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apis-api" class="md-nav__link">
    APIs (API 服务)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging (日志)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finops" class="md-nav__link">
    FinOps (成本管理)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#miscellaneous" class="md-nav__link">
    Miscellaneous (其他)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#golang-exporter" class="md-nav__link">
    附录: Golang Exporter 完整示例
  </a>
  
    <nav class="md-nav" aria-label="附录: Golang Exporter 完整示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_118" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_119" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_120" class="md-nav__link">
    使用说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_121" class="md-nav__link">
    代码要点解析
  </a>
  
    <nav class="md-nav" aria-label="代码要点解析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-gauge-collector" class="md-nav__link">
    1. Gauge 指标 (自定义 Collector)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-histogram" class="md-nav__link">
    2. Histogram 指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_10" class="md-nav__link">
    Prometheus 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promql_3" class="md-nav__link">
    PromQL 查询示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_122" class="md-nav__link">
    最佳实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_123" class="md-nav__link">
    扩展示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_124" class="md-nav__link">
    故障排查
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_125" class="md-nav__link">
    总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pushgateway-golang" class="md-nav__link">
    附录: Pushgateway Golang 示例
  </a>
  
    <nav class="md-nav" aria-label="附录: Pushgateway Golang 示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_126" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_127" class="md-nav__link">
    适用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_128" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_129" class="md-nav__link">
    使用说明
  </a>
  
    <nav class="md-nav" aria-label="使用说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-pushgateway" class="md-nav__link">
    1. 启动 Pushgateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-go" class="md-nav__link">
    2. 安装 Go 依赖
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    3. 运行示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4. 查看推送的指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_130" class="md-nav__link">
    核心概念
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-push-vs-add-vs-delete" class="md-nav__link">
    1. Push vs Add vs Delete
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-grouping-labels" class="md-nav__link">
    2. 分组标签 (Grouping Labels)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-registry" class="md-nav__link">
    3. Registry 使用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_131" class="md-nav__link">
    实际应用场景
  </a>
  
    <nav class="md-nav" aria-label="实际应用场景">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-cron-job" class="md-nav__link">
    场景 1: Cron Job 批处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    场景 2: 数据处理脚本
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_2" class="md-nav__link">
    场景 3: 定期推送 (长期运行脚本)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_11" class="md-nav__link">
    Prometheus 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promql_4" class="md-nav__link">
    PromQL 查询示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_132" class="md-nav__link">
    最佳实践
  </a>
  
    <nav class="md-nav" aria-label="最佳实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-add-push" class="md-nav__link">
    1. 使用 Add 而非 Push (多指标场景)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    2. 任务结束时删除指标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_3" class="md-nav__link">
    3. 添加时间戳指标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_1" class="md-nav__link">
    4. 错误处理和重试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_133" class="md-nav__link">
    安全性
  </a>
  
    <nav class="md-nav" aria-label="安全性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-basic-auth" class="md-nav__link">
    1. 使用 Basic Auth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-tls" class="md-nav__link">
    2. TLS 加密
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_134" class="md-nav__link">
    常见问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pushgateway_2" class="md-nav__link">
    监控 Pushgateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_135" class="md-nav__link">
    总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#textfile-collector" class="md-nav__link">
    附录: Textfile Collector 示例
  </a>
  
    <nav class="md-nav" aria-label="附录: Textfile Collector 示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_136" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_137" class="md-nav__link">
    适用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_138" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_139" class="md-nav__link">
    使用说明
  </a>
  
    <nav class="md-nav" aria-label="使用说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-node-exporter" class="md-nav__link">
    1. 安装 Node Exporter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-go_1" class="md-nav__link">
    2. 安装 Go 依赖
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_4" class="md-nav__link">
    3. 运行示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-prom" class="md-nav__link">
    4. 生成的 .prom 文件内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5. 访问指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api_4" class="md-nav__link">
    核心 API 详解
  </a>
  
    <nav class="md-nav" aria-label="核心 API 详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-registrygather" class="md-nav__link">
    1. registry.Gather()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-expfmtmetricfamilytotext" class="md-nav__link">
    2. expfmt.MetricFamilyToText()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_140" class="md-nav__link">
    实际应用场景
  </a>
  
    <nav class="md-nav" aria-label="实际应用场景">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    场景 1: 备份任务指标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_2" class="md-nav__link">
    场景 2: 磁盘配额监控
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-shell" class="md-nav__link">
    场景 3: Shell 脚本生成指标
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_141" class="md-nav__link">
    最佳实践
  </a>
  
    <nav class="md-nav" aria-label="最佳实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    1. 使用原子写入
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_3" class="md-nav__link">
    2. 添加文件修改时间指标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_5" class="md-nav__link">
    3. 错误处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_2" class="md-nav__link">
    4. 文件权限
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_12" class="md-nav__link">
    Prometheus 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promql_5" class="md-nav__link">
    PromQL 查询示例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#textfile-collector_1" class="md-nav__link">
    监控 Textfile Collector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_142" class="md-nav__link">
    常见问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_143" class="md-nav__link">
    性能考虑
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_144" class="md-nav__link">
    总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python-shell" class="md-nav__link">
    附录: Python &amp; Shell 完整示例
  </a>
  
    <nav class="md-nav" aria-label="附录: Python &amp; Shell 完整示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-http-exporter" class="md-nav__link">
    Python HTTP Exporter
  </a>
  
    <nav class="md-nav" aria-label="Python HTTP Exporter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_145" class="md-nav__link">
    概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_146" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_147" class="md-nav__link">
    安装和运行
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-pushgateway" class="md-nav__link">
    Python Pushgateway
  </a>
  
    <nav class="md-nav" aria-label="Python Pushgateway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_148" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_149" class="md-nav__link">
    运行
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-textfile-collector" class="md-nav__link">
    Python Textfile Collector
  </a>
  
    <nav class="md-nav" aria-label="Python Textfile Collector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_150" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crontab" class="md-nav__link">
    Crontab 配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell-textfile-collector" class="md-nav__link">
    Shell Textfile Collector
  </a>
  
    <nav class="md-nav" aria-label="Shell Textfile Collector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_151" class="md-nav__link">
    完整代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_152" class="md-nav__link">
    使用方法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_153" class="md-nav__link">
    对比总结
  </a>
  
    <nav class="md-nav" aria-label="对比总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_154" class="md-nav__link">
    语言选择
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_155" class="md-nav__link">
    模式选择
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_156" class="md-nav__link">
    最佳实践
  </a>
  
    <nav class="md-nav" aria-label="最佳实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#http-exporter" class="md-nav__link">
    HTTP Exporter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pushgateway_3" class="md-nav__link">
    Pushgateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#textfile-collector_2" class="md-nav__link">
    Textfile Collector
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus_13" class="md-nav__link">
    Prometheus 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_157" class="md-nav__link">
    总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/Yuki-0215/Yuki-0215.github.io/edit/master/docs/2.k8s/monitoring/2025-12-24-Prometheus_Learning_Notes.md" title="编辑此页" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="prometheus">Prometheus 中文学习笔记<a class="headerlink" href="#prometheus" title="Permanent link">&para;</a></h1>
<blockquote>
<p>基于Prometheus官网文档，结合Prometheus 3.5 &amp; Alertmanager 0.27整理而成。</p>
</blockquote>
<hr />
<h2 id="introduction">一、Introduction (简介)<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<h3 id="11-overview">1.1 Overview (概览)<a class="headerlink" href="#11-overview" title="Permanent link">&para;</a></h3>
<h4 id="prometheus_1">什么是 Prometheus?<a class="headerlink" href="#prometheus_1" title="Permanent link">&para;</a></h4>
<p><strong>Prometheus</strong> 是一个开源的系统监控和告警工具包，最初由 SoundCloud 构建。自 2012 年诞生以来，许多公司和组织都采用了 Prometheus，该项目拥有非常活跃的开发者和用户社区。2016 年，Prometheus 作为第二个托管项目（继 Kubernetes 之后）加入了云原生计算基金会（CNCF）。</p>
<p><strong>核心特性：</strong></p>
<ul>
<li>Prometheus 以<strong>时间序列数据</strong>的形式收集和存储指标</li>
<li>指标信息与记录时的时间戳一起存储</li>
<li>可选的键值对称为<strong>标签（Labels）</strong></li>
</ul>
<h4 id="_1">主要特性<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>多维数据模型</strong></p>
</li>
<li>
<p>时间序列数据通过指标名称和键值对（标签）进行标识</p>
</li>
<li>
<p><strong>灵活的查询语言 PromQL</strong></p>
</li>
<li>
<p>利用维度性进行强大的数据查询</p>
</li>
<li>
<p><strong>不依赖分布式存储</strong></p>
</li>
<li>
<p>单个服务器节点是自治的</p>
</li>
<li>
<p><strong>基于 HTTP 的 Pull 模型</strong></p>
</li>
<li>
<p>通过 HTTP 拉取方式采集时间序列数据</p>
</li>
<li>
<p><strong>支持推送时间序列</strong></p>
</li>
<li>
<p>通过中间网关（Push Gateway）支持短生命周期的任务</p>
</li>
<li>
<p><strong>服务发现</strong></p>
</li>
<li>
<p>通过服务发现或静态配置发现目标</p>
</li>
<li><strong>多种图形和仪表板支持</strong></li>
</ol>
<h4 id="metrics">什么是指标（Metrics）？<a class="headerlink" href="#metrics" title="Permanent link">&para;</a></h4>
<p><strong>指标</strong>是数值测量的通俗术语。<strong>时间序列</strong>是指随时间变化的记录。</p>
<p><strong>应用场景示例：</strong></p>
<ul>
<li><strong>Web 服务器</strong>: 请求时间</li>
<li><strong>数据库</strong>: 活跃连接数、活跃查询数</li>
<li><strong>应用性能</strong>: 当请求数量高时，应用可能变慢，通过请求计数指标可以确定原因并增加服务器数量</li>
</ul>
<h4 id="_2">组件架构<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>Prometheus 生态系统由多个组件组成，其中许多是可选的：</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Prometheus Server</strong></td>
<td>抓取和存储时间序列数据的主服务器</td>
</tr>
<tr>
<td><strong>Client Libraries</strong></td>
<td>用于为应用程序代码添加监控埋点的客户端库</td>
</tr>
<tr>
<td><strong>Push Gateway</strong></td>
<td>支持短生命周期任务的推送网关</td>
</tr>
<tr>
<td><strong>Exporters</strong></td>
<td>用于 HAProxy、StatsD、Graphite 等服务的专用导出器</td>
</tr>
<tr>
<td><strong>Alertmanager</strong></td>
<td>处理告警的告警管理器</td>
</tr>
<tr>
<td><strong>Support Tools</strong></td>
<td>各种支持工具</td>
</tr>
</tbody>
</table>
<blockquote>
<p>大多数 Prometheus 组件使用 <strong>Go</strong> 语言编写，易于构建和部署为静态二进制文件。</p>
</blockquote>
<h4 id="_3">架构图<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    A[Prometheus Server] --&gt;|scrape| B[Jobs/Exporters]
    A --&gt;|scrape| C[Short-lived Jobs]
    C --&gt;|push| D[Push Gateway]
    A --&gt;|scrape| D
    A --&gt; E[TSDB 本地存储]
    A --&gt;|PromQL| F[Alertmanager]
    F --&gt;|通知| G[Email/Pagerduty/etc]
    A --&gt;|HTTP API| H[Grafana]
    A --&gt;|HTTP API| I[API Clients]
    J[Service Discovery] -.发现.-&gt; A
    K[Static Config] -.配置.-&gt; A
</code></pre></div>
<p><strong>工作流程：</strong></p>
<ol>
<li>Prometheus 从被监控的任务中抓取指标，可以直接抓取，也可以通过推送网关抓取短生命周期的任务</li>
<li>将所有抓取的样本存储在本地</li>
<li>对数据运行规则以聚合和记录新的时间序列，或生成告警</li>
<li>使用 Grafana 或其他 API 消费者可视化收集的数据</li>
</ol>
<h4 id="_4">适用场景<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p><strong>✅ 适合使用 Prometheus 的场景：</strong></p>
<ul>
<li>记录纯数值时间序列数据</li>
<li>面向机器的监控</li>
<li>高度动态的面向服务的架构监控</li>
<li>微服务环境（多维数据收集和查询是其特别优势）</li>
<li>需要高可靠性的场景（每个 Prometheus 服务器是独立的，不依赖网络存储或其他远程服务）</li>
</ul>
<p><strong>❌ 不适合使用 Prometheus 的场景：</strong></p>
<ul>
<li>需要 100% 准确性的场景（如按请求计费）</li>
<li>Prometheus 更注重可靠性而非绝对准确性</li>
<li>对于需要详细和完整数据的计费系统，建议使用其他系统进行数据收集和分析</li>
</ul>
<hr />
<h3 id="12-first-steps">1.2 First Steps (入门步骤)<a class="headerlink" href="#12-first-steps" title="Permanent link">&para;</a></h3>
<p>本节将指导你完成 Prometheus 的安装、配置和监控第一个资源的过程。</p>
<h4 id="prometheus_2">下载 Prometheus<a class="headerlink" href="#prometheus_2" title="Permanent link">&para;</a></h4>
<ol>
<li>下载适合你平台的最新版本 Prometheus</li>
<li>解压文件：</li>
</ol>
<div class="highlight"><pre><span></span><code>tar<span class="w"> </span>xvfz<span class="w"> </span>prometheus-*.tar.gz
<span class="nb">cd</span><span class="w"> </span>prometheus-*
</code></pre></div>
<ol>
<li>Prometheus 服务器是一个名为 <code>prometheus</code> 的单一二进制文件（Windows 上为 <code>prometheus.exe</code>）</li>
<li>查看帮助信息：</li>
</ol>
<div class="highlight"><pre><span></span><code>./prometheus<span class="w"> </span>--help
</code></pre></div>
<h4 id="prometheus_3">配置 Prometheus<a class="headerlink" href="#prometheus_3" title="Permanent link">&para;</a></h4>
<p>Prometheus 使用 <strong>YAML</strong> 格式进行配置。下载包中包含一个示例配置文件 <code>prometheus.yml</code>。</p>
<p><strong>配置文件示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w">     </span><span class="l l-Scalar l-Scalar-Plain">15s</span><span class="w">    </span><span class="c1"># 全局抓取间隔</span>
<span class="w">  </span><span class="nt">evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span><span class="w">    </span><span class="c1"># 规则评估间隔</span>

<span class="nt">rule_files</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># - &quot;first.rules&quot;</span>
<span class="w">  </span><span class="c1"># - &quot;second.rules&quot;</span>

<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prometheus</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9090&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>配置文件三大块：</strong></p>
<table>
<thead>
<tr>
<th>配置块</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>global</strong></td>
<td>Prometheus 服务器的全局配置</td>
</tr>
<tr>
<td><strong>rule_files</strong></td>
<td>指定 Prometheus 服务器要加载的规则文件位置</td>
</tr>
<tr>
<td><strong>scrape_configs</strong></td>
<td>控制 Prometheus 监控哪些资源</td>
</tr>
</tbody>
</table>
<p><strong>配置详解：</strong></p>
<ol>
<li>
<p><strong>global 块</strong></p>
</li>
<li>
<p><code>scrape_interval</code>: 控制 Prometheus 抓取目标的频率（默认 15 秒）</p>
</li>
<li><code>evaluation_interval</code>: 控制 Prometheus 评估规则的频率</li>
<li>
<p><strong>rule_files 块</strong></p>
</li>
<li>
<p>指定规则文件位置</p>
</li>
<li>Prometheus 使用规则创建新时间序列和生成告警</li>
<li>
<p><strong>scrape_configs 块</strong></p>
</li>
<li>
<p>定义监控目标</p>
</li>
<li>默认配置包含一个名为 <code>prometheus</code> 的任务，抓取 Prometheus 服务器自身暴露的时间序列数据</li>
<li>默认抓取路径: <code>http://localhost:9090/metrics</code></li>
</ol>
<h4 id="prometheus_4">启动 Prometheus<a class="headerlink" href="#prometheus_4" title="Permanent link">&para;</a></h4>
<p>使用配置文件启动 Prometheus：</p>
<div class="highlight"><pre><span></span><code>./prometheus<span class="w"> </span>--config.file<span class="o">=</span>prometheus.yml
</code></pre></div>
<p>启动后，可以访问以下地址：</p>
<ul>
<li><strong>状态页面</strong>: <code>http://localhost:9090</code></li>
<li><strong>指标端点</strong>: <code>http://localhost:9090/metrics</code></li>
</ul>
<h4 id="_5">使用表达式浏览器<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<ol>
<li>访问表达式浏览器: <code>http://localhost:9090/graph</code></li>
<li>选择 "Graph" 标签页中的 "Table" 视图</li>
</ol>
<p><strong>查询示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询 Prometheus 服务器处理的 /metrics 请求总数</span>
<span class="nv">promhttp_metric_handler_requests_total</span>

<span class="c1"># 仅查询 HTTP 状态码 200 的请求</span>
<span class="nv">promhttp_metric_handler_requests_total</span><span class="p">{</span><span class="nl">code</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;}</span>

<span class="c1"># 计算返回的时间序列数量</span>
<span class="k">count</span><span class="o">(</span><span class="nv">promhttp_metric_handler_requests_total</span><span class="o">)</span>
</code></pre></div>
<h4 id="_6">使用图形界面<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>访问 <code>http://localhost:9090/graph</code> 并使用 "Graph" 标签页。</p>
<p><strong>示例：绘制每秒 HTTP 请求速率</strong></p>
<div class="highlight"><pre><span></span><code><span class="kr">rate</span><span class="o">(</span><span class="nv">promhttp_metric_handler_requests_total</span><span class="p">{</span><span class="nl">code</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;}[</span><span class="s">1m</span><span class="p">]</span><span class="o">)</span>
</code></pre></div>
<h4 id="_7">监控其他目标<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>要更好地了解 Prometheus 的功能，推荐探索其他导出器的文档，例如：</p>
<ul>
<li>使用 Node Exporter 监控 Linux 或 macOS 主机指标</li>
</ul>
<hr />
<h3 id="13-comparison">1.3 Comparison (与其他监控系统对比)<a class="headerlink" href="#13-comparison" title="Permanent link">&para;</a></h3>
<h4 id="prometheus-vs-graphite">Prometheus vs. Graphite<a class="headerlink" href="#prometheus-vs-graphite" title="Permanent link">&para;</a></h4>
<p><strong>范围（Scope）</strong></p>
<ul>
<li><strong>Graphite</strong>: 被动的时间序列数据库，具有查询语言和图形功能，其他关注点由外部组件处理</li>
<li><strong>Prometheus</strong>: 完整的监控和趋势系统，包括内置的主动抓取、存储、查询、图形和告警功能</li>
</ul>
<p><strong>数据模型（Data Model）</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Graphite</th>
<th>Prometheus</th>
</tr>
</thead>
<tbody>
<tr>
<td>指标命名</td>
<td>点分隔的组件（隐式编码维度）</td>
<td>显式的键值对标签</td>
</tr>
<tr>
<td>示例</td>
<td><code>stats.api-server.tracks.post.500 -&gt; 93</code></td>
<td><code>api_server_http_requests_total{method="POST",handler="/tracks",status="500",instance="sample1"} -&gt; 34</code></td>
</tr>
<tr>
<td>维度支持</td>
<td>隐式</td>
<td>显式，易于过滤、分组和匹配</td>
</tr>
</tbody>
</table>
<p><strong>存储（Storage）</strong></p>
<ul>
<li><strong>Graphite</strong>: 使用 Whisper 格式在本地磁盘存储（RRD 风格数据库），样本需按固定间隔到达</li>
<li><strong>Prometheus</strong>: 每个时间序列一个本地文件，允许以任意间隔存储样本，新样本简单追加，可长期保留旧数据</li>
</ul>
<p><strong>总结</strong></p>
<ul>
<li>✅ <strong>Prometheus 优势</strong>: 更丰富的数据模型和查询语言，更易于运行和集成</li>
<li>✅ <strong>Graphite 优势</strong>: 如果需要集群化解决方案和长期历史数据存储</li>
</ul>
<hr />
<h4 id="prometheus-vs-influxdb">Prometheus vs. InfluxDB<a class="headerlink" href="#prometheus-vs-influxdb" title="Permanent link">&para;</a></h4>
<p><strong>范围（Scope）</strong></p>
<ul>
<li>需要将 <strong>Kapacitor</strong> 与 InfluxDB 一起考虑，以解决与 Prometheus + Alertmanager 相同的问题空间</li>
<li>InfluxDB 提供连续查询（continuous queries），相当于 Prometheus 的记录规则</li>
<li>Kapacitor 的范围类似于 Prometheus 记录规则、告警规则和 Alertmanager 的通知功能</li>
</ul>
<p><strong>数据模型/存储</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>InfluxDB</th>
<th>Prometheus</th>
</tr>
</thead>
<tbody>
<tr>
<td>标签</td>
<td>Tags（第一级）+ Fields（第二级）</td>
<td>Labels</td>
</tr>
<tr>
<td>时间戳精度</td>
<td>纳秒级</td>
<td>毫秒级</td>
</tr>
<tr>
<td>数据类型</td>
<td>float64, int64, bool, string</td>
<td>float64（有限的字符串支持）</td>
</tr>
<tr>
<td>存储方式</td>
<td>LSM 树变体 + WAL，按时间分片</td>
<td>每个时间序列一个仅追加文件</td>
</tr>
</tbody>
</table>
<p><strong>架构（Architecture）</strong></p>
<ul>
<li><strong>Prometheus</strong>: 服务器彼此独立运行，仅依赖本地存储</li>
<li><strong>InfluxDB 开源版</strong>: 类似 Prometheus</li>
<li><strong>InfluxDB 商业版</strong>: 分布式存储集群，存储和查询由多个节点处理</li>
</ul>
<p><strong>优劣对比</strong></p>
<p><strong>InfluxDB 更优：</strong></p>
<ul>
<li>✅ 事件日志场景</li>
<li>✅ 商业版提供集群化支持，更适合长期数据存储</li>
<li>✅ 副本之间的最终一致性视图</li>
</ul>
<p><strong>Prometheus 更优：</strong></p>
<ul>
<li>✅ 主要用于指标监控</li>
<li>✅ 更强大的查询语言、告警和通知功能</li>
<li>✅ 更高的图形和告警可用性和正常运行时间</li>
</ul>
<hr />
<h4 id="prometheus-vs-opentsdb">Prometheus vs. OpenTSDB<a class="headerlink" href="#prometheus-vs-opentsdb" title="Permanent link">&para;</a></h4>
<p><strong>范围（Scope）</strong></p>
<ul>
<li>与 Graphite 的范围差异相同</li>
</ul>
<p><strong>数据模型（Data Model）</strong></p>
<ul>
<li>OpenTSDB 的数据模型几乎与 Prometheus 相同</li>
<li>时间序列由一组任意键值对标识（OpenTSDB 的 tags = Prometheus 的 labels）</li>
<li><strong>差异</strong>:</li>
<li>Prometheus 允许标签值中使用任意字符，OpenTSDB 限制更多</li>
<li>OpenTSDB 缺少完整的查询语言，仅允许通过 API 进行简单聚合和数学运算</li>
</ul>
<p><strong>存储（Storage）</strong></p>
<ul>
<li>OpenTSDB 基于 Hadoop 和 HBase 实现</li>
<li>易于水平扩展，但需要接受运行 Hadoop/HBase 集群的复杂性</li>
<li>Prometheus 初期运行更简单，但超过单节点容量后需要显式分片</li>
</ul>
<p><strong>总结</strong></p>
<ul>
<li>✅ <strong>Prometheus 优势</strong>: 更丰富的查询语言，能处理更高基数的指标，是完整监控系统的一部分</li>
<li>✅ <strong>OpenTSDB 优势</strong>: 如果已经运行 Hadoop 并且重视长期存储</li>
</ul>
<hr />
<h4 id="prometheus-vs-nagios">Prometheus vs. Nagios<a class="headerlink" href="#prometheus-vs-nagios" title="Permanent link">&para;</a></h4>
<p><strong>范围（Scope）</strong></p>
<ul>
<li><strong>Nagios</strong>: 起源于 1990 年代，主要基于脚本退出码进行告警（"checks"）</li>
<li>支持单个告警的静默，但无分组、路由或去重功能</li>
</ul>
<p><strong>数据模型（Data Model）</strong></p>
<ul>
<li>Nagios 是基于主机的</li>
<li>每个主机可以有一个或多个服务，每个服务可以执行一次检查</li>
<li>没有标签概念或查询语言</li>
</ul>
<p><strong>存储（Storage）</strong></p>
<ul>
<li>Nagios 本身没有存储，只存储当前检查状态</li>
<li>可以通过插件存储数据用于可视化</li>
</ul>
<p><strong>架构（Architecture）</strong></p>
<ul>
<li>Nagios 服务器是独立的</li>
<li>所有检查配置通过文件完成</li>
</ul>
<p><strong>总结</strong></p>
<ul>
<li>✅ <strong>Nagios 适用</strong>: 小型和/或静态系统的基本监控，黑盒探测足够的场景</li>
<li>✅ <strong>Prometheus 适用</strong>: 白盒监控，或具有动态/云环境的场景</li>
</ul>
<hr />
<h4 id="prometheus-vs-sensu">Prometheus vs. Sensu<a class="headerlink" href="#prometheus-vs-sensu" title="Permanent link">&para;</a></h4>
<p><strong>范围（Scope）</strong></p>
<ul>
<li><strong>Sensu</strong>: 开源监控和可观测性管道，专注于处理和告警可观测性数据流（事件流）</li>
<li>提供事件过滤、聚合、转换和处理的可扩展框架</li>
<li>Sensu 的事件处理能力类似于 Prometheus 告警规则和 Alertmanager 的范围</li>
</ul>
<p><strong>数据模型（Data Model）</strong></p>
<ul>
<li>Sensu 事件通过实体名称、事件名称和可选的键值元数据（"labels" 或 "annotations"）进行标识</li>
<li>事件有效载荷可能包含一个或多个指标点（JSON 对象：name, tags, timestamp, value）</li>
</ul>
<p><strong>存储（Storage）</strong></p>
<ul>
<li>Sensu 将当前和最近的事件状态信息及实时清单数据存储在嵌入式数据库（etcd）或外部 RDBMS（PostgreSQL）中</li>
</ul>
<p><strong>架构（Architecture）</strong></p>
<ul>
<li>Sensu 部署的所有组件都可以集群化以实现高可用性和提高事件处理吞吐量</li>
</ul>
<p><strong>优劣对比</strong></p>
<p><strong>Sensu 更优：</strong></p>
<ul>
<li>✅ 收集和处理混合可观测性数据（包括指标和/或事件）</li>
<li>✅ 整合多个监控工具，需要支持指标和 Nagios 风格插件或检查脚本</li>
<li>✅ 更强大的事件处理平台</li>
</ul>
<p><strong>Prometheus 更优：</strong></p>
<ul>
<li>✅ 主要收集和评估指标</li>
<li>✅ 监控同质 Kubernetes 基础设施（100% K8s 工作负载，Prometheus 提供更好的 K8s 集成）</li>
<li>✅ 更强大的查询语言，内置历史数据分析支持</li>
</ul>
<hr />
<h2 id="_8">总结<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>通过以上内容，我们了解了：</p>
<ol>
<li><strong>Prometheus 的核心概念</strong>：时间序列数据、指标、标签</li>
<li><strong>如何快速开始</strong>：下载、配置、启动和基本查询</li>
<li><strong>与其他监控系统的对比</strong>：帮助选择合适的监控方案</li>
</ol>
<p>接下来将深入学习 Prometheus 的核心概念、服务器配置、查询语言和最佳实践。</p>
<hr />
<hr />
<h2 id="concepts">二、Concepts (核心概念)<a class="headerlink" href="#concepts" title="Permanent link">&para;</a></h2>
<h3 id="21-data-model">2.1 Data Model (数据模型)<a class="headerlink" href="#21-data-model" title="Permanent link">&para;</a></h3>
<h4 id="_9">时间序列数据<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>Prometheus 从根本上将所有数据存储为<strong>时间序列</strong>：属于同一指标和同一组标签维度的带时间戳的值流。</p>
<p>除了存储的时间序列外，Prometheus 还可以根据查询结果生成临时的派生时间序列。</p>
<h4 id="_10">指标名称和标签<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>每个时间序列都通过其<strong>指标名称</strong>和可选的<strong>键值对（标签）</strong>唯一标识。</p>
<p><strong>指标名称（Metric Names）</strong></p>
<table>
<thead>
<tr>
<th>规则</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>命名规范</strong></td>
<td>应指定被测量系统的一般特性（例如 <code>http_requests_total</code> - 收到的 HTTP 请求总数）</td>
</tr>
<tr>
<td><strong>字符支持</strong></td>
<td>可以使用任何 UTF-8 字符</td>
</tr>
<tr>
<td><strong>推荐格式</strong></td>
<td>应匹配正则表达式 <code>[a-zA-Z_:][a-zA-Z0-9_:]*</code> 以获得最佳体验和兼容性</td>
</tr>
<tr>
<td><strong>保留字符</strong></td>
<td>冒号（<code>:</code>）保留用于用户定义的记录规则，导出器或直接埋点不应使用</td>
</tr>
</tbody>
</table>
<p><strong>指标标签（Metric Labels）</strong></p>
<p>标签让你能够捕获同一指标名称的不同实例。例如：所有使用 POST 方法访问 <code>/api/tracks</code> 处理器的 HTTP 请求。这就是 Prometheus 的<strong>"多维数据模型"</strong>。</p>
<p>查询语言允许基于这些维度进行过滤和聚合。</p>
<table>
<thead>
<tr>
<th>规则</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>字符支持</strong></td>
<td>标签名可以使用任何 UTF-8 字符</td>
</tr>
<tr>
<td><strong>保留前缀</strong></td>
<td>以 <code>__</code>（两个下划线）开头的标签名必须保留给 Prometheus 内部使用</td>
</tr>
<tr>
<td><strong>推荐格式</strong></td>
<td>应匹配正则表达式 <code>[a-zA-Z_][a-zA-Z0-9_]*</code> 以获得最佳兼容性</td>
</tr>
<tr>
<td><strong>标签值</strong></td>
<td>可以包含任何 UTF-8 字符</td>
</tr>
<tr>
<td><strong>空值处理</strong></td>
<td>具有空标签值的标签被视为等同于不存在的标签</td>
</tr>
</tbody>
</table>
<blockquote>
<p>⚠️ <strong>注意</strong>: Prometheus v3.0.0 中添加了对指标和标签名称的 UTF-8 支持。建议使用推荐的字符集以获得最佳兼容性。</p>
</blockquote>
<h4 id="samples">样本（Samples）<a class="headerlink" href="#samples" title="Permanent link">&para;</a></h4>
<p>样本构成实际的时间序列数据。每个样本包括：</p>
<table>
<thead>
<tr>
<th>组成部分</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>值</strong></td>
<td>float64 或原生直方图值</td>
</tr>
<tr>
<td><strong>时间戳</strong></td>
<td>毫秒精度的时间戳</td>
</tr>
</tbody>
</table>
<h4 id="notation">表示法（Notation）<a class="headerlink" href="#notation" title="Permanent link">&para;</a></h4>
<p>给定指标名称和一组标签，时间序列通常使用以下表示法标识：</p>
<div class="highlight"><pre><span></span><code>&lt;metric name&gt;{&lt;label name&gt;=&quot;&lt;label value&gt;&quot;, ...}
</code></pre></div>
<p><strong>示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 标准表示法</span>
<span class="nv">api_http_requests_total</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">POST</span><span class="p">&quot;,</span><span class="w"> </span><span class="nl">handler</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/messages</span><span class="p">&quot;}</span>

<span class="c1"># UTF-8 字符需要引号</span>
<span class="p">{</span><span class="err">&quot;特殊指标名&quot;</span><span class="p">,</span><span class="w"> </span><span class="nl">label</span><span class="o">=</span><span class="p">&quot;</span><span class="s">value</span><span class="p">&quot;}</span>

<span class="c1"># 使用 __name__ 标签（内部表示）</span>
<span class="p">{</span><span class="nl">__name__</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api_http_requests_total</span><span class="p">&quot;,</span><span class="w"> </span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">POST</span><span class="p">&quot;,</span><span class="w"> </span><span class="nl">handler</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/messages</span><span class="p">&quot;}</span>
</code></pre></div>
<blockquote>
<p>💡 这与 OpenTSDB 使用的表示法相同。</p>
</blockquote>
<hr />
<h3 id="22-metric-types">2.2 Metric Types (指标类型)<a class="headerlink" href="#22-metric-types" title="Permanent link">&para;</a></h3>
<p>Prometheus 客户端库提供四种核心指标类型。这些类型目前仅在客户端库中区分（以支持特定类型的使用 API）和在传输协议中区分。Prometheus 服务器尚未使用类型信息，而是将所有数据展平为无类型时间序列。</p>
<div class="highlight"><pre><span></span><code>graph TD
    A[Prometheus 指标类型] --&gt; B[Counter 计数器]
    A --&gt; C[Gauge 仪表]
    A --&gt; D[Histogram 直方图]
    A --&gt; E[Summary 摘要]

    B --&gt; B1[单调递增]
    B --&gt; B2[可重置为0]

    C --&gt; C1[可增可减]
    C --&gt; C2[适用于温度/内存等]

    D --&gt; D1[观测值分桶]
    D --&gt; D2[提供总和与计数]
    D --&gt; D3[可计算分位数]

    E --&gt; E1[观测值分位数]
    E --&gt; E2[滑动时间窗口]
    E --&gt; E3[提供总和与计数]
</code></pre></div>
<h4 id="counter">Counter (计数器)<a class="headerlink" href="#counter" title="Permanent link">&para;</a></h4>
<p><strong>Counter</strong> 是一个累积指标，表示单个单调递增的计数器，其值只能增加或在重启时重置为零。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>✅ 请求服务数</li>
<li>✅ 已完成的任务数</li>
<li>✅ 错误数</li>
</ul>
<p><strong>❌ 不要使用 Counter:</strong></p>
<ul>
<li>不要用于可能减少的值（如当前运行的进程数，应使用 Gauge）</li>
</ul>
<p><strong>示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># HTTP 请求总数</span>
<span class="nv">http_requests_total</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">POST</span><span class="p">&quot;,</span><span class="w"> </span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;}</span>
</code></pre></div>
<hr />
<h4 id="gauge">Gauge (仪表)<a class="headerlink" href="#gauge" title="Permanent link">&para;</a></h4>
<p><strong>Gauge</strong> 是表示单个数值的指标，该值可以任意上下波动。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>✅ 温度测量</li>
<li>✅ 当前内存使用量</li>
<li>✅ 可以上下波动的"计数"（如并发请求数）</li>
</ul>
<p><strong>示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 当前内存使用量（字节）</span>
<span class="nv">memory_usage_bytes</span><span class="p">{</span><span class="nl">instance</span><span class="o">=</span><span class="p">&quot;</span><span class="s">localhost:9090</span><span class="p">&quot;}</span>

<span class="c1"># 当前并发请求数</span>
<span class="nv">http_concurrent_requests</span><span class="p">{</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api</span><span class="p">&quot;}</span>
</code></pre></div>
<hr />
<h4 id="histogram">Histogram (直方图)<a class="headerlink" href="#histogram" title="Permanent link">&para;</a></h4>
<p><strong>Histogram</strong> 对观测值（通常是请求持续时间或响应大小等）进行采样，并将其计入可配置的桶中。它还提供所有观测值的总和。</p>
<p><strong>暴露的时间序列：</strong></p>
<p>对于基础指标名称为 <code>&lt;basename&gt;</code> 的直方图，会在抓取时暴露多个时间序列：</p>
<table>
<thead>
<tr>
<th>时间序列</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;basename&gt;_bucket{le="&lt;上限&gt;"}"</code></td>
<td>观测桶的累积计数器</td>
</tr>
<tr>
<td><code>&lt;basename&gt;_sum</code></td>
<td>所有观测值的总和</td>
</tr>
<tr>
<td><code>&lt;basename&gt;_count</code></td>
<td>已观测到的事件计数（等同于 <code>&lt;basename&gt;_bucket{le="+Inf"}</code>）</td>
</tr>
</tbody>
</table>
<p><strong>使用场景：</strong></p>
<ul>
<li>✅ 使用 <code>histogram_quantile()</code> 函数计算直方图的分位数</li>
<li>✅ 计算 Apdex 分数</li>
<li>✅ 适合聚合多个实例的直方图</li>
</ul>
<p><strong>示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 原始直方图指标</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.1</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">1000</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.5</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">1500</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">1.0</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">1800</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">+Inf</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">2000</span>
<span class="nv">http_request_duration_seconds_sum</span><span class="w"> </span><span class="mi">850</span>
<span class="nv">http_request_duration_seconds_count</span><span class="w"> </span><span class="mi">2000</span>

<span class="c1"># 查询 95 分位数</span>
<span class="kr">histogram_quantile</span><span class="o">(</span><span class="mf">0.95</span><span class="p">,</span><span class="w"> </span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>
</code></pre></div>
<blockquote>
<p>📌 <strong>Prometheus v2.40+</strong>: 实验性支持原生直方图（Native Histograms），只需一个时间序列，包含动态数量的桶，提供更高分辨率且成本更低。</p>
<p>📌 <strong>Prometheus v3.0+</strong>: 经典直方图的 <code>le</code> 标签值在摄取期间规范化，遵循 OpenMetrics 规范数字格式。</p>
</blockquote>
<hr />
<h4 id="summary">Summary (摘要)<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h4>
<p><strong>Summary</strong> 与 Histogram 类似，也对观测值进行采样（通常是请求持续时间和响应大小）。它提供观测值的总计数和总和，并可以计算滑动时间窗口上的可配置分位数。</p>
<p><strong>暴露的时间序列：</strong></p>
<p>对于基础指标名称为 <code>&lt;basename&gt;</code> 的摘要，会在抓取时暴露多个时间序列：</p>
<table>
<thead>
<tr>
<th>时间序列</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;basename&gt;{quantile="&lt;φ&gt;"}</code></td>
<td>观测事件的流式 φ-分位数（0 ≤ φ ≤ 1）</td>
</tr>
<tr>
<td><code>&lt;basename&gt;_sum</code></td>
<td>所有观测值的总和</td>
</tr>
<tr>
<td><code>&lt;basename&gt;_count</code></td>
<td>已观测到的事件计数</td>
</tr>
</tbody>
</table>
<p><strong>示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 摘要指标</span>
<span class="nv">http_request_duration_seconds</span><span class="p">{</span><span class="nl">quantile</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.5</span><span class="p">&quot;}</span><span class="w"> </span><span class="mf">0.05</span>
<span class="nv">http_request_duration_seconds</span><span class="p">{</span><span class="nl">quantile</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.9</span><span class="p">&quot;}</span><span class="w"> </span><span class="mf">0.2</span>
<span class="nv">http_request_duration_seconds</span><span class="p">{</span><span class="nl">quantile</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.99</span><span class="p">&quot;}</span><span class="w"> </span><span class="mf">0.5</span>
<span class="nv">http_request_duration_seconds_sum</span><span class="w"> </span><span class="mi">850</span>
<span class="nv">http_request_duration_seconds_count</span><span class="w"> </span><span class="mi">2000</span>
</code></pre></div>
<blockquote>
<p>📌 <strong>Prometheus v3.0+</strong>: 分位数标签值在摄取期间规范化，遵循 OpenMetrics 规范数字格式。</p>
</blockquote>
<p><strong>Histogram vs Summary 对比：</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Histogram</th>
<th>Summary</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>分位数计算</strong></td>
<td>服务器端（PromQL）</td>
<td>客户端（应用端）</td>
</tr>
<tr>
<td><strong>聚合能力</strong></td>
<td>可聚合多个实例</td>
<td>无法聚合</td>
</tr>
<tr>
<td><strong>精度</strong></td>
<td>桶粒度限制</td>
<td>精确</td>
</tr>
<tr>
<td><strong>性能开销</strong></td>
<td>低</td>
<td>较高</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>需要聚合、预先不知道分位数</td>
<td>已知所需分位数、单实例观测</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="23-jobs-and-instances">2.3 Jobs and Instances (任务与实例)<a class="headerlink" href="#23-jobs-and-instances" title="Permanent link">&para;</a></h3>
<h4 id="_11">基本概念<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>在 Prometheus 术语中：</p>
<ul>
<li><strong>Instance（实例）</strong>: 可以抓取的端点，通常对应单个进程</li>
<li><strong>Job（任务）</strong>: 具有相同目的的实例集合（例如为了可扩展性或可靠性而复制的进程）</li>
</ul>
<p><strong>示例：一个有 4 个副本实例的 API 服务器任务</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-server</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">instance 1</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.2.3.4:5670</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">instance 2</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.2.3.4:5671</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">instance 3</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.6.7.8:5670</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">instance 4</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.6.7.8:5671</span>
</code></pre></div>
<p><strong>架构关系图：</strong></p>
<div class="highlight"><pre><span></span><code>graph LR
    A[Job: api-server] --&gt; B[Instance: 1.2.3.4:5670]
    A --&gt; C[Instance: 1.2.3.4:5671]
    A --&gt; D[Instance: 5.6.7.8:5670]
    A --&gt; E[Instance: 5.6.7.8:5671]

    F[Job: database] --&gt; G[Instance: 10.0.0.1:3306]
    F --&gt; H[Instance: 10.0.0.2:3306]
</code></pre></div>
<h4 id="_12">自动生成的标签和时间序列<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>当 Prometheus 抓取目标时，会自动附加一些标签到抓取的时间序列，用于标识被抓取的目标：</p>
<table>
<thead>
<tr>
<th>标签</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>job</strong></td>
<td>目标所属的已配置任务名称</td>
</tr>
<tr>
<td><strong>instance</strong></td>
<td>被抓取目标 URL 的 <code>&lt;host&gt;:&lt;port&gt;</code> 部分</td>
</tr>
</tbody>
</table>
<blockquote>
<p>💡 如果这些标签已存在于抓取的数据中，行为取决于 <code>honor_labels</code> 配置选项。</p>
</blockquote>
<h4 id="_13">自动生成的指标<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>对于每个实例抓取，Prometheus 会在以下时间序列中存储样本：</p>
<p><strong>核心指标：</strong></p>
<table>
<thead>
<tr>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>up{job="&lt;job-name&gt;", instance="&lt;instance-id&gt;"}</code></td>
<td>实例是否健康：<code>1</code> = 可达，<code>0</code> = 抓取失败</td>
</tr>
<tr>
<td><code>scrape_duration_seconds{job="&lt;job-name&gt;", instance="&lt;instance-id&gt;"}</code></td>
<td>抓取持续时间（秒）</td>
</tr>
<tr>
<td><code>scrape_samples_post_metric_relabeling{job="&lt;job-name&gt;", instance="&lt;instance-id&gt;"}</code></td>
<td>应用指标重新标记后剩余的样本数</td>
</tr>
<tr>
<td><code>scrape_samples_scraped{job="&lt;job-name&gt;", instance="&lt;instance-id&gt;"}</code></td>
<td>目标暴露的样本数</td>
</tr>
<tr>
<td><code>scrape_series_added{job="&lt;job-name&gt;", instance="&lt;instance-id&gt;"}</code></td>
<td>此次抓取中新增的大约序列数（v2.10+）</td>
</tr>
</tbody>
</table>
<p><strong>扩展指标（需启用 <code>extra-scrape-metrics</code> 特性标志）：</strong></p>
<table>
<thead>
<tr>
<th>指标</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>scrape_timeout_seconds{job="&lt;job-name&gt;", instance="&lt;instance-id&gt;"}</code></td>
<td>为目标配置的 <code>scrape_timeout</code></td>
</tr>
<tr>
<td><code>scrape_sample_limit{job="&lt;job-name&gt;", instance="&lt;instance-id&gt;"}</code></td>
<td>为目标配置的 <code>sample_limit</code>（0 = 无限制）</td>
</tr>
<tr>
<td><code>scrape_body_size_bytes{job="&lt;job-name&gt;", instance="&lt;instance-id&gt;"}</code></td>
<td>最近一次成功抓取的未压缩响应大小（失败返回 0 或 -1）</td>
</tr>
</tbody>
</table>
<p><strong>实用查询示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查所有实例的健康状态</span>
<span class="nv">up</span>

<span class="c1"># 查询所有不健康的实例</span>
<span class="nv">up</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>

<span class="c1"># 查询特定任务的所有实例</span>
<span class="nv">up</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api-server</span><span class="p">&quot;}</span>

<span class="c1"># 计算任务的健康实例数</span>
<span class="k">sum</span><span class="o">(</span><span class="nv">up</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api-server</span><span class="p">&quot;}</span><span class="o">)</span>

<span class="c1"># 查询抓取时间超过 1 秒的实例</span>
<span class="nv">scrape_duration_seconds</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<blockquote>
<p>💡 <code>up</code> 时间序列对于实例可用性监控非常有用！</p>
</blockquote>
<hr />
<h2 id="_14">总结<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h2>
<p>通过本章节，我们深入了解了 Prometheus 的核心概念：</p>
<ol>
<li><strong>数据模型</strong>: 时间序列如何通过指标名称和标签唯一标识</li>
<li><strong>指标类型</strong>: Counter、Gauge、Histogram、Summary 的区别和使用场景</li>
<li><strong>任务与实例</strong>: Job 和 Instance 的关系，以及 Prometheus 自动生成的监控指标</li>
</ol>
<p>这些概念是理解和使用 Prometheus 的基础，为后续学习服务器配置、查询语言和最佳实践奠定了坚实基础。</p>
<hr />
<hr />
<h2 id="server">三、Server (服务器)<a class="headerlink" href="#server" title="Permanent link">&para;</a></h2>
<h3 id="31-getting-started">3.1 Getting Started (快速开始)<a class="headerlink" href="#31-getting-started" title="Permanent link">&para;</a></h3>
<p>本指南是一个 "Hello World" 风格的教程，展示如何安装、配置和使用一个简单的 Prometheus 实例。</p>
<h4 id="prometheus_5">下载和运行 Prometheus<a class="headerlink" href="#prometheus_5" title="Permanent link">&para;</a></h4>
<ol>
<li>下载适合你平台的最新版本 Prometheus</li>
<li>解压并运行：</li>
</ol>
<div class="highlight"><pre><span></span><code>tar<span class="w"> </span>xvfz<span class="w"> </span>prometheus-*.tar.gz
<span class="nb">cd</span><span class="w"> </span>prometheus-*
</code></pre></div>
<h4 id="prometheus_6">配置 Prometheus 监控自身<a class="headerlink" href="#prometheus_6" title="Permanent link">&para;</a></h4>
<p>Prometheus 通过抓取指标 HTTP 端点从目标收集指标。由于 Prometheus 以相同方式暴露自身数据，它也可以抓取和监控自己的健康状况。</p>
<p>将以下基本配置保存为 <code>prometheus.yml</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span><span class="w">  </span><span class="c1"># 默认每 15 秒抓取目标一次</span>

<span class="w">  </span><span class="c1"># 与外部系统通信时附加这些标签</span>
<span class="w">  </span><span class="c1"># (federation, remote storage, Alertmanager)</span>
<span class="w">  </span><span class="nt">external_labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">monitor</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;codelab-monitor&#39;</span>

<span class="c1"># 包含一个要抓取的端点的抓取配置</span>
<span class="c1"># 这里是 Prometheus 自身</span>
<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># job 名称作为标签 `job=&lt;job_name&gt;` 添加到从此配置抓取的任何时间序列</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;prometheus&#39;</span>

<span class="w">    </span><span class="c1"># 覆盖全局默认值，每 5 秒抓取此任务的目标</span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>

<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9090&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>配置说明：</strong></p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>global.scrape_interval</code></td>
<td>全局抓取间隔，默认 15 秒</td>
</tr>
<tr>
<td><code>global.external_labels</code></td>
<td>与外部系统通信时附加的标签</td>
</tr>
<tr>
<td><code>scrape_configs</code></td>
<td>抓取配置列表</td>
</tr>
<tr>
<td><code>job_name</code></td>
<td>任务名称，将作为 <code>job</code> 标签添加</td>
</tr>
<tr>
<td><code>scrape_interval</code></td>
<td>特定任务的抓取间隔（覆盖全局设置）</td>
</tr>
<tr>
<td><code>static_configs.targets</code></td>
<td>静态配置的目标列表</td>
</tr>
</tbody>
</table>
<h4 id="prometheus_7">启动 Prometheus<a class="headerlink" href="#prometheus_7" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 启动 Prometheus</span>
<span class="c1"># 默认情况下，Prometheus 将数据库存储在 ./data (标志 --storage.tsdb.path)</span>
./prometheus<span class="w"> </span>--config.file<span class="o">=</span>prometheus.yml
</code></pre></div>
<p>启动后访问：</p>
<ul>
<li><strong>状态页面</strong>: <code>http://localhost:9090</code></li>
<li><strong>指标端点</strong>: <code>http://localhost:9090/metrics</code></li>
</ul>
<h4 id="_15">使用表达式浏览器<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>访问 <code>http://localhost:9090/graph</code> 并选择 "Graph" 标签页中的 "Table" 视图。</p>
<p><strong>查询示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询目标抓取间隔</span>
<span class="nv">prometheus_target_interval_length_seconds</span>

<span class="c1"># 仅查询 99 分位数延迟</span>
<span class="nv">prometheus_target_interval_length_seconds</span><span class="p">{</span><span class="nl">quantile</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.99</span><span class="p">&quot;}</span>

<span class="c1"># 计算返回的时间序列数量</span>
<span class="k">count</span><span class="o">(</span><span class="nv">prometheus_target_interval_length_seconds</span><span class="o">)</span>
</code></pre></div>
<h4 id="_16">使用图形界面<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>访问 <code>http://localhost:9090/graph</code> 并使用 "Graph" 标签页。</p>
<p><strong>示例：绘制每秒创建的块速率</strong></p>
<div class="highlight"><pre><span></span><code><span class="kr">rate</span><span class="o">(</span><span class="nv">prometheus_tsdb_head_chunks_created_total</span><span class="p">[</span><span class="s">1m</span><span class="p">]</span><span class="o">)</span>
</code></pre></div>
<h4 id="_17">启动示例目标<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>使用 Node Exporter 作为示例目标：</p>
<div class="highlight"><pre><span></span><code>tar<span class="w"> </span>-xzvf<span class="w"> </span>node_exporter-*.*.tar.gz
<span class="nb">cd</span><span class="w"> </span>node_exporter-*.*

<span class="c1"># 在不同终端启动 3 个示例目标</span>
./node_exporter<span class="w"> </span>--web.listen-address<span class="w"> </span><span class="m">127</span>.0.0.1:8080
./node_exporter<span class="w"> </span>--web.listen-address<span class="w"> </span><span class="m">127</span>.0.0.1:8081
./node_exporter<span class="w"> </span>--web.listen-address<span class="w"> </span><span class="m">127</span>.0.0.1:8082
</code></pre></div>
<p>现在有三个目标监听：</p>
<ul>
<li><code>http://localhost:8080/metrics</code></li>
<li><code>http://localhost:8081/metrics</code></li>
<li><code>http://localhost:8082/metrics</code></li>
</ul>
<h4 id="prometheus_8">配置 Prometheus 监控示例目标<a class="headerlink" href="#prometheus_8" title="Permanent link">&para;</a></h4>
<p>将所有三个端点分组到一个名为 <code>node</code> 的任务中。我们将前两个端点标记为生产目标，第三个表示金丝雀实例。</p>
<p>在 <code>prometheus.yml</code> 的 <code>scrape_configs</code> 部分添加：</p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;node&#39;</span>

<span class="w">    </span><span class="c1"># 每 5 秒抓取一次</span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>

<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:8080&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;localhost:8081&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;production&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:8082&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;canary&#39;</span>
</code></pre></div>
<p>访问表达式浏览器，验证是否有 <code>node_cpu_seconds_total</code> 等指标。</p>
<h4 id="_18">配置聚合规则<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>为了提高效率，Prometheus 可以通过配置的记录规则将表达式预录制到新的持久时间序列中。</p>
<p><strong>示例：记录 CPU 使用率的 5 分钟平均值</strong></p>
<p>创建 <code>prometheus.rules.yml</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpu-node</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job_instance_mode:node_cpu_seconds:avg_rate5m</span>
<span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">avg by (job, instance, mode) (rate(node_cpu_seconds_total[5m]))</span>
</code></pre></div>
<p><strong>更新 <code>prometheus.yml</code> 以加载规则：</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span>
<span class="w">  </span><span class="nt">evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span><span class="w">  </span><span class="c1"># 每 15 秒评估规则</span>

<span class="w">  </span><span class="nt">external_labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">monitor</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;codelab-monitor&#39;</span>

<span class="nt">rule_files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;prometheus.rules.yml&#39;</span>

<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;prometheus&#39;</span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9090&#39;</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;node&#39;</span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:8080&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;localhost:8081&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;production&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:8082&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;canary&#39;</span>
</code></pre></div>
<p>重启 Prometheus 并验证新指标 <code>job_instance_mode:node_cpu_seconds:avg_rate5m</code> 是否可用。</p>
<h4 id="_19">重新加载配置<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<p>无需重启进程即可重新加载配置（使用 SIGHUP 信号）：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Linux 系统</span>
<span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>SIGHUP<span class="w"> </span>&lt;PID&gt;
</code></pre></div>
<h4 id="_20">优雅关闭实例<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<p>建议使用信号进行干净关闭：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Linux 系统</span>
<span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>SIGTERM<span class="w"> </span>&lt;PID&gt;
<span class="c1"># 或</span>
<span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>SIGINT<span class="w"> </span>&lt;PID&gt;
<span class="c1"># 或在终端按 Control-C</span>
</code></pre></div>
<hr />
<h3 id="32-installation">3.2 Installation (安装)<a class="headerlink" href="#32-installation" title="Permanent link">&para;</a></h3>
<p>Prometheus 提供多种安装方式，适合不同的使用场景。</p>
<h4 id="_21">安装方式概览<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    A[Prometheus 安装方式] --&gt; B[预编译二进制文件]
    A --&gt; C[源码编译]
    A --&gt; D[Docker 镜像]

    B --&gt; B1[下载官方二进制]
    B --&gt; B2[直接运行]

    C --&gt; C1[使用 Makefile]
    C --&gt; C2[自定义构建]

    D --&gt; D1[Docker Hub]
    D --&gt; D2[Quay.io]
    D --&gt; D3[容器化部署]
</code></pre></div>
<h4 id="_22">方式一：使用预编译二进制文件<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p><strong>优点：</strong> 简单快速，适合快速测试和开发环境</p>
<ol>
<li>访问官方下载页面</li>
<li>选择适合你平台的版本</li>
<li>下载并解压</li>
<li>直接运行 <code>prometheus</code> 二进制文件</li>
</ol>
<div class="highlight"><pre><span></span><code>tar<span class="w"> </span>xvfz<span class="w"> </span>prometheus-*.tar.gz
<span class="nb">cd</span><span class="w"> </span>prometheus-*
./prometheus<span class="w"> </span>--config.file<span class="o">=</span>prometheus.yml
</code></pre></div>
<hr />
<h4 id="_23">方式二：从源码编译<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p><strong>优点：</strong> 可自定义构建选项，获取最新功能</p>
<p>查看相应仓库中的 Makefile 目标进行构建。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 通常流程</span>
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/prometheus/prometheus.git
<span class="nb">cd</span><span class="w"> </span>prometheus
make<span class="w"> </span>build
</code></pre></div>
<hr />
<h4 id="docker">方式三：使用 Docker<a class="headerlink" href="#docker" title="Permanent link">&para;</a></h4>
<p><strong>优点：</strong> 容器化部署，易于管理和扩展</p>
<p>所有 Prometheus 服务都提供 Docker 镜像，可从 <strong>Quay.io</strong> 或 <strong>Docker Hub</strong> 获取。</p>
<p><strong>基本运行：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用示例配置启动 Prometheus</span>
docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">9090</span>:9090<span class="w"> </span>prom/prometheus
</code></pre></div>
<p>这将使用示例配置启动 Prometheus 并在端口 9090 上暴露。</p>
<p><strong>重要提示：</strong></p>
<ul>
<li>Prometheus 镜像使用卷来存储实际指标</li>
<li>生产部署强烈建议使用命名卷来简化 Prometheus 升级时的数据管理</li>
</ul>
<h4 id="docker_1">Docker 高级配置<a class="headerlink" href="#docker_1" title="Permanent link">&para;</a></h4>
<p><strong>1. 设置命令行参数</strong></p>
<p>Docker 镜像以多个默认命令行参数启动（参见 Dockerfile）。</p>
<p>如果要添加额外的命令行参数，需要重新添加默认参数，因为它们会被覆盖。</p>
<p><strong>2. 挂载配置文件（Bind-mount）</strong></p>
<p><strong>方法 A：挂载 prometheus.yml 文件</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">9090</span>:9090<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/path/to/prometheus.yml:/etc/prometheus/prometheus.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>prom/prometheus
</code></pre></div>
<p><strong>方法 B：挂载包含 prometheus.yml 的目录</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">9090</span>:9090<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/path/to/config:/etc/prometheus<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>prom/prometheus
</code></pre></div>
<p><strong>3. 保存 Prometheus 数据</strong></p>
<p>Prometheus 数据存储在容器内的 <code>/prometheus</code> 目录中。每次容器重启时数据都会被清除。</p>
<p>要保存数据，需要为容器设置持久存储：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建持久卷</span>
docker<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>prometheus-data

<span class="c1"># 使用持久存储启动 Prometheus</span>
docker<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">9090</span>:9090<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/path/to/prometheus.yml:/etc/prometheus/prometheus.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>prometheus-data:/prometheus<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>prom/prometheus
</code></pre></div>
<p><strong>存储位置：</strong></p>
<table>
<thead>
<tr>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/etc/prometheus/</code></td>
<td>配置文件目录</td>
</tr>
<tr>
<td><code>/prometheus/</code></td>
<td>数据存储目录（TSDB）</td>
</tr>
</tbody>
</table>
<p><strong>4. 自定义镜像</strong></p>
<p>将配置烘焙到镜像中，避免在主机上管理文件。适合配置相对静态且跨环境一致的场景。</p>
<p><strong>创建自定义镜像：</strong></p>
<p>创建新目录，包含 <code>prometheus.yml</code> 和 <code>Dockerfile</code>：</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">prom/prometheus</span>
<span class="k">ADD</span><span class="w"> </span>prometheus.yml<span class="w"> </span>/etc/prometheus/
</code></pre></div>
<p><strong>构建并运行：</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>my-prometheus<span class="w"> </span>.
docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">9090</span>:9090<span class="w"> </span>my-prometheus
</code></pre></div>
<p><strong>高级选项：</strong></p>
<ul>
<li>启动时动态渲染配置（使用工具）</li>
<li>使用守护进程定期更新配置</li>
</ul>
<hr />
<h4 id="docker_2">Docker 部署完整示例<a class="headerlink" href="#docker_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 创建持久卷</span>
docker<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>prometheus-data
docker<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>prometheus-config

<span class="c1"># 2. 创建配置文件</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>/tmp/prometheus.yml<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">global:</span>
<span class="s">  scrape_interval: 15s</span>
<span class="s">  evaluation_interval: 15s</span>

<span class="s">scrape_configs:</span>
<span class="s">  - job_name: &#39;prometheus&#39;</span>
<span class="s">    static_configs:</span>
<span class="s">      - targets: [&#39;localhost:9090&#39;]</span>
<span class="s">EOF</span>

<span class="c1"># 3. 启动 Prometheus</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>prometheus<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">9090</span>:9090<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/tmp/prometheus.yml:/etc/prometheus/prometheus.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>prometheus-data:/prometheus<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>prom/prometheus<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--config.file<span class="o">=</span>/etc/prometheus/prometheus.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--storage.tsdb.path<span class="o">=</span>/prometheus

<span class="c1"># 4. 查看日志</span>
docker<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>prometheus

<span class="c1"># 5. 访问 Web UI</span>
<span class="c1"># http://localhost:9090</span>
</code></pre></div>
<h4 id="_24">安装方式对比<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>方式</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>预编译二进制</strong></td>
<td>简单快速、无依赖</td>
<td>需手动管理更新</td>
<td>开发、测试、小规模部署</td>
</tr>
<tr>
<td><strong>源码编译</strong></td>
<td>可定制、最新功能</td>
<td>构建复杂、依赖多</td>
<td>需要特定功能、深度定制</td>
</tr>
<tr>
<td><strong>Docker</strong></td>
<td>容器化、易于管理、可扩展</td>
<td>需要 Docker 环境</td>
<td>生产环境、云原生架构、K8s</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_25">总结<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h2>
<p>通过本章节，我们学习了：</p>
<ol>
<li>
<p><strong>Getting Started</strong>:</p>
</li>
<li>
<p>Prometheus 的基本配置和启动</p>
</li>
<li>监控自身和外部目标</li>
<li>使用表达式浏览器和图形界面</li>
<li>配置记录规则进行数据预聚合</li>
<li>
<p><strong>Installation</strong>:</p>
</li>
<li>
<p>三种主要安装方式及其适用场景</p>
</li>
<li>Docker 部署的详细配置和最佳实践</li>
<li>持久化存储和自定义镜像的使用</li>
</ol>
<p>这些内容为后续深入学习 Prometheus 的配置、查询和告警功能打下了坚实基础。</p>
<hr />
<h3 id="33-configuration">3.3 Configuration (配置详解)<a class="headerlink" href="#33-configuration" title="Permanent link">&para;</a></h3>
<p>Prometheus 通过命令行标志和配置文件进行配置。命令行标志配置不可变的系统参数(如存储位置、保留数据量等),而配置文件定义抓取任务、实例及要加载的规则文件。</p>
<h4 id="_26">配置文件基础<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<p><strong>配置文件格式</strong>: YAML</p>
<p><strong>查看所有命令行标志:</strong></p>
<div class="highlight"><pre><span></span><code>./prometheus<span class="w"> </span>-h
</code></pre></div>
<p><strong>指定配置文件:</strong></p>
<div class="highlight"><pre><span></span><code>./prometheus<span class="w"> </span>--config.file<span class="o">=</span>prometheus.yml
</code></pre></div>
<p><strong>运行时重新加载配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 方法 1: 发送 SIGHUP 信号</span>
<span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>SIGHUP<span class="w"> </span>&lt;PID&gt;

<span class="c1"># 方法 2: HTTP POST (需启用 --web.enable-lifecycle)</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9090/-/reload
</code></pre></div>
<blockquote>
<p>💡 如果新配置格式不正确,更改不会被应用。重新加载也会重新加载规则文件。</p>
</blockquote>
<h4 id="_27">配置文件结构<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    A[prometheus.yml] --&gt; B[global 全局配置]
    A --&gt; C[runtime 运行时配置]
    A --&gt; D[rule_files 规则文件]
    A --&gt; E[scrape_configs 抓取配置]
    A --&gt; F[alerting 告警配置]
    A --&gt; G[remote_write 远程写入]
    A --&gt; H[remote_read 远程读取]
    A --&gt; I[storage 存储配置]

    E --&gt; E1[static_configs 静态配置]
    E --&gt; E2[服务发现]
    E2 --&gt; E2A[kubernetes_sd_configs]
    E2 --&gt; E2B[consul_sd_configs]
    E2 --&gt; E2C[ec2_sd_configs]
    E2 --&gt; E2D[dns_sd_configs]
    E2 --&gt; E2E[其他20+种服务发现]
</code></pre></div>
<hr />
<h4 id="_28">通用占位符说明<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>占位符</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;boolean&gt;</code></td>
<td>布尔值</td>
<td><code>true</code> 或 <code>false</code></td>
</tr>
<tr>
<td><code>&lt;duration&gt;</code></td>
<td>持续时间</td>
<td><code>1d</code>, <code>1h30m</code>, <code>5m</code>, <code>10s</code></td>
</tr>
<tr>
<td><code>&lt;filename&gt;</code></td>
<td>当前工作目录中的有效路径</td>
<td><code>prometheus.yml</code></td>
</tr>
<tr>
<td><code>&lt;float&gt;</code></td>
<td>浮点数</td>
<td><code>0.5</code>, <code>1.25</code></td>
</tr>
<tr>
<td><code>&lt;host&gt;</code></td>
<td>主机名或 IP + 可选端口号</td>
<td><code>localhost:9090</code></td>
</tr>
<tr>
<td><code>&lt;int&gt;</code></td>
<td>整数值</td>
<td><code>100</code>, <code>5000</code></td>
</tr>
<tr>
<td><code>&lt;labelname&gt;</code></td>
<td>标签名 (正则:<code>[a-zA-Z_][a-zA-Z0-9_]*</code>)</td>
<td><code>job</code>, <code>instance</code></td>
</tr>
<tr>
<td><code>&lt;labelvalue&gt;</code></td>
<td>Unicode 字符串</td>
<td>任何 UTF-8 字符</td>
</tr>
<tr>
<td><code>&lt;path&gt;</code></td>
<td>有效的 URL 路径</td>
<td><code>/metrics</code></td>
</tr>
<tr>
<td><code>&lt;scheme&gt;</code></td>
<td>协议方案</td>
<td><code>http</code> 或 <code>https</code></td>
</tr>
<tr>
<td><code>&lt;secret&gt;</code></td>
<td>机密字符串(如密码)</td>
<td><code>password123</code></td>
</tr>
<tr>
<td><code>&lt;string&gt;</code></td>
<td>常规字符串</td>
<td>任意字符串</td>
</tr>
<tr>
<td><code>&lt;size&gt;</code></td>
<td>字节大小(需要单位)</td>
<td><code>512MB</code>, <code>1GB</code></td>
</tr>
</tbody>
</table>
<hr />
<h4 id="global">Global 全局配置<a class="headerlink" href="#global" title="Permanent link">&para;</a></h4>
<p>全局配置在所有其他配置上下文中有效,并作为其他配置节的默认值。</p>
<div class="highlight"><pre><span></span><code><span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 抓取目标的默认频率</span>
<span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span><span class="w">  </span><span class="c1"># 默认 1m</span>

<span class="w">  </span><span class="c1"># 抓取请求超时时间 (不能大于 scrape_interval)</span>
<span class="w">  </span><span class="nt">scrape_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span><span class="w">  </span><span class="c1"># 默认 10s</span>

<span class="w">  </span><span class="c1"># 规则评估频率</span>
<span class="w">  </span><span class="nt">evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span><span class="w">  </span><span class="c1"># 默认 1m</span>

<span class="w">  </span><span class="c1"># 规则评估时间戳偏移(确保底层指标已收到)</span>
<span class="w">  </span><span class="nt">rule_query_offset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span><span class="w">  </span><span class="c1"># 默认 0s</span>

<span class="w">  </span><span class="c1"># 与外部系统通信时添加的标签</span>
<span class="w">  </span><span class="c1"># (federation, remote storage, Alertmanager)</span>
<span class="w">  </span><span class="nt">external_labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;production&#39;</span>
<span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;us-east-1&#39;</span>

<span class="w">  </span><span class="c1"># PromQL 查询日志文件</span>
<span class="w">  </span><span class="nt">query_log_file</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/var/log/prometheus/query.log&#39;</span>

<span class="w">  </span><span class="c1"># 抓取失败日志文件</span>
<span class="w">  </span><span class="nt">scrape_failure_log_file</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/var/log/prometheus/scrape_failures.log&#39;</span>
</code></pre></div>
<p><strong>关键全局配置项:</strong></p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>scrape_interval</code></td>
<td>抓取目标的频率</td>
<td><code>1m</code></td>
</tr>
<tr>
<td><code>scrape_timeout</code></td>
<td>抓取超时时间</td>
<td><code>10s</code></td>
</tr>
<tr>
<td><code>evaluation_interval</code></td>
<td>规则评估频率</td>
<td><code>1m</code></td>
</tr>
<tr>
<td><code>body_size_limit</code></td>
<td>响应体大小限制</td>
<td><code>0</code> (无限制)</td>
</tr>
<tr>
<td><code>sample_limit</code></td>
<td>每次抓取样本数限制</td>
<td><code>0</code> (无限制)</td>
</tr>
<tr>
<td><code>label_limit</code></td>
<td>每个样本标签数限制</td>
<td><code>0</code> (无限制)</td>
</tr>
<tr>
<td><code>target_limit</code></td>
<td>每个抓取配置的目标数限制</td>
<td><code>0</code> (无限制)</td>
</tr>
<tr>
<td><code>metric_name_validation_scheme</code></td>
<td>指标名称验证方案</td>
<td><code>utf8</code></td>
</tr>
</tbody>
</table>
<hr />
<h4 id="runtime">Runtime 运行时配置<a class="headerlink" href="#runtime" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">runtime</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 配置 Go 垃圾回收器 GOGC 参数</span>
<span class="w">  </span><span class="c1"># 降低此数字会增加 CPU 使用率</span>
<span class="w">  </span><span class="nt">gogc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">75</span><span class="w">  </span><span class="c1"># 默认 75</span>
</code></pre></div>
<hr />
<h4 id="scrape-configs">Scrape Configs 抓取配置<a class="headerlink" href="#scrape-configs" title="Permanent link">&para;</a></h4>
<p>抓取配置指定一组目标及其抓取参数。一般情况下,一个抓取配置指定一个任务。</p>
<p><strong>基本结构:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;prometheus&#39;</span><span class="w">  </span><span class="c1"># 任务名称(必需,唯一)</span>

<span class="w">    </span><span class="c1"># 抓取间隔(覆盖全局设置)</span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>

<span class="w">    </span><span class="c1"># 抓取超时</span>
<span class="w">    </span><span class="nt">scrape_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>

<span class="w">    </span><span class="c1"># 指标路径</span>
<span class="w">    </span><span class="nt">metrics_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/metrics</span>

<span class="w">    </span><span class="c1"># 协议方案</span>
<span class="w">    </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>

<span class="w">    </span><span class="c1"># honor_labels 控制标签冲突处理</span>
<span class="w">    </span><span class="c1"># true: 保留抓取数据中的标签,忽略服务端标签</span>
<span class="w">    </span><span class="c1"># false: 重命名冲突标签为 exported_&lt;label&gt;</span>
<span class="w">    </span><span class="nt">honor_labels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">    </span><span class="c1"># honor_timestamps 控制是否使用目标的时间戳</span>
<span class="w">    </span><span class="c1"># true: 使用目标提供的时间戳</span>
<span class="w">    </span><span class="c1"># false: 忽略目标时间戳</span>
<span class="w">    </span><span class="nt">honor_timestamps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">    </span><span class="c1"># 静态配置的目标列表</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9090&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;production&#39;</span>
</code></pre></div>
<p><strong>完整配置示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 监控 Prometheus 自身</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;prometheus&#39;</span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9090&#39;</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="c1"># 监控 Node Exporter</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;node&#39;</span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;node1:9100&#39;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;node2:9100&#39;</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;production&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;node3:9100&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;testing&#39;</span>

<span class="w">  </span><span class="c1"># 使用 Kubernetes 服务发现</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;kubernetes-pods&#39;</span>
<span class="w">    </span><span class="nt">kubernetes_sd_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod</span>
<span class="w">    </span><span class="nt">relabel_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__meta_kubernetes_pod_label_app</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
</code></pre></div>
<p><strong>抓取配置关键选项:</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>job_name</code></td>
<td>任务名称(分配给抓取指标的标签)</td>
<td>必需</td>
</tr>
<tr>
<td><code>scrape_interval</code></td>
<td>抓取频率</td>
<td>继承 global</td>
</tr>
<tr>
<td><code>scrape_timeout</code></td>
<td>抓取超时</td>
<td>继承 global</td>
</tr>
<tr>
<td><code>metrics_path</code></td>
<td>指标路径</td>
<td><code>/metrics</code></td>
</tr>
<tr>
<td><code>scheme</code></td>
<td>协议</td>
<td><code>http</code></td>
</tr>
<tr>
<td><code>honor_labels</code></td>
<td>是否保留原始标签</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>honor_timestamps</code></td>
<td>是否使用目标时间戳</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>enable_compression</code></td>
<td>是否请求压缩响应</td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
<hr />
<h4 id="http-config-http">HTTP Config HTTP 配置<a class="headerlink" href="#http-config-http" title="Permanent link">&para;</a></h4>
<p>HTTP 配置允许配置 HTTP 请求的认证和 TLS 设置。</p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;secure-app&#39;</span>
<span class="w">    </span><span class="c1"># Basic 认证</span>
<span class="w">    </span><span class="nt">basic_auth</span><span class="p">:</span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;admin&#39;</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;secret123&#39;</span>

<span class="w">    </span><span class="c1"># 或使用文件</span>
<span class="w">    </span><span class="c1"># basic_auth:</span>
<span class="w">    </span><span class="c1">#   username_file: /path/to/username</span>
<span class="w">    </span><span class="c1">#   password_file: /path/to/password</span>

<span class="w">    </span><span class="c1"># 或使用 Bearer Token</span>
<span class="w">    </span><span class="c1"># authorization:</span>
<span class="w">    </span><span class="c1">#   type: Bearer</span>
<span class="w">    </span><span class="c1">#   credentials: &#39;mytoken123&#39;</span>
<span class="w">    </span><span class="c1">#   # 或从文件读取</span>
<span class="w">    </span><span class="c1">#   # credentials_file: /path/to/token</span>

<span class="w">    </span><span class="c1"># TLS 配置</span>
<span class="w">    </span><span class="nt">tls_config</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># CA 证书</span>
<span class="w">      </span><span class="nt">ca_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/ca.crt</span>
<span class="w">      </span><span class="c1"># 客户端证书</span>
<span class="w">      </span><span class="nt">cert_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/client.crt</span>
<span class="w">      </span><span class="nt">key_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/client.key</span>
<span class="w">      </span><span class="c1"># 跳过证书验证(不建议)</span>
<span class="w">      </span><span class="nt">insecure_skip_verify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="c1"># 最小 TLS 版本</span>
<span class="w">      </span><span class="nt">min_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TLS12</span>

<span class="w">    </span><span class="c1"># 代理设置</span>
<span class="w">    </span><span class="nt">proxy_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://proxy.example.com:8080</span>

<span class="w">    </span><span class="c1"># 自定义 HTTP 头</span>
<span class="w">    </span><span class="nt">http_headers</span><span class="p">:</span>
<span class="w">      </span><span class="nt">X-Custom-Header</span><span class="p">:</span>
<span class="w">        </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;custom-value&#39;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;app.example.com:443&#39;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
</code></pre></div>
<p><strong>HTTP 认证方式对比:</strong></p>
<table>
<thead>
<tr>
<th>认证方式</th>
<th>适用场景</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Basic Auth</strong></td>
<td>简单的用户名/密码认证</td>
<td>内部服务、开发环境</td>
</tr>
<tr>
<td><strong>Bearer Token</strong></td>
<td>API Token 认证</td>
<td>Kubernetes, 云服务</td>
</tr>
<tr>
<td><strong>OAuth 2.0</strong></td>
<td>复杂的授权流程</td>
<td>需要刷新 token 的场景</td>
</tr>
<tr>
<td><strong>TLS Client Cert</strong></td>
<td>mTLS 双向认证</td>
<td>高安全要求的服务</td>
</tr>
</tbody>
</table>
<hr />
<h4 id="service-discovery">服务发现 (Service Discovery)<a class="headerlink" href="#service-discovery" title="Permanent link">&para;</a></h4>
<p>Prometheus 支持 25+ 种服务发现机制,可以自动发现监控目标。</p>
<p><strong>支持的服务发现类型:</strong></p>
<div class="highlight"><pre><span></span><code>graph LR
    A[服务发现] --&gt; B[云平台]
    A --&gt; C[容器编排]
    A --&gt; D[服务注册]
    A --&gt; E[其他]

    B --&gt; B1[AWS EC2]
    B --&gt; B2[Azure]
    B --&gt; B3[GCE]
    B --&gt; B4[DigitalOcean]
    B --&gt; B5[Lightsail]
    B --&gt; B6[Linode]
    B --&gt; B7[Hetzner]

    C --&gt; C1[Kubernetes]
    C --&gt; C2[Docker]
    C --&gt; C3[Docker Swarm]
    C --&gt; C4[Nomad]
    C --&gt; C5[Marathon]

    D --&gt; D1[Consul]
    D --&gt; D2[Eureka]
    D --&gt; D3[Zookeeper]
    D --&gt; D4[DNS]

    E --&gt; E1[HTTP]
    E --&gt; E2[File]
    E --&gt; E3[OpenStack]
</code></pre></div>
<p><strong>常用服务发现配置示例:</strong></p>
<p><strong>1. Kubernetes 服务发现</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;kubernetes-pods&#39;</span>
<span class="w">    </span><span class="nt">kubernetes_sd_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod</span>
<span class="w">        </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">          </span><span class="nt">names</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>

<span class="w">    </span><span class="nt">relabel_configs</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 仅抓取带有 prometheus.io/scrape=true 注解的 Pod</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keep</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">      </span><span class="c1"># 使用自定义路径</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__meta_kubernetes_pod_annotation_prometheus_io_path</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replace</span>
<span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__metrics_path__</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">(.+)</span>

<span class="w">      </span><span class="c1"># 使用自定义端口</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__address__</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">__meta_kubernetes_pod_annotation_prometheus_io_port</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replace</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">([^:]+)(?::\d+)?;(\d+)</span>
<span class="w">        </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$1:$2</span>
<span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__address__</span>
</code></pre></div>
<p><strong>2. Consul 服务发现</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;consul-services&#39;</span>
<span class="w">    </span><span class="nt">consul_sd_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;localhost:8500&#39;</span>
<span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dc1&#39;</span>
<span class="w">        </span><span class="nt">services</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;web&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;api&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;database&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;prometheus&#39;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">relabel_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__meta_consul_service</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service</span>
</code></pre></div>
<p><strong>3. DNS 服务发现</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dns-discovery&#39;</span>
<span class="w">    </span><span class="nt">dns_sd_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">names</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;tasks.myservice.example.com&#39;</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;A&#39;</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9100</span>
<span class="w">    </span><span class="nt">refresh_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
</code></pre></div>
<p><strong>4. EC2 服务发现</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ec2-nodes&#39;</span>
<span class="w">    </span><span class="nt">ec2_sd_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-east-1</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9100</span>
<span class="w">        </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tag:Environment</span>
<span class="w">            </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;production&#39;</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance-state-name</span>
<span class="w">            </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;running&#39;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">relabel_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__meta_ec2_tag_Name</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance_name</span>
</code></pre></div>
<p><strong>5. File 服务发现 (最灵活)</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;file-sd&#39;</span>
<span class="w">    </span><span class="nt">file_sd_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">files</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;/etc/prometheus/targets/*.json&#39;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;/etc/prometheus/targets/*.yaml&#39;</span>
<span class="w">        </span><span class="nt">refresh_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
</code></pre></div>
<p><strong>targets.json 示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;host1:9100&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;host2:9100&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;labels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;team&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;backend&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;host3:9100&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;labels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;staging&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<hr />
<h4 id="relabel-configs">Relabel Configs 重新标记配置<a class="headerlink" href="#relabel-configs" title="Permanent link">&para;</a></h4>
<p>重新标记是一个强大的工具,可以在抓取之前动态重写目标的标签集。</p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;example&#39;</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9090&#39;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">relabel_configs</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 保留特定标签的目标</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__meta_kubernetes_namespace</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keep</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;production|staging&#39;</span>

<span class="w">      </span><span class="c1"># 删除特定标签的目标</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__meta_kubernetes_pod_name</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drop</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;test-.*&#39;</span>

<span class="w">      </span><span class="c1"># 替换标签值</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__address__</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;(.+):.*&#39;</span>
<span class="w">        </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;$1&#39;</span>

<span class="w">      </span><span class="c1"># 添加新标签</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster</span>
<span class="w">        </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;us-central&#39;</span>

<span class="w">      </span><span class="c1"># 保留标签</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">labelkeep</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;__meta_kubernetes_(namespace|pod_name|pod_ip)&#39;</span>

<span class="w">      </span><span class="c1"># 删除标签</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">labeldrop</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;__meta_kubernetes_pod_label_.*&#39;</span>
</code></pre></div>
<p><strong>Relabel 动作类型:</strong></p>
<table>
<thead>
<tr>
<th>Action</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>replace</code></td>
<td>替换标签值(默认)</td>
</tr>
<tr>
<td><code>keep</code></td>
<td>保留匹配 regex 的目标</td>
</tr>
<tr>
<td><code>drop</code></td>
<td>丢弃匹配 regex 的目标</td>
</tr>
<tr>
<td><code>labelkeep</code></td>
<td>保留匹配 regex 的标签</td>
</tr>
<tr>
<td><code>labeldrop</code></td>
<td>删除匹配 regex 的标签</td>
</tr>
<tr>
<td><code>labelmap</code></td>
<td>将标签名映射到新名称</td>
</tr>
<tr>
<td><code>hashmod</code></td>
<td>计算哈希值用于分片</td>
</tr>
</tbody>
</table>
<hr />
<h4 id="alerting">Alerting 告警配置<a class="headerlink" href="#alerting" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">alerting</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 告警重新标记</span>
<span class="w">  </span><span class="nt">alert_relabel_configs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">dc</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dc1&#39;</span>
<span class="w">      </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity</span>
<span class="w">      </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;critical&#39;</span>

<span class="w">  </span><span class="c1"># Alertmanager 配置</span>
<span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;alertmanager1:9093&#39;</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;alertmanager2:9093&#39;</span>

<span class="w">      </span><span class="c1"># 超时设置</span>
<span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>

<span class="w">      </span><span class="c1"># 路径前缀</span>
<span class="w">      </span><span class="nt">path_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/alertmanager</span>
</code></pre></div>
<hr />
<h4 id="remote-writeread">Remote Write/Read 远程写入/读取<a class="headerlink" href="#remote-writeread" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 远程写入(用于长期存储)</span>
<span class="nt">remote_write</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;http://remote-storage:9201/write&#39;</span>

<span class="w">    </span><span class="c1"># 写入超时</span>
<span class="w">    </span><span class="nt">remote_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>

<span class="w">    </span><span class="c1"># 队列配置</span>
<span class="w">    </span><span class="nt">queue_config</span><span class="p">:</span>
<span class="w">      </span><span class="nt">capacity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">      </span><span class="nt">max_shards</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="w">      </span><span class="nt">max_samples_per_send</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>

<span class="w">    </span><span class="c1"># 写入重新标记(过滤不需要的指标)</span>
<span class="w">    </span><span class="nt">write_relabel_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__name__</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;go_.*&#39;</span>
<span class="w">        </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drop</span>

<span class="c1"># 远程读取</span>
<span class="nt">remote_read</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;http://remote-storage:9201/read&#39;</span>
<span class="w">    </span><span class="nt">read_recent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<hr />
<h4 id="storage">Storage 存储配置<a class="headerlink" href="#storage" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tsdb</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 数据保留时间</span>
<span class="w">    </span><span class="nt">retention_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15d</span>

<span class="w">    </span><span class="c1"># 最大数据块大小</span>
<span class="w">    </span><span class="nt">retention_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512GB</span>

<span class="w">  </span><span class="nt">exemplars</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Exemplar 最大存储大小</span>
<span class="w">    </span><span class="nt">max_exemplars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100000</span>
</code></pre></div>
<hr />
<h4 id="_29">完整配置示例<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 全局配置</span>
<span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span>
<span class="w">  </span><span class="nt">evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span>
<span class="w">  </span><span class="nt">external_labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;production&#39;</span>
<span class="w">    </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;us-east-1&#39;</span>

<span class="c1"># 运行时配置</span>
<span class="nt">runtime</span><span class="p">:</span>
<span class="w">  </span><span class="nt">gogc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">75</span>

<span class="c1"># 规则文件</span>
<span class="nt">rule_files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;/etc/prometheus/rules/*.yml&#39;</span>

<span class="c1"># 抓取配置</span>
<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Prometheus 自身</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;prometheus&#39;</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9090&#39;</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="c1"># Node Exporters (使用文件服务发现)</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;node&#39;</span>
<span class="w">    </span><span class="nt">file_sd_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">files</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;/etc/prometheus/targets/nodes/*.json&#39;</span>

<span class="w">    </span><span class="nt">relabel_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__address__</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance</span>

<span class="w">  </span><span class="c1"># Kubernetes Pods</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;kubernetes-pods&#39;</span>
<span class="w">    </span><span class="nt">kubernetes_sd_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod</span>

<span class="w">    </span><span class="nt">relabel_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keep</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">__meta_kubernetes_pod_annotation_prometheus_io_path</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replace</span>
<span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__metrics_path__</span>
<span class="w">        </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">(.+)</span>

<span class="c1"># 告警配置</span>
<span class="nt">alerting</span><span class="p">:</span>
<span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;alertmanager:9093&#39;</span><span class="p p-Indicator">]</span>

<span class="c1"># 远程写入</span>
<span class="nt">remote_write</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;http://thanos-receive:19291/api/v1/receive&#39;</span>
<span class="w">    </span><span class="nt">queue_config</span><span class="p">:</span>
<span class="w">      </span><span class="nt">capacity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">      </span><span class="nt">max_samples_per_send</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>

<span class="c1"># 存储配置</span>
<span class="nt">storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tsdb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">retention_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30d</span>
<span class="w">    </span><span class="nt">retention_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1TB</span>
</code></pre></div>
<hr />
<h2 id="_30">总结<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h2>
<p>通过本节,我们学习了 Prometheus 配置的核心内容：</p>
<ol>
<li><strong>全局配置</strong>: 抓取间隔、评估间隔、外部标签等</li>
<li><strong>抓取配置</strong>: 如何定义监控目标、静态配置和服务发现</li>
<li><strong>服务发现</strong>: 支持 25+ 种自动发现机制(Kubernetes、Consul、EC2 等)</li>
<li><strong>认证与安全</strong>: Basic Auth、Bearer Token、OAuth 2.0、TLS 配置</li>
<li><strong>重新标记</strong>: 动态修改标签,实现灵活的目标过滤和标签管理</li>
<li><strong>告警配置</strong>: 配置 Alertmanager 集成</li>
<li><strong>远程存储</strong>: 远程写入/读取,实现长期数据存储</li>
</ol>
<p>这些配置选项为 Prometheus 提供了极大的灵活性,可以适应各种监控场景和基础设施环境。</p>
<hr />
<h3 id="34-recording-rules">3.4 Recording Rules (记录规则)<a class="headerlink" href="#34-recording-rules" title="Permanent link">&para;</a></h3>
<p>记录规则允许你预计算频繁使用或计算成本高的表达式,并将结果保存为新的时间序列。查询预计算的结果通常比每次执行原始表达式快得多,特别适用于需要重复查询相同表达式的仪表板。</p>
<h4 id="_31">规则配置基础<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<p>Prometheus 支持两种类型的规则:</p>
<ul>
<li><strong>Recording Rules (记录规则)</strong>: 预计算表达式,保存为新的时间序列</li>
<li><strong>Alerting Rules (告警规则)</strong>: 定义告警条件,触发通知</li>
</ul>
<p><strong>规则文件格式</strong>: YAML</p>
<p><strong>在配置文件中加载规则:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">rule_files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;/etc/prometheus/rules/*.yml&#39;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;/etc/prometheus/alerts/*.yml&#39;</span>
</code></pre></div>
<p><strong>运行时重新加载规则:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 发送 SIGHUP 信号</span>
<span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>SIGHUP<span class="w"> </span>&lt;PID&gt;

<span class="c1"># 或使用 HTTP 接口</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9090/-/reload
</code></pre></div>
<blockquote>
<p>⚠️ 只有所有规则文件格式正确时,更改才会被应用</p>
</blockquote>
<p><strong>语法检查工具:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>check<span class="w"> </span>rules<span class="w"> </span>/path/to/example.rules.yml
</code></pre></div>
<hr />
<h4 id="_32">规则文件结构<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;组名&gt;</span><span class="w">              </span><span class="c1"># 必需,文件内唯一</span>
<span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;持续时间&gt;</span><span class="w">       </span><span class="c1"># 可选,规则评估频率</span>
<span class="w">    </span><span class="nt">limit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;整数&gt;</span><span class="w">              </span><span class="c1"># 可选,限制告警/序列数量</span>
<span class="w">    </span><span class="nt">query_offset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;持续时间&gt;</span><span class="w">   </span><span class="c1"># 可选,查询时间偏移</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">                    </span><span class="c1"># 可选,添加到所有规则的标签</span>
<span class="w">      </span><span class="nt">&lt;标签名&gt;</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;标签值&gt;</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;规则定义&gt;</span>
</code></pre></div>
<p><strong>基本示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example</span>
<span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 记录规则</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code:prometheus_http_requests_total:sum</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum by (code) (prometheus_http_requests_total)</span>
</code></pre></div>
<hr />
<h4 id="recording-rule">Recording Rule 语法<a class="headerlink" href="#recording-rule" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 记录规则名称(必需,必须是有效的指标名称)</span>
<span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;string&gt;</span>

<span class="c1"># PromQL 表达式(必需)</span>
<span class="c1"># 每次评估时执行,结果保存为新的时间序列</span>
<span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;string&gt;</span>

<span class="c1"># 添加或覆盖的标签(可选)</span>
<span class="nt">labels</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;labelname&gt;</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;labelvalue&gt;</span>
</code></pre></div>
<p><strong>完整配置示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 1. HTTP 请求聚合</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http_requests_aggregation</span>
<span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 按状态码聚合请求总数</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">code:prometheus_http_requests_total:sum</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum by (code) (prometheus_http_requests_total)</span>

<span class="w">      </span><span class="c1"># 按 job 聚合请求总数</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job:prometheus_http_requests_total:sum</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum by (job) (prometheus_http_requests_total)</span>

<span class="w">      </span><span class="c1"># 计算每个 job 的请求速率 (5分钟平均)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job:prometheus_http_requests_total:rate5m</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum by (job) (rate(prometheus_http_requests_total[5m]))</span>

<span class="w">  </span><span class="c1"># 2. 资源使用率聚合</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">resource_usage</span>
<span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># CPU 使用率聚合</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance:node_cpu_utilization:rate5m</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 - avg by (instance) (rate(node_cpu_seconds_total{mode=&quot;idle&quot;}[5m]))</span>

<span class="w">      </span><span class="c1"># 内存使用率</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance:node_memory_utilization:ratio</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">1 - (</span>
<span class="w">            </span><span class="no">node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes</span>
<span class="w">          </span><span class="no">)</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">infrastructure</span>

<span class="w">  </span><span class="c1"># 3. 业务指标聚合</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">business_metrics</span>
<span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 计算 API 请求成功率</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job:api_success_rate:ratio</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">sum by (job) (rate(api_requests_total{status=~&quot;2..&quot;}[5m]))</span>
<span class="w">          </span><span class="no">/</span>
<span class="w">          </span><span class="no">sum by (job) (rate(api_requests_total[5m]))</span>

<span class="w">      </span><span class="c1"># 计算 99 分位延迟</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job:request_latency_seconds:p99</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">histogram_quantile(0.99, sum by (job, le) (rate(request_duration_seconds_bucket[5m])))</span>
</code></pre></div>
<hr />
<h4 id="_33">记录规则命名最佳实践<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h4>
<p><strong>命名格式</strong>: <code>level:metric:operations</code></p>
<ul>
<li><strong>level</strong>: 聚合级别 (如 <code>job</code>, <code>instance</code>, <code>cluster</code>)</li>
<li><strong>metric</strong>: 原始指标名称</li>
<li><strong>operations</strong>: 应用的操作 (如 <code>sum</code>, <code>rate5m</code>, <code>ratio</code>)</li>
</ul>
<p><strong>示例:</strong></p>
<table>
<thead>
<tr>
<th>规则名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>job:http_requests_total:rate5m</code></td>
<td>按 job 聚合的 HTTP 请求 5 分钟速率</td>
</tr>
<tr>
<td><code>instance:node_cpu:utilization</code></td>
<td>按实例聚合的 CPU 使用率</td>
</tr>
<tr>
<td><code>cluster:memory:available_bytes</code></td>
<td>集群级别的可用内存</td>
</tr>
<tr>
<td><code>code:http_errors_total:sum</code></td>
<td>按状态码聚合的错误总数</td>
</tr>
</tbody>
</table>
<hr />
<h4 id="_34">规则组配置选项<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>name</code></td>
<td>规则组名称(必需,唯一)</td>
<td>-</td>
</tr>
<tr>
<td><code>interval</code></td>
<td>规则评估间隔</td>
<td><code>global.evaluation_interval</code></td>
</tr>
<tr>
<td><code>limit</code></td>
<td>告警/序列数量限制</td>
<td><code>0</code> (无限制)</td>
</tr>
<tr>
<td><code>query_offset</code></td>
<td>查询时间偏移</td>
<td><code>global.rule_query_offset</code></td>
</tr>
<tr>
<td><code>labels</code></td>
<td>附加到所有规则的标签</td>
<td>-</td>
</tr>
</tbody>
</table>
<hr />
<h4 id="_35">规则评估性能优化<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h4>
<p><strong>1. 设置合适的评估间隔</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 高频评估 - 关键指标</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical_metrics</span>
<span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance:up:count</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">count by (job) (up == 1)</span>

<span class="w">  </span><span class="c1"># 低频评估 - 聚合指标</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">daily_aggregations</span>
<span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster:cpu_usage:avg24h</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">avg_over_time(cluster:cpu_usage:ratio[24h])</span>
</code></pre></div>
<p><strong>2. 使用查询偏移确保数据可用</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">remote_write_metrics</span>
<span class="w">    </span><span class="c1"># 偏移 1 分钟,确保远程写入的数据已到达</span>
<span class="w">    </span><span class="nt">query_offset</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job:requests_total:rate5m</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum by (job) (rate(requests_total[5m]))</span>
</code></pre></div>
<p><strong>3. 限制规则产生的序列数量</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high_cardinality_metrics</span>
<span class="w">    </span><span class="c1"># 限制最多产生 10000 个时间序列</span>
<span class="w">    </span><span class="nt">limit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path:http_requests_total:sum</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum by (path) (http_requests_total)</span>
</code></pre></div>
<hr />
<h3 id="35-alerting-rules">3.5 Alerting Rules (告警规则)<a class="headerlink" href="#35-alerting-rules" title="Permanent link">&para;</a></h3>
<p>告警规则允许你基于 Prometheus 表达式定义告警条件,并在告警触发时发送通知到外部服务(如 Alertmanager)。</p>
<h4 id="_36">告警规则语法<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 告警名称(必需,必须是有效的标签值)</span>
<span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;string&gt;</span>

<span class="c1"># PromQL 表达式(必需)</span>
<span class="c1"># 当表达式结果为真时,告警激活</span>
<span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;string&gt;</span>

<span class="c1"># 持续时间阈值(可选)</span>
<span class="c1"># 告警在持续触发这段时间后才会 firing</span>
<span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">for</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">&lt;duration&gt; | default = 0s</span><span class="w"> </span><span class="p p-Indicator">]</span>

<span class="c1"># 保持触发时间(可选)</span>
<span class="c1"># 告警条件消失后继续触发的时间</span>
<span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">keep_firing_for</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">&lt;duration&gt; | default = 0s</span><span class="w"> </span><span class="p p-Indicator">]</span>

<span class="c1"># 附加标签(可选)</span>
<span class="c1"># 标签值支持模板化</span>
<span class="nt">labels</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">&lt;labelname&gt;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">&lt;tmpl_string&gt;</span><span class="w"> </span><span class="p p-Indicator">]</span>

<span class="c1"># 注解(可选)</span>
<span class="c1"># 用于存储描述、Runbook 链接等信息</span>
<span class="c1"># 注解值支持模板化</span>
<span class="nt">annotations</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">&lt;labelname&gt;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">&lt;tmpl_string&gt;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</code></pre></div>
<hr />
<h4 id="_37">告警规则示例<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h4>
<p><strong>基础告警:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance_alerts</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 实例宕机告警</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InstanceDown</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">up == 0</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">          </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">infrastructure</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;实例</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">宕机&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">(job:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.job</span><span class="nv"> </span><span class="s">}})</span><span class="nv"> </span><span class="s">已宕机超过</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">分钟&quot;</span>
</code></pre></div>
<p><strong>高级告警配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application_alerts</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 1. API 高延迟告警</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">APIHighRequestLatency</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">histogram_quantile(0.5, </span>
<span class="w">            </span><span class="no">rate(api_http_request_latencies_second_bucket[5m])</span>
<span class="w">          </span><span class="no">) &gt; 1</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">API</span><span class="nv"> </span><span class="s">延迟过高&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;实例</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">的中位数请求延迟超过</span><span class="nv"> </span><span class="s">1s</span><span class="nv"> </span><span class="s">(当前值:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}s)&quot;</span>
<span class="w">          </span><span class="nt">dashboard</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://grafana.example.com/d/api-dashboard&quot;</span>
<span class="w">          </span><span class="nt">runbook</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://wiki.example.com/runbooks/api-latency&quot;</span>

<span class="w">      </span><span class="c1"># 2. 错误率过高告警</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighErrorRate</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">(</span>
<span class="w">            </span><span class="no">sum by (job) (rate(http_requests_total{status=~&quot;5..&quot;}[5m]))</span>
<span class="w">            </span><span class="no">/</span>
<span class="w">            </span><span class="no">sum by (job) (rate(http_requests_total[5m]))</span>
<span class="w">          </span><span class="no">) &gt; 0.05</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">keep_firing_for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.job</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">错误率过高&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.job</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">的</span><span class="nv"> </span><span class="s">5xx</span><span class="nv"> </span><span class="s">错误率超过</span><span class="nv"> </span><span class="s">5%</span><span class="nv"> </span><span class="s">(当前:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">humanizePercentage</span><span class="nv"> </span><span class="s">}})&quot;</span>

<span class="w">      </span><span class="c1"># 3. 磁盘空间不足告警</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DiskSpaceLow</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">(</span>
<span class="w">            </span><span class="no">node_filesystem_avail_bytes{fstype!~&quot;tmpfs|fuse.lxcfs&quot;}</span>
<span class="w">            </span><span class="no">/</span>
<span class="w">            </span><span class="no">node_filesystem_size_bytes{fstype!~&quot;tmpfs|fuse.lxcfs&quot;}</span>
<span class="w">          </span><span class="no">) &lt; 0.1</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">磁盘空间不足&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">实例 {{ $labels.instance }} 的挂载点 {{ $labels.mountpoint }} </span>
<span class="w">            </span><span class="no">可用空间低于 10% (当前: {{ $value | humanizePercentage }})</span>

<span class="w">      </span><span class="c1"># 4. 内存使用率过高告警</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighMemoryUsage</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) &gt; 0.9</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">内存使用率过高&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;实例</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">内存使用率超过</span><span class="nv"> </span><span class="s">90%</span><span class="nv"> </span><span class="s">(当前:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">humanizePercentage</span><span class="nv"> </span><span class="s">}})&quot;</span>
</code></pre></div>
<hr />
<h4 id="_38">告警状态转换<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    A[Inactive&lt;br/&gt;未触发] --&gt;|expr = true| B[Pending&lt;br/&gt;待触发]
    B --&gt;|持续 for 时间| C[Firing&lt;br/&gt;触发中]
    B --&gt;|expr = false| A
    C --&gt;|expr = false&lt;br/&gt;&amp; keep_firing_for = 0| A
    C --&gt;|expr = false&lt;br/&gt;&amp; keep_firing_for &gt; 0| D[Keep Firing&lt;br/&gt;保持触发]
    D --&gt;|超过 keep_firing_for| A
    D --&gt;|expr = true| C
</code></pre></div>
<p><strong>状态说明:</strong></p>
<table>
<thead>
<tr>
<th>状态</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Inactive</strong></td>
<td>告警表达式结果为假,告警未激活</td>
</tr>
<tr>
<td><strong>Pending</strong></td>
<td>表达式为真,但未达到 <code>for</code> 持续时间</td>
</tr>
<tr>
<td><strong>Firing</strong></td>
<td>表达式为真且持续时间超过 <code>for</code> 阈值</td>
</tr>
<tr>
<td><strong>Keep Firing</strong></td>
<td>表达式已变为假,但在 <code>keep_firing_for</code> 期间内继续触发</td>
</tr>
</tbody>
</table>
<hr />
<h4 id="_39">告警模板化<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<p>告警的 <code>labels</code> 和 <code>annotations</code> 支持使用 Go 模板语法。</p>
<p><strong>可用变量:</strong></p>
<table>
<thead>
<tr>
<th>变量</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$labels</code></td>
<td>告警实例的标签键值对</td>
<td><code>{{ $labels.instance }}</code></td>
</tr>
<tr>
<td><code>$value</code></td>
<td>告警表达式的评估值</td>
<td><code>{{ $value }}</code></td>
</tr>
<tr>
<td><code>$externalLabels</code></td>
<td>全局配置的外部标签</td>
<td><code>{{ $externalLabels.cluster }}</code></td>
</tr>
</tbody>
</table>
<p><strong>模板函数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">annotations</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 格式化百分比</span>
<span class="w">  </span><span class="nt">usage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">humanizePercentage</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="w">  </span><span class="c1"># 格式化数字(添加单位)</span>
<span class="w">  </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">humanize</span><span class="nv"> </span><span class="s">}}B&quot;</span>

<span class="w">  </span><span class="c1"># 格式化为 1024 进制</span>
<span class="w">  </span><span class="nt">disk</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">humanize1024</span><span class="nv"> </span><span class="s">}}B&quot;</span>

<span class="w">  </span><span class="c1"># 格式化时间戳</span>
<span class="w">  </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">humanizeTimestamp</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<p><strong>完整模板示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template_examples</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PodCrashLooping</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(kube_pod_container_status_restarts_total[15m]) &gt; 0</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">          </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.namespace</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">          </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.pod</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Pod</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.namespace</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">$labels.pod</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">频繁重启&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">命名空间: {{ $labels.namespace }}</span>
<span class="w">            </span><span class="no">Pod: {{ $labels.pod }}</span>
<span class="w">            </span><span class="no">容器: {{ $labels.container }}</span>
<span class="w">            </span><span class="no">重启速率: {{ $value | humanize }} 次/秒</span>
<span class="w">            </span><span class="no">集群: {{ $externalLabels.cluster }}</span>
<span class="w">          </span><span class="nt">grafana</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://grafana/d/pods?var-namespace={{</span><span class="nv"> </span><span class="s">$labels.namespace</span><span class="nv"> </span><span class="s">}}&amp;var-pod={{</span><span class="nv"> </span><span class="s">$labels.pod</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<hr />
<h4 id="_40">告警最佳实践<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h4>
<p><strong>1. 合理设置 <code>for</code> 持续时间</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ 不好 - 可能产生大量瞬时告警</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighCPU</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpu_usage &gt; 0.8</span>
<span class="w">  </span><span class="c1"># 没有 for,立即告警</span>

<span class="c1"># ✅ 好 - 只在持续高负载时告警</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighCPU</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpu_usage &gt; 0.8</span>
<span class="w">  </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span><span class="w">  </span><span class="c1"># 持续 10 分钟才告警</span>
</code></pre></div>
<p><strong>2. 使用 <code>keep_firing_for</code> 防止抖动</strong></p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceDown</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">up{job=&quot;myservice&quot;} == 0</span>
<span class="w">  </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">  </span><span class="nt">keep_firing_for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span><span class="w">  </span><span class="c1"># 服务恢复后继续告警 10 分钟</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;服务可能存在不稳定问题&quot;</span>
</code></pre></div>
<p><strong>3. 分级告警严重程度</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">disk_alerts</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 警告级别</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DiskSpaceWarning</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">disk_free_percent &lt; 20</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>

<span class="w">      </span><span class="c1"># 严重级别</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DiskSpaceCritical</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">disk_free_percent &lt; 10</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>

<span class="w">      </span><span class="c1"># 紧急级别</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DiskSpaceEmergency</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">disk_free_percent &lt; 5</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">emergency</span>
</code></pre></div>
<p><strong>4. 提供详细的上下文信息</strong></p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DatabaseConnectionPoolExhausted</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db_connection_pool_usage &gt; 0.95</span>
<span class="w">  </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">数据库连接池即将耗尽&quot;</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">数据库连接池使用率: {{ $value | humanizePercentage }}</span>
<span class="w">      </span><span class="no">实例: {{ $labels.instance }}</span>
<span class="w">      </span><span class="no">数据库: {{ $labels.database }}</span>
<span class="w">    </span><span class="nt">impact</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;可能导致应用无法建立新的数据库连接,影响业务&quot;</span>
<span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">1. 检查是否存在连接泄漏</span>
<span class="w">      </span><span class="no">2. 考虑增加连接池大小</span>
<span class="w">      </span><span class="no">3. 检查慢查询</span>
<span class="w">    </span><span class="nt">runbook</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://wiki.example.com/runbooks/db-connection-pool&quot;</span>
<span class="w">    </span><span class="nt">dashboard</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://grafana.example.com/d/db-dashboard?var-instance={{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<hr />
<h4 id="_41">查看告警状态<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h4>
<p><strong>1. 通过 Prometheus UI</strong></p>
<p>访问 <code>http://prometheus:9090/alerts</code> 查看所有告警的当前状态。</p>
<p><strong>2. 通过 API 查询</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询所有 firing 告警</span>
curl<span class="w"> </span>http://localhost:9090/api/v1/alerts

<span class="c1"># 查询 ALERTS 指标</span>
curl<span class="w"> </span>-g<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=ALERTS&#39;</span>
</code></pre></div>
<p><strong>3. ALERTS 合成指标</strong></p>
<p>Prometheus 为每个告警自动创建 <code>ALERTS</code> 时间序列:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询所有 firing 状态的告警</span>
<span class="nv">ALERTS</span><span class="p">{</span><span class="nl">alertstate</span><span class="o">=</span><span class="p">&quot;</span><span class="s">firing</span><span class="p">&quot;}</span>

<span class="c1"># 查询所有 pending 状态的告警</span>
<span class="nv">ALERTS</span><span class="p">{</span><span class="nl">alertstate</span><span class="o">=</span><span class="p">&quot;</span><span class="s">pending</span><span class="p">&quot;}</span>

<span class="c1"># 查询特定告警</span>
<span class="nv">ALERTS</span><span class="p">{</span><span class="nl">alertname</span><span class="o">=</span><span class="p">&quot;</span><span class="s">InstanceDown</span><span class="p">&quot;,</span><span class="w"> </span><span class="nl">alertstate</span><span class="o">=</span><span class="p">&quot;</span><span class="s">firing</span><span class="p">&quot;}</span>
</code></pre></div>
<hr />
<h4 id="alertmanager">集成 Alertmanager<a class="headerlink" href="#alertmanager" title="Permanent link">&para;</a></h4>
<p>Prometheus 负责告警检测,Alertmanager 负责告警通知、分组、抑制和静默。</p>
<p><strong>在 prometheus.yml 中配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">alerting</span><span class="p">:</span>
<span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;alertmanager1:9093&#39;</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;alertmanager2:9093&#39;</span>
<span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
</code></pre></div>
<p><strong>告警流程:</strong></p>
<div class="highlight"><pre><span></span><code>graph LR
    A[Prometheus&lt;br/&gt;评估规则] --&gt;|告警触发| B[Prometheus&lt;br/&gt;发送告警]
    B --&gt; C[Alertmanager&lt;br/&gt;接收告警]
    C --&gt; D[分组&lt;br/&gt;Group]
    D --&gt; E[抑制&lt;br/&gt;Inhibition]
    E --&gt; F[静默&lt;br/&gt;Silence]
    F --&gt; G[路由&lt;br/&gt;Route]
    G --&gt; H1[Email]
    G --&gt; H2[Slack]
    G --&gt; H3[PagerDuty]
    G --&gt; H4[Webhook]
</code></pre></div>
<hr />
<h3 id="36-template-examples">3.6 Template Examples (模板示例)<a class="headerlink" href="#36-template-examples" title="Permanent link">&para;</a></h3>
<p>Prometheus 在告警的注解和标签中支持模板化,也支持在控制台页面中使用模板。模板基于 Go 模板系统,可以执行查询、迭代数据、使用条件语句和格式化数据。</p>
<h4 id="_42">告警字段模板<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h4>
<p><strong>基本模板:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InstanceDown</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">up == 0</span>
<span class="w">  </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">page</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;实例</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">宕机&quot;</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">(job:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.job</span><span class="nv"> </span><span class="s">}})</span><span class="nv"> </span><span class="s">已宕机超过</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">分钟&quot;</span>
</code></pre></div>
<blockquote>
<p>⚠️ 告警模板在每次规则迭代时对每个触发的告警执行,应保持查询和模板的轻量化。对于复杂模板,建议链接到控制台页面。</p>
</blockquote>
<hr />
<h4 id="_43">简单迭代<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h4>
<p><strong>显示实例列表及其状态:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{{</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s">&quot;up&quot;</span><span class="w"> </span><span class="p">}}</span>
<span class="w">  </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Labels</span><span class="p">.</span><span class="nx">instance</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Value</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>
</code></pre></div>
<p><strong>输出示例:</strong></p>
<div class="highlight"><pre><span></span><code>localhost:9090 1
localhost:9100 1
server1:9100 0
</code></pre></div>
<p>特殊变量 <code>.</code> 包含当前循环迭代的样本值。</p>
<hr />
<h4 id="_44">显示单个值<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h4>
<p><strong>获取特定指标值:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{{</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="s">&quot;some_metric{instance=&#39;someinstance&#39;}&quot;</span><span class="w"> </span><span class="p">}}</span>
<span class="w">  </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">first</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">humanize</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>
</code></pre></div>
<p><strong>说明:</strong></p>
<ul>
<li><code>with</code> 语句用于错误处理,防止查询无结果时出错</li>
<li><code>first</code> 获取第一个结果</li>
<li><code>value</code> 提取数值</li>
<li><code>humanize</code> 格式化数字</li>
</ul>
<hr />
<h4 id="url">使用控制台 URL 参数<a class="headerlink" href="#url" title="Permanent link">&para;</a></h4>
<p><strong>动态查询参数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{{</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">printf</span><span class="w"> </span><span class="s">&quot;node_memory_MemTotal{job=&#39;node&#39;,instance=&#39;%s&#39;}&quot;</span><span class="w"> </span><span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">instance</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="p">}}</span>
<span class="w">  </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">first</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">humanize1024</span><span class="w"> </span><span class="p">}}</span><span class="nx">B</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>
</code></pre></div>
<p><strong>访问方式:</strong></p>
<div class="highlight"><pre><span></span><code>console.html?instance=hostname
</code></pre></div>
<p>此时 <code>.Params.instance</code> 的值为 <code>hostname</code>。</p>
<hr />
<h4 id="_45">高级迭代示例<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h4>
<p><strong>显示网络接口流量表格:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
{{ range printf &quot;node_network_receive_bytes{job=&#39;node&#39;,instance=&#39;%s&#39;,device!=&#39;lo&#39;}&quot; .Params.instance | query | sortByLabel &quot;device&quot;}}
  <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;&lt;</span><span class="nt">th</span> <span class="na">colspan</span><span class="o">=</span><span class="s">2</span><span class="p">&gt;</span>{{ .Labels.device }}<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>接收<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ with printf &quot;rate(node_network_receive_bytes{job=&#39;node&#39;,instance=&#39;%s&#39;,device=&#39;%s&#39;}[5m])&quot; .Labels.instance .Labels.device | query }}{{ . | first | value | humanize }}B/s{{end}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>发送<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ with printf &quot;rate(node_network_transmit_bytes{job=&#39;node&#39;,instance=&#39;%s&#39;,device=&#39;%s&#39;}[5m])&quot; .Labels.instance .Labels.device | query }}{{ . | first | value | humanize }}B/s{{end}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
{{ end }}
<span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
</code></pre></div>
<p><strong>说明:</strong></p>
<ul>
<li><code>sortByLabel "device"</code> 按设备名称排序</li>
<li>在 <code>range</code> 循环中,<code>.</code> 变为循环变量,因此 <code>.Params.instance</code> 不再可用</li>
</ul>
<hr />
<h4 id="_46">定义可重用模板<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<p><strong>定义模板:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{{</span><span class="cm">/* 定义模板 */</span><span class="p">}}</span>
<span class="p">{{</span><span class="nx">define</span><span class="w"> </span><span class="s">&quot;myTemplate&quot;</span><span class="p">}}</span>
<span class="w">  </span><span class="nx">执行某些操作</span>
<span class="p">{{</span><span class="nx">end</span><span class="p">}}</span>

<span class="p">{{</span><span class="cm">/* 使用模板 */</span><span class="p">}}</span>
<span class="p">{{</span><span class="nx">template</span><span class="w"> </span><span class="s">&quot;myTemplate&quot;</span><span class="p">}}</span>
</code></pre></div>
<p><strong>多参数模板:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{{</span><span class="nx">define</span><span class="w"> </span><span class="s">&quot;myMultiArgTemplate&quot;</span><span class="p">}}</span>
<span class="w">  </span><span class="nx">第一个参数</span><span class="p">:</span><span class="w"> </span><span class="p">{{.</span><span class="nx">arg0</span><span class="p">}}</span>
<span class="w">  </span><span class="nx">第二个参数</span><span class="p">:</span><span class="w"> </span><span class="p">{{.</span><span class="nx">arg1</span><span class="p">}}</span>
<span class="p">{{</span><span class="nx">end</span><span class="p">}}</span>

<span class="p">{{</span><span class="cm">/* 使用 args 函数传递多个参数 */</span><span class="p">}}</span>
<span class="p">{{</span><span class="nx">template</span><span class="w"> </span><span class="s">&quot;myMultiArgTemplate&quot;</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">)}}</span>
</code></pre></div>
<hr />
<h4 id="_47">常用模板函数<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
<th>示例</th>
<th>输出</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>humanize</code></td>
<td>格式化数字,添加单位</td>
<td><code>{{ 1234567 \| humanize }}</code></td>
<td><code>1.234567M</code></td>
</tr>
<tr>
<td><code>humanize1024</code></td>
<td>按 1024 进制格式化</td>
<td><code>{{ 1048576 \| humanize1024 }}B</code></td>
<td><code>1MiB</code></td>
</tr>
<tr>
<td><code>humanizePercentage</code></td>
<td>格式化为百分比</td>
<td><code>{{ 0.8234 \| humanizePercentage }}</code></td>
<td><code>82.34%</code></td>
</tr>
<tr>
<td><code>humanizeDuration</code></td>
<td>格式化持续时间</td>
<td><code>{{ 3661 \| humanizeDuration }}</code></td>
<td><code>1h1m1s</code></td>
</tr>
<tr>
<td><code>humanizeTimestamp</code></td>
<td>格式化时间戳</td>
<td><code>{{ 1609459200 \| humanizeTimestamp }}</code></td>
<td><code>2021-01-01 00:00:00</code></td>
</tr>
<tr>
<td><code>title</code></td>
<td>首字母大写</td>
<td><code>{{ "hello" \| title }}</code></td>
<td><code>Hello</code></td>
</tr>
<tr>
<td><code>toUpper</code></td>
<td>转大写</td>
<td><code>{{ "hello" \| toUpper }}</code></td>
<td><code>HELLO</code></td>
</tr>
<tr>
<td><code>toLower</code></td>
<td>转小写</td>
<td><code>{{ "HELLO" \| toLower }}</code></td>
<td><code>hello</code></td>
</tr>
<tr>
<td><code>stripPort</code></td>
<td>移除端口号</td>
<td><code>{{ "host:8080" \| stripPort }}</code></td>
<td><code>host</code></td>
</tr>
</tbody>
</table>
<hr />
<h4 id="_48">实用模板示例<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h4>
<p><strong>1. 格式化告警消息:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">annotations</span><span class="p">:</span>
<span class="w">  </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{{ $labels.job }} 服务异常</span>

<span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">服务: {{ $labels.job }}</span>
<span class="w">    </span><span class="no">实例: {{ $labels.instance }}</span>
<span class="w">    </span><span class="no">状态: {{ if eq $value 0.0 }}宕机{{ else }}运行中{{ end }}</span>
<span class="w">    </span><span class="no">持续时间: {{ .StartsAt | humanizeDuration }}</span>

<span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">CPU 使用率: {{ with query (printf &quot;instance:cpu_usage:ratio{instance=&#39;%s&#39;}&quot; $labels.instance) }}{{ . | first | value | humanizePercentage }}{{ end }}</span>
<span class="w">    </span><span class="no">内存使用率: {{ with query (printf &quot;instance:memory_usage:ratio{instance=&#39;%s&#39;}&quot; $labels.instance) }}{{ . | first | value | humanizePercentage }}{{ end }}</span>
</code></pre></div>
<p><strong>2. 动态生成 Runbook 链接:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">annotations</span><span class="p">:</span>
<span class="w">  </span><span class="nt">runbook</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">https://wiki.example.com/runbooks/{{ $labels.alertname | toLower | reReplaceAll &quot; &quot; &quot;-&quot; }}</span>
</code></pre></div>
<p><strong>3. 条件格式化:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">annotations</span><span class="p">:</span>
<span class="w">  </span><span class="nt">severity_emoji</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{{ if eq $labels.severity &quot;critical&quot; }}🔴{{ else if eq $labels.severity &quot;warning&quot; }}⚠️{{ else }}ℹ️{{ end }}</span>

<span class="w">  </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{{ .Annotations.severity_emoji }} {{ $labels.alertname }}</span>

<span class="w">    </span><span class="no">{{ if gt $value 0.9 }}</span>
<span class="w">      </span><span class="no">紧急! 使用率超过 90%</span>
<span class="w">    </span><span class="no">{{ else if gt $value 0.7 }}</span>
<span class="w">      </span><span class="no">警告: 使用率超过 70%</span>
<span class="w">    </span><span class="no">{{ else }}</span>
<span class="w">      </span><span class="no">注意: 使用率为 {{ $value | humanizePercentage }}</span>
<span class="w">    </span><span class="no">{{ end }}</span>
</code></pre></div>
<p><strong>4. 表格格式化:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">annotations</span><span class="p">:</span>
<span class="w">  </span><span class="nt">details</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">| 指标 | 当前值 | 阈值 |</span>
<span class="w">    </span><span class="no">|------|--------|------|</span>
<span class="w">    </span><span class="no">| CPU 使用率 | {{ with query &quot;instance:cpu_usage:ratio&quot; }}{{ . | first | value | humanizePercentage }}{{ end }} | 80% |</span>
<span class="w">    </span><span class="no">| 内存使用率 | {{ with query &quot;instance:memory_usage:ratio&quot; }}{{ . | first | value | humanizePercentage }}{{ end }} | 80% |</span>
<span class="w">    </span><span class="no">| 磁盘使用率 | {{ with query &quot;instance:disk_usage:ratio&quot; }}{{ . | first | value | humanizePercentage }}{{ end }} | 80% |</span>
</code></pre></div>
<hr />
<h4 id="_49">模板调试技巧<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h4>
<p><strong>1. 使用 promtool 验证模板:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>check<span class="w"> </span>rules<span class="w"> </span>rules.yml
</code></pre></div>
<p><strong>2. 在告警注解中输出调试信息:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">annotations</span><span class="p">:</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">Labels: {{ $labels }}</span>
<span class="w">    </span><span class="no">Value: {{ $value }}</span>
<span class="w">    </span><span class="no">External Labels: {{ $externalLabels }}</span>
</code></pre></div>
<p><strong>3. 测试查询结果:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">annotations</span><span class="p">:</span>
<span class="w">  </span><span class="nt">query_result</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{{ with query &quot;up{instance=&#39;localhost:9090&#39;}&quot; }}</span>
<span class="w">      </span><span class="no">结果数量: {{ . | len }}</span>
<span class="w">      </span><span class="no">第一个值: {{ . | first | value }}</span>
<span class="w">    </span><span class="no">{{ else }}</span>
<span class="w">      </span><span class="no">查询无结果</span>
<span class="w">    </span><span class="no">{{ end }}</span>
</code></pre></div>
<hr />
<h2 id="_50">总结<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h2>
<p>通过本节,我们学习了 Prometheus 规则和模板的核心内容:</p>
<p><strong>Recording Rules (记录规则):</strong></p>
<ol>
<li>预计算频繁使用或计算昂贵的表达式</li>
<li>提供命名最佳实践 (<code>level:metric:operations</code>)</li>
<li>支持规则分组、评估间隔和限制配置</li>
<li>适用于仪表板、告警和长期存储优化</li>
</ol>
<p><strong>Alerting Rules (告警规则):</strong></p>
<ol>
<li>基于 PromQL 表达式定义告警条件</li>
<li>支持告警状态转换 (Inactive → Pending → Firing)</li>
<li>提供 <code>for</code> 和 <code>keep_firing_for</code> 控制告警行为</li>
<li>与 Alertmanager 集成实现通知路由</li>
</ol>
<p><strong>Template Examples (模板示例):</strong></p>
<ol>
<li>基于 Go 模板系统的强大模板化能力</li>
<li>支持在告警标签、注解和控制台中使用</li>
<li>提供丰富的模板函数 (humanize、格式化等)</li>
<li>可定义可重用模板,提高配置复用性</li>
</ol>
<p>这些功能组合使用,能够构建强大的监控和告警系统,满足复杂的生产环境需求。</p>
<hr />
<h2 id="4-querying">4. Querying (查询)<a class="headerlink" href="#4-querying" title="Permanent link">&para;</a></h2>
<h3 id="41-basics">4.1 Basics (基础)<a class="headerlink" href="#41-basics" title="Permanent link">&para;</a></h3>
<p>Prometheus 提供了一种功能强大的查询语言 <strong>PromQL</strong> (Prometheus Query Language),允许用户实时选择和聚合时间序列数据。</p>
<h4 id="promql">PromQL 查询类型<a class="headerlink" href="#promql" title="Permanent link">&para;</a></h4>
<p><strong>1. Instant Query (即时查询)</strong></p>
<ul>
<li>在单个时间点评估</li>
<li>返回该时刻的数据</li>
<li>UI 中使用 "Table" 标签页</li>
</ul>
<p><strong>2. Range Query (范围查询)</strong></p>
<ul>
<li>在起始和结束时间之间的等间隔步长评估</li>
<li>相当于在多个时间戳运行即时查询</li>
<li>UI 中使用 "Graph" 标签页</li>
</ul>
<div class="highlight"><pre><span></span><code>graph LR
    A[PromQL 查询] --&gt; B[Instant Query&lt;br/&gt;即时查询]
    A --&gt; C[Range Query&lt;br/&gt;范围查询]
    B --&gt; D[返回单个时间点数据&lt;br/&gt;Table视图]
    C --&gt; E[返回时间范围数据&lt;br/&gt;Graph视图]
</code></pre></div>
<hr />
<h4 id="_51">表达式数据类型<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h4>
<p>PromQL 表达式可以评估为以下四种类型之一:</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>说明</th>
<th>示例用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Instant Vector``(即时向量)</strong></td>
<td>包含单个时间戳的一组时间序列,每个序列一个样本</td>
<td>当前 CPU 使用率</td>
</tr>
<tr>
<td><strong>Range Vector``(范围向量)</strong></td>
<td>包含一段时间内数据点的一组时间序列</td>
<td>过去5分钟的请求数据</td>
</tr>
<tr>
<td><strong>Scalar``(标量)</strong></td>
<td>简单的浮点数值</td>
<td>阈值、常数</td>
</tr>
<tr>
<td><strong>String``(字符串)</strong></td>
<td>简单的字符串值(当前未使用)</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>查询类型限制:</strong></p>
<ul>
<li><strong>即时查询</strong>: 支持所有数据类型</li>
<li><strong>范围查询</strong>: 只支持 Scalar 和 Instant Vector</li>
</ul>
<h2 id="4-querying_1">4. Querying (查询)<a class="headerlink" href="#4-querying_1" title="Permanent link">&para;</a></h2>
<p>本部分详细介绍 PromQL 查询语言的基础知识、操作符、函数和实用示例。由于内容较多,以下是简明版本,完整文档请参考官方文档。</p>
<h3 id="41-basics_1">4.1 Basics (基础)<a class="headerlink" href="#41-basics_1" title="Permanent link">&para;</a></h3>
<p><strong>核心概念:</strong></p>
<ul>
<li><strong>Instant Query</strong>: 即时查询,返回单个时间点数据</li>
<li><strong>Range Query</strong>: 范围查询,返回时间范围内数据</li>
</ul>
<p><strong>数据类型:</strong></p>
<ol>
<li>Instant Vector (即时向量) - 时间序列集合,每个序列一个样本</li>
<li>Range Vector (范围向量) - 时间序列集合,包含一段时间的数据</li>
<li>Scalar (标量) - 浮点数值</li>
<li>String (字符串) - 字符串值</li>
</ol>
<p><strong>选择器语法:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 基本选择</span>
<span class="nv">http_requests_total</span>

<span class="c1"># 标签过滤</span>
<span class="nv">http_requests_total</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">prometheus</span><span class="p">&quot;,</span><span class="w"> </span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;}</span>

<span class="c1"># 正则匹配</span>
<span class="nv">http_requests_total</span><span class="p">{</span><span class="nl">job</span><span class="o">=~</span><span class="p">&quot;</span><span class="s">.*server</span><span class="p">&quot;,</span><span class="w"> </span><span class="nl">status</span><span class="o">!~</span><span class="p">&quot;</span><span class="s">4..</span><span class="p">&quot;}</span>

<span class="c1"># 范围向量</span>
<span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span>

<span class="c1"># 时间修饰符</span>
<span class="nv">http_requests_total</span><span class="w"> </span><span class="k">offset</span><span class="w"> </span><span class="s">5m</span>
<span class="nv">http_requests_total</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mi">1609746000</span>
</code></pre></div>
<p><strong>标签匹配运算符:</strong></p>
<ul>
<li><code>=</code> : 等于</li>
<li><code>!=</code> : 不等于</li>
<li><code>=~</code> : 正则匹配</li>
<li><code>!~</code> : 正则不匹配</li>
</ul>
<hr />
<h3 id="42-operators">4.2 Operators (操作符)<a class="headerlink" href="#42-operators" title="Permanent link">&para;</a></h3>
<p><strong>算术操作符:</strong> <code>+</code> <code>-</code> <code>*</code> <code>/</code> <code>%</code> <code>^</code></p>
<p><strong>比较操作符:</strong> <code>==</code> <code>!=</code> <code>&gt;</code> <code>&lt;</code> <code>&gt;=</code> <code>&lt;=</code></p>
<p><strong>逻辑/集合操作符:</strong></p>
<ul>
<li><code>and</code> - 交集</li>
<li><code>or</code> - 并集</li>
<li><code>unless</code> - 补集</li>
</ul>
<p><strong>向量匹配:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># One-to-One 匹配</span>
<span class="nv">method_code</span><span class="err">:</span><span class="nv">http_errors</span><span class="err">:</span><span class="nv">rate5m</span><span class="p">{</span><span class="nl">code</span><span class="o">=</span><span class="p">&quot;</span><span class="s">500</span><span class="p">&quot;}</span><span class="w"> </span>
<span class="w">  </span><span class="o">/</span><span class="w"> </span><span class="k">ignoring</span><span class="o">(</span><span class="nv">code</span><span class="o">)</span><span class="w"> </span>
<span class="w">  </span><span class="nv">method</span><span class="err">:</span><span class="nv">http_requests</span><span class="err">:</span><span class="nv">rate5m</span>

<span class="c1"># Many-to-One 匹配</span>
<span class="nv">method_code</span><span class="err">:</span><span class="nv">http_errors</span><span class="err">:</span><span class="nv">rate5m</span><span class="w"> </span>
<span class="w">  </span><span class="o">/</span><span class="w"> </span><span class="k">ignoring</span><span class="o">(</span><span class="nv">code</span><span class="o">)</span><span class="w"> </span><span class="k">group_left</span><span class="w"> </span>
<span class="w">  </span><span class="nv">method</span><span class="err">:</span><span class="nv">http_requests</span><span class="err">:</span><span class="nv">rate5m</span>
</code></pre></div>
<p><strong>聚合操作符:</strong></p>
<ul>
<li><code>sum</code>, <code>avg</code>, <code>min</code>, <code>max</code>, <code>count</code></li>
<li><code>topk</code>, <code>bottomk</code>, <code>quantile</code></li>
<li><code>stddev</code>, <code>stdvar</code>, <code>group</code></li>
<li><code>count_values</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 按标签聚合</span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">job</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nv">http_requests_total</span><span class="o">)</span>
<span class="k">sum</span><span class="w"> </span><span class="k">without</span><span class="w"> </span><span class="o">(</span><span class="nv">instance</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nv">http_requests_total</span><span class="o">)</span>

<span class="c1"># 取最大的 k 个值</span>
<span class="k">topk</span><span class="o">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nv">http_requests_total</span><span class="o">)</span>

<span class="c1"># 分位数</span>
<span class="k">quantile</span><span class="o">(</span><span class="mf">0.95</span><span class="p">,</span><span class="w"> </span><span class="nv">http_request_duration_seconds</span><span class="o">)</span>
</code></pre></div>
<hr />
<h3 id="43-functions">4.3 Functions (函数)<a class="headerlink" href="#43-functions" title="Permanent link">&para;</a></h3>
<p><strong>速率函数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)</span><span class="w">           </span><span class="c1"># 平均速率</span>
<span class="kr">irate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)</span><span class="w">          </span><span class="c1"># 瞬时速率</span>
<span class="kr">increase</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">1h</span><span class="p">]</span><span class="o">)</span><span class="w">       </span><span class="c1"># 总增量</span>
</code></pre></div>
<p><strong>时间聚合函数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kr">avg_over_time</span><span class="o">(</span><span class="nv">node_cpu_usage</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)</span>
<span class="kr">max_over_time</span><span class="o">(</span><span class="nv">node_cpu_usage</span><span class="p">[</span><span class="s">24h</span><span class="p">]</span><span class="o">)</span>
<span class="kr">min_over_time</span><span class="o">(</span><span class="nv">node_cpu_usage</span><span class="p">[</span><span class="s">24h</span><span class="p">]</span><span class="o">)</span>
<span class="kr">sum_over_time</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">1h</span><span class="p">]</span><span class="o">)</span>
<span class="kr">quantile_over_time</span><span class="o">(</span><span class="mf">0.9</span><span class="p">,</span><span class="w"> </span><span class="nv">latency</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)</span>
</code></pre></div>
<p><strong>直方图函数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 计算 P90 延迟</span>
<span class="kr">histogram_quantile</span><span class="o">(</span><span class="mf">0.9</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">[</span><span class="s">10m</span><span class="p">]</span><span class="o">)</span>
<span class="o">)</span>

<span class="c1"># 计算平均值</span>
<span class="nv">histogram_avg</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>

<span class="c1"># 计算区间占比</span>
<span class="nv">histogram_fraction</span><span class="o">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds</span><span class="p">[</span><span class="s">1h</span><span class="p">]</span><span class="o">))</span>
</code></pre></div>
<p><strong>数学函数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kr">abs</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="w">            </span><span class="c1"># 绝对值</span>
<span class="kr">ceil</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="w">           </span><span class="c1"># 向上取整</span>
<span class="kr">floor</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="w">          </span><span class="c1"># 向下取整</span>
<span class="kr">round</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="w">          </span><span class="c1"># 四舍五入</span>
<span class="kr">sqrt</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="w">           </span><span class="c1"># 平方根</span>
<span class="kr">ln</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="p">,</span><span class="w"> </span><span class="kr">log2</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="p">,</span><span class="w"> </span><span class="kr">log10</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="w">   </span><span class="c1"># 对数</span>
<span class="kr">exp</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="w">            </span><span class="c1"># 指数</span>
<span class="kr">clamp_min</span><span class="o">(</span><span class="err">v</span><span class="p">,</span><span class="w"> </span><span class="k">min</span><span class="o">)</span><span class="p">,</span><span class="w"> </span><span class="kr">clamp_max</span><span class="o">(</span><span class="err">v</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="o">)</span><span class="w">  </span><span class="c1"># 钳位</span>
</code></pre></div>
<p><strong>缺失数据检测:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kr">absent</span><span class="o">(</span><span class="nv">up</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">critical-service</span><span class="p">&quot;}</span><span class="o">)</span><span class="w">               </span><span class="c1"># 检测指标缺失</span>
<span class="kr">absent_over_time</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api</span><span class="p">&quot;}[</span><span class="s">1h</span><span class="p">]</span><span class="o">)</span><span class="w">  </span><span class="c1"># 时间范围内缺失</span>
</code></pre></div>
<p><strong>预测函数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kr">predict_linear</span><span class="o">(</span><span class="nv">node_filesystem_free_bytes</span><span class="p">[</span><span class="s">1h</span><span class="p">],</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="mi">3600</span><span class="o">)</span><span class="w">  </span><span class="c1"># 预测未来值</span>
<span class="kr">deriv</span><span class="o">(</span><span class="nv">node_temperature_celsius</span><span class="p">[</span><span class="s">1h</span><span class="p">]</span><span class="o">)</span><span class="w">     </span><span class="c1"># 计算导数</span>
</code></pre></div>
<p><strong>标签操作:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kr">label_replace</span><span class="o">(</span><span class="err">v</span><span class="p">,</span><span class="w"> </span><span class="p">&quot;</span><span class="s">dst</span><span class="p">&quot;,</span><span class="w"> </span><span class="p">&quot;</span><span class="s">$1</span><span class="p">&quot;,</span><span class="w"> </span><span class="p">&quot;</span><span class="s">src</span><span class="p">&quot;,</span><span class="w"> </span><span class="p">&quot;</span><span class="s">(.*):.*</span><span class="p">&quot;</span><span class="o">)</span><span class="w">  </span><span class="c1"># 替换标签</span>
<span class="kr">label_join</span><span class="o">(</span><span class="err">v</span><span class="p">,</span><span class="w"> </span><span class="p">&quot;</span><span class="s">dst</span><span class="p">&quot;,</span><span class="w"> </span><span class="p">&quot;</span><span class="s">,</span><span class="p">&quot;,</span><span class="w"> </span><span class="p">&quot;</span><span class="s">src1</span><span class="p">&quot;,</span><span class="w"> </span><span class="p">&quot;</span><span class="s">src2</span><span class="p">&quot;</span><span class="o">)</span><span class="w">        </span><span class="c1"># 连接标签</span>
</code></pre></div>
<p><strong>时间函数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kr">time</span><span class="o">()</span><span class="w">                    </span><span class="c1"># 当前时间戳</span>
<span class="kr">timestamp</span><span class="o">(</span><span class="err">v</span><span class="o">)</span><span class="w">              </span><span class="c1"># 样本时间戳</span>
<span class="kr">year</span><span class="o">()</span><span class="p">,</span><span class="w"> </span><span class="kr">month</span><span class="o">()</span><span class="p">,</span><span class="w"> </span><span class="kr">day_of_month</span><span class="o">()</span><span class="p">,</span><span class="w"> </span><span class="kr">hour</span><span class="o">()</span><span class="p">,</span><span class="w"> </span><span class="kr">minute</span><span class="o">()</span><span class="w">  </span><span class="c1"># 时间组件</span>
</code></pre></div>
<hr />
<h3 id="44-examples">4.4 Examples (示例)<a class="headerlink" href="#44-examples" title="Permanent link">&para;</a></h3>
<p><strong>1. 计算请求速率</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># QPS</span>
<span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>

<span class="c1"># 按服务聚合</span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">service</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>
</code></pre></div>
<p><strong>2. 计算成功率/错误率</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 成功率</span>
<span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">{</span><span class="nl">status</span><span class="o">=~</span><span class="p">&quot;</span><span class="s">2..</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>
<span class="o">/</span>
<span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>

<span class="c1"># 错误率</span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">service</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">{</span><span class="nl">status</span><span class="o">=~</span><span class="p">&quot;</span><span class="s">5..</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>
<span class="o">/</span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">service</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>
</code></pre></div>
<p><strong>3. 计算资源使用率</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># CPU 使用率</span>
<span class="mi">100</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="k">avg</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">instance</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">node_cpu_seconds_total</span><span class="p">{</span><span class="nl">mode</span><span class="o">=</span><span class="p">&quot;</span><span class="s">idle</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="o">)</span>

<span class="c1"># 内存使用率</span>
<span class="o">(</span><span class="nv">node_memory_MemTotal_bytes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">node_memory_MemAvail</span><span class="w"> </span><span class="nv">able_bytes</span><span class="o">)</span><span class="w"> </span>
<span class="o">/</span><span class="w"> </span><span class="nv">node_memory_MemTotal_bytes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span>

<span class="c1"># 磁盘使用率</span>
<span class="o">(</span><span class="nv">node_filesystem_size_bytes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">node_filesystem_avail_bytes</span><span class="o">)</span><span class="w"> </span>
<span class="o">/</span><span class="w"> </span><span class="nv">node_filesystem_size_bytes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span>
</code></pre></div>
<p><strong>4. 计算延迟分位数</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># P50/P90/P99 延迟</span>
<span class="kr">histogram_quantile</span><span class="o">(</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">le</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)))</span>
<span class="kr">histogram_quantile</span><span class="o">(</span><span class="mf">0.9</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">le</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)))</span>
<span class="kr">histogram_quantile</span><span class="o">(</span><span class="mf">0.99</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">le</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)))</span>
</code></pre></div>
<p><strong>5. Top K 查询</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># CPU 使用率最高的 5 个实例</span>
<span class="k">topk</span><span class="o">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="kr">rate</span><span class="o">(</span><span class="nv">node_cpu_seconds_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>

<span class="c1"># 请求量最大的 10 个服务</span>
<span class="k">topk</span><span class="o">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">service</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)))</span>
</code></pre></div>
<p><strong>6. 预测和趋势</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 预测 4 小时后磁盘是否会满</span>
<span class="kr">predict_linear</span><span class="o">(</span><span class="nv">node_filesystem_avail_bytes</span><span class="p">[</span><span class="s">1h</span><span class="p">],</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="mi">3600</span><span class="o">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>

<span class="c1"># 流量环比增长</span>
<span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="w"> </span><span class="k">offset</span><span class="w"> </span><span class="s">1h</span><span class="o">))</span>
<span class="o">/</span><span class="w"> </span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="w"> </span><span class="k">offset</span><span class="w"> </span><span class="s">1h</span><span class="o">)</span>
</code></pre></div>
<p><strong>7. 计算 Uptime</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 运行时长(秒)</span>
<span class="kr">time</span><span class="o">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">node_boot_time_seconds</span>

<span class="c1"># 转换为天</span>
<span class="o">(</span><span class="kr">time</span><span class="o">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">node_boot_time_seconds</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">86400</span>
</code></pre></div>
<p><strong>8. 统计计数</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 运行中的实例数</span>
<span class="k">count</span><span class="o">(</span><span class="nv">up</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>

<span class="c1"># 每个应用的实例数</span>
<span class="k">count</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">app</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nv">up</span><span class="o">)</span>

<span class="c1"># 不同版本的实例数</span>
<span class="k">count_values</span><span class="o">(</span><span class="p">&quot;</span><span class="s">version</span><span class="p">&quot;,</span><span class="w"> </span><span class="nv">build_version</span><span class="o">)</span>
</code></pre></div>
<p><strong>9. SLA 可用性</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 过去 30 天的可用性百分比</span>
<span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">{</span><span class="nl">status</span><span class="o">=~</span><span class="p">&quot;</span><span class="s">2..|3..</span><span class="p">&quot;}[</span><span class="s">30d</span><span class="p">]</span><span class="o">))</span>
<span class="o">/</span>
<span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">30d</span><span class="p">]</span><span class="o">))</span>
<span class="o">*</span><span class="w"> </span><span class="mi">100</span>
</code></pre></div>
<p><strong>10. 告警相关查询</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检测服务宕机</span>
<span class="nv">up</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">critical-service</span><span class="p">&quot;}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>

<span class="c1"># 检测指标缺失</span>
<span class="kr">absent</span><span class="o">(</span><span class="nv">up</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">critical-service</span><span class="p">&quot;}</span><span class="o">)</span>

<span class="c1"># 高错误率</span>
<span class="o">(</span><span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">{</span><span class="nl">status</span><span class="o">=~</span><span class="p">&quot;</span><span class="s">5..</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_requests_total</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.05</span>

<span class="c1"># CPU 持续高负载</span>
<span class="k">avg</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">node_cpu_seconds_total</span><span class="p">{</span><span class="nl">mode</span><span class="o">!=</span><span class="p">&quot;</span><span class="s">idle</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.8</span>
</code></pre></div>
<hr />
<h2 id="promql_1">PromQL 最佳实践<a class="headerlink" href="#promql_1" title="Permanent link">&para;</a></h2>
<p><strong>1. 性能优化</strong></p>
<ul>
<li>✅ 使用记录规则预计算复杂查询</li>
<li>✅ 先聚合后查询,减少时间序列数量</li>
<li>✅ 避免高基数标签</li>
<li>✅ 使用合适的时间范围</li>
</ul>
<p><strong>2. 准确性</strong></p>
<ul>
<li>✅ Counter 使用 <code>rate()</code> 或 <code>increase()</code></li>
<li>✅ Gauge 使用 <code>delta()</code> 或直接查询</li>
<li>✅ 计算速率时先 <code>rate()</code> 再聚合</li>
<li>✅ 注意操作符优先级,必要时使用括号</li>
</ul>
<p><strong>3. 可读性</strong></p>
<ul>
<li>✅ 使用有意义的记录规则名称</li>
<li>✅ 添加注释说明查询目的</li>
<li>✅ 将复杂查询分解为多个步骤</li>
<li>✅ 保持一致的格式和缩进</li>
</ul>
<p><strong>4. 告警查询</strong></p>
<ul>
<li>✅ 使用 <code>rate()</code> 而非 <code>irate()</code> (更稳定)</li>
<li>✅ 设置合适的 <code>for</code> 持续时间避免抖动</li>
<li>✅ 使用 <code>absent()</code> 检测缺失指标</li>
<li>✅ 考虑使用布尔运算符提高可读性</li>
</ul>
<hr />
<h3 id="45-api-http-api">4.5 API (HTTP API)<a class="headerlink" href="#45-api-http-api" title="Permanent link">&para;</a></h3>
<p>Prometheus 提供了完整的 HTTP API 用于查询数据和管理服务器。当前稳定版本API位于 <code>/api/v1</code> 端点。</p>
<h4 id="api">API 响应格式<a class="headerlink" href="#api" title="Permanent link">&para;</a></h4>
<p>所有 API 返回 JSON 格式:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">&lt;...&gt;</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// 错误时包含</span>
<span class="w">  </span><span class="nt">&quot;errorType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// 警告信息(可选)</span>
<span class="w">  </span><span class="nt">&quot;warnings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;infos&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>HTTP 状态码:</strong></p>
<ul>
<li><code>200</code> - 成功</li>
<li><code>400</code> - 参数错误</li>
<li><code>422</code> - 表达式无法执行</li>
<li><code>503</code> - 查询超时或中止</li>
</ul>
<hr />
<h4 id="1-api">1. 表达式查询 API<a class="headerlink" href="#1-api" title="Permanent link">&para;</a></h4>
<p><strong>即时查询 (Instant Query)</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># GET 请求</span>
GET<span class="w"> </span>/api/v1/query

<span class="c1"># 参数</span>
<span class="nv">query</span><span class="o">=</span>&lt;string&gt;<span class="w">        </span><span class="c1"># PromQL 表达式</span>
<span class="nv">time</span><span class="o">=</span>&lt;timestamp&gt;<span class="w">      </span><span class="c1"># 评估时间戳(可选,默认当前时间)</span>
<span class="nv">timeout</span><span class="o">=</span>&lt;duration&gt;<span class="w">    </span><span class="c1"># 超时时间(可选)</span>
<span class="nv">limit</span><span class="o">=</span>&lt;number&gt;<span class="w">        </span><span class="c1"># 返回序列数量限制(可选)</span>
</code></pre></div>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询 up 指标在特定时间点的值</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=up&amp;time=2015-07-01T20:10:51.781Z&#39;</span>

<span class="c1"># 查询所有实例的 CPU 使用率</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=rate(node_cpu_seconds_total[5m])&#39;</span>
</code></pre></div>
<p><strong>响应示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;resultType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vector&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;metric&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;__name__&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;up&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;job&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prometheus&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;instance&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;localhost:9090&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1435781451.781</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<p><strong>范围查询 (Range Query)</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/query_range

<span class="c1"># 参数</span>
<span class="nv">query</span><span class="o">=</span>&lt;string&gt;<span class="w">    </span><span class="c1"># PromQL 表达式</span>
<span class="nv">start</span><span class="o">=</span>&lt;timestamp&gt;<span class="w"> </span><span class="c1"># 开始时间</span>
<span class="nv">end</span><span class="o">=</span>&lt;timestamp&gt;<span class="w">   </span><span class="c1"># 结束时间</span>
<span class="nv">step</span><span class="o">=</span>&lt;duration&gt;<span class="w">   </span><span class="c1"># 查询步长</span>
<span class="nv">timeout</span><span class="o">=</span>&lt;duration&gt;#<span class="w"> </span>超时<span class="o">(</span>可选<span class="o">)</span>
<span class="nv">limit</span><span class="o">=</span>&lt;number&gt;<span class="w">    </span><span class="c1"># 序列数量限制(可选)</span>
</code></pre></div>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询过去 30 秒的 up 指标,步长 15s</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query_range?query=up&amp;start=2015-07-01T20:10:30.781Z&amp;end=2015-07-01T20:11:00.781Z&amp;step=15s&#39;</span>
</code></pre></div>
<hr />
<h4 id="2-api">2. 元数据查询 API<a class="headerlink" href="#2-api" title="Permanent link">&para;</a></h4>
<p><strong>查询时间序列 (Series)</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/series

<span class="c1"># 参数</span>
match<span class="o">[]=</span>&lt;selector&gt;<span class="w">  </span><span class="c1"># 序列选择器(必需,可重复)</span>
<span class="nv">start</span><span class="o">=</span>&lt;timestamp&gt;<span class="w">   </span><span class="c1"># 开始时间(可选)</span>
<span class="nv">end</span><span class="o">=</span>&lt;timestamp&gt;<span class="w">     </span><span class="c1"># 结束时间(可选)</span>
<span class="nv">limit</span><span class="o">=</span>&lt;number&gt;<span class="w">      </span><span class="c1"># 返回数量限制(可选)</span>
</code></pre></div>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询匹配的时间序列</span>
curl<span class="w"> </span>-g<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/series?match[]=up&amp;match[]=process_start_time_seconds{job=&quot;prometheus&quot;}&#39;</span>
</code></pre></div>
<hr />
<p><strong>查询标签名称</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/labels

<span class="c1"># 参数</span>
<span class="nv">start</span><span class="o">=</span>&lt;timestamp&gt;<span class="w">     </span><span class="c1"># 开始时间(可选)</span>
<span class="nv">end</span><span class="o">=</span>&lt;timestamp&gt;<span class="w">       </span><span class="c1"># 结束时间(可选)</span>
match<span class="o">[]=</span>&lt;selector&gt;<span class="w">    </span><span class="c1"># 过滤选择器(可选)</span>
<span class="nv">limit</span><span class="o">=</span>&lt;number&gt;<span class="w">        </span><span class="c1"># 返回数量限制(可选)</span>
</code></pre></div>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/labels&#39;</span>
</code></pre></div>
<p><strong>响应:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;__name__&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;instance&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;job&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;method&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;status&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<p><strong>查询标签值</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/label/&lt;label_name&gt;/values

<span class="c1"># 示例</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/label/job/values&#39;</span>
</code></pre></div>
<hr />
<h4 id="3">3. 目标和规则查询<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<p><strong>查询抓取目标</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/targets

<span class="c1"># 参数</span>
<span class="nv">state</span><span class="o">=</span>&lt;active<span class="p">|</span>dropped<span class="p">|</span>any&gt;<span class="w">  </span><span class="c1"># 过滤目标状态(可选)</span>
<span class="nv">scrapePool</span><span class="o">=</span>&lt;name&gt;<span class="w">            </span><span class="c1"># 过滤抓取池(可选)</span>
</code></pre></div>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/targets?state=active&#39;</span>
</code></pre></div>
<hr />
<p><strong>查询规则</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/rules

<span class="c1"># 参数</span>
<span class="nv">type</span><span class="o">=</span>&lt;alert<span class="p">|</span>record&gt;<span class="w">       </span><span class="c1"># 过滤规则类型(可选)</span>
rule_name<span class="o">[]=</span>&lt;name&gt;<span class="w">        </span><span class="c1"># 过滤规则名称(可选)</span>
rule_group<span class="o">[]=</span>&lt;name&gt;<span class="w">       </span><span class="c1"># 过滤规则组(可选)</span>
file<span class="o">[]=</span>&lt;path&gt;<span class="w">             </span><span class="c1"># 过滤文件路径(可选)</span>
<span class="nv">exclude_alerts</span><span class="o">=</span>&lt;bool&gt;<span class="w">     </span><span class="c1"># 排除告警(可选)</span>
</code></pre></div>
<hr />
<p><strong>查询告警</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/alerts

<span class="c1"># 返回所有活跃告警</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/alerts&#39;</span>
</code></pre></div>
<hr />
<h4 id="4-api">4. 状态和配置 API<a class="headerlink" href="#4-api" title="Permanent link">&para;</a></h4>
<p><strong>查询配置</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/status/config

<span class="c1"># 返回当前加载的配置文件(YAML格式)</span>
</code></pre></div>
<p><strong>查询启动标志</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/status/flags

<span class="c1"># 返回 Prometheus 启动参数</span>
</code></pre></div>
<p><strong>查询运行时信息</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/status/runtimeinfo

<span class="c1"># 返回运行时信息(启动时间、时间序列数量、内存等)</span>
</code></pre></div>
<p><strong>查询构建信息</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/status/buildinfo

<span class="c1"># 返回版本、Git 版本号、Go 版本等</span>
</code></pre></div>
<p><strong>查询 TSDB 统计</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/status/tsdb

<span class="c1"># 参数</span>
<span class="nv">limit</span><span class="o">=</span>&lt;number&gt;<span class="w">  </span><span class="c1"># 限制返回项数(默认10)</span>

<span class="c1"># 返回时间序列数据库的基数统计</span>
</code></pre></div>
<hr />
<h4 id="5-api-webenable-admin-api">5. 管理 API (需启用 --web.enable-admin-api)<a class="headerlink" href="#5-api-webenable-admin-api" title="Permanent link">&para;</a></h4>
<p><strong>创建快照</strong></p>
<div class="highlight"><pre><span></span><code>POST<span class="w"> </span>/api/v1/admin/tsdb/snapshot

<span class="c1"># 参数</span>
<span class="nv">skip_head</span><span class="o">=</span>&lt;bool&gt;<span class="w">  </span><span class="c1"># 跳过 head block(可选)</span>
</code></pre></div>
<p><strong>删除序列数据</strong></p>
<div class="highlight"><pre><span></span><code>POST<span class="w"> </span>/api/v1/admin/tsdb/delete_series

<span class="c1"># 参数</span>
match<span class="o">[]=</span>&lt;selector&gt;<span class="w">  </span><span class="c1"># 序列选择器(必需,可重复)</span>
<span class="nv">start</span><span class="o">=</span>&lt;timestamp&gt;<span class="w">   </span><span class="c1"># 开始时间(可选)</span>
<span class="nv">end</span><span class="o">=</span>&lt;timestamp&gt;<span class="w">     </span><span class="c1"># 结束时间(可选)</span>
</code></pre></div>
<p><strong>清理墓碑</strong></p>
<div class="highlight"><pre><span></span><code>POST<span class="w"> </span>/api/v1/admin/tsdb/clean_tombstones

<span class="c1"># 清理已删除的数据,释放磁盘空间</span>
</code></pre></div>
<hr />
<h4 id="6-api">6. 实用工具 API<a class="headerlink" href="#6-api" title="Permanent link">&para;</a></h4>
<p><strong>格式化查询</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/format_query

<span class="c1"># 参数</span>
<span class="nv">query</span><span class="o">=</span>&lt;string&gt;<span class="w">  </span><span class="c1"># PromQL 表达式</span>

<span class="c1"># 返回格式化后的查询字符串</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/format_query?query=foo/bar&#39;</span>
</code></pre></div>
<p><strong>解析查询为 AST</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w"> </span>/api/v1/parse_query

<span class="c1"># 参数</span>
<span class="nv">query</span><span class="o">=</span>&lt;string&gt;<span class="w">  </span><span class="c1"># PromQL 表达式</span>

<span class="c1"># 返回查询的抽象语法树(JSON格式)</span>
</code></pre></div>
<hr />
<h4 id="7-api">7. 常用 API 调用示例<a class="headerlink" href="#7-api" title="Permanent link">&para;</a></h4>
<p><strong>1. 查询当前 CPU 使用率</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-g<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-urlencode<span class="w"> </span><span class="s1">&#39;query=100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=&quot;idle&quot;}[5m])) * 100)&#39;</span>
</code></pre></div>
<p><strong>2. 查询过去 1 小时的请求速率</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-g<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query_range&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-urlencode<span class="w"> </span><span class="s1">&#39;query=rate(http_requests_total[5m])&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;start=</span><span class="k">$(</span>date<span class="w"> </span>-u<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;1 hour ago&#39;</span><span class="w"> </span>+%s<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-urlencode<span class="w"> </span><span class="s2">&quot;end=</span><span class="k">$(</span>date<span class="w"> </span>-u<span class="w"> </span>+%s<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-urlencode<span class="w"> </span><span class="s1">&#39;step=60s&#39;</span>
</code></pre></div>
<p><strong>3. 查询特定 job 的所有标签</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-g<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/series?match[]=up{job=&quot;prometheus&quot;}&#39;</span>
</code></pre></div>
<p><strong>4. 查询所有 job 的标签值</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/label/job/values&#39;</span>
</code></pre></div>
<p><strong>5. 查询当前活跃的抓取目标</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/targets?state=active&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.data.activeTargets[] | {instance: .labels.instance, health: .health}&#39;</span>
</code></pre></div>
<p><strong>6. 查询所有 firing 状态的告警</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/alerts&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.data.alerts[] | select(.state==&quot;firing&quot;)&#39;</span>
</code></pre></div>
<p><strong>7. 获取 Prometheus 版本信息</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/status/buildinfo&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.data.version&#39;</span>
</code></pre></div>
<p><strong>8. 查询 TSDB 中的时间序列数量</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/status/runtimeinfo&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.data.timeSeriesCount&#39;</span>
</code></pre></div>
<hr />
<h4 id="8-api">8. API 使用最佳实践<a class="headerlink" href="#8-api" title="Permanent link">&para;</a></h4>
<p><strong>1. 使用 POST 方式发送复杂查询</strong></p>
<p>对于长查询字符串,使用 POST 避免 URL 长度限制:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-urlencode<span class="w"> </span><span class="s1">&#39;query=sum by (job) (rate(http_requests_total{status=~&quot;5..&quot;,path=~&quot;/api/.*&quot;}[5m]))&#39;</span>
</code></pre></div>
<p><strong>2. 合理设置超时</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=complex_query&amp;timeout=30s&#39;</span>
</code></pre></div>
<p><strong>3. 使用 limit 限制返回数据量</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=up&amp;limit=100&#39;</span>
</code></pre></div>
<p><strong>4. URL 编码参数</strong></p>
<p>使用 <code>--data-urlencode</code> 或手动编码:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用 --data-urlencode</span>
curl<span class="w"> </span>-G<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-urlencode<span class="w"> </span><span class="s1">&#39;query=http_requests_total{method=&quot;GET&quot;}&#39;</span>

<span class="c1"># 手动编码</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=http_requests_total%7Bmethod%3D%22GET%22%7D&#39;</span>
</code></pre></div>
<p><strong>5. 处理 JSON 响应</strong></p>
<p>使用 <code>jq</code> 处理 JSON:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 提取数据部分</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=up&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.data&#39;</span>

<span class="c1"># 提取所有指标值</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=up&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.data.result[].value[1]&#39;</span>

<span class="c1"># 检查状态</span>
curl<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=up&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.status&#39;</span>
</code></pre></div>
<p><strong>6. 错误处理</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">response</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-s<span class="w"> </span><span class="s1">&#39;http://localhost:9090/api/v1/query?query=invalid_query&#39;</span><span class="k">)</span>
<span class="nv">status</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$response</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.status&#39;</span><span class="k">)</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$status</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;error&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Error: </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$response</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.error&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Type: </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$response</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.errorType&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="k">fi</span>
</code></pre></div>
<hr />
<h4 id="9">9. 编程语言客户端示例<a class="headerlink" href="#9" title="Permanent link">&para;</a></h4>
<p><strong>Python 示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="c1"># 基础配置</span>
<span class="n">PROMETHEUS_URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:9090&quot;</span>

<span class="c1"># 即时查询</span>
<span class="k">def</span> <span class="nf">instant_query</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PROMETHEUS_URL</span><span class="si">}</span><span class="s2">/api/v1/query&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="c1"># 范围查询</span>
<span class="k">def</span> <span class="nf">range_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="s2">&quot;15s&quot;</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PROMETHEUS_URL</span><span class="si">}</span><span class="s2">/api/v1/query_range&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
        <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
        <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
        <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="c1"># 使用示例</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># 查询当前 CPU 使用率</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">instant_query</span><span class="p">(</span><span class="s1">&#39;rate(node_cpu_seconds_total[5m])&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># 查询过去 1 小时的数据</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">range_query</span><span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;60s&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>
<p><strong>Go 示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;context&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/prometheus/client_golang/api&quot;</span>
<span class="w">    </span><span class="nx">v1</span><span class="w"> </span><span class="s">&quot;github.com/prometheus/client_golang/api/prometheus/v1&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">api</span><span class="p">.</span><span class="nx">NewClient</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://localhost:9090&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">v1api</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v1</span><span class="p">.</span><span class="nx">NewAPI</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 即时查询</span>
<span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">warnings</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v1api</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;up&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">())</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">warnings</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Warnings: %v\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">warnings</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Result: %v\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 范围查询</span>
<span class="w">    </span><span class="nx">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v1</span><span class="p">.</span><span class="nx">Range</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Start</span><span class="p">:</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="o">-</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">),</span>
<span class="w">        </span><span class="nx">End</span><span class="p">:</span><span class="w">   </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">Step</span><span class="p">:</span><span class="w">  </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">warnings</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v1api</span><span class="p">.</span><span class="nx">QueryRange</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;rate(http_requests_total[5m])&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Result: %v\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="api_1">API 快速参考<a class="headerlink" href="#api_1" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>API 端点</th>
<th>方法</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/api/v1/query</code></td>
<td>GET/POST</td>
<td>即时查询</td>
</tr>
<tr>
<td><code>/api/v1/query_range</code></td>
<td>GET/POST</td>
<td>范围查询</td>
</tr>
<tr>
<td><code>/api/v1/series</code></td>
<td>GET/POST</td>
<td>查询时间序列</td>
</tr>
<tr>
<td><code>/api/v1/labels</code></td>
<td>GET/POST</td>
<td>查询标签名称</td>
</tr>
<tr>
<td><code>/api/v1/label/&lt;name&gt;/values</code></td>
<td>GET</td>
<td>查询标签值</td>
</tr>
<tr>
<td><code>/api/v1/targets</code></td>
<td>GET</td>
<td>查询抓取目标</td>
</tr>
<tr>
<td><code>/api/v1/rules</code></td>
<td>GET</td>
<td>查询规则</td>
</tr>
<tr>
<td><code>/api/v1/alerts</code></td>
<td>GET</td>
<td>查询告警</td>
</tr>
<tr>
<td><code>/api/v1/status/config</code></td>
<td>GET</td>
<td>查询配置</td>
</tr>
<tr>
<td><code>/api/v1/status/flags</code></td>
<td>GET</td>
<td>查询标志</td>
</tr>
<tr>
<td><code>/api/v1/status/runtimeinfo</code></td>
<td>GET</td>
<td>查询运行时信息</td>
</tr>
<tr>
<td><code>/api/v1/status/buildinfo</code></td>
<td>GET</td>
<td>查询构建信息</td>
</tr>
<tr>
<td><code>/api/v1/status/tsdb</code></td>
<td>GET</td>
<td>查询 TSDB 统计</td>
</tr>
<tr>
<td><code>/api/v1/admin/tsdb/snapshot</code></td>
<td>POST</td>
<td>创建快照</td>
</tr>
<tr>
<td><code>/api/v1/admin/tsdb/delete_series</code></td>
<td>POST</td>
<td>删除序列</td>
</tr>
<tr>
<td><code>/api/v1/admin/tsdb/clean_tombstones</code></td>
<td>POST</td>
<td>清理墓碑</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5-storage">5. Storage (存储)<a class="headerlink" href="#5-storage" title="Permanent link">&para;</a></h2>
<p>Prometheus 包含本地磁盘时间序列数据库,同时可选地与远程存储系统集成。</p>
<h3 id="51">5.1 本地存储<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<h4 id="_52">磁盘布局<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h4>
<p><strong>Block 结构:</strong></p>
<ul>
<li>采样数据按 <strong>2 小时</strong> 分组为 block</li>
<li>每个 block 包含:</li>
<li><code>chunks/</code> - 时间序列样本数据(最多 512MB/文件)</li>
<li><code>index</code> - 索引文件(指标名称和标签到时间序列的映射)</li>
<li><code>meta.json</code> - 元数据文件</li>
<li><code>tombstones</code> - 删除记录</li>
</ul>
<p><strong>目录结构示例:</strong></p>
<div class="highlight"><pre><span></span><code>./data
├── 01BKGV7JBM69T2G1BGBGM6KB12/    # 2小时 block
│   ├── chunks/
│   │   └── 000001
│   ├── index
│   ├── tombstones
│   └── meta.json
├── chunks_head/                    # Head block (内存中)
│   └── 000001
└── wal/                            # 写前日志
    ├── 000000002
    └── checkpoint.00000001/
        └── 00000000
</code></pre></div>
<hr />
<h4 id="wal-write-ahead-log">WAL (Write-Ahead Log)<a class="headerlink" href="#wal-write-ahead-log" title="Permanent link">&para;</a></h4>
<p><strong>特性:</strong></p>
<ul>
<li>保护内存中的当前 block 防止崩溃丢失</li>
<li>文件大小: 128MB/段</li>
<li>最少保留: 3 个 WAL 文件</li>
<li>高流量服务器可能保留更多(至少 2 小时原始数据)</li>
</ul>
<p><strong>启用 WAL 压缩:</strong></p>
<div class="highlight"><pre><span></span><code>--storage.tsdb.wal-compression
<span class="c1"># 可将 WAL 大小减半,CPU 开销很小</span>
<span class="c1"># v2.11.0 引入,v2.20.0 默认启用</span>
</code></pre></div>
<hr />
<h4 id="compaction">压缩 (Compaction)<a class="headerlink" href="#compaction" title="Permanent link">&para;</a></h4>
<ul>
<li>初始 2 小时 blocks 会在后台压缩成更大的 blocks</li>
<li>最大 block 大小: <strong>保留时间的 10%</strong> 或 <strong>31 天</strong>(取较小值)</li>
</ul>
<hr />
<h4 id="_53">存储配置参数<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--storage.tsdb.path</code></td>
<td>数据库目录路径</td>
<td><code>data/</code></td>
</tr>
<tr>
<td><code>--storage.tsdb.retention.time</code></td>
<td>样本保留时间</td>
<td><code>15d</code></td>
</tr>
<tr>
<td><code>--storage.tsdb.retention.size</code></td>
<td>最大存储字节数</td>
<td><code>0</code>(禁用)</td>
</tr>
<tr>
<td><code>--storage.tsdb.wal-compression</code></td>
<td>启用 WAL 压缩</td>
<td><code>true</code>(v2.20+)</td>
</tr>
</tbody>
</table>
<p><strong>支持的时间单位:</strong> <code>y</code>, <code>w</code>, <code>d</code>, <code>h</code>, <code>m</code>, <code>s</code>, <code>ms</code></p>
<p><strong>支持的存储单位:</strong> <code>B</code>, <code>KB</code>, <code>MB</code>, <code>GB</code>, <code>TB</code>, <code>PB</code>, <code>EB</code></p>
<hr />
<h4 id="_54">容量规划<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h4>
<p><strong>估算公式:</strong></p>
<div class="highlight"><pre><span></span><code>所需磁盘空间 = 保留时间(秒) × 每秒采样数 × 每样本字节数
</code></pre></div>
<p><strong>每样本平均大小:</strong> 1-2 bytes</p>
<p><strong>示例计算:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 假设: 10万时间序列,15秒抓取间隔,保留15天</span>
<span class="nv">采样率</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>,000<span class="w"> </span>/<span class="w"> </span><span class="nv">15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>,666<span class="w"> </span>samples/s
<span class="nv">所需空间</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>15天<span class="w"> </span>*<span class="w"> </span>86400秒<span class="w"> </span>*<span class="w"> </span><span class="m">6</span>,666<span class="w"> </span>*<span class="w"> </span><span class="m">2</span><span class="w"> </span>bytes<span class="w"> </span>
<span class="w">         </span>≈<span class="w"> </span><span class="m">17</span>.3<span class="w"> </span>GB
</code></pre></div>
<p><strong>降低采样率的方法:</strong></p>
<ol>
<li>减少时间序列数量(更少的目标或每个目标更少的序列)</li>
<li>增加抓取间隔</li>
<li>使用记录规则预聚合</li>
</ol>
<hr />
<h4 id="_55">保留策略<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h4>
<p><strong>时间保留:</strong></p>
<div class="highlight"><pre><span></span><code>--storage.tsdb.retention.time<span class="o">=</span>30d
</code></pre></div>
<p><strong>大小保留:</strong></p>
<div class="highlight"><pre><span></span><code>--storage.tsdb.retention.size<span class="o">=</span>50GB
</code></pre></div>
<p><strong>建议:</strong></p>
<ul>
<li>如果同时设置时间和大小保留,<strong>首先触发的生效</strong></li>
<li>大小保留建议设置为磁盘空间的 <strong>80-85%</strong></li>
<li>过期 block 清理在后台进行,最多可能需要 <strong>2 小时</strong></li>
</ul>
<hr />
<h4 id="_56">数据完整性<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h4>
<p><strong>文件系统要求:</strong></p>
<ul>
<li>✅ 必须使用 <strong>POSIX 兼容</strong>的文件系统</li>
<li>❌ <strong>不支持 NFS</strong>(包括 AWS EFS)</li>
<li>✅ 强烈推荐使用 <strong>本地文件系统</strong></li>
</ul>
<p><strong>备份建议:</strong></p>
<ul>
<li>使用快照 API 进行备份</li>
<li>非快照备份可能丢失最后 2 小时的数据(上次 WAL 同步以来)</li>
</ul>
<p><strong>数据恢复:</strong></p>
<p>如果本地存储损坏:</p>
<ol>
<li>备份存储目录</li>
<li>从备份恢复损坏的 block 目录</li>
<li>最后手段: 删除损坏的文件/WAL</li>
</ol>
<hr />
<h3 id="52">5.2 远程存储集成<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<p>Prometheus 通过以下方式与远程存储系统集成:</p>
<h4 id="_57">四种集成方式<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    A[Prometheus 服务器] --&gt;|Remote Write| B[远程存储]
    C[其他客户端] --&gt;|Remote Write| A
    B --&gt;|Remote Read| A
    A --&gt;|Remote Read| D[查询客户端]
</code></pre></div>
<ol>
<li><strong>Remote Write (写出)</strong>: Prometheus 将采集的样本写入远程 URL</li>
<li><strong>Remote Write Receiver (接收)</strong>: Prometheus 接收其他客户端的样本</li>
<li><strong>Remote Read (读取)</strong>: Prometheus 从远程 URL 读取样本数据</li>
<li><strong>Remote Read Server (提供)</strong>: Prometheus 为客户端提供样本数据</li>
</ol>
<hr />
<h4 id="_58">协议特性<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h4>
<p><strong>编码方式:</strong></p>
<ul>
<li>Snappy 压缩的 Protocol Buffer</li>
<li>通过 HTTP 传输</li>
</ul>
<p><strong>版本:</strong></p>
<ul>
<li>Write 协议: 1.0 (稳定) + 2.0 (实验性)</li>
<li>Read 协议: 尚未稳定</li>
</ul>
<p><strong>配置位置:</strong> <code>prometheus.yml</code> 的 <code>remote_write</code> 和 <code>remote_read</code> 部分</p>
<hr />
<h4 id="remote-write-receiver">Remote Write Receiver<a class="headerlink" href="#remote-write-receiver" title="Permanent link">&para;</a></h4>
<p><strong>启用方式:</strong></p>
<div class="highlight"><pre><span></span><code>prometheus<span class="w"> </span>--web.enable-remote-write-receiver
</code></pre></div>
<p><strong>端点:</strong> <code>/api/v1/write</code></p>
<blockquote>
<p>⚠️ <strong>注意:</strong> 这不是高效的样本采集方式,仅用于特定低流量场景,不适合替代抓取机制</p>
</blockquote>
<hr />
<h4 id="remote-read">Remote Read 限制<a class="headerlink" href="#remote-read" title="Permanent link">&para;</a></h4>
<ul>
<li>Prometheus 仅从远程端获取原始序列数据</li>
<li>所有 PromQL 评估仍在 Prometheus 本地进行</li>
<li>存在可扩展性限制(所有数据需先加载到查询服务器)</li>
<li>完全分布式 PromQL 评估目前不可行</li>
</ul>
<hr />
<h3 id="53-backfilling">5.3 数据回填 (Backfilling)<a class="headerlink" href="#53-backfilling" title="Permanent link">&para;</a></h3>
<h4 id="openmetrics">OpenMetrics 格式回填<a class="headerlink" href="#openmetrics" title="Permanent link">&para;</a></h4>
<p><strong>用途:</strong> 从其他监控系统或时间序列数据库迁移数据</p>
<p><strong>使用方法:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 从 OpenMetrics 格式创建 blocks</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>create-blocks-from<span class="w"> </span>openmetrics<span class="w"> </span>&lt;input_file&gt;<span class="w"> </span><span class="o">[</span>&lt;output_dir&gt;<span class="o">]</span>

<span class="c1"># 移动生成的 blocks 到 Prometheus 数据目录</span>
mv<span class="w"> </span>&lt;output_dir&gt;/*<span class="w"> </span>/path/to/prometheus/data/
</code></pre></div>
<p><strong>注意事项:</strong></p>
<ul>
<li>⚠️ 不要回填最近 3 小时的数据(可能与 head block 重叠)</li>
<li>每个 block 包含 2 小时的数据</li>
<li>需要启用 <code>--storage.tsdb.allow-overlapping-blocks</code> (v2.38 及以下)</li>
<li>回填数据受保留策略约束</li>
</ul>
<p><strong>调整 Block 大小:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用更大的 block 持续时间(适合回填大量历史数据)</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>create-blocks-from<span class="w"> </span>openmetrics<span class="w"> </span>input.txt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-block-duration<span class="o">=</span>7d
</code></pre></div>
<blockquote>
<p>⚠️ <strong>注意:</strong> 大 block 会影响基于时间的保留策略效果</p>
</blockquote>
<hr />
<h4 id="recording-rules">Recording Rules 回填<a class="headerlink" href="#recording-rules" title="Permanent link">&para;</a></h4>
<p><strong>用途:</strong> 为新创建的记录规则生成历史数据</p>
<p><strong>使用方法:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>tsdb<span class="w"> </span>create-blocks-from<span class="w"> </span>rules<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--start<span class="w"> </span><span class="m">1617079873</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--end<span class="w"> </span><span class="m">1617097873</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--url<span class="w"> </span>http://prometheus:9090<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>rules.yaml<span class="w"> </span>rules2.yaml
</code></pre></div>
<p><strong>限制:</strong></p>
<ul>
<li>重复运行会创建重复数据</li>
<li>所有规则都会被评估</li>
<li>同组规则无法看到其他规则的结果</li>
<li>告警会被忽略</li>
</ul>
<hr />
<h2 id="6-federation">6. Federation (联邦)<a class="headerlink" href="#6-federation" title="Permanent link">&para;</a></h2>
<p>Federation 允许一个 Prometheus 服务器从另一个 Prometheus 服务器抓取选定的时间序列。</p>
<h3 id="61">6.1 使用场景<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<p><strong>1. 分层联邦 (Hierarchical Federation)</strong></p>
<p>用于扩展到拥有数十个数据中心和数百万节点的环境。</p>
<div class="highlight"><pre><span></span><code>graph TD
    A[全局 Prometheus&lt;br/&gt;聚合数据] --&gt; B[数据中心1 Prometheus&lt;br/&gt;详细数据]
    A --&gt; C[数据中心2 Prometheus&lt;br/&gt;详细数据]
    A --&gt; D[数据中心3 Prometheus&lt;br/&gt;详细数据]
    B --&gt; E[实例级监控]
    C --&gt; F[实例级监控]
    D --&gt; G[实例级监控]
</code></pre></div>
<p><strong>架构特点:</strong></p>
<ul>
<li>下层服务器: 采集详细数据(实例级)</li>
<li>上层服务器: 采集聚合数据(job级)</li>
<li>提供全局聚合视图 + 本地详细视图</li>
</ul>
<hr />
<p><strong>2. 跨服务联邦 (Cross-Service Federation)</strong></p>
<p>一个服务的 Prometheus 从另一个服务的 Prometheus 抓取数据,实现跨服务查询和告警。</p>
<p><strong>示例场景:</strong></p>
<ul>
<li>集群调度器: 提供资源使用信息(CPU、内存)</li>
<li>服务实例: 提供应用特定指标</li>
<li>通过联邦合并两类指标到一个服务器</li>
</ul>
<hr />
<h3 id="62-federation">6.2 配置 Federation<a class="headerlink" href="#62-federation" title="Permanent link">&para;</a></h3>
<p><strong>Federation 端点:</strong> <code>/federate</code></p>
<p><strong>必需参数:</strong> <code>match[]</code> - 选择要暴露的时间序列</p>
<p><strong>选择器示例:</strong></p>
<ul>
<li><code>up</code></li>
<li><code>{job="api-server"}</code></li>
<li><code>{__name__=~"job:.*"}</code></li>
</ul>
<hr />
<p><strong>完整配置示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;federate&#39;</span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span>

<span class="w">    </span><span class="c1"># 不覆盖源服务器暴露的标签</span>
<span class="w">    </span><span class="nt">honor_labels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">    </span><span class="c1"># Federation 端点</span>
<span class="w">    </span><span class="nt">metrics_path</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/federate&#39;</span>

<span class="w">    </span><span class="c1"># 选择要联邦的指标</span>
<span class="w">    </span><span class="nt">params</span><span class="p">:</span>
<span class="w">      </span><span class="s">&#39;match[]&#39;</span><span class="p p-Indicator">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;{job=&quot;prometheus&quot;}&#39;</span><span class="w">           </span><span class="c1"># 所有 prometheus job 的指标</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;{__name__=~&quot;job:.*&quot;}&#39;</span><span class="w">         </span><span class="c1"># 所有 job: 开头的指标(聚合指标)</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;{__name__=~&quot;instance:.*&quot;}&#39;</span><span class="w">    </span><span class="c1"># 所有 instance: 开头的指标</span>

<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;source-prometheus-1:9090&#39;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;source-prometheus-2:9090&#39;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;source-prometheus-3:9090&#39;</span>
</code></pre></div>
<hr />
<p><strong>关键配置说明:</strong></p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
<th>必需</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>honor_labels: true</code></td>
<td>保留源服务器的标签,不覆盖</td>
<td>✅</td>
</tr>
<tr>
<td><code>metrics_path: '/federate'</code></td>
<td>Federation 端点路径</td>
<td>✅</td>
</tr>
<tr>
<td><code>params.match[]</code></td>
<td>时间序列选择器(可多个)</td>
<td>✅</td>
</tr>
</tbody>
</table>
<hr />
<p><strong>最佳实践:</strong></p>
<p><strong>1. 只联邦必要的指标</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">params</span><span class="p">:</span>
<span class="w">  </span><span class="s">&#39;match[]&#39;</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="c1"># ❌ 不好 - 联邦所有指标</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;{__name__=~&quot;.+&quot;}&#39;</span>

<span class="w">    </span><span class="c1"># ✅ 好 - 只联邦聚合指标</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;{__name__=~&quot;job:.*&quot;}&#39;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;{__name__=~&quot;instance:.*&quot;}&#39;</span>
</code></pre></div>
<p><strong>2. 使用记录规则进行预聚合</strong></p>
<p>下层服务器创建记录规则:</p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">federation_aggregation</span>
<span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 为联邦准备的聚合指标</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job:http_requests_total:rate5m</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum by (job) (rate(http_requests_total[5m]))</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance:node_cpu:avg</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">avg by (instance) (rate(node_cpu_seconds_total[5m]))</span>
</code></pre></div>
<p>上层服务器联邦这些指标:</p>
<div class="highlight"><pre><span></span><code><span class="nt">params</span><span class="p">:</span>
<span class="w">  </span><span class="s">&#39;match[]&#39;</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;{__name__=~&quot;job:.*&quot;}&#39;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;{__name__=~&quot;instance:.*&quot;}&#39;</span>
</code></pre></div>
<p><strong>3. 合理设置抓取间隔</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span><span class="w">  </span><span class="c1"># Federation 可以使用较长间隔</span>
</code></pre></div>
<hr />
<p><strong>原生直方图支持:</strong></p>
<p>要通过 federation 抓取原生直方图,需要:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在抓取服务器启用原生直方图</span>
prometheus<span class="w"> </span>--enable-feature<span class="o">=</span>native-histograms
</code></pre></div>
<blockquote>
<p>⚠️ <strong>注意:</strong> 如果联邦指标包含混合样本类型(float64、counter histogram、gauge histogram),会违反 protobuf 格式规则,但 Prometheus 仍能正确采集</p>
</blockquote>
<hr />
<h2 id="7-management-api-api">7. Management API (管理 API)<a class="headerlink" href="#7-management-api-api" title="Permanent link">&para;</a></h2>
<p>Prometheus 提供了一组管理 API 用于自动化和集成。</p>
<h3 id="71-api">7.1 健康检查 API<a class="headerlink" href="#71-api" title="Permanent link">&para;</a></h3>
<p><strong>健康检查 (Health Check)</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w">  </span>/-/healthy
HEAD<span class="w"> </span>/-/healthy
</code></pre></div>
<p><strong>用途:</strong> 检查 Prometheus 是否正在运行</p>
<p><strong>返回:</strong> 始终返回 <code>200</code></p>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>http://localhost:9090/-/healthy
<span class="c1"># 返回 &quot;Prometheus Server is Healthy.&quot;</span>

<span class="c1"># 或仅检查状态码</span>
curl<span class="w"> </span>-I<span class="w"> </span>http://localhost:9090/-/healthy
</code></pre></div>
<hr />
<p><strong>就绪检查 (Readiness Check)</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w">  </span>/-/ready
HEAD<span class="w"> </span>/-/ready
</code></pre></div>
<p><strong>用途:</strong> 检查 Prometheus 是否准备好处理查询</p>
<p><strong>返回:</strong> 准备好时返回 <code>200</code>,否则返回 <code>503</code></p>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查就绪状态</span>
curl<span class="w"> </span>-s<span class="w"> </span>http://localhost:9090/-/ready

<span class="c1"># Kubernetes 就绪探针配置</span>
readinessProbe:
<span class="w">  </span>httpGet:
<span class="w">    </span>path:<span class="w"> </span>/-/ready
<span class="w">    </span>port:<span class="w"> </span><span class="m">9090</span>
<span class="w">  </span>initialDelaySeconds:<span class="w"> </span><span class="m">30</span>
<span class="w">  </span>periodSeconds:<span class="w"> </span><span class="m">5</span>
</code></pre></div>
<p><strong>区别:</strong></p>
<ul>
<li><code>/-/healthy</code>: 服务进程是否存活</li>
<li><code>/-/ready</code>: 服务是否准备好处理流量(WAL 重放完成等)</li>
</ul>
<hr />
<h3 id="72-api">7.2 配置管理 API<a class="headerlink" href="#72-api" title="Permanent link">&para;</a></h3>
<p><strong>重新加载配置</strong></p>
<div class="highlight"><pre><span></span><code>POST<span class="w"> </span>/-/reload
PUT<span class="w">  </span>/-/reload
</code></pre></div>
<p><strong>用途:</strong> 触发配置和规则文件重新加载</p>
<p><strong>前提:</strong> 需启用 <code>--web.enable-lifecycle</code> 标志</p>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 重新加载配置</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9090/-/reload

<span class="c1"># 或使用 PUT</span>
curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>http://localhost:9090/-/reload
</code></pre></div>
<p><strong>替代方法 - 发送 SIGHUP 信号:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查找 Prometheus 进程 ID</span>
ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>prometheus

<span class="c1"># 发送 SIGHUP 信号</span>
<span class="nb">kill</span><span class="w"> </span>-HUP<span class="w"> </span>&lt;PID&gt;
</code></pre></div>
<hr />
<p><strong>优雅关闭</strong></p>
<div class="highlight"><pre><span></span><code>POST<span class="w"> </span>/-/quit
PUT<span class="w">  </span>/-/quit
</code></pre></div>
<p><strong>用途:</strong> 触发 Prometheus 优雅关闭</p>
<p><strong>前提:</strong> 需启用 <code>--web.enable-lifecycle</code> 标志</p>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 优雅关闭 Prometheus</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9090/-/quit
</code></pre></div>
<p><strong>替代方法 - 发送 SIGTERM 信号:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 优雅关闭</span>
<span class="nb">kill</span><span class="w"> </span>-TERM<span class="w"> </span>&lt;PID&gt;

<span class="c1"># 或使用 systemd</span>
systemctl<span class="w"> </span>stop<span class="w"> </span>prometheus
</code></pre></div>
<hr />
<h3 id="73">7.3 使用场景<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<p><strong>1. Kubernetes 健康和就绪探针</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prometheus</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prometheus</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prom/prometheus:latest</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9090</span>

<span class="w">    </span><span class="c1"># 存活探针</span>
<span class="w">    </span><span class="nt">livenessProbe</span><span class="p">:</span>
<span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/-/healthy</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9090</span>
<span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">      </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">      </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">      </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>

<span class="w">    </span><span class="c1"># 就绪探针</span>
<span class="w">    </span><span class="nt">readinessProbe</span><span class="p">:</span>
<span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/-/ready</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9090</span>
<span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">      </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">      </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">      </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</code></pre></div>
<hr />
<p><strong>2. 自动配置更新脚本</strong></p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># 更新 Prometheus 配置文件</span>
cp<span class="w"> </span>/path/to/new/prometheus.yml<span class="w"> </span>/etc/prometheus/prometheus.yml

<span class="c1"># 验证配置</span>
<span class="k">if</span><span class="w"> </span>promtool<span class="w"> </span>check<span class="w"> </span>config<span class="w"> </span>/etc/prometheus/prometheus.yml<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Config valid, reloading...&quot;</span>

<span class="w">  </span><span class="c1"># 重新加载配置</span>
<span class="w">  </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9090/-/reload

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Successfully reloaded configuration&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Failed to reload configuration&quot;</span>
<span class="w">    </span><span class="c1"># 恢复旧配置</span>
<span class="w">    </span>cp<span class="w"> </span>/path/to/backup/prometheus.yml<span class="w"> </span>/etc/prometheus/prometheus.yml
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">fi</span>
<span class="k">else</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Invalid config, not reloading&quot;</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>
</code></pre></div>
<hr />
<p><strong>3. 监控脚本</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">PROMETHEUS_URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:9090&quot;</span>

<span class="k">def</span> <span class="nf">check_health</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PROMETHEUS_URL</span><span class="si">}</span><span class="s2">/-/healthy&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">check_ready</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PROMETHEUS_URL</span><span class="si">}</span><span class="s2">/-/ready&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># 持续监控</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">health</span> <span class="o">=</span> <span class="n">check_health</span><span class="p">()</span>
    <span class="n">ready</span> <span class="o">=</span> <span class="n">check_ready</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Health: </span><span class="si">{</span><span class="s1">&#39;✓&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">health</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;✗&#39;</span><span class="si">}</span><span class="s2"> | Ready: </span><span class="si">{</span><span class="s1">&#39;✓&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;✗&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">health</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️  Prometheus is healthy but not ready (possibly replaying WAL)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">health</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔴 Prometheus is not healthy!&quot;</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>
<hr />
<p><strong>4. CI/CD 集成</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># GitLab CI 示例</span>
<span class="nt">deploy</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 部署新配置</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl apply -f prometheus-config.yaml</span>

<span class="w">    </span><span class="c1"># 等待 ConfigMap 更新</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep 5</span>

<span class="w">    </span><span class="c1"># 触发重新加载</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">kubectl exec -n monitoring prometheus-0 -- \</span>
<span class="w">        </span><span class="no">wget --post-data=&quot;&quot; -O- http://localhost:9090/-/reload</span>

<span class="w">    </span><span class="c1"># 验证重新加载成功</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">kubectl exec -n monitoring prometheus-0 -- \</span>
<span class="w">        </span><span class="no">wget -O- http://localhost:9090/-/ready</span>
</code></pre></div>
<hr />
<h2 id="_59">总结<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h2>
<p><strong>Storage (存储):</strong></p>
<ol>
<li>本地存储采用 2 小时 block 结构</li>
<li>WAL 保护内存数据防止崩溃</li>
<li>支持时间和大小两种保留策略</li>
<li>可通过 Remote Write/Read 集成远程存储</li>
<li>支持数据回填用于迁移和规则历史数据生成</li>
</ol>
<p><strong>Federation (联邦):</strong></p>
<ol>
<li>实现 Prometheus 服务器之间的数据共享</li>
<li>支持分层和跨服务两种场景</li>
<li>使用 <code>/federate</code> 端点和 <code>match[]</code> 参数</li>
<li>建议只联邦聚合指标以提高效率</li>
</ol>
<p><strong>Management API (管理API):</strong></p>
<ol>
<li><code>/-/healthy</code> - 健康检查(存活探针)</li>
<li><code>/-/ready</code> - 就绪检查(就绪探针)</li>
<li><code>/-/reload</code> - 重新加载配置</li>
<li><code>/-/quit</code> - 优雅关闭</li>
<li>后两者需启用 <code>--web.enable-lifecycle</code></li>
</ol>
<hr />
<h2 id="8-command-line">8. Command Line (命令行工具)<a class="headerlink" href="#8-command-line" title="Permanent link">&para;</a></h2>
<h3 id="81-prometheus">8.1 Prometheus 命令<a class="headerlink" href="#81-prometheus" title="Permanent link">&para;</a></h3>
<p>Prometheus 监控服务器启动命令。</p>
<h4 id="_60">基本用法<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>prometheus<span class="w"> </span><span class="o">[</span>flags<span class="o">]</span>
</code></pre></div>
<h4 id="_61">核心启动参数<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h4>
<p><strong>配置文件:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 指定配置文件</span>
--config.file<span class="o">=</span>prometheus.yml<span class="w">          </span><span class="c1"># 默认: prometheus.yml</span>

<span class="c1"># 配置自动重载间隔</span>
--config.auto-reload-interval<span class="o">=</span>30s<span class="w">     </span><span class="c1"># 默认: 30s</span>
</code></pre></div>
<p><strong>Web 服务器:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 监听地址(可重复指定)</span>
--web.listen-address<span class="o">=</span><span class="m">0</span>.0.0.0:9090<span class="w">     </span><span class="c1"># 默认: 0.0.0.0:9090</span>

<span class="c1"># 外部访问 URL</span>
--web.external-url<span class="o">=</span>http://prometheus.example.com

<span class="c1"># TLS/认证配置</span>
--web.config.file<span class="o">=</span>/path/to/web-config.yml

<span class="c1"># 页面标题</span>
--web.page-title<span class="o">=</span><span class="s2">&quot;Production Prometheus&quot;</span>

<span class="c1"># CORS 源</span>
--web.cors.origin<span class="o">=</span><span class="s1">&#39;https?://(domain1|domain2).com&#39;</span>
</code></pre></div>
<p><strong>启用功能:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 启用生命周期 API(重载/关闭)</span>
--web.enable-lifecycle

<span class="c1"># 启用管理 API</span>
--web.enable-admin-api

<span class="c1"># 启用 Remote Write 接收器</span>
--web.enable-remote-write-receiver

<span class="c1"># 启用 OTLP 接收器</span>
--web.enable-otlp-receiver
</code></pre></div>
<hr />
<h4 id="_62">存储配置<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h4>
<p><strong>本地存储 (Server 模式):</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 数据目录</span>
--storage.tsdb.path<span class="o">=</span>data/

<span class="c1"># 时间保留</span>
--storage.tsdb.retention.time<span class="o">=</span>15d<span class="w">     </span><span class="c1"># 单位: y,w,d,h,m,s,ms</span>

<span class="c1"># 大小保留</span>
--storage.tsdb.retention.size<span class="o">=</span>50GB<span class="w">    </span><span class="c1"># 单位: B,KB,MB,GB,TB,PB,EB</span>

<span class="c1"># 禁用锁文件</span>
--storage.tsdb.no-lockfile
</code></pre></div>
<p><strong>Agent 模式存储:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Agent 数据目录</span>
--storage.agent.path<span class="o">=</span>data-agent/

<span class="c1"># WAL 压缩</span>
--storage.agent.wal-compression<span class="o">=</span><span class="nb">true</span>

<span class="c1"># 保留时间</span>
--storage.agent.retention.min-time<span class="o">=</span>0h
--storage.agent.retention.max-time<span class="o">=</span>0h
</code></pre></div>
<p><strong>远程存储:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 刷新截止时间</span>
--storage.remote.flush-deadline<span class="o">=</span>1m

<span class="c1"># Remote Read 限制</span>
--storage.remote.read-sample-limit<span class="o">=</span><span class="m">50000000</span>
--storage.remote.read-concurrent-limit<span class="o">=</span><span class="m">10</span>
</code></pre></div>
<hr />
<h4 id="_63">查询配置<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询超时</span>
--query.timeout<span class="o">=</span>2m

<span class="c1"># 最大并发查询数</span>
--query.max-concurrency<span class="o">=</span><span class="m">20</span>

<span class="c1"># 最大样本数</span>
--query.max-samples<span class="o">=</span><span class="m">50000000</span>

<span class="c1"># 回溯时长</span>
--query.lookback-delta<span class="o">=</span>5m
</code></pre></div>
<hr />
<h4 id="_64">规则和告警配置<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h4>
<p><strong>规则评估:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 最大并发规则评估数</span>
--rules.max-concurrent-evals<span class="o">=</span><span class="m">4</span>

<span class="c1"># 告警 for 容错时间</span>
--rules.alert.for-outage-tolerance<span class="o">=</span>1h

<span class="c1"># 告警 for 宽限期</span>
--rules.alert.for-grace-period<span class="o">=</span>10m

<span class="c1"># 告警重发延迟</span>
--rules.alert.resend-delay<span class="o">=</span>1m
</code></pre></div>
<p><strong>Alertmanager:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 通知队列容量</span>
--alertmanager.notification-queue-capacity<span class="o">=</span><span class="m">10000</span>

<span class="c1"># 批量通知大小</span>
--alertmanager.notification-batch-size<span class="o">=</span><span class="m">256</span>

<span class="c1"># 关闭时清空队列</span>
--alertmanager.drain-notification-queue-on-shutdown<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<hr />
<h4 id="_65">特性标志<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>feature1,feature2

<span class="c1"># 可用特性:</span>
<span class="c1"># - exemplar-storage              示例存储</span>
<span class="c1"># - native-histograms             原生直方图</span>
<span class="c1"># - promql-experimental-functions 实验性 PromQL 函数</span>
<span class="c1"># - extra-scrape-metrics          额外抓取指标</span>
<span class="c1"># - memory-snapshot-on-shutdown   关闭时内存快照</span>
<span class="c1"># - auto-gomaxprocs               自动 GOMAXPROCS</span>
<span class="c1"># - otlp-deltatocumulative        OTLP Delta 转累积</span>
</code></pre></div>
<hr />
<h4 id="_66">日志配置<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 日志级别</span>
--log.level<span class="o">=</span>info<span class="w">                </span><span class="c1"># 选项: debug, info, warn, error</span>

<span class="c1"># 日志格式</span>
--log.format<span class="o">=</span>logfmt<span class="w">             </span><span class="c1"># 选项: logfmt, json</span>
</code></pre></div>
<hr />
<h4 id="agent">Agent 模式<a class="headerlink" href="#agent" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 以 Agent 模式运行</span>
--agent

<span class="c1"># Agent 模式特点:</span>
<span class="c1"># - 仅写入 Remote Write,不存储本地数据</span>
<span class="c1"># - 不支持查询</span>
<span class="c1"># - 更轻量级</span>
</code></pre></div>
<hr />
<h4 id="_67">完整启动示例<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h4>
<p><strong>生产环境配置:</strong></p>
<div class="highlight"><pre><span></span><code>prometheus<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config.file<span class="o">=</span>/etc/prometheus/prometheus.yml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--web.listen-address<span class="o">=</span><span class="m">0</span>.0.0.0:9090<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--web.external-url<span class="o">=</span>https://prometheus.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--web.enable-lifecycle<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--web.enable-admin-api<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--storage.tsdb.path<span class="o">=</span>/var/lib/prometheus<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--storage.tsdb.retention.time<span class="o">=</span>30d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--storage.tsdb.retention.size<span class="o">=</span>50GB<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--query.timeout<span class="o">=</span>2m<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--query.max-concurrency<span class="o">=</span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--log.level<span class="o">=</span>info<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--log.format<span class="o">=</span>json
</code></pre></div>
<p><strong>Agent 模式:</strong></p>
<div class="highlight"><pre><span></span><code>prometheus<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--agent<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config.file<span class="o">=</span>/etc/prometheus/agent.yml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--storage.agent.path<span class="o">=</span>/var/lib/prometheus-agent<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--web.listen-address<span class="o">=</span><span class="m">0</span>.0.0.0:9090<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--enable-feature<span class="o">=</span>native-histograms
</code></pre></div>
<hr />
<h3 id="82-promtool">8.2 Promtool 工具<a class="headerlink" href="#82-promtool" title="Permanent link">&para;</a></h3>
<p>Prometheus 监控系统的工具箱,用于验证、测试、查询和调试。</p>
<h4 id="_68">基本用法<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span><span class="o">[</span>flags<span class="o">]</span><span class="w"> </span>&lt;command&gt;<span class="w"> </span><span class="o">[</span>args...<span class="o">]</span>
</code></pre></div>
<h4 id="_69">常用命令列表<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>check</code></td>
<td>检查资源有效性</td>
</tr>
<tr>
<td><code>query</code></td>
<td>对 Prometheus 服务器执行查询</td>
</tr>
<tr>
<td><code>test</code></td>
<td>单元测试</td>
</tr>
<tr>
<td><code>tsdb</code></td>
<td>TSDB 相关命令</td>
</tr>
<tr>
<td><code>debug</code></td>
<td>获取调试信息</td>
</tr>
<tr>
<td><code>push</code></td>
<td>推送数据到 Prometheus</td>
</tr>
<tr>
<td><code>promql</code></td>
<td>PromQL 格式化和编辑(实验性)</td>
</tr>
</tbody>
</table>
<hr />
<h4 id="1-check-">1. Check 命令 - 验证配置<a class="headerlink" href="#1-check-" title="Permanent link">&para;</a></h4>
<p><strong>检查配置文件:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 Prometheus 配置</span>
promtool<span class="w"> </span>check<span class="w"> </span>config<span class="w"> </span>prometheus.yml

<span class="c1"># 只检查语法</span>
promtool<span class="w"> </span>check<span class="w"> </span>config<span class="w"> </span>--syntax-only<span class="w"> </span>prometheus.yml

<span class="c1"># 启用 linting</span>
promtool<span class="w"> </span>check<span class="w"> </span>config<span class="w"> </span>--lint<span class="o">=</span>all<span class="w"> </span>prometheus.yml

<span class="c1"># Agent 模式配置</span>
promtool<span class="w"> </span>check<span class="w"> </span>config<span class="w"> </span>--agent<span class="w"> </span>agent.yml
</code></pre></div>
<p><strong>检查规则文件:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查规则文件</span>
promtool<span class="w"> </span>check<span class="w"> </span>rules<span class="w"> </span>/path/to/rules/*.yml

<span class="c1"># 启用 linting</span>
promtool<span class="w"> </span>check<span class="w"> </span>rules<span class="w"> </span>--lint<span class="o">=</span>all<span class="w"> </span>rules.yml

<span class="c1"># 忽略未知字段</span>
promtool<span class="w"> </span>check<span class="w"> </span>rules<span class="w"> </span>--ignore-unknown-fields<span class="w"> </span>rules.yml
</code></pre></div>
<p><strong>检查 Web 配置:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>check<span class="w"> </span>web-config<span class="w"> </span>web-config.yml
</code></pre></div>
<p><strong>检查服务发现:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 执行服务发现并查看结果</span>
promtool<span class="w"> </span>check<span class="w"> </span>service-discovery<span class="w"> </span>prometheus.yml<span class="w"> </span>job_name

<span class="c1"># 设置超时</span>
promtool<span class="w"> </span>check<span class="w"> </span>service-discovery<span class="w"> </span>--timeout<span class="o">=</span>30s<span class="w"> </span>prometheus.yml<span class="w"> </span>job_name
</code></pre></div>
<p><strong>检查 Prometheus 健康状态:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 健康检查</span>
promtool<span class="w"> </span>check<span class="w"> </span>healthy<span class="w"> </span>--url<span class="o">=</span>http://localhost:9090

<span class="c1"># 就绪检查</span>
promtool<span class="w"> </span>check<span class="w"> </span>ready<span class="w"> </span>--url<span class="o">=</span>http://localhost:9090
</code></pre></div>
<p><strong>检查指标格式:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查指标有效性</span>
cat<span class="w"> </span>metrics.prom<span class="w"> </span><span class="p">|</span><span class="w"> </span>promtool<span class="w"> </span>check<span class="w"> </span>metrics

<span class="c1"># 从远程检查</span>
curl<span class="w"> </span>-s<span class="w"> </span>http://localhost:9090/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>promtool<span class="w"> </span>check<span class="w"> </span>metrics
</code></pre></div>
<hr />
<h4 id="2-query-">2. Query 命令 - 执行查询<a class="headerlink" href="#2-query-" title="Permanent link">&para;</a></h4>
<p><strong>即时查询:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 基本即时查询</span>
promtool<span class="w"> </span>query<span class="w"> </span>instant<span class="w"> </span>http://localhost:9090<span class="w"> </span><span class="s1">&#39;up&#39;</span>

<span class="c1"># 指定时间</span>
promtool<span class="w"> </span>query<span class="w"> </span>instant<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--time<span class="o">=</span><span class="s1">&#39;2024-01-01T12:00:00Z&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>http://localhost:9090<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;rate(http_requests_total[5m])&#39;</span>
</code></pre></div>
<p><strong>范围查询:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>query<span class="w"> </span>range<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--start<span class="o">=</span><span class="s1">&#39;2024-01-01T00:00:00Z&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--end<span class="o">=</span><span class="s1">&#39;2024-01-01T01:00:00Z&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--step<span class="o">=</span>60s<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>http://localhost:9090<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;rate(http_requests_total[5m])&#39;</span>
</code></pre></div>
<p><strong>查询时间序列:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询匹配的序列</span>
promtool<span class="w"> </span>query<span class="w"> </span>series<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--match<span class="o">=</span><span class="s1">&#39;{job=&quot;prometheus&quot;}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--match<span class="o">=</span><span class="s1">&#39;{__name__=~&quot;job:.*&quot;}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--start<span class="o">=</span><span class="s1">&#39;2024-01-01T00:00:00Z&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--end<span class="o">=</span><span class="s1">&#39;2024-01-01T01:00:00Z&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>http://localhost:9090
</code></pre></div>
<p><strong>查询标签值:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询标签值</span>
promtool<span class="w"> </span>query<span class="w"> </span>labels<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--match<span class="o">=</span><span class="s1">&#39;{job=&quot;prometheus&quot;}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>http://localhost:9090<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>job
</code></pre></div>
<p><strong>分析查询:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 分析直方图使用模式</span>
promtool<span class="w"> </span>query<span class="w"> </span>analyze<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--server<span class="o">=</span>http://localhost:9090<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--type<span class="o">=</span>histogram<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--duration<span class="o">=</span>1h<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--match<span class="o">=</span><span class="s1">&#39;{__name__=~&quot;http_request_duration.*&quot;}&#39;</span>
</code></pre></div>
<hr />
<h4 id="3-test-">3. Test 命令 - 单元测试<a class="headerlink" href="#3-test-" title="Permanent link">&para;</a></h4>
<p><strong>测试规则:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 运行规则单元测试</span>
promtool<span class="w"> </span><span class="nb">test</span><span class="w"> </span>rules<span class="w"> </span>test.yml

<span class="c1"># 运行特定测试组</span>
promtool<span class="w"> </span><span class="nb">test</span><span class="w"> </span>rules<span class="w"> </span>--run<span class="o">=</span><span class="s1">&#39;TestGroup.*&#39;</span><span class="w"> </span>test.yml

<span class="c1"># 启用调试</span>
promtool<span class="w"> </span><span class="nb">test</span><span class="w"> </span>rules<span class="w"> </span>--debug<span class="w"> </span>test.yml

<span class="c1"># 显示差异</span>
promtool<span class="w"> </span><span class="nb">test</span><span class="w"> </span>rules<span class="w"> </span>--diff<span class="w"> </span>test.yml

<span class="c1"># 输出 JUnit XML</span>
promtool<span class="w"> </span><span class="nb">test</span><span class="w"> </span>rules<span class="w"> </span>--junit<span class="o">=</span>results.xml<span class="w"> </span>test.yml
</code></pre></div>
<p><strong>测试文件示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># test.yml</span>
<span class="nt">rule_files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rules.yml</span>

<span class="nt">evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>

<span class="nt">tests</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>
<span class="w">    </span><span class="nt">input_series</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">series</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;http_requests_total{job=&quot;api&quot;,instance=&quot;0&quot;}&#39;</span>
<span class="w">        </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;0</span><span class="nv"> </span><span class="s">100</span><span class="nv"> </span><span class="s">200</span><span class="nv"> </span><span class="s">300</span><span class="nv"> </span><span class="s">400&#39;</span>

<span class="w">    </span><span class="nt">alert_rule_test</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">eval_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">alertname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighRequestRate</span>
<span class="w">        </span><span class="nt">exp_alerts</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">exp_labels</span><span class="p">:</span>
<span class="w">              </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">              </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api</span>
<span class="w">            </span><span class="nt">exp_annotations</span><span class="p">:</span>
<span class="w">              </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;High</span><span class="nv"> </span><span class="s">request</span><span class="nv"> </span><span class="s">rate&quot;</span>
</code></pre></div>
<hr />
<h4 id="4-tsdb-">4. TSDB 命令 - 数据库操作<a class="headerlink" href="#4-tsdb-" title="Permanent link">&para;</a></h4>
<p><strong>列出 Blocks:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 列出所有 blocks</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>list<span class="w"> </span>data/

<span class="c1"># 人类可读格式</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>list<span class="w"> </span>-r<span class="w"> </span>data/
</code></pre></div>
<p><strong>分析 TSDB:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 分析数据库</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>analyze<span class="w"> </span>data/

<span class="c1"># 扩展分析</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>analyze<span class="w"> </span>--extended<span class="w"> </span>data/

<span class="c1"># 限制结果数量</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>analyze<span class="w"> </span>--limit<span class="o">=</span><span class="m">50</span><span class="w"> </span>data/

<span class="c1"># 分析特定序列</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>analyze<span class="w"> </span>--match<span class="o">=</span><span class="s1">&#39;{job=&quot;api&quot;}&#39;</span><span class="w"> </span>data/
</code></pre></div>
<p><strong>导出数据:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 导出为 OpenMetrics 格式</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>dump-openmetrics<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--min-time<span class="o">=</span><span class="m">1609459200000</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-time<span class="o">=</span><span class="m">1609545600000</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--match<span class="o">=</span><span class="s1">&#39;{job=&quot;prometheus&quot;}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>data/

<span class="c1"># 导出原始数据</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>dump<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--min-time<span class="o">=</span><span class="m">1609459200000</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-time<span class="o">=</span><span class="m">1609545600000</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>data/
</code></pre></div>
<p><strong>回填数据:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 从 OpenMetrics 文件创建 blocks</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>create-blocks-from<span class="w"> </span>openmetrics<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>input.txt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>data/

<span class="c1"># 为记录规则回填</span>
promtool<span class="w"> </span>tsdb<span class="w"> </span>create-blocks-from<span class="w"> </span>rules<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--start<span class="o">=</span><span class="m">1609459200</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--end<span class="o">=</span><span class="m">1609545600</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--url<span class="o">=</span>http://localhost:9090<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output-dir<span class="o">=</span>data/<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--eval-interval<span class="o">=</span>15s<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>rules.yml
</code></pre></div>
<p><strong>性能基准测试:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>tsdb<span class="w"> </span>bench<span class="w"> </span>write<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--metrics<span class="o">=</span><span class="m">10000</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scrapes<span class="o">=</span><span class="m">3000</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--out<span class="o">=</span>benchout<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>samples.json
</code></pre></div>
<hr />
<h4 id="5-debug-">5. Debug 命令 - 调试信息<a class="headerlink" href="#5-debug-" title="Permanent link">&para;</a></h4>
<p><strong>获取性能分析数据:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>debug<span class="w"> </span>pprof<span class="w"> </span>http://localhost:9090
</code></pre></div>
<p><strong>获取指标:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>debug<span class="w"> </span>metrics<span class="w"> </span>http://localhost:9090
</code></pre></div>
<p><strong>获取所有调试信息:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>debug<span class="w"> </span>all<span class="w"> </span>http://localhost:9090
</code></pre></div>
<hr />
<h4 id="6-push-">6. Push 命令 - 推送数据<a class="headerlink" href="#6-push-" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 推送指标到 Remote Write 端点</span>
promtool<span class="w"> </span>push<span class="w"> </span>metrics<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--label<span class="o">=</span><span class="nv">job</span><span class="o">=</span><span class="nb">test</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--label<span class="o">=</span><span class="nv">instance</span><span class="o">=</span><span class="nb">local</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--timeout<span class="o">=</span>30s<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>http://localhost:9090/api/v1/write<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>metrics.txt

<span class="c1"># 从标准输入读取</span>
cat<span class="w"> </span>metrics.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>promtool<span class="w"> </span>push<span class="w"> </span>metrics<span class="w"> </span>http://localhost:9090/api/v1/write
</code></pre></div>
<hr />
<h4 id="7-promql-">7. PromQL 命令 - 格式化 (实验性)<a class="headerlink" href="#7-promql-" title="Permanent link">&para;</a></h4>
<p>需要 <code>--experimental</code> 标志。</p>
<p><strong>格式化查询:</strong></p>
<div class="highlight"><pre><span></span><code>promtool<span class="w"> </span>--experimental<span class="w"> </span>promql<span class="w"> </span>format<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;sum(rate(http_requests_total[5m]))by(job)&#39;</span>

<span class="c1"># 输出:</span>
<span class="c1"># sum by(job) (rate(http_requests_total[5m]))</span>
</code></pre></div>
<p><strong>编辑标签匹配器:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 设置标签</span>
promtool<span class="w"> </span>--experimental<span class="w"> </span>promql<span class="w"> </span>label-matchers<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--type<span class="o">=</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;up&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;job&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;prometheus&#39;</span>
<span class="c1"># 输出: up{job=&quot;prometheus&quot;}</span>

<span class="c1"># 删除标签</span>
promtool<span class="w"> </span>--experimental<span class="w"> </span>promql<span class="w"> </span>label-matchers<span class="w"> </span>delete<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;up{job=&quot;prometheus&quot;,instance=&quot;localhost&quot;}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;instance&#39;</span>
<span class="c1"># 输出: up{job=&quot;prometheus&quot;}</span>
</code></pre></div>
<hr />
<h4 id="shell">实用 Shell 脚本示例<a class="headerlink" href="#shell" title="Permanent link">&para;</a></h4>
<p><strong>自动化配置验证:</strong></p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># validate-config.sh</span>

<span class="nb">set</span><span class="w"> </span>-e

<span class="nv">CONFIG_FILE</span><span class="o">=</span><span class="s2">&quot;prometheus.yml&quot;</span>
<span class="nv">RULES_DIR</span><span class="o">=</span><span class="s2">&quot;/etc/prometheus/rules&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Validating Prometheus configuration...&quot;</span>
<span class="k">if</span><span class="w"> </span>promtool<span class="w"> </span>check<span class="w"> </span>config<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONFIG_FILE</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✓ Configuration is valid&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✗ Configuration is invalid&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Validating rules...&quot;</span>
<span class="k">for</span><span class="w"> </span>rule_file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$RULES_DIR</span><span class="s2">&quot;</span>/*.yml<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>promtool<span class="w"> </span>check<span class="w"> </span>rules<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$rule_file</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✓ </span><span class="nv">$rule_file</span><span class="s2"> is valid&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✗ </span><span class="nv">$rule_file</span><span class="s2"> is invalid&quot;</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;All checks passed!&quot;</span>
</code></pre></div>
<p><strong>CI/CD 集成示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># ci-validate.sh</span>

<span class="c1"># 验证所有配置</span>
find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.yml&quot;</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>file<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$file</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>*<span class="s2">&quot;prometheus&quot;</span>*<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>promtool<span class="w"> </span>check<span class="w"> </span>config<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$file</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>*<span class="s2">&quot;rules&quot;</span>*<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>promtool<span class="w"> </span>check<span class="w"> </span>rules<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># 运行单元测试</span>
promtool<span class="w"> </span><span class="nb">test</span><span class="w"> </span>rules<span class="w"> </span>tests/*.yml<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✓ All validations passed&quot;</span>
</code></pre></div>
<p><strong>查询性能测试:</strong></p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># query-benchmark.sh</span>

<span class="nv">PROMETHEUS_URL</span><span class="o">=</span><span class="s2">&quot;http://localhost:9090&quot;</span>
<span class="nv">QUERIES</span><span class="o">=(</span>
<span class="w">    </span><span class="s2">&quot;up&quot;</span>
<span class="w">    </span><span class="s2">&quot;rate(http_requests_total[5m])&quot;</span>
<span class="w">    </span><span class="s2">&quot;histogram_quantile(0.99, sum by(le) (rate(http_request_duration_seconds_bucket[5m])))&quot;</span>
<span class="o">)</span>

<span class="k">for</span><span class="w"> </span>query<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">QUERIES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Testing: </span><span class="nv">$query</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">time</span><span class="w"> </span>promtool<span class="w"> </span>query<span class="w"> </span>instant<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROMETHEUS_URL</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$query</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;---&quot;</span>
<span class="k">done</span>
</code></pre></div>
<hr />
<h2 id="_70">命令行工具最佳实践<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h2>
<p><strong>1. 配置验证</strong></p>
<ul>
<li>✅ 在重载配置前始终使用 <code>promtool check config</code></li>
<li>✅ 在 CI/CD 中集成配置验证</li>
<li>✅ 使用 <code>--lint</code> 检查常见问题</li>
</ul>
<p><strong>2. 规则测试</strong></p>
<ul>
<li>✅ 为所有规则编写单元测试</li>
<li>✅ 在 CI/CD 中运行 <code>promtool test rules</code></li>
<li>✅ 使用 <code>--debug</code> 排查测试问题</li>
</ul>
<p><strong>3. TSDB 维护</strong></p>
<ul>
<li>✅ 定期使用 <code>tsdb analyze</code> 检查基数问题</li>
<li>✅ 使用 <code>tsdb list</code> 监控 block 大小</li>
<li>✅ 在迁移前使用 <code>tsdb dump</code> 导出数据</li>
</ul>
<p><strong>4. 查询优化</strong></p>
<ul>
<li>✅ 使用 <code>query analyze</code> 分析查询模式</li>
<li>✅ 在生产环境测试前先用 <code>promtool query</code> 验证</li>
<li>✅ 使用 <code>--format</code> 参数获取不同格式的输出</li>
</ul>
<p><strong>5. 安全性</strong></p>
<ul>
<li>✅ 使用 <code>--http.config.file</code> 配置 TLS 客户端</li>
<li>✅ 避免在命令行中暴露敏感信息</li>
<li>✅ 使用环境变量或配置文件传递凭证</li>
</ul>
<hr />
<h2 id="9-migration">9. Migration (迁移指南)<a class="headerlink" href="#9-migration" title="Permanent link">&para;</a></h2>
<h3 id="prometheus-30">Prometheus 3.0 迁移指南<a class="headerlink" href="#prometheus-30" title="Permanent link">&para;</a></h3>
<p>Prometheus 3.0 包含重大变更。本指南帮助从 2.x 迁移到 3.0+。</p>
<h4 id="_71">已移除的特性标志<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h4>
<p>以下特性标志已移除并成为默认行为:</p>
<table>
<thead>
<tr>
<th>旧特性标志</th>
<th>新行为</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>promql-at-modifier</code></td>
<td>默认启用</td>
<td><code>@</code> 修饰符</td>
</tr>
<tr>
<td><code>promql-negative-offset</code></td>
<td>默认启用</td>
<td>负偏移支持</td>
</tr>
<tr>
<td><code>new-service-discovery-manager</code></td>
<td>默认启用</td>
<td>新服务发现管理器</td>
</tr>
<tr>
<td><code>expand-external-labels</code></td>
<td>默认启用</td>
<td>外部标签支持环境变量 <code>${var}</code></td>
</tr>
<tr>
<td><code>no-default-scrape-port</code></td>
<td>默认启用</td>
<td>不再自动添加端口</td>
</tr>
<tr>
<td><code>agent</code></td>
<td>使用 <code>--agent</code></td>
<td>独立的 Agent 标志</td>
</tr>
<tr>
<td><code>remote-write-receiver</code></td>
<td>使用 <code>--web.enable-remote-write-receiver</code></td>
<td>独立的标志</td>
</tr>
<tr>
<td><code>auto-gomemlimit</code></td>
<td>默认启用</td>
<td>自动设置 GOMEMLIMIT</td>
</tr>
<tr>
<td><code>auto-gomaxprocs</code></td>
<td>默认启用</td>
<td>自动设置 GOMAXPROCS</td>
</tr>
</tbody>
</table>
<blockquote>
<p>⚠️ <strong>注意:</strong> 继续使用这些标志会记录警告</p>
</blockquote>
<hr />
<h4 id="_72">配置变更<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h4>
<p><strong>1. 经典直方图配置重命名:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># v2.x</span>
<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;app&#39;</span>
<span class="w">    </span><span class="nt">scrape_classic_histograms</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># ❌ 旧名称</span>

<span class="c1"># v3.0</span>
<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;app&#39;</span>
<span class="w">    </span><span class="nt">always_scrape_classic_histograms</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># ✅ 新名称</span>
</code></pre></div>
<p><strong>2. Remote Write HTTP/2 默认值变更:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># v3.0 默认为 false,需显式启用</span>
<span class="nt">remote_write</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://remote-storage.example.com</span>
<span class="w">    </span><span class="nt">http_config</span><span class="p">:</span>
<span class="w">      </span><span class="nt">enable_http2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># 显式启用 HTTP/2</span>
</code></pre></div>
<hr />
<h4 id="promql_2">PromQL 变更<a class="headerlink" href="#promql_2" title="Permanent link">&para;</a></h4>
<p><strong>1. 正则表达式匹配换行符</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># v3.0 中 . 匹配换行符</span>
<span class="p">{</span><span class="nl">label</span><span class="o">=~</span><span class="p">&quot;</span><span class="s">.*</span><span class="p">&quot;}</span><span class="w">  </span><span class="c1"># 现在匹配包含 \n 的字符串</span>

<span class="c1"># 如需 v2 行为,使用 [^\n]</span>
<span class="p">{</span><span class="nl">label</span><span class="o">=~</span><span class="p">&quot;</span><span class="s">foo[^\n]*</span><span class="p">&quot;}</span><span class="w">  </span><span class="c1"># 不匹配换行符</span>
</code></pre></div>
<p><strong>2. 范围选择器变更 (左开右闭)</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 假设样本间隔 1 分钟</span>
<span class="nv">foo</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="w">  </span><span class="c1"># v2: 可能返回 5 或 6 个样本</span>
<span class="w">         </span><span class="c1"># v3: 始终返回 5 个样本</span>
</code></pre></div>
<p><strong>影响:</strong></p>
<ul>
<li>子查询受影响最大</li>
<li><code>foo[1m:1m]</code> 在 v3 中只返回 1 个点(不足以计算 rate)</li>
<li><strong>修复:</strong> 扩展窗口 <code>foo[2m:1m]</code> 返回 2 个点</li>
</ul>
<p><strong>3. <code>holt_winters</code> 函数重命名:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># v2.x</span>
<span class="kr">holt_winters</span><span class="o">(</span><span class="nv">metric</span><span class="p">[</span><span class="s">5m</span><span class="p">],</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="o">)</span><span class="w">  </span><span class="c1"># ❌</span>

<span class="c1"># v3.0 (需启用实验性函数)</span>
<span class="nv">double_exponential_smoothing</span><span class="o">(</span><span class="nv">metric</span><span class="p">[</span><span class="s">5m</span><span class="p">],</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="o">)</span><span class="w">  </span><span class="c1"># ✅</span>

<span class="c1"># 启动参数</span>
<span class="nv">prometheus</span><span class="w"> </span><span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">feature</span><span class="err">=</span><span class="nv">promql</span><span class="o">-</span><span class="nv">experimental</span><span class="o">-</span><span class="nv">functions</span>
</code></pre></div>
<hr />
<h4 id="_73">抓取协议变更<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h4>
<p>Prometheus 3.0 对 <code>Content-Type</code> 头更严格:</p>
<p><strong>v2.x 行为:</strong></p>
<ul>
<li>缺少 <code>Content-Type</code> → 默认为文本格式</li>
<li>可能导致数据错误</li>
</ul>
<p><strong>v3.0 行为:</strong></p>
<ul>
<li>缺少/无效 <code>Content-Type</code> → 抓取失败</li>
<li>需配置 fallback 协议:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;legacy_app&#39;</span>
<span class="w">    </span><span class="nt">fallback_scrape_protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PrometheusText0.0.4</span>
</code></pre></div>
<hr />
<h4 id="_74">其他重要变更<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h4>
<p><strong>1. TSDB 格式和降级</strong></p>
<ul>
<li>TSDB 格式在 v2.55 已变更</li>
<li><strong>v3.0 只能降级到 v2.55+</strong>,不能更低</li>
<li><strong>建议:</strong> 先升级到 v2.55 测试,再升级到 v3.0</li>
</ul>
<p><strong>2. UTF-8 指标名称支持</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 保留旧验证行为(全局)</span>
<span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">metric_name_validation_scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy</span>

<span class="c1"># 或按 job 配置</span>
<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;new_app&#39;</span>
<span class="w">    </span><span class="nt">metric_name_validation_scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">utf8</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;legacy_app&#39;</span>
<span class="w">    </span><span class="nt">metric_name_validation_scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">legacy</span>
</code></pre></div>
<p><strong>3. 日志格式变更</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># v2.x</span>
<span class="nv">ts</span><span class="o">=</span><span class="m">2024</span>-10-23T22:01:06.074Z<span class="w"> </span><span class="nv">caller</span><span class="o">=</span>main.go:627<span class="w"> </span><span class="nv">level</span><span class="o">=</span>info<span class="w"> </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;...&quot;</span>

<span class="c1"># v3.0</span>
<span class="nv">time</span><span class="o">=</span><span class="m">2024</span>-10-24T00:03:07.542+02:00<span class="w"> </span><span class="nv">level</span><span class="o">=</span>INFO<span class="w"> </span><span class="nv">source</span><span class="o">=</span>main.go:640<span class="w"> </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;...&quot;</span>
</code></pre></div>
<p><strong>4. <code>le</code> 和 <code>quantile</code> 标签归一化</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># v2.x</span>
<span class="nv">my_histogram</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">1</span><span class="p">&quot;}</span><span class="w">  </span><span class="c1"># 文本格式</span>
<span class="nv">my_histogram</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">1.0</span><span class="p">&quot;}</span><span class="w">  </span><span class="c1"># protobuf 格式</span>

<span class="c1"># v3.0 统一归一化</span>
<span class="nv">my_histogram</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">1.0</span><span class="p">&quot;}</span><span class="w">  </span><span class="c1"># 所有格式</span>

<span class="c1"># 需更新查询</span>
<span class="c1"># ❌ le=&quot;1&quot;</span>
<span class="c1"># ✅ le=&quot;1.0&quot;</span>
</code></pre></div>
<p><strong>5. Alertmanager API v1 移除</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># v2.x</span>
<span class="nt">alerting</span><span class="p">:</span>
<span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">api_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w">  </span><span class="c1"># ❌ 不再支持</span>

<span class="c1"># v3.0 (需要 Alertmanager 0.16.0+)</span>
<span class="nt">alerting</span><span class="p">:</span>
<span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">api_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span><span class="w">  </span><span class="c1"># ✅</span>
</code></pre></div>
<hr />
<h2 id="10-feature-flags">10. Feature Flags (特性标志)<a class="headerlink" href="#10-feature-flags" title="Permanent link">&para;</a></h2>
<p>使用 <code>--enable-feature</code> 启用实验性或破坏性变更的特性。</p>
<div class="highlight"><pre><span></span><code>prometheus<span class="w"> </span>--enable-feature<span class="o">=</span>feature1,feature2
</code></pre></div>
<h3 id="_75">可用特性标志<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p><strong>1. exemplar-storage - 示例存储</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>exemplar-storage
</code></pre></div>
<ul>
<li>存储 OpenMetrics 示例(如 trace_id)</li>
<li>固定大小循环缓冲区</li>
<li>每个示例约 100 字节内存</li>
<li>持久化到 WAL</li>
</ul>
<hr />
<p><strong>2. native-histograms - 原生直方图</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>native-histograms
</code></pre></div>
<ul>
<li>采集原生直方图(高分辨率直方图)</li>
<li><strong>实验性</strong>: 可能有破坏性变更</li>
<li>使用 protobuf 格式</li>
<li>可与经典直方图共存</li>
</ul>
<p><strong>配置示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;app&#39;</span>
<span class="w">    </span><span class="nt">always_scrape_classic_histograms</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># 同时保留经典直方图</span>
</code></pre></div>
<hr />
<p><strong>3. extra-scrape-metrics - 额外抓取指标</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>extra-scrape-metrics
</code></pre></div>
<p>添加以下指标:</p>
<ul>
<li><code>scrape_timeout_seconds</code> - 配置的超时时间</li>
<li><code>scrape_sample_limit</code> - 样本限制</li>
<li><code>scrape_body_size_bytes</code> - 响应体大小</li>
</ul>
<p><strong>用途:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查接近超时的目标</span>
<span class="nv">scrape_duration_seconds</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">scrape_timeout_seconds</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span>

<span class="c1"># 检查接近限制的目标</span>
<span class="nv">scrape_samples_post_metric_relabeling</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">(</span><span class="nv">scrape_sample_limit</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span>
</code></pre></div>
<hr />
<p><strong>4. memory-snapshot-on-shutdown - 关闭时内存快照</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>memory-snapshot-on-shutdown
</code></pre></div>
<ul>
<li>关闭时保存内存快照到磁盘</li>
<li>重启时快速恢复</li>
<li>减少 WAL 重放时间</li>
</ul>
<hr />
<p><strong>5. concurrent-rule-eval - 并发规则评估</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>concurrent-rule-eval
</code></pre></div>
<ul>
<li>同组内无依赖的规则并发执行</li>
<li>配合 <code>--rules.max-concurrent-rule-evals=4</code> 使用</li>
<li>提高规则评估速度</li>
</ul>
<hr />
<p><strong>6. auto-reload-config - 自动重载配置</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>auto-reload-config
--config.auto-reload-interval<span class="o">=</span>30s
</code></pre></div>
<ul>
<li>自动检测配置变更</li>
<li>定期检查文件校验和</li>
<li>原子更新文件以避免问题</li>
</ul>
<hr />
<p><strong>7. otlp-deltatocumulative - OTLP Delta 转换</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>otlp-deltatocumulative
</code></pre></div>
<ul>
<li>将 OTLP delta 指标转换为累积</li>
<li>内存状态存储增量</li>
<li>重启后从零开始(导致计数器重置)</li>
</ul>
<hr />
<p><strong>8. promql-experimental-functions - 实验性 PromQL 函数</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>promql-experimental-functions
</code></pre></div>
<p>启用实验性函数(如 <code>double_exponential_smoothing</code>)。</p>
<hr />
<p><strong>9. type-and-unit-labels - 类型和单位标签</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>type-and-unit-labels
</code></pre></div>
<ul>
<li>注入 <code>__type__</code> 和 <code>__unit__</code> 保留标签</li>
<li>从元数据获取类型和单位信息</li>
<li>支持基于类型/单位的查询</li>
</ul>
<hr />
<p><strong>10. old-ui - 旧版 UI</strong></p>
<div class="highlight"><pre><span></span><code>--enable-feature<span class="o">=</span>old-ui
</code></pre></div>
<p>使用 Prometheus 2.x 的旧版 Web UI。</p>
<hr />
<p><strong>其他特性:</strong></p>
<ul>
<li><code>promql-per-step-stats</code> - 每步统计</li>
<li><code>created-timestamp-zero-ingestion</code> - Created 时间戳注入</li>
<li><code>delayed-compaction</code> - 延迟压缩</li>
<li><code>promql-delayed-name-removal</code> - 延迟 <code>__name__</code> 移除</li>
<li><code>promql-duration-expr</code> - 持续时间算术表达式</li>
<li><code>otlp-native-delta-ingestion</code> - OTLP 原生 Delta</li>
<li><code>metadata-wal-records</code> - 元数据 WAL 记录</li>
<li><code>use-uncached-io</code> - 非缓存 I/O (Linux)</li>
</ul>
<hr />
<h2 id="11-security">11. Security (安全)<a class="headerlink" href="#11-security" title="Permanent link">&para;</a></h2>
<h3 id="_76">安全模型概述<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<blockquote>
<p>⚠️ <strong>重要:</strong> Prometheus HTTP 端点<strong>不应暴露到公网</strong>,包括:</p>
<ul>
<li><code>/metrics</code> 端点</li>
<li>API 端点 (<code>/api/v1/*</code>)</li>
<li><code>/pprof</code> 调试端点</li>
</ul>
</blockquote>
<h3 id="_77">安全假设<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p><strong>Prometheus:</strong></p>
<ul>
<li>✅ 不可信用户可访问 HTTP 端点和日志</li>
<li>✅ 不可信用户可查询所有时间序列数据</li>
<li>❌ 只有可信用户可修改配置、规则文件、命令行参数</li>
</ul>
<p><strong>目标:</strong></p>
<ul>
<li>不可信用户可运行抓取目标</li>
<li>默认情况下目标不能伪装成其他目标</li>
<li><code>honor_labels: true</code> 会移除此保护</li>
</ul>
<hr />
<h3 id="api_2">管理 API<a class="headerlink" href="#api_2" title="Permanent link">&para;</a></h3>
<p><strong>v2.0+ 安全控制:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 启用管理 API (删除时间序列等)</span>
--web.enable-admin-api

<span class="c1"># 启用生命周期 API (重载/关闭)</span>
--web.enable-lifecycle
</code></pre></div>
<p><strong>端点:</strong></p>
<ul>
<li><code>/api/*/admin/*</code> - 管理功能</li>
<li><code>/-/reload</code> - 重载配置</li>
<li><code>/-/quit</code> - 关闭服务</li>
</ul>
<hr />
<h3 id="_78">组件安全<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p><strong>Alertmanager:</strong></p>
<ul>
<li>任何访问者可创建、解析告警</li>
<li>任何访问者可创建、修改、删除静默</li>
</ul>
<p><strong>Pushgateway:</strong></p>
<ul>
<li>任何访问者可创建、修改、删除指标</li>
<li>通常与 <code>honor_labels</code> 一起使用</li>
<li>可伪造任意时间序列</li>
</ul>
<p><strong>Exporters:</strong></p>
<ul>
<li>SNMP/Blackbox Exporter 从 URL 参数获取目标</li>
<li>可能泄露认证信息(如 HTTP Basic Auth、SNMP community)</li>
</ul>
<hr />
<h3 id="_79">认证、授权和加密<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<p><strong>TLS 支持:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># prometheus.yml</span>
<span class="nt">tls_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cert_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server.crt</span>
<span class="w">  </span><span class="nt">key_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server.key</span>
<span class="w">  </span><span class="nt">client_ca_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>

<span class="c1"># 最低 TLS 1.2</span>
<span class="c1"># 目标: Qualys SSL Labs A 级</span>
</code></pre></div>
<p><strong>HTTP Basic 认证:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">basic_auth</span><span class="p">:</span>
<span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
<span class="w">  </span><span class="nt">password_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/password</span>

<span class="c1"># 密码使用 bcrypt 哈希存储</span>
<span class="c1"># 建议使用 TLS,否则明文传输</span>
</code></pre></div>
<p><strong>客户端认证:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">tls_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">insecure_skip_verify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># 不跳过 SSL 验证</span>
</code></pre></div>
<hr />
<h3 id="api_3">API 安全<a class="headerlink" href="#api_3" title="Permanent link">&para;</a></h3>
<p><strong>CSRF 防护:</strong></p>
<ul>
<li>无内置 CSRF 保护(为兼容 cURL 等工具)</li>
<li>建议在反向代理层阻止可变端点</li>
</ul>
<p><strong>XSS 防护:</strong></p>
<ul>
<li>非可变端点设置 CORS 头</li>
<li>示例: <code>Access-Control-Allow-Origin</code></li>
</ul>
<p><strong>PromQL 注入:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ 危险 - 用户输入未转义</span>
<span class="nv">up</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">&lt;user_input&gt;</span><span class="p">&quot;}</span>

<span class="c1"># 如果 user_input = &quot;} or some_metric{zzz=&quot;</span>
<span class="c1"># 结果: up{job=&quot;&quot;} or some_metric{zzz=&quot;&quot;}</span>
</code></pre></div>
<p><strong>Grafana 注意事项:</strong></p>
<ul>
<li>Dashboard 权限 ≠ 数据源权限</li>
<li>代理模式下用户可运行任意查询</li>
</ul>
<hr />
<h3 id="_80">秘密管理<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p><strong>秘密字段:</strong></p>
<ul>
<li>配置中标记为秘密的字段不会暴露在日志/API</li>
<li>不要在其他字段存放秘密</li>
<li>保护磁盘文件权限</li>
</ul>
<p><strong>外部秘密:</strong></p>
<ul>
<li>依赖的秘密(如 <code>AWS_SECRET_KEY</code>)可能被泄露</li>
<li>用户需自行保护</li>
</ul>
<hr />
<h3 id="dos">DoS 防护<a class="headerlink" href="#dos" title="Permanent link">&para;</a></h3>
<p><strong>缓解措施:</strong></p>
<ul>
<li>部分负载和查询限制</li>
<li>过多/昂贵查询会导致组件崩溃</li>
</ul>
<p><strong>用户责任:</strong></p>
<ul>
<li>提供足够资源 (CPU、RAM、磁盘、IOPS、文件描述符、带宽)</li>
<li>监控所有组件</li>
<li>自动重启失败组件</li>
</ul>
<hr />
<h3 id="_81">漏洞报告<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p><strong>公开漏洞:</strong></p>
<ul>
<li>在 GitHub 提交 Bug 报告</li>
</ul>
<p><strong>未公开漏洞:</strong></p>
<ul>
<li>私下报告给 MAINTAINERS</li>
<li>抄送: <code>prometheus-team@googlegroups.com</code></li>
<li>7 天内修复核心组件(Prometheus、Alertmanager、Node Exporter 等)</li>
</ul>
<p><strong>扫描工具用户注意:</strong></p>
<ul>
<li>提交前分析报告,避免误报</li>
<li>使用开源工具(如 <code>govulncheck</code>)验证</li>
</ul>
<hr />
<h2 id="12-overview">12. Overview (概览)<a class="headerlink" href="#12-overview" title="Permanent link">&para;</a></h2>
<h3 id="prometheus_9">什么是 Prometheus?<a class="headerlink" href="#prometheus_9" title="Permanent link">&para;</a></h3>
<p>Prometheus 是开源的系统监控和告警工具包,最初在 SoundCloud 构建。2016 年加入 CNCF,成为继 Kubernetes 之后的第二个托管项目。</p>
<p><strong>核心特点:</strong></p>
<ul>
<li>采集并存储指标为时间序列数据</li>
<li>指标 + 时间戳 + 可选键值对标签</li>
</ul>
<hr />
<h3 id="_82">主要特性<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>多维数据模型</strong> - 指标名称和键值对标识时间序列</li>
<li><strong>PromQL</strong> - 灵活的查询语言</li>
<li><strong>无依赖分布式存储</strong> - 单服务器节点自治</li>
<li><strong>Pull 模型</strong> - 通过 HTTP 拉取时间序列</li>
<li><strong>Push 支持</strong> - 通过中间网关支持推送</li>
<li><strong>服务发现</strong> - 静态配置或服务发现</li>
<li><strong>图形和仪表板</strong> - 多种可视化支持</li>
</ol>
<hr />
<h3 id="_83">什么是指标?<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p><strong>指标:</strong> 数值测量</p>
<p><strong>时间序列:</strong> 随时间变化的记录</p>
<p><strong>示例:</strong></p>
<ul>
<li>Web 服务器: 请求时间</li>
<li>数据库: 活动连接数、活动查询数</li>
</ul>
<p><strong>作用:</strong> 理解应用行为,诊断问题,指导扩容</p>
<hr />
<h3 id="_84">组件生态<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>graph TB
    A[Prometheus Server&lt;br/&gt;抓取并存储数据] --&gt; B[时间序列数据库]
    C[客户端库] --&gt; D[应用程序]
    E[Pushgateway&lt;br/&gt;短期任务] --&gt; A
    F[Exporters&lt;br/&gt;HAProxy/StatsD等] --&gt; A
    A --&gt; G[Alertmanager&lt;br/&gt;告警处理]
    A --&gt; H[Grafana&lt;br/&gt;可视化]
    I[服务发现] --&gt; A
</code></pre></div>
<p><strong>核心组件:</strong></p>
<ol>
<li><strong>Prometheus Server</strong> - 抓取和存储时间序列</li>
<li><strong>客户端库</strong> - 应用程序埋点</li>
<li><strong>Pushgateway</strong> - 短期任务支持</li>
<li><strong>Exporters</strong> - 第三方服务(HAProxy、StatsD 等)</li>
<li><strong>Alertmanager</strong> - 告警处理</li>
</ol>
<p><strong>语言:</strong> 大多数组件用 Go 编写,易于部署</p>
<hr />
<h3 id="_85">架构<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>Prometheus 从已埋点的作业抓取指标:</p>
<ul>
<li>直接抓取</li>
<li>通过 Pushgateway(短期任务)</li>
</ul>
<p>存储样本并运行规则:</p>
<ul>
<li>聚合和记录新时间序列</li>
<li>生成告警</li>
</ul>
<p>Grafana 或其他 API 消费者可视化数据。</p>
<hr />
<h3 id="_86">适用场景<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p><strong>适合:</strong></p>
<ul>
<li>✅ 记录纯数值时间序列</li>
<li>✅ 机器中心监控</li>
<li>✅ 高度动态的面向服务架构</li>
<li>✅ 微服务环境</li>
<li>✅ 多维数据收集和查询</li>
</ul>
<p><strong>可靠性设计:</strong></p>
<ul>
<li>独立服务器,不依赖网络存储</li>
<li>故障期间可查看统计信息</li>
<li>不需要复杂基础设施</li>
</ul>
<hr />
<h3 id="_87">不适用场景<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h3>
<p><strong>不适合:</strong></p>
<ul>
<li>❌ 需要 100% 准确性(如按请求计费)</li>
<li>❌ 采集的数据可能不够详细和完整</li>
<li>❌ 建议使用其他系统收集计费数据</li>
<li>✅ Prometheus 用于其余监控</li>
</ul>
<hr />
<h2 id="13-alertmanager">13. Alertmanager (告警管理器)<a class="headerlink" href="#13-alertmanager" title="Permanent link">&para;</a></h2>
<h3 id="_88">核心功能<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h3>
<p>Alertmanager 处理客户端(如 Prometheus)发送的告警,负责:</p>
<ul>
<li><strong>去重 (Deduplication)</strong></li>
<li><strong>分组 (Grouping)</strong></li>
<li><strong>路由 (Routing)</strong></li>
<li><strong>静默 (Silencing)</strong></li>
<li><strong>抑制 (Inhibition)</strong></li>
</ul>
<hr />
<h3 id="_89">核心概念<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h3>
<h4 id="1-grouping">1. Grouping (分组)<a class="headerlink" href="#1-grouping" title="Permanent link">&para;</a></h4>
<p><strong>目的:</strong> 将相似告警归类为单个通知</p>
<p><strong>场景:</strong></p>
<p>数百个服务实例 → 网络分区 → 一半实例无法访问数据库</p>
<p><strong>无分组:</strong> 发送数百条告警</p>
<p><strong>有分组:</strong> 发送一条告警,列出所有受影响实例</p>
<p><strong>配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">route</span><span class="p">:</span>
<span class="w">  </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;alertname&#39;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">group_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1h</span>
<span class="w">  </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;team-ops&#39;</span>
</code></pre></div>
<hr />
<h4 id="2-inhibition">2. Inhibition (抑制)<a class="headerlink" href="#2-inhibition" title="Permanent link">&para;</a></h4>
<p><strong>目的:</strong> 某些告警触发时,抑制其他相关告警</p>
<p><strong>场景:</strong></p>
<p>整个集群不可达 → 数百个实例告警</p>
<p><strong>抑制规则:</strong> 集群不可达告警触发时,抑制该集群的所有其他告警</p>
<p><strong>配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">inhibit_rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_match</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;critical&#39;</span>
<span class="w">      </span><span class="nt">alertname</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ClusterDown&#39;</span>
<span class="w">    </span><span class="nt">target_match</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;warning&#39;</span>
<span class="w">    </span><span class="nt">equal</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<hr />
<h4 id="3-silences">3. Silences (静默)<a class="headerlink" href="#3-silences" title="Permanent link">&para;</a></h4>
<p><strong>目的:</strong> 在给定时间内静默告警</p>
<p><strong>配置方式:</strong> Web UI 配置</p>
<p><strong>示例:</strong></p>
<ul>
<li>计划维护期间静默告警</li>
<li>基于标签匹配器</li>
<li>支持等式和正则表达式</li>
</ul>
<p><strong>Web UI 操作:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 访问 Alertmanager UI</span>
http://alertmanager:9093

<span class="c1"># 创建静默</span>
Silences<span class="w"> </span>→<span class="w"> </span>Create<span class="w"> </span>Silence<span class="w"> </span>→<span class="w"> </span>设置匹配器和时间
</code></pre></div>
<hr />
<h3 id="_90">高可用性<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h3>
<p><strong>集群配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Alertmanager 1</span>
alertmanager<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cluster.peer<span class="o">=</span>alertmanager-2:9094<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cluster.peer<span class="o">=</span>alertmanager-3:9094

<span class="c1"># Alertmanager 2</span>
alertmanager<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cluster.peer<span class="o">=</span>alertmanager-1:9094<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cluster.peer<span class="o">=</span>alertmanager-3:9094
</code></pre></div>
<p><strong>Prometheus 配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ⚠️ 不要负载均衡,而是提供完整列表</span>
<span class="nt">alerting</span><span class="p">:</span>
<span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertmanager-1:9093</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertmanager-2:9093</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertmanager-3:9093</span>
</code></pre></div>
<hr />
<h3 id="_91">配置示例<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h3>
<p><strong>完整路由树:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">route</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 根路由</span>
<span class="w">  </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;default-receiver&#39;</span>
<span class="w">  </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;alertname&#39;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">group_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12h</span>

<span class="w">  </span><span class="c1"># 子路由</span>
<span class="w">  </span><span class="nt">routes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">        </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">      </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pager&#39;</span>
<span class="w">      </span><span class="nt">continue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">        </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">      </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack&#39;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match_re</span><span class="p">:</span>
<span class="w">        </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^(foo|bar)$</span>
<span class="w">      </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;team-ops&#39;</span>
<span class="w">      </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;service&#39;</span><span class="p p-Indicator">]</span>

<span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;default-receiver&#39;</span>
<span class="w">    </span><span class="nt">email_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;team@example.com&#39;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pager&#39;</span>
<span class="w">    </span><span class="nt">pagerduty_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">service_key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&lt;key&gt;&#39;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack&#39;</span>
<span class="w">    </span><span class="nt">slack_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">api_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&lt;webhook_url&gt;&#39;</span>
<span class="w">        </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#alerts&#39;</span>
</code></pre></div>
<hr />
<h3 id="_92">通知接收器<a class="headerlink" href="#_92" title="Permanent link">&para;</a></h3>
<p><strong>支持的接收器:</strong></p>
<ul>
<li>Email</li>
<li>PagerDuty</li>
<li>Slack</li>
<li>Webhook</li>
<li>OpsGenie</li>
<li>VictorOps</li>
<li>WeChat</li>
<li>Pushover</li>
<li>等等...</li>
</ul>
<p><strong>Webhook 示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;webhook&#39;</span>
<span class="w">    </span><span class="nt">webhook_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;http://example.com/webhook&#39;</span>
<span class="w">        </span><span class="nt">send_resolved</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<hr />
<h3 id="_93">最佳实践<a class="headerlink" href="#_93" title="Permanent link">&para;</a></h3>
<p><strong>1. 合理分组</strong></p>
<ul>
<li>按集群、服务、严重程度分组</li>
<li>避免过度分组导致通知风暴</li>
</ul>
<p><strong>2. 使用抑制</strong></p>
<ul>
<li>上游问题抑制下游告警</li>
<li>减少噪音</li>
</ul>
<p><strong>3. 静默管理</strong></p>
<ul>
<li>维护期间使用静默</li>
<li>设置合理的静默时间</li>
<li>避免永久静默</li>
</ul>
<p><strong>4. 高可用部署</strong></p>
<ul>
<li>至少 3 个 Alertmanager 实例</li>
<li>Prometheus 配置完整的 Alertmanager 列表</li>
<li>不要负载均衡</li>
</ul>
<p><strong>5. 测试通知</strong></p>
<ul>
<li>使用 <code>amtool</code> 测试配置</li>
<li>验证路由规则</li>
<li>测试所有接收器</li>
</ul>
<hr />
<h2 id="14-alerting-configuration-alertmanager">14. Alerting Configuration (Alertmanager 配置)<a class="headerlink" href="#14-alerting-configuration-alertmanager" title="Permanent link">&para;</a></h2>
<p>Alertmanager 通过命令行标志和配置文件进行配置。</p>
<h3 id="141">14.1 配置文件基础<a class="headerlink" href="#141" title="Permanent link">&para;</a></h3>
<p><strong>启动命令:</strong></p>
<div class="highlight"><pre><span></span><code>alertmanager<span class="w"> </span>--config.file<span class="o">=</span>alertmanager.yml
</code></pre></div>
<p><strong>重载配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 发送 SIGHUP 信号</span>
<span class="nb">kill</span><span class="w"> </span>-HUP<span class="w"> </span>&lt;pid&gt;

<span class="c1"># 或使用 HTTP 端点</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9093/-/reload
</code></pre></div>
<hr />
<h3 id="142">14.2 全局配置<a class="headerlink" href="#142" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># SMTP 配置</span>
<span class="w">  </span><span class="nt">smtp_from</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;alertmanager@example.com&#39;</span>
<span class="w">  </span><span class="nt">smtp_smarthost</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;smtp.gmail.com:587&#39;</span>
<span class="w">  </span><span class="nt">smtp_auth_username</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;alerts@example.com&#39;</span>
<span class="w">  </span><span class="nt">smtp_auth_password</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;password&#39;</span>
<span class="w">  </span><span class="nt">smtp_require_tls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="c1"># Slack 配置</span>
<span class="w">  </span><span class="nt">slack_api_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://hooks.slack.com/services/xxx&#39;</span>

<span class="w">  </span><span class="c1"># PagerDuty 配置</span>
<span class="w">  </span><span class="nt">pagerduty_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://events.pagerduty.com/v2/enqueue&#39;</span>

<span class="w">  </span><span class="c1"># OpsGenie 配置</span>
<span class="w">  </span><span class="nt">opsgenie_api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">  </span><span class="nt">opsgenie_api_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://api.opsgenie.com/&#39;</span>

<span class="w">  </span><span class="c1"># 解析超时</span>
<span class="w">  </span><span class="nt">resolve_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>

<span class="w">  </span><span class="c1"># HTTP 客户端配置</span>
<span class="w">  </span><span class="nt">http_config</span><span class="p">:</span>
<span class="w">    </span><span class="nt">tls_config</span><span class="p">:</span>
<span class="w">      </span><span class="nt">insecure_skip_verify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<hr />
<h3 id="143-route">14.3 路由配置 (Route)<a class="headerlink" href="#143-route" title="Permanent link">&para;</a></h3>
<p>路由定义告警如何分组和发送到接收器。</p>
<p><strong>核心参数:</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>receiver</code></td>
<td>接收器名称</td>
<td>必需</td>
</tr>
<tr>
<td><code>group_by</code></td>
<td>分组标签</td>
<td>-</td>
</tr>
<tr>
<td><code>group_wait</code></td>
<td>分组等待时间</td>
<td><code>30s</code></td>
</tr>
<tr>
<td><code>group_interval</code></td>
<td>组内新告警间隔</td>
<td><code>5m</code></td>
</tr>
<tr>
<td><code>repeat_interval</code></td>
<td>重复发送间隔</td>
<td><code>4h</code></td>
</tr>
<tr>
<td><code>continue</code></td>
<td>继续匹配兄弟节点</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>matchers</code></td>
<td>标签匹配器</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>完整示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">route</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 根路由 - 匹配所有告警</span>
<span class="w">  </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;default-receiver&#39;</span>
<span class="w">  </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;alertname&#39;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">  </span><span class="nt">group_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">  </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4h</span>

<span class="w">  </span><span class="c1"># 子路由</span>
<span class="w">  </span><span class="nt">routes</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 数据库告警</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;database-pager&#39;</span>
<span class="w">      </span><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">      </span><span class="nt">matchers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service=~&quot;mysql|cassandra&quot;</span>

<span class="w">    </span><span class="c1"># 前端团队告警</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;frontend-pager&#39;</span>
<span class="w">      </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;product&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;environment&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">matchers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">team=&quot;frontend&quot;</span>

<span class="w">    </span><span class="c1"># 非工作时间静默</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dev-pager&#39;</span>
<span class="w">      </span><span class="nt">matchers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service=&quot;inhouse-service&quot;</span>
<span class="w">      </span><span class="nt">mute_time_intervals</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">offhours</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">holidays</span>
<span class="w">      </span><span class="nt">continue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">    </span><span class="c1"># 工作时间激活</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;on-call-pager&#39;</span>
<span class="w">      </span><span class="nt">matchers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service=&quot;inhouse-service&quot;</span>
<span class="w">      </span><span class="nt">active_time_intervals</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">offhours</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">holidays</span>
</code></pre></div>
<p><strong>分组策略:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 按所有标签分组(禁用聚合)</span>
<span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;...&#39;</span><span class="p p-Indicator">]</span>

<span class="c1"># 按特定标签分组</span>
<span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;alertname&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;severity&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<hr />
<h3 id="144-time-intervals">14.4 时间间隔 (Time Intervals)<a class="headerlink" href="#144-time-intervals" title="Permanent link">&para;</a></h3>
<p>定义静默或激活路由的时间范围。</p>
<p><strong>基本示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">time_intervals</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 非工作时间</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">offhours</span>
<span class="w">    </span><span class="nt">time_intervals</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">times</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">start_time</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;17:00&#39;</span>
<span class="w">            </span><span class="nt">end_time</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;09:00&#39;</span>
<span class="w">        </span><span class="nt">weekdays</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;monday:friday&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">weekdays</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;saturday&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;sunday&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Asia/Shanghai&#39;</span>

<span class="w">  </span><span class="c1"># 节假日</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">holidays</span>
<span class="w">    </span><span class="nt">time_intervals</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">days_of_month</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;1&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">months</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;january&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;may&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;october&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">days_of_month</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;25&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">months</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;december&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>时间字段:</strong></p>
<ul>
<li><code>times</code> - 时间范围 (HH:MM - HH:MM)</li>
<li><code>weekdays</code> - 星期几 (sunday - saturday)</li>
<li><code>days_of_month</code> - 月份中的天 (1-31, 支持负数)</li>
<li><code>months</code> - 月份 (january-december 或 1-12)</li>
<li><code>years</code> - 年份 (如 2024:2025)</li>
<li><code>location</code> - 时区 (如 Asia/Shanghai, UTC, Local)</li>
</ul>
<hr />
<h3 id="145-inhibition">14.5 抑制规则 (Inhibition)<a class="headerlink" href="#145-inhibition" title="Permanent link">&para;</a></h3>
<p>当某个告警触发时,抑制其他相关告警。</p>
<p><strong>基本示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">inhibit_rules演</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain"># 集群宕机时抑制所有其他告警</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">- source_matchers</span><span class="p p-Indicator">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertname=&quot;ClusterDown&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity=&quot;critical&quot;</span>
<span class="w w-Error">    </span><span class="nt">target_matchers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity=&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">equal</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="c1"># 节点宕机时抑制该节点的所有告警</span>
<span class="w w-Error">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_matchers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertname=&quot;NodeDown&quot;</span>
<span class="w">    </span><span class="nt">target_matchers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertname!=&quot;NodeDown&quot;</span>
<span class="w">    </span><span class="nt">equal</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;instance&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>字段说明:</strong></p>
<ul>
<li><code>source_matchers</code> - 源告警匹配器(抑制器)</li>
<li><code>target_matchers</code> - 目标告警匹配器(被抑制)</li>
<li><code>equal</code> - 必须相等的标签列表</li>
</ul>
<hr />
<h3 id="146-matchers">14.6 标签匹配器 (Matchers)<a class="headerlink" href="#146-matchers" title="Permanent link">&para;</a></h3>
<p><strong>UTF-8 匹配器 (推荐):</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">matchers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertname = &quot;HighCPU&quot;</span><span class="w">           </span><span class="c1"># 等于</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity != &quot;info&quot;</span><span class="w">              </span><span class="c1"># 不等于</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service =~ &quot;api|web&quot;</span><span class="w">            </span><span class="c1"># 正则匹配</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance !~ &quot;test.*&quot;</span><span class="w">            </span><span class="c1"># 正则不匹配</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo = &quot;bar,baz&quot;</span><span class="w">                 </span><span class="c1"># 可包含特殊字符</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">team = &quot;前端&quot;</span><span class="w">                   </span><span class="c1"># 支持 UTF-8</span>
</code></pre></div>
<p><strong>组合匹配器:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># YAML 列表形式</span>
<span class="nt">matchers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertname = &quot;Watchdog&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity =~ &quot;warning|critical&quot;</span>

<span class="c1"># 短格式</span>
<span class="nt">matchers</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&#39;alertname</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">&quot;Watchdog&quot;&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;severity</span><span class="nv"> </span><span class="s">=~</span><span class="nv"> </span><span class="s">&quot;warning|critical&quot;&#39;</span><span class="w"> </span><span class="p p-Indicator">]</span>

<span class="c1"># PromQL 风格</span>
<span class="nt">matchers</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&#39;{alertname=&quot;Watchdog&quot;,</span><span class="nv"> </span><span class="s">severity=~&quot;warning|critical&quot;}&#39;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>UTF-8 严格模式:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 启用 UTF-8 严格模式</span>
alertmanager<span class="w"> </span>--enable-feature<span class="o">=</span><span class="s2">&quot;utf8-strict-mode&quot;</span>

<span class="c1"># 验证配置</span>
amtool<span class="w"> </span>check-config<span class="w"> </span>alertmanager.yml
</code></pre></div>
<hr />
<h3 id="147-receivers">14.7 接收器 (Receivers)<a class="headerlink" href="#147-receivers" title="Permanent link">&para;</a></h3>
<h4 id="email">Email 接收器<a class="headerlink" href="#email" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;email-team&#39;</span>
<span class="w">    </span><span class="nt">email_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;team@example.com&#39;</span>
<span class="w">        </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;alertmanager@example.com&#39;</span>
<span class="w">        </span><span class="nt">smarthost</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;smtp.gmail.com:587&#39;</span>
<span class="w">        </span><span class="nt">auth_username</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;alerts@example.com&#39;</span>
<span class="w">        </span><span class="nt">auth_password</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;password&#39;</span>
<span class="w">        </span><span class="nt">require_tls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">headers</span><span class="p">:</span>
<span class="w">          </span><span class="nt">Subject</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.GroupLabels.alertname</span><span class="nv"> </span><span class="s">}}:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">.Status</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">        </span><span class="nt">html</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">template</span><span class="nv"> </span><span class="s">&quot;email.default.html&quot;</span><span class="nv"> </span><span class="s">.</span><span class="nv"> </span><span class="s">}}&#39;</span>
</code></pre></div>
<hr />
<h4 id="slack">Slack 接收器<a class="headerlink" href="#slack" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack-alerts&#39;</span>
<span class="w">    </span><span class="nt">slack_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">api_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://hooks.slack.com/services/xxx&#39;</span>
<span class="w">        </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#alerts&#39;</span>
<span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.GroupLabels.alertname</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">        </span><span class="nt">text</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">range</span><span class="nv"> </span><span class="s">.Alerts</span><span class="nv"> </span><span class="s">}}{{</span><span class="nv"> </span><span class="s">.Annotations.description</span><span class="nv"> </span><span class="s">}}{{</span><span class="nv"> </span><span class="s">end</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">        </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">eq</span><span class="nv"> </span><span class="s">.Status</span><span class="nv"> </span><span class="s">&quot;firing&quot;</span><span class="nv"> </span><span class="s">}}danger{{</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">}}good{{</span><span class="nv"> </span><span class="s">end</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">        </span><span class="nt">send_resolved</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<hr />
<h4 id="pagerduty">PagerDuty 接收器<a class="headerlink" href="#pagerduty" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pagerduty-critical&#39;</span>
<span class="w">    </span><span class="nt">pagerduty_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">routing_key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">        </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;critical&#39;</span>
<span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.GroupLabels.alertname</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">        </span><span class="nt">details</span><span class="p">:</span>
<span class="w">          </span><span class="nt">firing</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">template</span><span class="nv"> </span><span class="s">&quot;pagerduty.default.instances&quot;</span><span class="nv"> </span><span class="s">.Alerts.Firing</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">          </span><span class="nt">num_firing</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.Alerts.Firing</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">len</span><span class="nv"> </span><span class="s">}}&#39;</span>
</code></pre></div>
<hr />
<h4 id="webhook">Webhook 接收器<a class="headerlink" href="#webhook" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;webhook-receiver&#39;</span>
<span class="w">    </span><span class="nt">webhook_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;http://example.com/webhook&#39;</span>
<span class="w">        </span><span class="nt">send_resolved</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">max_alerts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w">  </span><span class="c1"># 0 = 无限制</span>
<span class="w">        </span><span class="nt">http_config</span><span class="p">:</span>
<span class="w">          </span><span class="nt">basic_auth</span><span class="p">:</span>
<span class="w">            </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;user&#39;</span>
<span class="w">            </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pass&#39;</span>
</code></pre></div>
<p><strong>Webhook JSON 格式:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;groupKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;firing|resolved&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;receiver&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;groupLabels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">  </span><span class="nt">&quot;commonLabels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">  </span><span class="nt">&quot;commonAnnotations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">  </span><span class="nt">&quot;externalURL&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;alerts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;firing|resolved&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;labels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="nt">&quot;annotations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="nt">&quot;startsAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;rfc3339&gt;&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;endsAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;rfc3339&gt;&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;generatorURL&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;fingerprint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;string&gt;&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h4 id="_94">其他接收器<a class="headerlink" href="#_94" title="Permanent link">&para;</a></h4>
<p><strong>OpsGenie:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">opsgenie_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.GroupLabels.alertname</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">    </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;P1&#39;</span>
<span class="w">    </span><span class="nt">responders</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;team&#39;</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ops-team&#39;</span>
</code></pre></div>
<p><strong>Telegram:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">telegram_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">bot_token</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">    </span><span class="nt">chat_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">123456789</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;🔥</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">.GroupLabels.alertname</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">    </span><span class="nt">parse_mode</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;HTML&#39;</span>
</code></pre></div>
<p><strong>WeChat (微信):</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">wechat_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">api_secret</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">    </span><span class="nt">corp_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">    </span><span class="nt">agent_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1000002&#39;</span>
<span class="w">    </span><span class="nt">to_user</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;user123&#39;</span>
<span class="w">    </span><span class="nt">message_type</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;markdown&#39;</span>
</code></pre></div>
<p><strong>Pushover:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">pushover_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">user_key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">    </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">    </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="w">  </span><span class="c1"># 紧急</span>
<span class="w">    </span><span class="nt">retry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">    </span><span class="nt">expire</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1h</span>
</code></pre></div>
<hr />
<h3 id="148-http">14.8 HTTP 配置<a class="headerlink" href="#148-http" title="Permanent link">&para;</a></h3>
<p><strong>TLS 配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">http_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tls_config</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ca_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/ca.crt</span>
<span class="w">    </span><span class="nt">cert_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/client.crt</span>
<span class="w">    </span><span class="nt">key_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/client.key</span>
<span class="w">    </span><span class="nt">server_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;example.com&#39;</span>
<span class="w">    </span><span class="nt">insecure_skip_verify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<p><strong>Basic 认证:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">http_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">basic_auth</span><span class="p">:</span>
<span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;admin&#39;</span>
<span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;secret&#39;</span>
</code></pre></div>
<p><strong>Bearer Token:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">http_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">authorization</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Bearer&#39;</span>
<span class="w">    </span><span class="nt">credentials</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;token123&#39;</span>
</code></pre></div>
<p><strong>OAuth2:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">http_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">oauth2</span><span class="p">:</span>
<span class="w">    </span><span class="nt">client_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">    </span><span class="nt">client_secret</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">    </span><span class="nt">token_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://auth.example.com/token&#39;</span>
<span class="w">    </span><span class="nt">scopes</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;read&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;write&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>代理配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">http_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">proxy_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;http://proxy.example.com:8080&#39;</span>
<span class="w">  </span><span class="nt">no_proxy</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;127.0.0.1,localhost&#39;</span>
</code></pre></div>
<hr />
<h3 id="149">14.9 完整配置示例<a class="headerlink" href="#149" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">resolve_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">  </span><span class="nt">smtp_smarthost</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;smtp.gmail.com:587&#39;</span>
<span class="w">  </span><span class="nt">smtp_from</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;alertmanager@example.com&#39;</span>
<span class="w">  </span><span class="nt">smtp_auth_username</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;alerts@example.com&#39;</span>
<span class="w">  </span><span class="nt">smtp_auth_password</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;password&#39;</span>
<span class="w">  </span><span class="nt">slack_api_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://hooks.slack.com/services/xxx&#39;</span>

<span class="nt">templates</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;/etc/alertmanager/templates/*.tmpl&#39;</span>

<span class="nt">route</span><span class="p">:</span>
<span class="w">  </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;default&#39;</span>
<span class="w">  </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;alertname&#39;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">group_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12h</span>

<span class="w">  </span><span class="nt">routes</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Critical 告警立即发送</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pagerduty&#39;</span>
<span class="w">      </span><span class="nt">matchers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity=&quot;critical&quot;</span>
<span class="w">      </span><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span>
<span class="w">      </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">      </span><span class="nt">continue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">    </span><span class="c1"># Warning 告警发送到 Slack</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack&#39;</span>
<span class="w">      </span><span class="nt">matchers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity=&quot;warning&quot;</span>

<span class="w">    </span><span class="c1"># 数据库告警</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;database-team&#39;</span>
<span class="w">      </span><span class="nt">matchers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service=~&quot;mysql|postgres&quot;</span>
<span class="w">      </span><span class="nt">mute_time_intervals</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weekends</span>

<span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;default&#39;</span>
<span class="w">    </span><span class="nt">email_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;team@example.com&#39;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pagerduty&#39;</span>
<span class="w">    </span><span class="nt">pagerduty_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">routing_key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack&#39;</span>
<span class="w">    </span><span class="nt">slack_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#alerts&#39;</span>
<span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.GroupLabels.alertname</span><span class="nv"> </span><span class="s">}}&#39;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;database-team&#39;</span>
<span class="w">    </span><span class="nt">email_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dba@example.com&#39;</span>

<span class="nt">inhibit_rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_matchers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity=&quot;critical&quot;</span>
<span class="w">    </span><span class="nt">target_matchers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity=&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">equal</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;alertname&#39;</span><span class="p p-Indicator">]</span>

<span class="nt">time_intervals</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weekends</span>
<span class="w">    </span><span class="nt">time_intervals</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">weekdays</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;saturday&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;sunday&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<hr />
<h3 id="1410">14.10 模板变量<a class="headerlink" href="#1410" title="Permanent link">&para;</a></h3>
<p><strong>常用变量:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 告警状态</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Status</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># firing 或 resolved</span>

<span class="c1"># 标签</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.GroupLabels.alertname</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># 分组标签</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.CommonLabels.instance</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># 公共标签</span>

<span class="c1"># 注解</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.CommonAnnotations.summary</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.CommonAnnotations.description</span><span class="w"> </span><span class="p p-Indicator">}}</span>

<span class="c1"># 告警列表</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">range .Alerts</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">  </span><span class="nt">Instance</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Labels.instance</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">  </span><span class="nt">Summary</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Annotations.summary</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">end</span><span class="w"> </span><span class="p p-Indicator">}}</span>

<span class="c1"># 告警数量</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Alerts.Firing | len</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># Firing 数量</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Alerts.Resolved | len</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># Resolved 数量</span>
</code></pre></div>
<hr />
<h3 id="1411">14.11 验证和测试<a class="headerlink" href="#1411" title="Permanent link">&para;</a></h3>
<p><strong>验证配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查配置文件</span>
amtool<span class="w"> </span>check-config<span class="w"> </span>alertmanager.yml

<span class="c1"># UTF-8 严格模式检查</span>
amtool<span class="w"> </span>check-config<span class="w"> </span>alertmanager.yml<span class="w"> </span>--enable-feature<span class="o">=</span><span class="s2">&quot;utf8-strict-mode&quot;</span>
</code></pre></div>
<p><strong>测试告警:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 发送测试告警</span>
amtool<span class="w"> </span>alert<span class="w"> </span>add<span class="w"> </span><span class="nv">alertname</span><span class="o">=</span><span class="s2">&quot;TestAlert&quot;</span><span class="w"> </span><span class="nv">severity</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="w"> </span><span class="nv">instance</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span>

<span class="c1"># 查看告警</span>
amtool<span class="w"> </span>alert<span class="w"> </span>query

<span class="c1"># 创建静默</span>
amtool<span class="w"> </span>silence<span class="w"> </span>add<span class="w"> </span><span class="nv">alertname</span><span class="o">=</span><span class="s2">&quot;TestAlert&quot;</span><span class="w"> </span>--duration<span class="o">=</span>1h<span class="w"> </span>--comment<span class="o">=</span><span class="s2">&quot;Testing&quot;</span>

<span class="c1"># 查看静默</span>
amtool<span class="w"> </span>silence<span class="w"> </span>query
</code></pre></div>
<hr />
<h3 id="1412">14.12 最佳实践<a class="headerlink" href="#1412" title="Permanent link">&para;</a></h3>
<p><strong>1. 合理的分组策略</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 按集群和告警名称分组</span>
<span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;alertname&#39;</span><span class="p p-Indicator">]</span>

<span class="c1"># ❌ 差 - 禁用聚合(产生大量通知)</span>
<span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;...&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>2. 合理的时间间隔</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span><span class="w">       </span><span class="c1"># 等待更多相同组的告警</span>
<span class="nt">group_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span><span class="w">    </span><span class="c1"># 组内新告警等待时间</span>
<span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4h</span><span class="w">   </span><span class="c1"># 重复发送间隔(应为 group_interval 的倍数)</span>
</code></pre></div>
<p><strong>3. 使用抑制规则</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 上游故障抑制下游告警</span>
<span class="nt">inhibit_rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">source_matchers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertname=&quot;APIDown&quot;</span>
<span class="w">    </span><span class="nt">target_matchers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertname=~&quot;.*Slow|.*Error&quot;</span>
<span class="w">    </span><span class="nt">equal</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;service&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>4. 多级路由</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">routes</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Critical → PagerDuty + Slack</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pagerduty&#39;</span>
<span class="w">    </span><span class="nt">matchers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity=&quot;critical&quot;</span>
<span class="w">    </span><span class="nt">continue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack&#39;</span>
<span class="w">    </span><span class="nt">matchers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">severity=&quot;critical&quot;</span>
</code></pre></div>
<p><strong>5. 使用模板文件</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">templates</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;/etc/alertmanager/templates/*.tmpl&#39;</span>
</code></pre></div>
<p><strong>6. 定期测试</strong></p>
<ul>
<li>定期发送测试告警</li>
<li>验证所有接收器工作正常</li>
<li>测试抑制和静默规则</li>
</ul>
<hr />
<h2 id="_95">配置快速参考<a class="headerlink" href="#_95" title="Permanent link">&para;</a></h2>
<p><strong>路由参数:</strong></p>
<ul>
<li><code>receiver</code> - 接收器名称</li>
<li><code>group_by</code> - 分组标签</li>
<li><code>group_wait</code> - 初始等待 (默认: 30s)</li>
<li><code>group_interval</code> - 组内间隔 (默认: 5m)</li>
<li><code>repeat_interval</code> - 重复间隔 (默认: 4h)</li>
<li><code>matchers</code> - 匹配器列表</li>
<li><code>continue</code> - 继续匹配 (默认: false)</li>
<li><code>mute_time_intervals</code> - 静默时间段</li>
<li><code>active_time_intervals</code> - 激活时间段</li>
</ul>
<p><strong>抑制参数:</strong></p>
<ul>
<li><code>source_matchers</code> - 源告警匹配器</li>
<li><code>target_matchers</code> - 目标告警匹配器</li>
<li><code>equal</code> - 相等标签列表</li>
</ul>
<p><strong>接收器类型:</strong></p>
<ul>
<li><code>email_configs</code> - 邮件</li>
<li><code>slack_configs</code> - Slack</li>
<li><code>pagerduty_configs</code> - PagerDuty</li>
<li><code>webhook_configs</code> - Webhook</li>
<li><code>opsgenie_configs</code> - OpsGenie</li>
<li><code>telegram_configs</code> - Telegram</li>
<li><code>wechat_configs</code> - 微信</li>
<li><code>pushover_configs</code> - Pushover</li>
<li><code>discord_configs</code> - Discord</li>
<li><code>msteams_configs</code> - Microsoft Teams</li>
<li><code>victorops_configs</code> - VictorOps</li>
<li><code>sns_configs</code> - AWS SNS</li>
<li><code>webex_configs</code> - Webex</li>
</ul>
<hr />
<h2 id="15-notification-examples">15. Notification Examples (通知示例)<a class="headerlink" href="#15-notification-examples" title="Permanent link">&para;</a></h2>
<p>以下是使用 Go 模板系统的 Alertmanager 通知配置示例。</p>
<h3 id="151-slack">15.1 自定义 Slack 通知<a class="headerlink" href="#151-slack" title="Permanent link">&para;</a></h3>
<p><strong>添加 Wiki 链接:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">slack_api_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://hooks.slack.com/services/xxx&#39;</span>

<span class="nt">route</span><span class="p">:</span>
<span class="w">  </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack-notifications&#39;</span>
<span class="w">  </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">alertname</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">datacenter</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">app</span><span class="p p-Indicator">]</span>

<span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack-notifications&#39;</span>
<span class="w">    </span><span class="nt">slack_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#alerts&#39;</span>
<span class="w">        </span><span class="nt">text</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://internal.myorg.net/wiki/alerts/{{</span><span class="nv"> </span><span class="s">.GroupLabels.app</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">.GroupLabels.alertname</span><span class="nv"> </span><span class="s">}}&#39;</span>
</code></pre></div>
<p><strong>效果:</strong> 根据告警的 <code>app</code> 和 <code>alertname</code> 标签,自动生成对应的 Wiki 文档链接。</p>
<hr />
<h3 id="152-annotations">15.2 访问注解 (Annotations)<a class="headerlink" href="#152-annotations" title="Permanent link">&para;</a></h3>
<p><strong>Prometheus 告警规则:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Instances</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InstanceDown</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">up == 0</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">page</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Instance</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">down&#39;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">job</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.job</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">down</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">than</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">minutes.&#39;</span>
</code></pre></div>
<p><strong>Alertmanager 接收器:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;team-x&#39;</span>
<span class="w">    </span><span class="nt">slack_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#alerts&#39;</span>
<span class="w">        </span><span class="nt">text</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">&lt;!channel&gt;</span>
<span class="w">          </span><span class="no">summary: {{ .CommonAnnotations.summary }}</span>
<span class="w">          </span><span class="no">description: {{ .CommonAnnotations.description }}</span>
</code></pre></div>
<p><strong>关键点:</strong></p>
<ul>
<li><code>{{ .CommonAnnotations.summary }}</code> - 访问公共注解中的摘要</li>
<li><code>{{ .CommonAnnotations.description }}</code> - 访问公共注解中的描述</li>
<li><code>&lt;!channel&gt;</code> - Slack 的 @channel 提及</li>
</ul>
<hr />
<h3 id="153">15.3 遍历所有告警<a class="headerlink" href="#153" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;default-receiver&#39;</span>
<span class="w">    </span><span class="nt">slack_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#alerts&#39;</span>
<span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">{{ range .Alerts }}{{ .Annotations.summary }}</span>
<span class="w">          </span><span class="no">{{ end }}</span>
<span class="w">        </span><span class="nt">text</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">{{ range .Alerts }}{{ .Annotations.description }}</span>
<span class="w">          </span><span class="no">{{ end }}</span>
</code></pre></div>
<p><strong>效果:</strong> 遍历所有接收到的告警,每个告警的摘要和描述各占一行。</p>
<hr />
<h3 id="154">15.4 定义可复用模板<a class="headerlink" href="#154" title="Permanent link">&para;</a></h3>
<p><strong>步骤 1: 创建模板文件 <code>/etc/alertmanager/templates/myorg.tmpl</code></strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{{</span><span class="w"> </span><span class="nx">define</span><span class="w"> </span><span class="s">&quot;slack.myorg.text&quot;</span><span class="w"> </span><span class="p">}}</span>
<span class="nx">https</span><span class="p">:</span><span class="c1">//internal.myorg.net/wiki/alerts/{{ .GroupLabels.app }}/{{ .GroupLabels.alertname }}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>

<span class="p">{{</span><span class="w"> </span><span class="nx">define</span><span class="w"> </span><span class="s">&quot;slack.myorg.title&quot;</span><span class="w"> </span><span class="p">}}</span>
<span class="err">🚨</span><span class="w"> </span><span class="p">[{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">toUpper</span><span class="w"> </span><span class="p">}}]</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">GroupLabels</span><span class="p">.</span><span class="nx">alertname</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>

<span class="p">{{</span><span class="w"> </span><span class="nx">define</span><span class="w"> </span><span class="s">&quot;email.subject&quot;</span><span class="w"> </span><span class="p">}}</span>
<span class="p">[{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="p">}}]</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">GroupLabels</span><span class="p">.</span><span class="nx">alertname</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="p">({{</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="p">.</span><span class="nx">Firing</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="nx">firing</span><span class="p">)</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>
</code></pre></div>
<p><strong>步骤 2: 在配置中引用模板</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">slack_api_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://hooks.slack.com/services/xxx&#39;</span>

<span class="nt">templates</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;/etc/alertmanager/templates/myorg.tmpl&#39;</span>

<span class="nt">route</span><span class="p">:</span>
<span class="w">  </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack-notifications&#39;</span>
<span class="w">  </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">alertname</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">datacenter</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">app</span><span class="p p-Indicator">]</span>

<span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;slack-notifications&#39;</span>
<span class="w">    </span><span class="nt">slack_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#alerts&#39;</span>
<span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">template</span><span class="nv"> </span><span class="s">&quot;slack.myorg.title&quot;</span><span class="nv"> </span><span class="s">.</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">        </span><span class="nt">text</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">template</span><span class="nv"> </span><span class="s">&quot;slack.myorg.text&quot;</span><span class="nv"> </span><span class="s">.</span><span class="nv"> </span><span class="s">}}&#39;</span>
</code></pre></div>
<hr />
<h3 id="155">15.5 更多实用模板示例<a class="headerlink" href="#155" title="Permanent link">&para;</a></h3>
<p><strong>1. 显示告警数量和列表</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">  </span><span class="no">{{ .GroupLabels.alertname }} ({{ .Alerts.Firing | len }} firing, {{ .Alerts.Resolved | len }} resolved)</span>

<span class="nt">text</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">  </span><span class="no">🔥 *Firing:*</span>
<span class="w">  </span><span class="no">{{ range .Alerts.Firing }}</span>
<span class="w">  </span><span class="no">• {{ .Labels.instance }}: {{ .Annotations.summary }}</span>
<span class="w">  </span><span class="no">{{ end }}</span>

<span class="w">  </span><span class="no">✅ *Resolved:*</span>
<span class="w">  </span><span class="no">{{ range .Alerts.Resolved }}</span>
<span class="w">  </span><span class="no">• {{ .Labels.instance }}: {{ .Annotations.summary }}</span>
<span class="w">  </span><span class="no">{{ end }}</span>
</code></pre></div>
<hr />
<p><strong>2. 根据严重程度设置颜色</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">slack_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#alerts&#39;</span>
<span class="w">    </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">{{ if eq .Status &quot;firing&quot; }}</span>
<span class="w">        </span><span class="no">{{ if eq .CommonLabels.severity &quot;critical&quot; }}danger{{ else if eq .CommonLabels.severity &quot;warning&quot; }}warning{{ else }}#439FE0{{ end }}</span>
<span class="w">      </span><span class="no">{{ else }}good{{ end }}</span>
</code></pre></div>
<hr />
<p><strong>3. 格式化时间</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">text</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">  </span><span class="no">Started: {{ .Alerts.Firing | len }} alerts at {{ .CommonAnnotations.startsAt }}</span>
<span class="w">  </span><span class="no">{{ range .Alerts }}</span>
<span class="w">  </span><span class="no">- {{ .Labels.instance }} ({{ .StartsAt.Format &quot;2006-01-02 15:04:05&quot; }})</span>
<span class="w">  </span><span class="no">{{ end }}</span>
</code></pre></div>
<hr />
<p><strong>4. 添加 Prometheus 查询链接</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">text</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">  </span><span class="no">{{ range .Alerts }}</span>
<span class="w">  </span><span class="no">Instance: {{ .Labels.instance }}</span>
<span class="w">  </span><span class="no">Query: {{ .GeneratorURL }}</span>
<span class="w">  </span><span class="no">{{ end }}</span>
</code></pre></div>
<hr />
<p><strong>5. Email 通知模板</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">receivers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;email-team&#39;</span>
<span class="w">    </span><span class="nt">email_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;team@example.com&#39;</span>
<span class="w">        </span><span class="nt">headers</span><span class="p">:</span>
<span class="w">          </span><span class="nt">Subject</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">template</span><span class="nv"> </span><span class="s">&quot;email.subject&quot;</span><span class="nv"> </span><span class="s">.</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">        </span><span class="nt">html</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">&lt;!DOCTYPE html&gt;</span>
<span class="w">          </span><span class="no">&lt;html&gt;</span>
<span class="w">          </span><span class="no">&lt;head&gt;</span>
<span class="w">            </span><span class="no">&lt;style&gt;</span>
<span class="w">              </span><span class="no">.firing { background-color: #ff0000; color: white; }</span>
<span class="w">              </span><span class="no">.resolved { background-color: #00ff00; color: black; }</span>
<span class="w">            </span><span class="no">&lt;/style&gt;</span>
<span class="w">          </span><span class="no">&lt;/head&gt;</span>
<span class="w">          </span><span class="no">&lt;body&gt;</span>
<span class="w">            </span><span class="no">&lt;h2&gt;{{ .GroupLabels.alertname }}&lt;/h2&gt;</span>
<span class="w">            </span><span class="no">&lt;p&gt;&lt;strong&gt;Status:&lt;/strong&gt; {{ .Status }}&lt;/p&gt;</span>
<span class="w">            </span><span class="no">&lt;p&gt;&lt;strong&gt;Severity:&lt;/strong&gt; {{ .CommonLabels.severity }}&lt;/p&gt;</span>

<span class="w">            </span><span class="no">&lt;h3&gt;Firing Alerts ({{ .Alerts.Firing | len }})&lt;/h3&gt;</span>
<span class="w">            </span><span class="no">&lt;ul&gt;</span>
<span class="w">            </span><span class="no">{{ range .Alerts.Firing }}</span>
<span class="w">              </span><span class="no">&lt;li class=&quot;firing&quot;&gt;</span>
<span class="w">                </span><span class="no">&lt;strong&gt;{{ .Labels.instance }}&lt;/strong&gt;&lt;br/&gt;</span>
<span class="w">                </span><span class="no">{{ .Annotations.description }}</span>
<span class="w">              </span><span class="no">&lt;/li&gt;</span>
<span class="w">            </span><span class="no">{{ end }}</span>
<span class="w">            </span><span class="no">&lt;/ul&gt;</span>

<span class="w">            </span><span class="no">&lt;h3&gt;Resolved Alerts ({{ .Alerts.Resolved | len }})&lt;/h3&gt;</span>
<span class="w">            </span><span class="no">&lt;ul&gt;</span>
<span class="w">            </span><span class="no">{{ range .Alerts.Resolved }}</span>
<span class="w">              </span><span class="no">&lt;li class=&quot;resolved&quot;&gt;</span>
<span class="w">                </span><span class="no">&lt;strong&gt;{{ .Labels.instance }}&lt;/strong&gt;&lt;br/&gt;</span>
<span class="w">                </span><span class="no">Resolved at {{ .EndsAt.Format &quot;2006-01-02 15:04:05&quot; }}</span>
<span class="w">              </span><span class="no">&lt;/li&gt;</span>
<span class="w">            </span><span class="no">{{ end }}</span>
<span class="w">            </span><span class="no">&lt;/ul&gt;</span>
<span class="w">          </span><span class="no">&lt;/body&gt;</span>
<span class="w">          </span><span class="no">&lt;/html&gt;</span>
</code></pre></div>
<hr />
<p><strong>6. PagerDuty 自定义详情</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">pagerduty_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">routing_key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;xxx&#39;</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.GroupLabels.alertname</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">    </span><span class="nt">details</span><span class="p">:</span>
<span class="w">      </span><span class="nt">firing</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">template</span><span class="nv"> </span><span class="s">&quot;pagerduty.default.instances&quot;</span><span class="nv"> </span><span class="s">.Alerts.Firing</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">      </span><span class="nt">num_firing</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.Alerts.Firing</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">len</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">      </span><span class="nt">num_resolved</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.Alerts.Resolved</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">len</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">      </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">.CommonLabels.cluster</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">      </span><span class="nt">runbook</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://runbooks.example.com/{{</span><span class="nv"> </span><span class="s">.GroupLabels.alertname</span><span class="nv"> </span><span class="s">}}&#39;</span>
</code></pre></div>
<hr />
<p><strong>7. Webhook JSON 自定义</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">webhook_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;http://example.com/webhook&#39;</span>
<span class="w">    </span><span class="nt">send_resolved</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<p><strong>接收到的 JSON 可通过代码处理:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/webhook&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">webhook</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>

    <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;alerts&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alert: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;alertname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instance: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summary: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>
</code></pre></div>
<hr />
<h3 id="156">15.6 模板函数<a class="headerlink" href="#156" title="Permanent link">&para;</a></h3>
<p><strong>常用函数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 字符串操作</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.CommonLabels.alertname | toUpper</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">    </span><span class="c1"># 大写</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.CommonLabels.alertname | toLower</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">    </span><span class="c1"># 小写</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.CommonLabels.alertname | title</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">      </span><span class="c1"># 首字母大写</span>

<span class="c1"># 列表操作</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Alerts.Firing | len</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">                 </span><span class="c1"># 长度</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">index .Alerts 0</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">                      </span><span class="c1"># 索引</span>

<span class="c1"># 条件判断</span>
<span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">if eq .Status &quot;firing&quot;</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">Firing{{ else }}Resolved{{ end }}</span>
<span class="l l-Scalar l-Scalar-Plain">{{ if gt (.Alerts.Firing | len) 5 }}Too many alerts!{{ end }}</span>

<span class="l l-Scalar l-Scalar-Plain"># 时间格式化</span>
<span class="l l-Scalar l-Scalar-Plain">{{ .StartsAt.Format &quot;2006-01-02 15:04:05&quot; }}</span>
<span class="l l-Scalar l-Scalar-Plain">{{ .EndsAt.Format &quot;15:04&quot; }}</span>
</code></pre></div>
<hr />
<h3 id="157">15.7 完整模板文件示例<a class="headerlink" href="#157" title="Permanent link">&para;</a></h3>
<p><strong><code>/etc/alertmanager/templates/custom.tmpl</code></strong></p>
<div class="highlight"><pre><span></span><code><span class="p">{{</span><span class="w"> </span><span class="nx">define</span><span class="w"> </span><span class="s">&quot;slack.title&quot;</span><span class="w"> </span><span class="p">}}</span>
<span class="p">[{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">toUpper</span><span class="w"> </span><span class="p">}}]</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">GroupLabels</span><span class="p">.</span><span class="nx">alertname</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>

<span class="p">{{</span><span class="w"> </span><span class="nx">define</span><span class="w"> </span><span class="s">&quot;slack.text&quot;</span><span class="w"> </span><span class="p">}}</span>
<span class="o">*</span><span class="nx">Cluster</span><span class="p">:</span><span class="o">*</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">CommonLabels</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">}}</span>
<span class="o">*</span><span class="nx">Severity</span><span class="p">:</span><span class="o">*</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">CommonLabels</span><span class="p">.</span><span class="nx">severity</span><span class="w"> </span><span class="p">}}</span>

<span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">gt</span><span class="w"> </span><span class="p">(</span><span class="nx">len</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="p">.</span><span class="nx">Firing</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}}</span>
<span class="err">🔥</span><span class="w"> </span><span class="o">*</span><span class="nx">Firing</span><span class="w"> </span><span class="p">({{</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="p">.</span><span class="nx">Firing</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="p">}}):</span><span class="o">*</span>
<span class="p">{{</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="p">.</span><span class="nx">Firing</span><span class="w"> </span><span class="p">}}</span>
<span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="o">*</span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Labels</span><span class="p">.</span><span class="nx">instance</span><span class="w"> </span><span class="p">}}</span><span class="o">*</span>
<span class="w">    </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Annotations</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="p">}}</span>
<span class="w">    </span><span class="p">&lt;{{</span><span class="w"> </span><span class="p">.</span><span class="nx">GeneratorURL</span><span class="w"> </span><span class="p">}}</span><span class="o">|</span><span class="nx">View</span><span class="w"> </span><span class="nx">Query</span><span class="p">&gt;</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>

<span class="p">{{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">gt</span><span class="w"> </span><span class="p">(</span><span class="nx">len</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="p">.</span><span class="nx">Resolved</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}}</span>
<span class="err">✅</span><span class="w"> </span><span class="o">*</span><span class="nx">Resolved</span><span class="w"> </span><span class="p">({{</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="p">.</span><span class="nx">Resolved</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="p">}}):</span><span class="o">*</span>
<span class="p">{{</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="p">.</span><span class="nx">Resolved</span><span class="w"> </span><span class="p">}}</span>
<span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Labels</span><span class="p">.</span><span class="nx">instance</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>

<span class="p">{{</span><span class="w"> </span><span class="nx">define</span><span class="w"> </span><span class="s">&quot;email.subject&quot;</span><span class="w"> </span><span class="p">}}</span>
<span class="p">[{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="p">}}]</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">GroupLabels</span><span class="p">.</span><span class="nx">alertname</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">CommonLabels</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>

<span class="p">{{</span><span class="w"> </span><span class="nx">define</span><span class="w"> </span><span class="s">&quot;email.html&quot;</span><span class="w"> </span><span class="p">}}</span>
<span class="p">&lt;</span><span class="nx">h2</span><span class="p">&gt;{{</span><span class="w"> </span><span class="p">.</span><span class="nx">GroupLabels</span><span class="p">.</span><span class="nx">alertname</span><span class="w"> </span><span class="p">}}&lt;</span><span class="o">/</span><span class="nx">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nx">table</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nx">tr</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;</span><span class="nx">Status</span><span class="p">:&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="p">}}&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="o">/</span><span class="nx">tr</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nx">tr</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;</span><span class="nx">Severity</span><span class="p">:&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;{{</span><span class="w"> </span><span class="p">.</span><span class="nx">CommonLabels</span><span class="p">.</span><span class="nx">severity</span><span class="w"> </span><span class="p">}}&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="o">/</span><span class="nx">tr</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nx">tr</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;</span><span class="nx">Cluster</span><span class="p">:&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;{{</span><span class="w"> </span><span class="p">.</span><span class="nx">CommonLabels</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">}}&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="o">/</span><span class="nx">tr</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nx">tr</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;</span><span class="nx">Firing</span><span class="p">:&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="p">.</span><span class="nx">Firing</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="p">}}&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="o">/</span><span class="nx">tr</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nx">tr</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;</span><span class="nx">Resolved</span><span class="p">:&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="nx">td</span><span class="p">&gt;{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="p">.</span><span class="nx">Resolved</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="p">}}&lt;</span><span class="o">/</span><span class="nx">td</span><span class="p">&gt;&lt;</span><span class="o">/</span><span class="nx">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">table</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nx">h3</span><span class="p">&gt;</span><span class="nx">Details</span><span class="p">&lt;</span><span class="o">/</span><span class="nx">h3</span><span class="p">&gt;</span>
<span class="p">{{</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="p">.</span><span class="nx">Alerts</span><span class="w"> </span><span class="p">}}</span>
<span class="p">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">style</span><span class="p">=</span><span class="s">&quot;border-left: 3px solid {{ if eq .Status &quot;</span><span class="nx">firing</span><span class="s">&quot; }}red{{ else }}green{{ end }}; padding-left: 10px; margin: 10px 0;&quot;</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nx">strong</span><span class="p">&gt;{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Labels</span><span class="p">.</span><span class="nx">instance</span><span class="w"> </span><span class="p">}}&lt;</span><span class="o">/</span><span class="nx">strong</span><span class="p">&gt;&lt;</span><span class="nx">br</span><span class="o">/</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">Annotations</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="p">}}&lt;</span><span class="nx">br</span><span class="o">/</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nx">small</span><span class="p">&gt;</span><span class="nx">Started</span><span class="p">:</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="nx">StartsAt</span><span class="p">.</span><span class="nx">Format</span><span class="w"> </span><span class="s">&quot;2006-01-02 15:04:05&quot;</span><span class="w"> </span><span class="p">}}&lt;</span><span class="o">/</span><span class="nx">small</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">div</span><span class="p">&gt;</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>
<span class="p">{{</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">}}</span>
</code></pre></div>
<hr />
<h2 id="16-alertmanager-management-api">16. Alertmanager Management API<a class="headerlink" href="#16-alertmanager-management-api" title="Permanent link">&para;</a></h2>
<p>Alertmanager 提供管理 API 用于自动化和集成。</p>
<h3 id="161">16.1 健康检查<a class="headerlink" href="#161" title="Permanent link">&para;</a></h3>
<p><strong>端点:</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w">  </span>/-/healthy
HEAD<span class="w"> </span>/-/healthy
</code></pre></div>
<p><strong>用途:</strong> 检查 Alertmanager 是否运行</p>
<p><strong>返回:</strong> 始终返回 <code>200</code></p>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查健康状态</span>
curl<span class="w"> </span>http://localhost:9093/-/healthy

<span class="c1"># 仅检查状态码</span>
curl<span class="w"> </span>-I<span class="w"> </span>http://localhost:9093/-/healthy
</code></pre></div>
<p><strong>Kubernetes 存活探针:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">livenessProbe</span><span class="p">:</span>
<span class="w">  </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/-/healthy</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9093</span>
<span class="w">  </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">  </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div>
<hr />
<h3 id="162">16.2 就绪检查<a class="headerlink" href="#162" title="Permanent link">&para;</a></h3>
<p><strong>端点:</strong></p>
<div class="highlight"><pre><span></span><code>GET<span class="w">  </span>/-/ready
HEAD<span class="w"> </span>/-/ready
</code></pre></div>
<p><strong>用途:</strong> 检查 Alertmanager 是否准备好处理流量</p>
<p><strong>返回:</strong> 准备好时返回 <code>200</code>,否则返回 <code>503</code></p>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>http://localhost:9093/-/ready
</code></pre></div>
<p><strong>Kubernetes 就绪探针:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">readinessProbe</span><span class="p">:</span>
<span class="w">  </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/-/ready</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9093</span>
<span class="w">  </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">  </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</code></pre></div>
<hr />
<h3 id="163">16.3 重载配置<a class="headerlink" href="#163" title="Permanent link">&para;</a></h3>
<p><strong>端点:</strong></p>
<div class="highlight"><pre><span></span><code>POST<span class="w"> </span>/-/reload
</code></pre></div>
<p><strong>用途:</strong> 触发配置文件重新加载</p>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9093/-/reload
</code></pre></div>
<p><strong>替代方法 - SIGHUP 信号:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查找进程 ID</span>
ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>alertmanager

<span class="c1"># 发送 SIGHUP 信号</span>
<span class="nb">kill</span><span class="w"> </span>-HUP<span class="w"> </span>&lt;PID&gt;

<span class="c1"># 或使用 systemd</span>
systemctl<span class="w"> </span>reload<span class="w"> </span>alertmanager
</code></pre></div>
<hr />
<h3 id="164">16.4 自动化脚本示例<a class="headerlink" href="#164" title="Permanent link">&para;</a></h3>
<p><strong>配置更新脚本:</strong></p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># update-alertmanager-config.sh</span>

<span class="nv">CONFIG_FILE</span><span class="o">=</span><span class="s2">&quot;/etc/alertmanager/alertmanager.yml&quot;</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s2">&quot;/etc/alertmanager/backups&quot;</span>
<span class="nv">ALERTMANAGER_URL</span><span class="o">=</span><span class="s2">&quot;http://localhost:9093&quot;</span>

<span class="c1"># 创建备份</span>
<span class="nv">timestamp</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d_%H%M%S<span class="k">)</span>
cp<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONFIG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BACKUP_DIR</span><span class="s2">/alertmanager_</span><span class="si">${</span><span class="nv">timestamp</span><span class="si">}</span><span class="s2">.yml&quot;</span>

<span class="c1"># 验证新配置</span>
<span class="k">if</span><span class="w"> </span>amtool<span class="w"> </span>check-config<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONFIG_FILE</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ Configuration is valid&quot;</span>

<span class="w">    </span><span class="c1"># 重载配置</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ALERTMANAGER_URL</span><span class="si">}</span><span class="s2">/-/reload&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ Configuration reloaded successfully&quot;</span>

<span class="w">        </span><span class="c1"># 验证就绪状态</span>
<span class="w">        </span>sleep<span class="w"> </span><span class="m">2</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span>curl<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ALERTMANAGER_URL</span><span class="si">}</span><span class="s2">/-/ready&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ Alertmanager is ready&quot;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;⚠️  Alertmanager not ready, check logs&quot;</span>
<span class="w">            </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;❌ Failed to reload configuration&quot;</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;❌ Configuration is invalid&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>
</code></pre></div>
<hr />
<p><strong>健康监控脚本:</strong></p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">ALERTMANAGER_URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:9093&quot;</span>

<span class="k">def</span> <span class="nf">check_health</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ALERTMANAGER_URL</span><span class="si">}</span><span class="s2">/-/healthy&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">check_ready</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ALERTMANAGER_URL</span><span class="si">}</span><span class="s2">/-/ready&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">healthy</span> <span class="o">=</span> <span class="n">check_health</span><span class="p">()</span>
        <span class="n">ready</span> <span class="o">=</span> <span class="n">check_ready</span><span class="p">()</span>

        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;✅&quot;</span> <span class="k">if</span> <span class="n">healthy</span> <span class="ow">and</span> <span class="n">ready</span> <span class="k">else</span> <span class="s2">&quot;❌&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> Health: </span><span class="si">{</span><span class="n">healthy</span><span class="si">}</span><span class="s2"> | Ready: </span><span class="si">{</span><span class="n">ready</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">healthy</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔴 Alertmanager is not healthy!&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<hr />
<p><strong>CI/CD 集成示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># GitLab CI</span>
<span class="nt">deploy-alertmanager</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 验证配置</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">amtool check-config alertmanager.yml</span>

<span class="w">    </span><span class="c1"># 部署配置</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl create configmap alertmanager-config \</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">--from-file=alertmanager.yml \</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">--dry-run=client -o yaml | kubectl apply -f -</span>

<span class="w">    </span><span class="c1"># 触发重载</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl exec -n monitoring alertmanager-0 -- \</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">wget --post-data=&quot;&quot; -O- http://localhost:9093/-/reload</span>

<span class="w">    </span><span class="c1"># 验证就绪</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep 5</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl exec -n monitoring alertmanager-0 -- \</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">wget -O- http://localhost:9093/-/ready</span>
</code></pre></div>
<hr />
<p><strong>Docker Compose 健康检查:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>
<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">alertmanager</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prom/alertmanager:latest</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alertmanager</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;9093:9093&quot;</span>
<span class="w">    </span><span class="nt">healthcheck</span><span class="p">:</span>
<span class="w">      </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;CMD&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;wget&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--spider&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-q&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;http://localhost:9093/-/healthy&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">      </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">      </span><span class="nt">start_period</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">40s</span>
</code></pre></div>
<hr />
<h3 id="165-api">16.5 API 使用最佳实践<a class="headerlink" href="#165-api" title="Permanent link">&para;</a></h3>
<p><strong>1. 在配置更新前验证</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 先验证再重载</span>
amtool<span class="w"> </span>check-config<span class="w"> </span>alertmanager.yml<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9093/-/reload

<span class="c1"># ❌ 差 - 直接重载可能导致错误</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9093/-/reload
</code></pre></div>
<p><strong>2. 使用就绪检查而非健康检查</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 使用就绪检查确保可以处理流量</span>
curl<span class="w"> </span>http://localhost:9093/-/ready

<span class="c1"># ⚠️  健康检查只表明进程存活,不代表可以处理请求</span>
curl<span class="w"> </span>http://localhost:9093/-/healthy
</code></pre></div>
<p><strong>3. 重载后验证</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 重载配置</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:9093/-/reload

<span class="c1"># 等待并验证</span>
sleep<span class="w"> </span><span class="m">2</span>
curl<span class="w"> </span>http://localhost:9093/-/ready<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Reload may have failed&quot;</span>
</code></pre></div>
<p><strong>4. 自动重启失败的实例</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># systemd service 配置</span>
<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">RestartSec</span><span class="o">=</span>5s
</code></pre></div>
<p><strong>5. 日志监控</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 监控重载操作</span>
journalctl<span class="w"> </span>-u<span class="w"> </span>alertmanager<span class="w"> </span>-f<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;reload&quot;</span>

<span class="c1"># 或 Docker logs</span>
docker<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>alertmanager<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;reload&quot;</span>
</code></pre></div>
<hr />
<h2 id="_96">总结<a class="headerlink" href="#_96" title="Permanent link">&para;</a></h2>
<p><strong>Notification Examples (通知示例):</strong></p>
<ul>
<li>自定义 Slack 通知文本和格式</li>
<li>访问和使用告警注解</li>
<li>遍历所有告警</li>
<li>定义可复用模板文件</li>
<li>丰富的模板函数和示例</li>
</ul>
<p><strong>Management API (管理API):</strong></p>
<ul>
<li><code>/-/healthy</code> - 健康检查</li>
<li><code>/-/ready</code> - 就绪检查</li>
<li><code>/-/reload</code> - 重载配置</li>
<li>自动化脚本和 CI/CD 集成</li>
<li>最佳实践</li>
</ul>
<p>这两个章节提供了实用的模板和自动化方案,帮助运维人员高效管理 Alertmanager!</p>
<hr />
<h2 id="17-practices">17. Practices (最佳实践)<a class="headerlink" href="#17-practices" title="Permanent link">&para;</a></h2>
<h3 id="171-naming">17.1 Naming (命名规范)<a class="headerlink" href="#171-naming" title="Permanent link">&para;</a></h3>
<p>指标和标签命名约定不是强制的,但可作为风格指南和最佳实践集合。</p>
<h4 id="_97">指标名称规范<a class="headerlink" href="#_97" title="Permanent link">&para;</a></h4>
<p><strong>必须 (MUST):</strong></p>
<ol>
<li><strong>符合数据模型的有效字符</strong></li>
<li><strong>具有应用前缀(命名空间)</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好</span>
<span class="nv">prometheus_notifications_total</span><span class="w">    </span><span class="c1"># Prometheus 服务器特定</span>
<span class="nv">process_cpu_seconds_total</span><span class="w">         </span><span class="c1"># 客户端库导出</span>
<span class="nv">http_request_duration_seconds</span><span class="w">     </span><span class="c1"># 所有 HTTP 请求</span>

<span class="c1"># ❌ 差</span>
<span class="nv">notifications_total</span><span class="w">               </span><span class="c1"># 缺少前缀</span>
</code></pre></div>
<ol>
<li><strong>使用单一单位</strong>(不混用秒和毫秒,秒和字节)</li>
<li><strong>使用基础单位</strong>(秒、字节、米,而非毫秒、兆字节、千米)</li>
<li><strong>具有复数形式的单位后缀</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好</span>
<span class="nv">http_request_duration_seconds</span>
<span class="nv">node_memory_usage_bytes</span>
<span class="nv">http_requests_total</span><span class="w">                </span><span class="c1"># 无单位累积计数</span>
<span class="nv">process_cpu_seconds_total</span><span class="w">          </span><span class="c1"># 带单位累积计数</span>
<span class="nv">foobar_build_info</span><span class="w">                  </span><span class="c1"># 元数据伪指标</span>
<span class="nv">data_pipeline_last_processed_timestamp_seconds</span>

<span class="c1"># ❌ 差</span>
<span class="nv">http_request_duration_ms</span><span class="w">          </span><span class="c1"># 应使用秒</span>
<span class="nv">node_memory_usage_megabytes</span><span class="w">       </span><span class="c1"># 应使用字节</span>
<span class="nv">http_request_total</span><span class="w">                </span><span class="c1"># 单数形式</span>
</code></pre></div>
<p><strong>建议 (SHOULD):</strong></p>
<ol>
<li><strong>按词法排序时的便利分组</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 公共组件在前,相关指标排在一起</span>
<span class="nv">prometheus_tsdb_head_truncations_closed_total</span>
<span class="nv">prometheus_tsdb_head_truncations_established_total</span>
<span class="nv">prometheus_tsdb_head_truncations_failed_total</span>
<span class="nv">prometheus_tsdb_head_truncations_total</span>

<span class="c1"># 也可以 - 更易读但可能分散</span>
<span class="nv">prometheus_tsdb_head_closed_truncations_total</span>
<span class="nv">prometheus_tsdb_head_established_truncations_total</span>
</code></pre></div>
<ol>
<li><strong>跨所有标签维度表示相同的逻辑测量对象</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - sum() 或 avg() 有意义</span>
<span class="nv">request_duration_seconds</span>
<span class="nv">bytes_transferred</span>
<span class="nv">resource_usage_ratio</span>

<span class="c1"># ❌ 差 - sum() 无意义(混合了不同类型)</span>
<span class="nv">queue_capacity_and_size</span><span class="w">  </span><span class="c1"># 混合容量和当前大小</span>
</code></pre></div>
<hr />
<h4 id="_98">为什么在名称中包含单位和类型?<a class="headerlink" href="#_98" title="Permanent link">&para;</a></h4>
<p><strong>Prometheus 强烈建议包含单位和类型,原因:</strong></p>
<ol>
<li>
<p><strong>指标消费可靠性和 UX</strong></p>
</li>
<li>
<p>纯 YAML 配置中可直接理解指标类型和单位</p>
</li>
<li>有助于事件响应时快速理解 PromQL 表达式</li>
<li>
<p><strong>避免指标冲突</strong></p>
</li>
<li>
<p>随着采用增长,缺少单位信息会导致序列冲突</p>
</li>
<li>例如 <code>process_cpu</code> 可能是秒或毫秒</li>
</ol>
<hr />
<h4 id="_99">标签规范<a class="headerlink" href="#_99" title="Permanent link">&para;</a></h4>
<p><strong>使用标签区分测量对象的特征:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好</span>
<span class="l l-Scalar l-Scalar-Plain">api_http_requests_total{operation=&quot;create|update|delete&quot;}</span>
<span class="l l-Scalar l-Scalar-Plain">api_request_duration_seconds{stage=&quot;extract|transform|load&quot;}</span>

<span class="l l-Scalar l-Scalar-Plain"># ❌ 差 - 标签名在指标名中</span>
<span class="l l-Scalar l-Scalar-Plain">api_http_requests_create_total</span>
<span class="l l-Scalar l-Scalar-Plain">api_http_requests_update_total</span>
<span class="l l-Scalar l-Scalar-Plain">api_http_requests_delete_total</span>
</code></pre></div>
<p><strong>注意事项:</strong></p>
<blockquote>
<p>⚠️ <strong>警告:</strong> 每个唯一的键值标签对组合代表一个新时间序列,会显著增加存储数据量。</p>
<p><strong>不要使用高基数标签:</strong></p>
<ul>
<li>❌ 用户 ID</li>
<li>❌ 邮箱地址</li>
<li>❌ 其他无界值集合</li>
</ul>
</blockquote>
<hr />
<h4 id="_100">基础单位<a class="headerlink" href="#_100" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>类别</th>
<th>基础单位</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Time</strong></td>
<td><code>seconds</code></td>
<td></td>
</tr>
<tr>
<td><strong>Temperature</strong></td>
<td><code>celsius</code></td>
<td>首选 celsius 而非 kelvin(实用性)</td>
</tr>
<tr>
<td><strong>Length</strong></td>
<td><code>meters</code></td>
<td></td>
</tr>
<tr>
<td><strong>Bytes</strong></td>
<td><code>bytes</code></td>
<td></td>
</tr>
<tr>
<td><strong>Bits</strong></td>
<td><code>bytes</code></td>
<td>始终使用 bytes 避免混淆</td>
</tr>
<tr>
<td><strong>Percent</strong></td>
<td><code>ratio</code></td>
<td>值为 0-1(而非 0-100),后缀为 <code>_ratio</code></td>
</tr>
<tr>
<td><strong>Voltage</strong></td>
<td><code>volts</code></td>
<td></td>
</tr>
<tr>
<td><strong>Electric current</strong></td>
<td><code>amperes</code></td>
<td></td>
</tr>
<tr>
<td><strong>Energy</strong></td>
<td><code>joules</code></td>
<td></td>
</tr>
<tr>
<td><strong>Power</strong></td>
<td>-</td>
<td>优先导出 counter of joules,用 <code>rate(joules[5m])</code> 得到瓦特</td>
</tr>
<tr>
<td><strong>Mass</strong></td>
<td><code>grams</code></td>
<td>优先 grams 而非 kilograms 以避免 kilo 前缀问题</td>
</tr>
</tbody>
</table>
<p><strong>百分比示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好</span>
<span class="nv">disk_usage_ratio</span><span class="w">  </span><span class="c1"># 值范围 0.0 - 1.0</span>
<span class="nv">cpu_usage_ratio</span>

<span class="c1"># 或使用模式 A_per_B</span>
<span class="nv">requests_per_second</span>
<span class="nv">errors_per_requests</span>
</code></pre></div>
<hr />
<h3 id="172-instrumentation">17.2 Instrumentation (埋点)<a class="headerlink" href="#172-instrumentation" title="Permanent link">&para;</a></h3>
<h4 id="_101">如何埋点<a class="headerlink" href="#_101" title="Permanent link">&para;</a></h4>
<p><strong>简短答案:</strong> 埋点一切!</p>
<ul>
<li>每个库、子系统和服务至少应有几个指标</li>
<li>埋点应是代码的组成部分</li>
<li>在使用指标的同一文件中实例化指标类</li>
</ul>
<hr />
<h4 id="_102">三种服务类型<a class="headerlink" href="#_102" title="Permanent link">&para;</a></h4>
<p><strong>1. Online-Serving Systems (在线服务系统)</strong></p>
<ul>
<li>人类或系统期待即时响应</li>
<li>例如:数据库、HTTP 请求</li>
</ul>
<p><strong>关键指标:</strong></p>
<ul>
<li>执行的查询数</li>
<li>错误数</li>
<li>延迟</li>
<li>进行中的请求数(可选)</li>
</ul>
<p><strong>最佳实践:</strong></p>
<ul>
<li>✅ 在客户端和服务器端都监控</li>
<li>✅ 记录请求结束时(而非开始时)</li>
<li>✅ 只在栈中一个点监控延迟(避免重复告警)</li>
</ul>
<hr />
<p><strong>2. Offline Processing (离线处理)</strong></p>
<ul>
<li>无人主动等待响应</li>
<li>通常批量处理</li>
</ul>
<p><strong>关键指标(每个阶段):</strong></p>
<ul>
<li>进入的项目数</li>
<li>进行中的项目数</li>
<li>最后处理时间</li>
<li>发出的项目数</li>
</ul>
<p><strong>心跳技巧:</strong>
发送带时间戳的虚拟项目通过系统,导出最近心跳时间戳。</p>
<hr />
<p><strong>3. Batch Jobs (批处理任务)</strong></p>
<ul>
<li>不连续运行</li>
<li>抓取困难</li>
</ul>
<p><strong>关键指标:</strong></p>
<ul>
<li>最后成功时间 (✅ 最重要)</li>
<li>各阶段耗时</li>
<li>总运行时间</li>
<li>最后完成时间</li>
<li>处理的记录总数</li>
</ul>
<p><strong>推送到 PushGateway:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Batch job 结束时推送指标</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;batch_job_last_success </span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>curl<span class="w"> </span>--data-binary<span class="w"> </span>@-<span class="w"> </span>http://pushgateway:9091/metrics/job/batch_job
</code></pre></div>
<p><strong>最佳实践:</strong></p>
<ul>
<li>批处理运行超过几分钟 → 也使用 pull 监控</li>
<li>运行频率超过每 15 分钟 → 考虑转为守护进程</li>
</ul>
<hr />
<h4 id="_103">子系统埋点<a class="headerlink" href="#_103" title="Permanent link">&para;</a></h4>
<p><strong>Libraries (库):</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 库自动埋点</span>
<span class="kn">import</span> <span class="nn">prometheus_client</span> <span class="k">as</span> <span class="nn">prom</span>

<span class="n">db_query_duration</span> <span class="o">=</span> <span class="n">prom</span><span class="o">.</span><span class="n">Histogram</span><span class="p">(</span>
    <span class="s1">&#39;db_query_duration_seconds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Database query duration&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;operation&#39;</span><span class="p">]</span>  <span class="c1"># 区分不同资源</span>
<span class="p">)</span>

<span class="nd">@db_query_duration</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">query_users</span><span class="p">():</span>
    <span class="c1"># ...</span>
</code></pre></div>
<p><strong>Logging (日志):</strong></p>
<ul>
<li>每一行日志代码 → 对应一个 counter</li>
<li>多个相关日志 → 可共享一个 counter</li>
<li>导出 info/error/warning 总行数</li>
</ul>
<p><strong>Failures (失败):</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">http_requests_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;http_requests_total&#39;</span><span class="p">,</span> <span class="s1">&#39;Total requests&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
<span class="n">http_request_errors</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;http_request_errors_total&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed requests&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>

<span class="c1"># 记录总数和失败数,方便计算失败率</span>
<span class="n">http_requests_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;200&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<span class="n">http_request_errors</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;timeout&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
</code></pre></div>
<p><strong>Threadpools (线程池):</strong></p>
<ul>
<li>排队请求数</li>
<li>使用中的线程数</li>
<li>总线程数</li>
<li>处理的任务数</li>
<li>任务耗时</li>
<li>排队等待时间</li>
</ul>
<p><strong>Caches (缓存):</strong></p>
<ul>
<li>总查询数</li>
<li>命中数</li>
<li>总延迟</li>
<li>后端系统的查询数、错误数、延迟</li>
</ul>
<hr />
<h4 id="_104">需要注意的事项<a class="headerlink" href="#_104" title="Permanent link">&para;</a></h4>
<p><strong>1. 使用标签</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 单个指标 + 标签</span>
<span class="nv">http_responses_total</span><span class="p">{</span><span class="nl">code</span><span class="o">=</span><span class="p">&quot;</span><span class="s">500</span><span class="p">&quot;}</span>
<span class="nv">http_responses_total</span><span class="p">{</span><span class="nl">code</span><span class="o">=</span><span class="p">&quot;</span><span class="s">403</span><span class="p">&quot;}</span>
<span class="nv">http_responses_total</span><span class="p">{</span><span class="nl">code</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;}</span>

<span class="c1"># ❌ 差 - 多个指标</span>
<span class="nv">http_responses_500_total</span>
<span class="nv">http_responses_403_total</span>
<span class="nv">http_responses_200_total</span>
</code></pre></div>
<p><strong>规则:</strong> 指标名称的任何部分都不应程序化生成(使用标签代替)</p>
<hr />
<p><strong>2. 不要过度使用标签</strong></p>
<p><strong>成本:</strong></p>
<ul>
<li>每个 labelset 增加 RAM、CPU、磁盘和网络开销</li>
</ul>
<p><strong>指导原则:</strong></p>
<ul>
<li>保持基数 &lt; 10</li>
<li>超过 10 的指标,整个系统限制在少数几个</li>
<li>大多数指标应无标签</li>
</ul>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 可接受 - node_exporter 在 10k 节点上</span>
<span class="c1"># 每个节点约 10 个文件系统 = 100k 时间序列</span>
<span class="nv">node_filesystem_avail</span>

<span class="c1"># ❌ 不可接受 - 添加用户配额</span>
<span class="c1"># 10k 用户 × 10k 节点 = 1 亿时间序列 (太多!)</span>
<span class="nv">node_filesystem_user_quota</span>
</code></pre></div>
<p><strong>最佳实践:</strong></p>
<ul>
<li>✅ 从无标签开始</li>
<li>✅ 根据具体用例逐步添加标签</li>
</ul>
<hr />
<p><strong>3. Counter vs. Gauge, Summary vs. Histogram</strong></p>
<p><strong>简单规则:</strong></p>
<ul>
<li>值能下降 → <code>Gauge</code></li>
<li>值只能上升 → <code>Counter</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Counter - 只能增加(或重置)</span>
<span class="n">http_requests_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>         <span class="c1"># ✅</span>
<span class="n">bytes_transferred_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>     <span class="c1"># ✅</span>

<span class="c1"># Gauge - 可上可下</span>
<span class="n">memory_usage_bytes</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>            <span class="c1"># ✅</span>
<span class="n">in_progress_requests</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>          <span class="c1"># ✅</span>
<span class="n">temperature_celsius</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>           <span class="c1"># ✅</span>

<span class="c1"># ❌ 错误用法</span>
<span class="n">rate</span><span class="p">(</span><span class="n">gauge_metric</span><span class="p">[</span><span class="mi">5</span><span class="n">m</span><span class="p">])</span>  <span class="c1"># 不要对 Gauge 使用 rate()</span>
</code></pre></div>
<hr />
<p><strong>4. 时间戳,而非"时间间隔"</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 导出 Unix 时间戳</span>
<span class="n">last_success_timestamp_seconds</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">last_success_timestamp_seconds</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

<span class="c1"># 查询时计算间隔</span>
<span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_success_timestamp_seconds</span>

<span class="c1"># ❌ 差 - 导出间隔(需要更新逻辑)</span>
<span class="n">time_since_last_success_seconds</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<hr />
<p><strong>5. 避免缺失指标</strong></p>
<p><strong>问题:</strong> 直到事件发生才出现的时间序列难以处理</p>
<p><strong>解决方案:</strong> 预先导出默认值(如 0)</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 大多数客户端库自动导出 0</span>
<span class="n">errors_total</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;errors_total&#39;</span><span class="p">,</span> <span class="s1">&#39;Errors&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
<span class="c1"># 即使从未调用,也会显示为 0</span>

<span class="c1"># 手动初始化所有已知标签组合</span>
<span class="k">for</span> <span class="n">error_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="s1">&#39;parse&#39;</span><span class="p">]:</span>
    <span class="n">errors_total</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error_type</span><span class="p">)</span>
</code></pre></div>
<hr />
<p><strong>6. 内循环优化</strong></p>
<p><strong>性能关键代码 (&gt; 100k 调用/秒):</strong></p>
<ul>
<li>Java counter 增量: 12-17ns</li>
<li>限制内循环中的指标更新</li>
<li>避免标签(或缓存标签查找结果)</li>
<li>注意涉及时间/持续时间的指标(可能涉及系统调用)</li>
</ul>
<p><strong>最佳实践:</strong> 使用基准测试确定影响</p>
<hr />
<h3 id="173-histograms">17.3 Histograms (直方图)<a class="headerlink" href="#173-histograms" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>注意:</strong> 本文档早于原生直方图(v2.40 实验性,v3.8 稳定)。</p>
</blockquote>
<h4 id="count-sum">Count 和 Sum<a class="headerlink" href="#count-sum" title="Permanent link">&para;</a></h4>
<p>Histograms 和 Summaries 都采样观测值,跟踪:</p>
<ul>
<li>观测数量 (<code>_count</code> 后缀) - Counter</li>
<li>观测值总和 (<code>_sum</code> 后缀) - Counter (如无负值)</li>
</ul>
<p><strong>计算平均值:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 过去 5 分钟的平均请求时长</span>
<span class="w">  </span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_sum</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)</span>
<span class="o">/</span>
<span class="w">  </span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_count</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)</span>
</code></pre></div>
<hr />
<h4 id="apdex">Apdex 分数<a class="headerlink" href="#apdex" title="Permanent link">&para;</a></h4>
<p><strong>SLO 示例:</strong> 95% 请求在 300ms 内</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 300ms 内的请求比例</span>
<span class="w">  </span><span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.3</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">job</span><span class="o">)</span>
<span class="o">/</span>
<span class="w">  </span><span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_count</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">job</span><span class="o">)</span>
</code></pre></div>
<p><strong>Apdex 分数计算:</strong></p>
<ul>
<li>目标: 300ms</li>
<li>容忍: 1.2s</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">(</span>
<span class="w">    </span><span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.3</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">job</span><span class="o">)</span>
<span class="w">  </span><span class="o">+</span>
<span class="w">    </span><span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">1.2</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">job</span><span class="o">)</span>
<span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_count</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">job</span><span class="o">)</span>
</code></pre></div>
<blockquote>
<p>注意:除以 2 是因为桶是累积的</p>
</blockquote>
<hr />
<h4 id="quantiles">Quantiles (分位数)<a class="headerlink" href="#quantiles" title="Permanent link">&para;</a></h4>
<p><strong>φ-quantile:</strong> φ*N 排名的观测值 (0 ≤ φ ≤ 1)</p>
<ul>
<li>0.5-quantile = 中位数</li>
<li>0.95-quantile = 95<sup>th</sup> 百分位</li>
</ul>
<p><strong>Histogram vs. Summary:</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Histogram</th>
<th>Summary</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>配置</strong></td>
<td>选择适合范围的桶</td>
<td>选择所需 φ-quantiles 和滑动窗口</td>
</tr>
<tr>
<td><strong>客户端性能</strong></td>
<td>非常便宜(仅增加计数器)</td>
<td>昂贵(流式分位数计算)</td>
</tr>
<tr>
<td><strong>服务器性能</strong></td>
<td>需计算分位数</td>
<td>低成本</td>
</tr>
<tr>
<td><strong>时间序列数</strong></td>
<td>每个桶一个</td>
<td>每个分位数一个</td>
</tr>
<tr>
<td><strong>分位数误差</strong></td>
<td>受桶宽度限制</td>
<td>受配置值限制</td>
</tr>
<tr>
<td><strong>规范</strong></td>
<td>Ad-hoc(PromQL)</td>
<td>客户端预配置</td>
</tr>
<tr>
<td><strong>聚合</strong></td>
<td>✅ 可聚合</td>
<td>❌ 通常不可聚合</td>
</tr>
</tbody>
</table>
<p><strong>关键区别 - 聚合:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ 差 - Summary 平均分位数无统计意义</span>
<span class="k">avg</span><span class="o">(</span><span class="nv">http_request_duration_seconds</span><span class="p">{</span><span class="nl">quantile</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.95</span><span class="p">&quot;}</span><span class="o">)</span>

<span class="c1"># ✅ 好 - Histogram 可正确聚合</span>
<span class="kr">histogram_quantile</span><span class="o">(</span><span class="mf">0.95</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">le</span><span class="o">))</span>
</code></pre></div>
<hr />
<h4 id="_105">选择建议<a class="headerlink" href="#_105" title="Permanent link">&para;</a></h4>
<p><strong>两条经验法则:</strong></p>
<ol>
<li><strong>需要聚合 → Histogram</strong></li>
<li>
<p><strong>其他情况:</strong></p>
</li>
<li>
<p>知道值的范围和分布 → <strong>Histogram</strong></p>
</li>
<li>需要精确分位数,无论范围和分布 → <strong>Summary</strong></li>
</ol>
<hr />
<h4 id="_106">分位数误差<a class="headerlink" href="#_106" title="Permanent link">&para;</a></h4>
<p><strong>Histogram 误差示例:</strong></p>
<p>桶配置: <code>{le="0.1"}</code>, <code>{le="0.2"}</code>, <code>{le="0.3"}</code>, <code>{le="0.45"}</code></p>
<ul>
<li>真实 95<sup>th</sup> 是 220ms</li>
<li>Histogram 计算为 295ms(线性插值在 200-300ms 桶中)</li>
</ul>
<p><strong>Summary 误差示例:</strong></p>
<p>配置: <code>0.95±0.01</code> (94<sup>th</sup> 到 96<sup>th</sup> 之间)</p>
<ul>
<li>如果分布范围宽,94<sup>th</sup>(270ms) 和 96<sup>th</sup>(330ms) 差异大</li>
<li>可能在 SLO 内外都不确定</li>
</ul>
<p><strong>结论:</strong></p>
<ul>
<li>Histogram: 控制观测值维度的误差</li>
<li>Summary: 控制 φ 维度的误差</li>
</ul>
<hr />
<h3 id="174-alerting">17.4 Alerting (告警最佳实践)<a class="headerlink" href="#174-alerting" title="Permanent link">&para;</a></h3>
<h4 id="_107">核心原则<a class="headerlink" href="#_107" title="Permanent link">&para;</a></h4>
<p><strong>简单化告警:</strong></p>
<ul>
<li>仅告警症状(symptoms),而非每个可能原因</li>
<li>告警应关联终端用户痛点</li>
<li>告警应链接到相关控制台</li>
<li>允许容错以适应小波动</li>
</ul>
<hr />
<h4 id="_108">告警命名<a class="headerlink" href="#_108" title="Permanent link">&para;</a></h4>
<p><strong>推荐:</strong> 使用 CamelCase</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 推荐</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighRequestLatency</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DatabaseDown</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceUnavailable</span>

<span class="c1"># 也可以,但不推荐</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high_request_latency</span>
</code></pre></div>
<hr />
<h4 id="_109">告警内容<a class="headerlink" href="#_109" title="Permanent link">&para;</a></h4>
<p><strong>Online-Serving Systems:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latency_errors</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># ✅ 好 - 在栈顶层告警高延迟</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighLatency</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) &gt; 1</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>

<span class="w">      </span><span class="c1"># ✅ 好 - 告警用户可见错误</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighErrorRate</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(http_requests_total{status=~&quot;5..&quot;}[5m]) &gt; 0.05</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>

<span class="w">      </span><span class="c1"># ❌ 差 - 不要在多个层级告警延迟</span>
<span class="w">      </span><span class="c1"># 如果用户延迟正常,底层慢不需要告警</span>
</code></pre></div>
<p><strong>Offline Processing:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ProcessingStalled</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time() - pipeline_last_processed_timestamp_seconds &gt; 3600</span>
<span class="w">  </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Pipeline</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.pipeline</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">stalled&quot;</span>
</code></pre></div>
<p><strong>Batch Jobs:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BatchJobFailed</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time() - batch_job_last_success_timestamp_seconds &gt; 14400</span><span class="w">  </span><span class="c1"># 4 hours</span>
<span class="w">  </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0m</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Batch</span><span class="nv"> </span><span class="s">job</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.job</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">hasn&#39;t</span><span class="nv"> </span><span class="s">succeeded</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">4</span><span class="nv"> </span><span class="s">hours&quot;</span>

<span class="c1"># 批处理运行间隔 4h,耗时 1h</span>
<span class="c1"># 阈值至少 2 倍完整运行时间(10h 合理)</span>
</code></pre></div>
<hr />
<h4 id="_110">容量告警<a class="headerlink" href="#_110" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DiskSpaceWarning</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node_filesystem_avail_bytes / node_filesystem_size_bytes &lt; 0.15</span>
<span class="w">  </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30m</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DiskSpaceCritical</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node_filesystem_avail_bytes / node_filesystem_size_bytes &lt; 0.05</span>
<span class="w">  </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
</code></pre></div>
<hr />
<h4 id="metamonitoring">元监控 (Metamonitoring)<a class="headerlink" href="#metamonitoring" title="Permanent link">&para;</a></h4>
<p><strong>监控监控基础设施本身:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 症状检测(黑盒测试)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AlertingPipelineBroken</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">up{job=&quot;blackbox-test&quot;} == 0</span>
<span class="w">  </span><span class="c1"># 测试: 告警从 PushGateway → Prometheus → Alertmanager → Email</span>

<span class="c1"># 也可以 - 单组件告警</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PrometheusDown</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">up{job=&quot;prometheus&quot;} == 0</span>
</code></pre></div>
<p><strong>补充白盒监控:</strong></p>
<ul>
<li>外部黑盒监控捕获不可见问题</li>
<li>内部系统完全失败时的备用方案</li>
</ul>
<hr />
<h3 id="175-recording-rules">17.5 Recording Rules (记录规则)<a class="headerlink" href="#175-recording-rules" title="Permanent link">&para;</a></h3>
<h4 id="_111">命名约定<a class="headerlink" href="#_111" title="Permanent link">&para;</a></h4>
<p><strong>格式:</strong> <code>level:metric:operations</code></p>
<ul>
<li><code>level</code> - 聚合级别和标签</li>
<li><code>metric</code> - 指标名称(从 counter 去除 <code>_total</code>,使用 rate/irate 时)</li>
<li><code>operations</code> - 操作列表(最新操作在前)</li>
</ul>
<p><strong>示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># level = instance_path (有 instance 和 path 标签)</span>
<span class="c1"># metric = requests</span>
<span class="c1"># operations = rate5m (5分钟 rate)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance_path:requests:rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(requests_total[5m])</span>

<span class="c1"># level = path (只有 path 标签,聚合掉 instance)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path:requests:rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum without (instance)(instance_path:requests:rate5m)</span>
</code></pre></div>
<hr />
<h4 id="_112">命名规则<a class="headerlink" href="#_112" title="Permanent link">&para;</a></h4>
<p><strong>简化操作:</strong></p>
<ul>
<li>省略 <code>_sum</code>(如有其他操作)</li>
<li>合并结合操作 (<code>min_min</code> = <code>min</code>)</li>
<li>无明显操作时使用 <code>sum</code></li>
<li>比率操作用 <code>_per_</code> 分隔,操作称为 <code>ratio</code></li>
</ul>
<p><strong>平均观测大小:</strong></p>
<ul>
<li>去除 <code>_count</code>/<code>_sum</code> 后缀</li>
<li>用 <code>mean</code> 替换 <code>rate</code></li>
</ul>
<hr />
<h4 id="_113">聚合规则<a class="headerlink" href="#_113" title="Permanent link">&para;</a></h4>
<p><strong>规则 1: 聚合比率时,分别聚合分子和分母</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ 差 - 不要平均比率或平均的平均</span>
<span class="l l-Scalar l-Scalar-Plain">avg(instance:requests_per_errors:ratio)</span>

<span class="l l-Scalar l-Scalar-Plain"># ✅ 好 - 分别聚合后再除</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">sum(instance:requests:rate5m)</span>
<span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">sum(instance:errors:rate5m)</span>
</code></pre></div>
<p><strong>规则 2: 始终指定 without子句</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 保留其他标签(job 等)</span>
<span class="l l-Scalar l-Scalar-Plain">sum without (instance)(instance_path:requests:rate5m)</span>

<span class="l l-Scalar l-Scalar-Plain"># ❌ 差 - 可能丢失有用标签</span>
<span class="l l-Scalar l-Scalar-Plain">sum(instance_path:requests:rate5m)</span>
</code></pre></div>
<hr />
<h4 id="_114">完整示例<a class="headerlink" href="#_114" title="Permanent link">&para;</a></h4>
<p><strong>聚合请求率:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 1: 实例+路径级别</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance_path:requests:rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(requests_total{job=&quot;myjob&quot;}[5m])</span>

<span class="c1"># Step 2: 路径级别(聚合掉 instance)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path:requests:rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sum without (instance)(instance_path:requests:rate5m{job=&quot;myjob&quot;})</span>
</code></pre></div>
<p><strong>失败率比例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 1: 失败率</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance_path:request_failures:rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(request_failures_total{job=&quot;myjob&quot;}[5m])</span>

<span class="c1"># Step 2: 实例+路径级别比率</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance_path:request_failures_per_requests:ratio_rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|2</span>
<span class="w">      </span><span class="no">instance_path:request_failures:rate5m{job=&quot;myjob&quot;}</span>
<span class="w">    </span><span class="no">/</span>
<span class="w">      </span><span class="no">instance_path:requests:rate5m{job=&quot;myjob&quot;}</span>

<span class="c1"># Step 3: 路径级别比率(正确聚合)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path:request_failures_per_requests:ratio_rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|2</span>
<span class="w">      </span><span class="no">sum without (instance)(instance_path:request_failures:rate5m{job=&quot;myjob&quot;})</span>
<span class="w">    </span><span class="no">/</span>
<span class="w">      </span><span class="no">sum without (instance)(instance_path:requests:rate5m{job=&quot;myjob&quot;})</span>

<span class="c1"># Step 4: Job 级别比率</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job:request_failures_per_requests:ratio_rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|2</span>
<span class="w">      </span><span class="no">sum without (instance, path)(instance_path:request_failures:rate5m{job=&quot;myjob&quot;})</span>
<span class="w">    </span><span class="no">/</span>
<span class="w">      </span><span class="no">sum without (instance, path)(instance_path:requests:rate5m{job=&quot;myjob&quot;})</span>
</code></pre></div>
<p><strong>平均延迟(Summary):</strong></p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance_path:request_latency_seconds_count:rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(request_latency_seconds_count{job=&quot;myjob&quot;}[5m])</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance_path:request_latency_seconds_sum:rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(request_latency_seconds_sum{job=&quot;myjob&quot;}[5m])</span>

<span class="c1"># mean 替换 rate(因为是平均观测大小)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance_path:request_latency_seconds:mean5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|2</span>
<span class="w">      </span><span class="no">instance_path:request_latency_seconds_sum:rate5m{job=&quot;myjob&quot;}</span>
<span class="w">    </span><span class="no">/</span>
<span class="w">      </span><span class="no">instance_path:request_latency_seconds_count:rate5m{job=&quot;myjob&quot;}</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path:request_latency_seconds:mean5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|2</span>
<span class="w">      </span><span class="no">sum without (instance)(instance_path:request_latency_seconds_sum:rate5m{job=&quot;myjob&quot;})</span>
<span class="w">    </span><span class="no">/</span>
<span class="w">      </span><span class="no">sum without (instance)(instance_path:request_latency_seconds_count:rate5m{job=&quot;myjob&quot;})</span>
</code></pre></div>
<p><strong>平均速率(avg 函数):</strong></p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job:request_latency_seconds_count:avg_rate5m</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">avg without (instance, path)(instance_path:request_latency_seconds_count:rate5m{job=&quot;myjob&quot;})</span>
</code></pre></div>
<p><strong>验证规则:</strong></p>
<ul>
<li>聚合时,without 子句中的标签从输出 level 中移除</li>
<li>无聚合时,level 始终匹配</li>
<li>如果不匹配,规则可能有错误</li>
</ul>
<hr />
<h3 id="176-pushing-metrics">17.6 Pushing Metrics (推送指标)<a class="headerlink" href="#176-pushing-metrics" title="Permanent link">&para;</a></h3>
<h4 id="pushgateway">何时使用 Pushgateway?<a class="headerlink" href="#pushgateway" title="Permanent link">&para;</a></h4>
<p><strong>仅限特定情况,不建议盲目使用</strong></p>
<h4 id="pushgateway_1">Pushgateway 的问题<a class="headerlink" href="#pushgateway_1" title="Permanent link">&para;</a></h4>
<p><strong>问题 1: 单点故障和瓶颈</strong></p>
<ul>
<li>多实例通过单个 Pushgateway → 成为瓶颈</li>
</ul>
<p><strong>问题 2: 失去自动健康监控</strong></p>
<ul>
<li>丢失 Prometheus 的 <code>up</code> 指标(每次抓取生成)</li>
</ul>
<p><strong>问题 3: 永不遗忘</strong></p>
<ul>
<li>Pushgateway 永远不会忘记推送的序列</li>
<li>必须手动通过 API 删除</li>
<li>实例重命名/删除后指标仍然存在</li>
<li>需要手动同步生命周期</li>
</ul>
<hr />
<h4 id="_115">唯一有效用例<a class="headerlink" href="#_115" title="Permanent link">&para;</a></h4>
<p><strong>Service-Level Batch Jobs:</strong></p>
<ul>
<li>与特定机器/实例语义无关的批处理</li>
<li>例如:为整个服务删除用户的批处理</li>
</ul>
<p><strong>特点:</strong></p>
<ul>
<li>指标不应包含 <code>machine</code> 或 <code>instance</code> 标签</li>
<li>减少管理 Pushgateway 中过期指标的负担</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - Service-level batch job</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;user_cleanup_total 150&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>curl<span class="w"> </span>--data-binary<span class="w"> </span>@-<span class="w"> </span>http://pushgateway:9091/metrics/job/user_cleanup

<span class="c1"># ❌ 差 - Machine-specific batch job</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;backup_size_bytes 1073741824&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>curl<span class="w"> </span>--data-binary<span class="w"> </span>@-<span class="w"> </span>http://pushgateway:9091/metrics/job/backup/instance/server1
</code></pre></div>
<hr />
<h4 id="_116">替代策略<a class="headerlink" href="#_116" title="Permanent link">&para;</a></h4>
<p><strong>1. 防火墙/NAT 问题:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 将 Prometheus 移到网络屏障内</span>
<span class="c1"># 或使用 PushProx</span>
</code></pre></div>
<p><strong>PushProx 架构:</strong></p>
<ul>
<li>Proxy 在网络外部</li>
<li>Targets 主动连接到 proxy</li>
<li>Prometheus 通过 proxy 拉取</li>
</ul>
<p><strong>2. 机器相关批处理任务:</strong></p>
<p>使用 Node Exporter 的 <strong>textfile collector</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 好 - 使用 textfile collector</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>/var/lib/node_exporter/textfile_collector/backup.prom<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s"># HELP backup_last_success_timestamp Last successful backup time</span>
<span class="s"># TYPE backup_last_success_timestamp gauge</span>
<span class="s">backup_last_success_timestamp $(date +%s)</span>
<span class="s"># HELP backup_size_bytes Size of last backup</span>
<span class="s"># TYPE backup_size_bytes gauge</span>
<span class="s">backup_size_bytes 1073741824</span>
<span class="s">EOF</span>
</code></pre></div>
<p><strong>优点:</strong></p>
<ul>
<li>自动生命周期管理</li>
<li>机器宕机时指标自动消失</li>
<li>无需管理 Pushgateway</li>
</ul>
<hr />
<h4 id="_117">最佳实践总结<a class="headerlink" href="#_117" title="Permanent link">&para;</a></h4>
<p><strong>Pushgateway 使用检查清单:</strong></p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 是 service-level batch job?(不是特定机器)</li>
<li class="task-list-item"><input type="checkbox" disabled/> 指标不包含 instance/machine 标签?</li>
<li class="task-list-item"><input type="checkbox" disabled/> 可以手动管理指标生命周期?</li>
</ul>
<p><strong>如果任何一项为 No → 使用替代方案:</strong></p>
<ul>
<li>机器相关批处理 → Node Exporter textfile collector</li>
<li>防火墙问题 → PushProx 或移动 Prometheus</li>
<li>其他情况 → 重新考虑架构</li>
</ul>
<hr />
<h2 id="practices">Practices 快速参考<a class="headerlink" href="#practices" title="Permanent link">&para;</a></h2>
<p><strong>Naming (命名):</strong></p>
<ul>
<li>应用前缀 + 基础单位 + 复数后缀</li>
<li>基数 &lt; 10,避免高基数标签</li>
</ul>
<p><strong>Instrumentation (埋点):</strong></p>
<ul>
<li>Counter vs Gauge:值能下降用 Gauge</li>
<li>导出时间戳,而非时间间隔</li>
<li>避免缺失指标,预初始化</li>
</ul>
<p><strong>Histograms:</strong></p>
<ul>
<li>需要聚合 → Histogram</li>
<li>需要精确分位数 → Summary</li>
</ul>
<p><strong>Alerting:</strong></p>
<ul>
<li>告警症状而非原因</li>
<li>关联用户痛点</li>
<li>在栈顶层告警</li>
</ul>
<p><strong>Recording Rules:</strong></p>
<ul>
<li>格式:<code>level:metric:operations</code></li>
<li>始终用 without 子句</li>
<li>聚合比率时分别聚合分子和分母</li>
</ul>
<p><strong>Pushing:</strong></p>
<ul>
<li>仅用于 service-level batch jobs</li>
<li>机器相关任务 → textfile collector</li>
<li>防火墙问题 → PushProx</li>
</ul>
<hr />
<hr />
<h2 id="18-exporters">18. Exporters (导出器列表)<a class="headerlink" href="#18-exporters" title="Permanent link">&para;</a></h2>
<p>以下是 Prometheus 官方和第三方 Exporter 列表,涵盖各种系统、服务和应用。</p>
<h3 id="databases">Databases (数据库)<a class="headerlink" href="#databases" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>Aerospike exporter</td>
<td><a href="https://github.com/aerospike/aerospike-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>AWS RDS exporter</td>
<td><a href="https://github.com/qonto/prometheus-rds-exporter">GitHub</a></td>
</tr>
<tr>
<td>ClickHouse exporter</td>
<td><a href="https://github.com/f1yegor/clickhouse_exporter">GitHub</a></td>
</tr>
<tr>
<td>Consul exporter 🏅</td>
<td><a href="https://github.com/prometheus/consul_exporter">GitHub</a></td>
</tr>
<tr>
<td>Couchbase exporter</td>
<td><a href="https://github.com/couchbase/couchbase-exporter">GitHub</a></td>
</tr>
<tr>
<td>CouchDB exporter</td>
<td><a href="https://github.com/gesellix/couchdb-exporter">GitHub</a></td>
</tr>
<tr>
<td>Druid exporter</td>
<td><a href="https://github.com/opstree/druid-exporter">GitHub</a></td>
</tr>
<tr>
<td>Elasticsearch exporter</td>
<td><a href="https://github.com/prometheus-community/elasticsearch_exporter">GitHub</a></td>
</tr>
<tr>
<td>EventStore exporter</td>
<td><a href="https://github.com/marcinbudny/eventstore_exporter">GitHub</a></td>
</tr>
<tr>
<td>IoTDB exporter</td>
<td><a href="https://github.com/fagnercarvalho/prometheus-iotdb-exporter">GitHub</a></td>
</tr>
<tr>
<td>KDB+ exporter</td>
<td><a href="https://github.com/KxSystems/prometheus-kdb-exporter">GitHub</a></td>
</tr>
<tr>
<td>Memcached exporter 🏅</td>
<td><a href="https://github.com/prometheus/memcached_exporter">GitHub</a></td>
</tr>
<tr>
<td>MongoDB exporter</td>
<td><a href="https://github.com/percona/mongodb_exporter">GitHub</a></td>
</tr>
<tr>
<td>MongoDB query exporter</td>
<td><a href="https://github.com/raffis/mongodb-query-exporter">GitHub</a></td>
</tr>
<tr>
<td>MongoDB Node.js Driver exporter</td>
<td><a href="https://github.com/christiangalsterer/mongodb-driver-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>MSSQL server exporter</td>
<td><a href="https://github.com/awaragi/prometheus-mssql-exporter">GitHub</a></td>
</tr>
<tr>
<td>MySQL router exporter</td>
<td><a href="https://github.com/rluisr/mysqlrouter_exporter">GitHub</a></td>
</tr>
<tr>
<td>MySQL server exporter 🏅</td>
<td><a href="https://github.com/prometheus/mysqld_exporter">GitHub</a></td>
</tr>
<tr>
<td>OpenTSDB exporter</td>
<td><a href="https://github.com/cloudflare/opentsdb_exporter">GitHub</a></td>
</tr>
<tr>
<td>Oracle DB exporter</td>
<td><a href="https://github.com/iamseth/oracledb_exporter">GitHub</a></td>
</tr>
<tr>
<td>PgBouncer exporter</td>
<td><a href="https://github.com/prometheus-community/pgbouncer_exporter">GitHub</a></td>
</tr>
<tr>
<td>PostgreSQL exporter</td>
<td><a href="https://github.com/prometheus-community/postgres_exporter">GitHub</a></td>
</tr>
<tr>
<td>Presto exporter</td>
<td><a href="https://github.com/yahoojapan/presto_exporter">GitHub</a></td>
</tr>
<tr>
<td>ProxySQL exporter</td>
<td><a href="https://github.com/percona/proxysql_exporter">GitHub</a></td>
</tr>
<tr>
<td>RavenDB exporter</td>
<td><a href="https://github.com/marcinbudny/ravendb_exporter">GitHub</a></td>
</tr>
<tr>
<td>Redis exporter</td>
<td><a href="https://github.com/oliver006/redis_exporter">GitHub</a></td>
</tr>
<tr>
<td>RethinkDB exporter</td>
<td><a href="https://github.com/oliver006/rethinkdb_exporter">GitHub</a></td>
</tr>
<tr>
<td>SQL exporter</td>
<td><a href="https://github.com/burningalchemist/sql_exporter">GitHub</a></td>
</tr>
<tr>
<td>Tarantool metric library</td>
<td><a href="https://github.com/tarantool/metrics">GitHub</a></td>
</tr>
<tr>
<td>Twemproxy exporter</td>
<td><a href="https://github.com/stuartnelson3/twemproxy_exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="hardware-related">Hardware Related (硬件相关)<a class="headerlink" href="#hardware-related" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>apcupsd exporter</td>
<td><a href="https://github.com/mdlayher/apcupsd_exporter">GitHub</a></td>
</tr>
<tr>
<td>BIG-IP exporter</td>
<td><a href="https://github.com/ExpressenAB/bigip_exporter">GitHub</a></td>
</tr>
<tr>
<td>Bosch Sensortec BMP/BME exporter</td>
<td><a href="https://github.com/David-Igou/bsbmp-exporter">GitHub</a></td>
</tr>
<tr>
<td>Collins exporter</td>
<td><a href="https://github.com/soundcloud/collins_exporter">GitHub</a></td>
</tr>
<tr>
<td>Dell Hardware OMSA exporter</td>
<td><a href="https://github.com/galexrt/dellhw_exporter">GitHub</a></td>
</tr>
<tr>
<td>Disk usage exporter</td>
<td><a href="https://github.com/dundee/disk_usage_exporter">GitHub</a></td>
</tr>
<tr>
<td>Fortigate exporter</td>
<td><a href="https://github.com/bluecmd/fortigate_exporter">GitHub</a></td>
</tr>
<tr>
<td>IBM Z HMC exporter</td>
<td><a href="https://github.com/zhmcclient/zhmc-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>IoT Edison exporter</td>
<td><a href="https://github.com/roman-vynar/edison_exporter">GitHub</a></td>
</tr>
<tr>
<td>InfiniBand exporter</td>
<td><a href="https://github.com/treydock/infiniband_exporter">GitHub</a></td>
</tr>
<tr>
<td>IPMI exporter</td>
<td><a href="https://github.com/soundcloud/ipmi_exporter">GitHub</a></td>
</tr>
<tr>
<td>knxd exporter</td>
<td><a href="https://github.com/RichiH/knxd_exporter">GitHub</a></td>
</tr>
<tr>
<td>Modbus exporter</td>
<td><a href="https://github.com/RichiH/modbus_exporter">GitHub</a></td>
</tr>
<tr>
<td>Netgear Cable Modem exporter</td>
<td><a href="https://github.com/ickymettle/netgear_cm_exporter">GitHub</a></td>
</tr>
<tr>
<td>Netgear Router exporter</td>
<td><a href="https://github.com/DRuggeri/netgear_exporter">GitHub</a></td>
</tr>
<tr>
<td>Network UPS Tools (NUT) exporter</td>
<td><a href="https://github.com/DRuggeri/nut_exporter">GitHub</a></td>
</tr>
<tr>
<td>Node/system metrics exporter 🏅</td>
<td><a href="https://github.com/prometheus/node_exporter">GitHub</a></td>
</tr>
<tr>
<td>NVIDIA GPU exporter</td>
<td><a href="https://github.com/mindprince/nvidia_gpu_prometheus_exporter">GitHub</a></td>
</tr>
<tr>
<td>ProSAFE exporter</td>
<td><a href="https://github.com/dalance/prosafe_exporter">GitHub</a></td>
</tr>
<tr>
<td>SmartRAID exporter</td>
<td><a href="https://gitlab.com/calestyo/prometheus-smartraid-exporter">GitLab</a></td>
</tr>
<tr>
<td>Waveplus Radon Sensor exporter</td>
<td><a href="https://github.com/jeremybz/waveplus_exporter">GitHub</a></td>
</tr>
<tr>
<td>Weathergoose Climate Monitor exporter</td>
<td><a href="https://github.com/branttaylor/watchdog-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>Windows exporter</td>
<td><a href="https://github.com/prometheus-community/windows_exporter">GitHub</a></td>
</tr>
<tr>
<td>Intel® Optane™ PMem Controller exporter</td>
<td><a href="https://github.com/intel/ipmctl-exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="issue-trackers-cicd">Issue Trackers &amp; CI/CD (问题跟踪 &amp; 持续集成)<a class="headerlink" href="#issue-trackers-cicd" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bamboo exporter</td>
<td><a href="https://github.com/AndreyVMarkelov/bamboo-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>Bitbucket exporter</td>
<td><a href="https://github.com/AndreyVMarkelov/prom-bitbucket-exporter">GitHub</a></td>
</tr>
<tr>
<td>Confluence exporter</td>
<td><a href="https://github.com/AndreyVMarkelov/prom-confluence-exporter">GitHub</a></td>
</tr>
<tr>
<td>Jenkins exporter</td>
<td><a href="https://github.com/lovoo/jenkins_exporter">GitHub</a></td>
</tr>
<tr>
<td>JIRA exporter</td>
<td><a href="https://github.com/AndreyVMarkelov/jira-prometheus-exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="messaging-systems">Messaging Systems (消息系统)<a class="headerlink" href="#messaging-systems" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>Beanstalkd exporter</td>
<td><a href="https://github.com/messagebird/beanstalkd_exporter">GitHub</a></td>
</tr>
<tr>
<td>EMQ exporter</td>
<td><a href="https://github.com/nuvo/emq_exporter">GitHub</a></td>
</tr>
<tr>
<td>Gearman exporter</td>
<td><a href="https://github.com/bakins/gearman-exporter">GitHub</a></td>
</tr>
<tr>
<td>IBM MQ exporter</td>
<td><a href="https://github.com/ibm-messaging/mq-metric-samples/tree/master/cmd/mq_prometheus">GitHub</a></td>
</tr>
<tr>
<td>Kafka exporter</td>
<td><a href="https://github.com/danielqsj/kafka_exporter">GitHub</a></td>
</tr>
<tr>
<td>NATS exporter</td>
<td><a href="https://github.com/nats-io/prometheus-nats-exporter">GitHub</a></td>
</tr>
<tr>
<td>NSQ exporter</td>
<td><a href="https://github.com/lovoo/nsq_exporter">GitHub</a></td>
</tr>
<tr>
<td>Mirth Connect exporter</td>
<td><a href="https://github.com/vynca/mirth_exporter">GitHub</a></td>
</tr>
<tr>
<td>MQTT blackbox exporter</td>
<td><a href="https://github.com/inovex/mqtt_blackbox_exporter">GitHub</a></td>
</tr>
<tr>
<td>MQTT2Prometheus</td>
<td><a href="https://github.com/hikhvar/mqtt2prometheus">GitHub</a></td>
</tr>
<tr>
<td>RabbitMQ exporter</td>
<td><a href="https://github.com/kbudde/rabbitmq_exporter">GitHub</a></td>
</tr>
<tr>
<td>RabbitMQ Management Plugin exporter</td>
<td><a href="https://github.com/deadtrickster/prometheus_rabbitmq_exporter">GitHub</a></td>
</tr>
<tr>
<td>RocketMQ exporter</td>
<td><a href="https://github.com/apache/rocketmq-exporter">GitHub</a></td>
</tr>
<tr>
<td>Solace exporter</td>
<td><a href="https://github.com/solacecommunity/solace-prometheus-exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="storage_1">Storage (存储)<a class="headerlink" href="#storage_1" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ceph exporter</td>
<td><a href="https://github.com/digitalocean/ceph_exporter">GitHub</a></td>
</tr>
<tr>
<td>Ceph RADOSGW exporter</td>
<td><a href="https://github.com/blemmenes/radosgw_usage_exporter">GitHub</a></td>
</tr>
<tr>
<td>Gluster exporter</td>
<td><a href="https://github.com/ofesseler/gluster_exporter">GitHub</a></td>
</tr>
<tr>
<td>GPFS exporter</td>
<td><a href="https://github.com/treydock/gpfs_exporter">GitHub</a></td>
</tr>
<tr>
<td>Hadoop HDFS FSImage exporter</td>
<td><a href="https://github.com/marcelmay/hadoop-hdfs-fsimage-exporter">GitHub</a></td>
</tr>
<tr>
<td>HPE CSI info metrics provider</td>
<td><a href="https://scod.hpedev.io/csi_driver/metrics.html">Docs</a></td>
</tr>
<tr>
<td>HPE storage array exporter</td>
<td><a href="https://hpe-storage.github.io/array-exporter/">GitHub</a></td>
</tr>
<tr>
<td>Lustre exporter</td>
<td><a href="https://github.com/HewlettPackard/lustre_exporter">GitHub</a></td>
</tr>
<tr>
<td>NetApp E-Series exporter</td>
<td><a href="https://github.com/treydock/eseries_exporter">GitHub</a></td>
</tr>
<tr>
<td>Pure Storage exporter</td>
<td><a href="https://github.com/PureStorage-OpenConnect/pure-exporter">GitHub</a></td>
</tr>
<tr>
<td>ScaleIO exporter</td>
<td><a href="https://github.com/syepes/sio2prom">GitHub</a></td>
</tr>
<tr>
<td>Tivoli Storage Manager/IBM Spectrum Protect</td>
<td><a href="https://github.com/treydock/tsm_exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="http-http">HTTP (HTTP 服务器)<a class="headerlink" href="#http-http" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>Apache exporter</td>
<td><a href="https://github.com/Lusitaniae/apache_exporter">GitHub</a></td>
</tr>
<tr>
<td>HAProxy exporter 🏅</td>
<td><a href="https://github.com/prometheus/haproxy_exporter">GitHub</a></td>
</tr>
<tr>
<td>Nginx metric library</td>
<td><a href="https://github.com/knyar/nginx-lua-prometheus">GitHub</a></td>
</tr>
<tr>
<td>Nginx VTS exporter</td>
<td><a href="https://github.com/sysulq/nginx-vts-exporter">GitHub</a></td>
</tr>
<tr>
<td>Passenger exporter</td>
<td><a href="https://github.com/stuartnelson3/passenger_exporter">GitHub</a></td>
</tr>
<tr>
<td>Squid exporter</td>
<td><a href="https://github.com/boynux/squid-exporter">GitHub</a></td>
</tr>
<tr>
<td>Tinyproxy exporter</td>
<td><a href="https://github.com/gmm42/tinyproxy_exporter">GitHub</a></td>
</tr>
<tr>
<td>Varnish exporter</td>
<td><a href="https://github.com/jonnenauha/prometheus_varnish_exporter">GitHub</a></td>
</tr>
<tr>
<td>WebDriver exporter</td>
<td><a href="https://github.com/mattbostock/webdriver_exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="apis-api">APIs (API 服务)<a class="headerlink" href="#apis-api" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWS ECS exporter</td>
<td><a href="https://github.com/slok/ecs-exporter">GitHub</a></td>
</tr>
<tr>
<td>AWS Health exporter</td>
<td><a href="https://github.com/Jimdo/aws-health-exporter">GitHub</a></td>
</tr>
<tr>
<td>AWS SQS exporter</td>
<td><a href="https://github.com/jmal98/sqs_exporter">GitHub</a></td>
</tr>
<tr>
<td>AWS SQS Prometheus exporter</td>
<td><a href="https://github.com/jmriebold/sqs-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>Azure Health exporter</td>
<td><a href="https://github.com/matzefriedrich/az-health-exporter">GitHub</a></td>
</tr>
<tr>
<td>BigBlueButton exporter</td>
<td><a href="https://github.com/greenstatic/bigbluebutton-exporter">GitHub</a></td>
</tr>
<tr>
<td>Cloudflare exporter</td>
<td><a href="https://gitlab.com/gitlab-org/cloudflare_exporter">GitLab</a></td>
</tr>
<tr>
<td>Cryptowat exporter</td>
<td><a href="https://github.com/nbarrientos/cryptowat_exporter">GitHub</a></td>
</tr>
<tr>
<td>DigitalOcean exporter</td>
<td><a href="https://github.com/metalmatze/digitalocean_exporter">GitHub</a></td>
</tr>
<tr>
<td>Docker Cloud exporter</td>
<td><a href="https://github.com/infinityworks/docker-cloud-exporter">GitHub</a></td>
</tr>
<tr>
<td>Docker Hub exporter</td>
<td><a href="https://github.com/infinityworks/docker-hub-exporter">GitHub</a></td>
</tr>
<tr>
<td>Fastly exporter</td>
<td><a href="https://github.com/peterbourgon/fastly-exporter">GitHub</a></td>
</tr>
<tr>
<td>GitHub exporter</td>
<td><a href="https://github.com/githubexporter/github-exporter">GitHub</a></td>
</tr>
<tr>
<td>Gmail exporter</td>
<td><a href="https://github.com/jamesread/prometheus-gmail-exporter/">GitHub</a></td>
</tr>
<tr>
<td>GraphQL exporter</td>
<td><a href="https://github.com/ricardbejarano/graphql_exporter">GitHub</a></td>
</tr>
<tr>
<td>InstaClustr exporter</td>
<td><a href="https://github.com/fcgravalos/instaclustr_exporter">GitHub</a></td>
</tr>
<tr>
<td>Mozilla Observatory exporter</td>
<td><a href="https://github.com/Jimdo/observatory-exporter">GitHub</a></td>
</tr>
<tr>
<td>OpenWeatherMap exporter</td>
<td><a href="https://github.com/RichiH/openweathermap_exporter">GitHub</a></td>
</tr>
<tr>
<td>Pagespeed exporter</td>
<td><a href="https://github.com/foomo/pagespeed_exporter">GitHub</a></td>
</tr>
<tr>
<td>Rancher exporter</td>
<td><a href="https://github.com/infinityworks/prometheus-rancher-exporter">GitHub</a></td>
</tr>
<tr>
<td>Speedtest exporter</td>
<td><a href="https://github.com/nlamirault/speedtest_exporter">GitHub</a></td>
</tr>
<tr>
<td>Tankerkönig API exporter</td>
<td><a href="https://github.com/lukasmalkmus/tankerkoenig_exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="logging">Logging (日志)<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fluentd exporter</td>
<td><a href="https://github.com/V3ckt0r/fluentd_exporter">GitHub</a></td>
</tr>
<tr>
<td>Google's mtail log data extractor</td>
<td><a href="https://github.com/google/mtail">GitHub</a></td>
</tr>
<tr>
<td>Grok exporter</td>
<td><a href="https://github.com/fstab/grok_exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="finops">FinOps (成本管理)<a class="headerlink" href="#finops" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWS Cost exporter</td>
<td><a href="https://github.com/electrolux-oss/aws-cost-exporter">GitHub</a></td>
</tr>
<tr>
<td>Azure Cost exporter</td>
<td><a href="https://github.com/electrolux-oss/azure-cost-exporter">GitHub</a></td>
</tr>
<tr>
<td>Kubernetes Cost exporter</td>
<td><a href="https://github.com/electrolux-oss/kubernetes-cost-exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="miscellaneous">Miscellaneous (其他)<a class="headerlink" href="#miscellaneous" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACT Fibernet exporter</td>
<td><a href="https://git.captnemo.in/nemo/prometheus-act-exporter">Git</a></td>
</tr>
<tr>
<td>BIND exporter</td>
<td><a href="https://github.com/prometheus-community/bind_exporter">GitHub</a></td>
</tr>
<tr>
<td>BIND query exporter</td>
<td><a href="https://github.com/DRuggeri/bind_query_exporter">GitHub</a></td>
</tr>
<tr>
<td>Bitcoind exporter</td>
<td><a href="https://github.com/LePetitBloc/bitcoind-exporter">GitHub</a></td>
</tr>
<tr>
<td>Blackbox exporter 🏅</td>
<td><a href="https://github.com/prometheus/blackbox_exporter">GitHub</a></td>
</tr>
<tr>
<td>Bungeecord exporter</td>
<td><a href="https://github.com/weihao/bungeecord-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>BOSH exporter</td>
<td><a href="https://github.com/cloudfoundry-community/bosh_exporter">GitHub</a></td>
</tr>
<tr>
<td>cAdvisor</td>
<td><a href="https://github.com/google/cadvisor">GitHub</a></td>
</tr>
<tr>
<td>Cachet exporter</td>
<td><a href="https://github.com/ContaAzul/cachet_exporter">GitHub</a></td>
</tr>
<tr>
<td>ccache exporter</td>
<td><a href="https://github.com/virtualtam/ccache_exporter">GitHub</a></td>
</tr>
<tr>
<td>c-lightning exporter</td>
<td><a href="https://github.com/lightningd/plugins/tree/master/prometheus">GitHub</a></td>
</tr>
<tr>
<td>DHCPD leases exporter</td>
<td><a href="https://github.com/DRuggeri/dhcpd_leases_exporter">GitHub</a></td>
</tr>
<tr>
<td>Dovecot exporter</td>
<td><a href="https://github.com/kumina/dovecot_exporter">GitHub</a></td>
</tr>
<tr>
<td>Dnsmasq exporter</td>
<td><a href="https://github.com/google/dnsmasq_exporter">GitHub</a></td>
</tr>
<tr>
<td>eBPF exporter</td>
<td><a href="https://github.com/cloudflare/ebpf_exporter">GitHub</a></td>
</tr>
<tr>
<td>eBPF network traffic exporter</td>
<td><a href="https://github.com/kasd/texporter">GitHub</a></td>
</tr>
<tr>
<td>Ethereum Client exporter</td>
<td><a href="https://github.com/31z4/ethereum-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>FFmpeg exporter</td>
<td><a href="https://github.com/domcyrus/ffmpeg_exporter">GitHub</a></td>
</tr>
<tr>
<td>File statistics exporter</td>
<td><a href="https://github.com/michael-doubez/filestat_exporter">GitHub</a></td>
</tr>
<tr>
<td>JFrog Artifactory exporter</td>
<td><a href="https://github.com/peimanja/artifactory_exporter">GitHub</a></td>
</tr>
<tr>
<td>Hostapd exporter</td>
<td><a href="https://github.com/Fundacio-i2CAT/hostapd_prometheus_exporter">GitHub</a></td>
</tr>
<tr>
<td>IBM Security Verify Access exporter</td>
<td><a href="https://gitlab.com/zeblawson/isva-prometheus-exporter">GitLab</a></td>
</tr>
<tr>
<td>IPsec exporter</td>
<td><a href="https://github.com/torilabs/ipsec-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>ipset exporter</td>
<td><a href="https://github.com/hatamiarash7/ipset-exporter">GitHub</a></td>
</tr>
<tr>
<td>IRCd exporter</td>
<td><a href="https://github.com/dgl/ircd_exporter">GitHub</a></td>
</tr>
<tr>
<td>Linux HA ClusterLabs exporter</td>
<td><a href="https://github.com/ClusterLabs/ha_cluster_exporter">GitHub</a></td>
</tr>
<tr>
<td>JMeter plugin</td>
<td><a href="https://github.com/johrstrom/jmeter-prometheus-plugin">GitHub</a></td>
</tr>
<tr>
<td>JSON exporter</td>
<td><a href="https://github.com/prometheus-community/json_exporter">GitHub</a></td>
</tr>
<tr>
<td>Kannel exporter</td>
<td><a href="https://github.com/apostvav/kannel_exporter">GitHub</a></td>
</tr>
<tr>
<td>Kemp LoadBalancer exporter</td>
<td><a href="https://github.com/giantswarm/prometheus-kemp-exporter">GitHub</a></td>
</tr>
<tr>
<td>Kibana exporter</td>
<td><a href="https://github.com/pjhampton/kibana-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>kube-state-metrics</td>
<td><a href="https://github.com/kubernetes/kube-state-metrics">GitHub</a></td>
</tr>
<tr>
<td>Locust exporter</td>
<td><a href="https://github.com/ContainerSolutions/locust_exporter">GitHub</a></td>
</tr>
<tr>
<td>Meteor JS web framework exporter</td>
<td><a href="https://atmospherejs.com/sevki/prometheus-exporter">Atmosphere</a></td>
</tr>
<tr>
<td>Minecraft exporter module</td>
<td><a href="https://github.com/Baughn/PrometheusIntegration">GitHub</a></td>
</tr>
<tr>
<td>Minecraft exporter</td>
<td><a href="https://github.com/dirien/minecraft-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>NetBird exporter</td>
<td><a href="https://github.com/matanbaruch/netbird-api-exporter">GitHub</a></td>
</tr>
<tr>
<td>Nomad exporter</td>
<td><a href="https://gitlab.com/yakshaving.art/nomad-exporter">GitLab</a></td>
</tr>
<tr>
<td>nftables exporter</td>
<td><a href="https://github.com/Intrinsec/nftables_exporter">GitHub</a></td>
</tr>
<tr>
<td>OpenStack exporter</td>
<td><a href="https://github.com/openstack-exporter/openstack-exporter">GitHub</a></td>
</tr>
<tr>
<td>OpenStack blackbox exporter</td>
<td><a href="https://github.com/infraly/openstack_client_exporter">GitHub</a></td>
</tr>
<tr>
<td>OpenVPN exporter</td>
<td><a href="https://github.com/Fadi-hamwi/OpenVPN-Metrics-Exporter">GitHub</a></td>
</tr>
<tr>
<td>oVirt exporter</td>
<td><a href="https://github.com/czerwonk/ovirt_exporter">GitHub</a></td>
</tr>
<tr>
<td>Pact Broker exporter</td>
<td><a href="https://github.com/ContainerSolutions/pactbroker_exporter">GitHub</a></td>
</tr>
<tr>
<td>PHP-FPM exporter</td>
<td><a href="https://github.com/bakins/php-fpm-exporter">GitHub</a></td>
</tr>
<tr>
<td>PowerDNS exporter</td>
<td><a href="https://github.com/ledgr/powerdns_exporter">GitHub</a></td>
</tr>
<tr>
<td>Podman exporter</td>
<td><a href="https://github.com/containers/prometheus-podman-exporter">GitHub</a></td>
</tr>
<tr>
<td>Prefect2 exporter</td>
<td><a href="https://github.com/pathfinder177/prefect2-prometheus-exporter">GitHub</a></td>
</tr>
<tr>
<td>Process exporter</td>
<td><a href="https://github.com/ncabatoff/process-exporter">GitHub</a></td>
</tr>
<tr>
<td>rTorrent exporter</td>
<td><a href="https://github.com/mdlayher/rtorrent_exporter">GitHub</a></td>
</tr>
<tr>
<td>Rundeck exporter</td>
<td><a href="https://github.com/phsmith/rundeck_exporter">GitHub</a></td>
</tr>
<tr>
<td>SABnzbd exporter</td>
<td><a href="https://github.com/msroest/sabnzbd_exporter">GitHub</a></td>
</tr>
<tr>
<td>SAML exporter</td>
<td><a href="https://github.com/DoodleScheduling/saml-exporter">GitHub</a></td>
</tr>
<tr>
<td>Script exporter</td>
<td><a href="https://github.com/adhocteam/script_exporter">GitHub</a></td>
</tr>
<tr>
<td>Shield exporter</td>
<td><a href="https://github.com/cloudfoundry-community/shield_exporter">GitHub</a></td>
</tr>
<tr>
<td>Smokeping prober</td>
<td><a href="https://github.com/SuperQ/smokeping_prober">GitHub</a></td>
</tr>
<tr>
<td>SMTP/Maildir MDA blackbox prober</td>
<td><a href="https://github.com/cherti/mailexporter">GitHub</a></td>
</tr>
<tr>
<td>SoftEther exporter</td>
<td><a href="https://github.com/dalance/softether_exporter">GitHub</a></td>
</tr>
<tr>
<td>SSH exporter</td>
<td><a href="https://github.com/treydock/ssh_exporter">GitHub</a></td>
</tr>
<tr>
<td>Teamspeak3 exporter</td>
<td><a href="https://github.com/hikhvar/ts3exporter">GitHub</a></td>
</tr>
<tr>
<td>Transmission exporter</td>
<td><a href="https://github.com/metalmatze/transmission-exporter">GitHub</a></td>
</tr>
<tr>
<td>Unbound exporter</td>
<td><a href="https://github.com/kumina/unbound_exporter">GitHub</a></td>
</tr>
<tr>
<td>WireGuard exporter</td>
<td><a href="https://github.com/MindFlavor/prometheus_wireguard_exporter">GitHub</a></td>
</tr>
<tr>
<td>Xen exporter</td>
<td><a href="https://github.com/lovoo/xenstats_exporter">GitHub</a></td>
</tr>
</tbody>
</table>
<hr />
<p><strong>图例:</strong></p>
<ul>
<li>🏅 = 官方维护的 Exporter</li>
</ul>
<p><strong>参考链接:</strong></p>
<ul>
<li><a href="https://prometheus.io/docs/instrumenting/exporters/">Prometheus Exporters 官方文档</a></li>
<li><a href="https://prometheus.io/docs/instrumenting/writing_exporters/">编写 Exporter 指南</a></li>
</ul>
<hr />
<p><strong>统计:</strong></p>
<ul>
<li>数据库: 30个</li>
<li>硬件: 24个</li>
<li>CI/CD: 5个</li>
<li>消息系统: 14个</li>
<li>存储: 12个</li>
<li>HTTP: 9个</li>
<li>APIs: 22个</li>
<li>日志: 3个</li>
<li>FinOps: 3个</li>
<li>其他: 70+个</li>
</ul>
<p><strong>总计: 200+ 个 Exporter</strong></p>
<hr />
<hr />
<h2 id="golang-exporter">附录: Golang Exporter 完整示例<a class="headerlink" href="#golang-exporter" title="Permanent link">&para;</a></h2>
<h3 id="_118">概述<a class="headerlink" href="#_118" title="Permanent link">&para;</a></h3>
<p>这是一个完整的 Golang Exporter 示例,展示了如何使用 Prometheus 客户端库实现:</p>
<ul>
<li><strong>Gauge</strong> - 内存使用、CPU 核心数等</li>
<li><strong>Histogram</strong> - HTTP 请求延迟分布</li>
</ul>
<h3 id="_119">完整代码<a class="headerlink" href="#_119" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w"> </span><span class="s">&quot;context&quot;</span>
<span class="w"> </span><span class="s">&quot;errors&quot;</span>
<span class="w"> </span><span class="s">&quot;flag&quot;</span>
<span class="w"> </span><span class="s">&quot;fmt&quot;</span>
<span class="w"> </span><span class="s">&quot;log&quot;</span>
<span class="w"> </span><span class="s">&quot;math/rand&quot;</span>
<span class="w"> </span><span class="s">&quot;net/http&quot;</span>
<span class="w"> </span><span class="s">&quot;os&quot;</span>
<span class="w"> </span><span class="s">&quot;os/signal&quot;</span>
<span class="w"> </span><span class="s">&quot;strconv&quot;</span>
<span class="w"> </span><span class="s">&quot;syscall&quot;</span>
<span class="w"> </span><span class="s">&quot;time&quot;</span>

<span class="w"> </span><span class="s">&quot;github.com/prometheus/client_golang/prometheus&quot;</span>
<span class="w"> </span><span class="s">&quot;github.com/prometheus/client_golang/prometheus/promhttp&quot;</span>
<span class="w"> </span><span class="s">&quot;github.com/shirou/gopsutil/cpu&quot;</span>
<span class="w"> </span><span class="s">&quot;github.com/shirou/gopsutil/mem&quot;</span>
<span class="w"> </span><span class="s">&quot;github.com/shirou/gopsutil/net&quot;</span>
<span class="p">)</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">listenPort</span><span class="w"> </span><span class="kt">string</span>

<span class="c1">// ExporterMetrics 存储指标的结构体</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ExporterMetrics</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">connectInfo</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Desc</span>
<span class="w"> </span><span class="nx">memInfo</span><span class="w">     </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Desc</span>
<span class="w"> </span><span class="nx">cpuNums</span><span class="w">     </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Desc</span>
<span class="p">}</span>

<span class="c1">// Describe 将所有可能的指标描述符发送到提供的通道</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">collector</span><span class="w"> </span><span class="o">*</span><span class="nx">ExporterMetrics</span><span class="p">)</span><span class="w"> </span><span class="nx">Describe</span><span class="p">(</span><span class="nx">ch</span><span class="w"> </span><span class="kd">chan</span><span class="o">&lt;-</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Desc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">connectInfo</span>
<span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">memInfo</span>
<span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">cpuNums</span>
<span class="p">}</span>

<span class="c1">// Collect 用于 Prometheus 收集指标</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">collector</span><span class="w"> </span><span class="o">*</span><span class="nx">ExporterMetrics</span><span class="p">)</span><span class="w"> </span><span class="nx">Collect</span><span class="p">(</span><span class="nx">ch</span><span class="w"> </span><span class="kd">chan</span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">collectMemoryMetrics</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// collectMemoryMetrics 收集内存使用信息</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">collector</span><span class="w"> </span><span class="o">*</span><span class="nx">ExporterMetrics</span><span class="p">)</span><span class="w"> </span><span class="nx">collectMemoryMetrics</span><span class="p">(</span><span class="nx">ch</span><span class="w"> </span><span class="kd">chan</span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">memoryStats</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mem</span><span class="p">.</span><span class="nx">VirtualMemory</span><span class="p">()</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Error collecting memory stats: %v\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">MustNewConstMetric</span><span class="p">(</span>
<span class="w">  </span><span class="nx">collector</span><span class="p">.</span><span class="nx">memInfo</span><span class="p">,</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeValue</span><span class="p">,</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">memoryStats</span><span class="p">.</span><span class="nx">Free</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;free&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">)</span>
<span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">MustNewConstMetric</span><span class="p">(</span>
<span class="w">  </span><span class="nx">collector</span><span class="p">.</span><span class="nx">memInfo</span><span class="p">,</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeValue</span><span class="p">,</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">memoryStats</span><span class="p">.</span><span class="nx">Used</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;used&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">)</span>
<span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">MustNewConstMetric</span><span class="p">(</span>
<span class="w">  </span><span class="nx">collector</span><span class="p">.</span><span class="nx">memInfo</span><span class="p">,</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeValue</span><span class="p">,</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">memoryStats</span><span class="p">.</span><span class="nx">Total</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;total&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 内存指标信息</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">memDesc</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Desc</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewDesc</span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;memory_usage&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Memory usage metrics including total, used, and free memory&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// cpu指标信息</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">cpuDesc</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Desc</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewDesc</span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;cpu_cores&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Number of CPU cores available&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="kc">nil</span><span class="p">,</span>
<span class="w">  </span><span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 连接指标信息</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">connDesc</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Desc</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewDesc</span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;connection_status&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Status of network connections&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;local_addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;local_port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;remote_addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;remote_port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pid&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// newMetricsCollector 创建并初始化一个新的指标收集器</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">newMetricsCollector</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">ExporterMetrics</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ExporterMetrics</span><span class="p">{</span>
<span class="w">  </span><span class="nx">connectInfo</span><span class="p">:</span><span class="w"> </span><span class="nx">connDesc</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">memInfo</span><span class="p">:</span><span class="w">     </span><span class="nx">memDesc</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">cpuNums</span><span class="p">:</span><span class="w">     </span><span class="nx">cpuDesc</span><span class="p">(),</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// =============== Histogram 示例 ===============</span>

<span class="c1">// 创建 Histogram 指标 - HTTP 请求延迟</span>
<span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w"> </span><span class="nx">httpRequestDuration</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewHistogramVec</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">HistogramOpts</span><span class="p">{</span>
<span class="w">   </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http_request_duration_seconds&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HTTP request latency distributions&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="c1">// 自定义桶边界: 1ms, 5ms, 10ms, 50ms, 100ms, 500ms, 1s, 5s</span>
<span class="w">   </span><span class="nx">Buckets</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="kt">float64</span><span class="p">{</span><span class="mf">0.001</span><span class="p">,</span><span class="w"> </span><span class="mf">0.005</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;endpoint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="p">},</span><span class="w"> </span><span class="c1">// 标签</span>
<span class="w"> </span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">// 模拟 API 处理函数 - 用于演示 Histogram</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">apiHandler</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="c1">// 记录请求开始时间</span>
<span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 模拟业务处理（随机延迟 10-500ms）</span>
<span class="w"> </span><span class="nx">processingTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="mi">490</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span>
<span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">processingTime</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 模拟不同的响应状态</span>
<span class="w"> </span><span class="nx">statusCode</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">200</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">rand</span><span class="p">.</span><span class="nx">Float64</span><span class="p">()</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 10% 概率返回 500</span>
<span class="w">  </span><span class="nx">statusCode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">500</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 记录请求耗时到 Histogram</span>
<span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Since</span><span class="p">(</span><span class="nx">start</span><span class="p">).</span><span class="nx">Seconds</span><span class="p">()</span>
<span class="w"> </span><span class="nx">httpRequestDuration</span><span class="p">.</span><span class="nx">WithLabelValues</span><span class="p">(</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span>
<span class="w">  </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">statusCode</span><span class="p">),</span>
<span class="w"> </span><span class="p">).</span><span class="nx">Observe</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 返回响应</span>
<span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">WriteHeader</span><span class="p">(</span><span class="nx">statusCode</span><span class="p">)</span>
<span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Request processed in %.3f seconds\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 健康检查接口</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">health</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;health&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">listenPort</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;28880&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;exporter listen port&quot;</span><span class="p">)</span>
<span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 初始化随机数种子</span>
<span class="w"> </span><span class="nx">rand</span><span class="p">.</span><span class="nx">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">())</span>

<span class="w"> </span><span class="c1">// 注册自定义 Collector (Gauge)</span>
<span class="w"> </span><span class="nx">allMetrics</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newMetricsCollector</span><span class="p">()</span>
<span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">allMetrics</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 注册 Histogram 指标</span>
<span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">httpRequestDuration</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 路由配置</span>
<span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/metrics&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">promhttp</span><span class="p">.</span><span class="nx">Handler</span><span class="p">())</span>
<span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/healthz&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">health</span><span class="p">)</span>
<span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/api/users&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">apiHandler</span><span class="p">)</span>
<span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/api/orders&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">apiHandler</span><span class="p">)</span>
<span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/api/products&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">apiHandler</span><span class="p">)</span>

<span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Addr</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;:%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">listenPort</span><span class="p">)}</span>

<span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Starting server on port %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">listenPort</span><span class="p">)</span>
<span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Metrics: http://localhost:%s/metrics\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">listenPort</span><span class="p">)</span>

<span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">server</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ErrServerClosed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;ListenAndServe(): %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">   </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w"> </span><span class="p">}()</span>

<span class="w"> </span><span class="nx">sigChan</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w"> </span><span class="nx">signal</span><span class="p">.</span><span class="nx">Notify</span><span class="p">(</span><span class="nx">sigChan</span><span class="p">,</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">,</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">,</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGKILL</span><span class="p">)</span>

<span class="w"> </span><span class="nx">sig</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">sigChan</span>
<span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;SIGTERM received, shutting down gracefully...&quot;</span><span class="p">)</span>

<span class="w"> </span><span class="nx">timeout</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w"> </span><span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">server</span><span class="p">.</span><span class="nx">Shutdown</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Server Close Error: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;server Close Successful&quot;</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="_120">使用说明<a class="headerlink" href="#_120" title="Permanent link">&para;</a></h3>
<p><strong>1. 安装依赖</strong></p>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span>mod<span class="w"> </span>init<span class="w"> </span>exporter-demo
go<span class="w"> </span>get<span class="w"> </span>github.com/prometheus/client_golang/prometheus
go<span class="w"> </span>get<span class="w"> </span>github.com/prometheus/client_golang/prometheus/promhttp
go<span class="w"> </span>get<span class="w"> </span>github.com/shirou/gopsutil
</code></pre></div>
<p><strong>2. 运行 Exporter</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 默认端口 28880</span>
go<span class="w"> </span>run<span class="w"> </span>main.go

<span class="c1"># 自定义端口</span>
go<span class="w"> </span>run<span class="w"> </span>main.go<span class="w"> </span>-port<span class="w"> </span><span class="m">9090</span>
</code></pre></div>
<p><strong>3. 测试 API 端点</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 生成一些请求,产生 Histogram 数据</span>
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..100<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span>curl<span class="w"> </span>http://localhost:28880/api/users
<span class="w">  </span>curl<span class="w"> </span>http://localhost:28880/api/orders
<span class="w">  </span>curl<span class="w"> </span>http://localhost:28880/api/products
<span class="k">done</span>
</code></pre></div>
<p><strong>4. 查看指标</strong></p>
<p>访问 <code>http://localhost:28880/metrics</code> 查看暴露的指标:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gauge 指标 - 内存使用</span>
<span class="nv">memory_usage</span><span class="p">{</span><span class="nl">type</span><span class="o">=</span><span class="p">&quot;</span><span class="s">free</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">8589934592</span>
<span class="nv">memory_usage</span><span class="p">{</span><span class="nl">type</span><span class="o">=</span><span class="p">&quot;</span><span class="s">used</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">7340032000</span>
<span class="nv">memory_usage</span><span class="p">{</span><span class="nl">type</span><span class="o">=</span><span class="p">&quot;</span><span class="s">total</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">17179869184</span>

<span class="c1"># Histogram 指标 - HTTP 请求延迟</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.001</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">0</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.005</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">0</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.01</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">0</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.05</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">5</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.1</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">18</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.5</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">100</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">1</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">100</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">5</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">100</span>
<span class="nv">http_request_duration_seconds_bucket</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">+Inf</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">100</span>
<span class="nv">http_request_duration_seconds_sum</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;}</span><span class="w"> </span><span class="mf">25.384</span>
<span class="nv">http_request_duration_seconds_count</span><span class="p">{</span><span class="nl">method</span><span class="o">=</span><span class="p">&quot;</span><span class="s">GET</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/api/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">100</span>
</code></pre></div>
<hr />
<h3 id="_121">代码要点解析<a class="headerlink" href="#_121" title="Permanent link">&para;</a></h3>
<h4 id="1-gauge-collector">1. Gauge 指标 (自定义 Collector)<a class="headerlink" href="#1-gauge-collector" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// 实现 prometheus.Collector 接口</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ExporterMetrics</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">memInfo</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Desc</span>
<span class="p">}</span>

<span class="c1">// Describe - 描述指标</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">ExporterMetrics</span><span class="p">)</span><span class="w"> </span><span class="nx">Describe</span><span class="p">(</span><span class="nx">ch</span><span class="w"> </span><span class="kd">chan</span><span class="o">&lt;-</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Desc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">memInfo</span>
<span class="p">}</span>

<span class="c1">// Collect - 收集指标</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">ExporterMetrics</span><span class="p">)</span><span class="w"> </span><span class="nx">Collect</span><span class="p">(</span><span class="nx">ch</span><span class="w"> </span><span class="kd">chan</span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">memoryStats</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mem</span><span class="p">.</span><span class="nx">VirtualMemory</span><span class="p">()</span>
<span class="w">    </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">MustNewConstMetric</span><span class="p">(</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">memInfo</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeValue</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nb">float64</span><span class="p">(</span><span class="nx">memoryStats</span><span class="p">.</span><span class="nx">Free</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="s">&quot;free&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>特点:</strong></p>
<ul>
<li>动态收集系统指标</li>
<li>每次抓取时实时获取最新值</li>
<li>适合 CPU、内存、磁盘等系统指标</li>
</ul>
<hr />
<h4 id="2-histogram">2. Histogram 指标<a class="headerlink" href="#2-histogram" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// 定义 Histogram</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">httpRequestDuration</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewHistogramVec</span><span class="p">(</span>
<span class="w">    </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">HistogramOpts</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http_request_duration_seconds&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HTTP request latency distributions&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Buckets</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="kt">float64</span><span class="p">{</span><span class="mf">0.001</span><span class="p">,</span><span class="w"> </span><span class="mf">0.005</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;endpoint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="p">},</span>
<span class="p">)</span>

<span class="c1">// 记录观测值</span>
<span class="nx">httpRequestDuration</span><span class="p">.</span><span class="nx">WithLabelValues</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/api/users&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;200&quot;</span><span class="p">).</span><span class="nx">Observe</span><span class="p">(</span><span class="mf">0.123</span><span class="p">)</span>
</code></pre></div>
<p><strong>桶配置选项:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// 1. 自定义桶</span>
<span class="nx">Buckets</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="kt">float64</span><span class="p">{</span><span class="mf">0.001</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">}</span>

<span class="c1">// 2. 默认桶</span>
<span class="nx">Buckets</span><span class="p">:</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">DefBuckets</span><span class="w">  </span><span class="c1">// [.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10]</span>

<span class="c1">// 3. 线性桶 (起始值, 宽度, 数量)</span>
<span class="nx">Buckets</span><span class="p">:</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">LinearBuckets</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w">  </span><span class="c1">// [0, 10, 20, ..., 90]</span>

<span class="c1">// 4. 指数桶 (起始值, 因子, 数量)</span>
<span class="nx">Buckets</span><span class="p">:</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">ExponentialBuckets</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w">  </span><span class="c1">// [1, 2, 4, 8, ..., 512]</span>
</code></pre></div>
<hr />
<h3 id="prometheus_10">Prometheus 配置<a class="headerlink" href="#prometheus_10" title="Permanent link">&para;</a></h3>
<p>将此 Exporter 添加到 Prometheus 抓取配置:</p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;custom-exporter&#39;</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:28880&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span>
</code></pre></div>
<hr />
<h3 id="promql_3">PromQL 查询示例<a class="headerlink" href="#promql_3" title="Permanent link">&para;</a></h3>
<p><strong>查询 Histogram P99 延迟:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 各端点 P99 延迟</span>
<span class="kr">histogram_quantile</span><span class="o">(</span><span class="mf">0.99</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">endpoint</span><span class="p">,</span><span class="w"> </span><span class="nv">le</span><span class="o">)</span><span class="w"> </span><span class="o">(</span>
<span class="w">    </span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_bucket</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">)</span>
<span class="w">  </span><span class="o">)</span>
<span class="o">)</span>

<span class="c1"># 各端点平均延迟</span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">endpoint</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_sum</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span>
<span class="o">/</span><span class="w"> </span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">endpoint</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_count</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>

<span class="c1"># 请求 QPS</span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">endpoint</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_count</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>

<span class="c1"># 错误率</span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">endpoint</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_count</span><span class="p">{</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">500</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span><span class="w"> </span>
<span class="o">/</span><span class="w"> </span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">endpoint</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">rate</span><span class="o">(</span><span class="nv">http_request_duration_seconds_count</span><span class="p">[</span><span class="s">5m</span><span class="p">]</span><span class="o">))</span>
</code></pre></div>
<hr />
<h3 id="_122">最佳实践<a class="headerlink" href="#_122" title="Permanent link">&para;</a></h3>
<p><strong>1. Histogram 桶设计</strong></p>
<ul>
<li>✅ 根据实际延迟分布设计桶边界</li>
<li>✅ 覆盖 SLO 阈值附近的桶</li>
<li>✅ 避免桶过多(通常 10-20 个桶)</li>
</ul>
<p><strong>2. 标签使用</strong></p>
<ul>
<li>✅ 保持标签基数低(&lt;1000)</li>
<li>✅ 使用有意义的标签(method, endpoint, status)</li>
<li>❌ 避免高基数标签(user_id, request_id)</li>
</ul>
<p><strong>3. 指标命名</strong></p>
<ul>
<li>✅ 使用描述性名称</li>
<li>✅ 包含单位后缀(<code>_seconds</code>, <code>_bytes</code>)</li>
<li>✅ 遵循 Prometheus 命名规范</li>
</ul>
<p><strong>4. 性能优化</strong></p>
<ul>
<li>✅ 使用 <code>HistogramVec</code> 而非多个 <code>Histogram</code></li>
<li>✅ 缓存标签值,避免重复分配</li>
<li>✅ 在高频路径使用 <code>Observe()</code> 而非 <code>ObserveWithExemplar()</code></li>
</ul>
<hr />
<h3 id="_123">扩展示例<a class="headerlink" href="#_123" title="Permanent link">&para;</a></h3>
<p><strong>添加 Counter:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">httpRequestsTotal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewCounterVec</span><span class="p">(</span>
<span class="w">    </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">CounterOpts</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http_requests_total&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Total number of HTTP requests&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;endpoint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="p">},</span>
<span class="p">)</span>

<span class="c1">// 在 apiHandler 中递增</span>
<span class="nx">httpRequestsTotal</span><span class="p">.</span><span class="nx">WithLabelValues</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">statusCode</span><span class="p">)).</span><span class="nx">Inc</span><span class="p">()</span>
</code></pre></div>
<p><strong>添加 Summary:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">httpRequestDurationSummary</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewSummaryVec</span><span class="p">(</span>
<span class="w">    </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">SummaryOpts</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http_request_duration_summary_seconds&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HTTP request latency summary&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Objectives</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">float64</span><span class="p">]</span><span class="kt">float64</span><span class="p">{</span>
<span class="w">            </span><span class="mf">0.5</span><span class="p">:</span><span class="w"> </span><span class="mf">0.05</span><span class="p">,</span><span class="w">   </span><span class="c1">// P50, 误差 ±5%</span>
<span class="w">            </span><span class="mf">0.9</span><span class="p">:</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w">   </span><span class="c1">// P90, 误差 ±1%</span>
<span class="w">            </span><span class="mf">0.99</span><span class="p">:</span><span class="w"> </span><span class="mf">0.001</span><span class="p">,</span><span class="w"> </span><span class="c1">// P99, 误差 ±0.1%</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;endpoint&quot;</span><span class="p">},</span>
<span class="p">)</span>

<span class="c1">// 记录观测值</span>
<span class="nx">httpRequestDurationSummary</span><span class="p">.</span><span class="nx">WithLabelValues</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/api/users&quot;</span><span class="p">).</span><span class="nx">Observe</span><span class="p">(</span><span class="mf">0.123</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="_124">故障排查<a class="headerlink" href="#_124" title="Permanent link">&para;</a></h3>
<p><strong>问题 1: 指标未暴露</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查注册</span>
prometheus.MustRegister<span class="o">(</span>httpRequestDuration<span class="o">)</span>

<span class="c1"># 检查路由</span>
http.Handle<span class="o">(</span><span class="s2">&quot;/metrics&quot;</span>,<span class="w"> </span>promhttp.Handler<span class="o">())</span>
</code></pre></div>
<p><strong>问题 2: Histogram 无数据</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 确保调用了 Observe()</span>
httpRequestDuration.WithLabelValues<span class="o">(</span>...<span class="o">)</span>.Observe<span class="o">(</span>duration<span class="o">)</span>

<span class="c1"># 检查桶配置是否合理</span>
Buckets:<span class="w"> </span><span class="o">[]</span>float64<span class="o">{</span><span class="m">0</span>.001,<span class="w"> </span><span class="m">0</span>.01,<span class="w"> </span><span class="m">0</span>.1,<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="m">10</span><span class="o">}</span>
</code></pre></div>
<p><strong>问题 3: 内存占用高</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 减少标签基数</span>
<span class="c1"># 减少桶数量</span>
<span class="c1"># 使用标签缓存</span>
</code></pre></div>
<hr />
<h3 id="_125">总结<a class="headerlink" href="#_125" title="Permanent link">&para;</a></h3>
<p>这个示例展示了:</p>
<ul>
<li>✅ Gauge 指标 - 使用自定义 Collector</li>
<li>✅ Histogram 指标 - 记录延迟分布</li>
<li>✅ 优雅关闭 - 处理信号和超时</li>
<li>✅ 多端点路由 - 健康检查、指标、API</li>
</ul>
<p>完整代码可作为生产环境 Exporter 的起点,根据实际需求扩展更多指标类型和业务逻辑。</p>
<hr />
<hr />
<h2 id="pushgateway-golang">附录: Pushgateway Golang 示例<a class="headerlink" href="#pushgateway-golang" title="Permanent link">&para;</a></h2>
<h3 id="_126">概述<a class="headerlink" href="#_126" title="Permanent link">&para;</a></h3>
<p>Pushgateway 是 Prometheus 生态中用于接收短期任务推送指标的中间组件。本示例展示如何使用 Golang 客户端推送指标到 Pushgateway。</p>
<h3 id="_127">适用场景<a class="headerlink" href="#_127" title="Permanent link">&para;</a></h3>
<p><strong>✅ 适合使用 Pushgateway:</strong></p>
<ul>
<li>批处理任务(Batch Jobs)</li>
<li>短期运行的脚本</li>
<li>定时任务(Cron Jobs)</li>
<li>无法被 Prometheus 抓取的服务</li>
</ul>
<p><strong>❌ 不适合使用 Pushgateway:</strong></p>
<ul>
<li>长期运行的服务(应使用 Pull 模式)</li>
<li>高频更新的指标</li>
<li>需要自动服务发现的场景</li>
</ul>
<hr />
<h3 id="_128">完整代码<a class="headerlink" href="#_128" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w"> </span><span class="s">&quot;log&quot;</span>
<span class="w"> </span><span class="s">&quot;time&quot;</span>

<span class="w"> </span><span class="s">&quot;github.com/prometheus/client_golang/prometheus&quot;</span>
<span class="w"> </span><span class="s">&quot;github.com/prometheus/client_golang/prometheus/push&quot;</span>
<span class="p">)</span>

<span class="c1">// MetricCollector 封装指标收集器</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">MetricCollector</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">counter</span><span class="w">   </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">CounterVec</span>
<span class="w"> </span><span class="nx">gauge</span><span class="w">     </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeVec</span>
<span class="w"> </span><span class="nx">histogram</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">HistogramVec</span>
<span class="w"> </span><span class="nx">registry</span><span class="w">  </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Registry</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewMetricCollector</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="c1">// 创建一个带标签的计数器</span>
<span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewCounterVec</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">CounterOpts</span><span class="p">{</span>
<span class="w">   </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;example_counter_total&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Example counter metric&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;service&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;endpoint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="p">},</span>
<span class="w"> </span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 创建一个带标签的 gauge</span>
<span class="w"> </span><span class="nx">gauge</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewGaugeVec</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeOpts</span><span class="p">{</span>
<span class="w">   </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;example_gauge_value&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Example gauge metric&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;service&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;instance_type&quot;</span><span class="p">},</span>
<span class="w"> </span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 创建一个带标签的直方图</span>
<span class="w"> </span><span class="nx">histogram</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewHistogramVec</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">HistogramOpts</span><span class="p">{</span>
<span class="w">   </span><span class="nx">Name</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;example_histogram_seconds&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nx">Help</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;Example histogram metric&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nx">Buckets</span><span class="p">:</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">LinearBuckets</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;service&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;operation&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="p">},</span>
<span class="w"> </span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 创建 Registry</span>
<span class="w"> </span><span class="nx">registry</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewRegistry</span><span class="p">()</span>
<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">counter</span><span class="p">)</span>
<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">gauge</span><span class="p">)</span>
<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">histogram</span><span class="p">)</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">MetricCollector</span><span class="p">{</span>
<span class="w">  </span><span class="nx">counter</span><span class="p">:</span><span class="w">   </span><span class="nx">counter</span><span class="p">,</span>
<span class="w">  </span><span class="nx">gauge</span><span class="p">:</span><span class="w">     </span><span class="nx">gauge</span><span class="p">,</span>
<span class="w">  </span><span class="nx">histogram</span><span class="p">:</span><span class="w"> </span><span class="nx">histogram</span><span class="p">,</span>
<span class="w">  </span><span class="nx">registry</span><span class="p">:</span><span class="w">  </span><span class="nx">registry</span><span class="p">,</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mc</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="p">)</span><span class="w"> </span><span class="nx">RecordMetrics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="c1">// 记录计数器</span>
<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">counter</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;api&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;endpoint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/users&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">   </span><span class="s">&quot;success&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Inc</span><span class="p">()</span>

<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">counter</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;api&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;endpoint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/orders&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">   </span><span class="s">&quot;error&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Inc</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 记录 Gauge</span>
<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">gauge</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w">       </span><span class="s">&quot;backend&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;region&quot;</span><span class="p">:</span><span class="w">        </span><span class="s">&quot;us-east-1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;instance_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;t2.micro&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Set</span><span class="p">(</span><span class="mf">42.0</span><span class="p">)</span>

<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">gauge</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w">       </span><span class="s">&quot;backend&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;region&quot;</span><span class="p">:</span><span class="w">        </span><span class="s">&quot;eu-west-1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;instance_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;t2.small&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Set</span><span class="p">(</span><span class="mf">56.0</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 记录 Histogram</span>
<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">histogram</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w">   </span><span class="s">&quot;database&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;operation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;query&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;success&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Observe</span><span class="p">(</span><span class="mf">0.23</span><span class="p">)</span>

<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">histogram</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w">   </span><span class="s">&quot;database&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;operation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;insert&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;success&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Observe</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mc</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="p">)</span><span class="w"> </span><span class="nx">PushMetrics</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">pusher</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">push</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="p">).</span>
<span class="w">  </span><span class="nx">Gatherer</span><span class="p">(</span><span class="nx">mc</span><span class="p">.</span><span class="nx">registry</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 添加分组标签</span>
<span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;example_instance&quot;</span><span class="p">)</span>
<span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;environment&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;production&quot;</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 推送指标</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Push</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// 使用 Basic Auth 推送</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mc</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="p">)</span><span class="w"> </span><span class="nx">PushMetricsWithBasicAuth</span><span class="p">(</span>
<span class="w"> </span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="p">,</span><span class="w"> </span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">pusher</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">push</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="p">).</span>
<span class="w">  </span><span class="nx">Gatherer</span><span class="p">(</span><span class="nx">mc</span><span class="p">.</span><span class="nx">registry</span><span class="p">).</span>
<span class="w">  </span><span class="nx">BasicAuth</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">)</span>

<span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;example_instance&quot;</span><span class="p">)</span>
<span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;environment&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;production&quot;</span><span class="p">)</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Push</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// 添加指标（保留旧数据）</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mc</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="p">)</span><span class="w"> </span><span class="nx">AddMetrics</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">pusher</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">push</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="p">).</span>
<span class="w">  </span><span class="nx">Gatherer</span><span class="p">(</span><span class="nx">mc</span><span class="p">.</span><span class="nx">registry</span><span class="p">)</span>

<span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;example_instance&quot;</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 使用 Add() 而非 Push()</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Add</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// 删除指标</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mc</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="p">)</span><span class="w"> </span><span class="nx">DeleteMetrics</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">pusher</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">push</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="p">)</span>

<span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;example_instance&quot;</span><span class="p">)</span>
<span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;environment&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;production&quot;</span><span class="p">)</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">Delete</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">collector</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewMetricCollector</span><span class="p">()</span>
<span class="w"> </span><span class="nx">pushGatewayURL</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;http://localhost:9091&quot;</span>
<span class="w"> </span><span class="nx">jobName</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;batch_job&quot;</span>

<span class="w"> </span><span class="c1">// 记录并推送指标</span>
<span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">RecordMetrics</span><span class="p">()</span>
<span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">PushMetrics</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="p">)</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Could not push to Pushgateway: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Successfully pushed metrics to Pushgateway&quot;</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 30秒后删除指标</span>
<span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">DeleteMetrics</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="p">)</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Could not delete metrics: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Successfully deleted metrics from Pushgateway&quot;</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="_129">使用说明<a class="headerlink" href="#_129" title="Permanent link">&para;</a></h3>
<h4 id="1-pushgateway">1. 启动 Pushgateway<a class="headerlink" href="#1-pushgateway" title="Permanent link">&para;</a></h4>
<p><strong>Docker 方式:</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">9091</span>:9091<span class="w"> </span>prom/pushgateway
</code></pre></div>
<p><strong>二进制方式:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 下载</span>
wget<span class="w"> </span>https://github.com/prometheus/pushgateway/releases/download/v1.6.2/pushgateway-1.6.2.linux-amd64.tar.gz
tar<span class="w"> </span>xvfz<span class="w"> </span>pushgateway-1.6.2.linux-amd64.tar.gz
<span class="nb">cd</span><span class="w"> </span>pushgateway-1.6.2.linux-amd64

<span class="c1"># 启动</span>
./pushgateway
</code></pre></div>
<p>访问 <code>http://localhost:9091</code> 查看 Web UI。</p>
<hr />
<h4 id="2-go">2. 安装 Go 依赖<a class="headerlink" href="#2-go" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span>mod<span class="w"> </span>init<span class="w"> </span>pushgateway-demo
go<span class="w"> </span>get<span class="w"> </span>github.com/prometheus/client_golang/prometheus
go<span class="w"> </span>get<span class="w"> </span>github.com/prometheus/client_golang/prometheus/push
</code></pre></div>
<hr />
<h4 id="3_1">3. 运行示例<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span>run<span class="w"> </span>main.go
</code></pre></div>
<p><strong>输出:</strong></p>
<div class="highlight"><pre><span></span><code>Successfully pushed metrics to Pushgateway
Successfully deleted metrics from Pushgateway
</code></pre></div>
<hr />
<h4 id="4">4. 查看推送的指标<a class="headerlink" href="#4" title="Permanent link">&para;</a></h4>
<p>访问 <code>http://localhost:9091/metrics</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Counter</span>
<span class="nv">example_counter_total</span><span class="p">{</span><span class="nl">environment</span><span class="o">=</span><span class="p">&quot;</span><span class="s">production</span><span class="p">&quot;,</span><span class="nl">instance</span><span class="o">=</span><span class="p">&quot;</span><span class="s">example_instance</span><span class="p">&quot;,</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/users</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">success</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">1</span>
<span class="nv">example_counter_total</span><span class="p">{</span><span class="nl">environment</span><span class="o">=</span><span class="p">&quot;</span><span class="s">production</span><span class="p">&quot;,</span><span class="nl">instance</span><span class="o">=</span><span class="p">&quot;</span><span class="s">example_instance</span><span class="p">&quot;,</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api</span><span class="p">&quot;,</span><span class="nl">endpoint</span><span class="o">=</span><span class="p">&quot;</span><span class="s">/orders</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">error</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">1</span>

<span class="c1"># Gauge</span>
<span class="nv">example_gauge_value</span><span class="p">{</span><span class="nl">environment</span><span class="o">=</span><span class="p">&quot;</span><span class="s">production</span><span class="p">&quot;,</span><span class="nl">instance</span><span class="o">=</span><span class="p">&quot;</span><span class="s">example_instance</span><span class="p">&quot;,</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">backend</span><span class="p">&quot;,</span><span class="nl">region</span><span class="o">=</span><span class="p">&quot;</span><span class="s">us-east-1</span><span class="p">&quot;,</span><span class="nl">instance_type</span><span class="o">=</span><span class="p">&quot;</span><span class="s">t2.micro</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">42</span>

<span class="c1"># Histogram</span>
<span class="nv">example_histogram_seconds_bucket</span><span class="p">{</span><span class="nl">environment</span><span class="o">=</span><span class="p">&quot;</span><span class="s">production</span><span class="p">&quot;,</span><span class="nl">instance</span><span class="o">=</span><span class="p">&quot;</span><span class="s">example_instance</span><span class="p">&quot;,</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">database</span><span class="p">&quot;,</span><span class="nl">operation</span><span class="o">=</span><span class="p">&quot;</span><span class="s">query</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">success</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.1</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">0</span>
<span class="nv">example_histogram_seconds_bucket</span><span class="p">{</span><span class="nl">environment</span><span class="o">=</span><span class="p">&quot;</span><span class="s">production</span><span class="p">&quot;,</span><span class="nl">instance</span><span class="o">=</span><span class="p">&quot;</span><span class="s">example_instance</span><span class="p">&quot;,</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">database</span><span class="p">&quot;,</span><span class="nl">operation</span><span class="o">=</span><span class="p">&quot;</span><span class="s">query</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">success</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.2</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">0</span>
<span class="nv">example_histogram_seconds_bucket</span><span class="p">{</span><span class="nl">environment</span><span class="o">=</span><span class="p">&quot;</span><span class="s">production</span><span class="p">&quot;,</span><span class="nl">instance</span><span class="o">=</span><span class="p">&quot;</span><span class="s">example_instance</span><span class="p">&quot;,</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">database</span><span class="p">&quot;,</span><span class="nl">operation</span><span class="o">=</span><span class="p">&quot;</span><span class="s">query</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">success</span><span class="p">&quot;,</span><span class="nl">le</span><span class="o">=</span><span class="p">&quot;</span><span class="s">0.3</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">1</span>
<span class="nv">example_histogram_seconds_sum</span><span class="p">{</span><span class="nl">environment</span><span class="o">=</span><span class="p">&quot;</span><span class="s">production</span><span class="p">&quot;,</span><span class="nl">instance</span><span class="o">=</span><span class="p">&quot;</span><span class="s">example_instance</span><span class="p">&quot;,</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">database</span><span class="p">&quot;,</span><span class="nl">operation</span><span class="o">=</span><span class="p">&quot;</span><span class="s">query</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">success</span><span class="p">&quot;}</span><span class="w"> </span><span class="mf">0.23</span>
<span class="nv">example_histogram_seconds_count</span><span class="p">{</span><span class="nl">environment</span><span class="o">=</span><span class="p">&quot;</span><span class="s">production</span><span class="p">&quot;,</span><span class="nl">instance</span><span class="o">=</span><span class="p">&quot;</span><span class="s">example_instance</span><span class="p">&quot;,</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">database</span><span class="p">&quot;,</span><span class="nl">operation</span><span class="o">=</span><span class="p">&quot;</span><span class="s">query</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">success</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<hr />
<h3 id="_130">核心概念<a class="headerlink" href="#_130" title="Permanent link">&para;</a></h3>
<h4 id="1-push-vs-add-vs-delete">1. Push vs Add vs Delete<a class="headerlink" href="#1-push-vs-add-vs-delete" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Push - 覆盖指定 job/grouping 的所有指标</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Push</span><span class="p">()</span>

<span class="c1">// Add - 添加指标，保留已有指标</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Add</span><span class="p">()</span>

<span class="c1">// Delete - 删除指定 job/grouping 的所有指标</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Delete</span><span class="p">()</span>
</code></pre></div>
<p><strong>区别示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// 第一次推送</span>
<span class="nx">gauge</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Push</span><span class="p">()</span><span class="w">  </span><span class="c1">// Pushgateway 中: gauge = 10</span>

<span class="c1">// 第二次推送 (不同指标)</span>
<span class="nx">counter</span><span class="p">.</span><span class="nx">Inc</span><span class="p">()</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Push</span><span class="p">()</span><span class="w">  </span><span class="c1">// Pushgateway 中: gauge 被删除, counter = 1</span>

<span class="c1">// 使用 Add 替代</span>
<span class="nx">gauge</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Push</span><span class="p">()</span><span class="w">  </span><span class="c1">// gauge = 10</span>

<span class="nx">counter</span><span class="p">.</span><span class="nx">Inc</span><span class="p">()</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Add</span><span class="p">()</span><span class="w">   </span><span class="c1">// gauge = 10, counter = 1 (保留 gauge)</span>
</code></pre></div>
<hr />
<h4 id="2-grouping-labels">2. 分组标签 (Grouping Labels)<a class="headerlink" href="#2-grouping-labels" title="Permanent link">&para;</a></h4>
<p>分组标签用于区分不同的指标来源:</p>
<div class="highlight"><pre><span></span><code><span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;server-1&quot;</span><span class="p">)</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;environment&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;production&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>URL 映射:</strong></p>
<div class="highlight"><pre><span></span><code>http://localhost:9091/metrics/job/batch_job/instance/server-1/environment/production
</code></pre></div>
<p><strong>最佳实践:</strong></p>
<ul>
<li>✅ 使用有意义的分组标签(instance, environment, region)</li>
<li>✅ 保持分组标签一致</li>
<li>❌ 避免高基数分组标签(user_id, request_id)</li>
</ul>
<hr />
<h4 id="3-registry">3. Registry 使用<a class="headerlink" href="#3-registry" title="Permanent link">&para;</a></h4>
<p><strong>为什么使用自定义 Registry?</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// ❌ 不好 - 使用默认 Registry</span>
<span class="nx">prometheus</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">gauge</span><span class="p">)</span>
<span class="nx">pusher</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">push</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">).</span><span class="nx">Gatherer</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">DefaultGatherer</span><span class="p">)</span>
<span class="c1">// 会推送所有默认的 Go 运行时指标</span>

<span class="c1">// ✅ 好 - 使用自定义 Registry</span>
<span class="nx">registry</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewRegistry</span><span class="p">()</span>
<span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">gauge</span><span class="p">)</span>
<span class="nx">pusher</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">push</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">).</span><span class="nx">Gatherer</span><span class="p">(</span><span class="nx">registry</span><span class="p">)</span>
<span class="c1">// 只推送显式注册的指标</span>
</code></pre></div>
<hr />
<h3 id="_131">实际应用场景<a class="headerlink" href="#_131" title="Permanent link">&para;</a></h3>
<h4 id="1-cron-job">场景 1: Cron Job 批处理<a class="headerlink" href="#1-cron-job" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// backup_job.go</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">runBackup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">collector</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewMetricCollector</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 执行备份</span>
<span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
<span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">performBackup</span><span class="p">()</span>
<span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Since</span><span class="p">(</span><span class="nx">start</span><span class="p">).</span><span class="nx">Seconds</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 记录指标</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">collector</span><span class="p">.</span><span class="nx">counter</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">   </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;backup&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;error&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">}).</span><span class="nx">Inc</span><span class="p">()</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">collector</span><span class="p">.</span><span class="nx">counter</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">   </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;backup&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;success&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">}).</span><span class="nx">Inc</span><span class="p">()</span>

<span class="w">  </span><span class="nx">collector</span><span class="p">.</span><span class="nx">gauge</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">   </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;backup&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;duration&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">}).</span><span class="nx">Set</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 推送到 Pushgateway</span>
<span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">PushMetrics</span><span class="p">(</span><span class="s">&quot;http://pushgateway:9091&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;backup_job&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Crontab 配置:</strong></p>
<div class="highlight"><pre><span></span><code>0 2 * * * /usr/local/bin/backup_job
</code></pre></div>
<hr />
<h4 id="2">场景 2: 数据处理脚本<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">processData</span><span class="p">(</span><span class="nx">batchID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">collector</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewMetricCollector</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 处理记录数</span>
<span class="w"> </span><span class="nx">recordsProcessed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
<span class="w"> </span><span class="nx">recordsFailed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>

<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">records</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">processRecord</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">recordsProcessed</span><span class="o">++</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">recordsFailed</span><span class="o">++</span>
<span class="w">  </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 记录指标</span>
<span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">gauge</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;batch_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">batchID</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">   </span><span class="s">&quot;processed&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">recordsProcessed</span><span class="p">))</span>

<span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">gauge</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;batch_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">batchID</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">   </span><span class="s">&quot;failed&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">recordsFailed</span><span class="p">))</span>

<span class="w"> </span><span class="c1">// 推送</span>
<span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">PushMetrics</span><span class="p">(</span><span class="s">&quot;http://pushgateway:9091&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;data_processor&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h4 id="3_2">场景 3: 定期推送 (长期运行脚本)<a class="headerlink" href="#3_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">monitorWorker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">collector</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewMetricCollector</span><span class="p">()</span>
<span class="w"> </span><span class="nx">ticker</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">NewTicker</span><span class="p">(</span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w"> </span><span class="k">defer</span><span class="w"> </span><span class="nx">ticker</span><span class="p">.</span><span class="nx">Stop</span><span class="p">()</span>

<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 收集指标</span>
<span class="w">  </span><span class="nx">queueSize</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getQueueSize</span><span class="p">()</span>
<span class="w">  </span><span class="nx">collector</span><span class="p">.</span><span class="nx">gauge</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">   </span><span class="s">&quot;queue&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tasks&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">}).</span><span class="nx">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">queueSize</span><span class="p">))</span>

<span class="w">  </span><span class="c1">// 推送</span>
<span class="w">  </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">PushMetrics</span><span class="p">(</span><span class="s">&quot;http://pushgateway:9091&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;worker&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Push failed: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="prometheus_11">Prometheus 配置<a class="headerlink" href="#prometheus_11" title="Permanent link">&para;</a></h3>
<p>配置 Prometheus 抓取 Pushgateway:</p>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pushgateway&#39;</span>
<span class="w">    </span><span class="nt">honor_labels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># 重要: 保留推送的 job 标签</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9091&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>关键配置说明:</strong></p>
<ul>
<li><code>honor_labels: true</code> - 保留 Pushgateway 中的 <code>job</code> 和 <code>instance</code> 标签</li>
<li>不设置会导致标签被 Prometheus 的抓取标签覆盖</li>
</ul>
<hr />
<h3 id="promql_4">PromQL 查询示例<a class="headerlink" href="#promql_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询批处理任务成功率</span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">service</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nv">example_counter_total</span><span class="p">{</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">success</span><span class="p">&quot;}</span><span class="o">)</span>
<span class="o">/</span>
<span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">service</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nv">example_counter_total</span><span class="o">)</span>

<span class="c1"># 查询最近一次推送时间</span>
<span class="nv">push_time_seconds</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;}</span>

<span class="c1"># 查询各批处理任务的处理记录数</span>
<span class="nv">example_gauge_value</span><span class="p">{</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">processed</span><span class="p">&quot;}</span>

<span class="c1"># 告警: 批处理任务失败</span>
<span class="nv">example_counter_total</span><span class="p">{</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">error</span><span class="p">&quot;}</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>

<span class="c1"># 告警: Pushgateway 长时间未收到推送</span>
<span class="kr">time</span><span class="o">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">push_time_seconds</span><span class="p">{</span><span class="nl">job</span><span class="o">=</span><span class="p">&quot;</span><span class="s">batch_job</span><span class="p">&quot;}</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3600</span>
</code></pre></div>
<hr />
<h3 id="_132">最佳实践<a class="headerlink" href="#_132" title="Permanent link">&para;</a></h3>
<h4 id="1-add-push">1. 使用 Add 而非 Push (多指标场景)<a class="headerlink" href="#1-add-push" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// ❌ 不好 - 第二次 Push 会覆盖第一次的 gauge</span>
<span class="nx">gauge</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Push</span><span class="p">()</span>

<span class="nx">counter</span><span class="p">.</span><span class="nx">Inc</span><span class="p">()</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Push</span><span class="p">()</span><span class="w">  </span><span class="c1">// gauge 被删除!</span>

<span class="c1">// ✅ 好 - 使用 Add 保留已有指标</span>
<span class="nx">gauge</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Push</span><span class="p">()</span>

<span class="nx">counter</span><span class="p">.</span><span class="nx">Inc</span><span class="p">()</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Add</span><span class="p">()</span><span class="w">   </span><span class="c1">// gauge 和 counter 都保留</span>
</code></pre></div>
<hr />
<h4 id="2_1">2. 任务结束时删除指标<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">runJob</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">collector</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewMetricCollector</span><span class="p">()</span>
<span class="w"> </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 任务结束时清理指标</span>
<span class="w">  </span><span class="nx">collector</span><span class="p">.</span><span class="nx">DeleteMetrics</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="p">)</span>
<span class="w"> </span><span class="p">}()</span>

<span class="w"> </span><span class="c1">// 执行任务...</span>
<span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">RecordMetrics</span><span class="p">()</span>
<span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">PushMetrics</span><span class="p">(</span><span class="nx">pushGatewayURL</span><span class="p">,</span><span class="w"> </span><span class="nx">jobName</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h4 id="3_3">3. 添加时间戳指标<a class="headerlink" href="#3_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Pushgateway 自动添加的指标</span>
<span class="nx">push_time_seconds</span><span class="p">{</span><span class="nx">job</span><span class="p">=</span><span class="s">&quot;batch_job&quot;</span><span class="p">,</span><span class="nx">instance</span><span class="p">=</span><span class="s">&quot;server-1&quot;</span><span class="p">}</span><span class="w"> </span><span class="mi">1700000000</span>
<span class="nx">push_failure_time_seconds</span><span class="p">{</span><span class="nx">job</span><span class="p">=</span><span class="s">&quot;batch_job&quot;</span><span class="p">,</span><span class="nx">instance</span><span class="p">=</span><span class="s">&quot;server-1&quot;</span><span class="p">}</span><span class="w"> </span><span class="mi">0</span>

<span class="c1">// 用于告警</span>
<span class="nx">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">push_time_seconds</span><span class="p">{</span><span class="nx">job</span><span class="p">=</span><span class="s">&quot;batch_job&quot;</span><span class="p">}</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">3600</span>
</code></pre></div>
<hr />
<h4 id="4_1">4. 错误处理和重试<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">PushWithRetry</span><span class="p">(</span><span class="nx">collector</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">maxRetries</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">3</span>
<span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>

<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">maxRetries</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">PushMetrics</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Push attempt %d failed: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;push failed after %d retries: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">maxRetries</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="_133">安全性<a class="headerlink" href="#_133" title="Permanent link">&para;</a></h3>
<h4 id="1-basic-auth">1. 使用 Basic Auth<a class="headerlink" href="#1-basic-auth" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nx">pusher</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">push</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">).</span>
<span class="w"> </span><span class="nx">BasicAuth</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Pushgateway 启动参数:</strong></p>
<div class="highlight"><pre><span></span><code>./pushgateway<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--web.basic-auth-file<span class="o">=</span>/etc/pushgateway/auth.yml
</code></pre></div>
<p><strong>auth.yml:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">basic_auth_users</span><span class="p">:</span>
<span class="w">  </span><span class="nt">admin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$2y$10$...</span><span class="w"> </span><span class="c1"># bcrypt hash</span>
</code></pre></div>
<hr />
<h4 id="2-tls">2. TLS 加密<a class="headerlink" href="#2-tls" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="s">&quot;crypto/tls&quot;</span>

<span class="nx">tlsConfig</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
<span class="w"> </span><span class="nx">InsecureSkipVerify</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">client</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span>
<span class="w"> </span><span class="nx">Transport</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
<span class="w">  </span><span class="nx">TLSClientConfig</span><span class="p">:</span><span class="w"> </span><span class="nx">tlsConfig</span><span class="p">,</span>
<span class="w"> </span><span class="p">},</span>
<span class="p">}</span>

<span class="nx">pusher</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">push</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;https://pushgateway:9091&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">).</span>
<span class="w"> </span><span class="nx">Client</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="_134">常见问题<a class="headerlink" href="#_134" title="Permanent link">&para;</a></h3>
<p><strong>Q1: Pushgateway 指标一直存在?</strong></p>
<p>A: 使用 <code>Delete()</code> 手动删除,或者重启 Pushgateway:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 任务结束时删除</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">DeleteMetrics</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">)</span>
</code></pre></div>
<hr />
<p><strong>Q2: 多个实例推送到同一 job?</strong></p>
<p>A: 使用不同的分组标签区分:</p>
<div class="highlight"><pre><span></span><code><span class="nx">hostname</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Hostname</span><span class="p">()</span>
<span class="nx">pusher</span><span class="p">.</span><span class="nx">Grouping</span><span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">hostname</span><span class="p">)</span>
</code></pre></div>
<hr />
<p><strong>Q3: Push 失败怎么办?</strong></p>
<p>A: 实现重试机制,记录到本地日志:</p>
<div class="highlight"><pre><span></span><code><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">PushMetrics</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="c1">// 记录到本地文件</span>
<span class="w"> </span><span class="nx">logMetrics</span><span class="p">(</span><span class="nx">collector</span><span class="p">.</span><span class="nx">registry</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<p><strong>Q4: Pushgateway 重启后数据丢失?</strong></p>
<p>A: Pushgateway 是无状态的,重启后数据丢失。解决方案:</p>
<ul>
<li>使用持久化 Pushgateway (--persistence.file)</li>
<li>批处理任务重新推送指标</li>
</ul>
<div class="highlight"><pre><span></span><code>./pushgateway<span class="w"> </span>--persistence.file<span class="o">=</span>/data/metrics.db
</code></pre></div>
<hr />
<h3 id="pushgateway_2">监控 Pushgateway<a class="headerlink" href="#pushgateway_2" title="Permanent link">&para;</a></h3>
<p><strong>关键指标:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Pushgateway 存储的时间序列数</span>
<span class="nv">pushgateway_http_push_size_bytes</span>

<span class="c1"># HTTP 推送请求数</span>
<span class="nv">pushgateway_http_requests_total</span>

<span class="c1"># 推送失败数</span>
<span class="kr">rate</span><span class="o">(</span><span class="nv">pushgateway_http_requests_total</span><span class="p">{</span><span class="nl">code</span><span class="o">!=</span><span class="p">&quot;</span><span class="s">200</span><span class="p">&quot;}[</span><span class="s">5m</span><span class="p">]</span><span class="o">)</span>
</code></pre></div>
<p><strong>告警规则:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pushgateway</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Pushgateway 宕机</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PushgatewayDown</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">up{job=&quot;pushgateway&quot;} == 0</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>

<span class="w">      </span><span class="c1"># 批处理任务长时间未推送</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BatchJobStale</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time() - push_time_seconds{job=&quot;batch_job&quot;} &gt; 86400</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;批处理任务超过</span><span class="nv"> </span><span class="s">24</span><span class="nv"> </span><span class="s">小时未运行&quot;</span>
</code></pre></div>
<hr />
<h3 id="_135">总结<a class="headerlink" href="#_135" title="Permanent link">&para;</a></h3>
<p><strong>Pushgateway 适用于:</strong></p>
<ul>
<li>✅ 批处理任务、Cron Jobs</li>
<li>✅ 短期运行的脚本</li>
<li>✅ 无法被 Prometheus 抓取的服务</li>
</ul>
<p><strong>关键要点:</strong></p>
<ol>
<li>使用自定义 Registry 避免推送不必要的指标</li>
<li>使用 <code>Add()</code> 保留已有指标,使用 <code>Push()</code> 覆盖</li>
<li>任务结束时使用 <code>Delete()</code> 清理指标</li>
<li>配置 Prometheus 时设置 <code>honor_labels: true</code></li>
<li>添加错误处理和重试机制</li>
</ol>
<p><strong>不要用于:</strong></p>
<ul>
<li>❌ 长期运行的服务(使用 Pull 模式)</li>
<li>❌ 高频更新的指标</li>
<li>❌ 需要服务发现的场景</li>
</ul>
<p>完整代码可作为生产环境批处理任务监控的起点! 🎯</p>
<hr />
<hr />
<h2 id="textfile-collector">附录: Textfile Collector 示例<a class="headerlink" href="#textfile-collector" title="Permanent link">&para;</a></h2>
<h3 id="_136">概述<a class="headerlink" href="#_136" title="Permanent link">&para;</a></h3>
<p>Textfile Collector 是 Node Exporter 的一个功能，允许通过读取 <code>.prom</code> 格式的文本文件来暴露自定义指标。这对于以下场景非常有用：</p>
<ul>
<li>批处理任务生成指标</li>
<li>脚本定期更新指标</li>
<li>无法直接集成 Prometheus 客户端的程序</li>
</ul>
<p>本示例展示如何使用 <code>expfmt</code> 包将指标写入 textfile 格式。</p>
<hr />
<h3 id="_137">适用场景<a class="headerlink" href="#_137" title="Permanent link">&para;</a></h3>
<p><strong>✅ 适合使用 Textfile Collector:</strong></p>
<ul>
<li>Cron 定时任务生成指标</li>
<li>Shell/Python 脚本导出指标</li>
<li>第三方工具输出转换为 Prometheus 格式</li>
<li>静态指标（配额、阈值等）</li>
</ul>
<p><strong>✅ 相比 Pushgateway 的优势:</strong></p>
<ul>
<li>不需要额外组件（复用 Node Exporter）</li>
<li>自动生命周期管理（文件删除 = 指标消失）</li>
<li>更简单的部署</li>
<li>本地文件系统，无网络依赖</li>
</ul>
<hr />
<h3 id="_138">完整代码<a class="headerlink" href="#_138" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w"> </span><span class="s">&quot;fmt&quot;</span>
<span class="w"> </span><span class="s">&quot;log&quot;</span>
<span class="w"> </span><span class="s">&quot;os&quot;</span>
<span class="w"> </span><span class="s">&quot;time&quot;</span>

<span class="w"> </span><span class="s">&quot;github.com/prometheus/client_golang/prometheus&quot;</span>
<span class="w"> </span><span class="s">&quot;github.com/prometheus/common/expfmt&quot;</span>
<span class="p">)</span>

<span class="c1">// MetricCollector 指标收集器</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">MetricCollector</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">registry</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Registry</span>
<span class="w"> </span><span class="nx">gauge</span><span class="w">    </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeVec</span>
<span class="w"> </span><span class="nx">counter</span><span class="w">  </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">CounterVec</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewMetricCollector</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="c1">// 创建自定义 Registry</span>
<span class="w"> </span><span class="nx">registry</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewRegistry</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 创建 Gauge 指标</span>
<span class="w"> </span><span class="nx">gauge</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewGaugeVec</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeOpts</span><span class="p">{</span>
<span class="w">   </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;custom_metric_gauge&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Custom gauge metric for textfile collector&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;service&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;region&quot;</span><span class="p">},</span>
<span class="w"> </span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 创建 Counter 指标</span>
<span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewCounterVec</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">CounterOpts</span><span class="p">{</span>
<span class="w">   </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;custom_metric_counter_total&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Custom counter metric for textfile collector&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;service&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="p">},</span>
<span class="w"> </span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 注册指标</span>
<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">gauge</span><span class="p">)</span>
<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">counter</span><span class="p">)</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">MetricCollector</span><span class="p">{</span>
<span class="w">  </span><span class="nx">registry</span><span class="p">:</span><span class="w"> </span><span class="nx">registry</span><span class="p">,</span>
<span class="w">  </span><span class="nx">gauge</span><span class="p">:</span><span class="w">    </span><span class="nx">gauge</span><span class="p">,</span>
<span class="w">  </span><span class="nx">counter</span><span class="p">:</span><span class="w">  </span><span class="nx">counter</span><span class="p">,</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// RecordMetrics 记录指标</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mc</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="p">)</span><span class="w"> </span><span class="nx">RecordMetrics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">gauge</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;api&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;region&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;us-east-1&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Set</span><span class="p">(</span><span class="mf">42.5</span><span class="p">)</span>

<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">gauge</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;database&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;region&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;eu-west-1&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Set</span><span class="p">(</span><span class="mf">78.9</span><span class="p">)</span>

<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">counter</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;api&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;success&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Inc</span><span class="p">()</span>

<span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">counter</span><span class="p">.</span><span class="nx">With</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Labels</span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;api&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;error&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">}).</span><span class="nx">Add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// WriteToTextfile 将指标写入 textfile</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mc</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="p">)</span><span class="w"> </span><span class="nx">WriteToTextfile</span><span class="p">(</span><span class="nx">filename</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to create file: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>
<span class="w"> </span><span class="k">defer</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 从 Registry 收集指标</span>
<span class="w"> </span><span class="nx">metricFamilies</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">Gather</span><span class="p">()</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to gather metrics: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 使用 expfmt 将指标写入文件</span>
<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">metricFamilies</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">expfmt</span><span class="p">.</span><span class="nx">MetricFamilyToText</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to write metric family: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// WriteToTextfileAtomic 原子写入（推荐）</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mc</span><span class="w"> </span><span class="o">*</span><span class="nx">MetricCollector</span><span class="p">)</span><span class="w"> </span><span class="nx">WriteToTextfileAtomic</span><span class="p">(</span><span class="nx">filename</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="c1">// 创建临时文件</span>
<span class="w"> </span><span class="nx">tmpFile</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.tmp.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">())</span>

<span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to create temp file: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 收集并写入指标</span>
<span class="w"> </span><span class="nx">metricFamilies</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mc</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">Gather</span><span class="p">()</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">file</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="w">  </span><span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to gather metrics: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">metricFamilies</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">expfmt</span><span class="p">.</span><span class="nx">MetricFamilyToText</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">file</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="w">   </span><span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to write metric family: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">Close</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to close temp file: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 原子重命名</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Rename</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to rename temp file: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">collector</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewMetricCollector</span><span class="p">()</span>
<span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">RecordMetrics</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 写入 textfile</span>
<span class="w"> </span><span class="nx">outputFile</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;/var/lib/node_exporter/textfile_collector/custom_metrics.prom&quot;</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">collector</span><span class="p">.</span><span class="nx">WriteToTextfileAtomic</span><span class="p">(</span><span class="nx">outputFile</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to write textfile: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Metrics written to: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">outputFile</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="_139">使用说明<a class="headerlink" href="#_139" title="Permanent link">&para;</a></h3>
<h4 id="1-node-exporter">1. 安装 Node Exporter<a class="headerlink" href="#1-node-exporter" title="Permanent link">&para;</a></h4>
<p><strong>二进制安装:</strong></p>
<div class="highlight"><pre><span></span><code>wget<span class="w"> </span>https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
tar<span class="w"> </span>xvfz<span class="w"> </span>node_exporter-1.7.0.linux-amd64.tar.gz
<span class="nb">cd</span><span class="w"> </span>node_exporter-1.7.0.linux-amd64
</code></pre></div>
<p><strong>启动 Node Exporter (启用 textfile collector):</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建 textfile 目录</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>/var/lib/node_exporter/textfile_collector

<span class="c1"># 启动 Node Exporter</span>
./node_exporter<span class="w"> </span>--collector.textfile.directory<span class="o">=</span>/var/lib/node_exporter/textfile_collector
</code></pre></div>
<hr />
<h4 id="2-go_1">2. 安装 Go 依赖<a class="headerlink" href="#2-go_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span>mod<span class="w"> </span>init<span class="w"> </span>textfile-demo
go<span class="w"> </span>get<span class="w"> </span>github.com/prometheus/client_golang/prometheus
go<span class="w"> </span>get<span class="w"> </span>github.com/prometheus/common/expfmt
</code></pre></div>
<hr />
<h4 id="3_4">3. 运行示例<a class="headerlink" href="#3_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 修改输出路径到 textfile 目录</span>
go<span class="w"> </span>run<span class="w"> </span>main.go
</code></pre></div>
<hr />
<h4 id="4-prom">4. 生成的 .prom 文件内容<a class="headerlink" href="#4-prom" title="Permanent link">&para;</a></h4>
<p>查看生成的文件:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>/var/lib/node_exporter/textfile_collector/custom_metrics.prom
</code></pre></div>
<p><strong>输出示例:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># HELP custom_metric_counter_total Custom counter metric for textfile collector</span>
<span class="c1"># TYPE custom_metric_counter_total counter</span>
<span class="nv">custom_metric_counter_total</span><span class="p">{</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">error</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">3</span>
<span class="nv">custom_metric_counter_total</span><span class="p">{</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">success</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">1</span>
<span class="c1"># HELP custom_metric_gauge Custom gauge metric for textfile collector</span>
<span class="c1"># TYPE custom_metric_gauge gauge</span>
<span class="nv">custom_metric_gauge</span><span class="p">{</span><span class="nl">region</span><span class="o">=</span><span class="p">&quot;</span><span class="s">eu-west-1</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">database</span><span class="p">&quot;}</span><span class="w"> </span><span class="mf">78.9</span>
<span class="nv">custom_metric_gauge</span><span class="p">{</span><span class="nl">region</span><span class="o">=</span><span class="p">&quot;</span><span class="s">us-east-1</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api</span><span class="p">&quot;}</span><span class="w"> </span><span class="mf">42.5</span>
</code></pre></div>
<hr />
<h4 id="5">5. 访问指标<a class="headerlink" href="#5" title="Permanent link">&para;</a></h4>
<p>访问 Node Exporter: <code>http://localhost:9100/metrics</code></p>
<p>搜索 <code>custom_metric</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nv">custom_metric_counter_total</span><span class="p">{</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">error</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">3</span>
<span class="nv">custom_metric_counter_total</span><span class="p">{</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api</span><span class="p">&quot;,</span><span class="nl">status</span><span class="o">=</span><span class="p">&quot;</span><span class="s">success</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">1</span>
<span class="nv">custom_metric_gauge</span><span class="p">{</span><span class="nl">region</span><span class="o">=</span><span class="p">&quot;</span><span class="s">eu-west-1</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">database</span><span class="p">&quot;}</span><span class="w"> </span><span class="mf">78.9</span>
<span class="nv">custom_metric_gauge</span><span class="p">{</span><span class="nl">region</span><span class="o">=</span><span class="p">&quot;</span><span class="s">us-east-1</span><span class="p">&quot;,</span><span class="nl">service</span><span class="o">=</span><span class="p">&quot;</span><span class="s">api</span><span class="p">&quot;}</span><span class="w"> </span><span class="mf">42.5</span>
</code></pre></div>
<hr />
<h3 id="api_4">核心 API 详解<a class="headerlink" href="#api_4" title="Permanent link">&para;</a></h3>
<h4 id="1-registrygather">1. registry.Gather()<a class="headerlink" href="#1-registrygather" title="Permanent link">&para;</a></h4>
<p>从 Registry 收集所有指标:</p>
<div class="highlight"><pre><span></span><code><span class="nx">metricFamilies</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">Gather</span><span class="p">()</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// metricFamilies 是 []*dto.MetricFamily 类型</span>
<span class="c1">// 每个 MetricFamily 包含:</span>
<span class="c1">// - Name: 指标名称</span>
<span class="c1">// - Help: 帮助信息</span>
<span class="c1">// - Type: 指标类型 (COUNTER, GAUGE, HISTOGRAM, SUMMARY)</span>
<span class="c1">// - Metric: 具体的指标值和标签</span>
</code></pre></div>
<hr />
<h4 id="2-expfmtmetricfamilytotext">2. expfmt.MetricFamilyToText()<a class="headerlink" href="#2-expfmtmetricfamilytotext" title="Permanent link">&para;</a></h4>
<p>将 MetricFamily 写入文本格式:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">metricFamilies</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 写入 Prometheus text format</span>
<span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">expfmt</span><span class="p">.</span><span class="nx">MetricFamilyToText</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>支持的格式:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Text format (默认,推荐)</span>
<span class="nx">expfmt</span><span class="p">.</span><span class="nx">MetricFamilyToText</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span><span class="w"> </span><span class="nx">metricFamily</span><span class="p">)</span>

<span class="c1">// OpenMetrics format</span>
<span class="nx">encoder</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">expfmt</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span><span class="w"> </span><span class="nx">expfmt</span><span class="p">.</span><span class="nx">FmtOpenMetrics</span><span class="p">)</span>
<span class="nx">encoder</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">metricFamily</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="_140">实际应用场景<a class="headerlink" href="#_140" title="Permanent link">&para;</a></h3>
<h4 id="1">场景 1: 备份任务指标<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// backup_monitor.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w"> </span><span class="s">&quot;log&quot;</span>
<span class="w"> </span><span class="s">&quot;os&quot;</span>
<span class="w"> </span><span class="s">&quot;time&quot;</span>

<span class="w"> </span><span class="s">&quot;github.com/prometheus/client_golang/prometheus&quot;</span>
<span class="w"> </span><span class="s">&quot;github.com/prometheus/common/expfmt&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">recordBackupMetrics</span><span class="p">(</span><span class="nx">backupSize</span><span class="w"> </span><span class="kt">int64</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span><span class="w"> </span><span class="nx">success</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">registry</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewRegistry</span><span class="p">()</span>

<span class="w"> </span><span class="c1">// 备份大小</span>
<span class="w"> </span><span class="nx">sizeGauge</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewGauge</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeOpts</span><span class="p">{</span>
<span class="w">  </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;backup_size_bytes&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Size of the backup in bytes&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">})</span>
<span class="w"> </span><span class="nx">sizeGauge</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">backupSize</span><span class="p">))</span>
<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">sizeGauge</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 备份耗时</span>
<span class="w"> </span><span class="nx">durationGauge</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewGauge</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeOpts</span><span class="p">{</span>
<span class="w">  </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;backup_duration_seconds&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Duration of the backup in seconds&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">})</span>
<span class="w"> </span><span class="nx">durationGauge</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">duration</span><span class="p">.</span><span class="nx">Seconds</span><span class="p">())</span>
<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">durationGauge</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 最后备份时间</span>
<span class="w"> </span><span class="nx">timestampGauge</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewGauge</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeOpts</span><span class="p">{</span>
<span class="w">  </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;backup_last_success_timestamp&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Timestamp of the last successful backup&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="p">})</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">success</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">timestampGauge</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">()))</span>
<span class="w"> </span><span class="p">}</span>
<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">timestampGauge</span><span class="p">)</span>

<span class="w"> </span><span class="c1">// 写入 textfile</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">writeMetrics</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/var/lib/node_exporter/textfile_collector/backup.prom&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">writeMetrics</span><span class="p">(</span><span class="nx">registry</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Registry</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">tmpFile</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.tmp&quot;</span>
<span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w"> </span><span class="p">}</span>
<span class="w"> </span><span class="k">defer</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w"> </span><span class="nx">metricFamilies</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">Gather</span><span class="p">()</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">metricFamilies</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">expfmt</span><span class="p">.</span><span class="nx">MetricFamilyToText</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">  </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Rename</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="c1">// 执行备份</span>
<span class="w"> </span><span class="nx">backupSize</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">int64</span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="c1">// 500MB</span>
<span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">120</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
<span class="w"> </span><span class="nx">success</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">recordBackupMetrics</span><span class="p">(</span><span class="nx">backupSize</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="p">,</span><span class="w"> </span><span class="nx">success</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to record metrics: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Backup metrics recorded successfully&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Crontab:</strong></p>
<div class="highlight"><pre><span></span><code>0 2 * * * /usr/local/bin/backup.sh &amp;&amp; /usr/local/bin/backup_monitor
</code></pre></div>
<hr />
<h4 id="2_2">场景 2: 磁盘配额监控<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// disk_quota.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w"> </span><span class="s">&quot;fmt&quot;</span>
<span class="w"> </span><span class="s">&quot;os/exec&quot;</span>
<span class="w"> </span><span class="s">&quot;strconv&quot;</span>
<span class="w"> </span><span class="s">&quot;strings&quot;</span>

<span class="w"> </span><span class="s">&quot;github.com/prometheus/client_golang/prometheus&quot;</span>
<span class="w"> </span><span class="s">&quot;github.com/prometheus/common/expfmt&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">QuotaInfo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">User</span><span class="w">      </span><span class="kt">string</span>
<span class="w"> </span><span class="nx">UsedBytes</span><span class="w"> </span><span class="kt">int64</span>
<span class="w"> </span><span class="nx">LimitBytes</span><span class="w"> </span><span class="kt">int64</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">getQuotaInfo</span><span class="p">()</span><span class="w"> </span><span class="p">([]</span><span class="nx">QuotaInfo</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="c1">// 执行 quota 命令</span>
<span class="w"> </span><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="s">&quot;quota&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-v&quot;</span><span class="p">)</span>
<span class="w"> </span><span class="nx">output</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Output</span><span class="p">()</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 解析输出 (示例)</span>
<span class="w"> </span><span class="nx">quotas</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">QuotaInfo</span><span class="p">{</span>
<span class="w">  </span><span class="p">{</span><span class="nx">User</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;alice&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">UsedBytes</span><span class="p">:</span><span class="w"> </span><span class="mi">5368709120</span><span class="p">,</span><span class="w"> </span><span class="nx">LimitBytes</span><span class="p">:</span><span class="w"> </span><span class="mi">10737418240</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="nx">User</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bob&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">UsedBytes</span><span class="p">:</span><span class="w"> </span><span class="mi">8589934592</span><span class="p">,</span><span class="w"> </span><span class="nx">LimitBytes</span><span class="p">:</span><span class="w"> </span><span class="mi">10737418240</span><span class="p">},</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">quotas</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">recordQuotaMetrics</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">registry</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewRegistry</span><span class="p">()</span>

<span class="w"> </span><span class="nx">usedGauge</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewGaugeVec</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeOpts</span><span class="p">{</span>
<span class="w">   </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;disk_quota_used_bytes&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Disk quota used in bytes&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;user&quot;</span><span class="p">},</span>
<span class="w"> </span><span class="p">)</span>

<span class="w"> </span><span class="nx">limitGauge</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewGaugeVec</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeOpts</span><span class="p">{</span>
<span class="w">   </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;disk_quota_limit_bytes&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Disk quota limit in bytes&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;user&quot;</span><span class="p">},</span>
<span class="w"> </span><span class="p">)</span>

<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">usedGauge</span><span class="p">)</span>
<span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">limitGauge</span><span class="p">)</span>

<span class="w"> </span><span class="nx">quotas</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getQuotaInfo</span><span class="p">()</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">q</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">quotas</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">usedGauge</span><span class="p">.</span><span class="nx">WithLabelValues</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">User</span><span class="p">).</span><span class="nx">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">UsedBytes</span><span class="p">))</span>
<span class="w">  </span><span class="nx">limitGauge</span><span class="p">.</span><span class="nx">WithLabelValues</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">User</span><span class="p">).</span><span class="nx">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">LimitBytes</span><span class="p">))</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">writeMetrics</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/var/lib/node_exporter/textfile_collector/disk_quota.prom&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Crontab:</strong></p>
<div class="highlight"><pre><span></span><code>*/5 * * * * /usr/local/bin/disk_quota_monitor
</code></pre></div>
<hr />
<h4 id="3-shell">场景 3: Shell 脚本生成指标<a class="headerlink" href="#3-shell" title="Permanent link">&para;</a></h4>
<p><strong>bash 版本:</strong></p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># generate_metrics.sh</span>

<span class="nv">TEXTFILE_DIR</span><span class="o">=</span><span class="s2">&quot;/var/lib/node_exporter/textfile_collector&quot;</span>
<span class="nv">METRIC_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$TEXTFILE_DIR</span><span class="s2">/custom.prom&quot;</span>
<span class="nv">TMP_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$METRIC_FILE</span><span class="s2">.</span><span class="nv">$$</span><span class="s2">&quot;</span>

<span class="c1"># 生成指标</span>
cat<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s"># HELP custom_database_connections Active database connections</span>
<span class="s"># TYPE custom_database_connections gauge</span>
<span class="s">custom_database_connections{database=&quot;primary&quot;} $(mysql -e &quot;SHOW STATUS LIKE &#39;Threads_connected&#39;&quot; | awk &#39;NR==2 {print $2}&#39;)</span>
<span class="s">custom_database_connections{database=&quot;replica&quot;} $(mysql -h replica -e &quot;SHOW STATUS LIKE &#39;Threads_connected&#39;&quot; | awk &#39;NR==2 {print $2}&#39;)</span>

<span class="s"># HELP custom_log_errors_total Total number of errors in logs</span>
<span class="s"># TYPE custom_log_errors_total counter</span>
<span class="s">custom_log_errors_total $(grep -c ERROR /var/log/app.log)</span>
<span class="s">EOF</span>

<span class="c1"># 原子移动</span>
mv<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$METRIC_FILE</span><span class="s2">&quot;</span>
</code></pre></div>
<p><strong>Python 版本:</strong></p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">CollectorRegistry</span><span class="p">,</span> <span class="n">Gauge</span><span class="p">,</span> <span class="n">write_to_textfile</span>

<span class="n">registry</span> <span class="o">=</span> <span class="n">CollectorRegistry</span><span class="p">()</span>

<span class="c1"># 创建指标</span>
<span class="n">connections</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;custom_database_connections&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Active database connections&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">],</span>
    <span class="n">registry</span><span class="o">=</span><span class="n">registry</span>
<span class="p">)</span>

<span class="c1"># 设置值</span>
<span class="n">connections</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">connections</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="s1">&#39;replica&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span>

<span class="c1"># 写入文件</span>
<span class="n">write_to_textfile</span><span class="p">(</span>
    <span class="s1">&#39;/var/lib/node_exporter/textfile_collector/custom.prom&#39;</span><span class="p">,</span>
    <span class="n">registry</span>
<span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="_141">最佳实践<a class="headerlink" href="#_141" title="Permanent link">&para;</a></h3>
<h4 id="1_1">1. 使用原子写入<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// ✅ 好 - 原子写入,避免 Node Exporter 读取部分文件</span>
<span class="nx">tmpFile</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.tmp&quot;</span>
<span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="c1">// ... 写入内容</span>
<span class="nx">os</span><span class="p">.</span><span class="nx">Rename</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">)</span>

<span class="c1">// ❌ 不好 - 直接写入,可能读取到不完整数据</span>
<span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
<span class="c1">// ... 写入内容</span>
</code></pre></div>
<hr />
<h4 id="2_3">2. 添加文件修改时间指标<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// 添加文件生成时间,用于监控脚本是否正常运行</span>
<span class="nx">timestampGauge</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">NewGauge</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeOpts</span><span class="p">{</span>
<span class="w"> </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;textfile_scrape_timestamp&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nx">Help</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Timestamp of the last textfile generation&quot;</span><span class="p">,</span>
<span class="p">})</span>
<span class="nx">timestampGauge</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">()))</span>
<span class="nx">registry</span><span class="p">.</span><span class="nx">MustRegister</span><span class="p">(</span><span class="nx">timestampGauge</span><span class="p">)</span>
</code></pre></div>
<p><strong>告警规则:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TextfileStale</span>
<span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time() - textfile_scrape_timestamp &gt; 3600</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Textfile</span><span class="nv"> </span><span class="s">超过</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">小时未更新&quot;</span>
</code></pre></div>
<hr />
<h4 id="3_5">3. 错误处理<a class="headerlink" href="#3_5" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">writeMetricsWithErrorHandling</span><span class="p">(</span><span class="nx">registry</span><span class="w"> </span><span class="o">*</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Registry</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="nx">tmpFile</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.tmp&quot;</span>

<span class="w"> </span><span class="c1">// 创建临时文件</span>
<span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;create temp file: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 收集指标</span>
<span class="w"> </span><span class="nx">mfs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">registry</span><span class="p">.</span><span class="nx">Gather</span><span class="p">()</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">file</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="w">  </span><span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;gather metrics: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 写入指标</span>
<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">mfs</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">expfmt</span><span class="p">.</span><span class="nx">MetricFamilyToText</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">mf</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">file</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="w">   </span><span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;write metric: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 关闭文件</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">Close</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;close file: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="c1">// 原子重命名</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Rename</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">tmpFile</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;rename file: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h4 id="4_2">4. 文件权限<a class="headerlink" href="#4_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 确保 Node Exporter 用户可读</span>
chmod<span class="w"> </span><span class="m">644</span><span class="w"> </span>/var/lib/node_exporter/textfile_collector/*.prom

<span class="c1"># 目录权限</span>
chmod<span class="w"> </span><span class="m">755</span><span class="w"> </span>/var/lib/node_exporter/textfile_collector
</code></pre></div>
<hr />
<h3 id="prometheus_12">Prometheus 配置<a class="headerlink" href="#prometheus_12" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;node&#39;</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9100&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<hr />
<h3 id="promql_5">PromQL 查询示例<a class="headerlink" href="#promql_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 查询 textfile 指标</span>
<span class="nv">custom_metric_gauge</span>

<span class="c1"># 检查 textfile 是否过期</span>
<span class="kr">time</span><span class="o">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">textfile_scrape_timestamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3600</span>

<span class="c1"># 备份大小趋势</span>
<span class="nv">backup_size_bytes</span>

<span class="c1"># 磁盘配额使用率</span>
<span class="nv">disk_quota_used_bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">disk_quota_limit_bytes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span>
</code></pre></div>
<hr />
<h3 id="textfile-collector_1">监控 Textfile Collector<a class="headerlink" href="#textfile-collector_1" title="Permanent link">&para;</a></h3>
<p><strong>Node Exporter 暴露的相关指标:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># textfile collector 读取错误</span>
<span class="nv">node_textfile_scrape_error</span>

<span class="c1"># 最后一次成功读取时间</span>
<span class="nv">node_textfile_mtime_seconds</span>

<span class="c1"># textfile 文件数量</span>
<span class="k">count</span><span class="o">(</span><span class="nv">node_textfile_mtime_seconds</span><span class="o">)</span>
</code></pre></div>
<p><strong>告警规则:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">textfile_collector</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Textfile 读取错误</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TextfileScrapeError</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node_textfile_scrape_error == 1</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Textfile</span><span class="nv"> </span><span class="s">collector</span><span class="nv"> </span><span class="s">读取错误&quot;</span>

<span class="w">      </span><span class="c1"># Textfile 文件过期</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TextfileStale</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time() - node_textfile_mtime_seconds &gt; 3600</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Textfile</span><span class="nv"> </span><span class="s">超过</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">小时未更新&quot;</span>
</code></pre></div>
<hr />
<h3 id="_142">常见问题<a class="headerlink" href="#_142" title="Permanent link">&para;</a></h3>
<p><strong>Q1: 指标未出现在 Node Exporter?</strong></p>
<p>A: 检查以下项:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 文件是否存在</span>
ls<span class="w"> </span>-la<span class="w"> </span>/var/lib/node_exporter/textfile_collector/

<span class="c1"># 2. 文件权限</span>
chmod<span class="w"> </span><span class="m">644</span><span class="w"> </span>/var/lib/node_exporter/textfile_collector/*.prom

<span class="c1"># 3. 文件格式是否正确</span>
cat<span class="w"> </span>/var/lib/node_exporter/textfile_collector/*.prom

<span class="c1"># 4. 检查 Node Exporter 日志</span>
journalctl<span class="w"> </span>-u<span class="w"> </span>node_exporter<span class="w"> </span>-f

<span class="c1"># 5. 检查 scrape 错误</span>
curl<span class="w"> </span>http://localhost:9100/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>node_textfile_scrape_error
</code></pre></div>
<hr />
<p><strong>Q2: 格式错误导致指标无法读取?</strong></p>
<p>A: 确保格式正确:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ✅ 正确格式</span>
<span class="c1"># HELP metric_name Metric description</span>
<span class="c1"># TYPE metric_name gauge</span>
<span class="nv">metric_name</span><span class="p">{</span><span class="nl">label</span><span class="o">=</span><span class="p">&quot;</span><span class="s">value</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">42</span>

<span class="c1"># ❌ 错误格式 (缺少 HELP/TYPE)</span>
<span class="nv">metric_name</span><span class="p">{</span><span class="nl">label</span><span class="o">=</span><span class="p">&quot;</span><span class="s">value</span><span class="p">&quot;}</span><span class="w"> </span><span class="mi">42</span>
</code></pre></div>
<hr />
<p><strong>Q3: 如何删除指标?</strong></p>
<p>A: 删除对应的 <code>.prom</code> 文件:</p>
<div class="highlight"><pre><span></span><code>rm<span class="w"> </span>/var/lib/node_exporter/textfile_collector/custom.prom
</code></pre></div>
<p>Node Exporter 会在下次 scrape 时自动移除这些指标。</p>
<hr />
<h3 id="_143">性能考虑<a class="headerlink" href="#_143" title="Permanent link">&para;</a></h3>
<p><strong>文件数量限制:</strong></p>
<ul>
<li>✅ 建议每个脚本/任务一个文件</li>
<li>✅ 总文件数 &lt; 100</li>
<li>❌ 避免过多小文件</li>
</ul>
<p><strong>文件大小:</strong></p>
<ul>
<li>✅ 每个文件 &lt; 10MB</li>
<li>❌ 避免大量时间序列</li>
</ul>
<p><strong>更新频率:</strong></p>
<ul>
<li>✅ 批处理任务: 按需更新</li>
<li>✅ 定期任务: 1-5 分钟</li>
<li>❌ 避免高频更新 (&lt; 10s)</li>
</ul>
<hr />
<h3 id="_144">总结<a class="headerlink" href="#_144" title="Permanent link">&para;</a></h3>
<p><strong>Textfile Collector 适用于:</strong></p>
<ul>
<li>✅ Cron/批处理任务生成指标</li>
<li>✅ Shell/Python 脚本导出指标</li>
<li>✅ 静态指标和配置信息</li>
<li>✅ 本地文件系统可访问的场景</li>
</ul>
<p><strong>关键要点:</strong></p>
<ol>
<li>使用 <code>registry.Gather()</code> 收集指标</li>
<li>使用 <code>expfmt.MetricFamilyToText()</code> 写入文件</li>
<li>使用临时文件 + 原子重命名</li>
<li>添加时间戳指标监控脚本运行</li>
<li>正确的文件权限 (644)</li>
</ol>
<p><strong>对比 Pushgateway:</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Textfile Collector</th>
<th>Pushgateway</th>
</tr>
</thead>
<tbody>
<tr>
<td>部署复杂度</td>
<td>低 (复用 Node Exporter)</td>
<td>中 (需要额外组件)</td>
</tr>
<tr>
<td>网络依赖</td>
<td>无 (本地文件)</td>
<td>有 (HTTP 推送)</td>
</tr>
<tr>
<td>生命周期</td>
<td>自动 (删除文件)</td>
<td>手动 (需调用 Delete)</td>
</tr>
<tr>
<td>适用场景</td>
<td>本地定时任务</td>
<td>远程批处理任务</td>
</tr>
</tbody>
</table>
<p>完整代码可作为批处理任务指标导出的最佳实践！🎯</p>
<hr />
<hr />
<h2 id="python-shell">附录: Python &amp; Shell 完整示例<a class="headerlink" href="#python-shell" title="Permanent link">&para;</a></h2>
<p>本章节提供 Python 和 Shell 脚本的完整 Prometheus 集成示例，涵盖三种主要模式。</p>
<hr />
<h3 id="python-http-exporter">Python HTTP Exporter<a class="headerlink" href="#python-http-exporter" title="Permanent link">&para;</a></h3>
<h4 id="_145">概述<a class="headerlink" href="#_145" title="Permanent link">&para;</a></h4>
<p>使用 <code>prometheus_client</code> 库创建 HTTP 端点暴露指标，适合长期运行的服务。</p>
<h4 id="_146">完整代码<a class="headerlink" href="#_146" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">start_http_server</span><span class="p">,</span> <span class="n">Gauge</span><span class="p">,</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="n">REGISTRY</span>

<span class="c1"># 定义指标</span>
<span class="n">cpu_usage</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;system_cpu_usage_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;CPU usage&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">],</span> <span class="n">registry</span><span class="o">=</span><span class="n">REGISTRY</span><span class="p">)</span>
<span class="n">memory_usage</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;system_memory_usage_bytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Memory usage&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">registry</span><span class="o">=</span><span class="n">REGISTRY</span><span class="p">)</span>
<span class="n">request_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;http_requests_total&#39;</span><span class="p">,</span> <span class="s1">&#39;HTTP requests&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;endpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">],</span> <span class="n">registry</span><span class="o">=</span><span class="n">REGISTRY</span><span class="p">)</span>
<span class="n">request_duration</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span><span class="s1">&#39;http_request_duration_seconds&#39;</span><span class="p">,</span> <span class="s1">&#39;Request latency&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;endpoint&#39;</span><span class="p">],</span> <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">registry</span><span class="o">=</span><span class="n">REGISTRY</span><span class="p">)</span>
<span class="n">app_info</span> <span class="o">=</span> <span class="n">Info</span><span class="p">(</span><span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;Application info&#39;</span><span class="p">,</span> <span class="n">registry</span><span class="o">=</span><span class="n">REGISTRY</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">update_system_metrics</span><span class="p">():</span>
    <span class="n">cpu_percent</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">percpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">percent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cpu_percent</span><span class="p">):</span>
        <span class="n">cpu_usage</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">cpu</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;cpu</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>

    <span class="n">mem</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
    <span class="n">memory_usage</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">mem</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
    <span class="n">memory_usage</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;used&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">mem</span><span class="o">.</span><span class="n">used</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app_info</span><span class="o">.</span><span class="n">info</span><span class="p">({</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">:</span> <span class="s1">&#39;production&#39;</span><span class="p">})</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">8000</span>
    <span class="n">start_http_server</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metrics: http://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">/metrics&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">update_system_metrics</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shutting down...&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h4 id="_147">安装和运行<a class="headerlink" href="#_147" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 安装依赖</span>
pip<span class="w"> </span>install<span class="w"> </span>prometheus-client<span class="w"> </span>psutil

<span class="c1"># 运行</span>
python3<span class="w"> </span>python_http_exporter.py

<span class="c1"># 查看指标</span>
curl<span class="w"> </span>http://localhost:8000/metrics
</code></pre></div>
<hr />
<h3 id="python-pushgateway">Python Pushgateway<a class="headerlink" href="#python-pushgateway" title="Permanent link">&para;</a></h3>
<h4 id="_148">完整代码<a class="headerlink" href="#_148" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">CollectorRegistry</span><span class="p">,</span> <span class="n">Gauge</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">push_to_gateway</span><span class="p">,</span> <span class="n">delete_from_gateway</span>

<span class="n">registry</span> <span class="o">=</span> <span class="n">CollectorRegistry</span><span class="p">()</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;batch_processing_size&#39;</span><span class="p">,</span> <span class="s1">&#39;Batch size&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;batch_id&#39;</span><span class="p">],</span> <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">)</span>
<span class="n">batch_processed</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;batch_items_processed_total&#39;</span><span class="p">,</span> <span class="s1">&#39;Items processed&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;batch_id&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">],</span> <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">item_count</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing batch: </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">batch_size</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">batch_id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">item_count</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">item_count</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="n">batch_processed</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">batch_id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_processed</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">batch_id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;failed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">pushgateway_url</span> <span class="o">=</span> <span class="s1">&#39;localhost:9091&#39;</span>
    <span class="n">job_name</span> <span class="o">=</span> <span class="s1">&#39;batch_job&#39;</span>
    <span class="n">grouping_key</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()}</span>

    <span class="n">batch_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;batch_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">process_batch</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">push_to_gateway</span><span class="p">(</span><span class="n">pushgateway_url</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span> <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">,</span> <span class="n">grouping_key</span><span class="o">=</span><span class="n">grouping_key</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metrics pushed to </span><span class="si">{</span><span class="n">pushgateway_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">delete_from_gateway</span><span class="p">(</span><span class="n">pushgateway_url</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span> <span class="n">grouping_key</span><span class="o">=</span><span class="n">grouping_key</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h4 id="_149">运行<a class="headerlink" href="#_149" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 启动 Pushgateway</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">9091</span>:9091<span class="w"> </span>prom/pushgateway

<span class="c1"># 运行脚本</span>
python3<span class="w"> </span>python_pushgateway.py
</code></pre></div>
<hr />
<h3 id="python-textfile-collector">Python Textfile Collector<a class="headerlink" href="#python-textfile-collector" title="Permanent link">&para;</a></h3>
<h4 id="_150">完整代码<a class="headerlink" href="#_150" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">CollectorRegistry</span><span class="p">,</span> <span class="n">Gauge</span>
<span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">write_to_textfile</span>

<span class="n">TEXTFILE_DIR</span> <span class="o">=</span> <span class="s1">&#39;/var/lib/node_exporter/textfile_collector&#39;</span>
<span class="n">METRIC_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEXTFILE_DIR</span><span class="p">,</span> <span class="s1">&#39;custom_metrics.prom&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">TEXTFILE_DIR</span><span class="p">):</span>
    <span class="n">TEXTFILE_DIR</span> <span class="o">=</span> <span class="s1">&#39;/tmp/textfile_collector&#39;</span>
    <span class="n">METRIC_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEXTFILE_DIR</span><span class="p">,</span> <span class="s1">&#39;custom_metrics.prom&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">TEXTFILE_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">registry</span> <span class="o">=</span> <span class="n">CollectorRegistry</span><span class="p">()</span>

<span class="n">disk_usage</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;custom_disk_usage_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;Disk usage&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mountpoint&#39;</span><span class="p">],</span> <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">)</span>
<span class="n">scrape_timestamp</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;custom_textfile_scrape_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;Last scrape time&#39;</span><span class="p">,</span> <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">collect_metrics</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">partition</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_partitions</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">usage</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="n">partition</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span>
            <span class="n">disk_usage</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">mountpoint</span><span class="o">=</span><span class="n">partition</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">percent</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="n">scrape_timestamp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Collecting metrics...&quot;</span><span class="p">)</span>
    <span class="n">collect_metrics</span><span class="p">()</span>

    <span class="n">tmp_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">METRIC_FILE</span><span class="si">}</span><span class="s2">.tmp&quot;</span>
    <span class="n">write_to_textfile</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="n">METRIC_FILE</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metrics written to: </span><span class="si">{</span><span class="n">METRIC_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h4 id="crontab">Crontab 配置<a class="headerlink" href="#crontab" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>*/5 * * * * /usr/bin/python3 /path/to/python_textfile_collector.py
</code></pre></div>
<hr />
<h3 id="shell-textfile-collector">Shell Textfile Collector<a class="headerlink" href="#shell-textfile-collector" title="Permanent link">&para;</a></h3>
<h4 id="_151">完整代码<a class="headerlink" href="#_151" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">set</span><span class="w"> </span>-e

<span class="nv">TEXTFILE_DIR</span><span class="o">=</span><span class="s2">&quot;/var/lib/node_exporter/textfile_collector&quot;</span>
<span class="nv">METRIC_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$TEXTFILE_DIR</span><span class="s2">/shell_metrics.prom&quot;</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TEXTFILE_DIR</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">TEXTFILE_DIR</span><span class="o">=</span><span class="s2">&quot;/tmp/textfile_collector&quot;</span>
<span class="w">    </span><span class="nv">METRIC_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$TEXTFILE_DIR</span><span class="s2">/shell_metrics.prom&quot;</span>
<span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TEXTFILE_DIR</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="nv">TMP_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$METRIC_FILE</span><span class="s2">.</span><span class="nv">$$</span><span class="s2">&quot;</span>

:<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span>

<span class="c1"># 系统负载</span>
<span class="nv">LOAD_1</span><span class="o">=</span><span class="k">$(</span>uptime<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;load average:&#39;</span><span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F,<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39; &#39;</span><span class="k">)</span>
cat<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s"># HELP shell_system_load System load average</span>
<span class="s"># TYPE shell_system_load gauge</span>
<span class="s">shell_system_load{period=&quot;1m&quot;} $LOAD_1</span>

<span class="s">EOF</span>

<span class="c1"># 磁盘使用</span>
cat<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s"># HELP shell_disk_usage_percent Disk usage percentage</span>
<span class="s"># TYPE shell_disk_usage_percent gauge</span>
<span class="s">EOF</span>

df<span class="w"> </span>-h<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;NR&gt;1 &amp;&amp; $1 ~ /^\// {</span>
<span class="s1">    gsub(/%/, &quot;&quot;, $5)</span>
<span class="s1">    printf &quot;shell_disk_usage_percent{mountpoint=\&quot;%s\&quot;} %s\n&quot;, $6, $5</span>
<span class="s1">}&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span>

<span class="c1"># 内存使用</span>
<span class="nv">MEMORY_TOTAL</span><span class="o">=</span><span class="k">$(</span>free<span class="w"> </span>-b<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;/^Mem:/ {print $2}&#39;</span><span class="k">)</span>
cat<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s"># HELP shell_memory_bytes Memory usage</span>
<span class="s"># TYPE shell_memory_bytes gauge</span>
<span class="s">shell_memory_bytes{type=&quot;total&quot;} $MEMORY_TOTAL</span>

<span class="s">EOF</span>

<span class="c1"># 时间戳</span>
cat<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s"># HELP shell_textfile_scrape_timestamp Timestamp</span>
<span class="s"># TYPE shell_textfile_scrape_timestamp gauge</span>
<span class="s">shell_textfile_scrape_timestamp $(date +%s)</span>
<span class="s">EOF</span>

mv<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TMP_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$METRIC_FILE</span><span class="s2">&quot;</span>
chmod<span class="w"> </span><span class="m">644</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$METRIC_FILE</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Metrics written to: </span><span class="nv">$METRIC_FILE</span><span class="s2">&quot;</span>
</code></pre></div>
<h4 id="_152">使用方法<a class="headerlink" href="#_152" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>chmod<span class="w"> </span>+x<span class="w"> </span>shell_textfile_collector.sh
./shell_textfile_collector.sh

<span class="c1"># Crontab</span>
*/5<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>/path/to/shell_textfile_collector.sh
</code></pre></div>
<hr />
<h3 id="_153">对比总结<a class="headerlink" href="#_153" title="Permanent link">&para;</a></h3>
<h4 id="_154">语言选择<a class="headerlink" href="#_154" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>特性</th>
<th>Python</th>
<th>Go</th>
<th>Shell</th>
</tr>
</thead>
<tbody>
<tr>
<td>性能</td>
<td>中</td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td>部署</td>
<td>需要 Python 环境</td>
<td>单一二进制</td>
<td>无依赖</td>
</tr>
<tr>
<td>开发效率</td>
<td>高</td>
<td>中</td>
<td>中</td>
</tr>
<tr>
<td>适用场景</td>
<td>数据处理、脚本</td>
<td>生产服务</td>
<td>系统监控</td>
</tr>
</tbody>
</table>
<h4 id="_155">模式选择<a class="headerlink" href="#_155" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>模式</th>
<th>优势</th>
<th>劣势</th>
<th>场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>HTTP Exporter</strong></td>
<td>实时更新</td>
<td>需要暴露端口</td>
<td>长期服务</td>
</tr>
<tr>
<td><strong>Pushgateway</strong></td>
<td>适合批处理</td>
<td>需要额外组件</td>
<td>批处理任务</td>
</tr>
<tr>
<td><strong>Textfile</strong></td>
<td>简单、无依赖</td>
<td>定期更新</td>
<td>定时任务</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_156">最佳实践<a class="headerlink" href="#_156" title="Permanent link">&para;</a></h3>
<h4 id="http-exporter">HTTP Exporter<a class="headerlink" href="#http-exporter" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用自定义 Registry</span>
<span class="n">registry</span> <span class="o">=</span> <span class="n">CollectorRegistry</span><span class="p">()</span>

<span class="c1"># 合理标签基数</span>
<span class="n">gauge</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">])</span>  <span class="c1"># ✅ 低基数</span>
<span class="n">gauge</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>  <span class="c1"># ❌ 高基数</span>
</code></pre></div>
<h4 id="pushgateway_3">Pushgateway<a class="headerlink" href="#pushgateway_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 任务结束时删除指标</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">push_to_gateway</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">delete_from_gateway</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="s1">&#39;batch&#39;</span><span class="p">)</span>
</code></pre></div>
<h4 id="textfile-collector_2">Textfile Collector<a class="headerlink" href="#textfile-collector_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 原子写入</span>
<span class="n">tmp_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_file</span><span class="si">}</span><span class="s2">.tmp&quot;</span>
<span class="n">write_to_textfile</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="n">metric_file</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="prometheus_13">Prometheus 配置<a class="headerlink" href="#prometheus_13" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;python_exporter&#39;</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:8000&#39;</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pushgateway&#39;</span>
<span class="w">    </span><span class="nt">honor_labels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9091&#39;</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;node&#39;</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;localhost:9100&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<hr />
<h3 id="_157">总结<a class="headerlink" href="#_157" title="Permanent link">&para;</a></h3>
<p>本章节提供了完整的示例代码：</p>
<ul>
<li>✅ <strong>3 种语言</strong>: Go、Python、Shell</li>
<li>✅ <strong>3 种模式</strong>: HTTP、Pushgateway、Textfile</li>
<li>✅ <strong>4 种指标</strong>: Counter、Gauge、Histogram、Info</li>
<li>✅ <strong>最佳实践</strong>: 原子写入、错误处理、标签使用</li>
</ul>
<p>所有代码均可直接用于生产环境！🎯</p>
<hr />

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            回到页面顶部
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../../network/2025-12-24-kubernetes-network-learning_Notes/" class="md-footer__link md-footer__link--prev" aria-label="上一页: kubernetes 网络学习笔记" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              kubernetes 网络学习笔记
            </div>
          </div>
        </a>
      
      
        
        <a href="../../cert-manager/1-2025-03-29-cert-manager-install-doc/" class="md-footer__link md-footer__link--next" aria-label="下一页: kubernetes Cert-manager 安装" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              kubernetes Cert-manager 安装
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 lixie
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/cnych" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://hub.docker.com/r/cnych/" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/cnych" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://instagram.com/cnych" target="_blank" rel="noopener" title="instagram.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections", "navigation.instant.prefetch", "navigation.prune", "navigation.tabs", "navigation.tabs.sticky", "navigation.expand", "navigation.indexes", "navigation.top", "search.suggest", "search.highlight", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.01824240.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e8a254df.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="../../../js/baidu-tongji.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>