
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Project documentation with Markdown.">
      
      
        <meta name="author" content="Li">
      
      
        <link rel="canonical" href="https://yuki-0215.github.io/2.k8s/network/2025-12-24-kubernetes-network-learning_Notes/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-8.0.0">
    
    
      
        <title>kubernetes 网络学习笔记 - Kubernetes 进阶训练营</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.ad626c1e.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/custom.css">
    
    <script>function __md_scope(e,t,_){return new URL(_||(t===localStorage?"../../..":"../../.."),location).pathname+"."+e}function __md_get(e,t=localStorage,_){return JSON.parse(t.getItem(__md_scope(e,t,_)))}function __md_set(e,t,_=localStorage,o){try{_.setItem(__md_scope(e,_,o),JSON.stringify(t))}catch(e){}}</script>
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubernetes" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="Kubernetes 进阶训练营" class="md-header__button md-logo" aria-label="Kubernetes 进阶训练营" data-md-component="logo">
      
  <img src="../../../material/logo.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kubernetes 进阶训练营
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              kubernetes 网络学习笔记
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换暗色主题"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="切换暗色主题" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="切换亮色主题"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="切换亮色主题" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Yuki-0215/Yuki-0215.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      首页
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../0.Internet/2024-02-20-Tcp-ip-docs/" class="md-tabs__link">
        0、网络基础
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../1.Linux/hardware/1-2025-04-03-Hardware-cpu-benchmark-report-doc/" class="md-tabs__link">
        1、Linux
      </a>
    </li>
  

  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%91%E5%8E%9F%E7%94%9F/" class="md-tabs__link md-tabs__link--active">
        2、kubernetes
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../3.develop/python/2024-02-20-1-python-base-doc/" class="md-tabs__link">
        3、运维开发
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../4.database/mysql/2024-02-20-1-mysql-base-doc/" class="md-tabs__link">
        4、数据库
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../5.Storage/2024-02-20-disk-ssd-docs/" class="md-tabs__link">
        5、存储服务
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../6.Devops/2024-9-26-Git-docs/" class="md-tabs__link">
        6、Devops
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../7.Web/http/1-2025-03-30-http-web-doc/" class="md-tabs__link">
        7、Web
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-case1/" class="md-tabs__link">
        8、运维自动化
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../9.other/rustdesk/2026-01-06-%E8%87%AA%E5%BB%BARustDesk%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%99%E7%A8%8B/" class="md-tabs__link">
        9、其他
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../10.Ai-tools/cursor/2024-02-27-cursor-latest-features/" class="md-tabs__link">
        10、Ai
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../20.mylife/2024-9-24-myblog-life-docs/" class="md-tabs__link">
        关于我
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Kubernetes 进阶训练营" class="md-nav__button md-logo" aria-label="Kubernetes 进阶训练营" data-md-component="logo">
      
  <img src="../../../material/logo.jpg" alt="logo">

    </a>
    Kubernetes 进阶训练营
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Yuki-0215/Yuki-0215.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        首页
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" data-md-state="indeterminate" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          0、网络基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="0、网络基础" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          0、网络基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-Tcp-ip-docs/" class="md-nav__link">
        网络 Tcp/IP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-5g-docs/" class="md-nav__link">
        网络 思科设备
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-IB-ET-docs/" class="md-nav__link">
        网络 网卡模式调整
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-ZeroTier/" class="md-nav__link">
        ZeroTier组网
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-frp/" class="md-nav__link">
        frp 内网穿透
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-3-network-docs/" class="md-nav__link">
        kubernetes 网络组件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../0.Internet/2024-02-20-4-network-docs/" class="md-nav__link">
        科学上网
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/asus/asus-docs.md" class="md-nav__link">
        华硕服务器
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" data-md-state="indeterminate" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          1、Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="1、Linux" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          1、Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" data-md-state="indeterminate" type="checkbox" id="__nav_3_1" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Linux 服务器验收
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux 服务器验收" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Linux 服务器验收
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/1-2025-04-03-Hardware-cpu-benchmark-report-doc/" class="md-nav__link">
        Linux 服务器 CPU性能测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/2-2025-04-04-Hardware-memary-report-doc/" class="md-nav__link">
        Linux 服务器 内存性能验收
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/3-2025-04-04-Hareware-disk-benchmark-report-doc/" class="md-nav__link">
        Linux 服务器 硬盘性能验收
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/4-2025-04-04-Hardware-GPU-benchmark-report-doc/" class="md-nav__link">
        Linux 服务器 GPU性能验收
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/5-2025-04-04-Hareware-H100-report-doc/" class="md-nav__link">
        Linux 服务器 H100服务器验收
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/6-2025-04-04-Hardware-FAQ-disk-report-doc/" class="md-nav__link">
        Linux 服务器 FAQ:为什么系统显示的磁盘大小会比实际小?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/7-2025-04-06-Hardware-FAQ-no-network-debug-doc/" class="md-nav__link">
        Linux 服务器 无网络环境调试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" data-md-state="indeterminate" type="checkbox" id="__nav_3_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Linux系统管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux系统管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Linux系统管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-kjc-doc/" class="md-nav__link">
        Linux 云计算手册大纲
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/hardware/2024-02-20-cpu-doc/" class="md-nav__link">
        Linux 硬件 CPU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-bmc-doc/" class="md-nav__link">
        Linux 带外管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-install-doc/" class="md-nav__link">
        Linux 系统安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/2025-03-27-linux-SM-doc-01/" class="md-nav__link">
        Linux 系统管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/2025-03-27-linux-SM-doc-02/" class="md-nav__link">
        Linux 系统管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-mirror-doc/" class="md-nav__link">
        Linux 国内apt源
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-nvme-doc/" class="md-nav__link">
        Linux nvme磁盘管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-parted-doc/" class="md-nav__link">
        Linux parted磁盘管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-reboot-doc/" class="md-nav__link">
        Linux 系统强制重启
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-disk-doc/" class="md-nav__link">
        Linux 磁盘管理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" data-md-state="indeterminate" type="checkbox" id="__nav_3_3" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_3">
          Linux服务管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux服务管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Linux服务管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ubuntu/2024-02-20-ubuntu-network-doc/" class="md-nav__link">
        Linux 网络服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/2024-9-25-ssh-proxy-docs/" class="md-nav__link">
        Linux SSH 转发代理实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/ekgc/1-2025-04-11-rsync-to-ceph-doc/" class="md-nav__link">
        Linux rsync 实现ceph文件同步
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" data-md-state="indeterminate" type="checkbox" id="__nav_3_4" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_4">
          Windows 系统服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Windows 系统服务" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Windows 系统服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/windows/1-2025-04-16-windows-jumpserver-doc/" class="md-nav__link">
        Windows 跳板机
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5" data-md-state="indeterminate" type="checkbox" id="__nav_3_5" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_5">
          笔记-SRE运维
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="笔记-SRE运维" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          笔记-SRE运维
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/1-2025-04-04-linux-basic-introduction-doc.md" class="md-nav__link">
        Linux基础入门
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/2-2025-04-04-shell-script-programming-doc.md" class="md-nav__link">
        Shell脚本编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/6-文本处理工具和正则表达式/6-2025-04-04-linux-file-io-redirect-doc.md" class="md-nav__link">
        文本处理工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/4-2025-04-04-regular-expressions-doc.md" class="md-nav__link">
        正则表达式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/5-2025-04-04-filesystem-management-doc.md" class="md-nav__link">
        文件系统管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/6-2025-04-04-package-management-doc.md" class="md-nav__link">
        软件包管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/7-2025-04-04-ACL-user-group-doc/" class="md-nav__link">
        用户和组权限管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/8-2025-04-04-process-management-doc.md" class="md-nav__link">
        进程管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/9-2025-04-04-memory-management-doc.md" class="md-nav__link">
        内存管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/10-2025-04-04-scheduled-tasks-doc.md" class="md-nav__link">
        计划任务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/31%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/31-2025-04-04-linux-log-management-doc/" class="md-nav__link">
        日志服务管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/11-2025-04-04-network-basics-doc.md" class="md-nav__link">
        网络基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/12-2025-04-04-network-configuration-doc.md" class="md-nav__link">
        网络配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/13-2025-04-04-dns-service-doc.md" class="md-nav__link">
        DNS服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/14-2025-04-04-ftp-service-doc.md" class="md-nav__link">
        FTP服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/15-2025-04-04-nfs-service-doc.md" class="md-nav__link">
        NFS服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/16-2025-04-04-samba-service-doc.md" class="md-nav__link">
        Samba服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/17-2025-04-04-dhcp-service-doc.md" class="md-nav__link">
        DHCP服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/18-2025-04-04-apache-service-doc.md" class="md-nav__link">
        Apache服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/19-2025-04-04-nginx-service-doc.md" class="md-nav__link">
        Nginx服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/20-2025-04-04-mysql-basics-doc.md" class="md-nav__link">
        MySQL基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/21-2025-04-04-mysql-management-doc.md" class="md-nav__link">
        MySQL管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/22-2025-04-04-mysql-optimization-doc.md" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/23-2025-04-04-mysql-backup-recovery-doc.md" class="md-nav__link">
        MySQL备份恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/24-2025-04-04-mysql-master-slave-doc.md" class="md-nav__link">
        MySQL主从复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/25-2025-04-04-mysql-high-availability-doc.md" class="md-nav__link">
        MySQL高可用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/26-2025-04-04-lvs-load-balancing-doc.md" class="md-nav__link">
        LVS负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/27-2025-04-04-keepalived-ha-doc.md" class="md-nav__link">
        Keepalived高可用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/28-2025-04-04-haproxy-load-balancing-doc.md" class="md-nav__link">
        HAProxy负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/29-2025-04-04-shell-advanced-programming-doc.md" class="md-nav__link">
        Shell高级编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/30-2025-04-04-python-basics-doc.md" class="md-nav__link">
        Python基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/31-2025-04-04-python-advanced-doc.md" class="md-nav__link">
        Python进阶
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/32-2025-04-04-python-network-programming-doc.md" class="md-nav__link">
        Python网络编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/33-2025-04-04-python-web-development-doc.md" class="md-nav__link">
        Python Web开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/34-2025-04-04-django-framework-doc.md" class="md-nav__link">
        Django框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/35-2025-04-04-devops-platform-development-doc.md" class="md-nav__link">
        运维平台开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/36-2025-04-04-jenkins-ci-doc.md" class="md-nav__link">
        Jenkins持续集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/37-2025-04-04-git-version-control-doc.md" class="md-nav__link">
        Git版本控制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/38-2025-04-04-docker-container-tech-doc.md" class="md-nav__link">
        Docker容器技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/39-2025-04-04-kubernetes-basics-doc.md" class="md-nav__link">
        Kubernetes基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/40-2025-04-04-elk-log-analysis-doc.md" class="md-nav__link">
        ELK日志分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/41-2025-04-04-prometheus-monitoring-doc.md" class="md-nav__link">
        Prometheus监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/42-2025-04-04-redis-caching-tech-doc.md" class="md-nav__link">
        Redis缓存技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/43-2025-04-04-redis-master-slave-recovery-doc/" class="md-nav__link">
        Redis主从复制故障恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/44-2025-04-04-redis-data-migration-cluster-doc/" class="md-nav__link">
        Redis数据迁移与集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/45-2025-04-04-zabbix-enterprise-monitor1-doc/" class="md-nav__link">
        Zabbix分布式监控(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE/46-2025-04-04-zabbix-enterprise-monitor2-doc/" class="md-nav__link">
        Zabbix分布式监控(二)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_6" data-md-state="indeterminate" type="checkbox" id="__nav_3_6" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_6">
          笔记-SRE-CTO
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="笔记-SRE-CTO" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_6">
          <span class="md-nav__icon md-icon"></span>
          笔记-SRE-CTO
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/01-2025-04-04-nginx-basic-introduction-doc/" class="md-nav__link">
        Nginx基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/02-2025-04-04-haproxy-basic-introduction-doc/" class="md-nav__link">
        HAProxy基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/03-2025-04-04-keepalived-basic-introduction-doc/" class="md-nav__link">
        Keepalived基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/04-2025-04-04-kvm-virtualization-doc/" class="md-nav__link">
        KVM虚拟化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/05-2025-04-04-vmware-vsphere-introduction-doc/" class="md-nav__link">
        VMware vSphere
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/06-2025-04-04-docker-container-doc/" class="md-nav__link">
        Docker容器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/07-2025-04-04-jumpserver-introduction-doc/" class="md-nav__link">
        JumpServer跳板机
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/08-2025-04-04-kubernetes-basic-doc/" class="md-nav__link">
        Kubernetes基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/09-2025-04-04-redis-distributed-storage-doc/" class="md-nav__link">
        Redis分布式存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/10-2025-04-04-zabbix-distributed-monitor-doc/" class="md-nav__link">
        Zabbix分布式监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/11-2025-04-04-jenkins-gitlab-cicd-doc/" class="md-nav__link">
        Jenkins与GitLab CI/CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/12-2025-04-04-message-queue-microservice-doc/" class="md-nav__link">
        消息队列与微服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/13-2025-04-04-elk-log-collection-doc/" class="md-nav__link">
        ELK日志收集
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/14-2025-04-04-ceph-distributed-storage-doc/" class="md-nav__link">
        Ceph分布式存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/15-2025-04-04-interview-notes-questions-doc/" class="md-nav__link">
        面试注意事项
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/16-2025-04-04-kubernetes-production-cases-doc/" class="md-nav__link">
        Kubernetes生产案例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-SRE-CTO/17-2025-04-04-aliyun-cloud-platform-doc/" class="md-nav__link">
        阿里云平台
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_7" data-md-state="indeterminate" type="checkbox" id="__nav_3_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_7">
          笔记-云原生
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="笔记-云原生" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_7">
          <span class="md-nav__icon md-icon"></span>
          笔记-云原生
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/01-2025-04-04-computer-basics-doc/" class="md-nav__link">
        计算机基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/02-2025-04-04-basic-regular-expression-doc/" class="md-nav__link">
        基本正则表达式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/03-2025-04-04-docker-practice1-doc/" class="md-nav__link">
        Docker实践(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/04-2025-04-04-docker-practice2-doc/" class="md-nav__link">
        Docker实践(二)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/05-2025-04-04-docker-practice3-doc/" class="md-nav__link">
        Docker实践(三)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/06-2025-04-04-docker-compose-examples-doc/" class="md-nav__link">
        Docker-Compose示例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/07-2025-04-04-docker-practice4-doc/" class="md-nav__link">
        Docker实践(四)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/08-2025-04-04-docker-practice5-doc/" class="md-nav__link">
        Docker实践(五)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/09-2025-04-04-docker-basic-doc/" class="md-nav__link">
        Docker基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/10-2025-04-04-docker-k8s-integration-doc/" class="md-nav__link">
        Docker与K8s集成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/11-2025-04-04-kubernetes-practice1-doc/" class="md-nav__link">
        Kubernetes实践(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/12-2025-04-04-kubernetes-practice2-doc/" class="md-nav__link">
        Kubernetes实践(二)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/13-2025-04-04-kubernetes-practice3-doc/" class="md-nav__link">
        Kubernetes实践(三)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/14-2025-04-04-network-communication-doc/" class="md-nav__link">
        网络通信详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/15-2025-04-04-rbac-access-control-doc/" class="md-nav__link">
        RBAC权限控制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/16-2025-04-04-kubernetes-basic-doc/" class="md-nav__link">
        Kubernetes基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/17-2025-04-04-prometheus-deployment-doc/" class="md-nav__link">
        Prometheus部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/18-2025-04-04-monitoring-metrics-storage-doc/" class="md-nav__link">
        监控指标存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/19-2025-04-04-chain-tracking-skywalking-doc/" class="md-nav__link">
        链路追踪Skywalking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/20-2025-04-04-ceph-deployment-maintenance-doc/" class="md-nav__link">
        Ceph部署维护
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/21-2025-04-04-ceph-basic-doc/" class="md-nav__link">
        Ceph基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/22-2025-04-04-microservice-envoy1-doc/" class="md-nav__link">
        微服务与Envoy实战(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/23-2025-04-04-envoy-practice2-doc/" class="md-nav__link">
        Envoy实战(二)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/24-2025-04-04-microservice-envoy3-doc/" class="md-nav__link">
        微服务与Envoy实战(三)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/25-2025-04-04-service-mesh-istio-doc/" class="md-nav__link">
        服务网格Istio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/26-2025-04-04-istio-traffic-management-doc/" class="md-nav__link">
        Istio流量管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/27-2025-04-04-istio-security-auth-doc/" class="md-nav__link">
        Istio遥测与安全认证
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/28-2025-04-04-istio-authorization-deployment-doc/" class="md-nav__link">
        Istio授权机制与部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/29-2025-04-04-serverless-knative1-doc/" class="md-nav__link">
        Serverless与Knative
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/31-2025-04-04-gitops-tekton-doc/" class="md-nav__link">
        GitOps之Tekton
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/32-2025-04-04-gitops-argocd1-doc/" class="md-nav__link">
        GitOps之ArgoCD(一)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/33-2025-04-04-gitops-argocd2-doc/" class="md-nav__link">
        GitOps之ArgoCD(二)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/magedu-cloud-native/34-2025-04-04-kubernetes-high-availability-doc/" class="md-nav__link">
        Kubernetes高可用实现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_8" data-md-state="indeterminate" type="checkbox" id="__nav_3_8" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_8">
          虚拟化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="虚拟化" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_8">
          <span class="md-nav__icon md-icon"></span>
          虚拟化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../1.Linux/promox/1-2025-03-29-promox-doc/" class="md-nav__link">
        Proxmox虚拟化
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          2、kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="2、kubernetes" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          2、kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%91%E5%8E%9F%E7%94%9F/" class="md-nav__link">
        什么是云原生
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/cncf-docs/" class="md-nav__link">
        云原生简介及CNCF
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2025-03-27-containerd-cli-docs/" class="md-nav__link">
        Containerd 基本管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/containerd/2024-04-08-containerd-remove-none-tag-image-doc/" class="md-nav__link">
        Containerd 镜像管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2024-02-20-docker-docs/" class="md-nav__link">
        Docker 基本管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/lxcfs.md" class="md-nav__link">
        lxcfs 介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2024-02-20-docker-images-docs/" class="md-nav__link">
        docker 镜像构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2024-02-20-docker-proxy-docs/" class="md-nav__link">
        docker proxy代理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2.docker/2024-02-20-docker-image-clash-docs/" class="md-nav__link">
        docker Clash代理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../base/k8s-overview/" class="md-nav__link">
        kubernetes 简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-3-k8s-systeminit-docs/" class="md-nav__link">
        kubernetes 集群部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2025-12-2-k8s-delete-namespace-docs/" class="md-nav__link">
        kubernetes 强制删除namespace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-9-19-k8s-update/" class="md-nav__link">
        kubernetes 集群升级
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-pod-base-docs/" class="md-nav__link">
        kubernetes pod 基础原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-pod-hook-docs/" class="md-nav__link">
        kubernetes pod 生命周期
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/6-kubernetes-etcd-docs/" class="md-nav__link">
        kubernetes etcd 简介与实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/7-kubernetes-coredns-docs/" class="md-nav__link">
        kubernetes coredns 简介与实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-calico-docs/" class="md-nav__link">
        kubernetes calico 网络
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2025-12-10-k8s-secret-docs/" class="md-nav__link">
        kubernetes secret 管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../yaml/yaml/" class="md-nav__link">
        kubernetes 资源清单
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../base/k8s-limit-docs/" class="md-nav__link">
        kubernetes 资源限制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-configmap-docs/" class="md-nav__link">
        kubernetes 配置管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/5-kubernetes-UI-docs/" class="md-nav__link">
        Kubernetes UI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-deploy-sts-ds-docs/" class="md-nav__link">
        kubernetes 控制器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ingress-%E6%B5%81%E9%87%8F/" class="md-nav__link">
        Ingress 流量
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" class="md-nav__link">
        服务发现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gateway-api/" class="md-nav__link">
        Gateway API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dns-%E4%BC%98%E5%8C%96/" class="md-nav__link">
        DNS 优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ingress-nginx/" class="md-nav__link">
        ingress-nginx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../service-profiles/" class="md-nav__link">
        Service Profiles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4-network-docs.md" class="md-nav__link">
        科学上网
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-pv-rep/" class="md-nav__link">
        kubernetes pv/pvc简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-mon-docs/" class="md-nav__link">
        kubernetes 监控服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-logs-docs/" class="md-nav__link">
        kubernetes 日志管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-k8s-istio-docs/" class="md-nav__link">
        kubernetes 服务网格
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ui/rancher-update-docs/" class="md-nav__link">
        kubernetes Rancher 升级
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/7-kubernetes-update-docs/" class="md-nav__link">
        kubernetes 节点维护
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../other/k8s-ca-docs/" class="md-nav__link">
        kubernetes 处理k8s证书过期
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/" class="md-nav__link">
        kubernete 日志架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/" class="md-nav__link">
        kubernetes EFK日志系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/3.k8s/7.logging/fluentd.md" class="md-nav__link">
        kubernete 日志fluentd
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/loki/" class="md-nav__link">
        kubernete Loki
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        kubernetes 日志读写分离模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        kubernetes 日志微服务模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" class="md-nav__link">
        kubernetes 日志配置文件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/%E6%97%A5%E5%BF%97%E6%8A%A5%E8%AD%A6/" class="md-nav__link">
        kubernetes 日志报警
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../7.logging/logql/" class="md-nav__link">
        kubernetes 日志 Logql
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ansible-install-k8s-docs.md" class="md-nav__link">
        kubernetes 自动化安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2024-02-20-4-ansible-install-k8s/" class="md-nav__link">
        kubernetes 项目一
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../basic/9-install-keepalived-cluster/" class="md-nav__link">
        kubernetes 项目二
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_51" type="checkbox" id="__nav_4_51" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_51">
          kubernetes 网络管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="kubernetes 网络管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_51">
          <span class="md-nav__icon md-icon"></span>
          kubernetes 网络管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          kubernetes 网络学习笔记
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        kubernetes 网络学习笔记
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    📚 目录
  </a>
  
    <nav class="md-nav" aria-label="📚 目录">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    第一部分：网络基础
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes_1" class="md-nav__link">
    第二部分：Kubernetes 网络核心
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cilium-cni" class="md-nav__link">
    第三部分：Cilium CNI 深度实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flannel-cni" class="md-nav__link">
    第四部分：Flannel CNI 实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cnimultussr-iovdpdk" class="md-nav__link">
    第五部分：高性能 CNI（Multus/SR-IOV/DPDK）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_52" data-md-state="indeterminate" type="checkbox" id="__nav_4_52" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_52">
          kubernetes 监控管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="kubernetes 监控管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_52">
          <span class="md-nav__icon md-icon"></span>
          kubernetes 监控管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../monitoring/2025-12-24-Prometheus_Learning_Notes/" class="md-nav__link">
        kubernetes 监控学习笔记
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_53" data-md-state="indeterminate" type="checkbox" id="__nav_4_53" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_53">
          kubernetes 证书管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="kubernetes 证书管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_53">
          <span class="md-nav__icon md-icon"></span>
          kubernetes 证书管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cert-manager/1-2025-03-29-cert-manager-install-doc/" class="md-nav__link">
        kubernetes Cert-manager 安装
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_54" data-md-state="indeterminate" type="checkbox" id="__nav_4_54" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_54">
          kubernetes 网络管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="kubernetes 网络管理" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_54">
          <span class="md-nav__icon md-icon"></span>
          kubernetes 网络管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../calico/5-2025-04-07-calico-FAQ-doc/" class="md-nav__link">
        kubernetes calico 网络管理containerd 运行时导致的 calico  driver 无法启动FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_55" data-md-state="indeterminate" type="checkbox" id="__nav_4_55" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_55">
          K8s 认证
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="K8s 认证" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_55">
          <span class="md-nav__icon md-icon"></span>
          K8s 认证
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cks/cka/" class="md-nav__link">
        kubernetes CKA考题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cks/cks/" class="md-nav__link">
        kubernetes CKS考题
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_56" data-md-state="indeterminate" type="checkbox" id="__nav_4_56" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_56">
          Helm
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Helm" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_56">
          <span class="md-nav__icon md-icon"></span>
          Helm
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/0-2025-3-21-helm-install-doc/" class="md-nav__link">
        kubernetes Helm 实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/1-2025-3-21-helm-cli-doc/" class="md-nav__link">
        kubernetes Helm CLI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/2-2025-3-21-helm-chart-doc/" class="md-nav__link">
        kubernetes Helm chart包
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_57" data-md-state="indeterminate" type="checkbox" id="__nav_4_57" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_57">
          Helm FAQ
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Helm FAQ" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_57">
          <span class="md-nav__icon md-icon"></span>
          Helm FAQ
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/FAQ/0-2025-4-10-helm-repo-update-warning-FAQ-doc/" class="md-nav__link">
        kubernetes Helm repo update 警告关闭FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_58" data-md-state="indeterminate" type="checkbox" id="__nav_4_58" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_58">
          Helmfile
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Helmfile" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_58">
          <span class="md-nav__icon md-icon"></span>
          Helmfile
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../helm/5-2025-04-10-helmfile-docs/" class="md-nav__link">
        kubernetes Helmfile 文件
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_59" data-md-state="indeterminate" type="checkbox" id="__nav_4_59" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_59">
          k3s
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="k3s" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_59">
          <span class="md-nav__icon md-icon"></span>
          k3s
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../k3s/1-2025-03-29-k3s-docs/" class="md-nav__link">
        k3s 大纲介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../k3s/2-2025-03-29-k3s-install-docs/" class="md-nav__link">
        k3s 边缘计算
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_60" data-md-state="indeterminate" type="checkbox" id="__nav_4_60" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_60">
          dragonfly
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="dragonfly" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_60">
          <span class="md-nav__icon md-icon"></span>
          dragonfly
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2025-05-22-dragonfly-axiom-doc/" class="md-nav__link">
        dragonfly 原理剖析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" data-md-state="indeterminate" type="checkbox" id="__nav_5" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5">
          3、运维开发
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="3、运维开发" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          3、运维开发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" data-md-state="indeterminate" type="checkbox" id="__nav_5_1" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5_1">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Python" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2024-02-20-1-python-base-doc/" class="md-nav__link">
        开发-基础语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2024-02-20-2-python-interaction-doc/" class="md-nav__link">
        开发-用户交互
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2024-03-06-3-python-pip-offline-doc/" class="md-nav__link">
        pip-离线安装软件包
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/6-2025-08-06-python-types-doc/" class="md-nav__link">
        数据类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/7-2025-08-06-python-input-doc/" class="md-nav__link">
        用户输入
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/8-2025-08-06-python-list-tuple-doc/" class="md-nav__link">
        列表元组
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/14-2025-08-07-python-except-doc/" class="md-nav__link">
        异常处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2024-02-21-4-python-module-doc/" class="md-nav__link">
        模块
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2025-04-15-python-package-doc/" class="md-nav__link">
        包管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2025-04-15-python-standard-library-doc.md" class="md-nav__link">
        标准库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/2025-03-27-5-python-poetry-doc/" class="md-nav__link">
        Poetry 环境配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/24-2025-07-15-python-oop-object-docs/" class="md-nav__link">
        面向对象编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/25-2025-07-16-python-py-oop2-doc/" class="md-nav__link">
        继承和多态
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/26-2025-07-17-python-property-doc/" class="md-nav__link">
        property
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/28-2025-07-17-python-py-concurrency-doc/" class="md-nav__link">
        并发编程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/32-2025-07-17-python-py-venv-doc/" class="md-nav__link">
        虚拟环境
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/python/33-2025-07-17-python-py-action-base-doc/" class="md-nav__link">
        项目分析与简单实现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" data-md-state="indeterminate" type="checkbox" id="__nav_5_2" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5_2">
          GO
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="GO" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          GO
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/go/2024-02-20-1-go-base-doc/" class="md-nav__link">
        开发-环境安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../3.develop/go/2024-02-20-2-go-operator-doc/" class="md-nav__link">
        开发-操作符和表达式
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" data-md-state="indeterminate" type="checkbox" id="__nav_6" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6">
          4、数据库
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="4、数据库" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          4、数据库
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" data-md-state="indeterminate" type="checkbox" id="__nav_6_1" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6_1">
          MySQL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MySQL" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          MySQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/2024-02-20-1-mysql-base-doc/" class="md-nav__link">
        基础配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/2024-02-20-2-mysql-operator-doc/" class="md-nav__link">
        Operator 部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/2024-02-20-3-mysql-backup-doc/" class="md-nav__link">
        备份恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/4-2025-04-09-mysql-port-forward-doc/" class="md-nav__link">
        客户端通过port-forward连接mysql-server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/5-2025-04-10-mysql-Beekeeper-studio-doc/" class="md-nav__link">
        Mysql 客户端 Beekeeper-studio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/mysql/2024-02-20-4-mysql-backup-error-FAQ-doc/" class="md-nav__link">
        Mysql 数据恢复FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" data-md-state="indeterminate" type="checkbox" id="__nav_6_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6_2">
          Redis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Redis" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/redis/2024-02-20-1-redis-outline-doc/" class="md-nav__link">
        大纲
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/redis/2024-02-20-2-redis-persistence-doc/" class="md-nav__link">
        持久化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/redis/2024-02-20-3-redis-cluster-doc/" class="md-nav__link">
        集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../4.database/redis/2024-02-20-4-redis-base-doc/" class="md-nav__link">
        基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" data-md-state="indeterminate" type="checkbox" id="__nav_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7">
          5、存储服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="5、存储服务" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          5、存储服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-disk-ssd-docs/" class="md-nav__link">
        存储分类
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-base/" class="md-nav__link">
        ceph 基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-03-05-rook-ceph/" class="md-nav__link">
        ceph 分布式存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-rbd-docs/" class="md-nav__link">
        ceph RBD使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-cephfs-docs/" class="md-nav__link">
        ceph 文件系统使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-cli-docs/" class="md-nav__link">
        ceph 命令用法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-osd/" class="md-nav__link">
        ceph 性能测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-bucket/" class="md-nav__link">
        ceph 对象存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-s3-client-docs/" class="md-nav__link">
        ceph s3cmd管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-5-dev-docs/" class="md-nav__link">
        ceph 存储修复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-expand-docs/" class="md-nav__link">
        ceph 存储扩容
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-tools/" class="md-nav__link">
        ceph 外部环境连接集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-clean-ceph-docs/" class="md-nav__link">
        ceph 集群清理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-ceph-error/" class="md-nav__link">
        ceph 错误指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-6-ceph-crush-docs/" class="md-nav__link">
        ceph 高级参数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-03-05-Juicefs/" class="md-nav__link">
        Juicefs存储方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/2024-02-20-juicefs-update/" class="md-nav__link">
        Juicefs版本升级
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_18" data-md-state="indeterminate" type="checkbox" id="__nav_7_18" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7_18">
          rook-ceph
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="rook-ceph" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_18">
          <span class="md-nav__icon md-icon"></span>
          rook-ceph
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../5.Storage/rook-ceph/1-2024-04-08-rook-ceph-crd-doc/" class="md-nav__link">
        rook-ceph CRD 详细说明
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" data-md-state="indeterminate" type="checkbox" id="__nav_8" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8">
          6、Devops
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="6、Devops" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          6、Devops
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2024-9-26-Git-docs/" class="md-nav__link">
        Git Commit 问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2025-3-21-Gitignore-doc/" class="md-nav__link">
        Gitignore 特定文件忽略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2025-3-31-Git-rebase-error-docs.md" class="md-nav__link">
        Git rebase报错指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2025-07-16-git-merger-commit-doc/" class="md-nav__link">
        Git 合并两个 commit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/github/" class="md-nav__link">
        Github
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/2024-10-10-Github-rsync-Gitee/" class="md-nav__link">
        Github Rysnc 同步 Gitee
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/4-github-gitee-doc/" class="md-nav__link">
        Github仓库同步至Gitee
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../6.Devops/3-github-docs/" class="md-nav__link">
        Google 浏览器扩展
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Devops/2025-3-27-conda-libmamba-solver-error-solution.md" class="md-nav__link">
        Conda conda-libmamba-solver Bug 修复
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" data-md-state="indeterminate" type="checkbox" id="__nav_9" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_9">
          7、Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="7、Web" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          7、Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../7.Web/http/1-2025-03-30-http-web-doc/" class="md-nav__link">
        Http 协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../7.Web/nginx/2025-3-27-certbot_ssl_doc/" class="md-nav__link">
        Nginx 配置Cerbot
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" data-md-state="indeterminate" type="checkbox" id="__nav_10" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_10">
          8、运维自动化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="8、运维自动化" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          8、运维自动化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-case1/" class="md-nav__link">
        Ansible 应用基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-docs2/" class="md-nav__link">
        Ansible 高级用法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-install-docs/" class="md-nav__link">
        Ansible 安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../8.Ansible/2024-02-20-ansible-playbook/" class="md-nav__link">
        Ansible playbook
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" data-md-state="indeterminate" type="checkbox" id="__nav_11" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11">
          9、其他
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="9、其他" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          9、其他
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_1" data-md-state="indeterminate" type="checkbox" id="__nav_11_1" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_1">
          远程访问
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="远程访问" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_1">
          <span class="md-nav__icon md-icon"></span>
          远程访问
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/rustdesk/2026-01-06-%E8%87%AA%E5%BB%BARustDesk%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%99%E7%A8%8B/" class="md-nav__link">
        自建RustDesk远程服务器教程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_2" data-md-state="indeterminate" type="checkbox" id="__nav_11_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_2">
          Macos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Macos" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_2">
          <span class="md-nav__icon md-icon"></span>
          Macos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/1-2025-03-29-mac-kubeconfig-doc/" class="md-nav__link">
        kubeconfig 实践应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/2-2025-03-29-mac-k9s-doc/" class="md-nav__link">
        k9s 实践应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/3-2025-03-29-mac-usb-system-doc/" class="md-nav__link">
        Mac 制作ubuntu系统盘
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/4-2025-03-29-mac-vscode-doc/" class="md-nav__link">
        Mac vscode使用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/5-2025-03-27-mac-vscode-ssh-plugin-doc/" class="md-nav__link">
        Mac vscode ssh插件使用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/9-2025-05-06-mac-font-family-doc/" class="md-nav__link">
        Mac vscode字体设置设置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/6-2024-02-20-mac-mkdocs-docs/" class="md-nav__link">
        如何利用Mac 写博客文章
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/10-2025-6-11-mac-ncdu-cli-doc/" class="md-nav__link">
        Mac 磁盘分析命令 ncdu
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/11-2025-07-15-mac-cursor-disable-Tabnine-doc/" class="md-nav__link">
        Mac cursor 禁用 Tabnine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/12-2025-07-16-mac-crontab-caffeinate-doc/" class="md-nav__link">
        Macbook 显示器定时禁止自动休眠
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/13-2025-8-25-mac-iso-doc/" class="md-nav__link">
        Macos 制作 iso 镜像文件
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_3" data-md-state="indeterminate" type="checkbox" id="__nav_11_3" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_3">
          Mac 小知识
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Mac 小知识" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_3">
          <span class="md-nav__icon md-icon"></span>
          Mac 小知识
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/7-2025-04-11-mac-item2-ssh-doc/" class="md-nav__link">
        (第一期)Mac item2 SSH连接服务器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Macos/8-2025-04-11-mac-item2-use-doc/" class="md-nav__link">
        (第二期)Mac item2 使用技巧
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_4" data-md-state="indeterminate" type="checkbox" id="__nav_11_4" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_4">
          运维小知识
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="运维小知识" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_4">
          <span class="md-nav__icon md-icon"></span>
          运维小知识
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/Opsdaily/1-2025-03-27-ops-screen-docs/" class="md-nav__link">
        (第一期:)screen 使用技巧
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_5" data-md-state="indeterminate" type="checkbox" id="__nav_11_5" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_5">
          办公
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="办公" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_5">
          <span class="md-nav__icon md-icon"></span>
          办公
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/2024-03-07-office-docs/" class="md-nav__link">
        正版Office全家桶永久免费使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/2024-02-20-google-docs/" class="md-nav__link">
        高效利用谷歌来搜索
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/2024-02-20-discord-docs/" class="md-nav__link">
        Discord 新手教程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_6" data-md-state="indeterminate" type="checkbox" id="__nav_11_6" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_11_6">
          其他
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="其他" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_6">
          <span class="md-nav__icon md-icon"></span>
          其他
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../9.other/2025-03-27-usb-wifi-doc/" class="md-nav__link">
        Ubuntu-USB 无线无线网卡使用说明书
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" data-md-state="indeterminate" type="checkbox" id="__nav_12" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12">
          10、Ai
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="10、Ai" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          10、Ai
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_1" data-md-state="indeterminate" type="checkbox" id="__nav_12_1" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_1">
          Cursor
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cursor" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_1">
          <span class="md-nav__icon md-icon"></span>
          Cursor
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/cursor/2024-02-27-cursor-latest-features/" class="md-nav__link">
        Cursor 使用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/cursor/2024-02-27-cursor-model-performance/" class="md-nav__link">
        Cursor 模型性能排行
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_2" data-md-state="indeterminate" type="checkbox" id="__nav_12_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_2">
          vLLM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="vLLM" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_2">
          <span class="md-nav__icon md-icon"></span>
          vLLM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-03-03-vllm-Qwen2.5-VL/" class="md-nav__link">
        vLLM 部署 Qwen2.5-VL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-03-03-vllm-Qwen2.5-VL-72B/" class="md-nav__link">
        vLLM 部署 Qwen2.5-VL-72B
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-03-13-vllm-docs-2/" class="md-nav__link">
        vLLM 模型启动参数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-02-28-vllm-chatglm3-6b-doc/" class="md-nav__link">
        vLLM 部署 ChatGLM3-6B
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/vllm/2024-02-28-vllm-docs/" class="md-nav__link">
        vLLM 基础文档
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_3" data-md-state="indeterminate" type="checkbox" id="__nav_12_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_3">
          NVIDIA
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="NVIDIA" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_3">
          <span class="md-nav__icon md-icon"></span>
          NVIDIA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/Nvidia-gpu-compare/" class="md-nav__link">
        NVIDIA显卡对比
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/2025-12-17-NVIDIA-driver-install-doc/" class="md-nav__link">
        NVIDIA驱动安装和清理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/fake-gpu-operator-doc/" class="md-nav__link">
        fake-gpu-operator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/Nvidia-k8s-rdma/" class="md-nav__link">
        RDMA在Kubernetes中的应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/2025-12-03-%E5%A6%82%E4%BD%95%E6%A3%80%E6%9F%A5CUDA%E6%98%AF%E5%90%A6%E5%8F%AF%E7%94%A8/" class="md-nav__link">
        NVIDIA 如何检查CUDA是否正常
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/nvidia/LiteLLM-Proxy-doc/" class="md-nav__link">
        LiteLLM-Proxy
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_4" data-md-state="indeterminate" type="checkbox" id="__nav_12_4" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_4">
          ChatGPT
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ChatGPT" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_4">
          <span class="md-nav__icon md-icon"></span>
          ChatGPT
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/chatgpt/2024-02-20-chatgpt-docs/" class="md-nav__link">
        注册chatgpt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/chatgpt/2024-02-20-chatgpt-pulgin-docs/" class="md-nav__link">
        ChatGPT插件使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/chatgpt/2024-02-20-gpts-docs/" class="md-nav__link">
        如何使用Chatgpt来制作专属gpt
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_5" data-md-state="indeterminate" type="checkbox" id="__nav_12_5" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_5">
          OpenBayes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OpenBayes" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_5">
          <span class="md-nav__icon md-icon"></span>
          OpenBayes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/2-2024-03-27-wan-openbayes-deploy.md" class="md-nav__link">
        OpenBayes部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/1-2025-03-29-tju-gpu-error-FAQ-doc/" class="md-nav__link">
        Openbayes 天津大学GPU异常FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/2-2025-03-29-tju-gpu-ps-FAQ-doc/" class="md-nav__link">
        Openbayes GPU异常图文FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/3-2025-03-29-dev-cluster-FAQ-doc/" class="md-nav__link">
        Openbayes Dev环境集群FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/4-2025-03-29-delete-prometheus-db-FAQ-doc/" class="md-nav__link">
        Openbayes 误删除监控数据FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/5-2025-03-29-kubernetes-pvc-ubound-FAQ-doc/" class="md-nav__link">
        Openbayes Kubernetes pvc ubound FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/6-2025-03-29-dns-file-permission-FAQ-doc/" class="md-nav__link">
        Openbayes dns 文件权限调整FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/openbayes/7-2025-03-29-osd-disk-expansion-FAQ-doc/" class="md-nav__link">
        Openbayes osd 磁盘扩容FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_6" data-md-state="indeterminate" type="checkbox" id="__nav_12_6" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_6">
          Langfuse
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Langfuse" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_6">
          <span class="md-nav__icon md-icon"></span>
          Langfuse
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/Langfuse/2024-03-17-langfuse-deployment-guide/" class="md-nav__link">
        Langfuse部署指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/Langfuse/2024-03-14-opentelemetry-doc/" class="md-nav__link">
        OpenTelemetry文档
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12_7" data-md-state="indeterminate" type="checkbox" id="__nav_12_7" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_12_7">
          Midjourney
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Midjourney" data-md-level="2">
        <label class="md-nav__title" for="__nav_12_7">
          <span class="md-nav__icon md-icon"></span>
          Midjourney
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10.Ai-tools/2024-03-06-mj-doc/" class="md-nav__link">
        Midjourney文档
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" data-md-state="indeterminate" type="checkbox" id="__nav_13" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_13">
          关于我
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="关于我" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          关于我
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2024-9-24-myblog-life-docs/" class="md-nav__link">
        我的博客
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2021-life-docs/" class="md-nav__link">
        我的2021
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2022-life-docs/" class="md-nav__link">
        我的2022
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2023-life-docs/" class="md-nav__link">
        我的2023
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2024-life-docs/" class="md-nav__link">
        我的2024
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13_6" data-md-state="indeterminate" type="checkbox" id="__nav_13_6" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_13_6">
          我的2025
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="我的2025" data-md-level="2">
        <label class="md-nav__title" for="__nav_13_6">
          <span class="md-nav__icon md-icon"></span>
          我的2025
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2025-life-docs/" class="md-nav__link">
        我的2025
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2025/2025-life-qianguize-doc/" class="md-nav__link">
        一个很脏但是很现实的男女潜规则
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../20.mylife/2025-learning-docs/" class="md-nav__link">
        我的学习
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    📚 目录
  </a>
  
    <nav class="md-nav" aria-label="📚 目录">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    第一部分：网络基础
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes_1" class="md-nav__link">
    第二部分：Kubernetes 网络核心
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cilium-cni" class="md-nav__link">
    第三部分：Cilium CNI 深度实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flannel-cni" class="md-nav__link">
    第四部分：Flannel CNI 实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cnimultussr-iovdpdk" class="md-nav__link">
    第五部分：高性能 CNI（Multus/SR-IOV/DPDK）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/Yuki-0215/Yuki-0215.github.io/edit/master/docs/2.k8s/network/2025-12-24-kubernetes-network-learning_Notes.md" title="编辑此页" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="kubernetes">Kubernetes 容器网络学习笔记<a class="headerlink" href="#kubernetes" title="Permanent link">&para;</a></h1>
<blockquote>
<p>本文档是基于容器网络课程整理的系统性学习笔记，面向运维工程师/SRE，帮助深入理解 Kubernetes 容器网络。</p>
</blockquote>
<hr />
<h2 id="_1">📚 目录<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="_2">第一部分：网络基础<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#第1章-tcpip-协议栈">第1章 TCP/IP 协议栈</a></li>
<li><a href="#第2章-linux-网络命名空间">第2章 Linux 网络命名空间</a></li>
<li><a href="#第3章-veth-pair-虚拟网络设备">第3章 Veth Pair 虚拟网络设备</a></li>
<li><a href="#第4章-linux-bridge-网桥">第4章 Linux Bridge 网桥</a></li>
<li><a href="#第5章-路由与-arp">第5章 路由与 ARP</a></li>
<li><a href="#第6章-iptables-防火墙">第6章 iptables 防火墙</a></li>
<li><a href="#第7章-ipvs-负载均衡">第7章 IPVS 负载均衡</a></li>
</ul>
<h3 id="kubernetes_1">第二部分：Kubernetes 网络核心<a class="headerlink" href="#kubernetes_1" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#第8章-docker-网络模型">第8章 Docker 网络模型</a></li>
<li><a href="#第9章-kubernetes-网络模型">第9章 Kubernetes 网络模型</a></li>
<li><a href="#第10章-cni-容器网络接口">第10章 CNI 容器网络接口</a></li>
<li><a href="#第11章-pod-网络">第11章 Pod 网络</a></li>
<li><a href="#第12章-service-网络">第12章 Service 网络</a></li>
<li><a href="#第13章-dns-与服务发现">第13章 DNS 与服务发现</a></li>
<li><a href="#第14章-ingress-与-gateway-api">第14章 Ingress 与 Gateway API</a></li>
</ul>
<h3 id="cilium-cni">第三部分：Cilium CNI 深度实践<a class="headerlink" href="#cilium-cni" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#第15章-cilium-概述与架构">第15章 Cilium 概述与架构</a></li>
<li><a href="#第16章-cilium-安装与部署">第16章 Cilium 安装与部署</a></li>
<li><a href="#第17章-cilium-网络策略">第17章 Cilium 网络策略</a></li>
<li><a href="#第18章-cilium-observability">第18章 Cilium Observability</a></li>
<li><a href="#第19章-cilium-service-mesh">第19章 Cilium Service Mesh</a></li>
<li><a href="#第20章-cilium-cluster-mesh">第20章 Cilium Cluster Mesh</a></li>
<li><a href="#第21章-cilium-bgp">第21章 Cilium BGP</a></li>
<li><a href="#第22章-cilium-egress-gateway">第22章 Cilium Egress Gateway</a></li>
<li><a href="#第23章-cilium-bandwidth-manager">第23章 Cilium Bandwidth Manager</a></li>
<li><a href="#第24章-cilium-host-firewall">第24章 Cilium Host Firewall</a></li>
<li><a href="#第25章-cilium-透明加密">第25章 Cilium 透明加密</a></li>
<li><a href="#第26章-cilium-nat46-nat64">第26章 Cilium NAT46/NAT64</a></li>
<li><a href="#第27章-cilium-local-redirect-policy">第27章 Cilium Local Redirect Policy</a></li>
<li><a href="#第28章-cilium-health-checking">第28章 Cilium Health Checking</a></li>
<li><a href="#第29章-cilium-性能调优">第29章 Cilium 性能调优</a></li>
<li><a href="#第30章-cilium-故障排除">第30章 Cilium 故障排除</a></li>
<li><a href="#第31章-cilium-升级与运维">第31章 Cilium 升级与运维</a></li>
<li><a href="#第32章-cilium-生产最佳实践">第32章 Cilium 生产最佳实践</a></li>
<li><a href="#第33章-cilium-ebpf-internals">第33章 Cilium eBPF Internals</a></li>
<li><a href="#第34章-cilium-datapath">第34章 Cilium Datapath</a></li>
<li><a href="#第35章-cilium-identity-与安全">第35章 Cilium Identity 与安全</a></li>
<li><a href="#第36章-cilium-ipam">第36章 Cilium IPAM</a></li>
<li><a href="#第37章-cilium-lb-ipam">第37章 Cilium LB IPAM</a></li>
<li><a href="#第38章-cilium-envoy">第38章 Cilium Envoy</a></li>
<li><a href="#第39章-cilium-tetragon">第39章 Cilium Tetragon</a></li>
<li><a href="#第40章-cilium-hubble-深度解析">第40章 Cilium Hubble 深度解析</a></li>
<li><a href="#第41章-cilium-与-istio-集成">第41章 Cilium 与 Istio 集成</a></li>
<li><a href="#第42章-cilium-未来展望">第42章 Cilium 未来展望</a></li>
</ul>
<h3 id="flannel-cni">第四部分：Flannel CNI 实践<a class="headerlink" href="#flannel-cni" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#第43章-flannel-概述与架构">第43章 Flannel 概述与架构</a></li>
<li><a href="#第44章-flannel-vxlan-模式">第44章 Flannel VXLAN 模式</a></li>
<li><a href="#第45章-flannel-vxlan-directrouting">第45章 Flannel VXLAN DirectRouting</a></li>
<li><a href="#第46章-flannel-host-gw-模式">第46章 Flannel Host-GW 模式</a></li>
<li><a href="#第47章-flannel-udp-模式">第47章 Flannel UDP 模式</a></li>
<li><a href="#第48章-flannel-alloc-模式">第48章 Flannel Alloc 模式</a></li>
<li><a href="#第49章-flannel-多网卡与-public-ip">第49章 Flannel 多网卡与 Public IP</a></li>
<li><a href="#第50章-flannel-ipsec-模式">第50章 Flannel IPsec 模式</a></li>
<li><a href="#第51章-flannel-wireguard-模式">第51章 Flannel WireGuard 模式</a></li>
</ul>
<h3 id="cnimultussr-iovdpdk">第五部分：高性能 CNI（Multus/SR-IOV/DPDK）<a class="headerlink" href="#cnimultussr-iovdpdk" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#第52章-multus-多网卡方案">第52章 Multus 多网卡方案</a></li>
<li><a href="#第53章-multus-ipvlan-l2-模式">第53章 Multus IPVLAN L2 模式</a></li>
<li><a href="#第54章-multus-ipvlan-l3-模式">第54章 Multus IPVLAN L3 模式</a></li>
<li><a href="#第55章-multus-ipvlan-sbr-模式">第55章 Multus IPVLAN SBR 模式</a></li>
<li><a href="#第56章-ipvlan-sbr-深度解析">第56章 IPVLAN-SBR 深度解析</a></li>
<li><a href="#第57章-macvlan-sbr-实践">第57章 MACVLAN-SBR 实践</a></li>
<li><a href="#第58章-multus-with-sriov-kernel">第58章 Multus-with-SRIOV-Kernel</a></li>
<li><a href="#第59章-multus-with-sriov-dpdk-vpp">第59章 Multus-with-SRIOV-DPDK-VPP</a></li>
<li><a href="#第60章-k8s-cni-ipam-机制详解">第60章 K8s-CNI-IPAM 机制详解</a></li>
</ul>
<hr />
<h1 id="_3">第一部分：网络基础<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h1>
<hr />
<h2 id="1-tcpip">第1章 TCP/IP 协议栈<a class="headerlink" href="#1-tcpip" title="Permanent link">&para;</a></h2>
<h3 id="_4">🎯 学习目标<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 OSI 七层模型与 TCP/IP 四层模型的区别与联系</li>
<li>掌握网络分层架构的设计思想</li>
<li>理解 TCP 和 UDP 协议的核心差异</li>
<li>学会使用 tcpdump 和 Wireshark 进行网络抓包分析</li>
</ul>
<hr />
<h3 id="11-osi-tcpip">1.1 OSI 七层模型与 TCP/IP 四层模型<a class="headerlink" href="#11-osi-tcpip" title="Permanent link">&para;</a></h3>
<h4 id="_5">背景<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>在计算机网络发展早期，不同厂商的网络设备和协议互不兼容，导致设备之间无法互联互通。为了解决这个问题，国际标准化组织（ISO）提出了 <strong>OSI（Open Systems Interconnection）参考模型</strong>，将网络通信划分为七个层次，每一层负责特定的功能。</p>
<blockquote>
<p>[!NOTE]
OSI 模型是一个<strong>理论参考模型</strong>，而实际生产环境中更多使用的是简化后的 <strong>TCP/IP 四层模型</strong>。</p>
</blockquote>
<h4 id="_6">原理<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p><strong>分层架构的核心思想：术业有专攻</strong></p>
<p>网络分层的本质是<strong>解耦</strong>，使得：</p>
<ul>
<li>每一层专注于自身的协议实现</li>
<li>不同厂商的设备只要遵循同一标准，就可以互联互通</li>
<li>便于问题定位和排查</li>
</ul>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph OSI[&quot;OSI 七层模型&quot;]
        L7[应用层&lt;br/&gt;Application]
        L6[表示层&lt;br/&gt;Presentation]
        L5[会话层&lt;br/&gt;Session]
        L4[传输层&lt;br/&gt;Transport]
        L3[网络层&lt;br/&gt;Network]
        L2[数据链路层&lt;br/&gt;Data Link]
        L1[物理层&lt;br/&gt;Physical]

        L7 --&gt; L6 --&gt; L5 --&gt; L4 --&gt; L3 --&gt; L2 --&gt; L1
    end

    subgraph TCPIP[&quot;TCP/IP 四层模型&quot;]
        T4[应用层]
        T3[传输层]
        T2[网络层]
        T1[网络接口层]

        T4 --&gt; T3 --&gt; T2 --&gt; T1
    end

    L7 -.-&gt; T4
    L6 -.-&gt; T4
    L5 -.-&gt; T4
    L4 -.-&gt; T3
    L3 -.-&gt; T2
    L2 -.-&gt; T1
    L1 -.-&gt; T1
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<p>上图展示了 OSI 七层模型与 TCP/IP 四层模型的对应关系：</p>
<ul>
<li>OSI 的<strong>应用层、表示层、会话层</strong>统一为 TCP/IP 的<strong>应用层</strong></li>
<li>OSI 的<strong>传输层</strong>对应 TCP/IP 的<strong>传输层</strong></li>
<li>OSI 的<strong>网络层</strong>对应 TCP/IP 的<strong>网络层</strong></li>
<li>OSI 的<strong>数据链路层、物理层</strong>合并为 TCP/IP 的<strong>网络接口层</strong></li>
</ul>
<h4 id="_7">各层功能与核心协议<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: center;">层级</th>
<th style="text-align: center;">OSI 模型</th>
<th style="text-align: center;">TCP/IP 模型</th>
<th style="text-align: left;">核心功能</th>
<th style="text-align: left;">代表协议/设备</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">7</td>
<td style="text-align: center;">应用层</td>
<td style="text-align: center;">应用层</td>
<td style="text-align: left;">为用户提供网络服务</td>
<td style="text-align: left;">HTTP、FTP、DNS、DHCP</td>
</tr>
<tr>
<td style="text-align: center;">6</td>
<td style="text-align: center;">表示层</td>
<td style="text-align: center;">应用层</td>
<td style="text-align: left;">数据编解码、压缩、加密</td>
<td style="text-align: left;">SSL/TLS、JPEG</td>
</tr>
<tr>
<td style="text-align: center;">5</td>
<td style="text-align: center;">会话层</td>
<td style="text-align: center;">应用层</td>
<td style="text-align: left;">建立、管理、终止会话</td>
<td style="text-align: left;">RPC、NetBIOS</td>
</tr>
<tr>
<td style="text-align: center;">4</td>
<td style="text-align: center;">传输层</td>
<td style="text-align: center;">传输层</td>
<td style="text-align: left;">端到端的可靠传输</td>
<td style="text-align: left;"><strong>TCP</strong>、<strong>UDP</strong>、SCTP</td>
</tr>
<tr>
<td style="text-align: center;">3</td>
<td style="text-align: center;">网络层</td>
<td style="text-align: center;">网络层</td>
<td style="text-align: left;">路由选择、逻辑寻址</td>
<td style="text-align: left;"><strong>IP</strong>、ICMP、路由器</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: center;">数据链路层</td>
<td style="text-align: center;">网络接口层</td>
<td style="text-align: left;">物理寻址、帧封装</td>
<td style="text-align: left;"><strong>MAC</strong>、交换机、ARP</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">物理层</td>
<td style="text-align: center;">网络接口层</td>
<td style="text-align: left;">比特流传输</td>
<td style="text-align: left;">光纤、双绞线、无线</td>
</tr>
</tbody>
</table>
<p><strong>要点解读</strong>：</p>
<p>对于容器网络学习，我们需要重点关注以下三层：</p>
<ol>
<li><strong>传输层（L4）</strong>：TCP/UDP 端口，这是应用开发最常接触的层</li>
<li><strong>网络层（L3）</strong>：IP 地址、路由表，跨节点通信主要依赖此层</li>
<li><strong>数据链路层（L2）</strong>：MAC 地址、交换机，同网段通信的基础</li>
</ol>
<h4 id="_8">关键点<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!IMPORTANT]
<strong>运维排障思路</strong>：当服务不可达时，应该逐层排查：</p>
<ol>
<li>物理层：网线是否连接正常？</li>
<li>数据链路层：MAC 地址是否正确？ARP 表是否正确？</li>
<li>网络层：IP 是否可达？路由表是否正确？</li>
<li>传输层：端口是否监听？防火墙是否放行？</li>
<li>应用层：服务是否正常启动？</li>
</ol>
</blockquote>
<hr />
<h3 id="12">1.2 数据封装与解封装流程<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<h4 id="_9">背景<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>当应用程序需要发送数据时，数据会从上层向下层逐级传递，每经过一层都会添加该层的<strong>头部信息（Header）</strong>，这个过程称为<strong>封装（Encapsulation）</strong>。接收端则进行相反的操作，称为<strong>解封装（Decapsulation）</strong>。</p>
<h4 id="_10">原理<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph 发送端[&quot;发送端封装过程&quot;]
        direction TB
        A1[应用数据] --&gt; A2[TCP/UDP 头 + 数据&lt;br/&gt;段 Segment]
        A2 --&gt; A3[IP 头 + 段&lt;br/&gt;包 Packet]
        A3 --&gt; A4[MAC 头 + 包 + MAC 尾&lt;br/&gt;帧 Frame]
        A4 --&gt; A5[比特流 Bits]
    end

    subgraph 接收端[&quot;接收端解封装过程&quot;]
        direction TB
        B5[比特流 Bits] --&gt; B4[帧 Frame]
        B4 --&gt; B3[包 Packet]
        B3 --&gt; B2[段 Segment]
        B2 --&gt; B1[应用数据]
    end

    A5 --&gt;|网络传输| B5
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<p>数据在发送端逐层封装，每层添加自己的协议头：</p>
<ul>
<li><strong>应用层</strong>：生成原始数据</li>
<li><strong>传输层</strong>：添加 TCP/UDP 头（包含源端口、目的端口）</li>
<li><strong>网络层</strong>：添加 IP 头（包含源 IP、目的 IP、TTL）</li>
<li><strong>数据链路层</strong>：添加 MAC 头和尾（包含源 MAC、目的 MAC）</li>
<li><strong>物理层</strong>：转换为 0/1 比特流进行传输</li>
</ul>
<h4 id="_11">数据包结构示意<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>+------------------+----------+--------+----------+-----------------+
|   以太网帧头     |  IP 头   | TCP 头 |  数据    |   以太网帧尾    |
|  14 字节         | 20 字节  | 20 字节|  N 字节  |   4 字节        |
+------------------+----------+--------+----------+-----------------+
|←-- 二层 MAC --→|←-三层IP-→|←-四层-→|          |
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<p>以上结构展示了一个完整的以太网帧：</p>
<ul>
<li><strong>以太网帧头（14 字节）</strong>：包含目的 MAC（6B）+ 源 MAC（6B）+ 类型（2B）</li>
<li><strong>IP 头（20 字节）</strong>：包含版本、TTL、源 IP、目的 IP 等</li>
<li><strong>TCP 头（20 字节）</strong>：包含源端口、目的端口、序列号、标志位等</li>
<li><strong>以太网帧尾（4 字节）</strong>：FCS 帧校验序列</li>
</ul>
<hr />
<h3 id="13-tcp">1.3 TCP 协议详解<a class="headerlink" href="#13-tcp" title="Permanent link">&para;</a></h3>
<h4 id="_12">背景<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>TCP（Transmission Control Protocol，传输控制协议）是一种<strong>面向连接</strong>的、<strong>可靠</strong>的传输层协议。它通过三次握手建立连接、四次挥手断开连接，并提供流量控制、拥塞控制等机制来保证数据可靠传输。</p>
<h4 id="_13">原理<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<h5 id="131-socket">1.3.1 套接字（Socket）概念<a class="headerlink" href="#131-socket" title="Permanent link">&para;</a></h5>
<p><strong>套接字 = IP 地址 + 端口号</strong></p>
<p>例如：<code>192.168.1.100:8080</code> 表示一个套接字</p>
<blockquote>
<p>[!NOTE]
TCP 端口和 UDP 端口是独立的。同一个端口号（如 53）可以同时被 TCP 和 UDP 监听，因为它们属于不同的协议。</p>
</blockquote>
<h5 id="132-tcp">1.3.2 TCP 三次握手<a class="headerlink" href="#132-tcp" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant C as 客户端
    participant S as 服务端

    Note over S: LISTEN 状态
    C-&gt;&gt;S: SYN (seq=x)
    Note over C: SYN_SENT
    S-&gt;&gt;C: SYN + ACK (seq=y, ack=x+1)
    Note over S: SYN_RCVD
    C-&gt;&gt;S: ACK (ack=y+1)
    Note over C,S: ESTABLISHED 连接建立
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<p>三次握手的过程：</p>
<ol>
<li><strong>第一次握手</strong>：客户端发送 SYN 包（同步序列号），进入 SYN_SENT 状态</li>
<li><strong>第二次握手</strong>：服务端收到 SYN 后，回复 SYN+ACK 包，进入 SYN_RCVD 状态</li>
<li><strong>第三次握手</strong>：客户端收到后回复 ACK，双方进入 ESTABLISHED 状态，连接建立</li>
</ol>
<h5 id="133-tcp">1.3.3 TCP 标志位<a class="headerlink" href="#133-tcp" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th style="text-align: center;">标志位</th>
<th style="text-align: center;">名称</th>
<th style="text-align: left;">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">SYN</td>
<td style="text-align: center;">Synchronize</td>
<td style="text-align: left;">发起连接，同步序列号</td>
</tr>
<tr>
<td style="text-align: center;">ACK</td>
<td style="text-align: center;">Acknowledge</td>
<td style="text-align: left;">确认收到数据</td>
</tr>
<tr>
<td style="text-align: center;">FIN</td>
<td style="text-align: center;">Finish</td>
<td style="text-align: left;">请求关闭连接</td>
</tr>
<tr>
<td style="text-align: center;">RST</td>
<td style="text-align: center;">Reset</td>
<td style="text-align: left;">重置连接（异常终止）</td>
</tr>
<tr>
<td style="text-align: center;">PSH</td>
<td style="text-align: center;">Push</td>
<td style="text-align: left;">立即推送数据给应用层</td>
</tr>
<tr>
<td style="text-align: center;">URG</td>
<td style="text-align: center;">Urgent</td>
<td style="text-align: left;">紧急数据</td>
</tr>
</tbody>
</table>
<h5 id="134-mss">1.3.4 MSS 与分片机制<a class="headerlink" href="#134-mss" title="Permanent link">&para;</a></h5>
<p><strong>MSS（Maximum Segment Size）</strong>：最大报文段长度，指 TCP 数据部分的最大长度。</p>
<div class="highlight"><pre><span></span><code>MTU = 1500 字节（以太网默认）
MSS = MTU - IP头(20) - TCP头(20) = 1460 字节
</code></pre></div>
<p><strong>要点解读</strong>：</p>
<blockquote>
<p>[!IMPORTANT]
<strong>为什么分片在 TCP 层做而不是 IP 层？</strong></p>
<ul>
<li>TCP 有<strong>序列号</strong>，可以精确知道哪个片丢失，只需重传丢失的片</li>
<li>IP 没有重传机制，如果一个分片丢失，需要重传整个原始数据</li>
<li>在 TCP 层分片可以<strong>减少重传开销</strong></li>
</ul>
</blockquote>
<h5 id="135-tcp">1.3.5 TCP 卸载技术<a class="headerlink" href="#135-tcp" title="Permanent link">&para;</a></h5>
<p>当数据量较大时，TCP 分片等操作会消耗大量 CPU 资源。现代网卡支持将这些操作<strong>卸载（Offload）</strong>到硬件，减轻 CPU 负担：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">技术</th>
<th style="text-align: left;">全称</th>
<th style="text-align: left;">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">TSO</td>
<td style="text-align: left;">TCP Segmentation Offload</td>
<td style="text-align: left;">将 TCP 分片卸载到网卡</td>
</tr>
<tr>
<td style="text-align: center;">GSO</td>
<td style="text-align: left;">Generic Segmentation Offload</td>
<td style="text-align: left;">通用分片卸载</td>
</tr>
<tr>
<td style="text-align: center;">GRO</td>
<td style="text-align: left;">Generic Receive Offload</td>
<td style="text-align: left;">接收端合并小包</td>
</tr>
<tr>
<td style="text-align: center;">LRO</td>
<td style="text-align: left;">Large Receive Offload</td>
<td style="text-align: left;">大包接收卸载</td>
</tr>
</tbody>
</table>
<p><strong>代码说明</strong>：</p>
<p>查看网卡 offload 状态：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看网卡 offload 配置</span>
ethtool<span class="w"> </span>-k<span class="w"> </span>eth0

<span class="c1"># 输出示例：</span>
<span class="c1"># tcp-segmentation-offload: on</span>
<span class="c1"># generic-segmentation-offload: on</span>
<span class="c1"># generic-receive-offload: on</span>
<span class="c1"># large-receive-offload: off</span>
</code></pre></div>
<hr />
<h3 id="14-udp">1.4 UDP 协议特点<a class="headerlink" href="#14-udp" title="Permanent link">&para;</a></h3>
<h4 id="_14">背景<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>UDP（User Datagram Protocol，用户数据报协议）是一种<strong>无连接</strong>的、<strong>不可靠</strong>的传输层协议。它没有握手过程，发送数据时不保证对方能收到。</p>
<h4 id="tcp-udp">TCP 与 UDP 对比<a class="headerlink" href="#tcp-udp" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: center;">特性</th>
<th style="text-align: center;">TCP</th>
<th style="text-align: center;">UDP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">连接性</td>
<td style="text-align: center;">面向连接</td>
<td style="text-align: center;">无连接</td>
</tr>
<tr>
<td style="text-align: center;">可靠性</td>
<td style="text-align: center;">可靠（有确认、重传）</td>
<td style="text-align: center;">不可靠</td>
</tr>
<tr>
<td style="text-align: center;">有序性</td>
<td style="text-align: center;">保证顺序</td>
<td style="text-align: center;">不保证</td>
</tr>
<tr>
<td style="text-align: center;">速度</td>
<td style="text-align: center;">较慢（握手开销）</td>
<td style="text-align: center;">较快</td>
</tr>
<tr>
<td style="text-align: center;">头部大小</td>
<td style="text-align: center;">20 字节</td>
<td style="text-align: center;">8 字节</td>
</tr>
<tr>
<td style="text-align: center;">应用场景</td>
<td style="text-align: center;">HTTP、数据库、文件传输</td>
<td style="text-align: center;">DNS、视频流、游戏</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph TCP[&quot;TCP 通信&quot;]
        C1[客户端] --&gt;|1. SYN| S1[服务端]
        S1 --&gt;|2. SYN+ACK| C1
        C1 --&gt;|3. ACK| S1
        C1 --&gt;|4. 数据| S1
    end

    subgraph UDP[&quot;UDP 通信&quot;]
        C2[客户端] --&gt;|直接发送数据| S2[服务端]
    end
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li><strong>TCP</strong>：需要三次握手建立连接后才能传输数据</li>
<li><strong>UDP</strong>：直接发送数据，无需建立连接，简单高效但不可靠</li>
</ul>
<hr />
<h3 id="15-nc">1.5 使用 nc 工具进行网络测试<a class="headerlink" href="#15-nc" title="Permanent link">&para;</a></h3>
<h4 id="_15">背景<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p><code>nc</code>（netcat）是一个功能强大的网络工具，可以用于 TCP/UDP 端口监听、网络调试、数据传输等场景。</p>
<h4 id="_16">常用命令<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># ============ TCP 监听与连接 ============</span>
<span class="c1"># 服务端：监听 TCP 8088 端口（-l 表示 listen，-k 表示保持监听）</span>
nc<span class="w"> </span>-lk<span class="w"> </span><span class="m">192</span>.168.1.100<span class="w"> </span><span class="m">8088</span>

<span class="c1"># 客户端：连接 TCP 8088 端口</span>
nc<span class="w"> </span><span class="m">192</span>.168.1.100<span class="w"> </span><span class="m">8088</span>

<span class="c1"># ============ UDP 监听与连接 ============</span>
<span class="c1"># 服务端：监听 UDP 8088 端口（-u 表示使用 UDP）</span>
nc<span class="w"> </span>-lu<span class="w"> </span><span class="m">192</span>.168.1.100<span class="w"> </span><span class="m">8088</span>

<span class="c1"># 客户端：连接 UDP 8088 端口</span>
nc<span class="w"> </span>-u<span class="w"> </span><span class="m">192</span>.168.1.100<span class="w"> </span><span class="m">8088</span>
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li><code>-l</code>：listen 模式，作为服务端监听端口</li>
<li><code>-k</code>：keep-open，连接断开后保持监听</li>
<li><code>-u</code>：使用 UDP 协议（默认为 TCP）</li>
</ul>
<hr />
<h3 id="16-tcpdump-wireshark">1.6 使用 tcpdump 和 Wireshark 进行抓包分析<a class="headerlink" href="#16-tcpdump-wireshark" title="Permanent link">&para;</a></h3>
<h4 id="_17">背景<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>网络抓包是排查网络问题的核心技能。<code>tcpdump</code> 是 Linux 下的命令行抓包工具，<code>Wireshark</code> 是图形化的抓包分析工具。</p>
<h4 id="tcpdump">tcpdump 常用命令<a class="headerlink" href="#tcpdump" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 基础抓包：在 eth0 接口抓包并保存到文件</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-w<span class="w"> </span>capture.pcap

<span class="c1"># 抓取指定端口的 TCP 包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>port<span class="w"> </span><span class="m">8088</span>

<span class="c1"># 抓取指定 IP 的包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>host<span class="w"> </span><span class="m">192</span>.168.1.100

<span class="c1"># 详细显示包内容（-nn 不解析主机名和端口名）</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>-vv<span class="w"> </span>port<span class="w"> </span><span class="m">8088</span>
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">选项</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>-i</code></td>
<td style="text-align: left;">指定网络接口</td>
</tr>
<tr>
<td style="text-align: center;"><code>-w</code></td>
<td style="text-align: left;">写入文件（.pcap 格式）</td>
</tr>
<tr>
<td style="text-align: center;"><code>-nn</code></td>
<td style="text-align: left;">不解析主机名和端口名</td>
</tr>
<tr>
<td style="text-align: center;"><code>-vv</code></td>
<td style="text-align: left;">详细输出</td>
</tr>
</tbody>
</table>
<h4 id="wireshark">Wireshark 过滤技巧<a class="headerlink" href="#wireshark" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">过滤条件</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>tcp.port == 8088</code></td>
<td style="text-align: left;">过滤 TCP 8088 端口</td>
</tr>
<tr>
<td style="text-align: left;"><code>tcp.stream eq 0</code></td>
<td style="text-align: left;">过滤第一个 TCP 流</td>
</tr>
<tr>
<td style="text-align: left;"><code>tcp.flags.syn == 1</code></td>
<td style="text-align: left;">过滤 SYN 包</td>
</tr>
<tr>
<td style="text-align: left;"><code>tcp.len == 0</code></td>
<td style="text-align: left;">过滤无数据的 TCP 包（握手包）</td>
</tr>
<tr>
<td style="text-align: left;"><code>ip.addr == 192.168.1.100</code></td>
<td style="text-align: left;">过滤指定 IP</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="17-tcp-udp">1.7 实战：TCP 与 UDP 抓包分析<a class="headerlink" href="#17-tcp-udp" title="Permanent link">&para;</a></h3>
<h4 id="_18">实验目的<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>通过 nc 工具模拟 TCP 和 UDP 通信，使用 tcpdump 抓包，用 Wireshark 分析数据包结构。</p>
<h4 id="_19">实验步骤<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<p><strong>步骤一：TCP 抓包实验</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 终端 1：启动 tcpdump 抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-w<span class="w"> </span>tcp_capture.pcap<span class="w"> </span>port<span class="w"> </span><span class="m">8088</span>

<span class="c1"># 终端 2：启动 TCP 服务端</span>
nc<span class="w"> </span>-lk<span class="w"> </span><span class="m">192</span>.168.1.100<span class="w"> </span><span class="m">8088</span>

<span class="c1"># 终端 3：启动 TCP 客户端并发送数据</span>
nc<span class="w"> </span><span class="m">192</span>.168.1.100<span class="w"> </span><span class="m">8088</span>
<span class="c1"># 输入：hello CNI</span>
</code></pre></div>
<p><strong>步骤二：用 Wireshark 分析 TCP 包</strong></p>
<p>使用 Wireshark 打开 <code>tcp_capture.pcap</code>，可以看到：</p>
<ol>
<li><strong>三次握手</strong>：前三个包（SYN → SYN+ACK → ACK）</li>
<li><strong>数据传输</strong>：带有 PSH 标志的包，包含 "hello CNI" 数据</li>
<li><strong>四次挥手</strong>：断开连接的 FIN 包</li>
</ol>
<p><strong>步骤三：UDP 抓包实验</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 终端 1：启动 tcpdump 抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-w<span class="w"> </span>udp_capture.pcap<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">8088</span>

<span class="c1"># 终端 2：启动 UDP 服务端</span>
nc<span class="w"> </span>-lu<span class="w"> </span><span class="m">192</span>.168.1.100<span class="w"> </span><span class="m">8088</span>

<span class="c1"># 终端 3：启动 UDP 客户端并发送数据</span>
nc<span class="w"> </span>-u<span class="w"> </span><span class="m">192</span>.168.1.100<span class="w"> </span><span class="m">8088</span>
<span class="c1"># 输入：hello UDP</span>
</code></pre></div>
<p><strong>步骤四：对比分析</strong></p>
<table>
<thead>
<tr>
<th style="text-align: center;">对比项</th>
<th style="text-align: center;">TCP</th>
<th style="text-align: center;">UDP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">握手过程</td>
<td style="text-align: center;">有三次握手</td>
<td style="text-align: center;"><strong>无握手</strong></td>
</tr>
<tr>
<td style="text-align: center;">数据发送</td>
<td style="text-align: center;">有确认机制</td>
<td style="text-align: center;">直接发送</td>
</tr>
<tr>
<td style="text-align: center;">包数量</td>
<td style="text-align: center;">多（握手 + 数据 + 确认）</td>
<td style="text-align: center;">少（仅数据包）</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_20">📝 章节小结<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>本章介绍了网络通信的基础知识：</p>
<ol>
<li><strong>OSI 七层模型与 TCP/IP 四层模型</strong>：理解网络分层架构的设计思想，掌握各层的职责</li>
<li><strong>数据封装与解封装</strong>：理解数据在网络中传输时的打包和拆包过程</li>
<li><strong>TCP 协议</strong>：掌握三次握手、四次挥手、标志位、MSS 分片等核心概念</li>
<li><strong>UDP 协议</strong>：理解无连接、不可靠传输的特点和应用场景</li>
<li><strong>网络抓包</strong>：学会使用 tcpdump 和 Wireshark 进行网络问题分析</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>动手实践 nc 和 tcpdump 命令</li>
<li>使用 Wireshark 分析真实的网络包</li>
<li>理解每一层的头部信息，这对后续学习容器网络非常重要</li>
</ol>
</blockquote>
<hr />
<h2 id="2-ip-mac">第2章 IP 地址与 MAC 地址精讲<a class="headerlink" href="#2-ip-mac" title="Permanent link">&para;</a></h2>
<h3 id="_21">🎯 学习目标<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<ul>
<li>掌握 IP 地址的点分十进制表示与二进制转换</li>
<li>理解有类地址（A/B/C/D/E）与无类地址（CIDR）的区别</li>
<li>熟练掌握 VLSM（可变长子网掩码）的计算方法</li>
<li>理解 MAC 地址的结构与 OUI 厂商标识</li>
<li>掌握二层交换与三层路由的核心区别</li>
<li>理解路由转发过程中 IP 和 MAC 地址的变化规律</li>
</ul>
<hr />
<h3 id="21-ip">2.1 IP 地址基础<a class="headerlink" href="#21-ip" title="Permanent link">&para;</a></h3>
<h4 id="_22">背景<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>IP 地址是网络层的核心标识，用于在互联网中唯一标识一台设备的逻辑位置。与 MAC 地址不同，IP 地址是<strong>逻辑地址</strong>，可以根据网络规划进行分配和更改。</p>
<blockquote>
<p>[!NOTE]
IP 地址是逻辑地址，它不与设备绑定。例如，你的手机今天在家获得 <code>192.168.1.100</code>，明天同事来你家用他的手机也可能获得这个地址。</p>
</blockquote>
<h4 id="_23">原理<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<h5 id="211">2.1.1 点分十进制与二进制转换<a class="headerlink" href="#211" title="Permanent link">&para;</a></h5>
<p>IPv4 地址是一个 <strong>32 位的二进制数</strong>，为了便于人类阅读，将其分为 4 组，每组 8 位（1 字节），转换为十进制后用点分隔，称为<strong>点分十进制</strong>。</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Binary[&quot;二进制表示 (32位)&quot;]
        B1[&quot;11000000&quot;] --- B2[&quot;10101000&quot;] --- B3[&quot;00000010&quot;] --- B4[&quot;01001000&quot;]
    end

    subgraph Decimal[&quot;点分十进制&quot;]
        D1[&quot;192&quot;] --- D2[&quot;168&quot;] --- D3[&quot;2&quot;] --- D4[&quot;72&quot;]
    end

    B1 --&gt; D1
    B2 --&gt; D2
    B3 --&gt; D3
    B4 --&gt; D4
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<p>上图展示了 IP 地址 <code>192.168.2.72</code> 的二进制与十进制转换：</p>
<ul>
<li>每 8 位二进制对应一个十进制数</li>
<li>每个十进制数的范围是 0-255</li>
</ul>
<p><strong>二进制权重计算表</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">位置</th>
<th style="text-align: center;">第7位</th>
<th style="text-align: center;">第6位</th>
<th style="text-align: center;">第5位</th>
<th style="text-align: center;">第4位</th>
<th style="text-align: center;">第3位</th>
<th style="text-align: center;">第2位</th>
<th style="text-align: center;">第1位</th>
<th style="text-align: center;">第0位</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">权重</td>
<td style="text-align: center;">128</td>
<td style="text-align: center;">64</td>
<td style="text-align: center;">32</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: center;">示例</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">计算</td>
<td style="text-align: center;">128</td>
<td style="text-align: center;">64</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
</tbody>
</table>
<p><strong>结果</strong>：128 + 64 = <strong>192</strong></p>
<h5 id="212-ip">2.1.2 IP 地址分类（有类地址）<a class="headerlink" href="#212-ip" title="Permanent link">&para;</a></h5>
<p>早期的 IP 地址按照<strong>有类</strong>方式划分为 A、B、C、D、E 五类：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">类别</th>
<th style="text-align: center;">首位模式</th>
<th style="text-align: center;">网络位</th>
<th style="text-align: center;">主机位</th>
<th style="text-align: left;">地址范围</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">A 类</td>
<td style="text-align: center;">0xxxxxxx</td>
<td style="text-align: center;">8 位</td>
<td style="text-align: center;">24 位</td>
<td style="text-align: left;">1.0.0.0 ~ 127.255.255.255</td>
<td style="text-align: left;">大型网络</td>
</tr>
<tr>
<td style="text-align: center;">B 类</td>
<td style="text-align: center;">10xxxxxx</td>
<td style="text-align: center;">16 位</td>
<td style="text-align: center;">16 位</td>
<td style="text-align: left;">128.0.0.0 ~ 191.255.255.255</td>
<td style="text-align: left;">中型网络</td>
</tr>
<tr>
<td style="text-align: center;">C 类</td>
<td style="text-align: center;">110xxxxx</td>
<td style="text-align: center;">24 位</td>
<td style="text-align: center;">8 位</td>
<td style="text-align: left;">192.0.0.0 ~ 223.255.255.255</td>
<td style="text-align: left;">小型网络</td>
</tr>
<tr>
<td style="text-align: center;">D 类</td>
<td style="text-align: center;">1110xxxx</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
<td style="text-align: left;">224.0.0.0 ~ 239.255.255.255</td>
<td style="text-align: left;">组播地址</td>
</tr>
<tr>
<td style="text-align: center;">E 类</td>
<td style="text-align: center;">1111xxxx</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
<td style="text-align: left;">240.0.0.0 ~ 255.255.255.255</td>
<td style="text-align: left;">保留/实验</td>
</tr>
</tbody>
</table>
<p><strong>要点解读</strong>：</p>
<blockquote>
<p>[!NOTE]
有类地址划分已经过时，现代网络普遍使用<strong>无类域间路由（CIDR）</strong>。但理解有类地址有助于理解网络发展历史和一些遗留配置。</p>
</blockquote>
<h5 id="213">2.1.3 公有地址与私有地址<a class="headerlink" href="#213" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th style="text-align: center;">类别</th>
<th style="text-align: left;">私有地址范围</th>
<th style="text-align: center;">可用主机数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">A 类</td>
<td style="text-align: left;">10.0.0.0 ~ 10.255.255.255</td>
<td style="text-align: center;">约 1677 万</td>
</tr>
<tr>
<td style="text-align: center;">B 类</td>
<td style="text-align: left;">172.16.0.0 ~ 172.31.255.255</td>
<td style="text-align: center;">约 104 万</td>
</tr>
<tr>
<td style="text-align: center;">C 类</td>
<td style="text-align: left;">192.168.0.0 ~ 192.168.255.255</td>
<td style="text-align: center;">约 6.5 万</td>
</tr>
</tbody>
</table>
<p><strong>要点解读</strong>：</p>
<ul>
<li><strong>私有地址</strong>只能在内网使用，不能直接访问互联网</li>
<li>家庭路由器通常使用 <code>192.168.0.x</code> 或 <code>192.168.1.x</code></li>
<li>大型企业通常使用 <code>10.x.x.x</code> 段，因为地址空间更大</li>
</ul>
<hr />
<h3 id="22-vlsm">2.2 子网划分与 VLSM<a class="headerlink" href="#22-vlsm" title="Permanent link">&para;</a></h3>
<h4 id="_24">背景<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<p>在实际网络规划中，很少严格按照 A/B/C 类来划分网络。<strong>VLSM（Variable Length Subnet Mask，可变长子网掩码）</strong>允许我们根据实际需求灵活划分子网，这就是<strong>无类域间路由（CIDR）</strong>的核心思想。</p>
<h4 id="_25">原理<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<h5 id="221">2.2.1 网络位与主机位<a class="headerlink" href="#221" title="Permanent link">&para;</a></h5>
<p>一个 IP 地址由两部分组成：</p>
<ul>
<li><strong>网络位</strong>：标识所属网络（固定不变的部分）</li>
<li><strong>主机位</strong>：标识网络内的具体主机（可变的部分）</li>
</ul>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph IP[&quot;IP 地址: 192.168.1.72/24&quot;]
        NET[&quot;网络位: 192.168.1&quot;] --- HOST[&quot;主机位: 72&quot;]
    end

    subgraph Mask[&quot;子网掩码: 255.255.255.0&quot;]
        M1[&quot;255&quot;] --- M2[&quot;255&quot;] --- M3[&quot;255&quot;] --- M4[&quot;0&quot;]
        M1_B[&quot;11111111&quot;] --- M2_B[&quot;11111111&quot;] --- M3_B[&quot;11111111&quot;] --- M4_B[&quot;00000000&quot;]
    end

    NET -.-&gt; |&quot;前 24 位固定&quot;| M1
    HOST -.-&gt; |&quot;后 8 位可变&quot;| M4
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li><code>/24</code> 表示前 24 位是网络位（固定），后 8 位是主机位（可变）</li>
<li>子网掩码 <code>255.255.255.0</code> 的二进制表示中，<code>1</code> 表示网络位，<code>0</code> 表示主机位</li>
</ul>
<h5 id="222-vlsm">2.2.2 VLSM 计算实例<a class="headerlink" href="#222-vlsm" title="Permanent link">&para;</a></h5>
<p><strong>问题</strong>：如何将一个 /24 网络 <code>192.168.1.0/24</code> 划分为两个子网？</p>
<p><strong>解答</strong>：</p>
<p>将掩码从 /24 变为 /25，即多借用 1 位作为网络位：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">子网</th>
<th style="text-align: left;">网络地址</th>
<th style="text-align: left;">地址范围</th>
<th style="text-align: left;">广播地址</th>
<th style="text-align: center;">可用主机数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">子网1</td>
<td style="text-align: left;">192.168.1.0/25</td>
<td style="text-align: left;">192.168.1.1 ~ 192.168.1.126</td>
<td style="text-align: left;">192.168.1.127</td>
<td style="text-align: center;">126</td>
</tr>
<tr>
<td style="text-align: center;">子网2</td>
<td style="text-align: left;">192.168.1.128/25</td>
<td style="text-align: left;">192.168.1.129 ~ 192.168.1.254</td>
<td style="text-align: left;">192.168.1.255</td>
<td style="text-align: center;">126</td>
</tr>
</tbody>
</table>
<p><strong>计算过程</strong>：</p>
<div class="highlight"><pre><span></span><code>/24 掩码：11111111.11111111.11111111.00000000
/25 掩码：11111111.11111111.11111111.10000000
                                      ↑
                                   多借 1 位

第 25 位 = 0 → 子网1：主机位范围 0~127（0000000 ~ 1111111）
第 25 位 = 1 → 子网2：主机位范围 128~255（10000000 ~ 11111111）
</code></pre></div>
<h5 id="223">2.2.3 常用掩码速查表<a class="headerlink" href="#223" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th style="text-align: center;">CIDR</th>
<th style="text-align: left;">子网掩码</th>
<th style="text-align: center;">可用主机数</th>
<th style="text-align: left;">常用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">/30</td>
<td style="text-align: left;">255.255.255.252</td>
<td style="text-align: center;">2</td>
<td style="text-align: left;">点对点链路（路由器互联）</td>
</tr>
<tr>
<td style="text-align: center;">/29</td>
<td style="text-align: left;">255.255.255.248</td>
<td style="text-align: center;">6</td>
<td style="text-align: left;">小型服务器组</td>
</tr>
<tr>
<td style="text-align: center;">/28</td>
<td style="text-align: left;">255.255.255.240</td>
<td style="text-align: center;">14</td>
<td style="text-align: left;">小型 VLAN</td>
</tr>
<tr>
<td style="text-align: center;">/27</td>
<td style="text-align: left;">255.255.255.224</td>
<td style="text-align: center;">30</td>
<td style="text-align: left;">小型办公室</td>
</tr>
<tr>
<td style="text-align: center;">/26</td>
<td style="text-align: left;">255.255.255.192</td>
<td style="text-align: center;">62</td>
<td style="text-align: left;">中型 VLAN</td>
</tr>
<tr>
<td style="text-align: center;">/25</td>
<td style="text-align: left;">255.255.255.128</td>
<td style="text-align: center;">126</td>
<td style="text-align: left;">大型 VLAN</td>
</tr>
<tr>
<td style="text-align: center;">/24</td>
<td style="text-align: left;">255.255.255.0</td>
<td style="text-align: center;">254</td>
<td style="text-align: left;">标准子网</td>
</tr>
<tr>
<td style="text-align: center;">/16</td>
<td style="text-align: left;">255.255.0.0</td>
<td style="text-align: center;">65534</td>
<td style="text-align: left;">大型网络</td>
</tr>
</tbody>
</table>
<h4 id="_26">关键点<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!IMPORTANT]
<strong>CNI 中的 /32 掩码</strong></p>
<p>在 Kubernetes CNI 中，Pod IP 经常使用 <code>/32</code> 掩码。这意味着：</p>
<ul>
<li>所有 32 位都是网络位，没有主机位</li>
<li>每个 Pod IP 都是一个独立的"网络"</li>
<li><strong>同节点的两个 Pod 之间也需要通过路由通信，而非二层交换</strong></li>
</ul>
<p>这是理解 Calico 等 CNI 路由模式的关键！</p>
</blockquote>
<hr />
<h3 id="23-mac">2.3 MAC 地址详解<a class="headerlink" href="#23-mac" title="Permanent link">&para;</a></h3>
<h4 id="_27">背景<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<p>MAC（Media Access Control）地址是<strong>数据链路层</strong>的物理地址，用于在同一局域网内唯一标识一个网络设备。与 IP 地址不同，MAC 地址通常与网卡硬件绑定，也称为<strong>硬件地址</strong>或<strong>物理地址</strong>。</p>
<h4 id="_28">原理<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<h5 id="231-mac">2.3.1 MAC 地址结构<a class="headerlink" href="#231-mac" title="Permanent link">&para;</a></h5>
<p>MAC 地址是一个 <strong>48 位（6 字节）</strong> 的地址，通常用<strong>冒号分十六进制</strong>表示：</p>
<div class="highlight"><pre><span></span><code>AA:BB:CC:DD:EE:FF
└──┬──┘ └──┬──┘
  OUI     设备标识
(厂商)   (序列号)
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">部分</th>
<th style="text-align: center;">位数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">OUI</td>
<td style="text-align: center;">前 24 位</td>
<td style="text-align: left;">Organizationally Unique Identifier，厂商标识</td>
</tr>
<tr>
<td style="text-align: center;">设备标识</td>
<td style="text-align: center;">后 24 位</td>
<td style="text-align: left;">由厂商分配的设备序列号</td>
</tr>
</tbody>
</table>
<p><strong>常见厂商 OUI</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">OUI 前缀</th>
<th style="text-align: left;">厂商</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>00:50:56</code></td>
<td style="text-align: left;">VMware</td>
</tr>
<tr>
<td style="text-align: left;"><code>FA:16:3E</code></td>
<td style="text-align: left;">OpenStack</td>
</tr>
<tr>
<td style="text-align: left;"><code>52:54:00</code></td>
<td style="text-align: left;">QEMU/KVM</td>
</tr>
<tr>
<td style="text-align: left;"><code>00:0C:29</code></td>
<td style="text-align: left;">VMware</td>
</tr>
<tr>
<td style="text-align: left;"><code>00:1A:A0</code></td>
<td style="text-align: left;">Dell</td>
</tr>
</tbody>
</table>
<h5 id="232-mac">2.3.2 特殊 MAC 地址<a class="headerlink" href="#232-mac" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th style="text-align: center;">类型</th>
<th style="text-align: left;">地址</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">广播 MAC</td>
<td style="text-align: left;"><code>FF:FF:FF:FF:FF:FF</code></td>
<td style="text-align: left;">发送给同一广播域内所有设备</td>
</tr>
<tr>
<td style="text-align: center;">组播 MAC</td>
<td style="text-align: left;"><code>01:xx:xx:xx:xx:xx</code></td>
<td style="text-align: left;">第 8 位为 1，发送给一组设备</td>
</tr>
</tbody>
</table>
<h5 id="233-mac">2.3.3 MAC 地址表与学习机制<a class="headerlink" href="#233-mac" title="Permanent link">&para;</a></h5>
<p>交换机通过<strong>MAC 地址表</strong>来转发数据帧：</p>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Switch[&quot;交换机 MAC 地址表&quot;]
        T[MAC 地址表]
        E1[&quot;端口1 → AA:BB:CC:11:22:33&quot;]
        E2[&quot;端口2 → AA:BB:CC:44:55:66&quot;]
        E3[&quot;端口3 → AA:BB:CC:77:88:99&quot;]
    end

    P1[主机 A] --&gt;|端口1| Switch
    P2[主机 B] --&gt;|端口2| Switch
    P3[主机 C] --&gt;|端口3| Switch
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<p>交换机的学习过程：</p>
<ol>
<li>收到数据帧后，记录<strong>源 MAC 地址</strong>与<strong>入端口</strong>的对应关系</li>
<li>查找<strong>目的 MAC 地址</strong>对应的端口，从该端口转发</li>
<li>如果找不到目的 MAC，则<strong>泛洪</strong>到所有端口（除入端口外）</li>
<li>表项有<strong>老化时间</strong>，长时间无流量会被删除</li>
</ol>
<hr />
<h3 id="24">2.4 二层交换与三层路由<a class="headerlink" href="#24" title="Permanent link">&para;</a></h3>
<h4 id="_29">背景<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<p>网络通信的核心问题是：<strong>数据包应该发给谁？如何到达目的地？</strong></p>
<p>根据通信双方是否在<strong>同一网段</strong>，分为：</p>
<ul>
<li><strong>同网段通信</strong>：走二层交换（基于 MAC 地址）</li>
<li><strong>跨网段通信</strong>：走三层路由（基于 IP 地址）</li>
</ul>
<h4 id="_30">原理<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Layer2[&quot;二层交换（同网段）&quot;]
        H1[&quot;主机 A&lt;br/&gt;192.168.1.10&quot;] &lt;--&gt;|MAC 直接通信| SW[交换机]
        SW &lt;--&gt;|MAC 直接通信| H2[&quot;主机 B&lt;br/&gt;192.168.1.20&quot;]
    end

    subgraph Layer3[&quot;三层路由（跨网段）&quot;]
        H3[&quot;主机 C&lt;br/&gt;192.168.1.10&quot;] --&gt;|经过网关| R[路由器]
        R --&gt;|路由转发| H4[&quot;主机 D&lt;br/&gt;192.168.2.20&quot;]
    end
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">场景</th>
<th style="text-align: left;">判断依据</th>
<th style="text-align: left;">转发方式</th>
<th style="text-align: left;">地址变化</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">同网段</td>
<td style="text-align: left;">目的 IP 与源 IP 在同一子网</td>
<td style="text-align: left;">二层交换</td>
<td style="text-align: left;">MAC 不变</td>
</tr>
<tr>
<td style="text-align: center;">跨网段</td>
<td style="text-align: left;">目的 IP 与源 IP 不在同一子网</td>
<td style="text-align: left;">三层路由</td>
<td style="text-align: left;"><strong>MAC 每跳改变</strong></td>
</tr>
</tbody>
</table>
<h5 id="_31">判断是否同网段的方法<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h5>
<p>已知：</p>
<ul>
<li>主机 A：<code>192.168.1.2/24</code></li>
<li>主机 B：<code>192.168.1.130/24</code></li>
<li>主机 C：<code>192.168.1.130/25</code></li>
</ul>
<p><strong>分析</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">比较</th>
<th style="text-align: left;">A 的网段</th>
<th style="text-align: left;">B 的网段</th>
<th style="text-align: center;">是否同网段</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">A 和 B（/24）</td>
<td style="text-align: left;">192.168.1.0</td>
<td style="text-align: left;">192.168.1.0</td>
<td style="text-align: center;">✅ 是</td>
</tr>
<tr>
<td style="text-align: left;">A 和 C（不同掩码）</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">-</td>
<td style="text-align: center;">需按各自掩码计算</td>
</tr>
</tbody>
</table>
<p><strong>如果 A 使用 /25 掩码</strong>：</p>
<ul>
<li>A (192.168.1.2/25)：网段 192.168.1.0，范围 0~127</li>
<li>C (192.168.1.130/25)：网段 192.168.1.128，范围 128~255</li>
<li><strong>结论：A 和 C 不在同一网段！</strong></li>
</ul>
<hr />
<h3 id="25-arp-ip-mac">2.5 ARP 协议与 IP-MAC 映射<a class="headerlink" href="#25-arp-ip-mac" title="Permanent link">&para;</a></h3>
<h4 id="_32">背景<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<p>当主机知道目的 IP 但不知道目的 MAC 时，需要通过 <strong>ARP（Address Resolution Protocol）</strong> 协议来获取 MAC 地址。</p>
<h4 id="_33">原理<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant A as 主机 A&lt;br/&gt;192.168.1.10
    participant B as 主机 B&lt;br/&gt;192.168.1.20

    Note over A: 我要发数据给 192.168.1.20&lt;br/&gt;但不知道它的 MAC 地址
    A-&gt;&gt;B: ARP Request 广播&lt;br/&gt;谁是 192.168.1.20？
    Note over B: 是我！
    B-&gt;&gt;A: ARP Reply 单播&lt;br/&gt;我是 192.168.1.20&lt;br/&gt;我的 MAC 是 AA:BB:CC:DD:EE:FF
    Note over A: 记录到 ARP 缓存表&lt;br/&gt;192.168.1.20 → AA:BB:CC:DD:EE:FF
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ol>
<li>主机 A 发送 <strong>ARP 请求广播</strong>，询问 <code>192.168.1.20</code> 的 MAC 地址</li>
<li>主机 B 收到请求后，<strong>单播回复</strong>自己的 MAC 地址</li>
<li>主机 A 将 IP-MAC 映射<strong>缓存到 ARP 表</strong>，后续通信直接使用</li>
</ol>
<p><strong>查看 ARP 缓存</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Linux 查看 ARP 表</span>
ip<span class="w"> </span>neigh<span class="w"> </span>show

<span class="c1"># 或使用传统命令</span>
arp<span class="w"> </span>-a
</code></pre></div>
<hr />
<h3 id="26-ipmac">2.6 路由转发过程中的 IP/MAC 变化规律<a class="headerlink" href="#26-ipmac" title="Permanent link">&para;</a></h3>
<h4 id="_34">背景<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<p>这是理解网络转发的<strong>最核心知识点</strong>。很多从业多年的工程师也不一定能说清楚：在路由转发过程中，哪些地址在变化，哪些不变？</p>
<h4 id="_35">原理<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h4>
<p><strong>核心结论（非 NAT 场景）</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">地址类型</th>
<th style="text-align: center;">是否变化</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">源 IP</td>
<td style="text-align: center;"><strong>不变</strong></td>
<td style="text-align: left;">始终是发送方的 IP</td>
</tr>
<tr>
<td style="text-align: center;">目的 IP</td>
<td style="text-align: center;"><strong>不变</strong></td>
<td style="text-align: left;">始终是接收方的 IP</td>
</tr>
<tr>
<td style="text-align: center;">源 MAC</td>
<td style="text-align: center;"><strong>每跳改变</strong></td>
<td style="text-align: left;">变为上一跳设备的出接口 MAC</td>
</tr>
<tr>
<td style="text-align: center;">目的 MAC</td>
<td style="text-align: center;"><strong>每跳改变</strong></td>
<td style="text-align: left;">变为下一跳设备的入接口 MAC</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph S1[&quot;Server 1&quot;]
        IP1[&quot;IP: 10.1.5.10&quot;]
        MAC1[&quot;MAC: AA:11&quot;]
    end

    subgraph R[&quot;Router&quot;]
        R_E1[&quot;eth1&lt;br/&gt;MAC: BB:11&quot;]
        R_E2[&quot;eth2&lt;br/&gt;MAC: BB:22&quot;]
    end

    subgraph S2[&quot;Server 2&quot;]
        IP2[&quot;IP: 10.1.8.10&quot;]
        MAC2[&quot;MAC: CC:11&quot;]
    end

    S1 --&gt;|1| R
    R --&gt;|2| S2
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<p>当 Server 1 ping Server 2 时：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">阶段</th>
<th style="text-align: center;">源 IP</th>
<th style="text-align: center;">目的 IP</th>
<th style="text-align: center;">源 MAC</th>
<th style="text-align: center;">目的 MAC</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">S1 → R (eth1)</td>
<td style="text-align: center;">10.1.5.10</td>
<td style="text-align: center;">10.1.8.10</td>
<td style="text-align: center;"><strong>AA:11</strong></td>
<td style="text-align: center;"><strong>BB:11</strong></td>
</tr>
<tr>
<td style="text-align: center;">R (eth2) → S2</td>
<td style="text-align: center;">10.1.5.10</td>
<td style="text-align: center;">10.1.8.10</td>
<td style="text-align: center;"><strong>BB:22</strong></td>
<td style="text-align: center;"><strong>CC:11</strong></td>
</tr>
</tbody>
</table>
<p><strong>要点解读</strong>：</p>
<blockquote>
<p>[!IMPORTANT]
<strong>关键理解</strong>：</p>
<ol>
<li><strong>IP 地址决定最终目的地</strong>，在整个路由过程中始终不变（NAT 除外）</li>
<li><strong>MAC 地址决定下一跳</strong>，每经过一个路由器都会改变</li>
<li>发送数据时，<strong>目的 MAC 是网关的 MAC</strong>，不是最终目标的 MAC</li>
<li>这就是为什么同网段走交换（MAC 直达），跨网段走路由（MAC 逐跳变化）</li>
</ol>
</blockquote>
<h4 id="_36">实验验证<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h4>
<p><strong>步骤一：创建测试环境（使用 Containerlab）</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">routing-lab</span>
<span class="nt">topology</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">router</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos/vyos:1.2.8</span>
<span class="w">    </span><span class="nt">server1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">    </span><span class="nt">server2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">  </span><span class="nt">links</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;router:eth1&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server1:net0&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;router:eth2&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server2:net0&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>步骤二：在 Server 2 上抓包</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Server 2 的 net0 接口抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>net0<span class="w"> </span>-e<span class="w"> </span>-nn<span class="w"> </span>icmp

<span class="c1"># 输出示例：</span>
<span class="c1"># 12:00:00.001 BB:22 &gt; CC:11, 10.1.5.10 &gt; 10.1.8.10: ICMP echo request</span>
<span class="c1"># 12:00:00.002 CC:11 &gt; BB:22, 10.1.8.10 &gt; 10.1.5.10: ICMP echo reply</span>
</code></pre></div>
<p><strong>步骤三：分析结果</strong></p>
<ul>
<li><strong>源 MAC（BB:22）</strong>：是路由器 eth2 的 MAC，不是 Server 1 的 MAC</li>
<li><strong>源 IP（10.1.5.10）</strong>：仍然是 Server 1 的 IP，没有变化</li>
</ul>
<h4 id="ttl">TTL 值的变化<a class="headerlink" href="#ttl" title="Permanent link">&para;</a></h4>
<p><strong>TTL（Time To Live）</strong>：数据包的生存时间，每经过一个路由器减 1。</p>
<table>
<thead>
<tr>
<th style="text-align: center;">场景</th>
<th style="text-align: center;">TTL 变化</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">二层交换</td>
<td style="text-align: center;">不变</td>
<td style="text-align: left;">不经过路由器</td>
</tr>
<tr>
<td style="text-align: center;">三层路由</td>
<td style="text-align: center;">减 1</td>
<td style="text-align: left;">每跳减 1</td>
</tr>
</tbody>
</table>
<p><strong>作用</strong>：防止数据包在网络中无限循环。当 TTL 减为 0 时，路由器丢弃该数据包。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 通过 TTL 判断是否经过路由</span>
ping<span class="w"> </span><span class="m">10</span>.1.8.10

<span class="c1"># 同网段：TTL = 64（Linux 默认）</span>
<span class="c1"># 跨一跳：TTL = 63</span>
<span class="c1"># 跨两跳：TTL = 62</span>
</code></pre></div>
<hr />
<h3 id="27-containerlab">2.7 使用 Containerlab 进行网络实验<a class="headerlink" href="#27-containerlab" title="Permanent link">&para;</a></h3>
<h4 id="_37">背景<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h4>
<p>Containerlab 是一个强大的容器化网络实验工具，可以快速搭建包含路由器、交换机、主机的复杂网络拓扑，非常适合学习和验证网络知识。</p>
<h4 id="vs">实验：二层交换 vs 三层路由<a class="headerlink" href="#vs" title="Permanent link">&para;</a></h4>
<p><strong>二层交换拓扑</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">layer2-lab</span>
<span class="nt">topology</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bridge</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span>
<span class="w">    </span><span class="nt">server1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.5.10/24 dev net0</span>
<span class="w">    </span><span class="nt">server2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.5.11/24 dev net0</span>
<span class="w">  </span><span class="nt">links</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;bridge:eth1&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server1:net0&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;bridge:eth2&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server2:net0&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>验证</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 server1 ping server2</span>
ping<span class="w"> </span><span class="m">10</span>.1.5.11

<span class="c1"># TTL = 64，说明没有经过路由器，走的二层交换</span>
</code></pre></div>
<p><strong>三层路由拓扑</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">layer3-lab</span>
<span class="nt">topology</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">router</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos/vyos:1.2.8</span>
<span class="w">    </span><span class="nt">server1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.5.10/24 dev net0</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip route add default via 10.1.5.1</span>
<span class="w">    </span><span class="nt">server2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.8.10/24 dev net0</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip route add default via 10.1.8.1</span>
<span class="w">  </span><span class="nt">links</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;router:eth1&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server1:net0&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;router:eth2&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server2:net0&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>验证</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 server1 ping server2</span>
ping<span class="w"> </span><span class="m">10</span>.1.8.10

<span class="c1"># TTL = 63，说明经过了一跳路由器</span>
</code></pre></div>
<hr />
<h3 id="_38">📝 章节小结<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>本章深入讲解了 IP 地址和 MAC 地址的核心知识：</p>
<ol>
<li><strong>IP 地址基础</strong>：点分十进制、二进制转换、有类地址分类</li>
<li><strong>VLSM 子网划分</strong>：掌握网络位/主机位计算、快速确定地址范围</li>
<li><strong>MAC 地址结构</strong>：48 位硬件地址、OUI 厂商标识</li>
<li><strong>二层交换 vs 三层路由</strong>：</li>
<li>同网段走交换，MAC 不变</li>
<li>跨网段走路由，MAC 每跳改变</li>
<li><strong>路由转发中的地址变化</strong>：</li>
<li><strong>IP 不变</strong>（NAT 除外）</li>
<li><strong>MAC 每跳改变</strong></li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>熟练掌握 VLSM 计算，这是网络工程师的基本功</li>
<li>使用 Containerlab 动手搭建实验环境</li>
<li>通过抓包验证 IP/MAC 地址的变化规律</li>
<li>理解 <code>/32</code> 掩码在 CNI 中的应用场景</li>
</ol>
<p>[!CAUTION]
<strong>常见误区</strong>：</p>
<ul>
<li>❌ 认为目的 MAC 就是目标主机的 MAC</li>
<li>
<p>✅ 目的 MAC 是<strong>下一跳</strong>设备的 MAC（可能是网关）</p>
</li>
<li>
<p>❌ 认为 IP 地址在路由过程中会变化</p>
</li>
<li>✅ 在非 NAT 场景下，IP 地址<strong>始终不变</strong></li>
</ul>
</blockquote>
<hr />
<h2 id="3-veth">第3章 VETH 虚拟网络设备<a class="headerlink" href="#3-veth" title="Permanent link">&para;</a></h2>
<h3 id="_39">🎯 学习目标<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 VETH Pair 的概念与工作原理</li>
<li>掌握 Linux 网络命名空间（Network Namespace）的基本操作</li>
<li>学会手工创建和配置 VETH Pair</li>
<li>理解 Linux Bridge 与 VETH 的结合使用</li>
<li>掌握 VETH 在容器网络（CNI）中的核心应用</li>
</ul>
<hr />
<h3 id="31-veth-pair">3.1 VETH Pair 概念与原理<a class="headerlink" href="#31-veth-pair" title="Permanent link">&para;</a></h3>
<h4 id="_40">背景<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h4>
<p>在容器网络中，每个容器（Pod）都运行在独立的<strong>网络命名空间（Network Namespace）</strong>中，与宿主机的网络隔离。那么，容器如何与外界通信呢？</p>
<p>答案是：<strong>VETH Pair（虚拟以太网设备对）</strong>。</p>
<h4 id="_41">原理<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h4>
<p><strong>VETH Pair</strong> 是 Linux 内核提供的一种虚拟网络设备，它<strong>总是成对出现</strong>，就像一根虚拟的网线，一端插在容器内，一端插在宿主机上。</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph NS1[&quot;容器网络命名空间&quot;]
        V1[&quot;veth0&lt;br/&gt;10.1.5.10&quot;]
    end

    subgraph ROOT[&quot;宿主机 Root Namespace&quot;]
        V2[&quot;veth1&quot;]
    end

    V1 ---|&quot;VETH Pair&lt;br/&gt;虚拟网线&quot;| V2
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li>VETH Pair 由两个虚拟网卡组成，它们<strong>总是成对创建</strong></li>
<li>从一端发送的数据包，会<strong>立即出现在另一端</strong></li>
<li>通过 VETH Pair，可以实现<strong>跨网络命名空间的通信</strong></li>
</ul>
<h4 id="_42">核心特性<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">成对出现</td>
<td style="text-align: left;">一个 VETH 设备必定有一个 Peer 设备</td>
</tr>
<tr>
<td style="text-align: left;">双向通信</td>
<td style="text-align: left;">从一端发送的包会从另一端收到</td>
</tr>
<tr>
<td style="text-align: left;">跨命名空间</td>
<td style="text-align: left;">两端可以分别位于不同的网络命名空间</td>
</tr>
<tr>
<td style="text-align: left;">即时传输</td>
<td style="text-align: left;">数据包在内核中直接传递，无需经过物理网络</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>形象理解</strong>：VETH Pair 就像一根虚拟网线，把容器内部和宿主机连接起来。从网线一端发送的数据，必然从另一端出来。</p>
</blockquote>
<hr />
<h3 id="32-veth">3.2 VETH 在容器网络中的应用<a class="headerlink" href="#32-veth" title="Permanent link">&para;</a></h3>
<h4 id="_43">背景<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h4>
<p>在 Kubernetes 中，每个 Pod 都有自己独立的网络命名空间。Pod 内的应用要与外界通信，必须先将流量从 Pod 的网络命名空间"引出"到宿主机的 Root Namespace，然后才能进行后续的路由或转发。</p>
<h4 id="_44">原理<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Host[&quot;宿主机 (Root Namespace)&quot;]
        direction TB
        ETH0[&quot;eth0&lt;br/&gt;物理网卡&quot;]
        ROUTING[&quot;路由/转发&quot;]
        V2[&quot;veth-host&quot;]

        ETH0 --- ROUTING --- V2
    end

    subgraph Pod[&quot;Pod 网络命名空间&quot;]
        V1[&quot;eth0&lt;br/&gt;10.244.1.10/32&quot;]
    end

    V1 ---|&quot;VETH Pair&quot;| V2

    ROUTING --&gt;|&quot;南北向流量&lt;br/&gt;SNAT&quot;| INTERNET[&quot;外部网络&quot;]
    ROUTING --&gt;|&quot;东西向流量&lt;br/&gt;Pod to Pod&quot;| OTHER[&quot;其他节点&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ol>
<li><strong>Pod 网络命名空间</strong>：Pod 内的 eth0 是 VETH Pair 的一端</li>
<li><strong>宿主机 Root Namespace</strong>：VETH Pair 的另一端在宿主机上</li>
<li><strong>流量转发</strong>：</li>
<li><strong>南北向流量</strong>（Pod ↔ 外网）：从 VETH 到宿主机，经过 SNAT 后发出</li>
<li><strong>东西向流量</strong>（Pod ↔ Pod）：从 VETH 到宿主机，根据路由转发到目标节点</li>
</ol>
<h4 id="cni">CNI 实现模式<a class="headerlink" href="#cni" title="Permanent link">&para;</a></h4>
<p>不同的 CNI 插件使用 VETH 的方式略有不同：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">CNI</th>
<th style="text-align: left;">VETH 使用方式</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">Flannel</td>
<td style="text-align: left;">VETH + Bridge</td>
<td style="text-align: left;">Pod 的 VETH 插入到 cni0 网桥</td>
</tr>
<tr>
<td style="text-align: center;">Calico</td>
<td style="text-align: left;">VETH + Routing</td>
<td style="text-align: left;">Pod 的 VETH 直接路由，使用 /32 掩码</td>
</tr>
<tr>
<td style="text-align: center;">Cilium</td>
<td style="text-align: left;">VETH + eBPF</td>
<td style="text-align: left;">使用 eBPF 加速，可绕过部分内核协议栈</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="33-veth-pair">3.3 手工创建 VETH Pair<a class="headerlink" href="#33-veth-pair" title="Permanent link">&para;</a></h3>
<h4 id="_45">背景<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h4>
<p>理解 VETH Pair 的最好方式是亲手创建一个。通过手工操作，可以深入理解容器网络的底层实现。</p>
<h4 id="_46">实现步骤<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<h5 id="_47">步骤一：创建网络命名空间<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建两个网络命名空间</span>
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>ns1
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>ns2

<span class="c1"># 查看已创建的命名空间</span>
ip<span class="w"> </span>netns<span class="w"> </span>list
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li><code>ip netns add</code>：创建网络命名空间</li>
<li><code>ip netns list</code>：列出所有网络命名空间</li>
</ul>
<h5 id="veth-pair">步骤二：创建 VETH Pair<a class="headerlink" href="#veth-pair" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建 VETH Pair：veth01 和 veth10</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>veth01<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>veth10

<span class="c1"># 查看创建的设备</span>
ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li><code>ip link add ... type veth peer name ...</code>：创建一对 VETH 设备</li>
<li>此时两个设备都在 Root Namespace 中</li>
</ul>
<h5 id="_48">步骤三：分配到不同命名空间<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 将 veth01 移动到 ns1</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth01<span class="w"> </span>netns<span class="w"> </span>ns1

<span class="c1"># 将 veth10 移动到 ns2</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth10<span class="w"> </span>netns<span class="w"> </span>ns2
</code></pre></div>
<h5 id="ip">步骤四：配置 IP 地址并启用<a class="headerlink" href="#ip" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 ns1 中配置 IP 并启用接口</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.5.10/24<span class="w"> </span>dev<span class="w"> </span>veth01
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth01<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up

<span class="c1"># 在 ns2 中配置 IP 并启用接口</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.5.11/24<span class="w"> </span>dev<span class="w"> </span>veth10
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth10<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up
</code></pre></div>
<h5 id="_49">步骤五：测试连通性<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 从 ns1 ping ns2</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.1.5.11

<span class="c1"># 应该能够 ping 通，输出类似：</span>
<span class="c1"># PING 10.1.5.11 (10.1.5.11) 56(84) bytes of data.</span>
<span class="c1"># 64 bytes from 10.1.5.11: icmp_seq=1 ttl=64 time=0.050 ms</span>
</code></pre></div>
<h5 id="veth-pair_1">步骤六：查看 VETH Pair 关系<a class="headerlink" href="#veth-pair_1" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 ns1 中查看 veth01 的 peer index</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ethtool<span class="w"> </span>-S<span class="w"> </span>veth01

<span class="c1"># 输出示例：</span>
<span class="c1"># NIC statistics:</span>
<span class="c1">#      peer_ifindex: 12  # peer 的接口索引</span>

<span class="c1"># 在 ns2 中查看 veth10 的接口索引</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>veth10
<span class="c1"># 应该显示接口索引为 12</span>
</code></pre></div>
<h5 id="_50">清理环境<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 删除命名空间（会自动删除其中的 VETH 设备）</span>
ip<span class="w"> </span>netns<span class="w"> </span>del<span class="w"> </span>ns1
ip<span class="w"> </span>netns<span class="w"> </span>del<span class="w"> </span>ns2
</code></pre></div>
<hr />
<h3 id="34-linux-bridge-veth">3.4 Linux Bridge 与 VETH<a class="headerlink" href="#34-linux-bridge-veth" title="Permanent link">&para;</a></h3>
<h4 id="_51">背景<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h4>
<p>在 Flannel 等 CNI 插件中，同一节点上的多个 Pod 需要互相通信。如果每对 Pod 之间都创建一个 VETH Pair，网络结构会非常复杂。</p>
<p>解决方案：引入 <strong>Linux Bridge（网桥）</strong>，让所有 Pod 的 VETH 都"插"在同一个网桥上。</p>
<h4 id="_52">原理<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Host[&quot;宿主机&quot;]
        BRIDGE[&quot;Linux Bridge (cni0)&quot;]
        ETH0[&quot;eth0&lt;br/&gt;物理网卡&quot;]

        V1H[&quot;veth-pod1&quot;]
        V2H[&quot;veth-pod2&quot;]
        V3H[&quot;veth-pod3&quot;]

        V1H --&gt; BRIDGE
        V2H --&gt; BRIDGE
        V3H --&gt; BRIDGE
        BRIDGE --&gt; ETH0
    end

    subgraph Pod1[&quot;Pod 1&quot;]
        V1P[&quot;eth0&quot;]
    end

    subgraph Pod2[&quot;Pod 2&quot;]
        V2P[&quot;eth0&quot;]
    end

    subgraph Pod3[&quot;Pod 3&quot;]
        V3P[&quot;eth0&quot;]
    end

    V1P ---|VETH| V1H
    V2P ---|VETH| V2H
    V3P ---|VETH| V3H
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li>每个 Pod 的 VETH 一端在 Pod 内（eth0），另一端插在宿主机的 cni0 网桥上</li>
<li>同节点的 Pod 之间通信：通过 cni0 网桥的<strong>二层交换</strong>完成</li>
<li>跨节点的 Pod 通信：从网桥经路由转发到物理网卡</li>
</ul>
<h4 id="bridge-veth">手工实现 Bridge + VETH<a class="headerlink" href="#bridge-veth" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 创建两个命名空间</span>
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>ns1
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>ns2

<span class="c1"># 2. 创建 Linux Bridge</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>br0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>bridge
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br0<span class="w"> </span>up

<span class="c1"># 3. 创建两对 VETH</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>int0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>br-int0
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>int1<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>br-int1

<span class="c1"># 4. 将 VETH 一端移入命名空间</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>int0<span class="w"> </span>netns<span class="w"> </span>ns1
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>int1<span class="w"> </span>netns<span class="w"> </span>ns2

<span class="c1"># 5. 将 VETH 另一端插入 Bridge</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br-int0<span class="w"> </span>master<span class="w"> </span>br0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br-int1<span class="w"> </span>master<span class="w"> </span>br0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br-int0<span class="w"> </span>up
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br-int1<span class="w"> </span>up

<span class="c1"># 6. 配置命名空间内的 IP</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.5.10/24<span class="w"> </span>dev<span class="w"> </span>int0
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>int0<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up

ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.5.11/24<span class="w"> </span>dev<span class="w"> </span>int1
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>int1<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up

<span class="c1"># 7. 测试连通性</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.1.5.11
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li><code>ip link set ... master br0</code>：将接口插入网桥，相当于把网线插入交换机</li>
<li>插入网桥后，该接口会显示 <code>master br0</code> 标识</li>
</ul>
<h4 id="bridge">查看 Bridge 状态<a class="headerlink" href="#bridge" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看所有网桥</span>
brctl<span class="w"> </span>show

<span class="c1"># 输出示例：</span>
<span class="c1"># bridge name     bridge id               STP enabled     interfaces</span>
<span class="c1"># br0             8000.aabbccdd1122       no              br-int0</span>
<span class="c1">#                                                         br-int1</span>

<span class="c1"># 查看网桥的 MAC 地址表</span>
brctl<span class="w"> </span>showmacs<span class="w"> </span>br0
</code></pre></div>
<hr />
<h3 id="35-veth-cni">3.5 VETH 在不同 CNI 中的应用<a class="headerlink" href="#35-veth-cni" title="Permanent link">&para;</a></h3>
<h4 id="_53">背景<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h4>
<p>不同的 CNI 插件虽然都使用 VETH，但实现方式和网络模型有明显区别。</p>
<h4 id="flannel-bridge">Flannel 的 Bridge 模式<a class="headerlink" href="#flannel-bridge" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Node[&quot;Kubernetes 节点&quot;]
        CNI0[&quot;cni0 网桥&lt;br/&gt;10.244.1.1/24&quot;]
        FLANNEL[&quot;flannel.1&lt;br/&gt;VxLAN 设备&quot;]
        ETH0[&quot;eth0&quot;]

        V1[&quot;veth-pod1&quot;] --&gt; CNI0
        V2[&quot;veth-pod2&quot;] --&gt; CNI0
        CNI0 --&gt; FLANNEL
        FLANNEL --&gt; ETH0
    end

    subgraph Pod1[&quot;Pod 1&lt;br/&gt;10.244.1.10&quot;]
        E1[&quot;eth0&quot;]
    end

    subgraph Pod2[&quot;Pod 2&lt;br/&gt;10.244.1.11&quot;]
        E2[&quot;eth0&quot;]
    end

    E1 ---|VETH| V1
    E2 ---|VETH| V2
</code></pre></div>
<p><strong>要点解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Flannel Bridge 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Pod 掩码</td>
<td style="text-align: left;"><strong>/24</strong>（同节点 Pod 同网段）</td>
</tr>
<tr>
<td style="text-align: left;">同节点通信</td>
<td style="text-align: left;">通过 cni0 网桥<strong>二层交换</strong></td>
</tr>
<tr>
<td style="text-align: left;">跨节点通信</td>
<td style="text-align: left;">通过 flannel.1 VxLAN 封装</td>
</tr>
<tr>
<td style="text-align: left;">优点</td>
<td style="text-align: left;">配置简单，同节点通信高效</td>
</tr>
<tr>
<td style="text-align: left;">缺点</td>
<td style="text-align: left;">二层广播域可能导致广播风暴</td>
</tr>
</tbody>
</table>
<h4 id="calico">Calico 的路由模式<a class="headerlink" href="#calico" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Node[&quot;Kubernetes 节点&quot;]
        ROUTING[&quot;路由表&quot;]
        ETH0[&quot;eth0&quot;]

        V1[&quot;cali-xxx1&quot;] --&gt; ROUTING
        V2[&quot;cali-xxx2&quot;] --&gt; ROUTING
        ROUTING --&gt; ETH0
    end

    subgraph Pod1[&quot;Pod 1&lt;br/&gt;10.244.1.10/32&quot;]
        E1[&quot;eth0&quot;]
    end

    subgraph Pod2[&quot;Pod 2&lt;br/&gt;10.244.1.11/32&quot;]
        E2[&quot;eth0&quot;]
    end

    E1 ---|VETH| V1
    E2 ---|VETH| V2
</code></pre></div>
<p><strong>要点解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Calico 路由模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Pod 掩码</td>
<td style="text-align: left;"><strong>/32</strong>（每个 Pod 独立网络）</td>
</tr>
<tr>
<td style="text-align: left;">同节点通信</td>
<td style="text-align: left;">通过<strong>路由表</strong>三层转发</td>
</tr>
<tr>
<td style="text-align: left;">跨节点通信</td>
<td style="text-align: left;">BGP 协议或 IPIP/VxLAN 封装</td>
</tr>
<tr>
<td style="text-align: left;">优点</td>
<td style="text-align: left;">无广播风暴，支持网络策略</td>
</tr>
<tr>
<td style="text-align: left;">缺点</td>
<td style="text-align: left;">需要维护路由表，配置较复杂</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>Calico 使用 /32 掩码的关键意义</strong>：</p>
<ul>
<li>使用 /32 掩码意味着<strong>没有任何 IP 与该 Pod 同网段</strong></li>
<li>因此同节点的 Pod 之间也<strong>必须走路由</strong>，而非二层交换</li>
<li>这使得 Calico 可以在<strong>路由层面实施网络策略</strong></li>
</ul>
</blockquote>
<hr />
<h3 id="36-containerlab-veth">3.6 使用 Containerlab 模拟 VETH 网络<a class="headerlink" href="#36-containerlab-veth" title="Permanent link">&para;</a></h3>
<h4 id="veth">简单 VETH 拓扑<a class="headerlink" href="#veth" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">veth-demo</span>
<span class="nt">topology</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">server1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.5.10/24 dev net0</span>
<span class="w">    </span><span class="nt">server2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.5.11/24 dev net0</span>
<span class="w">  </span><span class="nt">links</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;server1:net0&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server2:net0&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li><code>links</code> 定义的连接会自动创建 VETH Pair</li>
<li>server1 的 net0 和 server2 的 net0 通过 VETH 直连</li>
</ul>
<h4 id="bridge-veth_1">Bridge + VETH 拓扑<a class="headerlink" href="#bridge-veth_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge-veth-demo</span>
<span class="nt">topology</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bridge</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span>
<span class="w">    </span><span class="nt">server1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.5.10/24 dev net0</span>
<span class="w">    </span><span class="nt">server2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.5.11/24 dev net0</span>
<span class="w">  </span><span class="nt">links</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;bridge:eth1&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server1:net0&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;bridge:eth2&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server2:net0&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li><code>kind: bridge</code> 创建一个 Linux Bridge</li>
<li>server1 和 server2 都通过 VETH 连接到这个 Bridge</li>
<li>可以使用 <code>brctl show</code> 查看 Bridge 上的接口</li>
</ul>
<h4 id="_54">部署与验证<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 部署拓扑</span>
clab<span class="w"> </span>deploy<span class="w"> </span>-t<span class="w"> </span>veth-demo.yaml

<span class="c1"># 进入容器测试</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>clab-veth-demo-server1<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.1.5.11

<span class="c1"># 查看 VETH Pair 关系</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>clab-veth-demo-server1<span class="w"> </span>ethtool<span class="w"> </span>-S<span class="w"> </span>net0

<span class="c1"># 清理环境</span>
clab<span class="w"> </span>destroy<span class="w"> </span>-t<span class="w"> </span>veth-demo.yaml
</code></pre></div>
<hr />
<h3 id="37">3.7 常见问题与排障<a class="headerlink" href="#37" title="Permanent link">&para;</a></h3>
<h4 id="1ping">问题1：ping 自己不通<a class="headerlink" href="#1ping" title="Permanent link">&para;</a></h4>
<p><strong>现象</strong>：在命名空间内 ping 自己的 IP 地址不通</p>
<p><strong>原因</strong>：loopback 接口（lo）未启用</p>
<p><strong>解决</strong>：</p>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up
</code></pre></div>
<blockquote>
<p>[!TIP]
创建网络命名空间后，记得启用 lo 接口。虽然 ping 自己通常不经过 lo，但某些协议栈处理需要 lo 处于 UP 状态。</p>
</blockquote>
<h4 id="2-veth-pair">问题2：如何判断两个接口是否为 VETH Pair<a class="headerlink" href="#2-veth-pair" title="Permanent link">&para;</a></h4>
<p><strong>方法</strong>：使用 <code>ethtool -S</code> 查看 peer_ifindex</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 veth0 的 peer 接口索引</span>
ethtool<span class="w"> </span>-S<span class="w"> </span>veth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>peer_ifindex

<span class="c1"># 对比另一端的接口索引</span>
ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;12:&quot;</span><span class="w">  </span><span class="c1"># 假设 peer_ifindex 是 12</span>
</code></pre></div>
<h4 id="3-bridge">问题3：如何查看接口属于哪个 Bridge<a class="headerlink" href="#3-bridge" title="Permanent link">&para;</a></h4>
<p><strong>方法</strong>：查看接口的 <code>master</code> 属性</p>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>veth0

<span class="c1"># 输出中如果包含 master br0，说明该接口插在 br0 网桥上</span>
<span class="c1"># 例如：5: veth0@eth0: &lt;BROADCAST,MULTICAST,UP&gt; ... master br0 state UP</span>
</code></pre></div>
<hr />
<h3 id="_55">📝 章节小结<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>本章深入讲解了 VETH 虚拟网络设备：</p>
<ol>
<li><strong>VETH Pair 概念</strong>：成对出现的虚拟网卡，用于跨网络命名空间通信</li>
<li><strong>CNI 中的应用</strong>：所有主流 CNI 都使用 VETH 将 Pod 流量引入宿主机</li>
<li><strong>手工创建 VETH</strong>：掌握 <code>ip link add ... type veth peer name ...</code> 命令</li>
<li><strong>Linux Bridge</strong>：多个 VETH 可以插入同一个 Bridge，实现二层交换</li>
<li><strong>CNI 实现差异</strong>：</li>
<li>Flannel：VETH + Bridge，同节点走二层</li>
<li>Calico：VETH + Routing（/32 掩码），同节点也走三层</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>动手执行手工创建 VETH 的全部步骤</li>
<li>使用 Containerlab 快速搭建各种 VETH 拓扑</li>
<li>对比 Flannel 和 Calico 的 VETH 使用方式</li>
<li>理解 "VETH 是容器网络的基石" 这一核心概念</li>
</ol>
</blockquote>
<hr />
<h2 id="4-host-gateway">第4章 Host-Gateway 网络模式<a class="headerlink" href="#4-host-gateway" title="Permanent link">&para;</a></h2>
<h3 id="_56">🎯 学习目标<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 Host-Gateway（主机网关）模式的核心概念</li>
<li>掌握静态路由在容器网络中的应用</li>
<li>学会使用 Containerlab 模拟 Host-GW 网络</li>
<li>掌握手工配置 Host-GW 模式的完整步骤</li>
<li>理解 Host-GW 与 Overlay 网络的优劣对比</li>
</ul>
<hr />
<h3 id="41-host-gateway">4.1 Host-Gateway 概念与原理<a class="headerlink" href="#41-host-gateway" title="Permanent link">&para;</a></h3>
<h4 id="_57">背景<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h4>
<p>在容器网络中，Pod 需要与其他节点上的 Pod 通信。实现跨节点通信有两种主要方式：</p>
<ol>
<li><strong>Overlay 网络</strong>：将容器网络封装在底层网络之上（如 VxLAN、IPIP）</li>
<li><strong>Host-Gateway</strong>：利用主机的路由功能直接转发容器流量</li>
</ol>
<p><strong>Host-Gateway（主机网关）</strong>是最简单、性能最高的容器网络模式之一。</p>
<h4 id="_58">原理<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h4>
<p><strong>Host-Gateway</strong> 的核心思想：<strong>把宿主机当作 Pod 的网关</strong>。</p>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Node1[&quot;节点1 (192.168.2.71)&quot;]
        GW1[&quot;cni0 网桥&lt;br/&gt;10.244.1.1&quot;]
        P1[&quot;Pod1&lt;br/&gt;10.244.1.10&quot;]
        P1 --&gt;|&quot;默认网关&quot;| GW1
    end

    subgraph Node2[&quot;节点2 (192.168.2.73)&quot;]
        GW2[&quot;cni0 网桥&lt;br/&gt;10.244.2.1&quot;]
        P2[&quot;Pod2&lt;br/&gt;10.244.2.10&quot;]
        P2 --&gt;|&quot;默认网关&quot;| GW2
    end

    GW1 --&gt;|&quot;路由: 10.244.2.0/24 via 192.168.2.73&quot;| GW2
    GW2 --&gt;|&quot;路由: 10.244.1.0/24 via 192.168.2.71&quot;| GW1
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ol>
<li>Pod1 发送数据包到 Pod2（目的地址 10.244.2.10）</li>
<li>Pod1 的默认网关是 cni0 网桥（10.244.1.1）</li>
<li>节点1 查询路由表：去往 10.244.2.0/24 的下一跳是 192.168.2.73</li>
<li>数据包发送到节点2，节点2 将其转发给 Pod2</li>
</ol>
<p><strong>关键理解</strong>：</p>
<blockquote>
<p>[!NOTE]
<strong>Host-Gateway = 把主机当网关</strong></p>
<p>就像你家的无线路由器是你手机的网关一样，Pod 把宿主机当作自己的网关。所有出站流量都先发给宿主机，由宿主机负责路由转发。</p>
</blockquote>
<hr />
<h3 id="42-host-gw-overlay">4.2 Host-GW 与 Overlay 网络对比<a class="headerlink" href="#42-host-gw-overlay" title="Permanent link">&para;</a></h3>
<h4 id="_59">原理对比<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph HostGW[&quot;Host-Gateway 模式&quot;]
        H1[&quot;节点1&quot;] --&gt;|&quot;直接路由&lt;br/&gt;原始包&quot;| H2[&quot;节点2&quot;]
    end

    subgraph Overlay[&quot;Overlay 模式 (VxLAN)&quot;]
        O1[&quot;节点1&quot;] --&gt;|&quot;封装&lt;br/&gt;外层包+内层包&quot;| O2[&quot;节点2&quot;]
    end
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Host-Gateway</th>
<th style="text-align: left;">Overlay (VxLAN/IPIP)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>性能</strong></td>
<td style="text-align: left;">⭐⭐⭐⭐⭐ 最高</td>
<td style="text-align: left;">⭐⭐⭐ 有封装开销</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MTU</strong></td>
<td style="text-align: left;">无损耗（1500）</td>
<td style="text-align: left;">有损耗（1450左右）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>配置复杂度</strong></td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">中等</td>
</tr>
<tr>
<td style="text-align: left;"><strong>对底层网络要求</strong></td>
<td style="text-align: left;">节点必须二层可达</td>
<td style="text-align: left;">节点只需三层可达</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Pod IP 暴露</strong></td>
<td style="text-align: left;">暴露在物理网络</td>
<td style="text-align: left;">封装隐藏</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨子网</strong></td>
<td style="text-align: left;">❌ 不支持</td>
<td style="text-align: left;">✅ 支持</td>
</tr>
</tbody>
</table>
<h4 id="_60">适用场景<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">推荐模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">节点在同一二层网络</td>
<td style="text-align: left;"><strong>Host-Gateway</strong>（性能最优）</td>
</tr>
<tr>
<td style="text-align: left;">节点跨子网/跨机房</td>
<td style="text-align: left;"><strong>Overlay</strong>（必须封装）</td>
</tr>
<tr>
<td style="text-align: left;">对性能敏感的业务</td>
<td style="text-align: left;"><strong>Host-Gateway</strong></td>
</tr>
<tr>
<td style="text-align: left;">多云/混合云环境</td>
<td style="text-align: left;"><strong>Overlay</strong></td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>Host-GW 的限制</strong>：</p>
<p>节点之间必须<strong>二层可达</strong>（在同一个广播域）。如果节点跨子网，数据包无法直接路由，必须使用 Overlay 封装。</p>
</blockquote>
<hr />
<h3 id="43-containerlab-host-gw">4.3 使用 Containerlab 实现 Host-GW<a class="headerlink" href="#43-containerlab-host-gw" title="Permanent link">&para;</a></h3>
<h4 id="_61">背景<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h4>
<p>Containerlab 可以快速搭建包含路由器和主机的网络拓扑，非常适合理解 Host-GW 的工作原理。</p>
<h4 id="_62">网络拓扑设计<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Topology[&quot;Host-GW 实验拓扑&quot;]
        GW0[&quot;GW0 路由器&lt;br/&gt;10.1.5.1&quot;]
        GW1[&quot;GW1 路由器&lt;br/&gt;10.1.8.1&quot;]
        S1[&quot;Server1&lt;br/&gt;10.1.5.10&quot;]
        S2[&quot;Server2&lt;br/&gt;10.1.8.10&quot;]

        S1 --&gt;|&quot;网关&quot;| GW0
        S2 --&gt;|&quot;网关&quot;| GW1
        GW0 &lt;--&gt;|&quot;172.12.1.x&quot;| GW1
    end
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li>Server1 的网关是 GW0（10.1.5.1）</li>
<li>Server2 的网关是 GW1（10.1.8.1）</li>
<li>GW0 和 GW1 通过 172.12.1.x 互联</li>
<li>GW0 需要知道如何到达 10.1.8.0/24，GW1 需要知道如何到达 10.1.5.0/24</li>
</ul>
<h4 id="containerlab">Containerlab 配置文件<a class="headerlink" href="#containerlab" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host-gw-lab</span>
<span class="nt">topology</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodes</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 路由器 GW0</span>
<span class="w">    </span><span class="nt">gw0</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos/vyos:1.2.8</span>
<span class="w">      </span><span class="nt">startup-config</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gw0.cfg</span>

<span class="w">    </span><span class="c1"># 路由器 GW1  </span>
<span class="w">    </span><span class="nt">gw1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vyos/vyos:1.2.8</span>
<span class="w">      </span><span class="nt">startup-config</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gw1.cfg</span>

<span class="w">    </span><span class="c1"># 服务器 Server1</span>
<span class="w">    </span><span class="nt">server1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.5.10/24 dev net0</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip route add default via 10.1.5.1</span>

<span class="w">    </span><span class="c1"># 服务器 Server2</span>
<span class="w">    </span><span class="nt">server2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip addr add 10.1.8.10/24 dev net0</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip route add default via 10.1.8.1</span>

<span class="w">  </span><span class="nt">links</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Server1 连接 GW0</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;gw0:eth1&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server1:net0&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="c1"># Server2 连接 GW1</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;gw1:eth1&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;server2:net0&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="c1"># GW0 和 GW1 互联</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;gw0:eth2&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;gw1:eth2&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h4 id="gw0-gw0cfg">GW0 路由配置 (gw0.cfg)<a class="headerlink" href="#gw0-gw0cfg" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># 接口配置
set interfaces ethernet eth1 address 10.1.5.1/24
set interfaces ethernet eth2 address 172.12.1.10/24

# 静态路由：去往 10.1.8.0/24 的下一跳是 GW1
set protocols static route 10.1.8.0/24 next-hop 172.12.1.11
</code></pre></div>
<h4 id="gw1-gw1cfg">GW1 路由配置 (gw1.cfg)<a class="headerlink" href="#gw1-gw1cfg" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># 接口配置
set interfaces ethernet eth1 address 10.1.8.1/24
set interfaces ethernet eth2 address 172.12.1.11/24

# 静态路由：去往 10.1.5.0/24 的下一跳是 GW0
set protocols static route 10.1.5.0/24 next-hop 172.12.1.10
</code></pre></div>
<h4 id="_63">验证连通性<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 部署拓扑</span>
clab<span class="w"> </span>deploy<span class="w"> </span>-t<span class="w"> </span>host-gw-lab.yaml

<span class="c1"># 从 Server1 ping Server2</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>clab-host-gw-lab-server1<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.1.8.10

<span class="c1"># 观察 TTL 变化</span>
<span class="c1"># TTL = 62（经过两个路由器，从 64 减 2）</span>

<span class="c1"># 清理</span>
clab<span class="w"> </span>destroy<span class="w"> </span>-t<span class="w"> </span>host-gw-lab.yaml
</code></pre></div>
<hr />
<h3 id="44-host-gw">4.4 手工实现 Host-GW 模式<a class="headerlink" href="#44-host-gw" title="Permanent link">&para;</a></h3>
<h4 id="_64">背景<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h4>
<p>理解 Host-GW 最好的方式是手工实现一个完整的配置，模拟 Flannel 的 Host-GW 模式。</p>
<h4 id="_65">实验拓扑<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph BPF71[&quot;节点 192.168.2.71&quot;]
        BR0_1[&quot;br0 网桥&lt;br/&gt;10.1.5.1&quot;]
        NS1[&quot;ns1 命名空间&lt;br/&gt;10.1.5.10&quot;]
        NS1 --&gt; BR0_1
    end

    subgraph BPF73[&quot;节点 192.168.2.73&quot;]
        BR0_2[&quot;br0 网桥&lt;br/&gt;10.1.8.1&quot;]
        NS2[&quot;ns2 命名空间&lt;br/&gt;10.1.8.10&quot;]
        NS2 --&gt; BR0_2
    end

    BR0_1 &lt;--&gt;|&quot;路由&quot;| BR0_2
</code></pre></div>
<h4 id="1-192168271">实现步骤（节点1: 192.168.2.71）<a class="headerlink" href="#1-192168271" title="Permanent link">&para;</a></h4>
<h5 id="_66">步骤一：创建网络基础设施<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建网络命名空间（模拟 Pod）</span>
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>ns1

<span class="c1"># 创建 Linux Bridge（模拟 cni0 网桥）</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>br0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>bridge
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br0<span class="w"> </span>up

<span class="c1"># 创建 VETH Pair</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>int0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>br-int0
</code></pre></div>
<h5 id="_67">步骤二：配置命名空间内的网络<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 将 VETH 一端移入命名空间</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>int0<span class="w"> </span>netns<span class="w"> </span>ns1

<span class="c1"># 配置命名空间内的接口</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.5.10/24<span class="w"> </span>dev<span class="w"> </span>int0
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>int0<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up

<span class="c1"># 配置默认路由（指向网关）</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.5.1
</code></pre></div>
<h5 id="_68">步骤三：配置宿主机网桥<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 将 VETH 另一端插入网桥</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br-int0<span class="w"> </span>master<span class="w"> </span>br0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br-int0<span class="w"> </span>up

<span class="c1"># 给网桥配置 IP（作为 Pod 的网关）</span>
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.5.1/24<span class="w"> </span>dev<span class="w"> </span>br0
</code></pre></div>
<h5 id="_69">步骤四：添加跨节点路由<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># 添加静态路由：去往 10.1.8.0/24 的下一跳是节点2</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.8.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.2.73<span class="w"> </span>dev<span class="w"> </span>ens160
</code></pre></div>
<h4 id="2-192168273">实现步骤（节点2: 192.168.2.73）<a class="headerlink" href="#2-192168273" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建网络命名空间</span>
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>ns2

<span class="c1"># 创建网桥</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>br0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>bridge
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br0<span class="w"> </span>up

<span class="c1"># 创建 VETH Pair 并配置</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>int0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>br-int0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>int0<span class="w"> </span>netns<span class="w"> </span>ns2

<span class="c1"># 配置命名空间</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.8.10/24<span class="w"> </span>dev<span class="w"> </span>int0
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>int0<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns2<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.8.1

<span class="c1"># 配置网桥</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br-int0<span class="w"> </span>master<span class="w"> </span>br0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>br-int0<span class="w"> </span>up
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.8.1/24<span class="w"> </span>dev<span class="w"> </span>br0

<span class="c1"># 添加跨节点路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.5.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span>dev<span class="w"> </span>ens160
</code></pre></div>
<h4 id="_70">验证测试<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 从节点1的 ns1 ping 节点2的 ns2</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.1.8.10

<span class="c1"># 应该能够 ping 通，TTL = 62（经过两跳）</span>
</code></pre></div>
<h4 id="_71">查看路由表<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 节点1 路由表</span>
ip<span class="w"> </span>route<span class="w"> </span>show

<span class="c1"># 输出类似：</span>
<span class="c1"># 10.1.5.0/24 dev br0 proto kernel scope link src 10.1.5.1</span>
<span class="c1"># 10.1.8.0/24 via 192.168.2.73 dev ens160  # Host-GW 关键路由</span>
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li><code>10.1.8.0/24 via 192.168.2.73</code>：这就是 Host-GW 的核心路由</li>
<li>去往 Pod 网段（10.1.8.0/24）的流量，下一跳是对端节点（192.168.2.73）</li>
<li>这与 Flannel Host-GW 模式自动创建的路由完全一致</li>
</ul>
<hr />
<h3 id="45-host-gw-flannel">4.5 Host-GW 在 Flannel 中的实现<a class="headerlink" href="#45-host-gw-flannel" title="Permanent link">&para;</a></h3>
<h4 id="_72">背景<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h4>
<p>Flannel 是 Kubernetes 中最常用的 CNI 插件之一。它支持多种后端模式，其中 Host-GW 是性能最高的模式。</p>
<h4 id="flannel-host-gw">Flannel Host-GW 架构<a class="headerlink" href="#flannel-host-gw" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Node1[&quot;节点1&quot;]
        CNI0_1[&quot;cni0&lt;br/&gt;10.244.1.1/24&quot;]
        FLANNELD1[&quot;flanneld&quot;]
        P1[&quot;Pod&lt;br/&gt;10.244.1.x&quot;]
        P1 --&gt; CNI0_1
        FLANNELD1 -.-&gt;|&quot;监听 etcd&lt;br/&gt;更新路由&quot;| CNI0_1
    end

    subgraph Node2[&quot;节点2&quot;]
        CNI0_2[&quot;cni0&lt;br/&gt;10.244.2.1/24&quot;]
        FLANNELD2[&quot;flanneld&quot;]
        P2[&quot;Pod&lt;br/&gt;10.244.2.x&quot;]
        P2 --&gt; CNI0_2
        FLANNELD2 -.-&gt;|&quot;监听 etcd&lt;br/&gt;更新路由&quot;| CNI0_2
    end

    FLANNELD1 &lt;--&gt;|&quot;etcd 同步&quot;| FLANNELD2
    CNI0_1 &lt;--&gt;|&quot;静态路由&quot;| CNI0_2
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ol>
<li><strong>flanneld</strong> 进程监听 etcd 中的网络配置</li>
<li>当新节点加入或 Pod 网段变化时，flanneld 自动更新路由表</li>
<li>每个节点的路由表包含所有其他节点的 Pod 网段路由</li>
</ol>
<h4 id="flannel-host-gw_1">Flannel Host-GW 配置<a class="headerlink" href="#flannel-host-gw_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;Network&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10.244.0.0/16&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Backend&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;host-gw&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="flannel">查看 Flannel 创建的路由<a class="headerlink" href="#flannel" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Kubernetes 节点上查看路由表</span>
ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">10</span>.244

<span class="c1"># 输出示例（假设有三个节点）：</span>
<span class="c1"># 10.244.0.0/24 via 192.168.1.10 dev eth0  # 节点1 的 Pod 网段</span>
<span class="c1"># 10.244.1.0/24 dev cni0 proto kernel scope link src 10.244.1.1  # 本节点</span>
<span class="c1"># 10.244.2.0/24 via 192.168.1.12 dev eth0  # 节点3 的 Pod 网段</span>
</code></pre></div>
<p><strong>要点解读</strong>：</p>
<blockquote>
<p>[!IMPORTANT]
<strong>Flannel Host-GW 的路由特征</strong>：</p>
<ul>
<li>本节点的 Pod 网段：<code>dev cni0</code>（直连）</li>
<li>其他节点的 Pod 网段：<code>via &lt;节点IP&gt;</code>（通过节点路由）</li>
<li>flanneld 自动维护这些路由，无需手工配置</li>
</ul>
</blockquote>
<hr />
<h3 id="46-next-hop">4.6 Next Hop 的核心作用<a class="headerlink" href="#46-next-hop" title="Permanent link">&para;</a></h3>
<h4 id="_73">背景<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h4>
<p>在 Host-GW 模式中，<strong>Next Hop（下一跳）</strong>是最关键的概念。理解 Next Hop 对于排障和网络设计至关重要。</p>
<h4 id="_74">原理<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1&lt;br/&gt;10.244.1.10
    participant Node1 as 节点1&lt;br/&gt;192.168.2.71
    participant Node2 as 节点2&lt;br/&gt;192.168.2.73
    participant Pod2 as Pod2&lt;br/&gt;10.244.2.10

    Pod1-&gt;&gt;Node1: 目的: 10.244.2.10&lt;br/&gt;下一跳: 10.244.1.1 (网关)
    Note over Node1: 查路由表:&lt;br/&gt;10.244.2.0/24 via 192.168.2.73
    Node1-&gt;&gt;Node2: 目的: 10.244.2.10&lt;br/&gt;下一跳: 192.168.2.73
    Note over Node2: 查路由表:&lt;br/&gt;10.244.2.0/24 dev cni0
    Node2-&gt;&gt;Pod2: 目的: 10.244.2.10&lt;br/&gt;直接投递
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ol>
<li><strong>Pod1 → Node1</strong>：Pod1 把所有出站流量发给默认网关</li>
<li><strong>Node1 查路由表</strong>：发现去往 10.244.2.0/24 的下一跳是 192.168.2.73</li>
<li><strong>Node1 → Node2</strong>：数据包发送到 Node2</li>
<li><strong>Node2 → Pod2</strong>：Node2 发现目的地址在本地 cni0，直接投递</li>
</ol>
<h4 id="_75">关键点<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">概念</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>默认网关</strong></td>
<td style="text-align: left;">Pod 的"下一跳"，通常是 cni0 网桥</td>
</tr>
<tr>
<td style="text-align: left;"><strong>静态路由</strong></td>
<td style="text-align: left;">节点路由表中的跨节点路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Next Hop</strong></td>
<td style="text-align: left;">静态路由指定的下一跳地址</td>
</tr>
<tr>
<td style="text-align: left;"><strong>出接口</strong></td>
<td style="text-align: left;">发送数据包的网卡接口</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1"># 完整的路由条目格式</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.244.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.2.73<span class="w"> </span>dev<span class="w"> </span>eth0
<span class="c1">#           ↑目的网段        ↑下一跳地址     ↑出接口</span>
</code></pre></div>
<blockquote>
<p>[!CAUTION]
<strong>Next Hop 必须可达</strong>：</p>
<p>如果 Next Hop 地址不可达（如跨子网），Host-GW 模式将无法工作。此时必须使用 Overlay 模式。</p>
</blockquote>
<hr />
<h3 id="47">4.7 常见问题与排障<a class="headerlink" href="#47" title="Permanent link">&para;</a></h3>
<h4 id="1-pod">问题1：跨节点 Pod 通信失败<a class="headerlink" href="#1-pod" title="Permanent link">&para;</a></h4>
<p><strong>检查步骤</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 检查路由表是否正确</span>
ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">10</span>.244

<span class="c1"># 2. 检查下一跳是否可达</span>
ping<span class="w"> </span>&lt;下一跳IP&gt;

<span class="c1"># 3. 检查是否开启 IP 转发</span>
cat<span class="w"> </span>/proc/sys/net/ipv4/ip_forward
<span class="c1"># 如果是 0，需要开启：</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/net/ipv4/ip_forward
</code></pre></div>
<h4 id="2host-gw">问题2：Host-GW 模式下节点跨子网<a class="headerlink" href="#2host-gw" title="Permanent link">&para;</a></h4>
<p><strong>现象</strong>：节点在不同子网，Host-GW 无法工作</p>
<p><strong>原因</strong>：Next Hop 不可达，ARP 无法解析</p>
<p><strong>解决方案</strong>：改用 Overlay 模式（VxLAN 或 IPIP）</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;Network&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10.244.0.0/16&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Backend&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vxlan&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="3">问题3：路由条目丢失<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<p><strong>现象</strong>：flanneld 重启后路由丢失</p>
<p><strong>检查</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 flanneld 是否正常运行</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kube-flannel

<span class="c1"># 查看 flanneld 日志</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>kube-flannel<span class="w"> </span>&lt;flannel-pod-name&gt;
</code></pre></div>
<hr />
<h3 id="_76">📝 章节小结<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>本章深入讲解了 Host-Gateway 网络模式：</p>
<ol>
<li><strong>核心概念</strong>：把宿主机当作 Pod 的网关，利用路由转发容器流量</li>
<li><strong>工作原理</strong>：Pod → 默认网关 → 查路由表 → 下一跳 → 目标节点</li>
<li><strong>优势</strong>：性能最高、配置简单、无封装开销</li>
<li><strong>限制</strong>：节点必须二层可达（同一广播域）</li>
<li><strong>实现方式</strong>：</li>
<li>Flannel Host-GW 模式</li>
<li>Calico BGP 模式（类似原理）</li>
<li>手工静态路由配置</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>使用 Containerlab 搭建 Host-GW 实验环境</li>
<li>手工配置一次完整的 Host-GW 网络</li>
<li>在真实 Kubernetes 集群中查看 Flannel 路由表</li>
<li>理解 "Next Hop 必须可达" 这一核心约束</li>
</ol>
<p>[!IMPORTANT]
<strong>选择 Host-GW 还是 Overlay？</strong></p>
<ul>
<li><strong>同一二层网络</strong> → 优先选择 <strong>Host-GW</strong>（性能更好）</li>
<li><strong>跨子网/跨机房</strong> → 必须使用 <strong>Overlay</strong>（VxLAN/IPIP）</li>
<li><strong>混合场景</strong> → 可以使用 Calico 的 <strong>ipip: CrossSubnet</strong> 模式</li>
</ul>
</blockquote>
<hr />
<h2 id="5-cni">第5章 CNI 网络模型<a class="headerlink" href="#5-cni" title="Permanent link">&para;</a></h2>
<h3 id="_77">🎯 学习目标<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 CNI 网络的四大分类：Overlay、Underlay、Routing、高性能</li>
<li>掌握 Pod 数据包在宿主机上的转发路径</li>
<li>理解网卡复用技术（IPVLAN、MACVLAN）的原理与应用</li>
<li>了解高性能网络（SR-IOV、DPDK、VPP）的核心概念</li>
<li>掌握 Cilium eBPF 的优化原理</li>
</ul>
<hr />
<h3 id="51-cni">5.1 CNI 网络模型概述<a class="headerlink" href="#51-cni" title="Permanent link">&para;</a></h3>
<h4 id="_78">背景<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h4>
<p>在 Kubernetes 中，CNI（Container Network Interface）负责为 Pod 配置网络。不同的 CNI 插件采用不同的网络模型，各有优劣。</p>
<h4 id="_79">四大网络模型<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    CNI[&quot;CNI 网络模型&quot;] --&gt; Overlay[&quot;Overlay 网络&lt;br/&gt;叠加网络&quot;]
    CNI --&gt; Underlay[&quot;Underlay 网络&lt;br/&gt;底层网络&quot;]
    CNI --&gt; Routing[&quot;Routing 网络&lt;br/&gt;路由网络&quot;]
    CNI --&gt; HighPerf[&quot;高性能网络&lt;br/&gt;内核 Bypass&quot;]

    Overlay --&gt; VxLAN[&quot;VxLAN&quot;]
    Overlay --&gt; IPIP[&quot;IPIP&quot;]
    Overlay --&gt; GRE[&quot;GRE&quot;]

    Underlay --&gt; IPVLAN[&quot;IPVLAN&quot;]
    Underlay --&gt; MACVLAN[&quot;MACVLAN&quot;]

    Routing --&gt; HostGW[&quot;Host-GW&quot;]
    Routing --&gt; BGP[&quot;BGP&quot;]

    HighPerf --&gt; SRIOV[&quot;SR-IOV&quot;]
    HighPerf --&gt; DPDK[&quot;DPDK&quot;]
    HighPerf --&gt; eBPF[&quot;eBPF&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">核心原理</th>
<th style="text-align: left;">代表性 CNI/技术</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Overlay</strong></td>
<td style="text-align: left;">封装隧道，Pod IP 隐藏</td>
<td style="text-align: left;">Flannel VxLAN、Calico IPIP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Underlay</strong></td>
<td style="text-align: left;">网卡复用，Pod 与宿主机同平面</td>
<td style="text-align: left;">IPVLAN、MACVLAN</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Routing</strong></td>
<td style="text-align: left;">路由转发，Pod IP 暴露</td>
<td style="text-align: left;">Host-GW、Calico BGP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>高性能</strong></td>
<td style="text-align: left;">绕过内核协议栈</td>
<td style="text-align: left;">SR-IOV、DPDK、Cilium eBPF</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="52-pod">5.2 Pod 数据包转发路径<a class="headerlink" href="#52-pod" title="Permanent link">&para;</a></h3>
<h4 id="_80">背景<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h4>
<p>理解 Pod 数据包在宿主机上的转发路径，是掌握 CNI 网络模型的关键。</p>
<h4 id="_81">原理<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Pod[&quot;Pod 网络命名空间&quot;]
        APP[&quot;应用进程&quot;]
        STACK1[&quot;协议栈处理&lt;br/&gt;TCP/IP&quot;]
        ETH0[&quot;eth0 (VETH)&quot;]
        APP --&gt; STACK1 --&gt; ETH0
    end

    subgraph Host[&quot;宿主机 Root Namespace&quot;]
        VETH[&quot;veth-xxx&quot;]
        BRIDGE[&quot;cni0 网桥&quot;]
        STACK2[&quot;协议栈处理&lt;br/&gt;iptables/路由&quot;]
        PHYS[&quot;物理网卡 eth0&quot;]
        VETH --&gt; BRIDGE --&gt; STACK2 --&gt; PHYS
    end

    ETH0 ---|&quot;VETH Pair&quot;| VETH
    PHYS --&gt; EXT[&quot;外部网络&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ol>
<li><strong>Pod 内部协议栈</strong>：应用发送数据包，经过 Pod 自己的 TCP/IP 协议栈</li>
<li><strong>VETH Pair 传输</strong>：数据包通过 VETH Pair 传到宿主机</li>
<li><strong>宿主机协议栈</strong>：再次经过宿主机的协议栈（iptables、路由查询等）</li>
<li><strong>物理网卡发出</strong>：最终从物理网卡发送到外部网络</li>
</ol>
<blockquote>
<p>[!IMPORTANT]
<strong>关键理解</strong>：Pod 发送一个数据包，需要经过<strong>两次协议栈处理</strong>：</p>
<ol>
<li>Pod 自己的协议栈（一次）</li>
<li>宿主机的协议栈（一次）</li>
</ol>
<p>这是容器网络相比传统网络有性能损耗的主要原因。</p>
</blockquote>
<hr />
<h3 id="53-overlay">5.3 Overlay 叠加网络<a class="headerlink" href="#53-overlay" title="Permanent link">&para;</a></h3>
<h4 id="_82">背景<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h4>
<p>Overlay 网络通过<strong>隧道封装</strong>技术，将 Pod 网络"叠加"在物理网络之上，使 Pod IP 对外部网络不可见。</p>
<h4 id="_83">原理<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Node1[&quot;节点1&quot;]
        P1[&quot;Pod1&lt;br/&gt;10.244.1.10&quot;]
        FLANNEL1[&quot;flannel.1&lt;br/&gt;VxLAN 封装&quot;]
    end

    subgraph Node2[&quot;节点2&quot;]
        P2[&quot;Pod2&lt;br/&gt;10.244.2.10&quot;]
        FLANNEL2[&quot;flannel.1&lt;br/&gt;VxLAN 解封装&quot;]
    end

    P1 --&gt; FLANNEL1
    FLANNEL1 --&gt;|&quot;外层: Node1 IP → Node2 IP&lt;br/&gt;内层: Pod1 IP → Pod2 IP&quot;| FLANNEL2
    FLANNEL2 --&gt; P2
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>封装方式</strong></td>
<td style="text-align: left;">VxLAN、IPIP、GRE、Geneve</td>
</tr>
<tr>
<td style="text-align: left;"><strong>外层报头</strong></td>
<td style="text-align: left;">宿主机 IP（物理网络可路由）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>内层报头</strong></td>
<td style="text-align: left;">Pod IP（物理网络不可见）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>优点</strong></td>
<td style="text-align: left;">跨子网、跨机房通信</td>
</tr>
<tr>
<td style="text-align: left;"><strong>缺点</strong></td>
<td style="text-align: left;">有封装开销、MTU 损耗</td>
</tr>
</tbody>
</table>
<h4 id="overlay">常见 Overlay 协议对比<a class="headerlink" href="#overlay" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">协议</th>
<th style="text-align: left;">封装开销</th>
<th style="text-align: left;">特点</th>
<th style="text-align: left;">使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>VxLAN</strong></td>
<td style="text-align: left;">50 字节</td>
<td style="text-align: left;">基于 UDP，成熟稳定</td>
<td style="text-align: left;">Flannel、Calico</td>
</tr>
<tr>
<td style="text-align: left;"><strong>IPIP</strong></td>
<td style="text-align: left;">20 字节</td>
<td style="text-align: left;">封装最小，性能较好</td>
<td style="text-align: left;">Calico</td>
</tr>
<tr>
<td style="text-align: left;"><strong>GRE</strong></td>
<td style="text-align: left;">24+ 字节</td>
<td style="text-align: left;">支持多协议</td>
<td style="text-align: left;">较少使用</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Geneve</strong></td>
<td style="text-align: left;">可变</td>
<td style="text-align: left;">可扩展，未来趋势</td>
<td style="text-align: left;">OVN</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>MTU 问题</strong>：Overlay 封装会增加报头大小，需要调整 Pod 网络的 MTU。</p>
<ul>
<li>VxLAN：MTU = 1450（1500 - 50）</li>
<li>IPIP：MTU = 1480（1500 - 20）</li>
</ul>
</blockquote>
<hr />
<h3 id="54-underlay">5.4 Underlay 底层网络<a class="headerlink" href="#54-underlay" title="Permanent link">&para;</a></h3>
<h4 id="_84">背景<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h4>
<p>Underlay 网络通过<strong>网卡复用</strong>技术，让 Pod 网络与宿主机网络处于同一平面，减少协议栈处理次数。</p>
<h4 id="_85">原理<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Host[&quot;宿主机&quot;]
        PHYS[&quot;物理网卡 eth0&lt;br/&gt;192.168.1.10&quot;]

        subgraph IPVLAN[&quot;IPVLAN 子接口&quot;]
            IPV1[&quot;ipvlan0&lt;br/&gt;192.168.1.11&quot;]
            IPV2[&quot;ipvlan1&lt;br/&gt;192.168.1.12&quot;]
        end

        PHYS --&gt; IPV1
        PHYS --&gt; IPV2
    end

    subgraph Pod1[&quot;Pod1&quot;]
        E1[&quot;eth0&quot;]
    end

    subgraph Pod2[&quot;Pod2&quot;]
        E2[&quot;eth0&quot;]
    end

    IPV1 --&gt; E1
    IPV2 --&gt; E2
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li>物理网卡通过 IPVLAN/MACVLAN 技术创建多个子接口</li>
<li>每个子接口分配给一个 Pod</li>
<li>Pod 的 IP 地址与宿主机在同一网段</li>
<li><strong>绕过了 Pod 内部的协议栈处理</strong></li>
</ul>
<h4 id="ipvlan-vs-macvlan">IPVLAN vs MACVLAN<a class="headerlink" href="#ipvlan-vs-macvlan" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">IPVLAN</th>
<th style="text-align: left;">MACVLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>MAC 地址</strong></td>
<td style="text-align: left;">子接口与父接口 MAC <strong>相同</strong></td>
<td style="text-align: left;">子接口有<strong>独立</strong> MAC</td>
</tr>
<tr>
<td style="text-align: left;"><strong>IP 地址</strong></td>
<td style="text-align: left;">子接口有独立 IP</td>
<td style="text-align: left;">子接口有独立 IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>二层通信</strong></td>
<td style="text-align: left;">不支持（需要三层）</td>
<td style="text-align: left;">支持</td>
</tr>
<tr>
<td style="text-align: left;"><strong>适用场景</strong></td>
<td style="text-align: left;">IaaS 虚拟化环境</td>
<td style="text-align: left;">裸机 K8s 环境</td>
</tr>
<tr>
<td style="text-align: left;"><strong>内核版本</strong></td>
<td style="text-align: left;">4.2+ 稳定</td>
<td style="text-align: left;">3.x 即可</td>
</tr>
</tbody>
</table>
<h4 id="_86">适用场景<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">推荐技术</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">OpenStack + K8s 环境</td>
<td style="text-align: left;"><strong>IPVLAN</strong></td>
</tr>
<tr>
<td style="text-align: left;">裸机 K8s 环境</td>
<td style="text-align: left;"><strong>MACVLAN</strong></td>
</tr>
<tr>
<td style="text-align: left;">高吞吐量需求</td>
<td style="text-align: left;">IPVLAN/MACVLAN（多网卡）</td>
</tr>
<tr>
<td style="text-align: left;">传统 Service 场景</td>
<td style="text-align: left;">不推荐（使用 Overlay/Routing）</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>多网卡架构</strong>：在实际生产中，Pod 通常有多张网卡：</p>
<ul>
<li><strong>默认 CNI 网卡</strong>：用于 Service 发现、K8s 网络</li>
<li><strong>IPVLAN/MACVLAN 网卡</strong>：用于高速数据通信</li>
</ul>
</blockquote>
<hr />
<h3 id="55-routing">5.5 Routing 路由网络<a class="headerlink" href="#55-routing" title="Permanent link">&para;</a></h3>
<h4 id="_87">背景<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h4>
<p>Routing 网络模式通过<strong>路由协议</strong>直接转发 Pod 流量，Pod IP 完全暴露在物理网络中。</p>
<h4 id="_88">原理<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Node1[&quot;节点1&lt;br/&gt;192.168.1.10&quot;]
        P1[&quot;Pod&lt;br/&gt;10.244.1.10&quot;]
        RT1[&quot;路由表&quot;]
    end

    subgraph Node2[&quot;节点2&lt;br/&gt;192.168.1.11&quot;]
        P2[&quot;Pod&lt;br/&gt;10.244.2.10&quot;]
        RT2[&quot;路由表&quot;]
    end

    subgraph Switch[&quot;物理交换机/路由器&quot;]
        RT3[&quot;路由表&quot;]
    end

    P1 --&gt; RT1
    RT1 --&gt;|&quot;10.244.2.0/24 via 192.168.1.11&quot;| Switch
    Switch --&gt;|&quot;10.244.2.0/24 via 192.168.1.11&quot;| RT2
    RT2 --&gt; P2
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">路由来源</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Host-GW</strong></td>
<td style="text-align: left;">静态路由（flanneld 维护）</td>
<td style="text-align: left;">同二层网络</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BGP</strong></td>
<td style="text-align: left;">动态路由（BGP 协议）</td>
<td style="text-align: left;">跨子网、大规模集群</td>
</tr>
</tbody>
</table>
<h4 id="host-gw-vs-bgp">Host-GW vs BGP<a class="headerlink" href="#host-gw-vs-bgp" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Host-GW</th>
<th style="text-align: left;">BGP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>路由协议</strong></td>
<td style="text-align: left;">静态路由</td>
<td style="text-align: left;">BGP 动态路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨子网</strong></td>
<td style="text-align: left;">❌ 不支持</td>
<td style="text-align: left;">✅ 支持</td>
</tr>
<tr>
<td style="text-align: left;"><strong>外部集成</strong></td>
<td style="text-align: left;">不需要</td>
<td style="text-align: left;">需要与 ToR 交换机对接</td>
</tr>
<tr>
<td style="text-align: left;"><strong>复杂度</strong></td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">较复杂</td>
</tr>
<tr>
<td style="text-align: left;"><strong>代表 CNI</strong></td>
<td style="text-align: left;">Flannel Host-GW</td>
<td style="text-align: left;">Calico BGP</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>BGP 的核心价值</strong>：</p>
<ol>
<li>可以将 Pod IP 发布到物理网络</li>
<li>外部设备可以直接访问 Pod IP（无需 NodePort/LoadBalancer）</li>
<li>支持 Service ClusterIP 的外部发布（Calico 特性）</li>
</ol>
</blockquote>
<hr />
<h3 id="56">5.6 高性能网络<a class="headerlink" href="#56" title="Permanent link">&para;</a></h3>
<h4 id="_89">背景<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h4>
<p>对于延迟敏感、高吞吐量的应用（如电信、视频流、金融交易），传统的内核协议栈处理已成为瓶颈。高性能网络技术通过<strong>绕过内核协议栈</strong>来实现极致性能。</p>
<h4 id="_90">技术分类<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    HP[&quot;高性能网络技术&quot;] --&gt; SRIOV[&quot;SR-IOV&lt;br/&gt;网卡直通&quot;]
    HP --&gt; DPDK[&quot;DPDK&lt;br/&gt;用户态协议栈&quot;]
    HP --&gt; eBPF[&quot;eBPF&lt;br/&gt;内核优化&quot;]

    SRIOV --&gt; VF[&quot;VF 虚拟网卡&lt;br/&gt;直接分配给 Pod&quot;]
    DPDK --&gt; VPP[&quot;VPP 用户态转发&quot;]
    eBPF --&gt; CILIUM[&quot;Cilium&lt;br/&gt;bpf_redirect&quot;]
</code></pre></div>
<h4 id="sr-iov">SR-IOV（网卡直通）<a class="headerlink" href="#sr-iov" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Host[&quot;宿主机&quot;]
        PF[&quot;物理网卡 PF&lt;br/&gt;e.g. Intel X710&quot;]
        VF0[&quot;VF0&quot;]
        VF1[&quot;VF1&quot;]
        VF2[&quot;VF2&quot;]

        PF --&gt; VF0
        PF --&gt; VF1
        PF --&gt; VF2
    end

    VF0 --&gt;|&quot;直通&quot;| Pod1[&quot;Pod1&quot;]
    VF1 --&gt;|&quot;直通&quot;| Pod2[&quot;Pod2&quot;]
</code></pre></div>
<p><strong>要点解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">概念</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>PF</strong></td>
<td style="text-align: left;">Physical Function，物理网卡</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VF</strong></td>
<td style="text-align: left;">Virtual Function，虚拟子网卡</td>
</tr>
<tr>
<td style="text-align: left;"><strong>直通</strong></td>
<td style="text-align: left;">VF 直接分配给 Pod，绕过宿主机协议栈</td>
</tr>
<tr>
<td style="text-align: left;"><strong>硬件要求</strong></td>
<td style="text-align: left;">需要支持 SR-IOV 的网卡（Intel、Mellanox）</td>
</tr>
</tbody>
</table>
<h4 id="dpdk-vpp">DPDK + VPP（用户态协议栈）<a class="headerlink" href="#dpdk-vpp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Traditional[&quot;传统模式&quot;]
        A1[&quot;应用&quot;] --&gt; K1[&quot;内核协议栈&quot;] --&gt; N1[&quot;网卡驱动&quot;] --&gt; HW1[&quot;网卡&quot;]
    end

    subgraph DPDK[&quot;DPDK 模式&quot;]
        A2[&quot;应用&quot;] --&gt; VPP[&quot;VPP 用户态协议栈&quot;] --&gt; PMD[&quot;PMD 轮询驱动&quot;] --&gt; HW2[&quot;网卡&quot;]
    end
</code></pre></div>
<p><strong>要点解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">技术</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>DPDK</strong></td>
<td style="text-align: left;">Data Plane Development Kit，Intel 开源的高速数据包处理框架</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VPP</strong></td>
<td style="text-align: left;">Vector Packet Processing，Cisco 开源的用户态协议栈</td>
</tr>
<tr>
<td style="text-align: left;"><strong>PMD</strong></td>
<td style="text-align: left;">Poll Mode Driver，轮询模式驱动，避免中断开销</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能</strong></td>
<td style="text-align: left;">可达<strong>千万级 PPS</strong>，远超内核协议栈</td>
</tr>
</tbody>
</table>
<h4 id="cilium-ebpf">Cilium eBPF 优化<a class="headerlink" href="#cilium-ebpf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Traditional[&quot;传统模式&quot;]
        P1_T[&quot;Pod1 协议栈&quot;] --&gt; V1_T[&quot;veth1&quot;] --&gt; HOST_T[&quot;宿主机协议栈&lt;br/&gt;iptables/路由&quot;] --&gt; V2_T[&quot;veth2&quot;] --&gt; P2_T[&quot;Pod2 协议栈&quot;]
    end

    subgraph eBPF[&quot;Cilium eBPF Host Routing&quot;]
        P1_E[&quot;Pod1 协议栈&quot;] --&gt; V1_E[&quot;veth1&lt;br/&gt;TC hook&quot;]
        V1_E --&gt;|&quot;bpf_redirect_peer&quot;| V2_E[&quot;veth2&quot;]
        V2_E --&gt; P2_E[&quot;Pod2 协议栈&quot;]
    end
</code></pre></div>
<p><strong>要点解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">作用</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>bpf_redirect_peer</strong></td>
<td style="text-align: left;">同节点 Pod 间数据包重定向</td>
<td style="text-align: left;">Pod ↔ Pod（同节点）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>bpf_redirect_neigh</strong></td>
<td style="text-align: left;">跨节点数据包直接发往物理网卡</td>
<td style="text-align: left;">Pod → 外部网络</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>Cilium eBPF Host Routing 的效果</strong>：</p>
<ul>
<li>同节点 Pod 通信：绕过宿主机协议栈和 iptables</li>
<li>抓包现象：在 veth 上只能看到单向流量（因为数据包被 redirect 了）</li>
</ul>
</blockquote>
<hr />
<h3 id="57-cni">5.7 CNI 模式对比与选型<a class="headerlink" href="#57-cni" title="Permanent link">&para;</a></h3>
<h4 id="_91">综合对比<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Overlay</th>
<th style="text-align: left;">Underlay</th>
<th style="text-align: left;">Routing</th>
<th style="text-align: left;">高性能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>性能</strong></td>
<td style="text-align: left;">⭐⭐⭐</td>
<td style="text-align: left;">⭐⭐⭐⭐</td>
<td style="text-align: left;">⭐⭐⭐⭐</td>
<td style="text-align: left;">⭐⭐⭐⭐⭐</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨子网</strong></td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">部分支持</td>
<td style="text-align: left;">取决于具体技术</td>
</tr>
<tr>
<td style="text-align: left;"><strong>配置复杂度</strong></td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">中等</td>
<td style="text-align: left;">中等</td>
<td style="text-align: left;">复杂</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Pod IP 可见性</strong></td>
<td style="text-align: left;">隐藏</td>
<td style="text-align: left;">暴露</td>
<td style="text-align: left;">暴露</td>
<td style="text-align: left;">暴露</td>
</tr>
<tr>
<td style="text-align: left;"><strong>硬件要求</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">SR-IOV 需要特定网卡</td>
</tr>
</tbody>
</table>
<h4 id="_92">选型建议<a class="headerlink" href="#_92" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    START[&quot;CNI 选型&quot;] --&gt; Q1{&quot;节点跨子网？&quot;}
    Q1 --&gt;|&quot;是&quot;| Q2{&quot;需要高性能？&quot;}
    Q1 --&gt;|&quot;否&quot;| Q3{&quot;需要 NetworkPolicy？&quot;}

    Q2 --&gt;|&quot;是&quot;| BGP[&quot;Calico BGP + IPIP CrossSubnet&quot;]
    Q2 --&gt;|&quot;否&quot;| OVERLAY[&quot;Flannel VxLAN / Calico IPIP&quot;]

    Q3 --&gt;|&quot;是&quot;| Q4{&quot;需要最高性能？&quot;}
    Q3 --&gt;|&quot;否&quot;| HOSTGW[&quot;Flannel Host-GW&quot;]

    Q4 --&gt;|&quot;是&quot;| CILIUM[&quot;Cilium eBPF&quot;]
    Q4 --&gt;|&quot;否&quot;| CALICO[&quot;Calico BGP&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">推荐 CNI</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">小型集群、测试环境</td>
<td style="text-align: left;"><strong>Flannel Host-GW</strong></td>
</tr>
<tr>
<td style="text-align: left;">需要 NetworkPolicy</td>
<td style="text-align: left;"><strong>Calico</strong> 或 <strong>Cilium</strong></td>
</tr>
<tr>
<td style="text-align: left;">跨子网、大规模集群</td>
<td style="text-align: left;"><strong>Calico BGP</strong></td>
</tr>
<tr>
<td style="text-align: left;">追求极致性能</td>
<td style="text-align: left;"><strong>Cilium eBPF Host Routing</strong></td>
</tr>
<tr>
<td style="text-align: left;">电信/视频流/高频交易</td>
<td style="text-align: left;"><strong>SR-IOV + DPDK</strong></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_93">📝 章节小结<a class="headerlink" href="#_93" title="Permanent link">&para;</a></h3>
<p>本章系统讲解了 CNI 网络模型：</p>
<ol>
<li><strong>四大网络类型</strong>：</li>
<li><strong>Overlay</strong>：封装隧道（VxLAN、IPIP），跨子网通信</li>
<li><strong>Underlay</strong>：网卡复用（IPVLAN、MACVLAN），同平面通信</li>
<li><strong>Routing</strong>：路由转发（Host-GW、BGP），Pod IP 暴露</li>
<li>
<p><strong>高性能</strong>：绕过内核（SR-IOV、DPDK、eBPF）</p>
</li>
<li>
<p><strong>数据包路径</strong>：Pod 发包需经过两次协议栈处理（Pod + 宿主机）</p>
</li>
<li>
<p><strong>关键技术</strong>：</p>
</li>
<li>VxLAN/IPIP 的封装原理</li>
<li>IPVLAN/MACVLAN 的网卡复用</li>
<li>SR-IOV 的网卡直通</li>
<li>
<p>Cilium eBPF 的 bpf_redirect 优化</p>
</li>
<li>
<p><strong>选型关键点</strong>：</p>
</li>
<li>跨子网 → Overlay 或 BGP</li>
<li>同二层 → Host-GW（最简单高效）</li>
<li>需要 NetworkPolicy → Calico 或 Cilium</li>
<li>极致性能 → SR-IOV + DPDK 或 Cilium eBPF</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>理解"两次协议栈处理"是容器网络性能损耗的根源</li>
<li>根据业务场景选择合适的网络模型</li>
<li>关注 eBPF 技术的发展趋势</li>
<li>高性能场景需要了解 SR-IOV、DPDK 的基本原理</li>
</ol>
</blockquote>
<hr />
<h2 id="6-cni">第6章 CNI 工作原理<a class="headerlink" href="#6-cni" title="Permanent link">&para;</a></h2>
<h3 id="_94">🎯 学习目标<a class="headerlink" href="#_94" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 CNI 的插件分类：Main、IPAM、Meta</li>
<li>掌握 CNI 的两大核心目录结构</li>
<li>理解 CNI 配置文件的格式与字段含义</li>
<li>掌握 IPAM（IP 地址管理）的工作机制</li>
<li>了解多网卡方案（Multus、Network Attachment Definition）</li>
</ul>
<hr />
<h3 id="61-cni">6.1 CNI 概述<a class="headerlink" href="#61-cni" title="Permanent link">&para;</a></h3>
<h4 id="_95">背景<a class="headerlink" href="#_95" title="Permanent link">&para;</a></h4>
<p>CNI（Container Network Interface）是 Kubernetes 网络的标准接口规范。它定义了容器运行时如何调用网络插件来配置 Pod 的网络。</p>
<h4 id="_96">原理<a class="headerlink" href="#_96" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    KUBELET[&quot;kubelet&quot;] --&gt;|&quot;创建 Pod&quot;| CRI[&quot;容器运行时&lt;br/&gt;containerd/CRI-O&quot;]
    CRI --&gt;|&quot;调用 CNI 插件&quot;| CNI[&quot;CNI 插件&quot;]
    CNI --&gt;|&quot;读取配置&quot;| CONF[&quot;/etc/cni/net.d/&quot;]
    CNI --&gt;|&quot;执行二进制&quot;| BIN[&quot;/opt/cni/bin/&quot;]
    CNI --&gt;|&quot;配置网络&quot;| POD[&quot;Pod 网络&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ol>
<li>kubelet 调用容器运行时创建 Pod</li>
<li>容器运行时调用 CNI 插件配置网络</li>
<li>CNI 插件读取 <code>/etc/cni/net.d/</code> 下的配置文件</li>
<li>CNI 插件执行 <code>/opt/cni/bin/</code> 下的二进制程序</li>
<li>完成 Pod 网络配置（创建 VETH、分配 IP、配置路由等）</li>
</ol>
<blockquote>
<p>[!NOTE]
<strong>CNI 的本质</strong>：CNI 只是一个<strong>接口规范</strong>，定义了输入输出格式。具体网络实现由各 CNI 插件负责（如 Flannel、Calico、Cilium）。</p>
</blockquote>
<hr />
<h3 id="62-cni">6.2 CNI 插件分类<a class="headerlink" href="#62-cni" title="Permanent link">&para;</a></h3>
<h4 id="_97">原理<a class="headerlink" href="#_97" title="Permanent link">&para;</a></h4>
<p>CNI 插件分为三大类：</p>
<div class="highlight"><pre><span></span><code>graph TD
    CNI[&quot;CNI 插件分类&quot;] --&gt; Main[&quot;Main 插件&lt;br/&gt;负责网络连通性&quot;]
    CNI --&gt; IPAM[&quot;IPAM 插件&lt;br/&gt;负责 IP 地址管理&quot;]
    CNI --&gt; Meta[&quot;Meta 插件&lt;br/&gt;辅助功能&quot;]

    Main --&gt; Bridge[&quot;bridge&quot;]
    Main --&gt; VETH[&quot;veth/ptp&quot;]
    Main --&gt; IPVLAN[&quot;ipvlan&quot;]
    Main --&gt; MACVLAN[&quot;macvlan&quot;]
    Main --&gt; SRIOV[&quot;sriov&quot;]

    IPAM --&gt; HostLocal[&quot;host-local&quot;]
    IPAM --&gt; DHCP[&quot;dhcp&quot;]
    IPAM --&gt; Static[&quot;static&quot;]
    IPAM --&gt; Whereabouts[&quot;whereabouts&quot;]

    Meta --&gt; PortMap[&quot;portmap&quot;]
    Meta --&gt; Bandwidth[&quot;bandwidth&quot;]
    Meta --&gt; Tuning[&quot;tuning&quot;]
    Meta --&gt; SBR[&quot;sbr&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">职责</th>
<th style="text-align: left;">代表插件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Main</strong></td>
<td style="text-align: left;">创建网络接口、配置网络连通性</td>
<td style="text-align: left;">bridge、veth、ipvlan、macvlan、sriov</td>
</tr>
<tr>
<td style="text-align: left;"><strong>IPAM</strong></td>
<td style="text-align: left;">分配和回收 IP 地址</td>
<td style="text-align: left;">host-local、dhcp、static、whereabouts</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Meta</strong></td>
<td style="text-align: left;">辅助功能（端口映射、带宽限制等）</td>
<td style="text-align: left;">portmap、bandwidth、tuning、sbr</td>
</tr>
</tbody>
</table>
<h4 id="main">Main 插件详解<a class="headerlink" href="#main" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">插件</th>
<th style="text-align: left;">功能</th>
<th style="text-align: left;">使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>bridge</strong></td>
<td style="text-align: left;">创建 Linux Bridge，VETH 插入 Bridge</td>
<td style="text-align: left;">Flannel、默认方案</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ptp</strong></td>
<td style="text-align: left;">点对点 VETH Pair</td>
<td style="text-align: left;">Calico</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ipvlan</strong></td>
<td style="text-align: left;">IPVLAN 子接口</td>
<td style="text-align: left;">高性能虚拟化环境</td>
</tr>
<tr>
<td style="text-align: left;"><strong>macvlan</strong></td>
<td style="text-align: left;">MACVLAN 子接口</td>
<td style="text-align: left;">裸机高性能</td>
</tr>
<tr>
<td style="text-align: left;"><strong>sriov</strong></td>
<td style="text-align: left;">SR-IOV VF 直通</td>
<td style="text-align: left;">电信/金融高性能</td>
</tr>
</tbody>
</table>
<h4 id="ipam">IPAM 插件详解<a class="headerlink" href="#ipam" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">插件</th>
<th style="text-align: left;">作用域</th>
<th style="text-align: left;">特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>host-local</strong></td>
<td style="text-align: left;">单节点</td>
<td style="text-align: left;">最常用，每个节点独立管理 IP 池</td>
</tr>
<tr>
<td style="text-align: left;"><strong>dhcp</strong></td>
<td style="text-align: left;">跨节点</td>
<td style="text-align: left;">使用 DHCP 服务器分配 IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>static</strong></td>
<td style="text-align: left;">固定 IP</td>
<td style="text-align: left;">手工指定 IP，不自动分配</td>
</tr>
<tr>
<td style="text-align: left;"><strong>whereabouts</strong></td>
<td style="text-align: left;">集群级</td>
<td style="text-align: left;">跨节点 IP 管理，多网卡常用</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>IPAM 插件的选择</strong>：</p>
<ul>
<li>普通场景：<strong>host-local</strong>（Flannel、Calico 默认）</li>
<li>多网卡场景：<strong>whereabouts</strong>（集群级 IP 管理）</li>
<li>固定 IP 需求：<strong>static</strong></li>
</ul>
</blockquote>
<hr />
<h3 id="63-cni">6.3 CNI 核心目录结构<a class="headerlink" href="#63-cni" title="Permanent link">&para;</a></h3>
<h4 id="_98">背景<a class="headerlink" href="#_98" title="Permanent link">&para;</a></h4>
<p>理解 CNI 的目录结构，是排障和自定义网络配置的基础。</p>
<h4 id="_99">两大核心目录<a class="headerlink" href="#_99" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph CNI[&quot;CNI 核心目录&quot;]
        CONF[&quot;/etc/cni/net.d/&lt;br/&gt;配置文件目录&quot;]
        BIN[&quot;/opt/cni/bin/&lt;br/&gt;二进制程序目录&quot;]
    end

    CONF --&gt;|&quot;定义：怎么配置网络&quot;| DESC[&quot;网络配置描述&quot;]
    BIN --&gt;|&quot;执行：实际配置网络&quot;| EXEC[&quot;网络配置执行&quot;]
</code></pre></div>
<h4 id="etccninetd-"><code>/etc/cni/net.d/</code> - 配置文件目录<a class="headerlink" href="#etccninetd-" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 CNI 配置文件</span>
ls<span class="w"> </span>-la<span class="w"> </span>/etc/cni/net.d/

<span class="c1"># 典型输出</span>
<span class="c1"># 10-flannel.conflist   # Flannel 配置</span>
<span class="c1"># 10-calico.conflist    # Calico 配置</span>
<span class="c1"># 10-cilium.conflist    # Cilium 配置</span>
</code></pre></div>
<p><strong>配置文件命名规则</strong>：</p>
<ul>
<li>按数字前缀排序，数字小的优先加载</li>
<li><code>.conf</code> 格式：单个插件配置</li>
<li><code>.conflist</code> 格式：多个插件链式调用</li>
</ul>
<h4 id="optcnibin-"><code>/opt/cni/bin/</code> - 二进制程序目录<a class="headerlink" href="#optcnibin-" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 CNI 二进制程序</span>
ls<span class="w"> </span>-la<span class="w"> </span>/opt/cni/bin/

<span class="c1"># 典型输出</span>
<span class="c1"># bandwidth    # 带宽限制插件</span>
<span class="c1"># bridge       # Linux Bridge 插件</span>
<span class="c1"># dhcp         # DHCP IPAM 插件</span>
<span class="c1"># flannel      # Flannel 专用插件</span>
<span class="c1"># host-local   # host-local IPAM 插件</span>
<span class="c1"># ipvlan       # IPVLAN 插件</span>
<span class="c1"># macvlan      # MACVLAN 插件</span>
<span class="c1"># portmap      # 端口映射插件</span>
<span class="c1"># ptp          # 点对点 VETH 插件</span>
<span class="c1"># sbr          # Source Based Routing 插件</span>
<span class="c1"># sriov        # SR-IOV 插件</span>
<span class="c1"># tuning       # 网卡参数调优插件</span>
<span class="c1"># vlan         # VLAN 插件</span>
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li>这些二进制文件由 CNI 插件项目提供</li>
<li>容器运行时会调用这些二进制来配置网络</li>
<li>安装不同 CNI 时会添加对应的二进制（如 Calico 的 <code>calico</code>、<code>calico-ipam</code>）</li>
</ul>
<hr />
<h3 id="64-cni">6.4 CNI 配置文件详解<a class="headerlink" href="#64-cni" title="Permanent link">&para;</a></h3>
<h4 id="_100">背景<a class="headerlink" href="#_100" title="Permanent link">&para;</a></h4>
<p>CNI 配置文件定义了网络如何配置。理解配置文件结构，有助于自定义网络和排障。</p>
<h4 id="calico_1">配置文件示例（Calico）<a class="headerlink" href="#calico_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;k8s-pod-network&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;cniVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.3.1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;plugins&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;calico&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;datastore_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kubernetes&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;mtu&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;nodename_file_optional&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;log_level&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Info&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;log_file_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/log/calico/cni/cni.log&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;ipam&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;calico-ipam&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;assign_ipv4&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;assign_ipv6&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;false&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;container_settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;allow_ip_forwarding&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;policy&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;k8s&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;kubernetes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;k8s_api_root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://10.96.0.1:443&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;kubeconfig&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/etc/cni/net.d/calico-kubeconfig&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;portmap&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;snat&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;capabilities&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;portMappings&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bandwidth&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;capabilities&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;bandwidth&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>配置字段解析</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>name</strong></td>
<td style="text-align: left;">网络名称</td>
</tr>
<tr>
<td style="text-align: left;"><strong>cniVersion</strong></td>
<td style="text-align: left;">CNI 规范版本</td>
</tr>
<tr>
<td style="text-align: left;"><strong>plugins</strong></td>
<td style="text-align: left;">插件列表（链式调用）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>type</strong></td>
<td style="text-align: left;">插件类型（对应 /opt/cni/bin/ 下的二进制）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ipam</strong></td>
<td style="text-align: left;">IP 地址管理配置</td>
</tr>
<tr>
<td style="text-align: left;"><strong>datastore_type</strong></td>
<td style="text-align: left;">数据存储类型（kubernetes/etcdv3）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>policy</strong></td>
<td style="text-align: left;">NetworkPolicy 实现方式</td>
</tr>
</tbody>
</table>
<h4 id="_101">链式调用示意图<a class="headerlink" href="#_101" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    Pod[&quot;Pod 创建&quot;] --&gt; P1[&quot;calico 插件&lt;br/&gt;创建 VETH、配置路由&quot;]
    P1 --&gt; P2[&quot;portmap 插件&lt;br/&gt;配置端口映射&quot;]
    P2 --&gt; P3[&quot;bandwidth 插件&lt;br/&gt;配置带宽限制&quot;]
    P3 --&gt; Done[&quot;网络配置完成&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li>CNI 插件按 <code>plugins</code> 数组顺序依次执行</li>
<li>每个插件完成特定功能后，传递给下一个插件</li>
<li>类似 Linux 管道的链式处理</li>
</ul>
<hr />
<h3 id="65-ipam">6.5 IPAM 工作机制<a class="headerlink" href="#65-ipam" title="Permanent link">&para;</a></h3>
<h4 id="_102">背景<a class="headerlink" href="#_102" title="Permanent link">&para;</a></h4>
<p>IPAM（IP Address Management）负责 Pod 的 IP 地址分配与回收。不同的 IPAM 插件有不同的管理范围和特点。</p>
<h4 id="_103">原理<a class="headerlink" href="#_103" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph HostLocal[&quot;host-local IPAM（节点级）&quot;]
        N1[&quot;节点1&lt;br/&gt;10.244.1.0/24&quot;]
        N2[&quot;节点2&lt;br/&gt;10.244.2.0/24&quot;]
        N3[&quot;节点3&lt;br/&gt;10.244.3.0/24&quot;]
    end

    subgraph Whereabouts[&quot;whereabouts IPAM（集群级）&quot;]
        POOL[&quot;IP 池&lt;br/&gt;10.244.0.0/16&quot;]
        POOL --&gt; PA[&quot;Pod A: 10.244.1.10&quot;]
        POOL --&gt; PB[&quot;Pod B: 10.244.2.20&quot;]
        POOL --&gt; PC[&quot;Pod C: 10.244.3.30&quot;]
    end
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">IPAM</th>
<th style="text-align: left;">管理范围</th>
<th style="text-align: left;">IP 池分配</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>host-local</strong></td>
<td style="text-align: left;">单节点</td>
<td style="text-align: left;">每个节点独立 IP 池</td>
<td style="text-align: left;">默认 CNI（Flannel/Calico）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>whereabouts</strong></td>
<td style="text-align: left;">集群级</td>
<td style="text-align: left;">统一 IP 池，跨节点分配</td>
<td style="text-align: left;">多网卡、需要 IP 跨节点迁移</td>
</tr>
</tbody>
</table>
<h4 id="host-local">host-local 存储位置<a class="headerlink" href="#host-local" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># host-local 的 IP 分配记录存储位置</span>
ls<span class="w"> </span>/var/lib/cni/networks/&lt;network-name&gt;/

<span class="c1"># 每个文件名是已分配的 IP 地址</span>
<span class="c1"># 文件内容是 Pod 的 Container ID</span>
</code></pre></div>
<h4 id="whereabouts">whereabouts 存储方式<a class="headerlink" href="#whereabouts" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># whereabouts 使用 Kubernetes CRD 存储 IP 分配信息</span>
kubectl<span class="w"> </span>get<span class="w"> </span>ippools.whereabouts.cni.cncf.io<span class="w"> </span>-A
kubectl<span class="w"> </span>get<span class="w"> </span>overlappingrangeipreservations.whereabouts.cni.cncf.io<span class="w"> </span>-A
</code></pre></div>
<hr />
<h3 id="66-multus">6.6 多网卡方案（Multus）<a class="headerlink" href="#66-multus" title="Permanent link">&para;</a></h3>
<h4 id="_104">背景<a class="headerlink" href="#_104" title="Permanent link">&para;</a></h4>
<p>在高性能场景中，Pod 可能需要多张网卡：默认网卡用于 Service 通信，额外网卡用于高速数据传输。</p>
<h4 id="_105">原理<a class="headerlink" href="#_105" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Pod[&quot;Pod&quot;]
        ETH0[&quot;eth0&lt;br/&gt;默认 CNI 网卡&lt;br/&gt;10.244.1.10&quot;]
        NET1[&quot;net1&lt;br/&gt;MACVLAN 网卡&lt;br/&gt;192.168.1.100&quot;]
        ETH0 --&gt; SVC[&quot;Service 通信&quot;]
        NET1 --&gt; DATA[&quot;高速数据通信&quot;]
    end

    MULTUS[&quot;Multus CNI&lt;br/&gt;多网卡编排&quot;] --&gt; ETH0
    MULTUS --&gt; NET1
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li><strong>Multus CNI</strong> 是一个 CNI "元插件"，可以调用其他 CNI 为 Pod 配置多张网卡</li>
<li><strong>默认网卡（eth0）</strong>：由集群默认 CNI（如 Calico）配置</li>
<li><strong>额外网卡（net1, net2...）</strong>：通过 Network Attachment Definition 配置</li>
</ul>
<h4 id="network-attachment-definition-nad">Network Attachment Definition (NAD)<a class="headerlink" href="#network-attachment-definition-nad" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-net</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;macvlan&quot;,</span>
<span class="w">    </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth0&quot;,</span>
<span class="w">    </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;bridge&quot;,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">      </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;192.168.1.0/24&quot;,</span>
<span class="w">      </span><span class="s">&quot;gateway&quot;:</span><span class="nv"> </span><span class="s">&quot;192.168.1.1&quot;</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<p><strong>配置说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>type</strong></td>
<td style="text-align: left;">网卡类型（macvlan/ipvlan/sriov）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>master</strong></td>
<td style="text-align: left;">父接口（物理网卡）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>mode</strong></td>
<td style="text-align: left;">MACVLAN 模式（bridge/vepa/private）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ipam.type</strong></td>
<td style="text-align: left;">IP 管理方式（whereabouts 用于多网卡）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ipam.range</strong></td>
<td style="text-align: left;">IP 地址范围</td>
</tr>
</tbody>
</table>
<h4 id="pod">Pod 使用多网卡<a class="headerlink" href="#pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multi-nic-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-net</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li>通过 <code>k8s.v1.cni.cncf.io/networks</code> 注解指定额外网卡</li>
<li>可以指定多个，用逗号分隔：<code>macvlan-net, sriov-net</code></li>
</ul>
<hr />
<h3 id="67-source-based-routing-sbr">6.7 Source Based Routing (SBR)<a class="headerlink" href="#67-source-based-routing-sbr" title="Permanent link">&para;</a></h3>
<h4 id="_106">背景<a class="headerlink" href="#_106" title="Permanent link">&para;</a></h4>
<p>当 Pod 有多张网卡时，需要确保从某张网卡进来的流量，响应也从同一张网卡出去。这需要基于源地址的路由（SBR）。</p>
<h4 id="_107">原理<a class="headerlink" href="#_107" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Pod[&quot;Pod 多网卡&quot;]
        ETH0[&quot;eth0&lt;br/&gt;10.244.1.10&quot;]
        NET1[&quot;net1&lt;br/&gt;192.168.1.100&quot;]
    end

    CLIENT[&quot;客户端&lt;br/&gt;192.168.1.50&quot;]

    CLIENT --&gt;|&quot;请求到 net1&quot;| NET1
    NET1 --&gt;|&quot;SBR: 响应从 net1 返回&quot;| CLIENT
</code></pre></div>
<p><strong>配置示例</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 添加路由规则：从 192.168.1.0/24 出来的流量，查 table 100</span>
ip<span class="w"> </span>rule<span class="w"> </span>add<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.0/24<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>

<span class="c1"># 在 table 100 中添加默认路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.1.1<span class="w"> </span>dev<span class="w"> </span>net1<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>
</code></pre></div>
<p><strong>要点解读</strong>：</p>
<ul>
<li><strong>基于源地址路由</strong> 优先级高于基于目的地址的路由</li>
<li>多网卡场景必须配置 SBR，否则响应流量可能走错网卡</li>
<li>CNI 的 <code>sbr</code> 插件可以自动配置</li>
</ul>
<hr />
<h3 id="68-pod">6.8 Pod 网络配置流程<a class="headerlink" href="#68-pod" title="Permanent link">&para;</a></h3>
<h4 id="_108">完整流程<a class="headerlink" href="#_108" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Kubelet as kubelet
    participant CRI as 容器运行时
    participant CNI as CNI 插件
    participant Config as /etc/cni/net.d/
    participant Bin as /opt/cni/bin/

    Kubelet-&gt;&gt;CRI: 创建 Pod
    CRI-&gt;&gt;Config: 读取 CNI 配置文件
    Config--&gt;&gt;CRI: 返回配置（plugin 列表）
    CRI-&gt;&gt;Bin: 调用 Main 插件（bridge/calico）
    Bin--&gt;&gt;CRI: 创建 VETH、配置路由
    CRI-&gt;&gt;Bin: 调用 IPAM 插件（host-local）
    Bin--&gt;&gt;CRI: 分配 IP 地址
    CRI-&gt;&gt;Bin: 调用 Meta 插件（portmap/bandwidth）
    Bin--&gt;&gt;CRI: 配置端口映射/带宽
    CRI--&gt;&gt;Kubelet: Pod 网络就绪
</code></pre></div>
<p><strong>流程说明</strong>：</p>
<ol>
<li>kubelet 调用容器运行时创建 Pod</li>
<li>容器运行时读取 <code>/etc/cni/net.d/</code> 下的配置文件（按名称排序，优先加载）</li>
<li>按配置文件中的 <code>plugins</code> 列表顺序：</li>
<li>调用 Main 插件：创建网络接口</li>
<li>调用 IPAM 插件：分配 IP 地址</li>
<li>调用 Meta 插件：附加功能</li>
<li>所有插件执行完成，Pod 网络就绪</li>
</ol>
<hr />
<h3 id="69">6.9 常见问题与排障<a class="headerlink" href="#69" title="Permanent link">&para;</a></h3>
<h4 id="1pod">问题1：Pod 网络配置失败<a class="headerlink" href="#1pod" title="Permanent link">&para;</a></h4>
<p><strong>检查步骤</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 检查 CNI 配置文件是否存在</span>
ls<span class="w"> </span>-la<span class="w"> </span>/etc/cni/net.d/

<span class="c1"># 2. 检查 CNI 二进制是否存在</span>
ls<span class="w"> </span>-la<span class="w"> </span>/opt/cni/bin/

<span class="c1"># 3. 查看 kubelet 日志</span>
journalctl<span class="w"> </span>-u<span class="w"> </span>kubelet<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>cni

<span class="c1"># 4. 查看容器运行时日志</span>
crictl<span class="w"> </span>logs<span class="w"> </span>&lt;container-id&gt;
</code></pre></div>
<h4 id="2ip">问题2：IP 地址分配失败<a class="headerlink" href="#2ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 host-local IPAM 的 IP 分配记录</span>
ls<span class="w"> </span>/var/lib/cni/networks/

<span class="c1"># 如果 IP 池耗尽，可以清理无效记录</span>
<span class="c1"># （谨慎操作，仅在确认 IP 未被使用时）</span>
</code></pre></div>
<h4 id="3-ip">问题3：多网卡 IP 冲突<a class="headerlink" href="#3-ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 whereabouts 的 IP 分配</span>
kubectl<span class="w"> </span>get<span class="w"> </span>ippools.whereabouts.cni.cncf.io<span class="w"> </span>-A<span class="w"> </span>-o<span class="w"> </span>wide

<span class="c1"># 查看 IP 预留情况</span>
kubectl<span class="w"> </span>get<span class="w"> </span>overlappingrangeipreservations<span class="w"> </span>-A
</code></pre></div>
<hr />
<h3 id="_109">📝 章节小结<a class="headerlink" href="#_109" title="Permanent link">&para;</a></h3>
<p>本章深入讲解了 CNI 工作原理：</p>
<ol>
<li><strong>CNI 插件分类</strong>：</li>
<li><strong>Main 插件</strong>：创建网络接口（bridge、veth、ipvlan、macvlan、sriov）</li>
<li><strong>IPAM 插件</strong>：分配 IP 地址（host-local、dhcp、static、whereabouts）</li>
<li>
<p><strong>Meta 插件</strong>：辅助功能（portmap、bandwidth、sbr）</p>
</li>
<li>
<p><strong>两大核心目录</strong>：</p>
</li>
<li><code>/etc/cni/net.d/</code>：配置文件，定义"怎么配置网络"</li>
<li>
<p><code>/opt/cni/bin/</code>：二进制程序，"实际执行配置"</p>
</li>
<li>
<p><strong>配置文件结构</strong>：链式调用多个插件</p>
</li>
<li>
<p><strong>IPAM 机制</strong>：</p>
</li>
<li>host-local：节点级，每节点独立 IP 池</li>
<li>
<p>whereabouts：集群级，跨节点 IP 管理</p>
</li>
<li>
<p><strong>多网卡方案</strong>：</p>
</li>
<li>Multus CNI 编排多网卡</li>
<li>Network Attachment Definition 定义额外网卡</li>
<li>SBR 保证多网卡响应路径正确</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>在实际集群中查看 <code>/etc/cni/net.d/</code> 和 <code>/opt/cni/bin/</code> 目录</li>
<li>理解 CNI 配置文件中的 plugins 链式调用</li>
<li>尝试使用 Multus 配置多网卡 Pod</li>
<li>出现网络问题时，首先检查 CNI 配置文件和二进制</li>
</ol>
<p>[!IMPORTANT]
<strong>CNI 排障核心思路</strong>：</p>
<ol>
<li>配置文件存在吗？（<code>/etc/cni/net.d/</code>）</li>
<li>二进制存在吗？（<code>/opt/cni/bin/</code>）</li>
<li>配置文件内容正确吗？（type、ipam 等字段）</li>
<li>IP 池是否耗尽？（检查 IPAM 存储）</li>
</ol>
</blockquote>
<hr />
<h1 id="cilium-cni_1">第二部分：Cilium-CNI<a class="headerlink" href="#cilium-cni_1" title="Permanent link">&para;</a></h1>
<h2 id="7-ebpf">第7章 eBPF 介绍与网络应用<a class="headerlink" href="#7-ebpf" title="Permanent link">&para;</a></h2>
<h3 id="_110">🎯 学习目标<a class="headerlink" href="#_110" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 eBPF 技术的背景与核心概念</li>
<li>掌握 eBPF 程序的加载流程</li>
<li>理解 eBPF 在网络中的 Hook 点（XDP、TC）</li>
<li>掌握数据包收发流程与 eBPF 介入点</li>
<li>了解 eBPF Map 的作用</li>
</ul>
<hr />
<h3 id="71-ebpf">7.1 eBPF 技术背景<a class="headerlink" href="#71-ebpf" title="Permanent link">&para;</a></h3>
<h4 id="_111">背景<a class="headerlink" href="#_111" title="Permanent link">&para;</a></h4>
<p>eBPF（extended Berkeley Packet Filter）是 Linux 内核中的一项革命性技术。它允许在<strong>不修改内核源码</strong>的情况下，动态向内核注入特定逻辑。</p>
<h4 id="cbpf-ebpf">从 cBPF 到 eBPF<a class="headerlink" href="#cbpf-ebpf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    cBPF[&quot;cBPF&lt;br/&gt;Classical BPF&lt;br/&gt;仅用于包过滤&quot;] --&gt;|&quot;扩展增强&quot;| eBPF[&quot;eBPF&lt;br/&gt;Extended BPF&lt;br/&gt;通用内核扩展&quot;]

    eBPF --&gt; NET[&quot;网络&lt;br/&gt;XDP/TC&quot;]
    eBPF --&gt; TRACE[&quot;追踪&lt;br/&gt;kprobe/tracepoint&quot;]
    eBPF --&gt; SEC[&quot;安全&lt;br/&gt;seccomp&quot;]
    eBPF --&gt; PERF[&quot;性能&lt;br/&gt;perf events&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">cBPF</th>
<th style="text-align: left;">eBPF</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>诞生时间</strong></td>
<td style="text-align: left;">1992 年（伯克利大学）</td>
<td style="text-align: left;">2014 年（Linux 3.18）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>功能范围</strong></td>
<td style="text-align: left;">仅包过滤</td>
<td style="text-align: left;">网络、追踪、安全、性能等</td>
</tr>
<tr>
<td style="text-align: left;"><strong>寄存器</strong></td>
<td style="text-align: left;">2 个 32 位</td>
<td style="text-align: left;">10 个 64 位</td>
</tr>
<tr>
<td style="text-align: left;"><strong>指令集</strong></td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">丰富（跳转、调用等）</td>
</tr>
</tbody>
</table>
<h4 id="ebpf">eBPF 的核心价值<a class="headerlink" href="#ebpf" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!IMPORTANT]
<strong>eBPF = 内核可编程化</strong></p>
<ul>
<li>传统方式：修改内核源码 → 重新编译 → 重启</li>
<li>eBPF 方式：编写 eBPF 程序 → 动态加载 → <strong>无需重启</strong></li>
</ul>
<p>这就像给内核"打补丁"，但不需要重新编译内核。</p>
</blockquote>
<hr />
<h3 id="72-ebpf">7.2 eBPF 程序加载流程<a class="headerlink" href="#72-ebpf" title="Permanent link">&para;</a></h3>
<h4 id="_112">原理<a class="headerlink" href="#_112" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    SRC[&quot;1. 编写源码&lt;br/&gt;C/Python/Go&quot;] --&gt; COMPILE[&quot;2. 编译&lt;br/&gt;LLVM/Clang → BPF 字节码&quot;]
    COMPILE --&gt; VERIFY[&quot;3. 验证 Verify&lt;br/&gt;安全性检查&quot;]
    VERIFY --&gt;|&quot;通过&quot;| JIT[&quot;4. JIT 编译&lt;br/&gt;字节码 → 机器码&quot;]
    VERIFY --&gt;|&quot;失败&quot;| REJECT[&quot;拒绝加载&quot;]
    JIT --&gt; INJECT[&quot;5. 注入 Hook 点&lt;br/&gt;XDP/TC/kprobe 等&quot;]
    INJECT --&gt; RUN[&quot;6. 运行&lt;br/&gt;事件触发执行&quot;]
</code></pre></div>
<p><strong>流程说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">步骤</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>编写源码</strong></td>
<td style="text-align: left;">使用 C、Python、Go 等高级语言编写</td>
</tr>
<tr>
<td style="text-align: left;"><strong>编译</strong></td>
<td style="text-align: left;">通过 LLVM/Clang 编译为 eBPF 字节码</td>
</tr>
<tr>
<td style="text-align: left;"><strong>验证 Verify</strong></td>
<td style="text-align: left;">内核验证器检查：无死循环、无越界访问、执行时间有限</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JIT 编译</strong></td>
<td style="text-align: left;">将字节码编译为本机机器指令，提高执行效率</td>
</tr>
<tr>
<td style="text-align: left;"><strong>注入 Hook</strong></td>
<td style="text-align: left;">将程序注入到内核的特定位置（Hook 点）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>运行</strong></td>
<td style="text-align: left;">当事件（如数据包到达）触发时执行</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>Verify 验证器的作用</strong>：确保 eBPF 程序不会导致内核崩溃。检查项包括：</p>
<ul>
<li>无无限循环</li>
<li>无越界内存访问</li>
<li>执行指令数有上限</li>
<li>仅能调用白名单内的内核函数</li>
</ul>
</blockquote>
<hr />
<h3 id="73-ebpf-hook">7.3 eBPF 网络 Hook 点<a class="headerlink" href="#73-ebpf-hook" title="Permanent link">&para;</a></h3>
<h4 id="_113">背景<a class="headerlink" href="#_113" title="Permanent link">&para;</a></h4>
<p>eBPF 可以在网络数据包处理路径的<strong>多个位置</strong>注入程序，实现流量过滤、转发、修改等功能。</p>
<h4 id="hook">核心 Hook 点<a class="headerlink" href="#hook" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph DataPath[&quot;数据包处理路径&quot;]
        NIC[&quot;网卡驱动&lt;br/&gt;NIC Driver&quot;] --&gt; XDP[&quot;XDP Hook&lt;br/&gt;最早介入点&quot;]
        XDP --&gt; SKB[&quot;sk_buff 分配&quot;]
        SKB --&gt; TC_IN[&quot;TC ingress Hook&quot;]
        TC_IN --&gt; NETFILTER[&quot;Netfilter/iptables&quot;]
        NETFILTER --&gt; PROTO[&quot;协议栈处理&lt;br/&gt;IP/TCP/UDP&quot;]
        PROTO --&gt; APP[&quot;应用程序&quot;]
    end

    style XDP fill:#90EE90
    style TC_IN fill:#87CEEB
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Hook 点</th>
<th style="text-align: left;">位置</th>
<th style="text-align: left;">特点</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>XDP</strong></td>
<td style="text-align: left;">网卡驱动层</td>
<td style="text-align: left;">最早、最快</td>
<td style="text-align: left;">DDoS 防护、简单丢弃/放行</td>
</tr>
<tr>
<td style="text-align: left;"><strong>TC</strong></td>
<td style="text-align: left;">sk_buff 分配后</td>
<td style="text-align: left;">功能丰富</td>
<td style="text-align: left;">流量整形、复杂策略</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Netfilter</strong></td>
<td style="text-align: left;">协议栈内部</td>
<td style="text-align: left;">传统方式</td>
<td style="text-align: left;">iptables 规则</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Socket</strong></td>
<td style="text-align: left;">应用层接口</td>
<td style="text-align: left;">最靠近应用</td>
<td style="text-align: left;">Service Mesh</td>
</tr>
</tbody>
</table>
<h4 id="xdp-vs-tc">XDP vs TC 对比<a class="headerlink" href="#xdp-vs-tc" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph XDP层[&quot;XDP（网卡驱动层）&quot;]
        XDP_ACT[&quot;动作：PASS/DROP/TX/REDIRECT/ABORTED&quot;]
    end

    subgraph TC层[&quot;TC（Traffic Control 层）&quot;]
        TC_ACT[&quot;动作：OK/SHOT/REDIRECT + 复杂处理&quot;]
    end

    NIC[&quot;网卡&quot;] --&gt; XDP层 --&gt; TC层 --&gt; PROTO[&quot;协议栈&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">XDP</th>
<th style="text-align: left;">TC</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>位置</strong></td>
<td style="text-align: left;">网卡驱动（最前）</td>
<td style="text-align: left;">sk_buff 分配后</td>
</tr>
<tr>
<td style="text-align: left;"><strong>速度</strong></td>
<td style="text-align: left;">⭐⭐⭐⭐⭐</td>
<td style="text-align: left;">⭐⭐⭐⭐</td>
</tr>
<tr>
<td style="text-align: left;"><strong>功能复杂度</strong></td>
<td style="text-align: left;">简单（无完整协议信息）</td>
<td style="text-align: left;">复杂（可访问完整 sk_buff）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cilium 使用</strong></td>
<td style="text-align: left;">部分功能（DDoS）</td>
<td style="text-align: left;"><strong>主要使用</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>可实现功能</strong></td>
<td style="text-align: left;">DROP/PASS/TX/REDIRECT</td>
<td style="text-align: left;">SNAT/DNAT/策略/重定向</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>Cilium 主要使用 TC Hook</strong>：</p>
<ul>
<li>XDP 过于靠前，无法获取完整的协议信息</li>
<li>TC 可以实现地址转换（SNAT/DNAT）、策略路由等复杂功能</li>
<li>TC 在 Cilium 中替代了 iptables 的功能</li>
</ul>
</blockquote>
<hr />
<h3 id="74">7.4 数据包收发流程<a class="headerlink" href="#74" title="Permanent link">&para;</a></h3>
<h4 id="_114">背景<a class="headerlink" href="#_114" title="Permanent link">&para;</a></h4>
<p>理解数据包在 Linux 内核中的收发流程，是理解 eBPF 网络优化的基础。</p>
<h4 id="rx">收包流程（RX）<a class="headerlink" href="#rx" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    WIRE[&quot;网络线缆&quot;] --&gt; NIC[&quot;网卡接收&quot;]
    NIC --&gt; DMA[&quot;DMA 拷贝到内存&quot;]
    DMA --&gt; IRQ[&quot;硬中断通知 CPU&quot;]
    IRQ --&gt; SOFTIRQ[&quot;软中断处理&lt;br/&gt;ksoftirqd&quot;]
    SOFTIRQ --&gt; SKB[&quot;分配 sk_buff&quot;]
    SKB --&gt; XDP_HOOK[&quot;XDP Hook&quot;]
    XDP_HOOK --&gt; TC_HOOK[&quot;TC ingress Hook&quot;]
    TC_HOOK --&gt; NETFILTER[&quot;Netfilter&quot;]
    NETFILTER --&gt; L3[&quot;IP 层处理&quot;]
    L3 --&gt; L4[&quot;TCP/UDP 处理&quot;]
    L4 --&gt; SOCKET[&quot;Socket 缓冲区&quot;]
    SOCKET --&gt; APP[&quot;应用程序读取&quot;]
</code></pre></div>
<p><strong>流程说明</strong>：</p>
<ol>
<li><strong>网卡接收</strong>：数据包到达物理网卡</li>
<li><strong>DMA 拷贝</strong>：网卡通过 DMA 将数据拷贝到内存（Ring Buffer）</li>
<li><strong>硬中断</strong>：通知 CPU 有数据到达</li>
<li><strong>软中断</strong>：ksoftirqd 处理数据包</li>
<li><strong>分配 sk_buff</strong>：为数据包分配内核数据结构</li>
<li><strong>XDP/TC Hook</strong>：eBPF 程序介入点</li>
<li><strong>协议栈处理</strong>：Netfilter → IP → TCP/UDP</li>
<li><strong>应用读取</strong>：数据到达 Socket 缓冲区，应用程序读取</li>
</ol>
<h4 id="tx">发包流程（TX）<a class="headerlink" href="#tx" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    APP[&quot;应用程序写入&quot;] --&gt; SOCKET[&quot;Socket 缓冲区&quot;]
    SOCKET --&gt; L4[&quot;TCP/UDP 封装&quot;]
    L4 --&gt; L3[&quot;IP 封装&quot;]
    L3 --&gt; NETFILTER[&quot;Netfilter&quot;]
    NETFILTER --&gt; TC_HOOK[&quot;TC egress Hook&quot;]
    TC_HOOK --&gt; QDISC[&quot;队列调度 Qdisc&quot;]
    QDISC --&gt; NIC[&quot;网卡发送&quot;]
    NIC --&gt; WIRE[&quot;网络线缆&quot;]
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>eBPF 优化的关键</strong>：在数据包进入完整协议栈之前，在 XDP 或 TC 层面就完成处理，避免不必要的协议栈开销。</p>
</blockquote>
<hr />
<h3 id="75-tc-ingressegress">7.5 TC ingress/egress 方向<a class="headerlink" href="#75-tc-ingressegress" title="Permanent link">&para;</a></h3>
<h4 id="_115">背景<a class="headerlink" href="#_115" title="Permanent link">&para;</a></h4>
<p>理解 TC 的 ingress 和 egress 方向，对于理解 Cilium 的流量处理至关重要。</p>
<h4 id="_116">原理<a class="headerlink" href="#_116" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Node[&quot;Linux 节点&quot;]
        NIC[&quot;物理网卡&quot;]

        subgraph TC[&quot;TC 层&quot;]
            INGRESS[&quot;ingress&lt;br/&gt;入方向：网卡 → 协议栈&quot;]
            EGRESS[&quot;egress&lt;br/&gt;出方向：协议栈 → 网卡&quot;]
        end

        PROTO[&quot;协议栈&quot;]

        NIC --&gt;|&quot;收包&quot;| INGRESS
        INGRESS --&gt; PROTO
        PROTO --&gt; EGRESS
        EGRESS --&gt;|&quot;发包&quot;| NIC
    end
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">方向</th>
<th style="text-align: left;">定义</th>
<th style="text-align: left;">数据流向</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>ingress</strong></td>
<td style="text-align: left;">入方向</td>
<td style="text-align: left;">网卡 → 协议栈</td>
</tr>
<tr>
<td style="text-align: left;"><strong>egress</strong></td>
<td style="text-align: left;">出方向</td>
<td style="text-align: left;">协议栈 → 网卡</td>
</tr>
</tbody>
</table>
<h4 id="veth-ingressegress">在 VETH 上的 ingress/egress<a class="headerlink" href="#veth-ingressegress" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Pod[&quot;Pod 网络命名空间&quot;]
        ETH0[&quot;eth0&quot;]
    end

    subgraph Host[&quot;宿主机 Root 命名空间&quot;]
        VETH[&quot;veth-xxx&lt;br/&gt;TC ingress/egress&quot;]
    end

    ETH0 &lt;--&gt;|&quot;VETH Pair&quot;| VETH
    VETH &lt;--&gt; PROTO[&quot;协议栈&quot;]
</code></pre></div>
<p><strong>Cilium 的处理方式</strong>：</p>
<ul>
<li>在 VETH 宿主机端的 <strong>TC ingress</strong> 挂载 eBPF 程序</li>
<li>当数据包从 Pod 发出时，到达 VETH 宿主机端的 ingress 方向</li>
<li>eBPF 程序可以直接重定向（redirect），绕过宿主机协议栈</li>
</ul>
<hr />
<h3 id="76-ebpf-map">7.6 eBPF Map<a class="headerlink" href="#76-ebpf-map" title="Permanent link">&para;</a></h3>
<h4 id="_117">背景<a class="headerlink" href="#_117" title="Permanent link">&para;</a></h4>
<p>eBPF 程序运行在内核空间，如何与用户空间的程序通信？答案是 <strong>eBPF Map</strong>。</p>
<h4 id="_118">原理<a class="headerlink" href="#_118" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Kernel[&quot;内核空间&quot;]
        BPF_PROG[&quot;eBPF 程序&lt;br/&gt;运行在 XDP/TC&quot;]
        BPF_MAP[&quot;eBPF Map&lt;br/&gt;Key-Value 存储&quot;]
        BPF_PROG &lt;--&gt;|&quot;读写&quot;| BPF_MAP
    end

    subgraph User[&quot;用户空间&quot;]
        USER_PROG[&quot;用户程序&lt;br/&gt;cilium-agent&quot;]
        USER_PROG &lt;--&gt;|&quot;读写&quot;| BPF_MAP
    end
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>数据结构</strong></td>
<td style="text-align: left;">Key-Value 存储（类似 Python 字典）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>作用</strong></td>
<td style="text-align: left;">内核空间 ↔ 用户空间通信桥梁</td>
</tr>
<tr>
<td style="text-align: left;"><strong>类型</strong></td>
<td style="text-align: left;">Hash、Array、LRU、Ring Buffer 等</td>
</tr>
<tr>
<td style="text-align: left;"><strong>持久化</strong></td>
<td style="text-align: left;">可通过文件系统（/sys/fs/bpf/）持久化</td>
</tr>
</tbody>
</table>
<h4 id="cilium">在 Cilium 中的应用<a class="headerlink" href="#cilium" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Cilium 的 eBPF Map</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>ct<span class="w"> </span>list<span class="w"> </span>global<span class="w">      </span><span class="c1"># 连接跟踪表</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>lb<span class="w"> </span>list<span class="w">             </span><span class="c1"># 负载均衡表</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>policy<span class="w"> </span>get<span class="w"> </span>--all<span class="w">    </span><span class="c1"># 策略表</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>endpoint<span class="w"> </span>list<span class="w">       </span><span class="c1"># Endpoint 表</span>
</code></pre></div>
<p><strong>代码说明</strong>：</p>
<ul>
<li>Cilium Agent 将 Service、Endpoint、Policy 等信息写入 eBPF Map</li>
<li>内核中的 eBPF 程序读取 Map 进行决策</li>
<li>无需经过用户空间，实现高性能数据平面</li>
</ul>
<hr />
<h3 id="77-ebpf-hook">7.7 抓包与 eBPF Hook 点<a class="headerlink" href="#77-ebpf-hook" title="Permanent link">&para;</a></h3>
<h4 id="_119">背景<a class="headerlink" href="#_119" title="Permanent link">&para;</a></h4>
<p>使用 tcpdump 抓包时，可能会遇到"抓不到包"的情况。理解 eBPF Hook 点与 tcpdump 的位置关系，有助于排障。</p>
<h4 id="_120">原理<a class="headerlink" href="#_120" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    NIC[&quot;网卡&quot;] --&gt; XDP[&quot;XDP Hook&quot;]
    XDP --&gt; SKB[&quot;sk_buff&quot;]
    SKB --&gt; TCPDUMP[&quot;tcpdump 抓包点&lt;br/&gt;AF_PACKET&quot;]
    TCPDUMP --&gt; TC[&quot;TC ingress Hook&quot;]
    TC --&gt;|&quot;可能 redirect&quot;| OTHER[&quot;其他接口/丢弃&quot;]
    TC --&gt; PROTO[&quot;协议栈&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">情况</th>
<th style="text-align: left;">能否抓到包</th>
<th style="text-align: left;">原因</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>入方向，TC 未 redirect</strong></td>
<td style="text-align: left;">✅ 能</td>
<td style="text-align: left;">tcpdump 在 TC 之前</td>
</tr>
<tr>
<td style="text-align: left;"><strong>入方向，TC redirect</strong></td>
<td style="text-align: left;">✅ 能</td>
<td style="text-align: left;">数据包先经过 tcpdump</td>
</tr>
<tr>
<td style="text-align: left;"><strong>出方向，TC redirect</strong></td>
<td style="text-align: left;">❌ 不能</td>
<td style="text-align: left;">数据包被 redirect，不经过 tcpdump</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
<strong>Cilium eBPF Host Routing 抓包现象</strong>：</p>
<ul>
<li>在 VETH 上只能看到<strong>单向流量</strong></li>
<li>因为响应流量被 <code>bpf_redirect_peer</code> 直接重定向了</li>
<li>排障时需要在 Pod 内部抓包，或使用 Cilium 的 <code>cilium monitor</code> 命令</li>
</ul>
</blockquote>
<hr />
<h3 id="78-ebpf-cilium">7.8 eBPF 在 Cilium 中的应用<a class="headerlink" href="#78-ebpf-cilium" title="Permanent link">&para;</a></h3>
<h4 id="cilium-ebpf_1">Cilium 的 eBPF 程序分布<a class="headerlink" href="#cilium-ebpf_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Pod[&quot;Pod&quot;]
        APP[&quot;应用&quot;]
        POD_ETH[&quot;eth0&quot;]
    end

    subgraph Host[&quot;宿主机&quot;]
        VETH[&quot;veth&lt;br/&gt;TC ingress: eBPF&quot;]
        BRIDGE[&quot;cilium_vxlan/cilium_host&quot;]
        PHYS[&quot;物理网卡&lt;br/&gt;TC/XDP: eBPF&quot;]
    end

    POD_ETH &lt;--&gt; VETH
    VETH &lt;--&gt; BRIDGE
    BRIDGE &lt;--&gt; PHYS
</code></pre></div>
<p><strong>Cilium 使用 eBPF 实现的功能</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">功能</th>
<th style="text-align: left;">传统方式</th>
<th style="text-align: left;">Cilium eBPF 方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Service 负载均衡</strong></td>
<td style="text-align: left;">kube-proxy + iptables</td>
<td style="text-align: left;">eBPF Map + TC</td>
</tr>
<tr>
<td style="text-align: left;"><strong>NetworkPolicy</strong></td>
<td style="text-align: left;">iptables 规则</td>
<td style="text-align: left;">eBPF Map + TC</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SNAT/Masquerade</strong></td>
<td style="text-align: left;">iptables MASQUERADE</td>
<td style="text-align: left;">eBPF TC</td>
</tr>
<tr>
<td style="text-align: left;"><strong>连接跟踪</strong></td>
<td style="text-align: left;">nf_conntrack</td>
<td style="text-align: left;">eBPF CT Map</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Host Routing</strong></td>
<td style="text-align: left;">协议栈路由</td>
<td style="text-align: left;">bpf_redirect_peer</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_121">📝 章节小结<a class="headerlink" href="#_121" title="Permanent link">&para;</a></h3>
<p>本章介绍了 eBPF 技术及其在网络中的应用：</p>
<ol>
<li><strong>eBPF 概念</strong>：</li>
<li>从 cBPF 演进而来的内核扩展技术</li>
<li>无需重编译内核，动态加载程序</li>
<li>
<p>"给内核打补丁"的能力</p>
</li>
<li>
<p><strong>程序加载流程</strong>：</p>
</li>
<li>
<p>编写 → 编译 → Verify → JIT → 注入 Hook → 运行</p>
</li>
<li>
<p><strong>网络 Hook 点</strong>：</p>
</li>
<li><strong>XDP</strong>：网卡驱动层，最快但功能简单</li>
<li><strong>TC</strong>：Traffic Control 层，Cilium 主要使用</li>
<li>
<p>ingress/egress 方向理解</p>
</li>
<li>
<p><strong>eBPF Map</strong>：</p>
</li>
<li>内核与用户空间通信的桥梁</li>
<li>
<p>Key-Value 存储结构</p>
</li>
<li>
<p><strong>在 Cilium 中的应用</strong>：</p>
</li>
<li>替代 iptables 实现 Service、NetworkPolicy</li>
<li>使用 bpf_redirect 实现 Host Routing</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>记住 XDP 和 TC 的位置关系</li>
<li>理解 ingress/egress 方向的定义</li>
<li>了解 tcpdump 与 eBPF Hook 的位置关系</li>
<li>使用 <code>cilium bpf</code> 命令查看 eBPF Map</li>
</ol>
<p>[!IMPORTANT]
<strong>核心记忆点</strong>：</p>
<ul>
<li><strong>XDP</strong> 最快但功能简单，<strong>TC</strong> 功能丰富是 Cilium 主力</li>
<li>数据包从网卡 → XDP → tcpdump → TC → 协议栈</li>
<li>Cilium 用 eBPF 替代 iptables，实现高性能数据平面</li>
</ul>
</blockquote>
<hr />
<h2 id="8-cilium">第8章 Cilium 及安装模式介绍<a class="headerlink" href="#8-cilium" title="Permanent link">&para;</a></h2>
<h3 id="_122">🎯 学习目标<a class="headerlink" href="#_122" title="Permanent link">&para;</a></h3>
<ul>
<li>了解 Cilium 的核心架构与组件</li>
<li>掌握 Cilium 的三种安装模式及其区别</li>
<li>理解 native routing 与 host routing 的概念差异</li>
<li>学会使用 Helm 安装和配置 Cilium</li>
<li>掌握 Cilium 常用命令</li>
</ul>
<hr />
<h3 id="81-cilium">8.1 Cilium 概述<a class="headerlink" href="#81-cilium" title="Permanent link">&para;</a></h3>
<h4 id="_123">背景<a class="headerlink" href="#_123" title="Permanent link">&para;</a></h4>
<p>Cilium 是一个基于 eBPF 的高性能 CNI 插件，专为 Kubernetes 设计。它不仅提供网络连通性，还集成了安全策略、负载均衡、可观测性等功能。</p>
<h4 id="_124">核心架构<a class="headerlink" href="#_124" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph ControlPlane[&quot;控制平面&quot;]
        OPERATOR[&quot;cilium-operator&lt;br/&gt;集群级管理&quot;]
    end

    subgraph DataPlane[&quot;数据平面（每节点）&quot;]
        AGENT[&quot;cilium-agent&lt;br/&gt;节点级管理&quot;]
        EBPF[&quot;eBPF 程序&lt;br/&gt;TC/XDP&quot;]
        AGENT --&gt; EBPF
    end

    subgraph Storage[&quot;存储&quot;]
        ETCD[&quot;Kubernetes etcd&lt;br/&gt;或 Cilium etcd&quot;]
    end

    OPERATOR --&gt; Storage
    AGENT --&gt; Storage
</code></pre></div>
<p><strong>组件说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">组件</th>
<th style="text-align: left;">位置</th>
<th style="text-align: left;">职责</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>cilium-operator</strong></td>
<td style="text-align: left;">Deployment</td>
<td style="text-align: left;">集群级资源管理（IPAM、BGP 等）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>cilium-agent</strong></td>
<td style="text-align: left;">DaemonSet</td>
<td style="text-align: left;">节点级网络配置、eBPF 程序管理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>cilium-envoy</strong></td>
<td style="text-align: left;">嵌入 Agent</td>
<td style="text-align: left;">L7 策略、可观测性</td>
</tr>
<tr>
<td style="text-align: left;"><strong>hubble</strong></td>
<td style="text-align: left;">可选组件</td>
<td style="text-align: left;">网络流量可视化</td>
</tr>
</tbody>
</table>
<h4 id="cilium_1">Cilium 核心功能<a class="headerlink" href="#cilium_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    CILIUM[&quot;Cilium&quot;] --&gt; CNI[&quot;CNI 网络&lt;br/&gt;Pod 连通性&quot;]
    CILIUM --&gt; LB[&quot;负载均衡&lt;br/&gt;替代 kube-proxy&quot;]
    CILIUM --&gt; POLICY[&quot;NetworkPolicy&lt;br/&gt;L3/L4/L7 安全&quot;]
    CILIUM --&gt; BGP[&quot;BGP&lt;br/&gt;路由通告&quot;]
    CILIUM --&gt; MESH[&quot;Cluster Mesh&lt;br/&gt;多集群&quot;]
    CILIUM --&gt; HUBBLE[&quot;Hubble&lt;br/&gt;可观测性&quot;]
</code></pre></div>
<hr />
<h3 id="82">8.2 三种安装模式<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<h4 id="_125">背景<a class="headerlink" href="#_125" title="Permanent link">&para;</a></h4>
<p>Cilium 提供三种安装模式，对应不同的功能层次和内核要求。理解这三种模式是使用 Cilium 的基础。</p>
<h4 id="_126">模式概览<a class="headerlink" href="#_126" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Mode1[&quot;模式1: with kube-proxy&quot;]
        M1_DESC[&quot;传统模式&lt;br/&gt;兼容性最好&quot;]
        M1_IPTABLES[&quot;Service: iptables&quot;]
        M1_ROUTING[&quot;Routing: 内核协议栈&quot;]
    end

    subgraph Mode2[&quot;模式2: kube-proxy replacement&quot;]
        M2_DESC[&quot;进阶模式&lt;br/&gt;替代 kube-proxy&quot;]
        M2_BPF[&quot;Service: eBPF&quot;]
        M2_ROUTING[&quot;Routing: 内核协议栈&quot;]
    end

    subgraph Mode3[&quot;模式3: eBPF Host Routing&quot;]
        M3_DESC[&quot;高级模式&lt;br/&gt;性能最优&quot;]
        M3_BPF[&quot;Service: eBPF&quot;]
        M3_HOSTROUTING[&quot;Routing: eBPF redirect&quot;]
    end

    Mode1 --&gt;|&quot;进阶&quot;| Mode2
    Mode2 --&gt;|&quot;进阶&quot;| Mode3
</code></pre></div>
<p><strong>模式对比</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">with kube-proxy</th>
<th style="text-align: left;">kube-proxy replacement</th>
<th style="text-align: left;">eBPF Host Routing</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Service 实现</strong></td>
<td style="text-align: left;">iptables</td>
<td style="text-align: left;">eBPF</td>
<td style="text-align: left;">eBPF</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Host 路由</strong></td>
<td style="text-align: left;">内核协议栈</td>
<td style="text-align: left;">内核协议栈</td>
<td style="text-align: left;">eBPF redirect</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能</strong></td>
<td style="text-align: left;">一般</td>
<td style="text-align: left;">较好</td>
<td style="text-align: left;">最优</td>
</tr>
<tr>
<td style="text-align: left;"><strong>内核要求</strong></td>
<td style="text-align: left;">4.9+</td>
<td style="text-align: left;">4.19+</td>
<td style="text-align: left;">5.10+</td>
</tr>
<tr>
<td style="text-align: left;"><strong>兼容性</strong></td>
<td style="text-align: left;">最好</td>
<td style="text-align: left;">较好</td>
<td style="text-align: left;">部分功能不支持</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>概念澄清</strong>：</p>
<ul>
<li><strong>native routing = direct routing = Host-GW</strong> → 路由转发方式</li>
<li><strong>host routing</strong> → eBPF 绕过宿主机协议栈的能力</li>
</ul>
<p>这两个概念<strong>完全不同</strong>，不要混淆！</p>
</blockquote>
<hr />
<h3 id="83-1-with-kube-proxy">8.3 模式1: with kube-proxy<a class="headerlink" href="#83-1-with-kube-proxy" title="Permanent link">&para;</a></h3>
<h4 id="_127">背景<a class="headerlink" href="#_127" title="Permanent link">&para;</a></h4>
<p>这是最基础的模式，Cilium 只负责 CNI 网络连通性，Service 依然由 kube-proxy + iptables 实现。</p>
<h4 id="_128">原理<a class="headerlink" href="#_128" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Pod[&quot;Pod&quot;]
        APP[&quot;应用&quot;]
    end

    subgraph Host[&quot;宿主机&quot;]
        VETH[&quot;veth&lt;br/&gt;TC: eBPF&quot;]
        IPTABLES[&quot;iptables&lt;br/&gt;kube-proxy 规则&quot;]
        PROTO[&quot;协议栈&quot;]
    end

    APP --&gt; VETH
    VETH --&gt; PROTO
    PROTO --&gt; IPTABLES
    IPTABLES --&gt; PHYS[&quot;物理网卡&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li>Cilium 在 TC 层实现 Pod 网络</li>
<li>Service 访问仍经过 iptables（kube-proxy 维护）</li>
<li>适合内核版本较低或需要最大兼容性的场景</li>
</ul>
<h4 id="helm">Helm 安装参数<a class="headerlink" href="#helm" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--version<span class="w"> </span><span class="m">1</span>.13.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">tunnel</span><span class="o">=</span>disabled<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span><span class="s2">&quot;10.244.0.0/16&quot;</span>
</code></pre></div>
<p><strong>参数说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">值</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>tunnel</code></td>
<td style="text-align: left;">disabled</td>
<td style="text-align: left;">禁用 VxLAN 隧道，使用 direct routing</td>
</tr>
<tr>
<td style="text-align: left;"><code>autoDirectNodeRoutes</code></td>
<td style="text-align: left;">true</td>
<td style="text-align: left;">自动配置节点间路由</td>
</tr>
<tr>
<td style="text-align: left;"><code>ipv4NativeRoutingCIDR</code></td>
<td style="text-align: left;">Pod CIDR</td>
<td style="text-align: left;">不做 SNAT 的地址范围</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="84-2-kube-proxy-replacement">8.4 模式2: kube-proxy replacement<a class="headerlink" href="#84-2-kube-proxy-replacement" title="Permanent link">&para;</a></h3>
<h4 id="_129">背景<a class="headerlink" href="#_129" title="Permanent link">&para;</a></h4>
<p>此模式下 Cilium 完全替代 kube-proxy，使用 eBPF 实现 Service 负载均衡，不再需要 iptables。</p>
<h4 id="_130">原理<a class="headerlink" href="#_130" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Pod[&quot;Pod&quot;]
        APP[&quot;应用&quot;]
    end

    subgraph Host[&quot;宿主机&quot;]
        VETH[&quot;veth&lt;br/&gt;TC: eBPF&quot;]
        BPF_LB[&quot;eBPF LB&lt;br/&gt;Service 处理&quot;]
        PROTO[&quot;协议栈&quot;]
    end

    APP --&gt; VETH
    VETH --&gt; BPF_LB
    BPF_LB --&gt; PROTO
    PROTO --&gt; PHYS[&quot;物理网卡&quot;]
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li>Service ClusterIP、NodePort 由 eBPF 直接处理</li>
<li><strong>不再需要 kube-proxy 和 iptables 规则</strong></li>
<li>性能提升明显（减少 iptables 规则匹配）</li>
</ul>
<h4 id="helm_1">Helm 安装参数<a class="headerlink" href="#helm_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--version<span class="w"> </span><span class="m">1</span>.13.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">kubeProxyReplacement</span><span class="o">=</span>strict<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">k8sServiceHost</span><span class="o">=</span><span class="si">${</span><span class="nv">API_SERVER_IP</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">k8sServicePort</span><span class="o">=</span><span class="m">6443</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">tunnel</span><span class="o">=</span>disabled<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span><span class="s2">&quot;10.244.0.0/16&quot;</span>
</code></pre></div>
<p><strong>关键参数</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">值</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>kubeProxyReplacement</code></td>
<td style="text-align: left;">strict</td>
<td style="text-align: left;">严格模式，完全替代 kube-proxy</td>
</tr>
<tr>
<td style="text-align: left;"><code>k8sServiceHost</code></td>
<td style="text-align: left;">API Server IP</td>
<td style="text-align: left;">必须提供，因为没有 kube-proxy</td>
</tr>
<tr>
<td style="text-align: left;"><code>k8sServicePort</code></td>
<td style="text-align: left;">6443</td>
<td style="text-align: left;">API Server 端口</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>kubeProxyReplacement 取值</strong>：</p>
<ul>
<li><code>disabled</code>：不替代 kube-proxy</li>
<li><code>partial</code>：部分替代</li>
<li><code>strict</code>：严格替代，完全使用 eBPF</li>
</ul>
</blockquote>
<hr />
<h3 id="85-3-ebpf-host-routing">8.5 模式3: eBPF Host Routing<a class="headerlink" href="#85-3-ebpf-host-routing" title="Permanent link">&para;</a></h3>
<h4 id="_131">背景<a class="headerlink" href="#_131" title="Permanent link">&para;</a></h4>
<p>这是性能最优的模式。除了替代 kube-proxy，还使用 eBPF 绕过宿主机协议栈的路由处理。</p>
<h4 id="_132">原理<a class="headerlink" href="#_132" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Pod1[&quot;Pod1&quot;]
        APP1[&quot;应用&quot;]
    end

    subgraph Host[&quot;宿主机&quot;]
        VETH1[&quot;veth1&lt;br/&gt;TC ingress&quot;]
        BPF_REDIRECT[&quot;bpf_redirect_peer&lt;br/&gt;bpf_redirect_neigh&quot;]
        VETH2[&quot;veth2&quot;]
    end

    subgraph Pod2[&quot;Pod2&quot;]
        APP2[&quot;应用&quot;]
    end

    APP1 --&gt; VETH1
    VETH1 --&gt;|&quot;eBPF 直接重定向&lt;br/&gt;绕过协议栈&quot;| BPF_REDIRECT
    BPF_REDIRECT --&gt; VETH2
    VETH2 --&gt; APP2
</code></pre></div>
<p><strong>图解说明</strong>：</p>
<ul>
<li>使用 <code>bpf_redirect_peer</code> 和 <code>bpf_redirect_neigh</code> 函数</li>
<li><strong>绕过宿主机的协议栈处理</strong></li>
<li>同节点 Pod 通信只经过一次协议栈（Pod 内）</li>
</ul>
<h4 id="host-routing">Host Routing 的核心价值<a class="headerlink" href="#host-routing" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Traditional[&quot;传统模式（两次协议栈）&quot;]
        T_POD1[&quot;Pod1 协议栈&quot;] --&gt; T_HOST[&quot;宿主机协议栈&quot;] --&gt; T_POD2[&quot;Pod2 协议栈&quot;]
    end

    subgraph HostRouting[&quot;eBPF Host Routing（一次协议栈）&quot;]
        H_POD1[&quot;Pod1 协议栈&quot;] --&gt;|&quot;bpf_redirect&quot;| H_POD2[&quot;Pod2 协议栈&quot;]
    end
</code></pre></div>
<h4 id="helm_2">Helm 安装参数<a class="headerlink" href="#helm_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--version<span class="w"> </span><span class="m">1</span>.13.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">kubeProxyReplacement</span><span class="o">=</span>strict<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">k8sServiceHost</span><span class="o">=</span><span class="si">${</span><span class="nv">API_SERVER_IP</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">k8sServicePort</span><span class="o">=</span><span class="m">6443</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">tunnel</span><span class="o">=</span>disabled<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span><span class="s2">&quot;10.244.0.0/16&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>bpf.masquerade<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<p><strong>新增关键参数</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">值</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>bpf.masquerade</code></td>
<td style="text-align: left;">true</td>
<td style="text-align: left;">使用 eBPF 实现 SNAT（而非 iptables）</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
<strong>eBPF Host Routing 的限制</strong>：</p>
<ul>
<li>不支持 IPsec 加密</li>
<li>内核要求 5.10+</li>
<li>部分高级功能可能受限</li>
</ul>
</blockquote>
<hr />
<h3 id="86">8.6 安装参数详解<a class="headerlink" href="#86" title="Permanent link">&para;</a></h3>
<h4 id="helm-values">Helm Values 查找方法<a class="headerlink" href="#helm-values" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 添加 Cilium Helm 仓库</span>
helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>cilium<span class="w"> </span>https://helm.cilium.io/

<span class="c1"># 2. 下载 chart 查看 values.yaml</span>
helm<span class="w"> </span>pull<span class="w"> </span>cilium/cilium<span class="w"> </span>--version<span class="w"> </span><span class="m">1</span>.13.0<span class="w"> </span>--untar
cat<span class="w"> </span>cilium/values.yaml
</code></pre></div>
<p><strong>核心配置分类</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">配置类别</th>
<th style="text-align: left;">典型参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>网络模式</strong></td>
<td style="text-align: left;"><code>tunnel</code>, <code>routingMode</code>, <code>autoDirectNodeRoutes</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>kube-proxy</strong></td>
<td style="text-align: left;"><code>kubeProxyReplacement</code>, <code>k8sServiceHost</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>eBPF 功能</strong></td>
<td style="text-align: left;"><code>bpf.masquerade</code>, <code>hostRouting</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>IPAM</strong></td>
<td style="text-align: left;"><code>ipam.mode</code>, <code>ipam.operator.clusterPoolIPv4PodCIDR</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>调试</strong></td>
<td style="text-align: left;"><code>debug.enabled</code>, <code>debug.verbose</code></td>
</tr>
</tbody>
</table>
<h4 id="_133">常用安装参数对照表<a class="headerlink" href="#_133" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">需求</th>
<th style="text-align: left;">参数设置</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">使用 Direct Routing</td>
<td style="text-align: left;"><code>tunnel=disabled</code></td>
</tr>
<tr>
<td style="text-align: left;">使用 VxLAN</td>
<td style="text-align: left;"><code>tunnel=vxlan</code>（默认）</td>
</tr>
<tr>
<td style="text-align: left;">替代 kube-proxy</td>
<td style="text-align: left;"><code>kubeProxyReplacement=strict</code></td>
</tr>
<tr>
<td style="text-align: left;">启用 eBPF masquerade</td>
<td style="text-align: left;"><code>bpf.masquerade=true</code></td>
</tr>
<tr>
<td style="text-align: left;">启用 BGP</td>
<td style="text-align: left;"><code>bgpControlPlane.enabled=true</code></td>
</tr>
<tr>
<td style="text-align: left;">启用 Hubble</td>
<td style="text-align: left;"><code>hubble.enabled=true</code></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="87-cilium">8.7 Cilium 常用命令<a class="headerlink" href="#87-cilium" title="Permanent link">&para;</a></h3>
<h4 id="cilium-status">cilium status<a class="headerlink" href="#cilium-status" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Cilium 状态</span>
cilium<span class="w"> </span>status

<span class="c1"># 查看详细状态</span>
cilium<span class="w"> </span>status<span class="w"> </span>--verbose
</code></pre></div>
<p><strong>输出解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>KubeProxyReplacement</code></td>
<td style="text-align: left;">strict/partial/disabled</td>
</tr>
<tr>
<td style="text-align: left;"><code>Host Routing</code></td>
<td style="text-align: left;">Legacy（传统）或 BPF（eBPF）</td>
</tr>
<tr>
<td style="text-align: left;"><code>Masquerading</code></td>
<td style="text-align: left;">IPTables 或 BPF</td>
</tr>
<tr>
<td style="text-align: left;"><code>Tunnel Mode</code></td>
<td style="text-align: left;">Disabled/VXLAN/Geneve</td>
</tr>
</tbody>
</table>
<h4 id="cilium-bpf">cilium bpf 命令<a class="headerlink" href="#cilium-bpf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 eBPF Service 表（替代 iptables -L）</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>lb<span class="w"> </span>list

<span class="c1"># 查看连接跟踪表</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>ct<span class="w"> </span>list<span class="w"> </span>global

<span class="c1"># 查看 Endpoint 信息</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>endpoint<span class="w"> </span>list

<span class="c1"># 查看策略表</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>policy<span class="w"> </span>get<span class="w"> </span>--all
</code></pre></div>
<h4 id="cilium-monitor">cilium monitor<a class="headerlink" href="#cilium-monitor" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 实时监控数据包流向</span>
cilium<span class="w"> </span>monitor

<span class="c1"># 详细模式</span>
cilium<span class="w"> </span>monitor<span class="w"> </span>-v

<span class="c1"># 查看 datapath 事件</span>
cilium<span class="w"> </span>monitor<span class="w"> </span>--type<span class="w"> </span>trace
</code></pre></div>
<hr />
<h3 id="88-vxlan-vs-direct-routing">8.8 VxLAN vs Direct Routing<a class="headerlink" href="#88-vxlan-vs-direct-routing" title="Permanent link">&para;</a></h3>
<h4 id="_134">背景<a class="headerlink" href="#_134" title="Permanent link">&para;</a></h4>
<p>Cilium 支持两种基础网络模式：VxLAN（隧道）和 Direct Routing（路由）。</p>
<h4 id="_135">对比<a class="headerlink" href="#_135" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph VxLAN[&quot;VxLAN 模式（默认）&quot;]
        V_POD1[&quot;Pod1&lt;br/&gt;10.244.1.10&quot;] --&gt; V_ENCAP[&quot;VxLAN 封装&quot;]
        V_ENCAP --&gt; V_DECAP[&quot;VxLAN 解封装&quot;]
        V_DECAP --&gt; V_POD2[&quot;Pod2&lt;br/&gt;10.244.2.10&quot;]
    end

    subgraph DirectRouting[&quot;Direct Routing 模式&quot;]
        D_POD1[&quot;Pod1&lt;br/&gt;10.244.1.10&quot;] --&gt; D_ROUTE[&quot;路由转发&quot;]
        D_ROUTE --&gt; D_POD2[&quot;Pod2&lt;br/&gt;10.244.2.10&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">VxLAN</th>
<th style="text-align: left;">Direct Routing</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>跨子网</strong></td>
<td style="text-align: left;">✅ 支持</td>
<td style="text-align: left;">❌ 需同二层</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能</strong></td>
<td style="text-align: left;">有封装开销</td>
<td style="text-align: left;">更高</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MTU</strong></td>
<td style="text-align: left;">需调整（-50）</td>
<td style="text-align: left;">无需调整</td>
</tr>
<tr>
<td style="text-align: left;"><strong>配置</strong></td>
<td style="text-align: left;">默认</td>
<td style="text-align: left;"><code>tunnel=disabled</code></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_136">📝 章节小结<a class="headerlink" href="#_136" title="Permanent link">&para;</a></h3>
<p>本章介绍了 Cilium 的架构与安装模式：</p>
<ol>
<li><strong>Cilium 架构</strong>：</li>
<li>cilium-operator：集群级控制平面</li>
<li>cilium-agent：节点级数据平面</li>
<li>
<p>eBPF 程序：实际的数据包处理</p>
</li>
<li>
<p><strong>三种安装模式</strong>：</p>
</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">Service</th>
<th style="text-align: left;">路由</th>
<th style="text-align: left;">性能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>with kube-proxy</strong></td>
<td style="text-align: left;">iptables</td>
<td style="text-align: left;">协议栈</td>
<td style="text-align: left;">一般</td>
</tr>
<tr>
<td style="text-align: left;"><strong>kube-proxy replacement</strong></td>
<td style="text-align: left;">eBPF</td>
<td style="text-align: left;">协议栈</td>
<td style="text-align: left;">较好</td>
</tr>
<tr>
<td style="text-align: left;"><strong>eBPF Host Routing</strong></td>
<td style="text-align: left;">eBPF</td>
<td style="text-align: left;">eBPF redirect</td>
<td style="text-align: left;">最优</td>
</tr>
</tbody>
</table>
<ol>
<li><strong>关键概念澄清</strong>：</li>
<li><strong>native/direct routing</strong> = Host-GW 路由方式</li>
<li><strong>host routing</strong> = eBPF 绕过协议栈</li>
<li>
<p>两者是<strong>完全不同</strong>的概念！</p>
</li>
<li>
<p><strong>Helm 安装</strong>：</p>
</li>
<li><code>kubeProxyReplacement=strict</code>：替代 kube-proxy</li>
<li><code>bpf.masquerade=true</code>：启用 eBPF Host Routing</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>准备三套安装脚本作为基础模板</li>
<li>使用 <code>cilium status --verbose</code> 验证安装结果</li>
<li>通过 <code>cilium bpf lb list</code> 验证 kube-proxy replacement</li>
<li>参考官方 values.yaml 了解所有配置项</li>
</ol>
<p>[!IMPORTANT]
<strong>模式选择指南</strong>：</p>
<ul>
<li><strong>内核 &lt; 4.19</strong> → with kube-proxy</li>
<li><strong>内核 ≥ 4.19，追求稳定</strong> → kube-proxy replacement</li>
<li><strong>内核 ≥ 5.10，追求极致性能</strong> → eBPF Host Routing</li>
</ul>
</blockquote>
<hr />
<h2 id="9-native-routing-with-kubeproxy">第9章 Native-Routing-with-kubeProxy 模式<a class="headerlink" href="#9-native-routing-with-kubeproxy" title="Permanent link">&para;</a></h2>
<h3 id="_137">🎯 学习目标<a class="headerlink" href="#_137" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 Native Routing 与 Host-GW 的等价关系</li>
<li>掌握同节点 Pod 通信的数据包流程</li>
<li>掌握跨节点 Pod 通信的数据包流程</li>
<li>理解 32 位掩码的作用与 L3 路由转发</li>
<li>理解 Cilium eBPF ARP 劫持机制</li>
</ul>
<hr />
<h3 id="91-native-routing">9.1 Native Routing 概述<a class="headerlink" href="#91-native-routing" title="Permanent link">&para;</a></h3>
<h4 id="_138">背景<a class="headerlink" href="#_138" title="Permanent link">&para;</a></h4>
<p>Native Routing 是 Cilium 中与 VxLAN 隧道模式相对的另一种网络模式。它<strong>不使用封装</strong>，而是依赖节点间的路由进行 Pod 网络通信。</p>
<h4 id="_139">核心概念<a class="headerlink" href="#_139" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    NATIVE[&quot;Native Routing&lt;br/&gt;Cilium 术语&quot;] === DIRECT[&quot;Direct Routing&lt;br/&gt;路由模式&quot;]
    DIRECT === HOSTGW[&quot;Host-GW&lt;br/&gt;传统术语&quot;]
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>概念等价关系</strong>：</p>
<p><strong>Native Routing = Direct Routing = Host-GW</strong></p>
<p>三者描述的是同一种网络模式，只是不同场景下的叫法不同。</p>
</blockquote>
<h4 id="native-routing">启用 Native Routing<a class="headerlink" href="#native-routing" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 关键参数</span>
--set<span class="w"> </span><span class="nv">tunnel</span><span class="o">=</span>disabled<span class="w">                    </span><span class="c1"># 禁用隧道</span>
--set<span class="w"> </span><span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span><span class="w">          </span><span class="c1"># 自动配置节点路由</span>
--set<span class="w"> </span><span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span><span class="s2">&quot;10.244.0.0/16&quot;</span><span class="w">  </span><span class="c1"># 原生路由网段</span>
</code></pre></div>
<hr />
<h3 id="92-pod-32">9.2 Pod 的 32 位掩码<a class="headerlink" href="#92-pod-32" title="Permanent link">&para;</a></h3>
<h4 id="_140">背景<a class="headerlink" href="#_140" title="Permanent link">&para;</a></h4>
<p>在 Cilium 中，Pod 的 IP 地址使用 <strong>32 位掩码</strong>（/32），这与传统 CNI 有所不同。</p>
<h4 id="_141">原理<a class="headerlink" href="#_141" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod 内查看 IP</span>
$<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>eth0
inet<span class="w"> </span><span class="m">10</span>.0.2.253/32<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>eth0
</code></pre></div>
<p><strong>32 位掩码意味着什么？</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">掩码</th>
<th style="text-align: left;">含义</th>
<th style="text-align: left;">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">/24</td>
<td style="text-align: left;">同网段有 254 个主机</td>
<td style="text-align: left;">同网段走二层</td>
</tr>
<tr>
<td style="text-align: left;">/32</td>
<td style="text-align: left;">"网段"只有自己</td>
<td style="text-align: left;"><strong>与任何地址都不同网段</strong></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>graph TD
    POD[&quot;Pod&lt;br/&gt;10.0.2.253/32&quot;]

    POD --&gt; CHECK{&quot;与目的 IP 在同一网段？&quot;}
    CHECK --&gt;|&quot;永远 No&quot;| L3[&quot;走三层路由&quot;]
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>32 位掩码的设计目的</strong>：</p>
<ul>
<li>强制所有流量走 <strong>L3 路由</strong>（而非 L2 交换）</li>
<li>流量必须经过网关，便于 eBPF 程序介入处理</li>
<li>这是 Cilium 能够劫持和重定向流量的基础</li>
</ul>
</blockquote>
<hr />
<h3 id="93-pod">9.3 同节点 Pod 通信<a class="headerlink" href="#93-pod" title="Permanent link">&para;</a></h3>
<h4 id="_142">背景<a class="headerlink" href="#_142" title="Permanent link">&para;</a></h4>
<p>理解同节点 Pod 间的通信流程，是理解 Cilium 数据平面的第一步。</p>
<h4 id="_143">场景描述<a class="headerlink" href="#_143" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Pod A (10.0.2.253) → Pod B (10.0.2.36)
两个 Pod 位于同一节点
</code></pre></div>
<h4 id="_144">网络拓扑<a class="headerlink" href="#_144" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Pod_A[&quot;Pod A (10.0.2.253)&quot;]
        APP_A[&quot;应用&quot;]
        ETH_A[&quot;eth0&lt;br/&gt;10.0.2.253/32&quot;]
    end

    subgraph Host[&quot;宿主机&quot;]
        LXC_A[&quot;lxc-xxxx&lt;br/&gt;（对应 Pod A）&quot;]
        LXC_B[&quot;lxc-yyyy&lt;br/&gt;（对应 Pod B）&quot;]
        CILIUM_HOST[&quot;cilium_host&lt;br/&gt;10.0.2.131&quot;]
    end

    subgraph Pod_B[&quot;Pod B (10.0.2.36)&quot;]
        ETH_B[&quot;eth0&lt;br/&gt;10.0.2.36/32&quot;]
        APP_B[&quot;应用&quot;]
    end

    ETH_A &lt;--&gt;|&quot;veth pair&quot;| LXC_A
    ETH_B &lt;--&gt;|&quot;veth pair&quot;| LXC_B
</code></pre></div>
<h4 id="_145">路由表分析<a class="headerlink" href="#_145" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod A 内部路由表</span>
$<span class="w"> </span>ip<span class="w"> </span>route
default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.2.131<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w">        </span><span class="c1"># 默认路由，网关是 cilium_host</span>
<span class="m">10</span>.0.2.131<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>scope<span class="w"> </span>link<span class="w">         </span><span class="c1"># 网关地址的直连路由</span>
</code></pre></div>
<p><strong>关键点解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">路由条目</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>default via 10.0.2.131</code></td>
<td style="text-align: left;">所有流量发往 cilium_host</td>
</tr>
<tr>
<td style="text-align: left;"><code>10.0.2.131 dev eth0</code></td>
<td style="text-align: left;">告诉系统如何到达网关</td>
</tr>
</tbody>
</table>
<h4 id="_146">数据包流程<a class="headerlink" href="#_146" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;10.0.2.253
    participant LXC_A as lxc-A&lt;br/&gt;(宿主机)
    participant LXC_B as lxc-B&lt;br/&gt;(宿主机)
    participant PodB as Pod B&lt;br/&gt;10.0.2.36

    Note over PodA: 查路由: 目的 IP 不在同网段&lt;br/&gt;需走网关 10.0.2.131
    PodA-&gt;&gt;PodA: ARP: Who has 10.0.2.131?
    Note over PodA: eBPF 劫持 ARP 请求&lt;br/&gt;返回 lxc-A 的 MAC（非网关 MAC）
    PodA-&gt;&gt;LXC_A: 发送数据包&lt;br/&gt;dst-MAC = lxc-A 的 MAC
    Note over LXC_A: eBPF 拦截&lt;br/&gt;查询 Pod B 对应的 lxc-B
    LXC_A-&gt;&gt;LXC_B: eBPF redirect&lt;br/&gt;直接转发到 lxc-B
    LXC_B-&gt;&gt;PodB: 通过 veth pair 送入 Pod B
</code></pre></div>
<h4 id="arp">ARP 劫持机制<a class="headerlink" href="#arp" title="Permanent link">&para;</a></h4>
<p><strong>传统行为</strong> vs <strong>Cilium 行为</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">步骤</th>
<th style="text-align: left;">传统 CNI</th>
<th style="text-align: left;">Cilium</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">ARP 请求</td>
<td style="text-align: left;">请求网关 MAC</td>
<td style="text-align: left;">请求网关 MAC</td>
</tr>
<tr>
<td style="text-align: left;">ARP 响应</td>
<td style="text-align: left;">返回网关 MAC</td>
<td style="text-align: left;"><strong>返回 lxc 网卡 MAC</strong></td>
</tr>
<tr>
<td style="text-align: left;">数据包 dst-MAC</td>
<td style="text-align: left;">填写网关 MAC</td>
<td style="text-align: left;">填写 <strong>lxc 网卡 MAC</strong></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1"># 验证 ARP 响应</span>
$<span class="w"> </span>arping<span class="w"> </span>-I<span class="w"> </span>eth0<span class="w"> </span><span class="m">10</span>.0.2.131
<span class="c1"># 返回的 MAC 是 lxc 网卡的 MAC，而非 cilium_host 的 MAC</span>
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>Cilium 的 ARP 劫持</strong>：</p>
<p>Pod 认为它在和网关通信，但实际上 eBPF 程序劫持了 ARP 响应，返回的是 veth pair 对端（lxc 网卡）的 MAC 地址。这使得数据包直接发往 lxc 网卡，而非经过完整的协议栈路由。</p>
</blockquote>
<h4 id="_147">关键发现<a class="headerlink" href="#_147" title="Permanent link">&para;</a></h4>
<p>虽然路由表显示出接口是 <code>cilium_host</code>，但抓包发现：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 cilium_host 上抓包</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>cilium_host<span class="w"> </span>icmp
<span class="c1"># 没有任何包！</span>

<span class="c1"># 在 lxc-B 上抓包</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>lxc-yyyy<span class="w"> </span>icmp
<span class="c1"># 能看到 ICMP 请求和响应！</span>
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>同节点通信的精髓</strong>：</p>
<ol>
<li>路由表说走 cilium_host，但实际 eBPF 将包 redirect 到 lxc 网卡</li>
<li>数据包直接从 lxc-A → lxc-B，不经过协议栈路由</li>
<li>这就是 Cilium 的 <strong>"跳跃式转发"</strong> 特性</li>
</ol>
</blockquote>
<hr />
<h3 id="94-pod">9.4 跨节点 Pod 通信<a class="headerlink" href="#94-pod" title="Permanent link">&para;</a></h3>
<h4 id="_148">背景<a class="headerlink" href="#_148" title="Permanent link">&para;</a></h4>
<p>跨节点通信需要经过物理网络（或底层网络），流程比同节点通信多了节点间路由的步骤。</p>
<h4 id="_149">场景描述<a class="headerlink" href="#_149" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Pod A (10.0.2.253, Node 1) → Pod C (10.0.1.173, Node 2)
两个 Pod 位于不同节点
</code></pre></div>
<h4 id="_150">网络拓扑<a class="headerlink" href="#_150" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Node1[&quot;Node 1 (172.18.0.2)&quot;]
        POD_A[&quot;Pod A&lt;br/&gt;10.0.2.253&quot;]
        LXC_A[&quot;lxc-A&quot;]
        ETH0_1[&quot;eth0&lt;br/&gt;172.18.0.2&quot;]
    end

    subgraph Network[&quot;物理网络&quot;]
        SWITCH[&quot;交换机/路由器&quot;]
    end

    subgraph Node2[&quot;Node 2 (172.18.0.4)&quot;]
        ETH0_2[&quot;eth0&lt;br/&gt;172.18.0.4&quot;]
        LXC_C[&quot;lxc-C&quot;]
        POD_C[&quot;Pod C&lt;br/&gt;10.0.1.173&quot;]
    end

    POD_A --&gt; LXC_A --&gt; ETH0_1
    ETH0_1 --&gt; SWITCH
    SWITCH --&gt; ETH0_2
    ETH0_2 --&gt; LXC_C --&gt; POD_C
</code></pre></div>
<h4 id="_151">宿主机路由表<a class="headerlink" href="#_151" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Node 1 路由表</span>
$<span class="w"> </span>ip<span class="w"> </span>route
default<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.1<span class="w"> </span>dev<span class="w"> </span>eth0
<span class="m">10</span>.0.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.4<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w">     </span><span class="c1"># 去 10.0.1.x 走 Node 2</span>
<span class="m">10</span>.0.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.2.131<span class="w"> </span>dev<span class="w"> </span>cilium_host<span class="w">  </span><span class="c1"># 本节点 Pod 网段</span>
<span class="m">10</span>.0.3.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.3<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w">     </span><span class="c1"># 去 10.0.3.x 走 Node 3</span>
</code></pre></div>
<p><strong>路由表解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">目的网段</th>
<th style="text-align: left;">下一跳</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">10.0.1.0/24</td>
<td style="text-align: left;">172.18.0.4</td>
<td style="text-align: left;">Pod C 在 Node 2，走 Node 2</td>
</tr>
<tr>
<td style="text-align: left;">10.0.2.0/24</td>
<td style="text-align: left;">cilium_host</td>
<td style="text-align: left;">本节点 Pod，走内部网关</td>
</tr>
<tr>
<td style="text-align: left;">默认</td>
<td style="text-align: left;">172.18.0.1</td>
<td style="text-align: left;">其他流量走默认网关</td>
</tr>
</tbody>
</table>
<h4 id="_152">数据包流程<a class="headerlink" href="#_152" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;10.0.2.253
    participant LXC_A as lxc-A
    participant ETH1 as Node1 eth0&lt;br/&gt;172.18.0.2
    participant ETH2 as Node2 eth0&lt;br/&gt;172.18.0.4
    participant LXC_C as lxc-C
    participant PodC as Pod C&lt;br/&gt;10.0.1.173

    Note over PodA: 目的: 10.0.1.173&lt;br/&gt;走默认路由
    PodA-&gt;&gt;LXC_A: 第1跳: veth pair
    Note over LXC_A: eBPF 查路由&lt;br/&gt;目的匹配 10.0.1.0/24
    LXC_A-&gt;&gt;ETH1: 第2跳: 路由转发
    Note over ETH1: src-MAC: 172.18.0.2 的 MAC&lt;br/&gt;dst-MAC: 172.18.0.4 的 MAC
    ETH1-&gt;&gt;ETH2: 第3跳: 物理网络
    Note over ETH2: 收包后查路由&lt;br/&gt;目的 10.0.1.173 是本地 Pod
    ETH2-&gt;&gt;LXC_C: 第4跳: 转发到 lxc
    LXC_C-&gt;&gt;PodC: 第5跳: veth pair
</code></pre></div>
<h4 id="mac">MAC 地址变化<a class="headerlink" href="#mac" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Hop1[&quot;第1跳&quot;]
        SRC_MAC1[&quot;src: Pod A eth0 MAC&quot;]
        DST_MAC1[&quot;dst: lxc-A MAC&quot;]
    end

    subgraph Hop2[&quot;第2跳&quot;]
        SRC_MAC2[&quot;src: Node1 eth0 MAC&lt;br/&gt;(172.18.0.2)&quot;]
        DST_MAC2[&quot;dst: Node2 eth0 MAC&lt;br/&gt;(172.18.0.4)&quot;]
    end

    subgraph Hop3[&quot;第3跳&quot;]
        SRC_MAC3[&quot;src: Node2 eth0 MAC&quot;]
        DST_MAC3[&quot;dst: lxc-C MAC&quot;]
    end

    Hop1 --&gt; Hop2 --&gt; Hop3
</code></pre></div>
<p><strong>抓包验证</strong>（在 Node1 eth0 上）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>icmp
<span class="c1"># src-MAC: 12:00:00:02 (Node1 eth0)</span>
<span class="c1"># dst-MAC: 12:00:00:04 (Node2 eth0)</span>
<span class="c1"># src-IP: 10.0.2.253 (不变)</span>
<span class="c1"># dst-IP: 10.0.1.173 (不变)</span>
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>跨节点通信的核心规律</strong>：</p>
<ul>
<li><strong>IP 地址不变</strong>：src-IP 和 dst-IP 全程保持</li>
<li><strong>MAC 地址逐跳变化</strong>：每经过一个路由点，MAC 都会更新</li>
<li>这就是 <strong>L3 路由转发</strong> 的本质</li>
</ul>
</blockquote>
<hr />
<h3 id="95-cilium-cni">9.5 Cilium 与传统 CNI 的差异<a class="headerlink" href="#95-cilium-cni" title="Permanent link">&para;</a></h3>
<h4 id="_153">架构对比<a class="headerlink" href="#_153" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Traditional[&quot;传统 CNI (如 Flannel)&quot;]
        T_POD[&quot;Pod&quot;] --&gt; T_VETH[&quot;veth&quot;]
        T_VETH --&gt; T_BRIDGE[&quot;Linux Bridge&quot;]
        T_BRIDGE --&gt; T_ROUTE[&quot;协议栈路由&quot;]
        T_ROUTE --&gt; T_ETH[&quot;物理网卡&quot;]
    end

    subgraph Cilium[&quot;Cilium CNI&quot;]
        C_POD[&quot;Pod&quot;] --&gt; C_VETH[&quot;veth&quot;]
        C_VETH --&gt; C_LXC[&quot;lxc 网卡&quot;]
        C_LXC --&gt;|&quot;eBPF redirect&quot;| C_LXC2[&quot;lxc 网卡&quot;]
        C_LXC2 --&gt; C_POD2[&quot;目的 Pod&quot;]
    end
</code></pre></div>
<h4 id="_154">关键差异<a class="headerlink" href="#_154" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">传统 CNI</th>
<th style="text-align: left;">Cilium</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>路由执行者</strong></td>
<td style="text-align: left;">Linux 协议栈</td>
<td style="text-align: left;">eBPF 程序</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ARP 响应</strong></td>
<td style="text-align: left;">真实网关 MAC</td>
<td style="text-align: left;">lxc 网卡 MAC（劫持）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>同节点转发</strong></td>
<td style="text-align: left;">经过 Bridge</td>
<td style="text-align: left;">eBPF redirect</td>
</tr>
<tr>
<td style="text-align: left;"><strong>抓包位置</strong></td>
<td style="text-align: left;">网卡上可抓</td>
<td style="text-align: left;">部分位置抓不到</td>
</tr>
<tr>
<td style="text-align: left;"><strong>转发风格</strong></td>
<td style="text-align: left;">一跳一跳</td>
<td style="text-align: left;">"跳跃式"转发</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_155">📝 章节小结<a class="headerlink" href="#_155" title="Permanent link">&para;</a></h3>
<p>本章介绍了 Cilium Native-Routing 模式下的数据包转发流程：</p>
<ol>
<li><strong>Native Routing 概念</strong>：</li>
<li>等价于 Host-GW 模式</li>
<li>使用 <code>tunnel=disabled</code> 启用</li>
<li>
<p>依赖节点间路由（非隧道封装）</p>
</li>
<li>
<p><strong>32 位掩码的作用</strong>：</p>
</li>
<li>强制所有流量走 L3 路由</li>
<li>
<p>便于 eBPF 程序介入处理</p>
</li>
<li>
<p><strong>同节点 Pod 通信</strong>：</p>
</li>
<li>eBPF 劫持 ARP，返回 lxc 网卡 MAC</li>
<li>数据包通过 lxc 网卡直接 redirect，不走协议栈路由</li>
<li>
<p>路由表显示走 cilium_host，实际走 lxc 网卡</p>
</li>
<li>
<p><strong>跨节点 Pod 通信</strong>：</p>
</li>
<li>遵循传统 L3 路由规则</li>
<li>IP 不变，MAC 逐跳变化</li>
<li>
<p>依赖宿主机路由表（autoDirectNodeRoutes）</p>
</li>
<li>
<p><strong>与传统 CNI 的差异</strong>：</p>
</li>
<li>ARP 劫持机制</li>
<li>eBPF redirect 替代协议栈路由</li>
<li>"跳跃式"转发</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>使用 <code>tcpdump</code> 在不同接口抓包，验证数据流向</li>
<li>使用 <code>arping</code> 验证 ARP 响应的 MAC 地址</li>
<li>对比路由表和实际抓包结果，理解 eBPF redirect</li>
</ol>
<p>[!IMPORTANT]
<strong>Native Routing with kube-proxy 模式核心特点</strong>：</p>
<ul>
<li>Pod 间流量：eBPF redirect（bypass 协议栈）</li>
<li>Service 流量：iptables（kube-proxy 维护）</li>
<li>这是一个"混合"模式</li>
</ul>
</blockquote>
<hr />
<h2 id="10-native-routing-with-ebpf-hostrouting">第10章 Native-Routing-with-eBPF-HostRouting 模式<a class="headerlink" href="#10-native-routing-with-ebpf-hostrouting" title="Permanent link">&para;</a></h2>
<h3 id="_156">🎯 学习目标<a class="headerlink" href="#_156" title="Permanent link">&para;</a></h3>
<ul>
<li>掌握 eBPF Host Routing 的核心函数</li>
<li>理解 <code>bpf_redirect_peer</code> 和 <code>bpf_redirect_neigh</code> 的作用</li>
<li>掌握同节点/跨节点 Pod 通信的数据流</li>
<li>理解 TC Hook 的位置与方向</li>
<li>了解 Socket LB 机制</li>
</ul>
<hr />
<h3 id="101-ebpf-host-routing">10.1 eBPF Host Routing 概述<a class="headerlink" href="#101-ebpf-host-routing" title="Permanent link">&para;</a></h3>
<h4 id="_157">背景<a class="headerlink" href="#_157" title="Permanent link">&para;</a></h4>
<p>eBPF Host Routing 是 Cilium 的<strong>最高级模式</strong>，它在 kube-proxy replacement 基础上，进一步使用 eBPF 绕过宿主机协议栈的路由处理，实现最高性能。</p>
<h4 id="_158">核心优势<a class="headerlink" href="#_158" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Traditional[&quot;传统模式&quot;]
        T1[&quot;Pod&quot;] --&gt; T2[&quot;lxc 网卡&quot;]
        T2 --&gt; T3[&quot;协议栈&lt;br/&gt;（iptables 处理）&quot;]
        T3 --&gt; T4[&quot;物理网卡&quot;]
    end

    subgraph eBPF[&quot;eBPF Host Routing&quot;]
        E1[&quot;Pod&quot;] --&gt; E2[&quot;lxc 网卡&quot;]
        E2 --&gt;|&quot;bpf_redirect&quot;| E4[&quot;物理网卡&quot;]
    end
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心优势</strong>：跳过宿主机协议栈处理，减少：</p>
<ul>
<li>上下文切换</li>
<li>数据包拷贝</li>
<li>中断处理</li>
<li>iptables 规则匹配</li>
</ul>
</blockquote>
<hr />
<h3 id="102-ebpf">10.2 核心 eBPF 函数<a class="headerlink" href="#102-ebpf" title="Permanent link">&para;</a></h3>
<h4 id="_159">两个关键函数<a class="headerlink" href="#_159" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Functions[&quot;eBPF 核心函数&quot;]
        PEER[&quot;bpf_redirect_peer&lt;br/&gt;（内核 ≥ 5.10）&quot;]
        NEIGH[&quot;bpf_redirect_neigh&lt;br/&gt;（内核 ≥ 5.10）&quot;]
    end

    PEER --&gt;|&quot;用于&quot;| SAME[&quot;同节点 Pod 通信&quot;]
    NEIGH --&gt;|&quot;用于&quot;| CROSS[&quot;跨节点通信&quot;]
</code></pre></div>
<p><strong>函数对比</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">作用</th>
<th style="text-align: left;">跳转目标</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>bpf_redirect_peer</code></td>
<td style="text-align: left;">同节点 Pod 间 redirect</td>
<td style="text-align: left;">直接到目的 Pod 的 eth0</td>
</tr>
<tr>
<td style="text-align: left;"><code>bpf_redirect_neigh</code></td>
<td style="text-align: left;">跨节点通信 redirect</td>
<td style="text-align: left;">从 lxc 网卡到物理网卡</td>
</tr>
</tbody>
</table>
<h4 id="_160">内核版本影响<a class="headerlink" href="#_160" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">内核版本</th>
<th style="text-align: left;">可用函数</th>
<th style="text-align: left;">跳转能力</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">&lt; 5.10</td>
<td style="text-align: left;"><code>bpf_redirect</code></td>
<td style="text-align: left;">只能跳到 lxc 网卡</td>
</tr>
<tr>
<td style="text-align: left;">≥ 5.10</td>
<td style="text-align: left;"><code>bpf_redirect_peer</code></td>
<td style="text-align: left;">直接跳到 Pod 的 eth0</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>为什么需要 5.10+ 内核</strong>：</p>
<ul>
<li><code>bpf_redirect_peer</code> 在 Linux 5.10 引入</li>
<li>它允许直接跳转到 veth pair 的对端（即 Pod 的 eth0）</li>
<li>这使得数据包<strong>完全绕过宿主机协议栈</strong></li>
</ul>
</blockquote>
<hr />
<h3 id="103-pod">10.3 同节点 Pod 通信<a class="headerlink" href="#103-pod" title="Permanent link">&para;</a></h3>
<h4 id="_161">场景描述<a class="headerlink" href="#_161" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Pod A (10.0.2.253) → Pod B (10.0.2.141)
两个 Pod 位于同一节点，使用 eBPF Host Routing
</code></pre></div>
<h4 id="_162">数据包流程<a class="headerlink" href="#_162" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;eth0
    participant LXC_A as lxc-A&lt;br/&gt;TC Hook
    participant LXC_B as lxc-B
    participant PodB as Pod B&lt;br/&gt;eth0

    Note over PodA: 发送 ICMP Request
    PodA-&gt;&gt;LXC_A: 数据包到达 lxc-A
    Note over LXC_A: TC Hook 调用&lt;br/&gt;bpf_redirect_peer
    LXC_A-&gt;&gt;PodB: 直接 redirect 到 Pod B 的 eth0
    Note over PodB: 收到 ICMP Request&lt;br/&gt;（绕过 lxc-B！）

    Note over PodB: 发送 ICMP Reply
    PodB-&gt;&gt;LXC_B: 数据包到达 lxc-B
    Note over LXC_B: TC Hook 调用&lt;br/&gt;bpf_redirect_peer
    LXC_B-&gt;&gt;PodA: 直接 redirect 到 Pod A 的 eth0
    Note over PodA: 收到 ICMP Reply&lt;br/&gt;（绕过 lxc-A！）
</code></pre></div>
<h4 id="_163">抓包验证<a class="headerlink" href="#_163" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 lxc-A（Pod A 对应的网卡）抓包</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>lxc-xxxx<span class="w"> </span>icmp

<span class="c1"># 结果：只能看到 ICMP Request，没有 Reply！</span>
<span class="c1"># 原因：Reply 通过 bpf_redirect_peer 直接送到 Pod A 的 eth0</span>

<span class="c1"># 在 Pod A 内部抓包</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>icmp

<span class="c1"># 结果：ICMP Request 和 Reply 都有！</span>
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>抓包"诡异"现象</strong>：</p>
<ul>
<li>lxc 网卡上只能看到"去的包"（Request）</li>
<li>"回的包"（Reply）直接 redirect 到 Pod 的 eth0</li>
<li>这是 eBPF Host Routing 的正常行为！</li>
</ul>
</blockquote>
<hr />
<h3 id="104-pod">10.4 跨节点 Pod 通信<a class="headerlink" href="#104-pod" title="Permanent link">&para;</a></h3>
<h4 id="_164">场景描述<a class="headerlink" href="#_164" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Pod A (10.0.2.253, Node 1) → Pod C (10.0.1.193, Node 2)
两个 Pod 位于不同节点
</code></pre></div>
<h4 id="_165">数据包流程<a class="headerlink" href="#_165" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;eth0
    participant LXC_A as lxc-A&lt;br/&gt;TC Hook
    participant ETH1 as Node1 eth0
    participant ETH2 as Node2 eth0&lt;br/&gt;TC Hook
    participant PodC as Pod C&lt;br/&gt;eth0

    Note over PodA: 发送 ICMP Request
    PodA-&gt;&gt;LXC_A: 数据包到达 lxc-A
    Note over LXC_A: TC Hook 调用&lt;br/&gt;bpf_redirect_neigh
    LXC_A-&gt;&gt;ETH1: redirect 到物理网卡&lt;br/&gt;（绕过协议栈路由！）
    ETH1-&gt;&gt;ETH2: 物理网络传输
    Note over ETH2: TC Hook 调用&lt;br/&gt;bpf_redirect_peer
    ETH2-&gt;&gt;PodC: redirect 到 Pod C 的 eth0
    Note over PodC: 收到 ICMP Request
</code></pre></div>
<h4 id="_166">抓包验证<a class="headerlink" href="#_166" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Node1 的 lxc-A 抓包</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>lxc-xxxx<span class="w"> </span>icmp
<span class="c1"># 只有 ICMP Request，没有 Reply</span>

<span class="c1"># 在 Node1 的 eth0 抓包</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>icmp
<span class="c1"># Request 和 Reply 都有！</span>

<span class="c1"># 说明：</span>
<span class="c1"># - 发出的包经过 lxc 网卡</span>
<span class="c1"># - 返回的包直接 redirect 到 Pod 的 eth0，不经过 lxc</span>
</code></pre></div>
<hr />
<h3 id="105-tc-hook">10.5 TC Hook 位置与方向<a class="headerlink" href="#105-tc-hook" title="Permanent link">&para;</a></h3>
<h4 id="_167">背景<a class="headerlink" href="#_167" title="Permanent link">&para;</a></h4>
<p>理解 TC Hook 的位置和方向，是理解 Cilium 数据平面的关键。</p>
<h4 id="hook_1">四个关键 Hook<a class="headerlink" href="#hook_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Pod[&quot;Pod 网络空间&quot;]
        ETH0[&quot;eth0&quot;]
    end

    subgraph Host[&quot;宿主机网络空间&quot;]
        LXC[&quot;lxc 网卡&quot;]
        CILIUM_HOST[&quot;cilium_host&quot;]
        ETH[&quot;物理网卡 eth0&quot;]
    end

    ETH0 &lt;--&gt;|&quot;veth pair&quot;| LXC

    LXC --&gt;|&quot;from_container&lt;br/&gt;（TC ingress）&quot;| PROCESS[&quot;eBPF 处理&quot;]
    ETH --&gt;|&quot;from_netdev&lt;br/&gt;（TC ingress）&quot;| PROCESS
    PROCESS --&gt;|&quot;to_netdev&lt;br/&gt;（TC egress）&quot;| ETH
    PROCESS --&gt;|&quot;to_container&quot;| ETH0
</code></pre></div>
<p><strong>Hook 说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Hook 名称</th>
<th style="text-align: left;">位置</th>
<th style="text-align: left;">方向</th>
<th style="text-align: left;">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>from_container</code></td>
<td style="text-align: left;">lxc 网卡</td>
<td style="text-align: left;">ingress</td>
<td style="text-align: left;">处理 Pod 发出的包</td>
</tr>
<tr>
<td style="text-align: left;"><code>to_container</code></td>
<td style="text-align: left;">调用函数</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">发往 Pod 的包</td>
</tr>
<tr>
<td style="text-align: left;"><code>to_netdev</code></td>
<td style="text-align: left;">物理网卡</td>
<td style="text-align: left;">egress</td>
<td style="text-align: left;">发往外部的包</td>
</tr>
<tr>
<td style="text-align: left;"><code>from_netdev</code></td>
<td style="text-align: left;">物理网卡</td>
<td style="text-align: left;">ingress</td>
<td style="text-align: left;">收到外部的包</td>
</tr>
</tbody>
</table>
<h4 id="_168">方向判断口诀<a class="headerlink" href="#_168" title="Permanent link">&para;</a></h4>
<blockquote>
<p><strong>Ingress（进入）</strong>：数据包进入某个网卡</p>
<p><strong>Egress（发出）</strong>：数据包从某个网卡发出</p>
</blockquote>
<div class="highlight"><pre><span></span><code>从 Pod 出来 → lxc ingress → from_container
发往外部网络 → eth0 egress → to_netdev
从外部收包 → eth0 ingress → from_netdev
</code></pre></div>
<hr />
<h3 id="106-socket-lb">10.6 Socket LB 机制<a class="headerlink" href="#106-socket-lb" title="Permanent link">&para;</a></h3>
<h4 id="_169">背景<a class="headerlink" href="#_169" title="Permanent link">&para;</a></h4>
<p>在 eBPF Host Routing 模式下，Service 访问也通过 eBPF 实现（而非 iptables）。</p>
<h4 id="_170">原理<a class="headerlink" href="#_170" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant App as 应用
    participant Socket as Socket 层&lt;br/&gt;eBPF Hook
    participant Pod as 目的 Pod

    Note over App: curl ClusterIP:Port
    App-&gt;&gt;Socket: 发起连接
    Note over Socket: eBPF 拦截&lt;br/&gt;查询 Service → Pod 映射
    Socket-&gt;&gt;Socket: 替换目的 IP:Port&lt;br/&gt;（Socket LB）
    Socket-&gt;&gt;Pod: 直接连接 Pod IP
</code></pre></div>
<h4 id="iptables">与 iptables 的对比<a class="headerlink" href="#iptables" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">iptables (kube-proxy)</th>
<th style="text-align: left;">Socket LB (eBPF)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>DNAT 位置</strong></td>
<td style="text-align: left;">宿主机协议栈</td>
<td style="text-align: left;">Pod 的 Socket 层</td>
</tr>
<tr>
<td style="text-align: left;"><strong>第一跳目的 IP</strong></td>
<td style="text-align: left;">仍是 ClusterIP</td>
<td style="text-align: left;">已是 Pod IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SNAT</strong></td>
<td style="text-align: left;">需要（externalTrafficPolicy: Cluster）</td>
<td style="text-align: left;">可不需要</td>
</tr>
<tr>
<td style="text-align: left;"><strong>抓包看到的 IP</strong></td>
<td style="text-align: left;">ClusterIP → Pod IP 转换</td>
<td style="text-align: left;">直接是 Pod IP</td>
</tr>
</tbody>
</table>
<h4 id="_171">抓包验证<a class="headerlink" href="#_171" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 访问 Service</span>
$<span class="w"> </span>curl<span class="w"> </span><span class="m">172</span>.18.0.2:32000

<span class="c1"># 在 Pod 内抓包</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>port<span class="w"> </span><span class="m">80</span>

<span class="c1"># 结果：目的 IP 直接是 Pod IP，不是 NodePort IP！</span>
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Socket LB 的意义</strong>：</p>
<ul>
<li>在 Pod 发包前就完成 Service → Pod 的解析</li>
<li>数据包从发出的第一跳就是 Pod IP</li>
<li>不需要经过宿主机做 DNAT</li>
</ul>
</blockquote>
<hr />
<h3 id="107-ebpf-host-routing">10.7 eBPF Host Routing 的限制<a class="headerlink" href="#107-ebpf-host-routing" title="Permanent link">&para;</a></h3>
<h4 id="_172">不支持的场景<a class="headerlink" href="#_172" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">功能</th>
<th style="text-align: left;">是否支持</th>
<th style="text-align: left;">原因</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>IPsec 加密</strong></td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">需要经过协议栈处理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>WireGuard 加密</strong></td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">需要经过协议栈处理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>某些 NetworkPolicy</strong></td>
<td style="text-align: left;">部分</td>
<td style="text-align: left;">需要协议栈介入</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!CAUTION]
<strong>如果需要加密</strong>：</p>
<p>使用 IPsec 或 WireGuard 时，<strong>不能启用 eBPF Host Routing</strong>。
流量需要进入协议栈进行加解密处理。</p>
</blockquote>
<hr />
<h3 id="108-ebpf-host-routing">10.8 验证 eBPF Host Routing 状态<a class="headerlink" href="#108-ebpf-host-routing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Cilium 状态</span>
$<span class="w"> </span>cilium<span class="w"> </span>status<span class="w"> </span>--verbose

<span class="c1"># 关键字段</span>
KubeProxyReplacement:<span class="w">    </span>Strict
Host<span class="w"> </span>Routing:<span class="w">            </span>BPF<span class="w">     </span><span class="c1"># ← 这里显示 BPF 表示已启用</span>
Masquerading:<span class="w">            </span>BPF
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">Host Routing 值</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>Legacy</code></td>
<td style="text-align: left;">传统模式，使用协议栈路由</td>
</tr>
<tr>
<td style="text-align: left;"><code>BPF</code></td>
<td style="text-align: left;">eBPF 模式，绕过协议栈</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_173">📝 章节小结<a class="headerlink" href="#_173" title="Permanent link">&para;</a></h3>
<p>本章介绍了 Cilium 最高级模式 —— eBPF Host Routing：</p>
<ol>
<li><strong>核心函数</strong>：</li>
<li><code>bpf_redirect_peer</code>：同节点 Pod 间直接跳转</li>
<li>
<p><code>bpf_redirect_neigh</code>：跨节点通信，lxc → 物理网卡</p>
</li>
<li>
<p><strong>同节点通信</strong>：</p>
</li>
<li>lxc 网卡只能看到"去的包"</li>
<li>
<p>"回的包"直接 redirect 到 Pod 的 eth0</p>
</li>
<li>
<p><strong>跨节点通信</strong>：</p>
</li>
<li>发出的包：lxc → bpf_redirect_neigh → 物理网卡</li>
<li>
<p>收到的包：物理网卡 → bpf_redirect_peer → Pod eth0</p>
</li>
<li>
<p><strong>TC Hook</strong>：</p>
</li>
<li><code>from_container</code>：lxc ingress，处理 Pod 发出的包</li>
<li><code>from_netdev</code>：物理网卡 ingress，处理收到的包</li>
<li>
<p><code>to_netdev</code>：物理网卡 egress，处理发出的包</p>
</li>
<li>
<p><strong>Socket LB</strong>：</p>
</li>
<li>Service 解析在 Pod 的 Socket 层完成</li>
<li>
<p>第一跳目的 IP 就是 Pod IP</p>
</li>
<li>
<p><strong>限制</strong>：</p>
</li>
<li>不支持 IPsec/WireGuard 加密</li>
<li>需要内核 ≥ 5.10</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习要点</strong>：</p>
<ol>
<li>理解两个 eBPF 函数的作用</li>
<li>在不同接口抓包，验证 redirect 行为</li>
<li>用 <code>cilium status</code> 确认 Host Routing: BPF</li>
</ol>
<p>[!IMPORTANT]
<strong>模式对比总结</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">Service</th>
<th style="text-align: left;">Pod 路由</th>
<th style="text-align: left;">性能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">with kube-proxy</td>
<td style="text-align: left;">iptables</td>
<td style="text-align: left;">eBPF redirect</td>
<td style="text-align: left;">一般</td>
</tr>
<tr>
<td style="text-align: left;">kube-proxy replacement</td>
<td style="text-align: left;">eBPF</td>
<td style="text-align: left;">eBPF redirect</td>
<td style="text-align: left;">较好</td>
</tr>
<tr>
<td style="text-align: left;"><strong>eBPF Host Routing</strong></td>
<td style="text-align: left;"><strong>Socket LB</strong></td>
<td style="text-align: left;"><strong>bpf_redirect_peer/neigh</strong></td>
<td style="text-align: left;"><strong>最优</strong></td>
</tr>
</tbody>
</table>
</blockquote>
<hr />
<h2 id="11-cilium-vxlan">第11章 Cilium-VxLAN 模式<a class="headerlink" href="#11-cilium-vxlan" title="Permanent link">&para;</a></h2>
<h3 id="_174">🎯 学习目标<a class="headerlink" href="#_174" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 VxLAN 诞生的背景与解决的问题</li>
<li>掌握 VxLAN 报文结构</li>
<li>理解 VTEP、VNI 等核心概念</li>
<li>掌握 Linux 下创建 VxLAN 设备的方法</li>
<li>理解 Overlay vs Underlay 网络</li>
</ul>
<hr />
<h3 id="111-vxlan">11.1 VxLAN 诞生背景<a class="headerlink" href="#111-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="_175">背景<a class="headerlink" href="#_175" title="Permanent link">&para;</a></h4>
<p><strong>VxLAN</strong>（Virtual eXtensible Local Area Network）是由 VMware、Cisco 等厂商提出的一种 Overlay 网络技术。</p>
<h4 id="_176">解决的问题<a class="headerlink" href="#_176" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Problem[&quot;传统问题&quot;]
        P1[&quot;数据中心虚机迁移&quot;]
        P2[&quot;迁移后 IP/MAC 需保持不变&quot;]
        P3[&quot;跨三层网络无法实现&quot;]
    end

    subgraph Solution[&quot;VxLAN 方案&quot;]
        S1[&quot;将三层网络抽象为 &#39;大二层&#39;&quot;]
        S2[&quot;IP/MAC 不变迁移&quot;]
    end

    Problem --&gt; Solution
</code></pre></div>
<p><strong>核心场景</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">VxLAN 方案</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">虚机迁移</td>
<td style="text-align: left;">跨机房后 IP/MAC 变化</td>
<td style="text-align: left;">封装后传输，IP/MAC 保持</td>
</tr>
<tr>
<td style="text-align: left;">多租户隔离</td>
<td style="text-align: left;">VLAN ID 只有 4094 个</td>
<td style="text-align: left;">VNI 支持 1600 万+</td>
</tr>
<tr>
<td style="text-align: left;">跨三层通信</td>
<td style="text-align: left;">二层网络无法跨越路由器</td>
<td style="text-align: left;">Overlay 隧道穿越</td>
</tr>
</tbody>
</table>
<h4 id="_177">大二层概念<a class="headerlink" href="#_177" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph DC1[&quot;数据中心 A&quot;]
        VM1[&quot;虚机&lt;br/&gt;10.1.1.2&quot;]
        VTEP1[&quot;VTEP&quot;]
    end

    subgraph Transport[&quot;传输网络&lt;br/&gt;（复杂的路由网络）&quot;]
        R1[&quot;路由器&quot;] --- R2[&quot;路由器&quot;]
        R2 --- R3[&quot;路由器&quot;]
    end

    subgraph DC2[&quot;数据中心 B&quot;]
        VTEP2[&quot;VTEP&quot;]
        VM2[&quot;虚机&lt;br/&gt;10.1.1.2&lt;br/&gt;迁移后&quot;]
    end

    VTEP1 --&gt; Transport
    Transport --&gt; VTEP2

    classDef vtep fill:#f9f,stroke:#333
    class VTEP1,VTEP2 vtep
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>大二层的本质</strong>：</p>
<p>将中间复杂的三层路由网络<strong>抽象</strong>成一个"大交换机"。
无论底层网络多复杂，对上层应用来说就像在同一个二层局域网内。</p>
</blockquote>
<hr />
<h3 id="112-vxlan">11.2 VxLAN 报文结构<a class="headerlink" href="#112-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="_178">封装原理<a class="headerlink" href="#_178" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Original[&quot;原始数据包&quot;]
        O_ETH[&quot;原始 MAC 层&quot;]
        O_IP[&quot;原始 IP 层&quot;]
        O_TCP[&quot;原始 TCP/UDP&quot;]
        O_DATA[&quot;应用数据&quot;]
    end

    subgraph VxLAN[&quot;VxLAN 封装后&quot;]
        V_ETH[&quot;外层 MAC&quot;]
        V_IP[&quot;外层 IP&quot;]
        V_UDP[&quot;UDP 8472&quot;]
        V_HEADER[&quot;VxLAN Header&lt;br/&gt;（含 VNI）&quot;]
        V_INNER[&quot;原始完整数据包&quot;]
    end

    Original --&gt; V_INNER
</code></pre></div>
<h4 id="_179">报文各层说明<a class="headerlink" href="#_179" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">层级</th>
<th style="text-align: left;">内容</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>外层 MAC</strong></td>
<td style="text-align: left;">VTEP 的 MAC 地址</td>
<td style="text-align: left;">源/目的都是 VTEP 设备</td>
</tr>
<tr>
<td style="text-align: left;"><strong>外层 IP</strong></td>
<td style="text-align: left;">VTEP 的 IP 地址</td>
<td style="text-align: left;">如节点的物理网卡 IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>UDP</strong></td>
<td style="text-align: left;">端口 8472</td>
<td style="text-align: left;">Cilium/Flannel 使用 8472</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VxLAN Header</strong></td>
<td style="text-align: left;">8 字节，含 VNI</td>
<td style="text-align: left;">标识隧道/租户</td>
</tr>
<tr>
<td style="text-align: left;"><strong>内层包</strong></td>
<td style="text-align: left;">原始完整以太网帧</td>
<td style="text-align: left;">Pod 间通信的真实数据</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>+----------------+----------------+---------------+
|   外层 MAC     |   外层 IP      |    UDP 8472   |
+----------------+----------------+---------------+
|  VxLAN Header (VNI)  |      原始数据包         |
+----------------------+-------------------------+
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>VxLAN 的核心思想</strong>：</p>
<p>把<strong>原始数据包</strong>作为<strong>外层 UDP 的 Payload</strong>。
相当于把一个信封（原始包）塞进另一个信封（VxLAN 包）发送。</p>
</blockquote>
<hr />
<h3 id="113">11.3 核心概念<a class="headerlink" href="#113" title="Permanent link">&para;</a></h3>
<h4 id="vtep">VTEP<a class="headerlink" href="#vtep" title="Permanent link">&para;</a></h4>
<p><strong>VTEP</strong>（VxLAN Tunnel End Point）是 VxLAN 隧道的端点设备。</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Node1[&quot;Node 1&quot;]
        POD1[&quot;Pod A&quot;]
        VTEP1[&quot;VTEP&lt;br/&gt;cilium_vxlan&quot;]
        ETH1[&quot;eth0&lt;br/&gt;172.18.0.2&quot;]
    end

    subgraph Node2[&quot;Node 2&quot;]
        ETH2[&quot;eth0&lt;br/&gt;172.18.0.3&quot;]
        VTEP2[&quot;VTEP&lt;br/&gt;cilium_vxlan&quot;]
        POD2[&quot;Pod B&quot;]
    end

    POD1 --&gt; VTEP1
    VTEP1 --&gt; ETH1
    ETH1 &lt;--&gt;|&quot;VxLAN 隧道&quot;| ETH2
    ETH2 --&gt; VTEP2
    VTEP2 --&gt; POD2
</code></pre></div>
<p><strong>VTEP 的职责</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">方向</th>
<th style="text-align: left;">操作</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">发送</td>
<td style="text-align: left;"><strong>封装</strong></td>
<td style="text-align: left;">添加外层 MAC/IP/UDP/VxLAN Header</td>
</tr>
<tr>
<td style="text-align: left;">接收</td>
<td style="text-align: left;"><strong>解封装</strong></td>
<td style="text-align: left;">剥离外层，露出原始包</td>
</tr>
</tbody>
</table>
<h4 id="vni">VNI<a class="headerlink" href="#vni" title="Permanent link">&para;</a></h4>
<p><strong>VNI</strong>（VxLAN Network Identifier）是 VxLAN 的网络标识。</p>
<table>
<thead>
<tr>
<th style="text-align: left;">对比</th>
<th style="text-align: left;">VLAN ID</th>
<th style="text-align: left;">VNI</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">位数</td>
<td style="text-align: left;">12 位</td>
<td style="text-align: left;">24 位</td>
</tr>
<tr>
<td style="text-align: left;">可用数量</td>
<td style="text-align: left;">4094 个</td>
<td style="text-align: left;">约 1600 万个</td>
</tr>
<tr>
<td style="text-align: left;">用途</td>
<td style="text-align: left;">传统交换机隔离</td>
<td style="text-align: left;">大规模多租户隔离</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>在 Cilium 中</strong>：</p>
<p>VNI 的使用比较灵活，不像传统网络那样要求两端 VNI 严格匹配。
Cilium 可能会动态分配 VNI，这是虚拟化网络与传统网络的区别之一。</p>
</blockquote>
<hr />
<h3 id="114-overlay-vs-underlay">11.4 Overlay vs Underlay<a class="headerlink" href="#114-overlay-vs-underlay" title="Permanent link">&para;</a></h3>
<h4 id="_180">概念对比<a class="headerlink" href="#_180" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Overlay[&quot;Overlay 网络&quot;]
        O1[&quot;Pod 网络&quot;]
        O2[&quot;VxLAN 隧道&quot;]
        O3[&quot;逻辑上的 &#39;大二层&#39;&quot;]
    end

    subgraph Underlay[&quot;Underlay 网络&quot;]
        U1[&quot;物理网络&quot;]
        U2[&quot;节点间 IP 路由&quot;]
        U3[&quot;交换机/路由器&quot;]
    end

    Overlay -.-&gt;|&quot;运行在其上&quot;| Underlay
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Overlay</th>
<th style="text-align: left;">Underlay</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>定义</strong></td>
<td style="text-align: left;">构建在现有网络之上的逻辑网络</td>
<td style="text-align: left;">承载 Overlay 的物理网络</td>
</tr>
<tr>
<td style="text-align: left;"><strong>代表</strong></td>
<td style="text-align: left;">VxLAN、GRE、GENEVE</td>
<td style="text-align: left;">数据中心交换机、路由器</td>
</tr>
<tr>
<td style="text-align: left;"><strong>优势</strong></td>
<td style="text-align: left;">灵活、跨三层、多租户</td>
<td style="text-align: left;">性能高、延迟低</td>
</tr>
<tr>
<td style="text-align: left;"><strong>劣势</strong></td>
<td style="text-align: left;">封装开销、MTU 减少</td>
<td style="text-align: left;">配置复杂、VLAN 数量有限</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="115-linux-vxlan">11.5 Linux 创建 VxLAN 设备<a class="headerlink" href="#115-linux-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="_181">命令格式<a class="headerlink" href="#_181" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>&lt;name&gt;<span class="w"> </span><span class="nb">type</span><span class="w"> </span>vxlan<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>id<span class="w"> </span>&lt;VNI&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dev<span class="w"> </span>&lt;物理网卡&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>&lt;本端<span class="w"> </span>VTEP<span class="w"> </span>IP&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>remote<span class="w"> </span>&lt;对端<span class="w"> </span>VTEP<span class="w"> </span>IP&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dstport<span class="w"> </span>&lt;端口&gt;
</code></pre></div>
<h4 id="_182">示例<a class="headerlink" href="#_182" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Node1 创建 VxLAN 设备</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>vxlan0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>vxlan<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>id<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dev<span class="w"> </span>eth0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="m">192</span>.168.1.10<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>remote<span class="w"> </span><span class="m">192</span>.168.1.20<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dstport<span class="w"> </span><span class="m">8472</span>

<span class="c1"># 启用设备</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>vxlan0<span class="w"> </span>up

<span class="c1"># 配置 IP</span>
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.0.0.1/24<span class="w"> </span>dev<span class="w"> </span>vxlan0
</code></pre></div>
<p><strong>在对端 Node2 创建对称配置</strong>：</p>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>vxlan0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>vxlan<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>id<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dev<span class="w"> </span>eth0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="m">192</span>.168.1.20<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>remote<span class="w"> </span><span class="m">192</span>.168.1.10<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dstport<span class="w"> </span><span class="m">8472</span>

ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>vxlan0<span class="w"> </span>up
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.0.0.2/24<span class="w"> </span>dev<span class="w"> </span>vxlan0
</code></pre></div>
<h4 id="_183">验证<a class="headerlink" href="#_183" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 VxLAN 设备</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>vxlan0

<span class="c1"># 测试连通性</span>
ping<span class="w"> </span><span class="m">10</span>.0.0.2

<span class="c1"># 抓包验证</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">8472</span>
</code></pre></div>
<hr />
<h3 id="116-cilium-vxlan">11.6 Cilium 的 VxLAN 实现<a class="headerlink" href="#116-cilium-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="_184">启用方式<a class="headerlink" href="#_184" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 默认就是 VxLAN 模式，或显式指定</span>
helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--set<span class="w"> </span><span class="nv">tunnel</span><span class="o">=</span>vxlan<span class="w">    </span><span class="c1"># 或 geneve</span>
</code></pre></div>
<h4 id="cilium_2">Cilium 创建的设备<a class="headerlink" href="#cilium_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Cilium 创建的 VxLAN 设备</span>
$<span class="w"> </span>ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>cilium_vxlan

<span class="c1"># 输出示例</span>
cilium_vxlan:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1450</span><span class="w"> </span>...
<span class="w">    </span>vxlan<span class="w"> </span>id<span class="w"> </span><span class="m">1</span><span class="w"> </span>...<span class="w"> </span>dstport<span class="w"> </span><span class="m">8472</span><span class="w"> </span>...
</code></pre></div>
<h4 id="native-routing_1">与 Native Routing 的对比<a class="headerlink" href="#native-routing_1" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">VxLAN 模式</th>
<th style="text-align: left;">Native Routing 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>跨节点通信</strong></td>
<td style="text-align: left;">VxLAN 封装</td>
<td style="text-align: left;">路由转发</td>
</tr>
<tr>
<td style="text-align: left;"><strong>底层网络要求</strong></td>
<td style="text-align: left;">仅需 IP 可达</td>
<td style="text-align: left;">需要配置路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MTU</strong></td>
<td style="text-align: left;">减少（封装开销）</td>
<td style="text-align: left;">保持原始</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能</strong></td>
<td style="text-align: left;">略低（封装/解封装）</td>
<td style="text-align: left;">较高</td>
</tr>
<tr>
<td style="text-align: left;"><strong>配置复杂度</strong></td>
<td style="text-align: left;">低（默认即可）</td>
<td style="text-align: left;">较高（需路由配置）</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_185">📝 章节小结<a class="headerlink" href="#_185" title="Permanent link">&para;</a></h3>
<p>本章介绍了 VxLAN 技术及其在 Cilium 中的应用：</p>
<ol>
<li><strong>VxLAN 背景</strong>：</li>
<li>解决数据中心虚机迁移问题</li>
<li>支持大规模多租户（VNI 1600 万+）</li>
<li>
<p>将三层网络抽象为"大二层"</p>
</li>
<li>
<p><strong>报文结构</strong>：</p>
</li>
<li>外层 MAC + IP + UDP（8472） + VxLAN Header</li>
<li>内层是原始完整以太网帧</li>
<li>
<p>原始包成为外层的 Payload</p>
</li>
<li>
<p><strong>核心概念</strong>：</p>
</li>
<li><strong>VTEP</strong>：隧道端点，负责封装/解封装</li>
<li>
<p><strong>VNI</strong>：网络标识，24 位，约 1600 万个</p>
</li>
<li>
<p><strong>Overlay vs Underlay</strong>：</p>
</li>
<li>Overlay 运行在 Underlay 之上</li>
<li>
<p>VxLAN 是典型的 Overlay 技术</p>
</li>
<li>
<p><strong>Linux 创建 VxLAN</strong>：</p>
</li>
<li>使用 <code>ip link add type vxlan</code> 命令</li>
<li>
<p>需要指定 VNI、local、remote、dstport</p>
</li>
<li>
<p><strong>Cilium 实现</strong>：</p>
</li>
<li>默认使用 VxLAN 模式</li>
<li>创建 <code>cilium_vxlan</code> 设备</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>选择 VxLAN 的场景</strong>：</p>
<ul>
<li>节点跨三层网络（不在同一二层）</li>
<li>底层网络配置受限</li>
<li>快速部署，不想配置路由</li>
<li>多租户隔离需求</li>
</ul>
<p>[!IMPORTANT]
<strong>VxLAN vs Native Routing 选择</strong>：</p>
<ul>
<li><strong>同二层网络</strong> → Native Routing（性能更好）</li>
<li><strong>跨三层网络 / 配置简单</strong> → VxLAN</li>
</ul>
</blockquote>
<hr />
<h2 id="12-containerlab-vxlan">第12章 Containerlab 实现通用 VxLAN 环境<a class="headerlink" href="#12-containerlab-vxlan" title="Permanent link">&para;</a></h2>
<h3 id="_186">🎯 学习目标<a class="headerlink" href="#_186" title="Permanent link">&para;</a></h3>
<ul>
<li>掌握 Containerlab 搭建 VxLAN 实验环境</li>
<li>深入理解 VxLAN 数据包转发的三步走</li>
<li>理解 VxLAN 封装过程中 MAC 地址的变化</li>
<li>掌握 VxLAN 配置的关键参数</li>
<li>能够独立分析 VxLAN 抓包结果</li>
</ul>
<hr />
<h3 id="121">12.1 实验拓扑<a class="headerlink" href="#121" title="Permanent link">&para;</a></h3>
<h4 id="_187">背景<a class="headerlink" href="#_187" title="Permanent link">&para;</a></h4>
<p>Containerlab 是一个用于创建网络实验环境的工具，非常适合用来学习和验证网络概念。</p>
<h4 id="_188">拓扑图<a class="headerlink" href="#_188" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Node1[&quot;GW0 (网关0)&quot;]
        VXLAN0[&quot;vxlan0&lt;br/&gt;1.1.1.1/24&quot;]
        ETH2_0[&quot;eth2&lt;br/&gt;172.12.1.10&quot;]
    end

    subgraph Node2[&quot;GW1 (网关1)&quot;]
        ETH2_1[&quot;eth2&lt;br/&gt;172.12.1.11&quot;]
        VXLAN1[&quot;vxlan0&lt;br/&gt;1.1.1.2/24&quot;]
    end

    S0[&quot;Server0&lt;br/&gt;10.1.5.10&quot;] --&gt; Node1
    ETH2_0 &lt;--&gt;|&quot;物理连接&quot;| ETH2_1
    Node2 --&gt; S1[&quot;Server1&lt;br/&gt;10.1.8.10&quot;]
</code></pre></div>
<p><strong>拓扑说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">设备</th>
<th style="text-align: left;">接口</th>
<th style="text-align: left;">IP 地址</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Server0</td>
<td style="text-align: left;">eth0</td>
<td style="text-align: left;">10.1.5.10</td>
<td style="text-align: left;">源端 Pod</td>
</tr>
<tr>
<td style="text-align: left;">GW0</td>
<td style="text-align: left;">eth1</td>
<td style="text-align: left;">10.1.5.1</td>
<td style="text-align: left;">Server0 的网关</td>
</tr>
<tr>
<td style="text-align: left;">GW0</td>
<td style="text-align: left;">eth2</td>
<td style="text-align: left;">172.12.1.10</td>
<td style="text-align: left;">物理互联接口</td>
</tr>
<tr>
<td style="text-align: left;">GW0</td>
<td style="text-align: left;">vxlan0</td>
<td style="text-align: left;">1.1.1.1</td>
<td style="text-align: left;">VxLAN 隧道端点</td>
</tr>
<tr>
<td style="text-align: left;">GW1</td>
<td style="text-align: left;">vxlan0</td>
<td style="text-align: left;">1.1.1.2</td>
<td style="text-align: left;">VxLAN 隧道端点</td>
</tr>
<tr>
<td style="text-align: left;">GW1</td>
<td style="text-align: left;">eth2</td>
<td style="text-align: left;">172.12.1.11</td>
<td style="text-align: left;">物理互联接口</td>
</tr>
<tr>
<td style="text-align: left;">GW1</td>
<td style="text-align: left;">eth1</td>
<td style="text-align: left;">10.1.8.1</td>
<td style="text-align: left;">Server1 的网关</td>
</tr>
<tr>
<td style="text-align: left;">Server1</td>
<td style="text-align: left;">eth0</td>
<td style="text-align: left;">10.1.8.10</td>
<td style="text-align: left;">目的端 Pod</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="122">12.2 关键配置<a class="headerlink" href="#122" title="Permanent link">&para;</a></h3>
<h4 id="vxlan">VxLAN 接口配置<a class="headerlink" href="#vxlan" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 GW0 上配置</span>
<span class="c1"># 1. 创建 vxlan0 接口</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>vxlan0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>vxlan<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>id<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>remote<span class="w"> </span><span class="m">172</span>.12.1.11<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dstport<span class="w"> </span><span class="m">8472</span>

<span class="c1"># 2. 配置 IP 地址</span>
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.1/24<span class="w"> </span>dev<span class="w"> </span>vxlan0

<span class="c1"># 3. 启用接口</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>vxlan0<span class="w"> </span>up

<span class="c1"># 4. 添加路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.8.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">1</span>.1.1.2<span class="w"> </span>dev<span class="w"> </span>vxlan0
</code></pre></div>
<p><strong>配置参数说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">值</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>id</code></td>
<td style="text-align: left;">10</td>
<td style="text-align: left;">VNI ID，两端必须一致</td>
</tr>
<tr>
<td style="text-align: left;"><code>remote</code></td>
<td style="text-align: left;">172.12.1.11</td>
<td style="text-align: left;">对端 VTEP 的物理 IP</td>
</tr>
<tr>
<td style="text-align: left;"><code>local</code></td>
<td style="text-align: left;">(默认)</td>
<td style="text-align: left;">本端物理 IP，默认使用同网段接口</td>
</tr>
<tr>
<td style="text-align: left;"><code>dstport</code></td>
<td style="text-align: left;">8472</td>
<td style="text-align: left;">VxLAN 目的端口</td>
</tr>
</tbody>
</table>
<h4 id="_189">为什么需要两套地址？<a class="headerlink" href="#_189" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Virtual[&quot;虚拟地址（VxLAN 接口）&quot;]
        V1[&quot;1.1.1.1 (vxlan0)&quot;]
        V2[&quot;1.1.1.2 (vxlan0)&quot;]
    end

    subgraph Physical[&quot;物理地址（eth2 接口）&quot;]
        P1[&quot;172.12.1.10&quot;]
        P2[&quot;172.12.1.11&quot;]
    end

    V1 -.-&gt;|&quot;借助&quot;| P1
    V2 -.-&gt;|&quot;借助&quot;| P2
    P1 &lt;--&gt;|&quot;物理连接&quot;| P2
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>为什么需要物理地址</strong>：</p>
<p>VxLAN 接口是<strong>虚拟接口</strong>，没有物理网线连接。
数据包实际上需要通过<strong>物理接口</strong>（172.12.1.x）发送。
虚拟接口"借助"物理接口完成数据传输。</p>
</blockquote>
<hr />
<h3 id="123">12.3 数据包转发三步走<a class="headerlink" href="#123" title="Permanent link">&para;</a></h3>
<h4 id="_190">核心概念<a class="headerlink" href="#_190" title="Permanent link">&para;</a></h4>
<p>VxLAN 数据包转发可以分解为三个步骤：</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Server as Server0&lt;br/&gt;10.1.5.10
    participant GW as GW0
    participant VXLAN as vxlan0 接口
    participant ETH as eth2 接口
    participant Remote as 远端

    rect rgb(200, 230, 200)
        Note over Server,GW: 第一步：引导到网关
        Server-&gt;&gt;GW: 默认路由 via 10.1.5.1
    end

    rect rgb(200, 200, 230)
        Note over GW,VXLAN: 第二步：路由引入 VxLAN 接口
        GW-&gt;&gt;VXLAN: 路由 10.1.8.0/24 via 1.1.1.2 dev vxlan0
    end

    rect rgb(230, 200, 200)
        Note over VXLAN,Remote: 第三步：VxLAN 封装
        VXLAN-&gt;&gt;ETH: 封装 VxLAN 头部
        ETH-&gt;&gt;Remote: 发送到 remote 172.12.1.11
    end
</code></pre></div>
<h4 id="_191">三步详解<a class="headerlink" href="#_191" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">步骤</th>
<th style="text-align: left;">发生位置</th>
<th style="text-align: left;">关键操作</th>
<th style="text-align: left;">路由条目</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>第一步</strong></td>
<td style="text-align: left;">Server0</td>
<td style="text-align: left;">默认路由引导到网关</td>
<td style="text-align: left;"><code>default via 10.1.5.1</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>第二步</strong></td>
<td style="text-align: left;">GW0</td>
<td style="text-align: left;">路由引入 VxLAN 接口</td>
<td style="text-align: left;"><code>10.1.8.0/24 via 1.1.1.2 dev vxlan0</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>第三步</strong></td>
<td style="text-align: left;">vxlan0</td>
<td style="text-align: left;">VxLAN 封装 + 发送</td>
<td style="text-align: left;">查询 remote/local 配置</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>通用套路</strong>：</p>
<p>这三步是<strong>所有 Overlay 网络</strong>的通用模式：</p>
<ol>
<li>引导数据包到 VTEP 设备</li>
<li>通过路由让数据包"经过" VxLAN 接口</li>
<li>VxLAN 接口进行封装并发送</li>
</ol>
<p>无论是 VxLAN、IPIP、GRE，都是这个套路！</p>
</blockquote>
<hr />
<h3 id="124">12.4 抓包分析<a class="headerlink" href="#124" title="Permanent link">&para;</a></h3>
<h4 id="_192">抓包命令<a class="headerlink" href="#_192" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 GW0 的 eth2 接口抓包</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth2<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">8472</span><span class="w"> </span>-w<span class="w"> </span>vxlan.pcap
</code></pre></div>
<h4 id="_193">抓包结果分析<a class="headerlink" href="#_193" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>外层 MAC: aa:ce:ab:xx:xx:xx -&gt; 9a:83:2a:xx:xx:xx
外层 IP:  172.12.1.10 -&gt; 172.12.1.11
UDP:      随机端口 -&gt; 8472
VxLAN:    VNI = 10
内层 MAC: 76:29:63:xx:xx:xx -&gt; 16:26:36:xx:xx:xx
内层 IP:  10.1.5.10 -&gt; 10.1.8.10
</code></pre></div>
<h4 id="mac_1">MAC 地址来源<a class="headerlink" href="#mac_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Outer[&quot;外层 MAC&quot;]
        O_SRC[&quot;源 MAC: eth2 的 MAC&quot;]
        O_DST[&quot;目的 MAC: 对端 eth2 的 MAC&quot;]
    end

    subgraph Inner[&quot;内层 MAC&quot;]
        I_SRC[&quot;源 MAC: vxlan0 的 MAC&lt;br/&gt;（不是 Server0 的！）&quot;]
        I_DST[&quot;目的 MAC: 对端 vxlan0 的 MAC&quot;]
    end
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>内层 MAC 不是 Server 的</strong>：</p>
<p>内层源 MAC 是 <strong>vxlan0 接口</strong>的 MAC 地址，而不是 Server0 的 MAC。
这是因为数据包"经过"了 vxlan0 接口，MAC 地址会被替换。</p>
</blockquote>
<hr />
<h3 id="125-1112">12.5 为什么下一跳是 1.1.1.2？<a class="headerlink" href="#125-1112" title="Permanent link">&para;</a></h3>
<h4 id="_194">问题<a class="headerlink" href="#_194" title="Permanent link">&para;</a></h4>
<p>为什么路由是 <code>10.1.8.0/24 via 1.1.1.2</code> 而不是 <code>via 172.12.1.11</code>？</p>
<h4 id="_195">答案<a class="headerlink" href="#_195" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    A[&quot;包发往 172.12.1.11&quot;] --&gt; B{&quot;172.12.1.11 是什么接口？&quot;}
    B --&gt;|&quot;普通网卡 eth2&quot;| C[&quot;不会做 VxLAN 封装&lt;br/&gt;包直接丢弃！&quot;]

    D[&quot;包发往 1.1.1.2&quot;] --&gt; E{&quot;1.1.1.2 是什么接口？&quot;}
    E --&gt;|&quot;VxLAN 接口 vxlan0&quot;| F[&quot;触发 VxLAN 封装&lt;br/&gt;正确转发！&quot;]
</code></pre></div>
<blockquote>
<p>[!CAUTION]
<strong>关键点</strong>：</p>
<ul>
<li>下一跳必须指向 <strong>VxLAN 接口的 IP</strong>（1.1.1.2）</li>
<li>只有经过 VxLAN 接口，才会触发封装</li>
<li>如果直接指向物理 IP（172.12.1.11），包不会被封装，无法到达目的地</li>
</ul>
</blockquote>
<hr />
<h3 id="126-vxlan-ip">12.6 VxLAN 接口的 IP 地址作用<a class="headerlink" href="#126-vxlan-ip" title="Permanent link">&para;</a></h3>
<h4 id="_196">问题<a class="headerlink" href="#_196" title="Permanent link">&para;</a></h4>
<p>vxlan0 接口的 IP 地址（1.1.1.1/1.1.1.2）在通信过程中真的用到了吗？</p>
<h4 id="_197">分析<a class="headerlink" href="#_197" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">观察点</th>
<th style="text-align: left;">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">外层 IP</td>
<td style="text-align: left;">172.12.1.10 → 172.12.1.11（物理接口 IP）</td>
</tr>
<tr>
<td style="text-align: left;">内层 IP</td>
<td style="text-align: left;">10.1.5.10 → 10.1.8.10（Server IP）</td>
</tr>
<tr>
<td style="text-align: left;">vxlan0 IP</td>
<td style="text-align: left;"><strong>没有出现在数据包中</strong></td>
</tr>
</tbody>
</table>
<h4 id="_198">那为什么还需要配置？<a class="headerlink" href="#_198" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>路由匹配</strong>：下一跳 1.1.1.2 需要有对应的接口</li>
<li><strong>ARP 学习</strong>：需要知道 1.1.1.2 对应的 MAC 地址</li>
<li><strong>接口可达性</strong>：用于判断 VxLAN 隧道是否可用</li>
</ol>
<blockquote>
<p>[!NOTE]
vxlan0 的 IP 地址主要用于<strong>路由决策</strong>和 <strong>ARP 学习</strong>，
而不是直接用于数据包封装。</p>
</blockquote>
<hr />
<h3 id="127">12.7 实践练习<a class="headerlink" href="#127" title="Permanent link">&para;</a></h3>
<h4 id="1-ip-vxlan">练习 1：使用 ip 命令搭建 VxLAN<a class="headerlink" href="#1-ip-vxlan" title="Permanent link">&para;</a></h4>
<p>在两台 Linux 机器上搭建 VxLAN 隧道：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 机器 A (192.168.1.10)</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>vxlan0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>vxlan<span class="w"> </span>id<span class="w"> </span><span class="m">100</span><span class="w"> </span>remote<span class="w"> </span><span class="m">192</span>.168.1.20<span class="w"> </span>dstport<span class="w"> </span><span class="m">8472</span>
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.0.0.1/24<span class="w"> </span>dev<span class="w"> </span>vxlan0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>vxlan0<span class="w"> </span>up

<span class="c1"># 机器 B (192.168.1.20)</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>vxlan0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>vxlan<span class="w"> </span>id<span class="w"> </span><span class="m">100</span><span class="w"> </span>remote<span class="w"> </span><span class="m">192</span>.168.1.10<span class="w"> </span>dstport<span class="w"> </span><span class="m">8472</span>
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.0.0.2/24<span class="w"> </span>dev<span class="w"> </span>vxlan0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>vxlan0<span class="w"> </span>up

<span class="c1"># 测试</span>
ping<span class="w"> </span><span class="m">10</span>.0.0.2
</code></pre></div>
<h4 id="2-arp">练习 2：观察 ARP 过程<a class="headerlink" href="#2-arp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 清除 ARP 缓存</span>
ip<span class="w"> </span>neigh<span class="w"> </span>del<span class="w"> </span><span class="m">10</span>.0.0.2<span class="w"> </span>dev<span class="w"> </span>vxlan0

<span class="c1"># 抓包观察 ARP</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">8472</span>

<span class="c1"># 触发通信</span>
ping<span class="w"> </span><span class="m">10</span>.0.0.2
</code></pre></div>
<hr />
<h3 id="_199">📝 章节小结<a class="headerlink" href="#_199" title="Permanent link">&para;</a></h3>
<p>本章通过 Containerlab 实验环境，深入理解了 VxLAN 的工作原理：</p>
<ol>
<li><strong>实验拓扑</strong>：</li>
<li>Server → GW (VTEP) → 物理网络 → GW (VTEP) → Server</li>
<li>
<p>需要两套地址：虚拟地址 + 物理地址</p>
</li>
<li>
<p><strong>VxLAN 配置</strong>：</p>
</li>
<li>VNI ID 两端一致</li>
<li>remote 指向对端物理 IP</li>
<li>
<p>dstport 通常为 8472</p>
</li>
<li>
<p><strong>三步转发</strong>：</p>
</li>
<li>第一步：引导到网关（默认路由）</li>
<li>第二步：路由引入 VxLAN 接口</li>
<li>
<p>第三步：VxLAN 封装并发送</p>
</li>
<li>
<p><strong>MAC 地址变化</strong>：</p>
</li>
<li>内层 MAC：vxlan0 接口的 MAC</li>
<li>
<p>外层 MAC：物理接口的 MAC</p>
</li>
<li>
<p><strong>下一跳设置</strong>：</p>
</li>
<li>必须指向 VxLAN 接口的 IP</li>
<li>不能直接指向物理 IP</li>
</ol>
<blockquote>
<p>[!IMPORTANT]
<strong>Overlay 网络通用模式</strong>：</p>
<p>无论是 VxLAN、IPIP 还是 GRE，都遵循相同的三步走：</p>
<ol>
<li>引导数据包到隧道设备</li>
<li>路由让包"经过"隧道接口</li>
<li>隧道接口进行封装</li>
</ol>
<p>掌握这个模式，所有 Overlay 网络都能理解！</p>
</blockquote>
<hr />
<h2 id="13-cilium-vxlan-datapath">第13章 Cilium-VxLAN-DataPath<a class="headerlink" href="#13-cilium-vxlan-datapath" title="Permanent link">&para;</a></h2>
<h3 id="_200">🎯 学习目标<a class="headerlink" href="#_200" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 Cilium VxLAN 与传统 VxLAN 的差异</li>
<li>掌握 Cilium eBPF Map 存储隧道信息的方式</li>
<li>理解 to_overlay / from_overlay eBPF Hook</li>
<li>掌握 Cilium Identity 概念</li>
<li>学会使用 cilium monitor 调试数据路径</li>
</ul>
<hr />
<h3 id="131-cilium-vxlan">13.1 Cilium VxLAN 概述<a class="headerlink" href="#131-cilium-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="_201">背景<a class="headerlink" href="#_201" title="Permanent link">&para;</a></h4>
<p>Cilium 的 VxLAN 模式是其默认的 Overlay 方案，但实现方式与传统 VxLAN 有显著差异。</p>
<h4 id="vxlan_1">与传统 VxLAN 的对比<a class="headerlink" href="#vxlan_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Traditional[&quot;传统 VxLAN&quot;]
        T1[&quot;vxlan0 接口&lt;br/&gt;有 IP 地址&quot;]
        T2[&quot;路由引入流量&quot;]
        T3[&quot;VNI 固定&quot;]
    end

    subgraph Cilium[&quot;Cilium VxLAN&quot;]
        C1[&quot;cilium_vxlan&lt;br/&gt;无 IP 地址&quot;]
        C2[&quot;eBPF redirect 引入&quot;]
        C3[&quot;VNI = Identity ID&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">传统 VxLAN</th>
<th style="text-align: left;">Cilium VxLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>接口 IP</strong></td>
<td style="text-align: left;">有（用于 ARP 学习）</td>
<td style="text-align: left;">无</td>
</tr>
<tr>
<td style="text-align: left;"><strong>流量引入方式</strong></td>
<td style="text-align: left;">路由（via VxLAN 接口）</td>
<td style="text-align: left;">eBPF redirect</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VNI 来源</strong></td>
<td style="text-align: left;">静态配置</td>
<td style="text-align: left;">Cilium Identity ID</td>
</tr>
<tr>
<td style="text-align: left;"><strong>隧道信息存储</strong></td>
<td style="text-align: left;">内核配置</td>
<td style="text-align: left;">eBPF Map</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MAC 地址</strong></td>
<td style="text-align: left;">替换为 vxlan0 的 MAC</td>
<td style="text-align: left;">保留原始 Pod 的 MAC</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>Cilium VxLAN 的核心差异</strong>：</p>
<ul>
<li>不依赖路由，使用 <strong>eBPF redirect</strong> 引入流量</li>
<li>不需要在 vxlan 接口配置 IP 地址</li>
<li>VNI ID 使用 <strong>Cilium Identity</strong>，而非静态配置</li>
</ul>
</blockquote>
<hr />
<h3 id="132-cilium_vxlan">13.2 cilium_vxlan 设备<a class="headerlink" href="#132-cilium_vxlan" title="Permanent link">&para;</a></h3>
<h4 id="_202">查看设备<a class="headerlink" href="#_202" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 VxLAN 类型的设备</span>
$<span class="w"> </span>ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span><span class="nb">type</span><span class="w"> </span>vxlan

cilium_vxlan:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>...
<span class="w">    </span>vxlan<span class="w"> </span>id<span class="w"> </span><span class="m">1</span><span class="w"> </span>...<span class="w"> </span>dstport<span class="w"> </span><span class="m">8472</span><span class="w"> </span>nolearning<span class="w"> </span>...
</code></pre></div>
<h4 id="_203">奇怪之处<a class="headerlink" href="#_203" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 传统 VxLAN 会显示 remote、local 等信息</span>
<span class="c1"># Cilium 的 cilium_vxlan 几乎没有这些信息！</span>

$<span class="w"> </span>ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>cilium_vxlan
<span class="c1"># 没有 remote</span>
<span class="c1"># 没有 local </span>
<span class="c1"># 只有基本的 vxlan 配置</span>
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>为什么没有隧道信息？</strong></p>
<p>因为 Cilium 的隧道信息存储在 <strong>eBPF Map</strong> 中，而不是内核的 VxLAN 模块配置。</p>
</blockquote>
<hr />
<h3 id="133-ebpf-map">13.3 eBPF Map 存储隧道信息<a class="headerlink" href="#133-ebpf-map" title="Permanent link">&para;</a></h3>
<h4 id="_204">查看隧道信息<a class="headerlink" href="#_204" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Cilium 的隧道 Map</span>
$<span class="w"> </span>cilium<span class="w"> </span>bpf<span class="w"> </span>tunnel<span class="w"> </span>list

TUNNEL<span class="w">             </span>VALUE
<span class="m">10</span>.0.2.0/24<span class="w">        </span><span class="m">172</span>.18.0.3
<span class="m">10</span>.0.0.0/24<span class="w">        </span><span class="m">172</span>.18.0.2
</code></pre></div>
<p><strong>输出解释</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>TUNNEL</code></td>
<td style="text-align: left;">目标 Pod CIDR</td>
</tr>
<tr>
<td style="text-align: left;"><code>VALUE</code></td>
<td style="text-align: left;">对端 VTEP 的 IP（节点 IP）</td>
</tr>
</tbody>
</table>
<h4 id="map">隧道 Map 结构<a class="headerlink" href="#map" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Map[&quot;eBPF Tunnel Map&quot;]
        E1[&quot;10.0.2.0/24 → 172.18.0.3&quot;]
        E2[&quot;10.0.0.0/24 → 172.18.0.2&quot;]
    end

    POD[&quot;Pod 发包&lt;br/&gt;目标: 10.0.2.x&quot;]
    POD --&gt; E1
    E1 --&gt; VTEP[&quot;封装目标: 172.18.0.3&quot;]
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>eBPF Map 的优势</strong>：</p>
<ul>
<li>查询速度快（O(1) 复杂度）</li>
<li>可动态更新，无需重启</li>
<li>与 eBPF 程序紧密集成</li>
</ul>
</blockquote>
<hr />
<h3 id="134-cilium-identity">13.4 Cilium Identity<a class="headerlink" href="#134-cilium-identity" title="Permanent link">&para;</a></h3>
<h4 id="_205">概念<a class="headerlink" href="#_205" title="Permanent link">&para;</a></h4>
<p>Cilium 为每个 Pod 分配一个 <strong>Identity ID</strong>，用于：</p>
<ul>
<li>安全策略</li>
<li>VxLAN 封装的 VNI</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Pod 的 Identity</span>
$<span class="w"> </span>cilium<span class="w"> </span>endpoint<span class="w"> </span>list

ENDPOINT<span class="w">   </span>IDENTITY<span class="w">   </span>LABELS<span class="w">                       </span>STATUS
<span class="m">238</span><span class="w">        </span><span class="m">68863</span><span class="w">      </span>k8s:app<span class="o">=</span>web<span class="w">                  </span>ready
<span class="m">145</span><span class="w">        </span><span class="m">68863</span><span class="w">      </span>k8s:app<span class="o">=</span>web<span class="w">                  </span>ready
</code></pre></div>
<h4 id="identity-vs-endpoint">Identity vs Endpoint<a class="headerlink" href="#identity-vs-endpoint" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Identity[&quot;Identity 68863&quot;]
        E1[&quot;Endpoint 238&lt;br/&gt;Pod A&quot;]
        E2[&quot;Endpoint 145&lt;br/&gt;Pod B&quot;]
    end

    LABEL[&quot;共同标签:&lt;br/&gt;k8s:app=web&quot;] --&gt; Identity
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">概念</th>
<th style="text-align: left;">粒度</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Identity</strong></td>
<td style="text-align: left;">一类 Pod（相同标签）</td>
<td style="text-align: left;">安全策略、VNI</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Endpoint</strong></td>
<td style="text-align: left;">单个 Pod</td>
<td style="text-align: left;">具体路由、状态</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>VNI = Identity ID</strong></p>
<p>VxLAN 封装时，VNI 字段使用的是目标 Pod 的 Identity ID。
这使得同一类 Pod 共享相同的 VNI，便于策略管理。</p>
</blockquote>
<hr />
<h3 id="135">13.5 数据路径分析<a class="headerlink" href="#135" title="Permanent link">&para;</a></h3>
<h4 id="pod-vxlan">从 Pod 到 VxLAN 封装<a class="headerlink" href="#pod-vxlan" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod as Pod eth0
    participant LXC as lxc 网卡
    participant eBPF as eBPF Hook&lt;br/&gt;from_container
    participant VXLAN as cilium_vxlan
    participant Overlay as to_overlay Hook
    participant Stack as 内核协议栈
    participant ETH as eth0

    Pod-&gt;&gt;LXC: 数据包
    LXC-&gt;&gt;eBPF: TC Hook 处理
    Note over eBPF: 查询 Tunnel Map&lt;br/&gt;获取 remote IP
    eBPF-&gt;&gt;VXLAN: bpf_redirect
    Note over VXLAN: to_overlay Hook&lt;br/&gt;VxLAN 封装
    VXLAN-&gt;&gt;Stack: 封装后的 UDP 包
    Note over Stack: 第二次协议栈处理
    Stack-&gt;&gt;ETH: 发送
</code></pre></div>
<h4 id="_206">关键点<a class="headerlink" href="#_206" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>不走路由</strong>：流量通过 <code>bpf_redirect</code> 直接到 cilium_vxlan</li>
<li><strong>保留原始 MAC</strong>：因为没有经过路由替换 MAC</li>
<li><strong>两次协议栈处理</strong>：</li>
<li>第一次：Pod 内部协议栈</li>
<li>第二次：VxLAN 封装后，作为普通 UDP 包处理</li>
</ol>
<hr />
<h3 id="136-ebpf-hook">13.6 eBPF Hook 说明<a class="headerlink" href="#136-ebpf-hook" title="Permanent link">&para;</a></h3>
<h4 id="to_overlay">to_overlay<a class="headerlink" href="#to_overlay" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    LXC[&quot;lxc 网卡&lt;br/&gt;from_container&quot;] --&gt;|&quot;bpf_redirect&quot;| VXLAN[&quot;cilium_vxlan&quot;]
    VXLAN --&gt;|&quot;to_overlay&quot;| ENC[&quot;VxLAN 封装&quot;]
    ENC --&gt; STACK[&quot;内核协议栈&quot;]
</code></pre></div>
<p><strong>to_overlay 职责</strong>：</p>
<ul>
<li>接收从 lxc 网卡 redirect 过来的包</li>
<li>调用内核 VxLAN 模块进行封装</li>
<li>但不替换 MAC 地址（与传统方式不同）</li>
</ul>
<h4 id="from_overlay">from_overlay<a class="headerlink" href="#from_overlay" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    ETH[&quot;eth0&lt;br/&gt;from_netdev&quot;] --&gt; VXLAN[&quot;cilium_vxlan&quot;]
    VXLAN --&gt;|&quot;from_overlay&quot;| DEC[&quot;VxLAN 解封装&quot;]
    DEC --&gt;|&quot;bpf_redirect_peer&quot;| POD[&quot;目标 Pod eth0&quot;]
</code></pre></div>
<p><strong>from_overlay 职责</strong>：</p>
<ul>
<li>处理接收到的 VxLAN 包</li>
<li>解封装</li>
<li>直接 redirect 到目标 Pod（跳过 lxc 网卡）</li>
</ul>
<hr />
<h3 id="137">13.7 抓包分析<a class="headerlink" href="#137" title="Permanent link">&para;</a></h3>
<h4 id="vni_1">VNI 的变化<a class="headerlink" href="#vni_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 抓包观察 VNI</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">8472</span><span class="w"> </span>-w<span class="w"> </span>cilium_vxlan.pcap
</code></pre></div>
<p><strong>抓包结果</strong>：</p>
<div class="highlight"><pre><span></span><code># 去程（Request）
VNI: 68863

# 回程（Reply）
VNI: 18705
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>VNI 去回不一致</strong>：</p>
<ul>
<li>去程 VNI = 目标 Pod 的 Identity</li>
<li>回程 VNI = 源 Pod 的 Identity</li>
<li>这与传统 VxLAN "两端 VNI 必须一致" 的规则不同！</li>
</ul>
</blockquote>
<h4 id="mac_2">MAC 地址分析<a class="headerlink" href="#mac_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># 内层 MAC
源 MAC: Pod A 的 eth0 MAC（保留原始）
目的 MAC: 目标 Pod 的 MAC

# 外层 MAC
源 MAC: eth0 的 MAC
目的 MAC: 对端 eth0 的 MAC
</code></pre></div>
<hr />
<h3 id="138-cilium-monitor">13.8 使用 cilium monitor 调试<a class="headerlink" href="#138-cilium-monitor" title="Permanent link">&para;</a></h3>
<h4 id="_207">命令<a class="headerlink" href="#_207" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 进入 Cilium Agent Pod</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>cilium-xxxx<span class="w"> </span>--<span class="w"> </span>bash

<span class="c1"># 监控所有流量</span>
cilium<span class="w"> </span>monitor<span class="w"> </span>-v

<span class="c1"># 只监控特定 Pod</span>
cilium<span class="w"> </span>monitor<span class="w"> </span>--related-to<span class="w"> </span>&lt;endpoint-id&gt;
</code></pre></div>
<h4 id="_208">输出分析<a class="headerlink" href="#_208" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># 第一次协议栈处理（Pod 内部）
-&gt; endpoint 238 flow 0x1234 identity 68863
   ICMP 10.0.1.112 -&gt; 10.0.2.237

# VxLAN 封装后
&lt;- host flow 0x1234
   UDP 172.18.0.2:random -&gt; 172.18.0.3:8472

# 收到回复
-&gt; endpoint 238 flow 0x1234
   ICMP 10.0.2.237 -&gt; 10.0.1.112 (reply)
</code></pre></div>
<p><strong>关键信息</strong>：</p>
<ul>
<li><code>identity</code>：Pod 的 Identity ID</li>
<li><code>endpoint</code>：Pod 的 Endpoint ID</li>
<li>两次处理：先是 ICMP，后是 UDP（封装后）</li>
</ul>
<hr />
<h3 id="139-cilium-vxlan-vs-vxlan">13.9 Cilium VxLAN vs 传统 VxLAN 总结<a class="headerlink" href="#139-cilium-vxlan-vs-vxlan" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">方面</th>
<th style="text-align: left;">传统 VxLAN</th>
<th style="text-align: left;">Cilium VxLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>流量引入</strong></td>
<td style="text-align: left;">路由（下一跳是 VxLAN 接口 IP）</td>
<td style="text-align: left;">eBPF redirect</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VxLAN 接口 IP</strong></td>
<td style="text-align: left;">必须配置</td>
<td style="text-align: left;">不需要</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VNI</strong></td>
<td style="text-align: left;">静态配置，两端一致</td>
<td style="text-align: left;">动态（Identity），去回可不同</td>
</tr>
<tr>
<td style="text-align: left;"><strong>隧道信息存储</strong></td>
<td style="text-align: left;">内核 VxLAN 模块</td>
<td style="text-align: left;">eBPF Map</td>
</tr>
<tr>
<td style="text-align: left;"><strong>内层 MAC</strong></td>
<td style="text-align: left;">vxlan0 接口的 MAC</td>
<td style="text-align: left;">原始 Pod 的 MAC</td>
</tr>
<tr>
<td style="text-align: left;"><strong>抓包</strong></td>
<td style="text-align: left;">在 vxlan0 能看到完整流量</td>
<td style="text-align: left;">蹦蹦跳跳，需多点抓包</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_209">📝 章节小结<a class="headerlink" href="#_209" title="Permanent link">&para;</a></h3>
<p>本章深入分析了 Cilium VxLAN 的数据路径：</p>
<ol>
<li><strong>与传统 VxLAN 的差异</strong>：</li>
<li>不依赖路由，使用 eBPF redirect</li>
<li>cilium_vxlan 接口没有 IP 地址</li>
<li>
<p>VNI 使用 Identity ID</p>
</li>
<li>
<p><strong>eBPF Map 存储隧道信息</strong>：</p>
</li>
<li><code>cilium bpf tunnel list</code> 查看</li>
<li>
<p>Pod CIDR → 对端节点 IP</p>
</li>
<li>
<p><strong>Cilium Identity</strong>：</p>
</li>
<li>一类 Pod 共享一个 Identity</li>
<li>
<p>用于安全策略和 VNI</p>
</li>
<li>
<p><strong>数据路径</strong>：</p>
</li>
<li>lxc → bpf_redirect → cilium_vxlan</li>
<li>to_overlay Hook 封装</li>
<li>
<p>两次协议栈处理</p>
</li>
<li>
<p><strong>调试方法</strong>：</p>
</li>
<li><code>cilium monitor</code> 监控流量</li>
<li>多点抓包分析</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>先掌握传统 VxLAN 的"朴实"玩法</li>
<li>再理解 Cilium 的 eBPF 增强方式</li>
<li>使用 cilium monitor + 抓包 验证理解</li>
</ol>
<p>[!IMPORTANT]
<strong>Cilium VxLAN 数据路径特点</strong>：</p>
<ul>
<li>流量"蹦蹦跳跳"，不是线性经过每个设备</li>
<li>回程包可能跳过某些设备（如 lxc 网卡）</li>
<li>需要多点抓包 + cilium monitor 才能完整理解</li>
</ul>
</blockquote>
<hr />
<h2 id="14-ipsec">第14章 IPSec 手工实现<a class="headerlink" href="#14-ipsec" title="Permanent link">&para;</a></h2>
<h3 id="_210">🎯 学习目标<a class="headerlink" href="#_210" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 IPSec 的基本概念和作用</li>
<li>掌握 IPSec 的两种模式：隧道模式和传输模式</li>
<li>理解 SA（安全联盟）和 SPI（安全参数索引）</li>
<li>学会使用 ip xfrm 命令手工配置 IPSec</li>
<li>掌握 Wireshark 解密 ESP 包的方法</li>
</ul>
<hr />
<h3 id="141-ipsec">14.1 IPSec 基础<a class="headerlink" href="#141-ipsec" title="Permanent link">&para;</a></h3>
<h4 id="_211">背景<a class="headerlink" href="#_211" title="Permanent link">&para;</a></h4>
<p>IPSec（Internet Protocol Security）是一个在 IP 层提供安全性的协议族，主要用于：</p>
<ul>
<li>加密数据报文</li>
<li>保护数据机密性</li>
<li>防止中间人攻击</li>
</ul>
<h4 id="ipsec">IPSec 的特性<a class="headerlink" href="#ipsec" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Features[&quot;IPSec 特性&quot;]
        F1[&quot;机密性&lt;br/&gt;数据加密&quot;]
        F2[&quot;完整性&lt;br/&gt;数据未被篡改&quot;]
        F3[&quot;抗重放&lt;br/&gt;防止重复攻击&quot;]
        F4[&quot;来源认证&lt;br/&gt;验证发送者身份&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>机密性</strong></td>
<td style="text-align: left;">数据加密，抓包看不到明文内容</td>
</tr>
<tr>
<td style="text-align: left;"><strong>完整性</strong></td>
<td style="text-align: left;">校验数据是否被篡改</td>
</tr>
<tr>
<td style="text-align: left;"><strong>抗重放</strong></td>
<td style="text-align: left;">防止攻击者重复发送旧数据包</td>
</tr>
<tr>
<td style="text-align: left;"><strong>来源认证</strong></td>
<td style="text-align: left;">验证数据确实来自声称的发送者</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>与 TLS 的区别</strong>：</p>
<ul>
<li>TLS 工作在传输层（如 HTTPS）</li>
<li>IPSec 工作在网络层（IP 层）</li>
<li>IPSec 对上层应用透明</li>
</ul>
</blockquote>
<hr />
<h3 id="142-ipsec">14.2 IPSec 模式<a class="headerlink" href="#142-ipsec" title="Permanent link">&para;</a></h3>
<h4 id="_212">两种模式对比<a class="headerlink" href="#_212" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Transport[&quot;传输模式&quot;]
        T1[&quot;IP Header&quot;] --&gt; T2[&quot;ESP Header&quot;]
        T2 --&gt; T3[&quot;Payload&quot;]
    end

    subgraph Tunnel[&quot;隧道模式&quot;]
        N1[&quot;New IP Header&quot;] --&gt; N2[&quot;ESP Header&quot;]
        N2 --&gt; N3[&quot;Original IP Header&quot;]
        N3 --&gt; N4[&quot;Payload&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">适用场景</th>
<th style="text-align: left;">IP 头数量</th>
<th style="text-align: left;">典型应用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>传输模式</strong></td>
<td style="text-align: left;">点对点直接通信</td>
<td style="text-align: left;">1 个</td>
<td style="text-align: left;">两台主机直接加密</td>
</tr>
<tr>
<td style="text-align: left;"><strong>隧道模式</strong></td>
<td style="text-align: left;">网关间通信</td>
<td style="text-align: left;">2 个（内外）</td>
<td style="text-align: left;">CNI Pod 间通信、VPN</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>Cilium 使用隧道模式</strong>：</p>
<p>因为 Pod 间通信需要经过节点（网关），所以 Cilium IPSec 使用<strong>隧道模式</strong>。
数据包结构：<code>[新 IP][ESP][原始 IP][Payload]</code></p>
</blockquote>
<hr />
<h3 id="143-esp">14.3 ESP 封装结构<a class="headerlink" href="#143-esp" title="Permanent link">&para;</a></h3>
<h4 id="esp">ESP 头部<a class="headerlink" href="#esp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>+-------------------+
|   IP Header       |  ← 新的外层 IP（隧道模式）
+-------------------+
|   ESP Header      |  ← SPI + Sequence Number
+-------------------+
|   Original IP     |  ← 原始 IP 头（加密）
+-------------------+
|   Payload         |  ← 原始数据（加密）
+-------------------+
|   ESP Trailer     |  ← Padding + Next Header
+-------------------+
|   ESP Auth        |  ← 认证数据（可选）
+-------------------+
</code></pre></div>
<p><strong>ESP（Encapsulating Security Payload）</strong>：封装安全载荷</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SPI</strong></td>
<td style="text-align: left;">Security Parameter Index，安全参数索引</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Sequence Number</strong></td>
<td style="text-align: left;">序列号，用于抗重放</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Payload</strong></td>
<td style="text-align: left;">加密后的原始数据</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Auth Data</strong></td>
<td style="text-align: left;">认证数据（可选）</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="144">14.4 核心概念<a class="headerlink" href="#144" title="Permanent link">&para;</a></h3>
<h4 id="sasecurity-association">SA（Security Association）<a class="headerlink" href="#sasecurity-association" title="Permanent link">&para;</a></h4>
<p><strong>安全联盟</strong>：定义了 IPSec 通信的参数</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 SA</span>
$<span class="w"> </span>ip<span class="w"> </span>xfrm<span class="w"> </span>state

src<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.73
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x00000978<span class="w"> </span>...
<span class="w">    </span>enc<span class="w"> </span>cbc<span class="o">(</span>aes<span class="o">)</span><span class="w"> </span>0x2668a9a6...
</code></pre></div>
<p>SA 包含的信息：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>src/dst</code></td>
<td style="text-align: left;">源和目的 IP</td>
</tr>
<tr>
<td style="text-align: left;"><code>proto</code></td>
<td style="text-align: left;">协议（ESP）</td>
</tr>
<tr>
<td style="text-align: left;"><code>spi</code></td>
<td style="text-align: left;">安全参数索引</td>
</tr>
<tr>
<td style="text-align: left;"><code>mode</code></td>
<td style="text-align: left;">模式（tunnel/transport）</td>
</tr>
<tr>
<td style="text-align: left;"><code>enc</code></td>
<td style="text-align: left;">加密算法和密钥</td>
</tr>
</tbody>
</table>
<h4 id="spisecurity-parameter-index">SPI（Security Parameter Index）<a class="headerlink" href="#spisecurity-parameter-index" title="Permanent link">&para;</a></h4>
<p><strong>安全参数索引</strong>：32 位数值，用于标识 SA</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 抓包中查看 SPI</span>
<span class="c1"># ESP Header 中包含 SPI 字段</span>
SPI:<span class="w"> </span>0x00000978
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>解密 ESP 包需要</strong>：</p>
<ol>
<li>SPI（标识使用哪个 SA）</li>
<li>加密算法</li>
<li>密钥（Key）</li>
</ol>
</blockquote>
<hr />
<h3 id="145-ip-xfrm">14.5 ip xfrm 命令<a class="headerlink" href="#145-ip-xfrm" title="Permanent link">&para;</a></h3>
<h4 id="_213">命令框架<a class="headerlink" href="#_213" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># xfrm = transform（转换）</span>
<span class="c1"># 用于配置 IPSec</span>

<span class="c1"># 查看 State（安全联盟）</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>state

<span class="c1"># 查看 Policy（安全策略）</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>policy

<span class="c1"># 简写</span>
ip<span class="w"> </span>x<span class="w"> </span>s<span class="w">    </span><span class="c1"># state</span>
ip<span class="w"> </span>x<span class="w"> </span>p<span class="w">    </span><span class="c1"># policy</span>

<span class="c1"># 清空配置</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>state<span class="w"> </span>flush
ip<span class="w"> </span>xfrm<span class="w"> </span>policy<span class="w"> </span>flush
</code></pre></div>
<h4 id="state-vs-policy">State vs Policy<a class="headerlink" href="#state-vs-policy" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对象</th>
<th style="text-align: left;">作用</th>
<th style="text-align: left;">包含内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>State</strong></td>
<td style="text-align: left;">定义如何加密</td>
<td style="text-align: left;">SPI、算法、密钥</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Policy</strong></td>
<td style="text-align: left;">定义哪些流量需要加密</td>
<td style="text-align: left;">源/目的、方向</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="146-ipsec">14.6 手工配置 IPSec<a class="headerlink" href="#146-ipsec" title="Permanent link">&para;</a></h3>
<h4 id="_214">实验拓扑<a class="headerlink" href="#_214" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Node1[&quot;节点 1 (192.168.2.71)&quot;]
        NS1[&quot;ns1&lt;br/&gt;1.1.1.2&quot;]
        VETH1[&quot;veth&quot;]
    end

    subgraph Node2[&quot;节点 2 (192.168.2.73)&quot;]
        VETH2[&quot;veth&quot;]
        NS2[&quot;ns1&lt;br/&gt;1.1.2.2&quot;]
    end

    NS1 --&gt; VETH1
    VETH1 &lt;--&gt;|&quot;IPSec 隧道&quot;| VETH2
    VETH2 --&gt; NS2
</code></pre></div>
<h4 id="1">步骤 1：创建网络命名空间<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 节点 1 (192.168.2.71)</span>
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>ns1
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>veth<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>ceth0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>ceth0<span class="w"> </span>netns<span class="w"> </span>ns1

<span class="c1"># 配置 IP</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.2/24<span class="w"> </span>dev<span class="w"> </span>ceth0
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>ceth0<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up

<span class="c1"># 添加路由</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">1</span>.1.1.1<span class="w"> </span>dev<span class="w"> </span>ceth0
</code></pre></div>
<h4 id="2">步骤 2：添加路由<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 节点 1：去往 1.1.2.0/24 走 192.168.2.73</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.2.73<span class="w"> </span>src<span class="w"> </span><span class="m">192</span>.168.2.71

<span class="c1"># 节点 2：去往 1.1.1.0/24 走 192.168.2.71</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span>src<span class="w"> </span><span class="m">192</span>.168.2.73
</code></pre></div>
<h4 id="3-ipsec-state">步骤 3：配置 IPSec State<a class="headerlink" href="#3-ipsec-state" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 节点 1：添加 State</span>
<span class="c1"># 方向：71 -&gt; 73（出）</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>state<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>src<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.73<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x00000978<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>mode<span class="w"> </span>tunnel<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>enc<span class="w"> </span><span class="s2">&quot;cbc(aes)&quot;</span><span class="w"> </span>0x2668a9a6b3c4d5e6f7a8b9c0d1e2f3a4

<span class="c1"># 方向：73 -&gt; 71（入）</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>state<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>src<span class="w"> </span><span class="m">192</span>.168.2.73<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x00000978<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>mode<span class="w"> </span>tunnel<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>enc<span class="w"> </span><span class="s2">&quot;cbc(aes)&quot;</span><span class="w"> </span>0x2668a9a6b3c4d5e6f7a8b9c0d1e2f3a4
</code></pre></div>
<h4 id="4-ipsec-policy">步骤 4：配置 IPSec Policy<a class="headerlink" href="#4-ipsec-policy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 出方向 Policy</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>policy<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>src<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span>dst<span class="w"> </span><span class="m">1</span>.1.2.0/24<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dir<span class="w"> </span>out<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>tmpl<span class="w"> </span>src<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.73<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>mode<span class="w"> </span>tunnel

<span class="c1"># 入方向 Policy</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>policy<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>src<span class="w"> </span><span class="m">1</span>.1.2.0/24<span class="w"> </span>dst<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dir<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>tmpl<span class="w"> </span>src<span class="w"> </span><span class="m">192</span>.168.2.73<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>mode<span class="w"> </span>tunnel

<span class="c1"># 转发 Policy</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>policy<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>src<span class="w"> </span><span class="m">1</span>.1.2.0/24<span class="w"> </span>dst<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dir<span class="w"> </span>fwd<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>tmpl<span class="w"> </span>src<span class="w"> </span><span class="m">192</span>.168.2.73<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>mode<span class="w"> </span>tunnel
</code></pre></div>
<hr />
<h3 id="147">14.7 验证配置<a class="headerlink" href="#147" title="Permanent link">&para;</a></h3>
<h4 id="state">查看 State<a class="headerlink" href="#state" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>xfrm<span class="w"> </span>state

src<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.73
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x00000978<span class="w"> </span>reqid<span class="w"> </span><span class="m">16385</span><span class="w"> </span>mode<span class="w"> </span>tunnel
<span class="w">    </span>replay-window<span class="w"> </span><span class="m">0</span><span class="w"> </span>
<span class="w">    </span>enc<span class="w"> </span>cbc<span class="o">(</span>aes<span class="o">)</span><span class="w"> </span>0x2668a9a6b3c4d5e6f7a8b9c0d1e2f3a4

src<span class="w"> </span><span class="m">192</span>.168.2.73<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.71
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x00000978<span class="w"> </span>reqid<span class="w"> </span><span class="m">16385</span><span class="w"> </span>mode<span class="w"> </span>tunnel
<span class="w">    </span>replay-window<span class="w"> </span><span class="m">0</span><span class="w"> </span>
<span class="w">    </span>enc<span class="w"> </span>cbc<span class="o">(</span>aes<span class="o">)</span><span class="w"> </span>0x2668a9a6b3c4d5e6f7a8b9c0d1e2f3a4
</code></pre></div>
<h4 id="policy">查看 Policy<a class="headerlink" href="#policy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>xfrm<span class="w"> </span>policy

src<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span>dst<span class="w"> </span><span class="m">1</span>.1.2.0/24<span class="w"> </span>
<span class="w">    </span>dir<span class="w"> </span>out<span class="w"> </span>priority<span class="w"> </span><span class="m">0</span><span class="w"> </span>
<span class="w">    </span>tmpl<span class="w"> </span>src<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.73
<span class="w">        </span>proto<span class="w"> </span>esp<span class="w"> </span>mode<span class="w"> </span>tunnel
</code></pre></div>
<h4 id="_215">抓包验证<a class="headerlink" href="#_215" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 抓 ESP 包</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>esp

<span class="c1"># 测试连通性</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ping<span class="w"> </span><span class="m">1</span>.1.2.2
</code></pre></div>
<hr />
<h3 id="148-wireshark-esp">14.8 Wireshark 解密 ESP<a class="headerlink" href="#148-wireshark-esp" title="Permanent link">&para;</a></h3>
<h4 id="_216">配置步骤<a class="headerlink" href="#_216" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>打开 Preferences</strong>：Edit → Preferences</li>
<li><strong>找到 ESP 协议</strong>：Protocols → ESP</li>
<li><strong>添加 SA</strong>：ESP SAs → Edit</li>
</ol>
<h4 id="_217">填写信息<a class="headerlink" href="#_217" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Protocol</td>
<td style="text-align: left;">IPv4</td>
</tr>
<tr>
<td style="text-align: left;">Src IP</td>
<td style="text-align: left;">* 或具体 IP</td>
</tr>
<tr>
<td style="text-align: left;">Dest IP</td>
<td style="text-align: left;">* 或具体 IP</td>
</tr>
<tr>
<td style="text-align: left;">SPI</td>
<td style="text-align: left;">从抓包中复制（如 0x00000978）</td>
</tr>
<tr>
<td style="text-align: left;">Encryption</td>
<td style="text-align: left;">AES-CBC</td>
</tr>
<tr>
<td style="text-align: left;">Encryption Key</td>
<td style="text-align: left;">密钥（16 进制）</td>
</tr>
</tbody>
</table>
<h4 id="_218">解密结果<a class="headerlink" href="#_218" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># 解密前
ESP (Encapsulating Security Payload)
    SPI: 0x00000978
    [Encrypted Data]

# 解密后
ESP (Encapsulating Security Payload)
    SPI: 0x00000978
    Inner IP: 1.1.1.2 -&gt; 1.1.2.2
    ICMP: Echo Request
</code></pre></div>
<hr />
<h3 id="149-cilium-ipsec">14.9 Cilium IPSec 的特殊之处<a class="headerlink" href="#149-cilium-ipsec" title="Permanent link">&para;</a></h3>
<h4 id="ipsec_1">与通用 IPSec 的差异<a class="headerlink" href="#ipsec_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Cilium 的 IPSec State</span>
$<span class="w"> </span>ip<span class="w"> </span>xfrm<span class="w"> </span>state

src<span class="w"> </span><span class="m">10</span>.0.0.165<span class="w"> </span>dst<span class="w"> </span><span class="m">10</span>.0.0.187
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x00000003<span class="w"> </span>...
<span class="w">    </span>mark<span class="w"> </span>0x3cb6<span class="w"> </span>...<span class="w">  </span><span class="c1"># ← Cilium 特有</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特点</th>
<th style="text-align: left;">通用 IPSec</th>
<th style="text-align: left;">Cilium IPSec</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>mark 字段</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">有（用于流量匹配）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>外层 IP</strong></td>
<td style="text-align: left;">节点 IP（如 172.18.0.x）</td>
<td style="text-align: left;">Pod CIDR IP（如 10.0.0.x）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>密钥管理</strong></td>
<td style="text-align: left;">手工或 IKE</td>
<td style="text-align: left;">Cilium 自动管理</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
<strong>Cilium IPSec 的外层 IP 不是节点 IP</strong>：</p>
<p>与 VxLAN 不同，Cilium IPSec 的外层 IP 使用 Pod CIDR 的 IP。
这需要通过<strong>源地址路由（SBR）</strong>来实现。</p>
</blockquote>
<hr />
<h3 id="1410">14.10 实践练习<a class="headerlink" href="#1410" title="Permanent link">&para;</a></h3>
<h4 id="1-ipsec">练习 1：手工配置 IPSec<a class="headerlink" href="#1-ipsec" title="Permanent link">&para;</a></h4>
<p>按照本章步骤，在两个 Linux 节点间配置 IPSec 隧道：</p>
<ol>
<li>创建网络命名空间</li>
<li>添加路由</li>
<li>配置 State 和 Policy</li>
<li>验证 ping 连通性</li>
<li>抓包查看 ESP 封装</li>
</ol>
<h4 id="2-wireshark">练习 2：使用 Wireshark 解密<a class="headerlink" href="#2-wireshark" title="Permanent link">&para;</a></h4>
<ol>
<li>抓取 ESP 包</li>
<li>配置 ESP SA 解密</li>
<li>查看解密后的原始内容</li>
</ol>
<hr />
<h3 id="_219">📝 章节小结<a class="headerlink" href="#_219" title="Permanent link">&para;</a></h3>
<p>本章介绍了 IPSec 的基础知识和手工配置方法：</p>
<ol>
<li><strong>IPSec 基础</strong>：</li>
<li>机密性、完整性、抗重放、来源认证</li>
<li>
<p>工作在 IP 层</p>
</li>
<li>
<p><strong>两种模式</strong>：</p>
</li>
<li>传输模式：点对点</li>
<li>
<p>隧道模式：网关间（Cilium 使用）</p>
</li>
<li>
<p><strong>核心概念</strong>：</p>
</li>
<li>SA：安全联盟，定义加密参数</li>
<li>
<p>SPI：安全参数索引，标识 SA</p>
</li>
<li>
<p><strong>ip xfrm 命令</strong>：</p>
</li>
<li><code>ip xfrm state</code>：查看/配置 SA</li>
<li>
<p><code>ip xfrm policy</code>：查看/配置策略</p>
</li>
<li>
<p><strong>手工配置步骤</strong>：</p>
</li>
<li>创建网络环境</li>
<li>添加路由</li>
<li>配置 State（加密参数）</li>
<li>配置 Policy（流量匹配）</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>先在空白环境练习手工配置</li>
<li>使用 Wireshark 解密验证理解</li>
<li>再对比 Cilium IPSec 的特殊实现</li>
</ol>
<p>[!IMPORTANT]
<strong>IPSec 配置要点</strong>：</p>
<ul>
<li>State 需要双向配置（出和入）</li>
<li>Policy 需要 out/in/fwd 三个方向</li>
<li>两端的 SPI、算法、密钥必须匹配</li>
</ul>
</blockquote>
<hr />
<h2 id="15-cilium-ipsec-datapath">第15章 Cilium-IPSec-DataPath<a class="headerlink" href="#15-cilium-ipsec-datapath" title="Permanent link">&para;</a></h2>
<h3 id="_220">🎯 学习目标<a class="headerlink" href="#_220" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 Cilium IPSec 的部署和配置方式</li>
<li>掌握 mark 字段在 IPSec 中的作用</li>
<li>理解 SBR（源地址路由）的工作原理</li>
<li>分析 Cilium IPSec 的数据路径</li>
<li>理解外层 IP 为何使用 cilium_host 地址</li>
</ul>
<hr />
<h3 id="151-cilium-ipsec">15.1 Cilium IPSec 部署<a class="headerlink" href="#151-cilium-ipsec" title="Permanent link">&para;</a></h3>
<h4 id="_221">背景<a class="headerlink" href="#_221" title="Permanent link">&para;</a></h4>
<p>Cilium 支持 IPSec 加密模式，可以对 Pod 间的流量进行加密。部署时需要：</p>
<ol>
<li>生成加密密钥</li>
<li>配置 Cilium 启用 IPSec</li>
</ol>
<h4 id="_222">部署配置<a class="headerlink" href="#_222" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建加密密钥 Secret</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium-ipsec-keys</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
<span class="nt">stringData</span><span class="p">:</span>
<span class="w">  </span><span class="nt">keys</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3</span><span class="nv"> </span><span class="s">rfc4106(gcm(aes))</span><span class="nv"> </span><span class="s">2668a9a6b3c4d5e6f7a8b9c0d1e2f3a4</span><span class="nv"> </span><span class="s">128&quot;</span>
</code></pre></div>
<p><strong>密钥格式说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>3</code></td>
<td style="text-align: left;">SPI（安全参数索引）</td>
</tr>
<tr>
<td style="text-align: left;"><code>rfc4106(gcm(aes))</code></td>
<td style="text-align: left;">加密算法</td>
</tr>
<tr>
<td style="text-align: left;"><code>2668a9a6...</code></td>
<td style="text-align: left;">密钥（128 位）</td>
</tr>
<tr>
<td style="text-align: left;"><code>128</code></td>
<td style="text-align: left;">密钥长度</td>
</tr>
</tbody>
</table>
<h4 id="helm_3">Helm 安装选项<a class="headerlink" href="#helm_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>encryption.enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>encryption.type<span class="o">=</span>ipsec
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>注意</strong>：Cilium IPSec 模式通常需要使用传统 kube-proxy，不支持完全替换 kube-proxy 的模式。
这是因为 IPSec 使用 xfrm 框架，与完全 eBPF 替换存在兼容性问题。</p>
</blockquote>
<hr />
<h3 id="152-cilium-ipsec-mark">15.2 Cilium IPSec 的 mark 字段<a class="headerlink" href="#152-cilium-ipsec-mark" title="Permanent link">&para;</a></h3>
<h4 id="ipsec_2">与通用 IPSec 的差异<a class="headerlink" href="#ipsec_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 通用 IPSec（无 mark）</span>
$<span class="w"> </span>ip<span class="w"> </span>xfrm<span class="w"> </span>state
src<span class="w"> </span><span class="m">192</span>.168.2.71<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.2.73
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x00000978<span class="w"> </span>...
<span class="w">    </span>enc<span class="w"> </span>cbc<span class="o">(</span>aes<span class="o">)</span><span class="w"> </span>0x2668a9a6...

<span class="c1"># Cilium IPSec（有 mark）</span>
$<span class="w"> </span>ip<span class="w"> </span>xfrm<span class="w"> </span>state
src<span class="w"> </span><span class="m">10</span>.0.0.159<span class="w"> </span>dst<span class="w"> </span><span class="m">10</span>.0.0.213
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x00000003<span class="w"> </span>...
<span class="w">    </span>mark<span class="w"> </span>0xd00/0xf00<span class="w"> </span>output<span class="w"> </span>mark<span class="w"> </span>0xe00/0xf00
<span class="w">    </span>enc<span class="w"> </span>cbc<span class="o">(</span>aes<span class="o">)</span><span class="w"> </span>0x2668a9a6...
</code></pre></div>
<p><strong>mark 字段的作用</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>mark 0xd00/0xf00</code></td>
<td style="text-align: left;">入向流量匹配标记</td>
</tr>
<tr>
<td style="text-align: left;"><code>output mark 0xe00/0xf00</code></td>
<td style="text-align: left;">出向流量标记</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>mark 的核心作用</strong>：</p>
<p>mark 用于将流量与特定的 IPSec SA（安全联盟）关联。
Cilium 通过 mark 实现流量分类和路由选择。</p>
</blockquote>
<hr />
<h3 id="153-sbr">15.3 SBR（源地址路由）机制<a class="headerlink" href="#153-sbr" title="Permanent link">&para;</a></h3>
<h4 id="_223">原理<a class="headerlink" href="#_223" title="Permanent link">&para;</a></h4>
<p>SBR（Source Based Routing，源地址路由）是 Cilium IPSec 的关键机制。</p>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Traditional[&quot;传统路由（基于目的地址）&quot;]
        T1[&quot;查看目的 IP&quot;]
        T2[&quot;匹配路由表&quot;]
        T3[&quot;转发到下一跳&quot;]
        T1 --&gt; T2 --&gt; T3
    end

    subgraph SBR[&quot;源地址路由&quot;]
        S1[&quot;查看源 IP&quot;]
        S2[&quot;匹配 ip rule&quot;]
        S3[&quot;选择特定路由表&quot;]
        S4[&quot;转发&quot;]
        S1 --&gt; S2 --&gt; S3 --&gt; S4
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">路由方式</th>
<th style="text-align: left;">匹配依据</th>
<th style="text-align: left;">典型应用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>DBR</strong> (Destination Based)</td>
<td style="text-align: left;">目的 IP</td>
<td style="text-align: left;">默认路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SBR</strong> (Source Based)</td>
<td style="text-align: left;">源 IP</td>
<td style="text-align: left;">IPSec、多网卡、策略路由</td>
</tr>
</tbody>
</table>
<h4 id="sbr">为什么需要 SBR<a class="headerlink" href="#sbr" title="Permanent link">&para;</a></h4>
<p>在 Cilium IPSec 中：</p>
<ul>
<li>IPSec 端点使用 <code>cilium_host</code> 的 IP（如 10.0.0.159）</li>
<li>而非节点的物理网卡 IP（如 172.18.0.2）</li>
<li>需要将流量引导到 <code>cilium_host</code> 进行 IPSec 处理</li>
</ul>
<hr />
<h3 id="154-ip-rule">15.4 ip rule 配置分析<a class="headerlink" href="#154-ip-rule" title="Permanent link">&para;</a></h3>
<h4 id="ip-rule">查看 ip rule<a class="headerlink" href="#ip-rule" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>rule<span class="w"> </span>list

<span class="m">0</span>:<span class="w">      </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span><span class="nb">local</span>
<span class="m">100</span>:<span class="w">    </span>from<span class="w"> </span>all<span class="w"> </span>fwmark<span class="w"> </span>0xd00/0xf00<span class="w"> </span>lookup<span class="w"> </span><span class="m">200</span>
<span class="m">101</span>:<span class="w">    </span>from<span class="w"> </span>all<span class="w"> </span>fwmark<span class="w"> </span>0xe00/0xf00<span class="w"> </span>lookup<span class="w"> </span><span class="m">200</span>
<span class="m">32766</span>:<span class="w">  </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span>main
<span class="m">32767</span>:<span class="w">  </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span>default
</code></pre></div>
<p><strong>规则解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">优先级</th>
<th style="text-align: left;">规则</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">0</td>
<td style="text-align: left;">lookup local</td>
<td style="text-align: left;">本地路由</td>
</tr>
<tr>
<td style="text-align: left;">100</td>
<td style="text-align: left;">fwmark 0xd00 → table 200</td>
<td style="text-align: left;">IPSec 入向流量</td>
</tr>
<tr>
<td style="text-align: left;">101</td>
<td style="text-align: left;">fwmark 0xe00 → table 200</td>
<td style="text-align: left;">IPSec 出向流量</td>
</tr>
<tr>
<td style="text-align: left;">32766</td>
<td style="text-align: left;">lookup main</td>
<td style="text-align: left;">主路由表</td>
</tr>
</tbody>
</table>
<h4 id="200">查看路由表 200<a class="headerlink" href="#200" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span><span class="m">200</span>

<span class="m">10</span>.0.0.0/24<span class="w"> </span>dev<span class="w"> </span>cilium_host<span class="w"> </span>scope<span class="w"> </span>link
<span class="m">10</span>.0.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.0.1<span class="w"> </span>dev<span class="w"> </span>cilium_host
<span class="m">10</span>.0.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.0.1<span class="w"> </span>dev<span class="w"> </span>cilium_host
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>关键理解</strong>：</p>
<p>被标记为 <code>0xd00</code> 或 <code>0xe00</code> 的流量会进入路由表 200，
然后通过 <code>cilium_host</code> 设备进行转发和 IPSec 处理。</p>
</blockquote>
<hr />
<h3 id="155">15.5 数据路径分析<a class="headerlink" href="#155" title="Permanent link">&para;</a></h3>
<h4 id="_224">发送流程<a class="headerlink" href="#_224" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Pod[&quot;源 Pod&quot;]
        P1[&quot;应用发包&quot;]
    end

    subgraph LXC[&quot;lxc 网卡&quot;]
        L1[&quot;eBPF 处理&quot;]
    end

    subgraph Host[&quot;节点&quot;]
        H1[&quot;cilium_host&lt;br/&gt;10.0.0.159&quot;]
        H2[&quot;xfrm 加密&quot;]
        H3[&quot;eth0&lt;br/&gt;172.18.0.2&quot;]
    end

    P1 --&gt; L1
    L1 --&gt;|&quot;SBR&quot;| H1
    H1 --&gt; H2
    H2 --&gt;|&quot;路由&quot;| H3
</code></pre></div>
<p><strong>流程说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">步骤</th>
<th style="text-align: left;">位置</th>
<th style="text-align: left;">操作</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1</td>
<td style="text-align: left;">Pod</td>
<td style="text-align: left;">发送原始数据包</td>
</tr>
<tr>
<td style="text-align: left;">2</td>
<td style="text-align: left;">lxc 网卡</td>
<td style="text-align: left;">eBPF 处理，打标记</td>
</tr>
<tr>
<td style="text-align: left;">3</td>
<td style="text-align: left;">SBR 路由</td>
<td style="text-align: left;">根据标记匹配 table 200</td>
</tr>
<tr>
<td style="text-align: left;">4</td>
<td style="text-align: left;">cilium_host</td>
<td style="text-align: left;">进入 xfrm 框架</td>
</tr>
<tr>
<td style="text-align: left;">5</td>
<td style="text-align: left;">xfrm</td>
<td style="text-align: left;">IPSec 加密封装</td>
</tr>
<tr>
<td style="text-align: left;">6</td>
<td style="text-align: left;">eth0</td>
<td style="text-align: left;">通过物理网卡发出</td>
</tr>
</tbody>
</table>
<h4 id="ip_1">外层 IP 的来源<a class="headerlink" href="#ip_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 抓包查看</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>esp

<span class="c1"># 外层 IP</span>
src:<span class="w"> </span><span class="m">10</span>.0.0.159<span class="w"> </span><span class="o">(</span>cilium_host<span class="o">)</span>
dst:<span class="w"> </span><span class="m">10</span>.0.0.213<span class="w"> </span><span class="o">(</span>对端<span class="w"> </span>cilium_host<span class="o">)</span>

<span class="c1"># 内层 IP</span>
src:<span class="w"> </span><span class="m">10</span>.0.0.233<span class="w"> </span><span class="o">(</span>Pod<span class="o">)</span>
dst:<span class="w"> </span><span class="m">10</span>.0.0.192<span class="w"> </span><span class="o">(</span>目标<span class="w"> </span>Pod<span class="o">)</span>
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>为什么外层 IP 是 cilium_host</strong>？</p>
<p>因为通过 SBR，流量被引导到 <code>cilium_host</code> 设备。
xfrm 使用 <code>cilium_host</code> 的 IP 作为封装的源地址。
这与 <code>ip xfrm state</code> 中配置的 src/dst 一致。</p>
</blockquote>
<hr />
<h3 id="156-mark-xfrm-state">15.6 mark 与 xfrm state 的关联<a class="headerlink" href="#156-mark-xfrm-state" title="Permanent link">&para;</a></h3>
<h4 id="_225">关联过程<a class="headerlink" href="#_225" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Packet[&quot;数据包&quot;]
        P1[&quot;原始包&lt;br/&gt;Pod → Pod&quot;]
    end

    subgraph Mark[&quot;标记&quot;]
        M1[&quot;eBPF 打标记&lt;br/&gt;mark = 0xe00&quot;]
    end

    subgraph Rule[&quot;ip rule&quot;]
        R1[&quot;fwmark 0xe00&lt;br/&gt;→ table 200&quot;]
    end

    subgraph Table[&quot;table 200&quot;]
        T1[&quot;via cilium_host&quot;]
    end

    subgraph XFRM[&quot;xfrm state&quot;]
        X1[&quot;mark 0xe00&lt;br/&gt;→ SA 匹配&quot;]
    end

    P1 --&gt; M1
    M1 --&gt; R1
    R1 --&gt; T1
    T1 --&gt; X1
</code></pre></div>
<h4 id="_226">查看关联<a class="headerlink" href="#_226" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># ip xfrm state 中的 mark</span>
$<span class="w"> </span>ip<span class="w"> </span>xfrm<span class="w"> </span>state
src<span class="w"> </span><span class="m">10</span>.0.0.159<span class="w"> </span>dst<span class="w"> </span><span class="m">10</span>.0.0.213
<span class="w">    </span>mark<span class="w"> </span>0xd00/0xf00<span class="w"> </span>output<span class="w"> </span>mark<span class="w"> </span>0xe00/0xf00
<span class="w">    </span>...

<span class="c1"># ip rule 中的 fwmark</span>
$<span class="w"> </span>ip<span class="w"> </span>rule<span class="w"> </span>list
<span class="m">100</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>fwmark<span class="w"> </span>0xd00/0xf00<span class="w"> </span>lookup<span class="w"> </span><span class="m">200</span>
<span class="m">101</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>fwmark<span class="w"> </span>0xe00/0xf00<span class="w"> </span>lookup<span class="w"> </span><span class="m">200</span>

<span class="c1"># table 200 中的路由</span>
$<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span><span class="m">200</span>
<span class="m">10</span>.0.2.0/24<span class="w"> </span>dev<span class="w"> </span>cilium_host
</code></pre></div>
<hr />
<h3 id="157">15.7 抓包分析<a class="headerlink" href="#157" title="Permanent link">&para;</a></h3>
<h4 id="_227">抓包位置<a class="headerlink" href="#_227" title="Permanent link">&para;</a></h4>
<p>在节点上使用 <code>tcpdump -i any esp</code> 可能抓到多个包：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">接口</th>
<th style="text-align: left;">抓到的包</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>cilium_host</code></td>
<td style="text-align: left;">ESP 包</td>
<td style="text-align: left;">IPSec 处理点</td>
</tr>
<tr>
<td style="text-align: left;"><code>eth0</code></td>
<td style="text-align: left;">ESP 包</td>
<td style="text-align: left;">物理网卡出口</td>
</tr>
<tr>
<td style="text-align: left;"><code>lxc_xxx</code></td>
<td style="text-align: left;">原始包</td>
<td style="text-align: left;">未加密的 Pod 包</td>
</tr>
</tbody>
</table>
<h4 id="wireshark_1">Wireshark 解密<a class="headerlink" href="#wireshark_1" title="Permanent link">&para;</a></h4>
<ol>
<li>获取密钥：</li>
</ol>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>xfrm<span class="w"> </span>state
src<span class="w"> </span><span class="m">10</span>.0.0.159<span class="w"> </span>dst<span class="w"> </span><span class="m">10</span>.0.0.213
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x00000003
<span class="w">    </span>enc<span class="w"> </span>cbc<span class="o">(</span>aes<span class="o">)</span><span class="w"> </span>0x2c...
</code></pre></div>
<ol>
<li>配置 Wireshark：</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">SPI</td>
<td style="text-align: left;">0x00000003</td>
</tr>
<tr>
<td style="text-align: left;">Algorithm</td>
<td style="text-align: left;">AES-CBC [RFC3602]</td>
</tr>
<tr>
<td style="text-align: left;">Key</td>
<td style="text-align: left;">从 ip xfrm state 复制</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="158-flannelcalico-ipsec">15.8 与 Flannel/Calico IPSec 的对比<a class="headerlink" href="#158-flannelcalico-ipsec" title="Permanent link">&para;</a></h3>
<h4 id="_228">密钥管理差异<a class="headerlink" href="#_228" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Cilium</th>
<th style="text-align: left;">Flannel/Calico</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SPI</strong></td>
<td style="text-align: left;">固定（如 0x3）</td>
<td style="text-align: left;">可能不同</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Key 方向</strong></td>
<td style="text-align: left;">来回可能相同</td>
<td style="text-align: left;">来回可能不同</td>
</tr>
<tr>
<td style="text-align: left;"><strong>mark 字段</strong></td>
<td style="text-align: left;">有</td>
<td style="text-align: left;">无</td>
</tr>
<tr>
<td style="text-align: left;"><strong>外层 IP</strong></td>
<td style="text-align: left;">cilium_host IP</td>
<td style="text-align: left;">节点 IP</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>Flannel IPSec 的差异</strong>：</p>
<p>Flannel 的来去方向可能使用不同的 Key。
在 Wireshark 解密时需要配置两条 SA。</p>
</blockquote>
<hr />
<h3 id="159">15.9 密钥更新<a class="headerlink" href="#159" title="Permanent link">&para;</a></h3>
<h4 id="_229">动态更新<a class="headerlink" href="#_229" title="Permanent link">&para;</a></h4>
<p>Cilium 支持密钥轮换：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 更新 Secret</span>
kubectl<span class="w"> </span>patch<span class="w"> </span>secret<span class="w"> </span>cilium-ipsec-keys<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="s1">&#39;{&quot;stringData&quot;:{&quot;keys&quot;:&quot;4 rfc4106(gcm(aes)) new_key_here 128&quot;}}&#39;</span>

<span class="c1"># Cilium 会自动检测并更新</span>
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>安全建议</strong>：</p>
<ul>
<li>定期轮换密钥（如每小时）</li>
<li>即使密钥泄露，更新后攻击者无法解密新流量</li>
<li>Cilium 自动处理密钥分发</li>
</ul>
</blockquote>
<hr />
<h3 id="1510">15.10 实践练习<a class="headerlink" href="#1510" title="Permanent link">&para;</a></h3>
<h4 id="1-sbr">练习 1：分析 SBR 配置<a class="headerlink" href="#1-sbr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 查看 ip rule</span>
ip<span class="w"> </span>rule<span class="w"> </span>list

<span class="c1"># 2. 查看特定路由表</span>
ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span><span class="m">200</span>

<span class="c1"># 3. 分析 mark 与 table 的关系</span>
</code></pre></div>
<h4 id="2_1">练习 2：抓包分析<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 在 cilium_host 抓包</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>cilium_host<span class="w"> </span>esp

<span class="c1"># 2. 在 eth0 抓包</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>esp

<span class="c1"># 3. 对比两个接口的包</span>
</code></pre></div>
<hr />
<h3 id="_230">📝 章节小结<a class="headerlink" href="#_230" title="Permanent link">&para;</a></h3>
<p>本章介绍了 Cilium IPSec 的数据路径：</p>
<ol>
<li><strong>部署方式</strong>：</li>
<li>创建 Secret 存储密钥</li>
<li>
<p>Helm 启用 IPSec</p>
</li>
<li>
<p><strong>mark 字段</strong>：</p>
</li>
<li>Cilium 特有</li>
<li>
<p>用于流量分类和 SA 匹配</p>
</li>
<li>
<p><strong>SBR 机制</strong>：</p>
</li>
<li>Source Based Routing</li>
<li>
<p>将流量引导到 cilium_host</p>
</li>
<li>
<p><strong>数据路径</strong>：</p>
</li>
<li>Pod → lxc → SBR → cilium_host → xfrm → eth0</li>
<li>
<p>外层 IP 使用 cilium_host 地址</p>
</li>
<li>
<p><strong>关联关系</strong>：</p>
</li>
<li>mark ↔ ip rule ↔ table 200 ↔ cilium_host ↔ xfrm state</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>理解要点</strong>：</p>
<p>Cilium IPSec 的核心是通过 <strong>mark + SBR</strong> 将流量引导到 <code>cilium_host</code>，
然后由 xfrm 框架完成 IPSec 加密。</p>
<p>[!IMPORTANT]
<strong>调试方法</strong>：</p>
<ol>
<li><code>ip rule list</code> - 查看规则</li>
<li><code>ip route show table 200</code> - 查看 SBR 路由</li>
<li><code>ip xfrm state</code> - 查看 SA 信息</li>
<li><code>tcpdump -i eth0 esp</code> - 抓包验证</li>
</ol>
</blockquote>
<hr />
<h2 id="16-wireguard">第16章 WireGuard 手工实现<a class="headerlink" href="#16-wireguard" title="Permanent link">&para;</a></h2>
<h3 id="_231">🎯 学习目标<a class="headerlink" href="#_231" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 WireGuard 的基本概念和特点</li>
<li>掌握 WireGuard 与 IPSec/OpenVPN 的区别</li>
<li>学会手工配置 WireGuard 隧道</li>
<li>理解 WireGuard 的数据包结构</li>
<li>了解 WireGuard 在 VPN 场景的应用</li>
</ul>
<hr />
<h3 id="161-wireguard">16.1 WireGuard 简介<a class="headerlink" href="#161-wireguard" title="Permanent link">&para;</a></h3>
<h4 id="_232">背景<a class="headerlink" href="#_232" title="Permanent link">&para;</a></h4>
<p>WireGuard 是一种现代、高效的 VPN 协议，于 Linux 5.6 内核正式合入。</p>
<h4 id="_233">核心特点<a class="headerlink" href="#_233" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Features[&quot;WireGuard 特点&quot;]
        F1[&quot;简洁&lt;br/&gt;约 4000 行代码&quot;]
        F2[&quot;高性能&lt;br/&gt;内核态实现&quot;]
        F3[&quot;现代加密&lt;br/&gt;Curve25519&quot;]
        F4[&quot;易配置&lt;br/&gt;类似 SSH&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特点</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>简洁</strong></td>
<td style="text-align: left;">内核代码仅约 4000 行（OpenVPN 约 10 万行）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>高性能</strong></td>
<td style="text-align: left;">完全内核态实现，无用户态拷贝</td>
</tr>
<tr>
<td style="text-align: left;"><strong>现代加密</strong></td>
<td style="text-align: left;">使用 Curve25519、ChaCha20 等</td>
</tr>
<tr>
<td style="text-align: left;"><strong>易配置</strong></td>
<td style="text-align: left;">像配置 SSH 一样简单</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>Linus Torvalds 评价</strong>：</p>
<p>"与 IPSec 和 OpenVPN 相比，WireGuard 更像一件<strong>艺术品</strong>"
(Can I just once again state my love for it and hope it gets merged soon? Compared to the horrors that are OpenVPN and IPSec, it is a work of art.)</p>
</blockquote>
<hr />
<h3 id="162-vpn">16.2 与其他 VPN 技术对比<a class="headerlink" href="#162-vpn" title="Permanent link">&para;</a></h3>
<h4 id="_234">技术对比<a class="headerlink" href="#_234" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">WireGuard</th>
<th style="text-align: left;">IPSec</th>
<th style="text-align: left;">OpenVPN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>代码量</strong></td>
<td style="text-align: left;">~4000 行</td>
<td style="text-align: left;">~10万行</td>
<td style="text-align: left;">~10万行</td>
</tr>
<tr>
<td style="text-align: left;"><strong>运行位置</strong></td>
<td style="text-align: left;">内核态</td>
<td style="text-align: left;">半内核半用户态</td>
<td style="text-align: left;">用户态</td>
</tr>
<tr>
<td style="text-align: left;"><strong>配置复杂度</strong></td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">复杂</td>
<td style="text-align: left;">中等</td>
</tr>
<tr>
<td style="text-align: left;"><strong>协议</strong></td>
<td style="text-align: left;">UDP</td>
<td style="text-align: left;">ESP</td>
<td style="text-align: left;">UDP/TCP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>密钥管理</strong></td>
<td style="text-align: left;">公钥/私钥</td>
<td style="text-align: left;">IKE/手工</td>
<td style="text-align: left;">证书/密钥</td>
</tr>
<tr>
<td style="text-align: left;"><strong>内核版本</strong></td>
<td style="text-align: left;">≥5.6</td>
<td style="text-align: left;">原生支持</td>
<td style="text-align: left;">无需</td>
</tr>
</tbody>
</table>
<h4 id="_235">性能对比<a class="headerlink" href="#_235" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Performance[&quot;性能排名&quot;]
        W[&quot;WireGuard&lt;br/&gt;最快&quot;]
        I[&quot;IPSec&lt;br/&gt;中等&quot;]
        O[&quot;OpenVPN&lt;br/&gt;较慢&quot;]
    end

    W --&gt; I --&gt; O
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>WireGuard 的优势</strong>：</p>
<ul>
<li>完全内核态 → 无上下文切换</li>
<li>代码简洁 → bug 少、审计容易</li>
<li>现代加密 → 更强安全性</li>
</ul>
</blockquote>
<hr />
<h3 id="163">16.3 内核支持检查<a class="headerlink" href="#163" title="Permanent link">&para;</a></h3>
<h4 id="_236">检查内核版本<a class="headerlink" href="#_236" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看内核版本</span>
$<span class="w"> </span>uname<span class="w"> </span>-r
<span class="m">5</span>.15.0-generic

<span class="c1"># WireGuard 需要 &gt;= 5.6</span>
<span class="c1"># 如果版本低于 5.6，需要先升级内核</span>
</code></pre></div>
<h4 id="wireguard">安装 WireGuard 工具<a class="headerlink" href="#wireguard" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Ubuntu/Debian</span>
apt<span class="w"> </span>install<span class="w"> </span>wireguard-tools

<span class="c1"># CentOS/RHEL</span>
yum<span class="w"> </span>install<span class="w"> </span>wireguard-tools
</code></pre></div>
<h4 id="_237">验证安装<a class="headerlink" href="#_237" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 wg 命令</span>
$<span class="w"> </span>which<span class="w"> </span>wg
/usr/bin/wg

<span class="c1"># 检查模块</span>
$<span class="w"> </span>lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>wireguard
wireguard<span class="w">             </span><span class="m">81920</span><span class="w">  </span><span class="m">0</span>
</code></pre></div>
<hr />
<h3 id="164-wireguard">16.4 手工配置 WireGuard<a class="headerlink" href="#164-wireguard" title="Permanent link">&para;</a></h3>
<h4 id="_238">实验拓扑<a class="headerlink" href="#_238" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Node1[&quot;节点 1 (192.168.2.71)&quot;]
        W1[&quot;wg0&lt;br/&gt;20.0.0.1/24&quot;]
    end

    subgraph Node2[&quot;节点 2 (192.168.2.73)&quot;]
        W2[&quot;wg0&lt;br/&gt;20.0.0.2/24&quot;]
    end

    W1 &lt;--&gt;|&quot;WireGuard 隧道&lt;br/&gt;UDP 51820&quot;| W2
</code></pre></div>
<h4 id="1_1">步骤 1：生成密钥<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 节点 1：生成私钥</span>
wg<span class="w"> </span>genkey<span class="w"> </span>&gt;<span class="w"> </span>/etc/wireguard/private

<span class="c1"># 从私钥提取公钥</span>
cat<span class="w"> </span>/etc/wireguard/private<span class="w"> </span><span class="p">|</span><span class="w"> </span>wg<span class="w"> </span>pubkey

<span class="c1"># 保护私钥权限</span>
chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>/etc/wireguard/private
</code></pre></div>
<h4 id="2-wireguard">步骤 2：创建 WireGuard 接口<a class="headerlink" href="#2-wireguard" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建 wg0 接口</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>wg0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>wireguard

<span class="c1"># 配置 IP 地址</span>
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">20</span>.0.0.1/24<span class="w"> </span>dev<span class="w"> </span>wg0

<span class="c1"># 应用私钥</span>
wg<span class="w"> </span><span class="nb">set</span><span class="w"> </span>wg0<span class="w"> </span>private-key<span class="w"> </span>/etc/wireguard/private

<span class="c1"># 设置监听端口</span>
wg<span class="w"> </span><span class="nb">set</span><span class="w"> </span>wg0<span class="w"> </span>listen-port<span class="w"> </span><span class="m">51820</span>

<span class="c1"># 启动接口</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>wg0<span class="w"> </span>up
</code></pre></div>
<h4 id="3-peer">步骤 3：添加 Peer<a class="headerlink" href="#3-peer" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在节点 1 添加 peer（节点 2）</span>
<span class="c1"># PEER_PUBLIC_KEY = 节点 2 的公钥</span>

wg<span class="w"> </span><span class="nb">set</span><span class="w"> </span>wg0<span class="w"> </span>peer<span class="w"> </span>&lt;PEER_PUBLIC_KEY&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>allowed-ips<span class="w"> </span><span class="m">20</span>.0.0.2/32<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>endpoint<span class="w"> </span><span class="m">192</span>.168.2.73:51820

<span class="c1"># 同样在节点 2 添加 peer（节点 1）</span>
</code></pre></div>
<hr />
<h3 id="165">16.5 查看配置<a class="headerlink" href="#165" title="Permanent link">&para;</a></h3>
<h4 id="wg">wg 命令<a class="headerlink" href="#wg" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>wg

interface:<span class="w"> </span>wg0
<span class="w">  </span>public<span class="w"> </span>key:<span class="w"> </span>aWE4xxx...
<span class="w">  </span>private<span class="w"> </span>key:<span class="w"> </span><span class="o">(</span>hidden<span class="o">)</span>
<span class="w">  </span>listening<span class="w"> </span>port:<span class="w"> </span><span class="m">51820</span>

peer:<span class="w"> </span>bXY5xxx...
<span class="w">  </span>endpoint:<span class="w"> </span><span class="m">192</span>.168.2.73:51820
<span class="w">  </span>allowed<span class="w"> </span>ips:<span class="w"> </span><span class="m">20</span>.0.0.2/32
<span class="w">  </span>latest<span class="w"> </span>handshake:<span class="w"> </span><span class="m">4</span><span class="w"> </span>seconds<span class="w"> </span>ago
<span class="w">  </span>transfer:<span class="w"> </span><span class="m">1</span>.2<span class="w"> </span>KiB<span class="w"> </span>received,<span class="w"> </span><span class="m">984</span><span class="w"> </span>B<span class="w"> </span>sent
</code></pre></div>
<p><strong>关键字段</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>public key</code></td>
<td style="text-align: left;">本端公钥</td>
</tr>
<tr>
<td style="text-align: left;"><code>listening port</code></td>
<td style="text-align: left;">监听端口</td>
</tr>
<tr>
<td style="text-align: left;"><code>peer</code></td>
<td style="text-align: left;">对端公钥</td>
</tr>
<tr>
<td style="text-align: left;"><code>endpoint</code></td>
<td style="text-align: left;">对端地址:端口</td>
</tr>
<tr>
<td style="text-align: left;"><code>allowed ips</code></td>
<td style="text-align: left;">允许的 IP 范围</td>
</tr>
<tr>
<td style="text-align: left;"><code>latest handshake</code></td>
<td style="text-align: left;">最近握手时间</td>
</tr>
</tbody>
</table>
<h4 id="wg-show">wg show 子命令<a class="headerlink" href="#wg-show" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 显示公钥</span>
wg<span class="w"> </span>show<span class="w"> </span>wg0<span class="w"> </span>public-key

<span class="c1"># 显示私钥</span>
wg<span class="w"> </span>show<span class="w"> </span>wg0<span class="w"> </span>private-key

<span class="c1"># 显示监听端口</span>
wg<span class="w"> </span>show<span class="w"> </span>wg0<span class="w"> </span>listen-port

<span class="c1"># 显示所有 peer</span>
wg<span class="w"> </span>show<span class="w"> </span>wg0<span class="w"> </span>peers
</code></pre></div>
<hr />
<h3 id="166">16.6 验证连通性<a class="headerlink" href="#166" title="Permanent link">&para;</a></h3>
<h4 id="ping">ping 测试<a class="headerlink" href="#ping" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在节点 1 ping 节点 2</span>
$<span class="w"> </span>ping<span class="w"> </span><span class="m">20</span>.0.0.2<span class="w"> </span>-c<span class="w"> </span><span class="m">3</span>

PING<span class="w"> </span><span class="m">20</span>.0.0.2<span class="w"> </span><span class="o">(</span><span class="m">20</span>.0.0.2<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">20</span>.0.0.2:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.432<span class="w"> </span>ms
</code></pre></div>
<h4 id="_239">查看握手状态<a class="headerlink" href="#_239" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>wg

<span class="c1"># 成功握手会显示：</span>
peer:<span class="w"> </span>bXY5xxx...
<span class="w">  </span>latest<span class="w"> </span>handshake:<span class="w"> </span><span class="m">4</span><span class="w"> </span>seconds<span class="w"> </span>ago

<span class="c1"># 未握手显示：</span>
peer:<span class="w"> </span>bXY5xxx...
<span class="w">  </span><span class="o">(</span>no<span class="w"> </span>handshake<span class="w"> </span>yet<span class="o">)</span>
</code></pre></div>
<hr />
<h3 id="167">16.7 数据包结构<a class="headerlink" href="#167" title="Permanent link">&para;</a></h3>
<h4 id="wireguard_1">WireGuard 封装格式<a class="headerlink" href="#wireguard_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>+-------------------+
|   IP Header       |  ← 外层 IP（节点 IP）
+-------------------+
|   UDP Header      |  ← 端口 51820
+-------------------+
|   WireGuard       |  ← WireGuard 协议头
+-------------------+
|   Encrypted       |  ← 加密的原始数据包
|   Payload         |
+-------------------+
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>与 VxLAN 类似</strong>：</p>
<ul>
<li>VxLAN: IP + UDP + VNI + 原始帧</li>
<li>WireGuard: IP + UDP + WG Header + 加密数据</li>
</ul>
<p>两者都使用 UDP 封装。</p>
</blockquote>
<h4 id="_240">链路类型<a class="headerlink" href="#_240" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 抓包查看</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>wg0

listening<span class="w"> </span>on<span class="w"> </span>wg0,<span class="w"> </span>link-type<span class="w"> </span>RAW<span class="w"> </span><span class="o">(</span>Raw<span class="w"> </span>IP<span class="o">)</span>...
</code></pre></div>
<p><strong>RAW IP</strong>：</p>
<ul>
<li>没有以太网头（无 MAC 地址）</li>
<li>类似于 tun 设备</li>
<li>只有三层 IP 信息</li>
</ul>
<hr />
<h3 id="168">16.8 抓包分析<a class="headerlink" href="#168" title="Permanent link">&para;</a></h3>
<h4 id="wg0">在 wg0 接口抓包<a class="headerlink" href="#wg0" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># wg0 上抓到的是明文（已解密）</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>wg0<span class="w"> </span>icmp

<span class="c1"># 注意：没有 MAC 地址，只有 IP</span>
<span class="m">20</span>.0.0.1<span class="w"> </span>&gt;<span class="w"> </span><span class="m">20</span>.0.0.2:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request
<span class="m">20</span>.0.0.2<span class="w"> </span>&gt;<span class="w"> </span><span class="m">20</span>.0.0.1:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>reply
</code></pre></div>
<h4 id="_241">在物理接口抓包<a class="headerlink" href="#_241" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># eth0 上抓到的是加密数据</span>
$<span class="w"> </span>tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">51820</span>

<span class="c1"># 只能看到 WireGuard 协议，内容加密</span>
<span class="m">192</span>.168.2.71.51820<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.2.73.51820:<span class="w"> </span>UDP,<span class="w"> </span>length<span class="w"> </span><span class="m">128</span>
</code></pre></div>
<h4 id="wireshark_2">Wireshark 过滤<a class="headerlink" href="#wireshark_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># 过滤 WireGuard 协议
wireguard
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>WireGuard 解密困难</strong>：</p>
<p>与 IPSec 不同，WireGuard 的解密需要从内核内存提取密钥，
目前没有简单的方法在 Wireshark 中解密 WireGuard 流量。</p>
</blockquote>
<hr />
<h3 id="169">16.9 路由与流量引导<a class="headerlink" href="#169" title="Permanent link">&para;</a></h3>
<h4 id="_242">路由规则<a class="headerlink" href="#_242" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 当添加 peer 时，系统自动添加路由</span>
$<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>show

<span class="m">20</span>.0.0.0/24<span class="w"> </span>dev<span class="w"> </span>wg0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">20</span>.0.0.1
</code></pre></div>
<p><strong>流量引导原理</strong>：</p>
<ol>
<li>目的 IP 为 20.0.0.2</li>
<li>匹配路由表，出接口为 wg0</li>
<li>wg0 查找 peer 配置</li>
<li>使用 peer 的 endpoint 封装发送</li>
</ol>
<blockquote>
<p>[!IMPORTANT]
<strong>与 IPSec 的区别</strong>：</p>
<ul>
<li>IPSec 使用 SBR（源地址路由）+ mark</li>
<li>WireGuard 使用 DBR（目的地址路由）</li>
<li>WireGuard 配置更简单</li>
</ul>
</blockquote>
<hr />
<h3 id="1610-udp">16.10 UDP 封装的优势<a class="headerlink" href="#1610-udp" title="Permanent link">&para;</a></h3>
<h4 id="udp">为什么使用 UDP<a class="headerlink" href="#udp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Question[&quot;为什么不用 TCP？&quot;]
        Q1[&quot;TCP over TCP&lt;br/&gt;双重确认&quot;]
        Q2[&quot;性能极差&lt;br/&gt;重传风暴&quot;]
    end

    subgraph Answer[&quot;UDP 的优势&quot;]
        A1[&quot;上层应用保证&lt;br/&gt;可靠传输&quot;]
        A2[&quot;避免双重&lt;br/&gt;确认机制&quot;]
        A3[&quot;高效传输&lt;br/&gt;低延迟&quot;]
    end
</code></pre></div>
<p><strong>原因</strong>：</p>
<ul>
<li>原始数据如果是 TCP，已有可靠性保证</li>
<li>UDP 封装 + TCP 上层 = 单层可靠传输</li>
<li>TCP 封装 + TCP 上层 = 双层可靠传输（性能灾难）</li>
</ul>
<blockquote>
<p>[!NOTE]
<strong>WireGuard 官方声明</strong>：</p>
<p>"我们不会支持 TCP 封装"
因为 TCP-over-TCP 会导致严重的性能问题。</p>
</blockquote>
<hr />
<h3 id="1611-vpn">16.11 VPN 应用场景<a class="headerlink" href="#1611-vpn" title="Permanent link">&para;</a></h3>
<h4 id="_243">典型场景：远程访问家庭网络<a class="headerlink" href="#_243" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Remote[&quot;远程设备&quot;]
        R[&quot;笔记本&lt;br/&gt;10.0.0.2&quot;]
    end

    subgraph Internet[&quot;公网&quot;]
        I[&quot;路由器&lt;br/&gt;公网 IP&quot;]
    end

    subgraph Home[&quot;家庭网络&quot;]
        H[&quot;WireGuard 服务器&lt;br/&gt;192.168.1.100&quot;]
        K[&quot;K8s 集群&lt;br/&gt;192.168.1.x&quot;]
    end

    R &lt;--&gt;|&quot;WireGuard&quot;| I
    I &lt;--&gt;|&quot;端口映射&quot;| H
    H &lt;--&gt; K
</code></pre></div>
<h4 id="_244">配置示例<a class="headerlink" href="#_244" title="Permanent link">&para;</a></h4>
<p><strong>服务端（家庭）</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="k">[Interface]</span>
<span class="na">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10.0.0.1/24</span>
<span class="na">PrivateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&lt;SERVER_PRIVATE_KEY&gt;</span>
<span class="na">ListenPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">51820</span>

<span class="c1"># 允许转发到内网</span>
<span class="na">PostUp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">iptables -A FORWARD -i wg0 -j ACCEPT</span>
<span class="na">PostUp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>

<span class="k">[Peer]</span>
<span class="na">PublicKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&lt;CLIENT_PUBLIC_KEY&gt;</span>
<span class="na">AllowedIPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10.0.0.2/32</span>
</code></pre></div>
<p><strong>客户端（远程）</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="k">[Interface]</span>
<span class="na">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10.0.0.2/24</span>
<span class="na">PrivateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&lt;CLIENT_PRIVATE_KEY&gt;</span>

<span class="k">[Peer]</span>
<span class="na">PublicKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&lt;SERVER_PUBLIC_KEY&gt;</span>
<span class="na">Endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&lt;公网IP&gt;:51820</span>
<span class="na">AllowedIPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10.0.0.0/24, 192.168.1.0/24</span>
</code></pre></div>
<hr />
<h3 id="1612">16.12 实践练习<a class="headerlink" href="#1612" title="Permanent link">&para;</a></h3>
<h4 id="1-wireguard">练习 1：手工配置 WireGuard<a class="headerlink" href="#1-wireguard" title="Permanent link">&para;</a></h4>
<p>按照本章步骤，在两个 Linux 节点间配置 WireGuard 隧道：</p>
<ol>
<li>生成密钥对</li>
<li>创建 wg0 接口</li>
<li>添加 peer</li>
<li>测试连通性</li>
</ol>
<h4 id="2_2">练习 2：抓包对比<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 在 wg0 抓包（明文）</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>wg0<span class="w"> </span>icmp

<span class="c1"># 2. 在 eth0 抓包（密文）</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">51820</span>

<span class="c1"># 3. 对比两个接口的数据</span>
</code></pre></div>
<hr />
<h3 id="_245">📝 章节小结<a class="headerlink" href="#_245" title="Permanent link">&para;</a></h3>
<p>本章介绍了 WireGuard 的基础知识和手工配置方法：</p>
<ol>
<li><strong>WireGuard 特点</strong>：</li>
<li>简洁（~4000 行代码）</li>
<li>高性能（内核态）</li>
<li>
<p>现代加密</p>
</li>
<li>
<p><strong>与其他 VPN 对比</strong>：</p>
</li>
<li>比 IPSec 配置简单</li>
<li>
<p>比 OpenVPN 性能更好</p>
</li>
<li>
<p><strong>手工配置步骤</strong>：</p>
</li>
<li>
<p>生成密钥 → 创建接口 → 添加 peer</p>
</li>
<li>
<p><strong>数据包结构</strong>：</p>
</li>
<li>IP + UDP + WireGuard Header + 加密数据</li>
<li>
<p>类似 VxLAN 封装方式</p>
</li>
<li>
<p><strong>路由机制</strong>：</p>
</li>
<li>使用 DBR（目的地址路由）</li>
<li>比 IPSec 的 SBR 更简单</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>学习建议</strong>：</p>
<ol>
<li>先手工配置两节点隧道</li>
<li>对比 wg0 和 eth0 的抓包数据</li>
<li>理解 UDP 封装的优势</li>
</ol>
<p>[!IMPORTANT]
<strong>WireGuard 核心命令</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 生成密钥</span>
wg<span class="w"> </span>genkey<span class="w"> </span>&gt;<span class="w"> </span>private
cat<span class="w"> </span>private<span class="w"> </span><span class="p">|</span><span class="w"> </span>wg<span class="w"> </span>pubkey<span class="w"> </span>&gt;<span class="w"> </span>public

<span class="c1"># 创建接口</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>wg0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>wireguard

<span class="c1"># 查看配置</span>
wg<span class="w"> </span>show<span class="w"> </span>wg0
</code></pre></div>
</blockquote>
<hr />
<h2 id="17-cilium-wireguard-datapath">第17章 Cilium-WireGuard-DataPath<a class="headerlink" href="#17-cilium-wireguard-datapath" title="Permanent link">&para;</a></h2>
<h3 id="_246">🎯 学习目标<a class="headerlink" href="#_246" title="Permanent link">&para;</a></h3>
<ul>
<li>理解 Cilium WireGuard 的部署方式</li>
<li>掌握 SBR（源地址路由）在 WireGuard 中的应用</li>
<li>理解 fwmark 标记机制</li>
<li>分析 Cilium WireGuard 的数据路径</li>
<li>对比手工配置与 Cilium 的差异</li>
</ul>
<hr />
<h3 id="171-cilium-wireguard">17.1 Cilium WireGuard 部署<a class="headerlink" href="#171-cilium-wireguard" title="Permanent link">&para;</a></h3>
<h4 id="_247">部署配置<a class="headerlink" href="#_247" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建 WireGuard 密钥 Secret</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium-wireguard-keys</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
<span class="nt">stringData</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 私钥（base64 编码）</span>
<span class="w">  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;...&quot;</span>
</code></pre></div>
<h4 id="helm_4">Helm 安装<a class="headerlink" href="#helm_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>encryption.enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>encryption.type<span class="o">=</span>wireguard<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">routingMode</span><span class="o">=</span>native<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">false</span>
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>注意</strong>：Cilium WireGuard 使用 Native Routing 模式（Direct Routing）。</p>
</blockquote>
<hr />
<h3 id="172-cilium-wireguard">17.2 Cilium WireGuard 接口<a class="headerlink" href="#172-cilium-wireguard" title="Permanent link">&para;</a></h3>
<h4 id="_248">查看接口<a class="headerlink" href="#_248" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span><span class="nb">type</span><span class="w"> </span>wireguard

<span class="m">10</span>:<span class="w"> </span>cilium_wg0:<span class="w"> </span>&lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1420</span><span class="w"> </span>...
<span class="w">    </span>link/none
</code></pre></div>
<p><strong>接口特点</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">属性</th>
<th style="text-align: left;">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">接口名</td>
<td style="text-align: left;"><code>cilium_wg0</code></td>
</tr>
<tr>
<td style="text-align: left;">类型</td>
<td style="text-align: left;">wireguard</td>
</tr>
<tr>
<td style="text-align: left;">MTU</td>
<td style="text-align: left;">1420</td>
</tr>
<tr>
<td style="text-align: left;">标志</td>
<td style="text-align: left;">POINTOPOINT, NOARP</td>
</tr>
</tbody>
</table>
<h4 id="peer">查看 Peer<a class="headerlink" href="#peer" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>wg<span class="w"> </span>show<span class="w"> </span>cilium_wg0

interface:<span class="w"> </span>cilium_wg0
<span class="w">  </span>public<span class="w"> </span>key:<span class="w"> </span>aWE4xxx...
<span class="w">  </span>listening<span class="w"> </span>port:<span class="w"> </span><span class="m">51820</span>

peer:<span class="w"> </span>bXY5xxx...
<span class="w">  </span>endpoint:<span class="w"> </span><span class="m">10</span>.0.0.2:51820
<span class="w">  </span>allowed<span class="w"> </span>ips:<span class="w"> </span><span class="m">10</span>.0.0.2/32

peer:<span class="w"> </span>cZA6xxx...
<span class="w">  </span>endpoint:<span class="w"> </span><span class="m">10</span>.0.0.3:51820
<span class="w">  </span>allowed<span class="w"> </span>ips:<span class="w"> </span><span class="m">10</span>.0.0.3/32
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Peer 数量</strong>：</p>
<p>3 节点集群，每个节点有 2 个 peer（其他 2 个节点）。
allowed ips 使用 /32 掩码，对应每个 Pod IP。</p>
</blockquote>
<hr />
<h3 id="173-sbr-vs-dbr">17.3 SBR vs DBR<a class="headerlink" href="#173-sbr-vs-dbr" title="Permanent link">&para;</a></h3>
<h4 id="vs-cilium">手工配置 vs Cilium<a class="headerlink" href="#vs-cilium" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">手工配置</th>
<th style="text-align: left;">Cilium</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>路由方式</strong></td>
<td style="text-align: left;">DBR（目的地址）</td>
<td style="text-align: left;">SBR（源地址）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>路由表</strong></td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">table 201</td>
</tr>
<tr>
<td style="text-align: left;"><strong>流量引导</strong></td>
<td style="text-align: left;">ip route</td>
<td style="text-align: left;">ip rule + fwmark</td>
</tr>
</tbody>
</table>
<h4 id="cilium-sbr">为什么 Cilium 使用 SBR<a class="headerlink" href="#cilium-sbr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph DBR[&quot;DBR（手工配置）&quot;]
        D1[&quot;查看目的 IP&quot;]
        D2[&quot;匹配 ip route&quot;]
        D3[&quot;出接口 = wg0&quot;]
        D1 --&gt; D2 --&gt; D3
    end

    subgraph SBR[&quot;SBR（Cilium）&quot;]
        S1[&quot;eBPF 打 fwmark&quot;]
        S2[&quot;匹配 ip rule&quot;]
        S3[&quot;查 table 201&quot;]
        S4[&quot;出接口 = cilium_wg0&quot;]
        S1 --&gt; S2 --&gt; S3 --&gt; S4
    end
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>SBR 的优势</strong>：</p>
<ul>
<li>不污染默认路由表</li>
<li>可以精确控制哪些流量需要加密</li>
<li>与 eBPF 配合更灵活</li>
</ul>
</blockquote>
<hr />
<h3 id="174-fwmark">17.4 fwmark 标记机制<a class="headerlink" href="#174-fwmark" title="Permanent link">&para;</a></h3>
<h4 id="_249">标记过程<a class="headerlink" href="#_249" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Pod[&quot;Pod&quot;]
        P1[&quot;发送数据包&quot;]
    end

    subgraph BPF[&quot;eBPF&quot;]
        B1[&quot;在 skb 上&lt;br/&gt;mark = MARK_MAGIC_ENCRYPT&quot;]
    end

    subgraph Rule[&quot;ip rule&quot;]
        R1[&quot;fwmark 匹配&lt;br/&gt;→ table 201&quot;]
    end

    subgraph WG[&quot;cilium_wg0&quot;]
        W1[&quot;WireGuard 加密&quot;]
    end

    P1 --&gt; B1 --&gt; R1 --&gt; W1
</code></pre></div>
<h4 id="ip-rule_1">查看 ip rule<a class="headerlink" href="#ip-rule_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>rule<span class="w"> </span>list

<span class="m">0</span>:<span class="w">      </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span><span class="nb">local</span>
<span class="m">100</span>:<span class="w">    </span>from<span class="w"> </span>all<span class="w"> </span>fwmark<span class="w"> </span>0x1/0xf0<span class="w"> </span>lookup<span class="w"> </span><span class="m">201</span>
<span class="m">32766</span>:<span class="w">  </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span>main
<span class="m">32767</span>:<span class="w">  </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span>default
</code></pre></div>
<p><strong>规则解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">优先级</th>
<th style="text-align: left;">条件</th>
<th style="text-align: left;">动作</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">100</td>
<td style="text-align: left;">fwmark = 0x1 (ENCRYPT)</td>
<td style="text-align: left;">查 table 201</td>
</tr>
</tbody>
</table>
<h4 id="table-201">查看 table 201<a class="headerlink" href="#table-201" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span><span class="m">201</span>

default<span class="w"> </span>dev<span class="w"> </span>cilium_wg0<span class="w"> </span>scope<span class="w"> </span>link
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>核心理解</strong>：</p>
<p>被 eBPF 标记为 <code>MARK_MAGIC_ENCRYPT</code> 的流量，
会匹配 ip rule，进入 table 201，
然后通过 <code>cilium_wg0</code> 发出。</p>
</blockquote>
<hr />
<h3 id="175">17.5 数据路径分析<a class="headerlink" href="#175" title="Permanent link">&para;</a></h3>
<h4 id="_250">发送流程<a class="headerlink" href="#_250" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph Pod[&quot;源 Pod&quot;]
        P1[&quot;应用发包&quot;]
    end

    subgraph LXC[&quot;lxc 网卡&quot;]
        L1[&quot;eBPF 处理&quot;]
        L2[&quot;mark = ENCRYPT&quot;]
    end

    subgraph SBR[&quot;SBR&quot;]
        S1[&quot;ip rule 匹配&quot;]
        S2[&quot;table 201&quot;]
    end

    subgraph WG[&quot;cilium_wg0&quot;]
        W1[&quot;WireGuard 加密&lt;br/&gt;UDP 51820&quot;]
    end

    subgraph ETH[&quot;eth0&quot;]
        E1[&quot;物理网卡发出&quot;]
    end

    P1 --&gt; L1 --&gt; L2
    L2 --&gt; S1 --&gt; S2 --&gt; W1 --&gt; E1
</code></pre></div>
<p><strong>步骤说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">步骤</th>
<th style="text-align: left;">位置</th>
<th style="text-align: left;">操作</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1</td>
<td style="text-align: left;">Pod</td>
<td style="text-align: left;">发送原始数据包</td>
</tr>
<tr>
<td style="text-align: left;">2</td>
<td style="text-align: left;">lxc</td>
<td style="text-align: left;">eBPF 处理，打 ENCRYPT 标记</td>
</tr>
<tr>
<td style="text-align: left;">3</td>
<td style="text-align: left;">ip rule</td>
<td style="text-align: left;">fwmark 匹配 table 201</td>
</tr>
<tr>
<td style="text-align: left;">4</td>
<td style="text-align: left;">table 201</td>
<td style="text-align: left;">默认路由到 cilium_wg0</td>
</tr>
<tr>
<td style="text-align: left;">5</td>
<td style="text-align: left;">cilium_wg0</td>
<td style="text-align: left;">WireGuard 加密封装</td>
</tr>
<tr>
<td style="text-align: left;">6</td>
<td style="text-align: left;">eth0</td>
<td style="text-align: left;">通过物理网卡发出</td>
</tr>
</tbody>
</table>
<h4 id="_251">接收流程<a class="headerlink" href="#_251" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph ETH[&quot;eth0&quot;]
        E1[&quot;收到 UDP 51820&quot;]
    end

    subgraph Kernel[&quot;内核&quot;]
        K1[&quot;检查端口&quot;]
        K2[&quot;51820 → WireGuard&quot;]
    end

    subgraph WG[&quot;cilium_wg0&quot;]
        W1[&quot;WireGuard 解密&quot;]
    end

    subgraph Route[&quot;路由&quot;]
        R1[&quot;送到目标 Pod&quot;]
    end

    E1 --&gt; K1 --&gt; K2 --&gt; W1 --&gt; R1
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>接收判断</strong>：</p>
<p>内核通过 UDP 端口 51820 判断是否为 WireGuard 流量。
监听在内核态（显示为 <code>-</code>），不是用户态进程。</p>
</blockquote>
<hr />
<h3 id="176">17.6 抓包分析<a class="headerlink" href="#176" title="Permanent link">&para;</a></h3>
<h4 id="_252">抓包位置<a class="headerlink" href="#_252" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 eth0 抓包（加密数据）</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">51820</span><span class="w"> </span>-w<span class="w"> </span>cilium_wg.pcap

<span class="c1"># 在 cilium_wg0 抓包（解密后的明文）</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>cilium_wg0
</code></pre></div>
<h4 id="wireshark_3">Wireshark 分析<a class="headerlink" href="#wireshark_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># 过滤 WireGuard 协议
wireguard
</code></pre></div>
<p><strong>抓包结果</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">接口</th>
<th style="text-align: left;">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>eth0</code></td>
<td style="text-align: left;">UDP 51820 + 加密数据</td>
</tr>
<tr>
<td style="text-align: left;"><code>cilium_wg0</code></td>
<td style="text-align: left;">Raw IP（无 MAC）</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
<strong>解密困难</strong>：</p>
<p>WireGuard 的密钥需要从内核内存提取，
目前无法像 IPSec 那样在 Wireshark 中直接解密。</p>
</blockquote>
<hr />
<h3 id="177">17.7 与手工配置的差异<a class="headerlink" href="#177" title="Permanent link">&para;</a></h3>
<h4 id="_253">主要区别<a class="headerlink" href="#_253" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">手工配置</th>
<th style="text-align: left;">Cilium</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>接口名</strong></td>
<td style="text-align: left;">wg0</td>
<td style="text-align: left;">cilium_wg0</td>
</tr>
<tr>
<td style="text-align: left;"><strong>路由方式</strong></td>
<td style="text-align: left;">DBR（ip route）</td>
<td style="text-align: left;">SBR（ip rule + table 201）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>流量标记</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">fwmark</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Peer 管理</strong></td>
<td style="text-align: left;">手工添加</td>
<td style="text-align: left;">自动管理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>allowed-ips</strong></td>
<td style="text-align: left;">手工指定</td>
<td style="text-align: left;">自动添加 Pod IP</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>为什么 Cilium 不用 DBR</strong>：</p>
<p>手工配置时，目的地址路由很简单：</p>
<div class="highlight"><pre><span></span><code>20.0.0.0/24 dev wg0
</code></pre></div>
<p>但 Cilium 环境中：</p>
<ul>
<li>Pod IP 不在同一网段</li>
<li>需要精确控制哪些流量加密</li>
<li>SBR + fwmark 更灵活</li>
</ul>
</blockquote>
<hr />
<h3 id="178">17.8 性能对比<a class="headerlink" href="#178" title="Permanent link">&para;</a></h3>
<h4 id="wireguard-vs-ipsec">WireGuard vs IPSec<a class="headerlink" href="#wireguard-vs-ipsec" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">WireGuard</th>
<th style="text-align: left;">IPSec</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>MTU 1500</strong></td>
<td style="text-align: left;">更高吞吐量</td>
<td style="text-align: left;">较低</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MTU 9000</strong></td>
<td style="text-align: left;">更高吞吐量</td>
<td style="text-align: left;">较低</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CPU 占用</strong></td>
<td style="text-align: left;">较低</td>
<td style="text-align: left;">较高</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>Benchmark 说明</strong>：</p>
<p>Cilium 官方测试显示 WireGuard 性能优于 IPSec。
但实际性能取决于：网络环境、MTU、负载类型等。</p>
</blockquote>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph Compare[&quot;性能对比（相对）&quot;]
        W[&quot;WireGuard&lt;br/&gt;★★★★★&quot;]
        I[&quot;IPSec&lt;br/&gt;★★★☆☆&quot;]
    end
</code></pre></div>
<hr />
<h3 id="179">17.9 实践练习<a class="headerlink" href="#179" title="Permanent link">&para;</a></h3>
<h4 id="1-cilium-wireguard">练习 1：查看 Cilium WireGuard 配置<a class="headerlink" href="#1-cilium-wireguard" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 查看 WireGuard 接口</span>
ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span><span class="nb">type</span><span class="w"> </span>wireguard

<span class="c1"># 2. 查看 Peer</span>
wg<span class="w"> </span>show<span class="w"> </span>cilium_wg0

<span class="c1"># 3. 查看 ip rule</span>
ip<span class="w"> </span>rule<span class="w"> </span>list

<span class="c1"># 4. 查看 table 201</span>
ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span><span class="m">201</span>
</code></pre></div>
<h4 id="2_3">练习 2：验证数据路径<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 在节点间 ping Pod</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>pod1<span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span>&lt;pod2-ip&gt;

<span class="c1"># 2. 抓包验证</span>
tcpdump<span class="w"> </span>-pne<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">51820</span>
</code></pre></div>
<hr />
<h3 id="_254">📝 章节小结<a class="headerlink" href="#_254" title="Permanent link">&para;</a></h3>
<p>本章介绍了 Cilium WireGuard 的数据路径：</p>
<ol>
<li><strong>部署方式</strong>：</li>
<li><code>encryption.type=wireguard</code></li>
<li>
<p>自动创建 <code>cilium_wg0</code> 接口</p>
</li>
<li>
<p><strong>SBR 机制</strong>：</p>
</li>
<li>eBPF 打 fwmark 标记</li>
<li>ip rule 匹配 table 201</li>
<li>
<p>路由到 cilium_wg0</p>
</li>
<li>
<p><strong>与手工配置的区别</strong>：</p>
</li>
<li>手工：DBR（目的地址路由）</li>
<li>
<p>Cilium：SBR（源地址路由）</p>
</li>
<li>
<p><strong>数据路径</strong>：</p>
</li>
<li>发送：Pod → eBPF(mark) → SBR → cilium_wg0 → eth0</li>
<li>
<p>接收：eth0 → 51820端口 → cilium_wg0 → Pod</p>
</li>
<li>
<p><strong>性能</strong>：</p>
</li>
<li>WireGuard 通常优于 IPSec</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>核心理解</strong>：</p>
<p>Cilium 通过 <strong>fwmark + SBR</strong> 将流量引导到 <code>cilium_wg0</code>，
然后由 WireGuard 完成加密封装。</p>
<p>[!IMPORTANT]
<strong>调试命令</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看规则</span>
ip<span class="w"> </span>rule<span class="w"> </span>list

<span class="c1"># 查看 SBR 路由</span>
ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span><span class="m">201</span>

<span class="c1"># 查看 WireGuard 状态</span>
wg<span class="w"> </span>show<span class="w"> </span>cilium_wg0

<span class="c1"># 抓包验证</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">51820</span>
</code></pre></div>
</blockquote>
<hr />
<h2 id="cilium-socketlb">第十八章 Cilium-SocketLB<a class="headerlink" href="#cilium-socketlb" title="Permanent link">&para;</a></h2>
<p>本章介绍 Cilium 独有的 Socket-based Load Balancing（Socket LB）特性，这是一种基于 eBPF 在 Socket 层面实现服务负载均衡的技术，能够显著优化集群内部的流量路径。</p>
<h3 id="181">18.1 背景与问题<a class="headerlink" href="#181" title="Permanent link">&para;</a></h3>
<h4 id="1811-service">18.1.1 传统 Service 访问模式的问题<a class="headerlink" href="#1811-service" title="Permanent link">&para;</a></h4>
<p>在传统的 Kubernetes 网络实现中（如 Flannel、Calico 等），当 Pod 访问 Service 时，数据包需要经历以下过程：</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod as Pod (Client)
    participant NS as Root Namespace
    participant IPT as iptables/IPVS
    participant Backend as Backend Pod

    Pod-&gt;&gt;NS: 发送数据包&lt;br/&gt;dst=Service IP
    NS-&gt;&gt;IPT: 进入宿主机网络栈
    IPT-&gt;&gt;IPT: DNAT 转换&lt;br/&gt;Service IP → Pod IP
    IPT-&gt;&gt;Backend: 转发到后端 Pod
    Backend--&gt;&gt;IPT: 响应
    IPT--&gt;&gt;NS: SNAT (如跨节点)
    NS--&gt;&gt;Pod: 返回响应
</code></pre></div>
<p><strong>问题分析</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>多层处理</strong></td>
<td style="text-align: left;">数据包需先到 Root Namespace，再经 iptables/IPVS 处理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>规则匹配</strong></td>
<td style="text-align: left;">iptables 链式匹配，规则多时性能下降</td>
</tr>
<tr>
<td style="text-align: left;"><strong>额外跳转</strong></td>
<td style="text-align: left;">跨节点时还需要 SNAT，增加处理开销</td>
</tr>
<tr>
<td style="text-align: left;"><strong>延迟增加</strong></td>
<td style="text-align: left;">整个处理流程增加了访问延迟</td>
</tr>
</tbody>
</table>
<h4 id="1812">18.1.2 理想的访问模式<a class="headerlink" href="#1812" title="Permanent link">&para;</a></h4>
<p>用户期望的访问模式应该更加直接：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;理想模式&quot;
        Pod[&quot;Pod (Client)&quot;] --&gt;|&quot;直接访问&quot;| Backend1[&quot;Backend Pod 1&quot;]
        Pod --&gt;|&quot;直接访问&quot;| Backend2[&quot;Backend Pod 2&quot;]
    end
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>理想状态</strong>：Pod 发出的数据包直接以后端 Pod 的 IP 作为目的地址，无需经过中间的 NAT 转换。</p>
</blockquote>
<h3 id="182-socket-lb">18.2 Socket LB 原理<a class="headerlink" href="#182-socket-lb" title="Permanent link">&para;</a></h3>
<h4 id="1821">18.2.1 核心思想<a class="headerlink" href="#1821" title="Permanent link">&para;</a></h4>
<p>Socket LB 的核心思想是：<strong>在 Socket 层面提前完成负载均衡决策</strong>，在数据包离开 Pod 之前就将 Service IP 替换为真实的后端 Pod IP。</p>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph Pod[&quot;Pod Namespace&quot;]
        App[&quot;应用程序&lt;br/&gt;connect(Service IP)&quot;]
        eBPF[&quot;eBPF Hook&lt;br/&gt;(cgroup/connect4)&quot;]
        Socket[&quot;Socket&lt;br/&gt;dst=Backend Pod IP&quot;]
    end

    subgraph Host[&quot;Root Namespace&quot;]
        Stack[&quot;网络栈&quot;]
    end

    subgraph Remote[&quot;远端节点&quot;]
        Backend[&quot;Backend Pod&quot;]
    end

    App --&gt;|&quot;原始目的: Service IP&quot;| eBPF
    eBPF --&gt;|&quot;Socket LB 替换&quot;| Socket
    Socket --&gt;|&quot;实际目的: Pod IP&quot;| Stack
    Stack --&gt;|&quot;普通路由&quot;| Backend
</code></pre></div>
<h4 id="1822">18.2.2 工作机制<a class="headerlink" href="#1822" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">阶段</th>
<th style="text-align: left;">传统模式</th>
<th style="text-align: left;">Socket LB 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>发包位置</strong></td>
<td style="text-align: left;">Pod 内发包，dst = Service IP</td>
<td style="text-align: left;">Pod 内发包，dst = <strong>Backend Pod IP</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>NAT 位置</strong></td>
<td style="text-align: left;">Root Namespace (iptables)</td>
<td style="text-align: left;">Pod Namespace (eBPF)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>后续路由</strong></td>
<td style="text-align: left;">需要 iptables 规则匹配</td>
<td style="text-align: left;">简单的跨节点/同节点路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>返回处理</strong></td>
<td style="text-align: left;">可能需要 SNAT 反向转换</td>
<td style="text-align: left;">直接返回，无需额外处理</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>关键优势</strong>：DNAT 提前在 Pod 命名空间内完成，后续流量变成简单的 Pod-to-Pod 通信，无需经过 iptables 规则链。</p>
</blockquote>
<h4 id="1823-ebpf">18.2.3 eBPF 实现位置<a class="headerlink" href="#1823-ebpf" title="Permanent link">&para;</a></h4>
<p>Socket LB 通过 eBPF 程序挂载在 cgroup 的 socket 操作钩子上实现：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;eBPF 挂载点&quot;
        connect[&quot;cgroup/connect4&lt;br/&gt;connect() 系统调用&quot;]
        sendmsg[&quot;cgroup/sendmsg4&lt;br/&gt;sendmsg() 系统调用&quot;]
        recvmsg[&quot;cgroup/recvmsg4&lt;br/&gt;recvmsg() 系统调用&quot;]
    end

    subgraph &quot;Service Map&quot;
        svc[&quot;Service → Endpoints 映射&quot;]
    end

    connect --&gt;|&quot;查询&quot;| svc
    sendmsg --&gt;|&quot;查询&quot;| svc

    svc --&gt;|&quot;返回 Backend Pod IP&quot;| connect
    svc --&gt;|&quot;返回 Backend Pod IP&quot;| sendmsg
</code></pre></div>
<h3 id="183">18.3 传统模式抓包分析<a class="headerlink" href="#183" title="Permanent link">&para;</a></h3>
<h4 id="1831-flannel">18.3.1 环境准备（以 Flannel 为例）<a class="headerlink" href="#1831-flannel" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建测试服务</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>demo-deployment.yaml

<span class="c1"># 查看 Service</span>
kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>demo-svc
<span class="c1"># NAME       TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c1"># demo-svc   NodePort   172.18.0.2     &lt;none&gt;        80:32000/TCP   1m</span>

<span class="c1"># 查看 iptables 规则链</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-L<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">32000</span>
<span class="c1"># 可以看到 KUBE-SVC-xxx 链</span>
</code></pre></div>
<h4 id="1832">18.3.2 抓包验证<a class="headerlink" href="#1832" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 进入 Pod 内抓包</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>frontend-pod<span class="w"> </span>--<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-n

<span class="c1"># 在另一个终端，从 Pod 内访问 Service</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>frontend-pod<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span><span class="m">172</span>.18.0.2:32000
</code></pre></div>
<p><strong>抓包结果分析</strong>：</p>
<div class="highlight"><pre><span></span><code># TCP 三次握手
10.244.2.2.42962 &gt; 172.18.0.2.32000: Flags [S]      # SYN: dst=Service IP
172.18.0.2.32000 &gt; 10.244.2.2.42962: Flags [S.]    # SYN-ACK
10.244.2.2.42962 &gt; 172.18.0.2.32000: Flags [.]     # ACK
</code></pre></div>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as Client Pod&lt;br/&gt;10.244.2.2
    participant Service as Service IP&lt;br/&gt;172.18.0.2:32000

    Note over Client,Service: 传统模式：目的地址是 Service IP

    Client-&gt;&gt;Service: SYN (src=10.244.2.2:42962, dst=172.18.0.2:32000)
    Service--&gt;&gt;Client: SYN-ACK
    Client-&gt;&gt;Service: ACK

    Note over Client,Service: iptables 在 Root NS 做 DNAT
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>观察要点</strong>：</p>
<ul>
<li>目的 IP 是 Service IP（172.18.0.2），而非后端 Pod IP</li>
<li>数据包需要到达 Root Namespace 后，由 iptables 进行 DNAT 转换</li>
<li>这是传统的、符合直觉的实现方式</li>
</ul>
</blockquote>
<h3 id="184-socket-lb">18.4 Socket LB 模式抓包分析<a class="headerlink" href="#184-socket-lb" title="Permanent link">&para;</a></h3>
<h4 id="1841-socket-lb">18.4.1 启用 Socket LB<a class="headerlink" href="#1841-socket-lb" title="Permanent link">&para;</a></h4>
<p>通过 Helm 部署 Cilium 并启用 Socket LB：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">kubeProxyReplacement</span><span class="o">=</span>strict<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>socketLB.enabled<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<h4 id="1842">18.4.2 验证配置<a class="headerlink" href="#1842" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Cilium 配置</span>
cilium<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>socket
<span class="c1"># socket-lb: enabled</span>

<span class="c1"># 或通过 cilium status</span>
cilium<span class="w"> </span>status<span class="w"> </span>--verbose<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>socket
<span class="c1"># KubeProxyReplacement Info: Socket LB: enabled</span>
</code></pre></div>
<h4 id="1843">18.4.3 抓包验证<a class="headerlink" href="#1843" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 进入 Pod 内抓包</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>frontend-pod<span class="w"> </span>--<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-n

<span class="c1"># 从 Pod 内访问 Service</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>frontend-pod<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span><span class="m">172</span>.18.0.2:32000
</code></pre></div>
<p><strong>抓包结果分析</strong>：</p>
<div class="highlight"><pre><span></span><code># TCP 三次握手
10.0.0.221.58504 &gt; 10.0.2.22.80: Flags [S]     # SYN: dst=Backend Pod IP !!!
10.0.2.22.80 &gt; 10.0.0.221.58504: Flags [S.]   # SYN-ACK
10.0.0.221.58504 &gt; 10.0.2.22.80: Flags [.]    # ACK
</code></pre></div>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as Client Pod&lt;br/&gt;10.0.0.221
    participant Backend as Backend Pod&lt;br/&gt;10.0.2.22:80

    Note over Client,Backend: Socket LB：目的地址直接是 Backend Pod IP

    Client-&gt;&gt;Backend: SYN (src=10.0.0.221:58504, dst=10.0.2.22:80)
    Backend--&gt;&gt;Client: SYN-ACK
    Client-&gt;&gt;Backend: ACK

    Note over Client,Backend: eBPF 在 Pod NS 内提前完成 DNAT
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>关键发现</strong>：</p>
<ul>
<li>虽然应用访问的是 Service IP（172.18.0.2:32000）</li>
<li>但抓包看到的目的 IP 直接是 Backend Pod IP（10.0.2.22:80）</li>
<li>这说明 Socket LB 在数据包发出前就完成了地址替换</li>
</ul>
</blockquote>
<h3 id="185">18.5 对比总结<a class="headerlink" href="#185" title="Permanent link">&para;</a></h3>
<h4 id="1851">18.5.1 数据路径对比<a class="headerlink" href="#1851" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph Traditional[&quot;传统模式 (Flannel/Calico)&quot;]
        direction LR
        T_Pod[&quot;Pod&quot;] --&gt;|&quot;dst=Service IP&quot;| T_veth[&quot;veth pair&quot;]
        T_veth --&gt; T_Root[&quot;Root NS&quot;]
        T_Root --&gt; T_IPT[&quot;iptables DNAT&quot;]
        T_IPT --&gt;|&quot;dst=Pod IP&quot;| T_Backend[&quot;Backend&quot;]
    end

    subgraph SocketLB[&quot;Socket LB 模式 (Cilium)&quot;]
        direction LR
        S_Pod[&quot;Pod&quot;] --&gt;|&quot;eBPF 替换&quot;| S_Socket[&quot;Socket&quot;]
        S_Socket --&gt;|&quot;dst=Pod IP&quot;| S_Root[&quot;Root NS&quot;]
        S_Root --&gt;|&quot;普通路由&quot;| S_Backend[&quot;Backend&quot;]
    end
</code></pre></div>
<h4 id="1852">18.5.2 核心差异表<a class="headerlink" href="#1852" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">传统模式</th>
<th style="text-align: left;">Socket LB 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>DNAT 位置</strong></td>
<td style="text-align: left;">Root Namespace</td>
<td style="text-align: left;">Pod Namespace</td>
</tr>
<tr>
<td style="text-align: left;"><strong>DNAT 时机</strong></td>
<td style="text-align: left;">数据包到达宿主机后</td>
<td style="text-align: left;">数据包离开 Pod 前</td>
</tr>
<tr>
<td style="text-align: left;"><strong>实现技术</strong></td>
<td style="text-align: left;">iptables / IPVS</td>
<td style="text-align: left;">eBPF (cgroup hooks)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>抓包看到的目的 IP</strong></td>
<td style="text-align: left;">Service IP</td>
<td style="text-align: left;">Backend Pod IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>后续处理</strong></td>
<td style="text-align: left;">需要规则匹配</td>
<td style="text-align: left;">简单路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能开销</strong></td>
<td style="text-align: left;">较高（规则链匹配）</td>
<td style="text-align: left;">较低（Map 查询）</td>
</tr>
</tbody>
</table>
<h4 id="1853">18.5.3 性能优势<a class="headerlink" href="#1853" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;性能优势&quot;
        A[&quot;提前 DNAT&quot;] --&gt; B[&quot;跳过 iptables&quot;]
        B --&gt; C[&quot;减少规则匹配&quot;]
        C --&gt; D[&quot;降低延迟&quot;]
        D --&gt; E[&quot;提升吞吐量&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">优势</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>减少跳数</strong></td>
<td style="text-align: left;">不需要经过 Root NS 的 iptables 处理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>规避规则膨胀</strong></td>
<td style="text-align: left;">Service 多时，iptables 规则链很长</td>
</tr>
<tr>
<td style="text-align: left;"><strong>路径简化</strong></td>
<td style="text-align: left;">变成简单的 Pod-to-Pod 通信</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能提升</strong></td>
<td style="text-align: left;">减少 CPU 开销和延迟</td>
</tr>
</tbody>
</table>
<h3 id="186">18.6 配置选项<a class="headerlink" href="#186" title="Permanent link">&para;</a></h3>
<h4 id="1861-helm">18.6.1 Helm 配置参数<a class="headerlink" href="#1861-helm" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># values.yaml 关键配置</span>
<span class="nt">kubeProxyReplacement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">strict</span><span class="w">  </span><span class="c1"># 或 partial</span>
<span class="nt">socketLB</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">hostNamespaceOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">    </span><span class="c1"># 是否仅对 host namespace 生效</span>
</code></pre></div>
<h4 id="1862">18.6.2 模式说明<a class="headerlink" href="#1862" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">kubeProxyReplacement</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>strict</strong></td>
<td style="text-align: left;">strict</td>
<td style="text-align: left;">完全替换 kube-proxy，启用所有 eBPF 功能</td>
</tr>
<tr>
<td style="text-align: left;"><strong>partial</strong></td>
<td style="text-align: left;">partial</td>
<td style="text-align: left;">部分替换，与 kube-proxy 共存</td>
</tr>
</tbody>
</table>
<h4 id="1863">18.6.3 验证命令<a class="headerlink" href="#1863" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Socket LB 状态</span>
cilium<span class="w"> </span>status<span class="w"> </span>--verbose

<span class="c1"># 查看详细配置</span>
cilium<span class="w"> </span>config<span class="w"> </span>view

<span class="c1"># 查看 BPF 程序</span>
bpftool<span class="w"> </span>prog<span class="w"> </span>list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>cgroup
</code></pre></div>
<h3 id="187">18.7 历史演进<a class="headerlink" href="#187" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">版本阶段</th>
<th style="text-align: left;">功能名称</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>早期版本</strong></td>
<td style="text-align: left;">Host Reachable Services</td>
<td style="text-align: left;">最初的功能名称</td>
</tr>
<tr>
<td style="text-align: left;"><strong>当前版本</strong></td>
<td style="text-align: left;">Socket LB</td>
<td style="text-align: left;">统一命名为 Socket-based Load Balancing</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
如果在旧版本 Cilium 文档中看到 "Host Reachable Services"，它与 Socket LB 描述的是同一功能。</p>
</blockquote>
<h3 id="188">18.8 适用场景<a class="headerlink" href="#188" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;适用场景&quot;
        A[&quot;集群内 Pod 访问 Service&quot;]
        B[&quot;东西向流量优化&quot;]
        C[&quot;大规模 Service 环境&quot;]
        D[&quot;延迟敏感型应用&quot;]
    end

    subgraph &quot;不适用场景&quot;
        E[&quot;外部流量进入集群&quot;]
        F[&quot;NodePort 外部访问&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">Socket LB 作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Pod → ClusterIP</strong></td>
<td style="text-align: left;">✅ 直接替换为后端 Pod IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Pod → NodePort（集群内）</strong></td>
<td style="text-align: left;">✅ 同样可以优化</td>
</tr>
<tr>
<td style="text-align: left;"><strong>外部 → NodePort</strong></td>
<td style="text-align: left;">❌ 需要其他机制（如 DSR）</td>
</tr>
</tbody>
</table>
<h3 id="189">18.9 章节小结<a class="headerlink" href="#189" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Socket LB))
    背景
      传统模式需要 iptables DNAT
      规则匹配开销大
      路径复杂
    原理
      eBPF 挂载 cgroup hooks
      Socket 层面完成 LB
      提前替换目的 IP
    验证
      传统模式：抓包看到 Service IP
      Socket LB：抓包看到 Backend Pod IP
    优势
      减少跳数
      降低延迟
      提升性能
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li>
<p><strong>什么是 Socket LB</strong>：在 Socket 层面通过 eBPF 实现的负载均衡，提前完成 Service IP 到 Backend Pod IP 的转换</p>
</li>
<li>
<p><strong>与传统模式区别</strong>：</p>
</li>
<li>传统：Pod → Root NS → iptables DNAT → Backend</li>
<li>
<p>Socket LB：Pod (eBPF DNAT) → Root NS → 直接路由 → Backend</p>
</li>
<li>
<p><strong>抓包验证</strong>：</p>
</li>
<li>传统模式抓包看到 dst = Service IP</li>
<li>
<p>Socket LB 模式抓包看到 dst = Backend Pod IP</p>
</li>
<li>
<p><strong>配置方法</strong>：<code>kubeProxyReplacement=strict</code> 或单独设置 <code>socketLB.enabled=true</code></p>
</li>
<li>
<p><strong>核心优势</strong>：减少 iptables 规则匹配，降低延迟，提升大规模集群的 Service 访问性能</p>
</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium-dsr">第十九章 Cilium-DSR 模式<a class="headerlink" href="#cilium-dsr" title="Permanent link">&para;</a></h2>
<p>本章介绍 Cilium 的 DSR（Direct Server Return）模式，这是一种优化南北向流量的技术，通过让后端 Pod 直接响应客户端，减少返回路径的跳数，降低入口节点的负载。</p>
<h3 id="191">19.1 背景与问题<a class="headerlink" href="#191" title="Permanent link">&para;</a></h3>
<h4 id="1911-snat">19.1.1 传统 SNAT 模式的数据路径<a class="headerlink" href="#1911-snat" title="Permanent link">&para;</a></h4>
<p>在传统的 NodePort/LoadBalancer 访问模式中，外部客户端访问集群内服务时，数据包需要经过 SNAT 处理：</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as 外部客户端&lt;br/&gt;1.1.1.10
    participant NodeA as Node A&lt;br/&gt;1.1.1.1:32000
    participant NodeB as Node B&lt;br/&gt;1.1.1.2
    participant Pod as Backend Pod&lt;br/&gt;10.0.0.1

    Note over Client,Pod: SNAT 模式：返回路径经过入口节点

    Client-&gt;&gt;NodeA: ① SYN (src=1.1.1.10, dst=1.1.1.1:32000)
    NodeA-&gt;&gt;NodeA: SNAT: src=1.1.1.10 → src=1.1.1.1
    NodeA-&gt;&gt;Pod: ② (src=1.1.1.1, dst=10.0.0.1:80)
    Pod-&gt;&gt;NodeA: ③ SYN-ACK (src=10.0.0.1, dst=1.1.1.1)
    NodeA-&gt;&gt;NodeA: Reverse SNAT
    NodeA-&gt;&gt;Client: ④ (src=1.1.1.1, dst=1.1.1.10)
</code></pre></div>
<p><strong>SNAT 模式的问题</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>入口节点瓶颈</strong></td>
<td style="text-align: left;">所有进出流量都经过入口节点，容易成为瓶颈</td>
</tr>
<tr>
<td style="text-align: left;"><strong>多一跳</strong></td>
<td style="text-align: left;">返回响应需要先回到入口节点，再转发给客户端</td>
</tr>
<tr>
<td style="text-align: left;"><strong>源 IP 丢失</strong></td>
<td style="text-align: left;">Pod 看到的源 IP 是入口节点 IP，而非真实客户端 IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>负载不均</strong></td>
<td style="text-align: left;">入口节点承担额外的转发负担</td>
</tr>
</tbody>
</table>
<h4 id="1912-dsr">19.1.2 DSR 的核心思想<a class="headerlink" href="#1912-dsr" title="Permanent link">&para;</a></h4>
<p>DSR（Direct Server Return）的核心思想是：<strong>让后端 Pod 直接将响应发送给客户端，跳过入口节点</strong>。</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as 外部客户端&lt;br/&gt;1.1.1.10
    participant NodeA as Node A&lt;br/&gt;1.1.1.1:32000
    participant NodeB as Node B&lt;br/&gt;1.1.1.2
    participant Pod as Backend Pod&lt;br/&gt;10.0.0.1

    Note over Client,Pod: DSR 模式：响应直接返回客户端

    Client-&gt;&gt;NodeA: ① SYN (src=1.1.1.10, dst=1.1.1.1:32000)
    NodeA-&gt;&gt;Pod: ② SYN (携带原始目的 IP 信息)
    Pod-&gt;&gt;Client: ③ SYN-ACK (src=1.1.1.1, dst=1.1.1.10)
    Client-&gt;&gt;NodeA: ④ ACK
    NodeA-&gt;&gt;Pod: ⑤ ACK
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>DSR 的关键</strong>：后端 Pod 在发送响应时，必须使用客户端原始访问的目的 IP（入口节点 IP）作为源 IP，否则客户端会丢弃这个"意外"的响应包。</p>
</blockquote>
<h3 id="192-dsr-vs-snat">19.2 DSR vs SNAT 对比<a class="headerlink" href="#192-dsr-vs-snat" title="Permanent link">&para;</a></h3>
<h4 id="1921">19.2.1 数据路径对比<a class="headerlink" href="#1921" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph SNAT[&quot;SNAT 模式&quot;]
        direction LR
        S_Client[&quot;Client&quot;] --&gt;|&quot;①&quot;| S_NodeA[&quot;Node A&quot;]
        S_NodeA --&gt;|&quot;② SNAT&quot;| S_Pod[&quot;Pod&quot;]
        S_Pod --&gt;|&quot;③&quot;| S_NodeA
        S_NodeA --&gt;|&quot;④ Reverse&quot;| S_Client
    end

    subgraph DSR[&quot;DSR 模式&quot;]
        direction LR
        D_Client[&quot;Client&quot;] --&gt;|&quot;①&quot;| D_NodeA[&quot;Node A&quot;]
        D_NodeA --&gt;|&quot;② + IP Info&quot;| D_Pod[&quot;Pod&quot;]
        D_Pod --&gt;|&quot;③ 直接返回&quot;| D_Client
    end
</code></pre></div>
<h4 id="1922">19.2.2 核心差异表<a class="headerlink" href="#1922" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">SNAT 模式</th>
<th style="text-align: left;">DSR 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>返回路径</strong></td>
<td style="text-align: left;">Client ← Node A ← Pod</td>
<td style="text-align: left;">Client ← Pod (直接)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跳数</strong></td>
<td style="text-align: left;">请求 2 跳 + 响应 2 跳 = 4 跳</td>
<td style="text-align: left;">请求 2 跳 + 响应 1 跳 = 3 跳</td>
</tr>
<tr>
<td style="text-align: left;"><strong>入口节点负载</strong></td>
<td style="text-align: left;">高（处理双向流量）</td>
<td style="text-align: left;">低（只处理入向流量）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>源 IP 可见性</strong></td>
<td style="text-align: left;">Pod 看到 Node A IP</td>
<td style="text-align: left;">Pod 看到真实 Client IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>响应包源 IP</strong></td>
<td style="text-align: left;">Node A IP</td>
<td style="text-align: left;">Node A IP (伪装)</td>
</tr>
</tbody>
</table>
<h3 id="193-ip">19.3 核心挑战：IP 传递问题<a class="headerlink" href="#193-ip" title="Permanent link">&para;</a></h3>
<h4 id="1931">19.3.1 问题描述<a class="headerlink" href="#1931" title="Permanent link">&para;</a></h4>
<p>DSR 模式的核心挑战是：<strong>如何将客户端原始访问的目的 IP（入口节点 IP）传递给后端 Pod？</strong></p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;问题&quot;
        A[&quot;客户端访问 1.1.1.1:32000&quot;]
        B[&quot;Pod 在 Node B (1.1.1.2)&quot;]
        C[&quot;Pod 响应时必须使用 src=1.1.1.1&quot;]
        D[&quot;但 Pod 不知道 1.1.1.1 这个地址&quot;]
    end

    A --&gt; B --&gt; C --&gt; D

    subgraph &quot;解决方案&quot;
        E[&quot;在请求转发时携带原始目的 IP&quot;]
    end

    D --&gt; E
</code></pre></div>
<h4 id="1932-ip">19.3.2 IP 响应的要求<a class="headerlink" href="#1932-ip" title="Permanent link">&para;</a></h4>
<p>客户端发送请求后，期望收到来自原始目的 IP 的响应：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">客户端行为</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">响应源 IP = 原始目的 IP</td>
<td style="text-align: left;">✅ 接受响应，通信正常</td>
</tr>
<tr>
<td style="text-align: left;">响应源 IP ≠ 原始目的 IP</td>
<td style="text-align: left;">❌ 丢弃响应，认为是无效包</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>类比理解</strong>：就像你 ping 1.1.1.1，但收到 1.1.1.2 的 reply，这个 reply 会被丢弃，因为"你问的是 A，但 B 来回答了"。</p>
</blockquote>
<h3 id="194-cilium-dsr">19.4 Cilium DSR 实现机制<a class="headerlink" href="#194-cilium-dsr" title="Permanent link">&para;</a></h3>
<h4 id="1941-ip-options">19.4.1 IP Options 方案<a class="headerlink" href="#1941-ip-options" title="Permanent link">&para;</a></h4>
<p>Cilium 原生使用 <strong>IP Options 字段</strong> 来传递原始目的 IP 信息：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;第一跳：Client → Node A&quot;
        A1[&quot;IP Header&quot;]
        A2[&quot;src=1.1.1.10&quot;]
        A3[&quot;dst=1.1.1.1&quot;]
    end

    subgraph &quot;第二跳：Node A → Pod (携带 Options)&quot;
        B1[&quot;IP Header&quot;]
        B2[&quot;src=1.1.1.10&quot;]
        B3[&quot;dst=10.0.0.1&quot;]
        B4[&quot;&lt;b&gt;Options: orig_dst=1.1.1.1:32000&lt;/b&gt;&quot;]
    end

    A1 --&gt; B1
</code></pre></div>
<h4 id="1942-ip-options">19.4.2 IP Options 字段解析<a class="headerlink" href="#1942-ip-options" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>IP Header Options 字段内容（十六进制）：
+------+------+------+------+------+------+------+------+
| 0x9a | ...  | 0xAC | 0x12 | 0x00 | 0x04 | 0x7D | 0x00 |
+------+------+------+------+------+------+------+------+
                 ↓      ↓      ↓      ↓      ↓      ↓
               172     18     0      4    32000端口高位

解析结果：原始目的 IP = 172.18.0.4，端口 = 32000
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">十六进制</th>
<th style="text-align: left;">十进制</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">0xAC</td>
<td style="text-align: left;">172</td>
<td style="text-align: left;">IP 第一段</td>
</tr>
<tr>
<td style="text-align: left;">0x12</td>
<td style="text-align: left;">18</td>
<td style="text-align: left;">IP 第二段</td>
</tr>
<tr>
<td style="text-align: left;">0x00</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">IP 第三段</td>
</tr>
<tr>
<td style="text-align: left;">0x04</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">IP 第四段</td>
</tr>
<tr>
<td style="text-align: left;">0x7D00</td>
<td style="text-align: left;">32000</td>
<td style="text-align: left;">端口号</td>
</tr>
</tbody>
</table>
<h4 id="1943">19.4.3 抓包验证<a class="headerlink" href="#1943" title="Permanent link">&para;</a></h4>
<p><strong>第一跳抓包（Client → Node A）</strong>：</p>
<div class="highlight"><pre><span></span><code># 正常的 SYN 包，没有 Options 字段
172.18.0.1.38645 &gt; 172.18.0.4.32000: Flags [S]
IP Header: 无 Options
</code></pre></div>
<p><strong>第二跳抓包（Node A → Pod）</strong>：</p>
<div class="highlight"><pre><span></span><code># 携带 Options 字段的 SYN 包
172.18.0.1.38645 &gt; 10.0.2.148.80: Flags [S]
IP Header Options: unknown (0x9a) [包含原始目的 IP]
</code></pre></div>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant C as Client&lt;br/&gt;172.18.0.1
    participant A as Node A&lt;br/&gt;172.18.0.4
    participant B as Node B&lt;br/&gt;172.18.0.2
    participant P as Pod&lt;br/&gt;10.0.2.148

    C-&gt;&gt;A: ① SYN (无 Options)
    A-&gt;&gt;P: ② SYN + Options (orig_dst=172.18.0.4:32000)
    Note over P: 解析 Options 获取原始目的 IP
    P-&gt;&gt;C: ③ SYN-ACK (src=172.18.0.4)
    Note over A: Node A 上只能看到 SYN 和 ACK
    C-&gt;&gt;A: ④ ACK
    A-&gt;&gt;P: ⑤ ACK
</code></pre></div>
<h3 id="195-tcp">19.5 TCP 三次握手详解<a class="headerlink" href="#195-tcp" title="Permanent link">&para;</a></h3>
<h4 id="1951">19.5.1 握手过程分析<a class="headerlink" href="#1951" title="Permanent link">&para;</a></h4>
<p>在 DSR 模式下，三次握手的包分布在不同路径：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">包名</th>
<th style="text-align: left;">路径</th>
<th style="text-align: left;">Node A 可见</th>
<th style="text-align: left;">Node B/Pod 可见</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SYN</strong></td>
<td style="text-align: left;">Client → A → Pod</td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SYN-ACK</strong></td>
<td style="text-align: left;">Pod → Client</td>
<td style="text-align: left;">❌ (跳过)</td>
<td style="text-align: left;">✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ACK</strong></td>
<td style="text-align: left;">Client → A → Pod</td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">✅</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>抓包技巧</strong>：在 Node A 上抓包只能看到 SYN 和 ACK，看不到 SYN-ACK；要看 SYN-ACK 需要在 Pod 所在节点抓包。</p>
</blockquote>
<h4 id="1952-tcp">19.5.2 TCP 三次握手简单理解<a class="headerlink" href="#1952-tcp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant A as Client (张三)
    participant B as Server (李四)

    A-&gt;&gt;B: SYN: &quot;你好，我是张三&quot;
    B-&gt;&gt;A: SYN-ACK: &quot;张三你好，我是李四&quot;
    A-&gt;&gt;B: ACK: &quot;好的，我知道你是李四了&quot;

    Note over A,B: 握手完成，可以开始通信
</code></pre></div>
<ul>
<li><strong>第一次握手 (SYN)</strong>：证明自己的存在</li>
<li><strong>第二次握手 (SYN-ACK)</strong>：证明对方的存在 + 确认收到</li>
<li><strong>第三次握手 (ACK)</strong>：确认彼此都存在</li>
</ul>
<h3 id="196">19.6 配置方法<a class="headerlink" href="#196" title="Permanent link">&para;</a></h3>
<h4 id="1961-helm">19.6.1 Helm 部署<a class="headerlink" href="#1961-helm" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">kubeProxyReplacement</span><span class="o">=</span>strict<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>loadBalancer.mode<span class="o">=</span>dsr
</code></pre></div>
<h4 id="1962">19.6.2 验证配置<a class="headerlink" href="#1962" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Cilium 状态</span>
cilium<span class="w"> </span>status<span class="w"> </span>--verbose<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;load&quot;</span>
<span class="c1"># LoadBalancer Mode: DSR</span>

<span class="c1"># 或通过 config view</span>
cilium<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>loadbalancer
<span class="c1"># loadbalancer-mode: dsr</span>
</code></pre></div>
<h3 id="197-ipip">19.7 进阶方案：IPIP 隧道<a class="headerlink" href="#197-ipip" title="Permanent link">&para;</a></h3>
<h4 id="1971-ip-options">19.7.1 IP Options 的局限性<a class="headerlink" href="#1971-ip-options" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>TCP Fast Open 不兼容</strong></td>
<td style="text-align: left;">使用 Options 字段会影响 TCP Fast Open</td>
</tr>
<tr>
<td style="text-align: left;"><strong>交换机处理慢</strong></td>
<td style="text-align: left;">交换机需要解析 Options，增加处理开销</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Slow Path</strong></td>
<td style="text-align: left;">触发非快速路径处理</td>
</tr>
</tbody>
</table>
<h4 id="1972-ipip">19.7.2 IPIP 隧道方案<a class="headerlink" href="#1972-ipip" title="Permanent link">&para;</a></h4>
<p>字节跳动工程师提出了使用 <strong>IPIP 隧道</strong> 来传递原始 IP 信息的方案：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;IPIP 封装&quot;
        direction TB
        Outer[&quot;外层 IP Header&lt;br/&gt;src=Node A IP, dst=Pod IP&quot;]
        Inner[&quot;内层 IP Header&lt;br/&gt;src=Client IP, dst=Pod IP&lt;br/&gt;+ Options: orig_dst&quot;]
        Data[&quot;TCP/Payload&quot;]

        Outer --&gt; Inner --&gt; Data
    end
</code></pre></div>
<h4 id="1973-ipip-vs-ip-options">19.7.3 IPIP vs IP Options 对比<a class="headerlink" href="#1973-ipip-vs-ip-options" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">IP Options</th>
<th style="text-align: left;">IPIP 隧道</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>交换机可见</strong></td>
<td style="text-align: left;">✅ 可见，需解析</td>
<td style="text-align: left;">❌ 不可见，快速转发</td>
</tr>
<tr>
<td style="text-align: left;"><strong>处理路径</strong></td>
<td style="text-align: left;">Slow Path</td>
<td style="text-align: left;">Fast Path</td>
</tr>
<tr>
<td style="text-align: left;"><strong>封装开销</strong></td>
<td style="text-align: left;">低</td>
<td style="text-align: left;">略高（多一层 IP）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>实现状态</strong></td>
<td style="text-align: left;">Cilium 原生支持</td>
<td style="text-align: left;">需要二次开发</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
IPIP 隧道方案将 Options 信息"隐藏"在内层 IP 中，外层 IP 是标准包，交换机可以快速转发。</p>
</blockquote>
<h3 id="198">19.8 应用场景<a class="headerlink" href="#198" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;适用 DSR 的场景&quot;
        A[&quot;外部流量访问 NodePort&quot;]
        B[&quot;LoadBalancer 类型 Service&quot;]
        C[&quot;南北向流量优化&quot;]
        D[&quot;入口节点负载分散&quot;]
    end

    subgraph &quot;不适用 DSR 的场景&quot;
        E[&quot;集群内 Pod-to-Pod&quot;]
        F[&quot;东西向流量 (用 Socket LB)&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">推荐模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>外部 → ClusterIP/NodePort</strong></td>
<td style="text-align: left;">DSR</td>
</tr>
<tr>
<td style="text-align: left;"><strong>外部 → LoadBalancer</strong></td>
<td style="text-align: left;">DSR</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Pod → Service（集群内）</strong></td>
<td style="text-align: left;">Socket LB</td>
</tr>
<tr>
<td style="text-align: left;"><strong>需要源 IP 保留</strong></td>
<td style="text-align: left;">DSR (externalTrafficPolicy=Local)</td>
</tr>
</tbody>
</table>
<h3 id="199-lvs-dsr">19.9 与 LVS DSR 的关系<a class="headerlink" href="#199-lvs-dsr" title="Permanent link">&para;</a></h3>
<p>Cilium DSR 的思想源自 Linux LVS 的 DR 模式：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">LVS 术语</th>
<th style="text-align: left;">Cilium 对应</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Director</strong></td>
<td style="text-align: left;">入口节点 (Node A)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Real Server</strong></td>
<td style="text-align: left;">后端 Pod</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VIP</strong></td>
<td style="text-align: left;">Service IP / NodePort</td>
</tr>
<tr>
<td style="text-align: left;"><strong>DIP</strong></td>
<td style="text-align: left;">Pod IP</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
学习 LVS 的 DR/NAT/TUN 模式可以帮助理解 Cilium DSR 的设计思想。</p>
</blockquote>
<h3 id="1910">19.10 章节小结<a class="headerlink" href="#1910" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((DSR 模式))
    背景
      SNAT 模式入口节点瓶颈
      返回流量多一跳
    原理
      后端直接响应客户端
      跳过入口节点
    挑战
      如何传递原始目的 IP
      Pod 响应需伪装源 IP
    实现
      IP Options 字段
      IPIP 隧道(进阶)
    验证
      Node A 看不到 SYN-ACK
      Pod 节点可见完整握手
    配置
      loadBalancer.mode=dsr
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li>
<p><strong>什么是 DSR</strong>：Direct Server Return，后端 Pod 直接响应客户端，跳过入口节点</p>
</li>
<li>
<p><strong>解决的问题</strong>：</p>
</li>
<li>减少返回路径跳数（4 跳 → 3 跳）</li>
<li>分散入口节点负载</li>
<li>
<p>保留真实客户端源 IP</p>
</li>
<li>
<p><strong>核心挑战</strong>：如何将原始目的 IP 传递给后端 Pod</p>
</li>
<li>
<p><strong>Cilium 实现</strong>：通过 IP Options 字段携带 <code>orig_dst</code> 信息</p>
</li>
<li>
<p><strong>抓包验证</strong>：SYN-ACK 从 Pod 直接发往 Client，Node A 看不到</p>
</li>
<li>
<p><strong>配置方法</strong>：<code>loadBalancer.mode=dsr</code></p>
</li>
<li>
<p><strong>与 Socket LB 的区别</strong>：</p>
</li>
<li>Socket LB：优化东西向（集群内）流量</li>
<li>DSR：优化南北向（外部访问）流量</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium_3">第二十章 Cilium 双栈模式<a class="headerlink" href="#cilium_3" title="Permanent link">&para;</a></h2>
<p>本章介绍 Cilium 的 IPv4/IPv6 双栈（Dual Stack）支持，这是一种让 Pod 和 Service 同时拥有 IPv4 和 IPv6 地址的网络配置方式，是从 IPv4 向 IPv6 过渡的重要技术。</p>
<h3 id="201">20.1 背景与概念<a class="headerlink" href="#201" title="Permanent link">&para;</a></h3>
<h4 id="2011">20.1.1 为什么需要双栈<a class="headerlink" href="#2011" title="Permanent link">&para;</a></h4>
<p>随着 IPv4 地址资源枯竭和 IPv6 的推广，越来越多的企业开始进行 IPv6 改造：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;演进路径&quot;
        A[&quot;纯 IPv4&quot;] --&gt; B[&quot;双栈过渡&quot;]
        B --&gt; C[&quot;纯 IPv6&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">方案</th>
<th style="text-align: left;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>纯 IPv4</strong></td>
<td style="text-align: left;">传统方案，地址资源紧张</td>
</tr>
<tr>
<td style="text-align: left;"><strong>假双栈</strong></td>
<td style="text-align: left;">两个网卡分别承载 IPv4/IPv6</td>
</tr>
<tr>
<td style="text-align: left;"><strong>真双栈</strong></td>
<td style="text-align: left;">同一网卡同时拥有 IPv4 和 IPv6 地址</td>
</tr>
<tr>
<td style="text-align: left;"><strong>纯 IPv6</strong></td>
<td style="text-align: left;">未来目标，彻底解决地址问题</td>
</tr>
</tbody>
</table>
<h4 id="2012">20.1.2 双栈的定义<a class="headerlink" href="#2012" title="Permanent link">&para;</a></h4>
<p><strong>真正的双栈（Dual Stack）</strong>：一个网络接口上同时配置 IPv4 和 IPv6 地址，两种协议栈独立运行。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;双栈网卡&quot;
        NIC[&quot;eth0&quot;]
        IPv4[&quot;IPv4: 10.0.0.1/24&quot;]
        IPv6[&quot;IPv6: fd00::1/64&quot;]

        NIC --&gt; IPv4
        NIC --&gt; IPv6
    end
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>假双栈 vs 真双栈</strong>：</p>
<ul>
<li><strong>假双栈</strong>：两个接口分别提供 IPv4 和 IPv6 服务，客户端根据协议访问不同接口</li>
<li><strong>真双栈</strong>：一个接口同时提供两种协议，客户端可以使用任意协议访问</li>
</ul>
</blockquote>
<h3 id="202-cilium">20.2 Cilium 双栈配置<a class="headerlink" href="#202-cilium" title="Permanent link">&para;</a></h3>
<h4 id="2021-helm">20.2.1 Helm 部署参数<a class="headerlink" href="#2021-helm" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>ipv6.enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>ipam.mode<span class="o">=</span>kubernetes
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>ipv6.enabled=true</code></td>
<td style="text-align: left;">启用 IPv6 支持</td>
</tr>
<tr>
<td style="text-align: left;"><code>ipv4.enabled=true</code></td>
<td style="text-align: left;">默认启用，无需显式设置</td>
</tr>
<tr>
<td style="text-align: left;"><code>kubeProxyReplacement</code></td>
<td style="text-align: left;">双栈暂不支持 strict 模式</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
<strong>注意事项</strong>：Cilium 双栈模式目前不支持 <code>kubeProxyReplacement=strict</code>，需要保留 kube-proxy。</p>
</blockquote>
<h4 id="2022-kind">20.2.2 Kind 集群配置<a class="headerlink" href="#2022-kind" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># kind-config.yaml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cluster</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kind.x-k8s.io/v1alpha4</span>
<span class="nt">networking</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ipFamily</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dual</span><span class="w">  </span><span class="c1"># 关键配置：启用双栈</span>
<span class="w">  </span><span class="nt">podSubnet</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.244.0.0/16,fd00:10:244::/56&quot;</span>
<span class="w">  </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.96.0.0/12,fd00:10:96::/112&quot;</span>
</code></pre></div>
<h3 id="203-pod">20.3 Pod 双栈验证<a class="headerlink" href="#203-pod" title="Permanent link">&para;</a></h3>
<h4 id="2031-pod-ip">20.3.1 查看 Pod IP<a class="headerlink" href="#2031-pod-ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 简单查看（只显示一个 IP）</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-o<span class="w"> </span>wide

<span class="c1"># 详细查看（显示所有 IP）</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="s2">&quot;podIPs&quot;</span>
</code></pre></div>
<p><strong>输出示例</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">podIPs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.244.1.57&quot;</span><span class="w">      </span><span class="c1"># IPv4 地址</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fd00::982a:...&quot;</span><span class="w">   </span><span class="c1"># IPv6 地址</span>
</code></pre></div>
<h4 id="2032">20.3.2 验证网卡配置<a class="headerlink" href="#2032" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 进入 Pod 查看 IP 地址</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>&lt;pod-name&gt;<span class="w"> </span>--<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>eth0
</code></pre></div>
<p><strong>输出示例</strong>：</p>
<div class="highlight"><pre><span></span><code>2: eth0@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500
    inet 10.244.1.57/32 scope global eth0
    inet6 fd00::982a:.../128 scope global
    inet6 fe80::xxxx/64 scope link
</code></pre></div>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Pod 网卡 eth0&quot;
        A[&quot;IPv4: 10.244.1.57/32&quot;]
        B[&quot;IPv6: fd00::982a.../128&lt;br/&gt;(Global)&quot;]
        C[&quot;IPv6: fe80::xxxx/64&lt;br/&gt;(Link-local)&quot;]
    end
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>三种地址</strong>：</p>
<ul>
<li><strong>IPv4 地址</strong>：Pod 的 IPv4 通信地址</li>
<li><strong>IPv6 Global 地址</strong>：Pod 的 IPv6 全局通信地址</li>
<li><strong>IPv6 Link-local 地址</strong>：以 <code>fe80::</code> 开头，仅用于本地链路通信</li>
</ul>
</blockquote>
<h3 id="204-service">20.4 Service 双栈支持<a class="headerlink" href="#204-service" title="Permanent link">&para;</a></h3>
<h4 id="2041-service">20.4.1 Service 配置<a class="headerlink" href="#2041-service" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-svc</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ipFamilyPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PreferDualStack</span><span class="w">  </span><span class="c1"># 优先双栈</span>
<span class="w">  </span><span class="nt">ipFamilies</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPv4</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPv6</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">值</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>ipFamilyPolicy</code></td>
<td style="text-align: left;"><code>PreferDualStack</code></td>
<td style="text-align: left;">优先使用双栈</td>
</tr>
<tr>
<td style="text-align: left;"><code>ipFamilyPolicy</code></td>
<td style="text-align: left;"><code>RequireDualStack</code></td>
<td style="text-align: left;">强制要求双栈</td>
</tr>
<tr>
<td style="text-align: left;"><code>ipFamilies</code></td>
<td style="text-align: left;"><code>[IPv4, IPv6]</code></td>
<td style="text-align: left;">指定支持的 IP 类型</td>
</tr>
</tbody>
</table>
<h4 id="2042-service-ip">20.4.2 验证 Service IP<a class="headerlink" href="#2042-service-ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>demo-svc<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="s2">&quot;clusterIPs&quot;</span>
</code></pre></div>
<p><strong>输出示例</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">clusterIPs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;10.96.44.152&quot;</span><span class="w">     </span><span class="c1"># IPv4 ClusterIP</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;fd00:10:96::xxx&quot;</span><span class="w">  </span><span class="c1"># IPv6 ClusterIP</span>
</code></pre></div>
<h3 id="205-dns">20.5 DNS 解析<a class="headerlink" href="#205-dns" title="Permanent link">&para;</a></h3>
<h4 id="2051-a-aaaa">20.5.1 A 记录与 AAAA 记录<a class="headerlink" href="#2051-a-aaaa" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;DNS 记录类型&quot;
        A[&quot;A 记录&quot;] --&gt;|&quot;返回&quot;| IPv4[&quot;IPv4 地址&quot;]
        AAAA[&quot;AAAA 记录&quot;] --&gt;|&quot;返回&quot;| IPv6[&quot;IPv6 地址&quot;]
    end
</code></pre></div>
<h4 id="2052">20.5.2 解析示例<a class="headerlink" href="#2052" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 解析 IPv4 地址（A 记录）</span>
nslookup<span class="w"> </span>-type<span class="o">=</span>A<span class="w"> </span>demo-svc.default.svc.cluster.local
<span class="c1"># 返回：10.96.44.152</span>

<span class="c1"># 解析 IPv6 地址（AAAA 记录）</span>
nslookup<span class="w"> </span>-type<span class="o">=</span>AAAA<span class="w"> </span>demo-svc.default.svc.cluster.local
<span class="c1"># 返回：fd00:10:96::xxx</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">记录类型</th>
<th style="text-align: left;">返回内容</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>A</strong></td>
<td style="text-align: left;">IPv4 地址</td>
<td style="text-align: left;">IPv4 客户端访问</td>
</tr>
<tr>
<td style="text-align: left;"><strong>AAAA</strong></td>
<td style="text-align: left;">IPv6 地址</td>
<td style="text-align: left;">IPv6 客户端访问</td>
</tr>
</tbody>
</table>
<h3 id="206">20.6 双栈路由<a class="headerlink" href="#206" title="Permanent link">&para;</a></h3>
<h4 id="2061-ipv4">20.6.1 IPv4 路由表<a class="headerlink" href="#2061-ipv4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod 内查看 IPv4 路由</span>
ip<span class="w"> </span>route
</code></pre></div>
<div class="highlight"><pre><span></span><code>default via 10.244.1.5 dev eth0
10.244.1.5 dev eth0 scope link
</code></pre></div>
<h4 id="2062-ipv6">20.6.2 IPv6 路由表<a class="headerlink" href="#2062-ipv6" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod 内查看 IPv6 路由</span>
ip<span class="w"> </span>-6<span class="w"> </span>route
</code></pre></div>
<div class="highlight"><pre><span></span><code>default via fe80::xxxx dev eth0
fd00::/64 dev eth0
</code></pre></div>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;双栈路由&quot;
        Pod[&quot;Pod&quot;]

        subgraph &quot;IPv4 路径&quot;
            GW4[&quot;网关: 10.244.1.5&quot;]
        end

        subgraph &quot;IPv6 路径&quot;
            GW6[&quot;网关: fe80::xxxx&quot;]
        end

        Pod --&gt;|&quot;IPv4 流量&quot;| GW4
        Pod --&gt;|&quot;IPv6 流量&quot;| GW6
    end
</code></pre></div>
<h3 id="207-ipv6">20.7 IPv6 邻居发现<a class="headerlink" href="#207-ipv6" title="Permanent link">&para;</a></h3>
<h4 id="2071-arp">20.7.1 与 ARP 的区别<a class="headerlink" href="#2071-arp" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">IPv4 ARP</th>
<th style="text-align: left;">IPv6 NDP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>协议名称</strong></td>
<td style="text-align: left;">ARP</td>
<td style="text-align: left;">NDP (Neighbor Discovery Protocol)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>请求消息</strong></td>
<td style="text-align: left;">ARP Request</td>
<td style="text-align: left;">NS (Neighbor Solicitation)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>响应消息</strong></td>
<td style="text-align: left;">ARP Reply</td>
<td style="text-align: left;">NA (Neighbor Advertisement)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>复杂度</strong></td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">复杂（有状态机）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>查看命令</strong></td>
<td style="text-align: left;"><code>arp -n</code></td>
<td style="text-align: left;"><code>ip -6 neigh</code></td>
</tr>
</tbody>
</table>
<h4 id="2072-ipv6">20.7.2 IPv6 地址类型<a class="headerlink" href="#2072-ipv6" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;IPv6 地址类型&quot;
        Global[&quot;全局地址&lt;br/&gt;fd00::/8 或 2000::/3&quot;]
        LinkLocal[&quot;链路本地地址&lt;br/&gt;fe80::/10&quot;]
        Multicast[&quot;组播地址&lt;br/&gt;ff00::/8&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">地址类型</th>
<th style="text-align: left;">前缀</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Global</strong></td>
<td style="text-align: left;"><code>2000::/3</code> 或 <code>fd00::/8</code></td>
<td style="text-align: left;">全局通信</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Link-local</strong></td>
<td style="text-align: left;"><code>fe80::/10</code></td>
<td style="text-align: left;">本地链路通信</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Multicast</strong></td>
<td style="text-align: left;"><code>ff00::/8</code></td>
<td style="text-align: left;">组播通信</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>Link-local 地址</strong>：每个启用 IPv6 的网卡都会自动生成一个 <code>fe80::</code> 开头的链路本地地址，用于邻居发现等本地通信。</p>
</blockquote>
<h4 id="2073">20.7.3 邻居发现状态机<a class="headerlink" href="#2073" title="Permanent link">&para;</a></h4>
<p>IPv6 邻居发现有多种状态：</p>
<div class="highlight"><pre><span></span><code>stateDiagram-v2
    [*] --&gt; INCOMPLETE
    INCOMPLETE --&gt; REACHABLE: 收到 NA
    REACHABLE --&gt; STALE: 超时
    STALE --&gt; DELAY: 有数据发送
    DELAY --&gt; PROBE: 超时
    PROBE --&gt; REACHABLE: 收到 NA
    PROBE --&gt; [*]: 失败
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">状态</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>INCOMPLETE</strong></td>
<td style="text-align: left;">正在解析，等待 NA 响应</td>
</tr>
<tr>
<td style="text-align: left;"><strong>REACHABLE</strong></td>
<td style="text-align: left;">可达，最近确认过</td>
</tr>
<tr>
<td style="text-align: left;"><strong>STALE</strong></td>
<td style="text-align: left;">过期，需要重新验证</td>
</tr>
<tr>
<td style="text-align: left;"><strong>DELAY</strong></td>
<td style="text-align: left;">延迟探测</td>
</tr>
<tr>
<td style="text-align: left;"><strong>PROBE</strong></td>
<td style="text-align: left;">主动探测中</td>
</tr>
</tbody>
</table>
<h3 id="208">20.8 跨节点通信验证<a class="headerlink" href="#208" title="Permanent link">&para;</a></h3>
<h4 id="2081-ipv6-ping">20.8.1 IPv6 Ping 测试<a class="headerlink" href="#2081-ipv6-ping" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod 内 ping IPv6 地址</span>
ping6<span class="w"> </span>fd00::9d86:...
</code></pre></div>
<h4 id="2082">20.8.2 抓包分析<a class="headerlink" href="#2082" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在节点上抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>lxc-xxx<span class="w"> </span>icmp6
</code></pre></div>
<p><strong>抓包输出</strong>：</p>
<div class="highlight"><pre><span></span><code># NS/NA 消息（邻居发现）
fe80::xxxx &gt; ff02::1:ffxx:xxxx: ICMP6, neighbor solicitation
fe80::xxxx &gt; fe80::yyyy: ICMP6, neighbor advertisement

# Echo Request/Reply
fd00::982a &gt; fd00::9d86: ICMP6, echo request
fd00::9d86 &gt; fd00::982a: ICMP6, echo reply
</code></pre></div>
<h3 id="209-mac">20.9 MAC 地址学习<a class="headerlink" href="#209-mac" title="Permanent link">&para;</a></h3>
<h4 id="2091-ebpf">20.9.1 eBPF 的作用<a class="headerlink" href="#2091-ebpf" title="Permanent link">&para;</a></h4>
<p>Cilium 使用 eBPF 来处理 IPv6 邻居发现：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;MAC 地址学习&quot;
        NS[&quot;NS 请求&quot;] --&gt; eBPF[&quot;eBPF Hook&quot;]
        eBPF --&gt; NA[&quot;NA 响应&quot;]
        NA --&gt; MAC[&quot;获取 MAC 地址&quot;]
    end
</code></pre></div>
<blockquote>
<p>[!TIP]
Cilium 的 eBPF 程序会劫持邻居发现请求，返回对应的 lxc 网卡 MAC 地址，类似于 Calico 中的 <code>169.254.1.1</code> 代理 ARP 机制。</p>
</blockquote>
<h4 id="2092-mac">20.9.2 验证 MAC 地址<a class="headerlink" href="#2092-mac" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 抓包查看目的 MAC</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>lxc-xxx<span class="w"> </span>-e<span class="w"> </span>icmp6

<span class="c1"># 输出示例</span>
<span class="c1"># src MAC: 7c:f9:26:... (Pod 网卡)</span>
<span class="c1"># dst MAC: b6:44:1b:... (lxc 网卡)</span>
</code></pre></div>
<h3 id="2010">20.10 配置总结<a class="headerlink" href="#2010" title="Permanent link">&para;</a></h3>
<h4 id="20101">20.10.1 完整配置流程<a class="headerlink" href="#20101" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    A[&quot;1. Kind 集群配置&lt;br/&gt;ipFamily: dual&quot;] --&gt; B[&quot;2. Helm 安装 Cilium&lt;br/&gt;ipv6.enabled=true&quot;]
    B --&gt; C[&quot;3. 部署 Pod&lt;br/&gt;自动获取双 IP&quot;]
    C --&gt; D[&quot;4. 创建 Service&lt;br/&gt;ipFamilyPolicy: PreferDualStack&quot;]
    D --&gt; E[&quot;5. 验证通信&lt;br/&gt;ping/ping6 测试&quot;]
</code></pre></div>
<h4 id="20102">20.10.2 关键配置对照表<a class="headerlink" href="#20102" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">层级</th>
<th style="text-align: left;">配置项</th>
<th style="text-align: left;">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Cluster</strong></td>
<td style="text-align: left;"><code>ipFamily</code></td>
<td style="text-align: left;"><code>dual</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cilium</strong></td>
<td style="text-align: left;"><code>ipv6.enabled</code></td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Service</strong></td>
<td style="text-align: left;"><code>ipFamilyPolicy</code></td>
<td style="text-align: left;"><code>PreferDualStack</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Service</strong></td>
<td style="text-align: left;"><code>ipFamilies</code></td>
<td style="text-align: left;"><code>[IPv4, IPv6]</code></td>
</tr>
</tbody>
</table>
<h3 id="2011_1">20.11 章节小结<a class="headerlink" href="#2011_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((双栈模式))
    概念
      同一网卡双 IP
      IPv4 + IPv6 共存
    配置
      ipv6.enabled=true
      ipFamilyPolicy: PreferDualStack
    Pod 验证
      kubectl get pod -o yaml
      ip addr show eth0
    Service 验证
      A 记录返回 IPv4
      AAAA 记录返回 IPv6
    IPv6 特性
      NDP 替代 ARP
      Link-local 地址
      状态机复杂
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li>
<p><strong>什么是双栈</strong>：同一网卡同时拥有 IPv4 和 IPv6 地址</p>
</li>
<li>
<p><strong>配置要点</strong>：</p>
</li>
<li>Cilium: <code>ipv6.enabled=true</code></li>
<li>
<p>Service: <code>ipFamilyPolicy: PreferDualStack</code></p>
</li>
<li>
<p><strong>验证方法</strong>：</p>
</li>
<li>Pod: <code>ip addr show eth0</code> 看到两个地址</li>
<li>
<p>Service: <code>kubectl get svc -o yaml</code> 看到两个 ClusterIP</p>
</li>
<li>
<p><strong>DNS 解析</strong>：</p>
</li>
<li>A 记录 → IPv4 地址</li>
<li>
<p>AAAA 记录 → IPv6 地址</p>
</li>
<li>
<p><strong>IPv6 特性</strong>：</p>
</li>
<li>使用 NDP 替代 ARP</li>
<li>自动生成 Link-local 地址 (<code>fe80::</code>)</li>
<li>
<p>邻居状态机比 ARP 复杂</p>
</li>
<li>
<p><strong>当前限制</strong>：双栈不支持 <code>kubeProxyReplacement=strict</code></p>
</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium-lb-ipam">第二十一章 Cilium-LB-IPAM<a class="headerlink" href="#cilium-lb-ipam" title="Permanent link">&para;</a></h2>
<p>本章介绍 Cilium 的 LB IPAM（LoadBalancer IP Address Management）功能，这是一个专门为 LoadBalancer 类型 Service 分配 IP 地址的工具，常与 BGP Control Plane 结合使用实现外部访问。</p>
<h3 id="211_1">21.1 背景与问题<a class="headerlink" href="#211_1" title="Permanent link">&para;</a></h3>
<h4 id="2111-loadbalancer-service">21.1.1 LoadBalancer Service 的困境<a class="headerlink" href="#2111-loadbalancer-service" title="Permanent link">&para;</a></h4>
<p>在裸金属（Bare Metal）Kubernetes 集群中，创建 LoadBalancer 类型的 Service 时，常遇到以下问题：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;云环境&quot;
        A[&quot;创建 LB Service&quot;] --&gt; B[&quot;云厂商自动分配 IP&quot;]
        B --&gt; C[&quot;External IP 就绪&quot;]
    end

    subgraph &quot;裸金属环境&quot;
        D[&quot;创建 LB Service&quot;] --&gt; E[&quot;无 IP 分配器&quot;]
        E --&gt; F[&quot;External IP: Pending&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">环境</th>
<th style="text-align: left;">LoadBalancer 支持</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>云环境（AWS/GCP/Azure）</strong></td>
<td style="text-align: left;">云厂商自动分配公网 IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>裸金属集群</strong></td>
<td style="text-align: left;">默认无 IP 分配，状态为 Pending</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
很多初学者在部署 Ingress Controller 时遇到 <code>EXTERNAL-IP</code> 一直显示 <code>&lt;pending&gt;</code> 的问题，原因就是没有 LoadBalancer IP 分配器。</p>
</blockquote>
<h4 id="2112">21.1.2 常见解决方案<a class="headerlink" href="#2112" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;LoadBalancer IP 解决方案&quot;
        A[&quot;MetalLB&quot;]
        B[&quot;Cilium LB IPAM&quot;]
        C[&quot;kube-vip&quot;]
        D[&quot;OpenELB&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">方案</th>
<th style="text-align: left;">特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>MetalLB</strong></td>
<td style="text-align: left;">独立项目，支持 L2 和 BGP 模式</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cilium LB IPAM</strong></td>
<td style="text-align: left;">Cilium 内置，需配合 BGP 使用</td>
</tr>
<tr>
<td style="text-align: left;"><strong>kube-vip</strong></td>
<td style="text-align: left;">轻量级，支持 VIP 和 LB</td>
</tr>
</tbody>
</table>
<h3 id="212">21.2 核心概念<a class="headerlink" href="#212" title="Permanent link">&para;</a></h3>
<h4 id="2121-lb-ipam">21.2.1 LB IPAM 的职责<a class="headerlink" href="#2121-lb-ipam" title="Permanent link">&para;</a></h4>
<p><strong>LB IPAM 只负责分配 IP 地址，不负责流量转发！</strong></p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;LB IPAM 职责&quot;
        A[&quot;IP Pool 管理&quot;]
        B[&quot;IP 分配&quot;]
        C[&quot;Service 标签匹配&quot;]
    end

    subgraph &quot;不负责&quot;
        D[&quot;流量路由&quot;]
        E[&quot;负载均衡&quot;]
        F[&quot;外部可达性&quot;]
    end

    A --&gt; B --&gt; C
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>关键理解</strong>：LB IPAM 分配的 IP 地址默认不可路由，需要配合 <strong>BGP Control Plane</strong> 将地址宣告出去，才能实现外部访问。</p>
</blockquote>
<h4 id="2122-bgp">21.2.2 与 BGP 的关系<a class="headerlink" href="#2122-bgp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Svc as Service
    participant IPAM as LB IPAM
    participant BGP as BGP Control Plane
    participant Router as 外部路由器

    Svc-&gt;&gt;IPAM: 请求 LoadBalancer IP
    IPAM-&gt;&gt;Svc: 分配 IP（如 20.0.10.1）
    Note over Svc: EXTERNAL-IP 就绪
    BGP-&gt;&gt;Router: 宣告 20.0.10.1
    Router-&gt;&gt;Router: 更新路由表
    Note over Router: 地址变得可路由
</code></pre></div>
<h3 id="213-cilium-vs-calico">21.3 Cilium vs Calico 设计对比<a class="headerlink" href="#213-cilium-vs-calico" title="Permanent link">&para;</a></h3>
<h4 id="2131-ip">21.3.1 宣告的 IP 类型<a class="headerlink" href="#2131-ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Cilium 方案&quot;
        A[&quot;宣告 LoadBalancer IP&quot;]
        B[&quot;符合 K8s 设计理念&quot;]
        C[&quot;LB IP 本应外部可达&quot;]
    end

    subgraph &quot;Calico 方案&quot;
        D[&quot;宣告 ClusterIP&quot;]
        E[&quot;ClusterIP 变得外部可达&quot;]
        F[&quot;可能违背设计初衷&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">Cilium</th>
<th style="text-align: left;">Calico</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>宣告的 IP</strong></td>
<td style="text-align: left;">LoadBalancer IP</td>
<td style="text-align: left;">ClusterIP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>设计契合度</strong></td>
<td style="text-align: left;">符合 K8s 设计</td>
<td style="text-align: left;">略有争议</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ClusterIP 暴露</strong></td>
<td style="text-align: left;">❌ 保持内部</td>
<td style="text-align: left;">✅ 可外部访问</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
Kubernetes 设计中 ClusterIP 是集群内部地址，Cilium 选择宣告 LB IP 更符合这一理念。</p>
</blockquote>
<h3 id="214">21.4 配置与使用<a class="headerlink" href="#214" title="Permanent link">&para;</a></h3>
<h4 id="2141-crd">21.4.1 CRD 资源<a class="headerlink" href="#2141-crd" title="Permanent link">&para;</a></h4>
<p>Cilium 安装后会自动创建 <code>CiliumLoadBalancerIPPool</code> CRD：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 CRD</span>
kubectl<span class="w"> </span>api-resources<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>cilium<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>pool

<span class="c1"># 输出</span>
ciliumloadbalancerippools<span class="w">  </span>ippools,lbippool<span class="w">  </span>cilium.io/v2alpha1<span class="w">  </span><span class="nb">false</span><span class="w">  </span>CiliumLoadBalancerIPPool
</code></pre></div>
<h4 id="2142-ip-pool">21.4.2 创建 IP Pool<a class="headerlink" href="#2142-ip-pool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium.io/v2alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CiliumLoadBalancerIPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">blocks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20.0.10.0/24&quot;</span><span class="w">   </span><span class="c1"># IP 地址池范围</span>
<span class="w">  </span><span class="nt">serviceSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span><span class="w">             </span><span class="c1"># 匹配的 Service 标签</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium.io/v2alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CiliumLoadBalancerIPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">red-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">blocks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30.0.10.0/24&quot;</span>
<span class="w">  </span><span class="nt">serviceSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">red</span>
</code></pre></div>
<h4 id="2143-ip-pool">21.4.3 IP Pool 结构说明<a class="headerlink" href="#2143-ip-pool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;IP Pool 结构&quot;
        Pool[&quot;CiliumLoadBalancerIPPool&quot;]
        Blocks[&quot;blocks&lt;br/&gt;(IP 地址段列表)&quot;]
        CIDR[&quot;cidr: 20.0.10.0/24&quot;]
        Selector[&quot;serviceSelector&lt;br/&gt;(Service 选择器)&quot;]
        Labels[&quot;matchLabels&lt;br/&gt;color: blue&quot;]

        Pool --&gt; Blocks --&gt; CIDR
        Pool --&gt; Selector --&gt; Labels
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>blocks</code></td>
<td style="text-align: left;">IP 地址段列表，支持多个 CIDR</td>
</tr>
<tr>
<td style="text-align: left;"><code>serviceSelector</code></td>
<td style="text-align: left;">Service 标签选择器</td>
</tr>
<tr>
<td style="text-align: left;"><code>matchLabels</code></td>
<td style="text-align: left;">精确匹配标签</td>
</tr>
<tr>
<td style="text-align: left;"><code>matchExpressions</code></td>
<td style="text-align: left;">表达式匹配（可选）</td>
</tr>
</tbody>
</table>
<h3 id="215-service">21.5 Service 配置<a class="headerlink" href="#215-service" title="Permanent link">&para;</a></h3>
<h4 id="2151-ip-pool-service">21.5.1 创建使用 IP Pool 的 Service<a class="headerlink" href="#2151-ip-pool-service" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-svc</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">red</span><span class="w">    </span><span class="c1"># 匹配 red-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span><span class="w">  </span><span class="c1"># 必须是 LoadBalancer 类型</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<h4 id="2152-ip">21.5.2 验证 IP 分配<a class="headerlink" href="#2152-ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Service</span>
kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>demo-svc

<span class="c1"># 输出示例</span>
NAME<span class="w">       </span>TYPE<span class="w">           </span>CLUSTER-IP<span class="w">    </span>EXTERNAL-IP<span class="w">    </span>PORT<span class="o">(</span>S<span class="o">)</span>
demo-svc<span class="w">   </span>LoadBalancer<span class="w">   </span><span class="m">10</span>.96.1.100<span class="w">   </span><span class="m">30</span>.0.10.208<span class="w">   </span><span class="m">80</span>:31234/TCP
</code></pre></div>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;IP 分配流程&quot;
        A[&quot;Service&lt;br/&gt;labels: color=red&quot;] --&gt; B[&quot;匹配 red-pool&quot;]
        B --&gt; C[&quot;从 30.0.10.0/24 分配&quot;]
        C --&gt; D[&quot;EXTERNAL-IP: 30.0.10.208&quot;]
    end
</code></pre></div>
<h3 id="216">21.6 工作原理<a class="headerlink" href="#216" title="Permanent link">&para;</a></h3>
<h4 id="2161">21.6.1 标签匹配机制<a class="headerlink" href="#2161" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;匹配流程&quot;
        S[&quot;Service 创建&lt;br/&gt;type: LoadBalancer&quot;]
        L[&quot;检查 Service labels&quot;]
        P1[&quot;blue-pool&lt;br/&gt;matchLabels: color=blue&quot;]
        P2[&quot;red-pool&lt;br/&gt;matchLabels: color=red&quot;]
        IP1[&quot;分配 20.0.10.x&quot;]
        IP2[&quot;分配 30.0.10.x&quot;]

        S --&gt; L
        L --&gt;|&quot;color=blue&quot;| P1 --&gt; IP1
        L --&gt;|&quot;color=red&quot;| P2 --&gt; IP2
    end
</code></pre></div>
<h4 id="2162-pool">21.6.2 多 Pool 匹配规则<a class="headerlink" href="#2162-pool" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">行为</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Service 标签匹配单个 Pool</td>
<td style="text-align: left;">从该 Pool 分配 IP</td>
</tr>
<tr>
<td style="text-align: left;">Service 标签匹配多个 Pool</td>
<td style="text-align: left;">从第一个匹配的 Pool 分配</td>
</tr>
<tr>
<td style="text-align: left;">Service 无匹配标签</td>
<td style="text-align: left;">IP 不分配，状态 Pending</td>
</tr>
</tbody>
</table>
<h3 id="217-metallb">21.7 与 MetalLB 对比<a class="headerlink" href="#217-metallb" title="Permanent link">&para;</a></h3>
<h4 id="2171">21.7.1 功能对比<a class="headerlink" href="#2171" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Cilium LB IPAM</th>
<th style="text-align: left;">MetalLB</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>IP 分配</strong></td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>L2 模式</strong></td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BGP 模式</strong></td>
<td style="text-align: left;">✅（需 BGP CP）</td>
<td style="text-align: left;">✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>独立使用</strong></td>
<td style="text-align: left;">❌（需配合 BGP）</td>
<td style="text-align: left;">✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CNI 集成</strong></td>
<td style="text-align: left;">✅ 原生</td>
<td style="text-align: left;">❌ 独立部署</td>
</tr>
</tbody>
</table>
<h4 id="2172">21.7.2 选择建议<a class="headerlink" href="#2172" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;选择指南&quot;
        Q1[&quot;使用 Cilium CNI?&quot;]
        Q2[&quot;有 BGP 基础设施?&quot;]
        A1[&quot;Cilium LB IPAM&lt;br/&gt;+ BGP Control Plane&quot;]
        A2[&quot;MetalLB L2 模式&quot;]
        A3[&quot;MetalLB&quot;]

        Q1 --&gt;|&quot;是&quot;| Q2
        Q1 --&gt;|&quot;否&quot;| A3
        Q2 --&gt;|&quot;是&quot;| A1
        Q2 --&gt;|&quot;否&quot;| A2
    end
</code></pre></div>
<h3 id="218">21.8 重要限制<a class="headerlink" href="#218" title="Permanent link">&para;</a></h3>
<blockquote>
<p>[!WARNING]
<strong>LB IPAM 单独使用时的限制</strong>：</p>
<ol>
<li><strong>IP 不可路由</strong>：分配的 IP 只是写入 Service，外部无法访问</li>
<li><strong>需要 BGP</strong>：必须配合 BGP Control Plane 宣告路由</li>
<li><strong>版本要求</strong>：Cilium 1.13+ 支持 BGP 宣告 LB IP</li>
</ol>
</blockquote>
<h4 id="2181-lb-ipam">21.8.1 单独使用 LB IPAM 的效果<a class="headerlink" href="#2181-lb-ipam" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Service 获得 IP，但无法访问</span>
kubectl<span class="w"> </span>get<span class="w"> </span>svc
NAME<span class="w">       </span>TYPE<span class="w">           </span>EXTERNAL-IP<span class="w">    </span>...
demo-svc<span class="w">   </span>LoadBalancer<span class="w">   </span><span class="m">30</span>.0.10.208<span class="w">   </span>...

<span class="c1"># 从集群外部访问</span>
curl<span class="w"> </span><span class="m">30</span>.0.10.208
<span class="c1"># 超时 - IP 不可路由</span>
</code></pre></div>
<h3 id="219">21.9 完整工作流程<a class="headerlink" href="#219" title="Permanent link">&para;</a></h3>
<h4 id="2191-lb-ipam-bgp-control-plane">21.9.1 LB IPAM + BGP Control Plane<a class="headerlink" href="#2191-lb-ipam-bgp-control-plane" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant User as 用户
    participant Svc as Service
    participant IPAM as LB IPAM
    participant BGP as BGP CP
    participant TOR as ToR 交换机
    participant Client as 外部客户端

    User-&gt;&gt;Svc: 创建 LB Service
    IPAM-&gt;&gt;Svc: 分配 IP 30.0.10.208
    BGP-&gt;&gt;TOR: BGP 宣告 30.0.10.208
    TOR-&gt;&gt;TOR: 更新路由表
    Client-&gt;&gt;TOR: 访问 30.0.10.208
    TOR-&gt;&gt;Svc: 路由到集群节点
    Svc-&gt;&gt;Client: 响应
</code></pre></div>
<h4 id="2192-ecmp">21.9.2 ECMP 负载均衡<a class="headerlink" href="#2192-ecmp" title="Permanent link">&para;</a></h4>
<p>配合 BGP 可实现 ECMP（等价多路径）负载均衡：</p>
<div class="highlight"><pre><span></span><code># 路由表示例
30.0.10.208 via 10.1.5.10  # Node 1
30.0.10.208 via 10.1.5.11  # Node 2
# = 等价路由，流量分担
</code></pre></div>
<h3 id="2110">21.10 章节小结<a class="headerlink" href="#2110" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((LB IPAM))
    概念
      LoadBalancer IP 管理器
      只分配IP不负责路由
    配置
      CiliumLoadBalancerIPPool
      blocks + serviceSelector
    匹配
      Service labels 匹配 Pool
      分配对应网段 IP
    限制
      单独使用IP不可路由
      需配合BGP使用
    对比
      Cilium宣告LB IP
      Calico宣告ClusterIP
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li>
<p><strong>什么是 LB IPAM</strong>：Cilium 内置的 LoadBalancer IP 地址分配器</p>
</li>
<li>
<p><strong>核心职责</strong>：只负责分配 IP，不负责路由和负载均衡</p>
</li>
<li>
<p><strong>配置方式</strong>：</p>
</li>
<li>创建 <code>CiliumLoadBalancerIPPool</code> 定义 IP 池</li>
<li>
<p>Service 通过 labels 匹配 Pool</p>
</li>
<li>
<p><strong>重要限制</strong>：</p>
</li>
<li>单独使用时 IP 不可路由</li>
<li>
<p>需要配合 BGP Control Plane 宣告路由</p>
</li>
<li>
<p><strong>与 Calico 对比</strong>：</p>
</li>
<li>Cilium：宣告 LB IP（符合 K8s 设计）</li>
<li>
<p>Calico：宣告 ClusterIP（有争议）</p>
</li>
<li>
<p><strong>版本要求</strong>：Cilium 1.13+ 才支持 BGP 宣告 LB IP</p>
</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium_4">第二十二章 Cilium 带宽管理<a class="headerlink" href="#cilium_4" title="Permanent link">&para;</a></h2>
<p>本章介绍 Cilium 的带宽管理（Bandwidth Manager）功能，这是一种通过 EDT（Earliest Departure Time）时间戳机制在物理网卡上实现 Pod 流量限速的技术。</p>
<h3 id="221_1">22.1 背景与问题<a class="headerlink" href="#221_1" title="Permanent link">&para;</a></h3>
<h4 id="2211">22.1.1 传统限速思路的局限<a class="headerlink" href="#2211" title="Permanent link">&para;</a></h4>
<p>最直觉的限速方式是在 Pod 的网卡上做限制：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;传统思路&quot;
        Pod[&quot;Pod eth0&quot;] --&gt; LXC[&quot;lxc 网卡&quot;]
        LXC --&gt; PHY[&quot;物理网卡&quot;]

        Pod -.-&gt;|&quot;❌ 在这限速&quot;| Pod
        LXC -.-&gt;|&quot;❌ 在这限速&quot;| LXC
    end
</code></pre></div>
<p><strong>为什么不能在 veth 网卡上限速？</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Buffer Bloat</strong></td>
<td style="text-align: left;">veth 队列缓冲区容易被填满</td>
</tr>
<tr>
<td style="text-align: left;"><strong>TCP TSQ 处理差</strong></td>
<td style="text-align: left;">影响 TCP 小队列优化</td>
</tr>
<tr>
<td style="text-align: left;"><strong>驱动限制</strong></td>
<td style="text-align: left;">veth pair 驱动不支持高级队列调度</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
Docker/Kubernetes 的 veth pair 虚拟网卡在带宽管理上存在天然限制，不适合做精确限速。</p>
</blockquote>
<h4 id="2212-cilium">22.1.2 Cilium 的解决方案<a class="headerlink" href="#2212-cilium" title="Permanent link">&para;</a></h4>
<p>Cilium 选择在<strong>物理网卡</strong>上做限速，通过 EDT 时间戳告诉物理网卡何时发送数据包：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Cilium 方案&quot;
        Pod[&quot;Pod eth0&quot;] --&gt; LXC[&quot;lxc 网卡&quot;]
        LXC --&gt; |&quot;EDT 时间戳&quot;| PHY[&quot;物理网卡&quot;]
        PHY -.-&gt;|&quot;✅ 在这限速&quot;| PHY
    end
</code></pre></div>
<h3 id="222">22.2 核心原理<a class="headerlink" href="#222" title="Permanent link">&para;</a></h3>
<h4 id="2221-edt-earliest-departure-time">22.2.1 EDT (Earliest Departure Time)<a class="headerlink" href="#2221-edt-earliest-departure-time" title="Permanent link">&para;</a></h4>
<p>EDT 是一个内核功能，数据包在发送时会携带一个时间戳，告诉网卡设备这个包最早什么时候可以发出：</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod as Pod
    participant eBPF as eBPF Datapath
    participant NIC as 物理网卡

    Pod-&gt;&gt;eBPF: 发送数据包
    eBPF-&gt;&gt;eBPF: 计算 EDT 时间戳
    eBPF-&gt;&gt;NIC: 数据包 + EDT
    Note over NIC: 根据 EDT 调度发送
    NIC-&gt;&gt;NIC: 时间到才发送
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>EDT 时间戳</strong>是 Linux 内核 5.x 版本引入的功能，Cilium 利用这一特性实现精确的带宽控制。</p>
</blockquote>
<h4 id="2222-mq-fq">22.2.2 MQ + FQ 队列协作<a class="headerlink" href="#2222-mq-fq" title="Permanent link">&para;</a></h4>
<p>物理网卡使用两种队列机制配合实现限速：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;队列调度架构&quot;
        Packets[&quot;数据包流&quot;] --&gt; MQ[&quot;MQ (Multi-Queue)&lt;br/&gt;多队列分发&quot;]
        MQ --&gt; Q1[&quot;队列 1&quot;]
        MQ --&gt; Q2[&quot;队列 2&quot;]
        MQ --&gt; Q3[&quot;队列 N&quot;]

        Q1 --&gt; FQ[&quot;FQ (Fair Queue)&lt;br/&gt;公平队列&quot;]
        Q2 --&gt; FQ
        Q3 --&gt; FQ

        FQ --&gt; |&quot;根据 EDT 调度&quot;| NIC[&quot;网卡发送&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">组件</th>
<th style="text-align: left;">全称</th>
<th style="text-align: left;">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>MQ</strong></td>
<td style="text-align: left;">Multi-Queue</td>
<td style="text-align: left;">多队列，将流量分散到多个 CPU/队列</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FQ</strong></td>
<td style="text-align: left;">Fair Queue</td>
<td style="text-align: left;">公平队列，基于时间轮按 EDT 调度发包</td>
</tr>
</tbody>
</table>
<h4 id="2223">22.2.3 工作流程<a class="headerlink" href="#2223" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    A[&quot;1. Cilium Agent 监控 Pod 注解&quot;]
    B[&quot;2. 读取带宽限制配置&quot;]
    C[&quot;3. 将限制写入 eBPF Datapath&quot;]
    D[&quot;4. 数据包发送时计算 EDT&quot;]
    E[&quot;5. 物理网卡 FQ 根据 EDT 调度&quot;]
    F[&quot;6. 实现带宽限速&quot;]

    A --&gt; B --&gt; C --&gt; D --&gt; E --&gt; F
</code></pre></div>
<h3 id="223_1">22.3 配置方法<a class="headerlink" href="#223_1" title="Permanent link">&para;</a></h3>
<h4 id="2231">22.3.1 启用带宽管理<a class="headerlink" href="#2231" title="Permanent link">&para;</a></h4>
<p>安装 Cilium 时需要开启 <code>bandwidthManager</code> 功能：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>bandwidthManager.enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>bandwidthManager.bbr<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>bpf.masquerade<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>bandwidthManager.enabled=true</code></td>
<td style="text-align: left;">启用带宽管理功能</td>
</tr>
<tr>
<td style="text-align: left;"><code>bandwidthManager.bbr=true</code></td>
<td style="text-align: left;">启用 BBR 拥塞控制算法</td>
</tr>
</tbody>
</table>
<h4 id="2232">22.3.2 验证功能启用<a class="headerlink" href="#2232" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Cilium 状态</span>
cilium<span class="w"> </span>status

<span class="c1"># 输出中确认</span>
BandwidthManager:<span class="w">    </span>EDT<span class="w"> </span>with<span class="w"> </span>BPF<span class="w"> </span><span class="o">[</span>BBR<span class="o">]</span>
</code></pre></div>
<h4 id="2233-pod">22.3.3 Pod 注解配置<a class="headerlink" href="#2233-pod" title="Permanent link">&para;</a></h4>
<p>通过注解（Annotation）为 Pod 设置带宽限制：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bandwidth-limited-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/egress-bandwidth</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;50M&quot;</span><span class="w">   </span><span class="c1"># 限制出站带宽 50Mbps</span>
<span class="w">    </span><span class="c1"># kubernetes.io/ingress-bandwidth: &quot;100M&quot;  # 入站带宽（可选）</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">注解</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>kubernetes.io/egress-bandwidth</code></td>
<td style="text-align: left;">限制出站（发送）带宽</td>
</tr>
<tr>
<td style="text-align: left;"><code>kubernetes.io/ingress-bandwidth</code></td>
<td style="text-align: left;">限制入站（接收）带宽</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
常用单位：<code>K</code>（Kbps）、<code>M</code>（Mbps）、<code>G</code>（Gbps），如 <code>10M</code> 表示 10 Mbps。</p>
</blockquote>
<h3 id="224">22.4 实现原理详解<a class="headerlink" href="#224" title="Permanent link">&para;</a></h3>
<h4 id="2241">22.4.1 为什么在物理网卡限速<a class="headerlink" href="#2241" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;veth 限速问题&quot;
        V1[&quot;veth 队列满&quot;]
        V2[&quot;Buffer Bloat&quot;]
        V3[&quot;TCP 性能下降&quot;]
        V1 --&gt; V2 --&gt; V3
    end

    subgraph &quot;物理网卡优势&quot;
        P1[&quot;硬件队列支持&quot;]
        P2[&quot;MQ+FQ 调度&quot;]
        P3[&quot;EDT 精确控制&quot;]
        P1 --&gt; P2 --&gt; P3
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">veth 网卡</th>
<th style="text-align: left;">物理网卡</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>队列支持</strong></td>
<td style="text-align: left;">简单队列</td>
<td style="text-align: left;">多队列 + 硬件队列</td>
</tr>
<tr>
<td style="text-align: left;"><strong>调度能力</strong></td>
<td style="text-align: left;">有限</td>
<td style="text-align: left;">FQ 公平调度</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能影响</strong></td>
<td style="text-align: left;">大（buffer bloat）</td>
<td style="text-align: left;">小</td>
</tr>
<tr>
<td style="text-align: left;"><strong>限速精度</strong></td>
<td style="text-align: left;">低</td>
<td style="text-align: left;">高（EDT 时间戳）</td>
</tr>
</tbody>
</table>
<h4 id="2242-edt">22.4.2 EDT 时间戳原理<a class="headerlink" href="#2242-edt" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant App as 应用
    participant Kernel as 内核
    participant FQ as FQ 调度器
    participant NIC as 网卡

    App-&gt;&gt;Kernel: 发送数据包
    Kernel-&gt;&gt;Kernel: 计算 EDT = 当前时间 + 延迟
    Kernel-&gt;&gt;FQ: 数据包 + EDT

    Note over FQ: 时间轮调度

    loop 每个时间片
        FQ-&gt;&gt;FQ: 检查 EDT &lt;= 当前时间?
        alt EDT 到达
            FQ-&gt;&gt;NIC: 发送数据包
        else EDT 未到
            FQ-&gt;&gt;FQ: 继续等待
        end
    end
</code></pre></div>
<p><strong>限速计算示例</strong>：</p>
<div class="highlight"><pre><span></span><code>原始带宽：1 Gbps = 每秒发送 1000M 数据
限制带宽：50 Mbps

计算：1000 / 50 = 20 倍

实现：每 20 个时间片才发送 1 个包
结果：带宽降低到 50 Mbps
</code></pre></div>
<h3 id="225">22.5 测试验证<a class="headerlink" href="#225" title="Permanent link">&para;</a></h3>
<h4 id="2251-pod">22.5.1 部署测试 Pod<a class="headerlink" href="#2251-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 10M 带宽限制</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netperf-10m</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/egress-bandwidth</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10M&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netperf</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networkstatic/netperf</span>
<span class="nn">---</span>
<span class="c1"># 100M 带宽限制</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netperf-100m</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/egress-bandwidth</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100M&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netperf</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networkstatic/netperf</span>
</code></pre></div>
<h4 id="2252-netperf">22.5.2 使用 netperf 测试<a class="headerlink" href="#2252-netperf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取服务端 IP</span>
<span class="nv">SERVER_IP</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>netperf-server<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.podIP}&#39;</span><span class="k">)</span>

<span class="c1"># 从限速 Pod 测试带宽</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>netperf-10m<span class="w"> </span>--<span class="w"> </span>netperf<span class="w"> </span>-H<span class="w"> </span><span class="nv">$SERVER_IP</span><span class="w"> </span>-t<span class="w"> </span>TCP_STREAM

<span class="c1"># 预期结果：~9.5 Mbps（接近 10M 限制）</span>
</code></pre></div>
<h4 id="2253">22.5.3 测试结果对照<a class="headerlink" href="#2253" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">配置</th>
<th style="text-align: left;">预期带宽</th>
<th style="text-align: left;">实测带宽</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>egress-bandwidth: 10M</code></td>
<td style="text-align: left;">10 Mbps</td>
<td style="text-align: left;">~9.5 Mbps</td>
</tr>
<tr>
<td style="text-align: left;"><code>egress-bandwidth: 100M</code></td>
<td style="text-align: left;">100 Mbps</td>
<td style="text-align: left;">~93 Mbps</td>
</tr>
<tr>
<td style="text-align: left;">无限制</td>
<td style="text-align: left;">网卡最大</td>
<td style="text-align: left;">~500+ Mbps</td>
</tr>
</tbody>
</table>
<h3 id="226">22.6 与传统方案对比<a class="headerlink" href="#226" title="Permanent link">&para;</a></h3>
<h4 id="2261-cni-bandwidth">22.6.1 与 CNI bandwidth 插件对比<a class="headerlink" href="#2261-cni-bandwidth" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;传统方案 - CNI bandwidth&quot;
        A1[&quot;使用 tc 规则&quot;]
        A2[&quot;在 veth 上限速&quot;]
        A3[&quot;tbf/htb 队列&quot;]
    end

    subgraph &quot;Cilium 方案&quot;
        B1[&quot;使用 eBPF + EDT&quot;]
        B2[&quot;在物理网卡限速&quot;]
        B3[&quot;MQ + FQ 调度&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">CNI bandwidth 插件</th>
<th style="text-align: left;">Cilium 带宽管理</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>限速位置</strong></td>
<td style="text-align: left;">veth 网卡</td>
<td style="text-align: left;">物理网卡</td>
</tr>
<tr>
<td style="text-align: left;"><strong>实现方式</strong></td>
<td style="text-align: left;">tc (tbf/htb)</td>
<td style="text-align: left;">eBPF + EDT</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能影响</strong></td>
<td style="text-align: left;">较大</td>
<td style="text-align: left;">较小</td>
</tr>
<tr>
<td style="text-align: left;"><strong>精度</strong></td>
<td style="text-align: left;">一般</td>
<td style="text-align: left;">高</td>
</tr>
<tr>
<td style="text-align: left;"><strong>TCP 优化</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">TSQ 支持</td>
</tr>
</tbody>
</table>
<h3 id="227">22.7 重要限制<a class="headerlink" href="#227" title="Permanent link">&para;</a></h3>
<blockquote>
<p>[!CAUTION]
<strong>使用限制</strong>：</p>
<ol>
<li><strong>不支持 Kind 环境</strong>：Kind 使用 veth pair，无法正确限速</li>
<li><strong>需要物理/虚拟机环境</strong>：必须有真正的物理网卡驱动</li>
<li><strong>内核版本要求</strong>：需要支持 EDT 的内核（5.x+）</li>
<li><strong>主要限制 egress</strong>：入站限速场景较少</li>
</ol>
</blockquote>
<h3 id="228">22.8 注意事项<a class="headerlink" href="#228" title="Permanent link">&para;</a></h3>
<h4 id="2281">22.8.1 环境要求<a class="headerlink" href="#2281" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;支持的环境&quot;
        A[&quot;物理服务器&quot;]
        B[&quot;VMware/KVM 虚拟机&quot;]
        C[&quot;云服务器&quot;]
    end

    subgraph &quot;不支持的环境&quot;
        D[&quot;Kind 集群&quot;]
        E[&quot;Docker Desktop&quot;]
    end
</code></pre></div>
<h4 id="2282">22.8.2 驱动检查<a class="headerlink" href="#2282" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看网卡驱动</span>
ethtool<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>driver

<span class="c1"># 物理网卡驱动示例</span>
driver:<span class="w"> </span>vmxnet3<span class="w">     </span><span class="c1"># VMware</span>
driver:<span class="w"> </span>virtio_net<span class="w">  </span><span class="c1"># KVM</span>
driver:<span class="w"> </span>ixgbe<span class="w">       </span><span class="c1"># Intel 万兆</span>
</code></pre></div>
<h3 id="229">22.9 章节小结<a class="headerlink" href="#229" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((带宽管理))
    原理
      EDT时间戳
      物理网卡限速
      MQ+FQ队列
    配置
      bandwidthManager.enabled
      Pod注解方式
    限速注解
      egress-bandwidth
      ingress-bandwidth
    限制
      不支持Kind
      需要真实网卡
      内核5.x+
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li>
<p><strong>为什么不在 veth 限速</strong>：Buffer Bloat、队列受限、精度差</p>
</li>
<li>
<p><strong>Cilium 方案</strong>：在物理网卡使用 EDT 时间戳限速</p>
</li>
<li>
<p><strong>启用方式</strong>：</p>
</li>
<li>Helm: <code>bandwidthManager.enabled=true</code></li>
<li>
<p>Pod: <code>kubernetes.io/egress-bandwidth: "50M"</code></p>
</li>
<li>
<p><strong>工作原理</strong>：</p>
</li>
<li>eBPF 为数据包打上 EDT 时间戳</li>
<li>
<p>FQ 调度器根据 EDT 控制发包时机</p>
</li>
<li>
<p><strong>MQ + FQ 协作</strong>：</p>
</li>
<li>MQ（多队列）分散流量</li>
<li>
<p>FQ（公平队列）按时间调度</p>
</li>
<li>
<p><strong>环境要求</strong>：</p>
</li>
<li>需要真实物理/虚拟网卡</li>
<li>不支持 Kind（veth pair）</li>
<li>内核版本 5.x+</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium-ingress-controller">第二十三章 Cilium Ingress Controller<a class="headerlink" href="#cilium-ingress-controller" title="Permanent link">&para;</a></h2>
<p>本章介绍 Cilium 原生的 Ingress Controller 功能，无需部署额外的 Ingress 控制器（如 Nginx Ingress），Cilium 可以直接提供七层负载均衡能力。</p>
<h3 id="231">23.1 背景与概念<a class="headerlink" href="#231" title="Permanent link">&para;</a></h3>
<h4 id="2311-ingress">23.1.1 Ingress 回顾<a class="headerlink" href="#2311-ingress" title="Permanent link">&para;</a></h4>
<p>Ingress 是 Kubernetes 中用于管理七层（HTTP/HTTPS）流量入口的资源：</p>
<div class="highlight"><pre><span></span><code>graph LR
    Client[&quot;外部客户端&quot;] --&gt; LB[&quot;LoadBalancer&lt;br/&gt;L4 负载均衡&quot;]
    LB --&gt; IC[&quot;Ingress Controller&lt;br/&gt;L7 负载均衡&quot;]
    IC --&gt; |&quot;基于 URI 路由&quot;| Svc1[&quot;Service A&quot;]
    IC --&gt; |&quot;基于 URI 路由&quot;| Svc2[&quot;Service B&quot;]
    Svc1 --&gt; Pod1[&quot;Pod A&quot;]
    Svc2 --&gt; Pod2[&quot;Pod B&quot;]
</code></pre></div>
<p><strong>四层 vs 七层负载均衡</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">四层（L4）</th>
<th style="text-align: left;">七层（L7）</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>工作层</strong></td>
<td style="text-align: left;">传输层（TCP/UDP）</td>
<td style="text-align: left;">应用层（HTTP/HTTPS）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>路由依据</strong></td>
<td style="text-align: left;">IP + 端口</td>
<td style="text-align: left;">URL 路径、Host 头</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SSL 卸载</strong></td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>典型场景</strong></td>
<td style="text-align: left;">Service LoadBalancer</td>
<td style="text-align: left;">Ingress</td>
</tr>
</tbody>
</table>
<h4 id="2312-ingress">23.1.2 传统 Ingress 架构<a class="headerlink" href="#2312-ingress" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;传统方案&quot;
        Nginx[&quot;Nginx Ingress Controller&quot;]
        Rules[&quot;Ingress Rules&quot;]
        Backend[&quot;后端 Service/Pod&quot;]

        Nginx --&gt; |&quot;解析 Rules&quot;| Rules
        Rules --&gt; |&quot;路由到&quot;| Backend
    end
</code></pre></div>
<p>需要额外部署 Nginx Ingress、Traefik 等控制器。</p>
<h4 id="2313-cilium-ingress-controller">23.1.3 Cilium Ingress Controller<a class="headerlink" href="#2313-cilium-ingress-controller" title="Permanent link">&para;</a></h4>
<p>Cilium 内置 Ingress Controller，无需额外组件：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Cilium 方案&quot;
        Cilium[&quot;Cilium Agent&lt;br/&gt;内置 Ingress Controller&quot;]
        Envoy[&quot;Envoy L7 Proxy&quot;]
        Rules[&quot;Ingress Rules&quot;]
        Backend[&quot;后端 Service/Pod&quot;]

        Cilium --&gt; Envoy
        Envoy --&gt; |&quot;解析 Rules&quot;| Rules
        Rules --&gt; |&quot;路由到&quot;| Backend
    end
</code></pre></div>
<blockquote>
<p>[!TIP]
Cilium 使用 Envoy 作为七层代理，提供 Ingress Controller 能力，同时为 Service Mesh 功能奠定基础。</p>
</blockquote>
<h3 id="232">23.2 前置要求<a class="headerlink" href="#232" title="Permanent link">&para;</a></h3>
<h4 id="2321">23.2.1 配置要求<a class="headerlink" href="#2321" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">要求</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>kubeProxyReplacement</strong></td>
<td style="text-align: left;">必须为 <code>strict</code> 或 <code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>L7 Proxy</strong></td>
<td style="text-align: left;">默认启用</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Kubernetes 版本</strong></td>
<td style="text-align: left;">≥ 1.19</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cilium 版本</strong></td>
<td style="text-align: left;">≥ 1.13</td>
</tr>
</tbody>
</table>
<h4 id="2322-ingress-controller">23.2.2 启用 Ingress Controller<a class="headerlink" href="#2322-ingress-controller" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>ingressController.enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>ingressController.loadbalancerMode<span class="o">=</span>dedicated
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>ingressController.enabled=true</code></td>
<td style="text-align: left;">启用 Ingress Controller</td>
</tr>
<tr>
<td style="text-align: left;"><code>ingressController.loadbalancerMode</code></td>
<td style="text-align: left;"><code>dedicated</code>（专用）或 <code>shared</code>（共享）</td>
</tr>
</tbody>
</table>
<h3 id="233-http">23.3 HTTP 模式<a class="headerlink" href="#233-http" title="Permanent link">&para;</a></h3>
<h4 id="2331">23.3.1 工作流程<a class="headerlink" href="#2331" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as 客户端
    participant LB as LoadBalancer
    participant Envoy as Cilium Envoy
    participant Svc as Service
    participant Pod as Pod

    Client-&gt;&gt;LB: HTTP 请求 (pass: /details)
    LB-&gt;&gt;Envoy: 转发请求
    Envoy-&gt;&gt;Envoy: 解析 Ingress Rules
    Envoy-&gt;&gt;Svc: 匹配后端服务
    Svc-&gt;&gt;Pod: 路由到 Pod
    Pod-&gt;&gt;Client: 返回响应
</code></pre></div>
<h4 id="2332">23.3.2 创建后端服务<a class="headerlink" href="#2332" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 部署后端应用</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/istio/examples-bookinfo-productpage-v1:1.16.2</span>
<span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
</code></pre></div>
<h4 id="2333-ingress">23.3.3 创建 Ingress 资源<a class="headerlink" href="#2333-ingress" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">basic-ingress</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium</span><span class="w">    </span><span class="c1"># 使用 Cilium Ingress Controller</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/details</span>
<span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">              </span><span class="nt">service</span><span class="p">:</span>
<span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">details</span>
<span class="w">                </span><span class="nt">port</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">              </span><span class="nt">service</span><span class="p">:</span>
<span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">                </span><span class="nt">port</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
</code></pre></div>
<h4 id="2334">23.3.4 验证配置<a class="headerlink" href="#2334" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Ingress</span>
kubectl<span class="w"> </span>get<span class="w"> </span>ingress

<span class="c1"># 输出示例</span>
NAME<span class="w">            </span>CLASS<span class="w">    </span>HOSTS<span class="w">   </span>ADDRESS<span class="w">        </span>PORTS
basic-ingress<span class="w">   </span>cilium<span class="w">   </span>*<span class="w">       </span><span class="m">172</span>.18.0.200<span class="w">   </span><span class="m">80</span>

<span class="c1"># 测试访问</span>
curl<span class="w"> </span>http://172.18.0.200/details<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq
</code></pre></div>
<h3 id="234-https">23.4 HTTPS 模式<a class="headerlink" href="#234-https" title="Permanent link">&para;</a></h3>
<h4 id="2341-tls">23.4.1 TLS 卸载原理<a class="headerlink" href="#2341-tls" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as 客户端
    participant Envoy as Cilium Envoy
    participant Pod as 后端 Pod

    Client-&gt;&gt;Envoy: HTTPS (TLS 加密)
    Note over Envoy: TLS 卸载（解密）
    Envoy-&gt;&gt;Pod: HTTP (明文)
    Pod-&gt;&gt;Envoy: HTTP 响应
    Note over Envoy: TLS 加密
    Envoy-&gt;&gt;Client: HTTPS 响应
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>信任域划分</strong>：</p>
<ul>
<li><strong>非信任域</strong>：客户端 ↔ Ingress Controller（HTTPS）</li>
<li><strong>信任域</strong>：Ingress Controller ↔ 后端 Pod（HTTP）</li>
</ul>
</blockquote>
<h4 id="2342-tls">23.4.2 创建 TLS 证书<a class="headerlink" href="#2342-tls" title="Permanent link">&para;</a></h4>
<p><strong>方式一：使用 minica</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 安装 minica</span>
go<span class="w"> </span>install<span class="w"> </span>github.com/jsha/minica@latest

<span class="c1"># 生成证书</span>
minica<span class="w"> </span>--domains<span class="w"> </span>demo.cilium.rocks

<span class="c1"># 创建 Secret</span>
kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>tls<span class="w"> </span>demo-cert<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cert<span class="o">=</span>demo.cilium.rocks/cert.pem<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--key<span class="o">=</span>demo.cilium.rocks/key.pem
</code></pre></div>
<p><strong>方式二：使用 OpenSSL</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 生成自签名证书</span>
openssl<span class="w"> </span>req<span class="w"> </span>-x509<span class="w"> </span>-nodes<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-keyout<span class="w"> </span>tls.key<span class="w"> </span>-out<span class="w"> </span>tls.crt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=demo.cilium.rocks&quot;</span>

<span class="c1"># 创建 Secret</span>
kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>tls<span class="w"> </span>demo-cert<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cert<span class="o">=</span>tls.crt<span class="w"> </span>--key<span class="o">=</span>tls.key
</code></pre></div>
<p><strong>方式三：使用 cert-manager</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Certificate</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-cert</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-cert</span>
<span class="w">  </span><span class="nt">dnsNames</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo.cilium.rocks</span>
<span class="w">  </span><span class="nt">issuerRef</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
<span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
</code></pre></div>
<h4 id="2343-https-ingress">23.4.3 创建 HTTPS Ingress<a class="headerlink" href="#2343-https-ingress" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-ingress</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium</span>
<span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo.cilium.rocks</span>
<span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-cert</span><span class="w">     </span><span class="c1"># 引用 TLS Secret</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo.cilium.rocks</span><span class="w">   </span><span class="c1"># 指定 Host</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">              </span><span class="nt">service</span><span class="p">:</span>
<span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">                </span><span class="nt">port</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
</code></pre></div>
<h4 id="2344-https">23.4.4 验证 HTTPS<a class="headerlink" href="#2344-https" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 添加 hosts 解析</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;172.18.0.200 demo.cilium.rocks&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/hosts

<span class="c1"># 测试 HTTPS 访问</span>
curl<span class="w"> </span>-k<span class="w"> </span>-v<span class="w"> </span>https://demo.cilium.rocks/

<span class="c1"># 查看 TLS 握手信息</span>
curl<span class="w"> </span>-k<span class="w"> </span>-v<span class="w"> </span>https://demo.cilium.rocks/<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A5<span class="w"> </span><span class="s2">&quot;SSL connection&quot;</span>
</code></pre></div>
<h3 id="235-loadbalancer">23.5 与 LoadBalancer 配合<a class="headerlink" href="#235-loadbalancer" title="Permanent link">&para;</a></h3>
<h4 id="2351-metallb">23.5.1 MetalLB 集成<a class="headerlink" href="#2351-metallb" title="Permanent link">&para;</a></h4>
<p>Ingress Controller 需要 LoadBalancer 类型的 Service 暴露外部访问：</p>
<div class="highlight"><pre><span></span><code>graph LR
    Client[&quot;外部客户端&quot;] --&gt; MetalLB[&quot;MetalLB&lt;br/&gt;L2/BGP 模式&quot;]
    MetalLB --&gt; |&quot;External IP&quot;| Ingress[&quot;Cilium Ingress&lt;br/&gt;Controller&quot;]
    Ingress --&gt; Pod[&quot;后端 Pod&quot;]
</code></pre></div>
<h4 id="2352-metallb">23.5.2 MetalLB 配置<a class="headerlink" href="#2352-metallb" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># MetalLB L2 模式配置</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPAddressPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">addresses</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.18.0.200-172.18.0.254</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">L2Advertisement</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb-system</span>
</code></pre></div>
<h3 id="236-ingress">23.6 Ingress 资源详解<a class="headerlink" href="#236-ingress" title="Permanent link">&para;</a></h3>
<h4 id="2361">23.6.1 资源结构<a class="headerlink" href="#2361" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Ingress 结构&quot;
        Ingress[&quot;Ingress&quot;]
        Class[&quot;ingressClassName: cilium&quot;]
        TLS[&quot;tls（可选）&quot;]
        Rules[&quot;rules&quot;]
        Host[&quot;host&quot;]
        Paths[&quot;paths&quot;]
        Backend[&quot;backend&quot;]

        Ingress --&gt; Class
        Ingress --&gt; TLS
        Ingress --&gt; Rules
        Rules --&gt; Host
        Rules --&gt; Paths
        Paths --&gt; Backend
    end
</code></pre></div>
<h4 id="2362">23.6.2 关键字段<a class="headerlink" href="#2362" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>ingressClassName</code></td>
<td style="text-align: left;">指定使用的 Ingress Controller</td>
</tr>
<tr>
<td style="text-align: left;"><code>tls.hosts</code></td>
<td style="text-align: left;">TLS 证书适用的域名</td>
</tr>
<tr>
<td style="text-align: left;"><code>tls.secretName</code></td>
<td style="text-align: left;">包含证书的 Secret 名称</td>
</tr>
<tr>
<td style="text-align: left;"><code>rules.host</code></td>
<td style="text-align: left;">匹配的 Host 头（可选）</td>
</tr>
<tr>
<td style="text-align: left;"><code>rules.http.paths</code></td>
<td style="text-align: left;">URL 路径匹配规则</td>
</tr>
<tr>
<td style="text-align: left;"><code>backend.service</code></td>
<td style="text-align: left;">后端 Service 配置</td>
</tr>
</tbody>
</table>
<h3 id="237">23.7 与传统方案对比<a class="headerlink" href="#237" title="Permanent link">&para;</a></h3>
<h4 id="2371">23.7.1 功能对比<a class="headerlink" href="#2371" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Nginx Ingress</th>
<th style="text-align: left;">Cilium Ingress</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>部署方式</strong></td>
<td style="text-align: left;">独立 Deployment</td>
<td style="text-align: left;">CNI 内置</td>
</tr>
<tr>
<td style="text-align: left;"><strong>L7 代理</strong></td>
<td style="text-align: left;">Nginx</td>
<td style="text-align: left;">Envoy</td>
</tr>
<tr>
<td style="text-align: left;"><strong>配置方式</strong></td>
<td style="text-align: left;">注解 + ConfigMap</td>
<td style="text-align: left;">标准 Ingress</td>
</tr>
<tr>
<td style="text-align: left;"><strong>与 CNI 集成</strong></td>
<td style="text-align: left;">独立</td>
<td style="text-align: left;">原生集成</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Service Mesh</strong></td>
<td style="text-align: left;">需额外组件</td>
<td style="text-align: left;">原生支持</td>
</tr>
</tbody>
</table>
<h4 id="2372">23.7.2 选择建议<a class="headerlink" href="#2372" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    Q1[&quot;使用 Cilium CNI?&quot;]
    Q2[&quot;需要 Service Mesh?&quot;]
    A1[&quot;Cilium Ingress&lt;br/&gt;原生集成&quot;]
    A2[&quot;Nginx/Traefik&lt;br/&gt;成熟稳定&quot;]

    Q1 --&gt;|&quot;是&quot;| Q2
    Q1 --&gt;|&quot;否&quot;| A2
    Q2 --&gt;|&quot;是&quot;| A1
    Q2 --&gt;|&quot;否&quot;| A1
</code></pre></div>
<h3 id="238">23.8 注意事项<a class="headerlink" href="#238" title="Permanent link">&para;</a></h3>
<blockquote>
<p>[!WARNING]
<strong>使用注意</strong>：</p>
<ol>
<li><strong>HTTP 模式异常</strong>：部分版本可能出现 503 错误，建议创建资源后等待 2-3 分钟</li>
<li><strong>Host 必填（HTTPS）</strong>：TLS 模式必须指定 host 字段</li>
<li><strong>LoadBalancer 依赖</strong>：需要 MetalLB 或云厂商 LB 提供 External IP</li>
<li><strong>证书有效期</strong>：自签证书需注意过期问题，生产环境建议使用 cert-manager</li>
</ol>
</blockquote>
<h3 id="239">23.9 章节小结<a class="headerlink" href="#239" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Cilium Ingress))
    概念
      Cilium内置L7代理
      基于Envoy
    启用
      ingressController.enabled
      kubeProxyReplacement
    HTTP模式
      ingressClassName: cilium
      path路由
    HTTPS模式
      TLS证书
      SSL卸载
    依赖
      LoadBalancer
      MetalLB/云LB
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li>
<p><strong>什么是 Cilium Ingress</strong>：Cilium 内置的七层 Ingress Controller，基于 Envoy</p>
</li>
<li>
<p><strong>前置要求</strong>：</p>
</li>
<li><code>kubeProxyReplacement=true</code></li>
<li>
<p><code>ingressController.enabled=true</code></p>
</li>
<li>
<p><strong>HTTP 模式</strong>：</p>
</li>
<li><code>ingressClassName: cilium</code></li>
<li>
<p>定义 path 和后端 Service</p>
</li>
<li>
<p><strong>HTTPS 模式</strong>：</p>
</li>
<li>添加 <code>tls</code> 字段配置证书</li>
<li>
<p>必须指定 <code>host</code> 字段</p>
</li>
<li>
<p><strong>TLS 证书创建</strong>：</p>
</li>
<li>minica / OpenSSL / cert-manager</li>
<li>
<p>创建为 Kubernetes Secret</p>
</li>
<li>
<p><strong>依赖组件</strong>：</p>
</li>
<li>需要 LoadBalancer（MetalLB/云 LB）提供外部 IP</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium-gateway-api">第二十四章 Cilium Gateway API<a class="headerlink" href="#cilium-gateway-api" title="Permanent link">&para;</a></h2>
<p>本章介绍 Cilium 对 Kubernetes Gateway API 的支持。Gateway API 是 Ingress 的下一代替代方案，提供更强大、更标准化的七层流量管理能力。</p>
<h3 id="241">24.1 背景与概念<a class="headerlink" href="#241" title="Permanent link">&para;</a></h3>
<h4 id="2411-gateway-api">24.1.1 什么是 Gateway API<a class="headerlink" href="#2411-gateway-api" title="Permanent link">&para;</a></h4>
<p>Gateway API 是 Kubernetes SIG-Network 设计的新一代流量管理 API，目标是替代 Ingress：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;演进历程&quot;
        Ingress[&quot;Ingress&lt;br/&gt;（传统方式）&quot;] --&gt; GatewayAPI[&quot;Gateway API&lt;br/&gt;（新一代）&quot;]
    end

    subgraph &quot;Gateway API 特点&quot;
        A[&quot;更强表达能力&quot;]
        B[&quot;角色分离&quot;]
        C[&quot;跨命名空间&quot;]
        D[&quot;可扩展性&quot;]
    end
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>Gateway API</strong> 是 Kubernetes 官方推荐的 Ingress 替代方案，Cilium 通过 Envoy 原生支持 Gateway API。</p>
</blockquote>
<h4 id="2412-ingress">24.1.2 与 Ingress 对比<a class="headerlink" href="#2412-ingress" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Ingress</th>
<th style="text-align: left;">Gateway API</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>API 成熟度</strong></td>
<td style="text-align: left;">稳定（GA）</td>
<td style="text-align: left;">逐步稳定（部分 Beta）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>表达能力</strong></td>
<td style="text-align: left;">有限</td>
<td style="text-align: left;">更丰富</td>
</tr>
<tr>
<td style="text-align: left;"><strong>角色分离</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">支持（Infra/Cluster/App）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>TLS 管理</strong></td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">更灵活</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨命名空间</strong></td>
<td style="text-align: left;">复杂</td>
<td style="text-align: left;">原生支持</td>
</tr>
<tr>
<td style="text-align: left;"><strong>扩展性</strong></td>
<td style="text-align: left;">注解（非标准）</td>
<td style="text-align: left;">标准化扩展</td>
</tr>
</tbody>
</table>
<h4 id="2413">24.1.3 核心资源对象<a class="headerlink" href="#2413" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Gateway API 资源&quot;
        GC[&quot;GatewayClass&lt;br/&gt;定义控制器类型&quot;]
        GW[&quot;Gateway&lt;br/&gt;定义入口网关&quot;]
        HR[&quot;HTTPRoute&lt;br/&gt;定义路由规则&quot;]

        GC --&gt; GW
        GW --&gt; HR
        HR --&gt; Svc[&quot;后端 Service&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">资源</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>GatewayClass</strong></td>
<td style="text-align: left;">定义使用的 Gateway 控制器（如 Cilium）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Gateway</strong></td>
<td style="text-align: left;">定义入口网关（监听端口、TLS 配置）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>HTTPRoute</strong></td>
<td style="text-align: left;">定义 HTTP 路由规则（类似 Ingress Rules）</td>
</tr>
</tbody>
</table>
<h3 id="242">24.2 前置要求<a class="headerlink" href="#242" title="Permanent link">&para;</a></h3>
<h4 id="2421">24.2.1 配置要求<a class="headerlink" href="#2421" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">要求</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>kubeProxyReplacement</strong></td>
<td style="text-align: left;">必须为 <code>strict</code> 或 <code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>L7 Proxy</strong></td>
<td style="text-align: left;">默认启用</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Gateway API CRDs</strong></td>
<td style="text-align: left;">必须预先安装</td>
</tr>
</tbody>
</table>
<h4 id="2422-gateway-api-crds">24.2.2 安装 Gateway API CRDs<a class="headerlink" href="#2422-gateway-api-crds" title="Permanent link">&para;</a></h4>
<p><strong>必须预先安装四个 CRD</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 安装 Gateway API CRDs</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.0.0/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.0.0/config/crd/standard/gateway.networking.k8s.io_gateways.yaml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.0.0/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.0.0/config/crd/standard/gateway.networking.k8s.io_referencegrants.yaml
</code></pre></div>
<blockquote>
<p>[!CAUTION]
<strong>必须先安装 CRDs</strong>！如果不预先安装 Gateway API CRDs，Cilium 将无法启用 Gateway API 功能。</p>
</blockquote>
<h4 id="2423-gateway-api">24.2.3 启用 Gateway API<a class="headerlink" href="#2423-gateway-api" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>gatewayAPI.enabled<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>gatewayAPI.enabled=true</code></td>
<td style="text-align: left;">启用 Gateway API 支持</td>
</tr>
</tbody>
</table>
<h3 id="243-http">24.3 HTTP 模式<a class="headerlink" href="#243-http" title="Permanent link">&para;</a></h3>
<h4 id="2431">24.3.1 工作流程<a class="headerlink" href="#2431" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as 客户端
    participant GW as Gateway
    participant Route as HTTPRoute
    participant Svc as Service
    participant Pod as Pod

    Client-&gt;&gt;GW: HTTP 请求
    GW-&gt;&gt;Route: 匹配路由规则
    Route-&gt;&gt;Svc: 转发到后端
    Svc-&gt;&gt;Pod: 路由到 Pod
    Pod-&gt;&gt;Client: 返回响应
</code></pre></div>
<h4 id="2432-gateway">24.3.2 创建 Gateway<a class="headerlink" href="#2432-gateway" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gateway.networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Gateway</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">gatewayClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium</span><span class="w">    </span><span class="c1"># 使用 Cilium 作为控制器</span>
<span class="w">  </span><span class="nt">listeners</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">allowedRoutes</span><span class="p">:</span>
<span class="w">        </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">          </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Same</span>
</code></pre></div>
<h4 id="2433-httproute">24.3.3 创建 HTTPRoute<a class="headerlink" href="#2433-httproute" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gateway.networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTPRoute</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http-route</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium-gateway</span><span class="w">     </span><span class="c1"># 关联 Gateway</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matches</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PathPrefix</span>
<span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/details</span>
<span class="w">      </span><span class="nt">backendRefs</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">details</span>
<span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matches</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PathPrefix</span>
<span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">      </span><span class="nt">backendRefs</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
</code></pre></div>
<h4 id="2434">24.3.4 验证配置<a class="headerlink" href="#2434" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Gateway</span>
kubectl<span class="w"> </span>get<span class="w"> </span>gateway

<span class="c1"># 输出示例</span>
NAME<span class="w">             </span>CLASS<span class="w">    </span>ADDRESS<span class="w">        </span>READY
cilium-gateway<span class="w">   </span>cilium<span class="w">   </span><span class="m">172</span>.18.0.200<span class="w">   </span>True

<span class="c1"># 查看 HTTPRoute</span>
kubectl<span class="w"> </span>get<span class="w"> </span>httproute

<span class="c1"># 测试访问</span>
<span class="nv">LB_IP</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>gateway<span class="w"> </span>cilium-gateway<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.addresses[0].value}&#39;</span><span class="k">)</span>
curl<span class="w"> </span>http://<span class="nv">$LB_IP</span>/details<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq
</code></pre></div>
<h3 id="244-https">24.4 HTTPS 模式<a class="headerlink" href="#244-https" title="Permanent link">&para;</a></h3>
<h4 id="2441-tls">24.4.1 TLS 配置架构<a class="headerlink" href="#2441-tls" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    Client[&quot;客户端&quot;] --&gt;|&quot;HTTPS&quot;| GW[&quot;Gateway&lt;br/&gt;TLS 终结&quot;]
    GW --&gt;|&quot;HTTP&quot;| Route[&quot;HTTPRoute&quot;]
    Route --&gt; Pod[&quot;后端 Pod&quot;]
</code></pre></div>
<h4 id="2442-tls">24.4.2 创建 TLS 证书<a class="headerlink" href="#2442-tls" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用 minica 生成证书</span>
minica<span class="w"> </span>--domains<span class="w"> </span>bookinfo.cilium.rocks

<span class="c1"># 创建 Secret</span>
kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>tls<span class="w"> </span>bookinfo-cert<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cert<span class="o">=</span>bookinfo.cilium.rocks/cert.pem<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--key<span class="o">=</span>bookinfo.cilium.rocks/key.pem
</code></pre></div>
<h4 id="2443-https-gateway">24.4.3 创建 HTTPS Gateway<a class="headerlink" href="#2443-https-gateway" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gateway.networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Gateway</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">gatewayClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium</span>
<span class="w">  </span><span class="nt">listeners</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTPS</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">      </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bookinfo.cilium.rocks</span>
<span class="w">      </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Terminate</span>
<span class="w">        </span><span class="nt">certificateRefs</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bookinfo-cert</span><span class="w">    </span><span class="c1"># 引用 TLS Secret</span>
<span class="w">      </span><span class="nt">allowedRoutes</span><span class="p">:</span>
<span class="w">        </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">          </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Same</span>
</code></pre></div>
<h4 id="2444-https-httproute">24.4.4 创建 HTTPS HTTPRoute<a class="headerlink" href="#2444-https-httproute" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gateway.networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTPRoute</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https-route</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-gateway</span>
<span class="w">  </span><span class="nt">hostnames</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bookinfo.cilium.rocks</span><span class="w">      </span><span class="c1"># 必须匹配 Gateway 的 hostname</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matches</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PathPrefix</span>
<span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">      </span><span class="nt">backendRefs</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productpage</span>
<span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span>
</code></pre></div>
<h4 id="2445-https">24.4.5 验证 HTTPS<a class="headerlink" href="#2445-https" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 添加 hosts 解析</span>
<span class="nv">LB_IP</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>gateway<span class="w"> </span>tls-gateway<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.addresses[0].value}&#39;</span><span class="k">)</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LB_IP</span><span class="s2"> bookinfo.cilium.rocks&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/hosts

<span class="c1"># 测试 HTTPS 访问</span>
curl<span class="w"> </span>-k<span class="w"> </span>-v<span class="w"> </span>https://bookinfo.cilium.rocks/
</code></pre></div>
<h3 id="245">24.5 资源关系详解<a class="headerlink" href="#245" title="Permanent link">&para;</a></h3>
<h4 id="2451">24.5.1 资源层级<a class="headerlink" href="#2451" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Gateway API 层级&quot;
        GC[&quot;GatewayClass&lt;br/&gt;⬇ 定义控制器&quot;]
        GW[&quot;Gateway&lt;br/&gt;⬇ 定义入口&quot;]
        HR[&quot;HTTPRoute&lt;br/&gt;⬇ 定义路由&quot;]
        Svc[&quot;Service&lt;br/&gt;⬇ 后端&quot;]
        Pod[&quot;Pod&quot;]

        GC --&gt; GW
        GW --&gt; HR
        HR --&gt; Svc
        Svc --&gt; Pod
    end
</code></pre></div>
<h4 id="2452-ingress">24.5.2 与 Ingress 映射<a class="headerlink" href="#2452-ingress" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">Ingress</th>
<th style="text-align: left;">Gateway API</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>ingressClassName</code></td>
<td style="text-align: left;"><code>GatewayClass</code> + <code>Gateway.gatewayClassName</code></td>
</tr>
<tr>
<td style="text-align: left;">Ingress 资源</td>
<td style="text-align: left;"><code>Gateway</code> + <code>HTTPRoute</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>rules.host</code></td>
<td style="text-align: left;"><code>Gateway.listeners.hostname</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>rules.http.paths</code></td>
<td style="text-align: left;"><code>HTTPRoute.rules.matches</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>tls</code></td>
<td style="text-align: left;"><code>Gateway.listeners.tls</code></td>
</tr>
</tbody>
</table>
<h3 id="246-ingress">24.6 与 Ingress 对比<a class="headerlink" href="#246-ingress" title="Permanent link">&para;</a></h3>
<h4 id="2461">24.6.1 配置对比<a class="headerlink" href="#2461" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Ingress 方式&quot;
        I1[&quot;Ingress&lt;br/&gt;（单一资源）&quot;]
    end

    subgraph &quot;Gateway API 方式&quot;
        G1[&quot;GatewayClass&quot;]
        G2[&quot;Gateway&quot;]
        G3[&quot;HTTPRoute&quot;]
        G1 --&gt; G2 --&gt; G3
    end
</code></pre></div>
<h4 id="2462">24.6.2 功能对比<a class="headerlink" href="#2462" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">Ingress</th>
<th style="text-align: left;">Gateway API</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>基础 HTTP 路由</strong></td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>TLS 终结</strong></td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Header 匹配</strong></td>
<td style="text-align: left;">注解</td>
<td style="text-align: left;">原生支持</td>
</tr>
<tr>
<td style="text-align: left;"><strong>请求重写</strong></td>
<td style="text-align: left;">注解</td>
<td style="text-align: left;">原生支持</td>
</tr>
<tr>
<td style="text-align: left;"><strong>流量拆分</strong></td>
<td style="text-align: left;">注解</td>
<td style="text-align: left;">原生支持</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨命名空间</strong></td>
<td style="text-align: left;">困难</td>
<td style="text-align: left;">简单</td>
</tr>
</tbody>
</table>
<h3 id="247">24.7 实际应用场景<a class="headerlink" href="#247" title="Permanent link">&para;</a></h3>
<h4 id="2471">24.7.1 场景一：多团队共享网关<a class="headerlink" href="#2471" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    GW[&quot;Gateway&lt;br/&gt;（Infra Team 管理）&quot;]

    subgraph &quot;Team A 命名空间&quot;
        HR1[&quot;HTTPRoute A&quot;]
        Svc1[&quot;Service A&quot;]
    end

    subgraph &quot;Team B 命名空间&quot;
        HR2[&quot;HTTPRoute B&quot;]
        Svc2[&quot;Service B&quot;]
    end

    GW --&gt; HR1
    GW --&gt; HR2
    HR1 --&gt; Svc1
    HR2 --&gt; Svc2
</code></pre></div>
<h4 id="2472-service-mesh">24.7.2 场景二：Service Mesh 集成<a class="headerlink" href="#2472-service-mesh" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    GW[&quot;Gateway API&quot;] --&gt; Envoy[&quot;Cilium Envoy&quot;]
    Envoy --&gt; SM[&quot;Service Mesh&lt;br/&gt;流量管理&quot;]
</code></pre></div>
<blockquote>
<p>[!TIP]
Gateway API 是 Service Mesh 的基础组件，Cilium 的 Gateway API 实现与其 Service Mesh 功能无缝集成。</p>
</blockquote>
<h3 id="248">24.8 注意事项<a class="headerlink" href="#248" title="Permanent link">&para;</a></h3>
<blockquote>
<p>[!WARNING]
<strong>使用注意</strong>：</p>
<ol>
<li><strong>CRDs 必须预装</strong>：Gateway API CRDs 必须在安装 Cilium 之前安装</li>
<li><strong>版本兼容性</strong>：确保 CRDs 版本与 Cilium 版本兼容</li>
<li><strong>LoadBalancer 依赖</strong>：Gateway 会创建 LoadBalancer 类型的 Service</li>
<li><strong>hostname 匹配</strong>：HTTPS 模式下，HTTPRoute 的 hostnames 必须匹配 Gateway 的 hostname</li>
</ol>
</blockquote>
<h3 id="249">24.9 章节小结<a class="headerlink" href="#249" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Gateway API))
    概念
      Ingress替代
      更强表达能力
    核心资源
      GatewayClass
      Gateway
      HTTPRoute
    前置要求
      CRDs预装
      gatewayAPI.enabled
    HTTP模式
      Gateway定义入口
      HTTPRoute定义路由
    HTTPS模式
      TLS配置
      hostname匹配
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li>
<p><strong>什么是 Gateway API</strong>：Ingress 的下一代替代方案，更强大的七层流量管理</p>
</li>
<li>
<p><strong>核心资源</strong>：</p>
</li>
<li><code>GatewayClass</code>：定义控制器</li>
<li><code>Gateway</code>：定义入口网关</li>
<li>
<p><code>HTTPRoute</code>：定义路由规则</p>
</li>
<li>
<p><strong>前置要求</strong>：</p>
</li>
<li>必须预装 Gateway API CRDs</li>
<li>
<p><code>gatewayAPI.enabled=true</code></p>
</li>
<li>
<p><strong>HTTP 模式</strong>：</p>
</li>
<li>创建 Gateway + HTTPRoute</li>
<li>
<p><code>gatewayClassName: cilium</code></p>
</li>
<li>
<p><strong>HTTPS 模式</strong>：</p>
</li>
<li>Gateway 配置 TLS 证书</li>
<li>
<p>HTTPRoute 配置 hostnames</p>
</li>
<li>
<p><strong>与 Ingress 区别</strong>：</p>
</li>
<li>更丰富的表达能力</li>
<li>原生支持流量拆分、Header 匹配等</li>
<li>更好的跨命名空间支持</li>
</ol>
</blockquote>
<hr />
<h2 id="bgp">第二十五章 BGP 基础知识<a class="headerlink" href="#bgp" title="Permanent link">&para;</a></h2>
<p>本章介绍 BGP（Border Gateway Protocol）协议的基础知识。BGP 是 Cilium 实现跨网络路由通告的核心技术，理解 BGP 原理对于配置 Cilium BGP 功能至关重要。</p>
<h3 id="251">25.1 背景与概念<a class="headerlink" href="#251" title="Permanent link">&para;</a></h3>
<h4 id="2511-bgp">25.1.1 为什么需要 BGP<a class="headerlink" href="#2511-bgp" title="Permanent link">&para;</a></h4>
<p>在 Kubernetes 环境中，每个 Pod 都有独立的 IP 地址，导致路由条目数量急剧增加：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;传统虚拟机&quot;
        VM1[&quot;VM1: 1 IP&quot;]
        VM2[&quot;VM2: 1 IP&quot;]
    end

    subgraph &quot;Kubernetes Pod&quot;
        Pod1[&quot;Pod1: 独立 IP&quot;]
        Pod2[&quot;Pod2: 独立 IP&quot;]
        Pod3[&quot;Pod3: 独立 IP&quot;]
        PodN[&quot;Pod N: 独立 IP&quot;]
    end
</code></pre></div>
<p><strong>路由条目膨胀</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">节点数</th>
<th style="text-align: left;">路由条目数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">传统虚拟机</td>
<td style="text-align: left;">200</td>
<td style="text-align: left;">~200</td>
</tr>
<tr>
<td style="text-align: left;">Kubernetes（100 Pod/节点）</td>
<td style="text-align: left;">200</td>
<td style="text-align: left;">~20,000</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
当路由条目达到数万甚至数十万时，传统 IGP 协议（如 OSPF）难以高效管理，需要使用 BGP 协议。</p>
</blockquote>
<h4 id="2512">25.1.2 路由协议分类<a class="headerlink" href="#2512" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;路由协议&quot;
        Static[&quot;静态路由&lt;br/&gt;手动配置&quot;]
        IGP[&quot;IGP 内部网关协议&lt;br/&gt;OSPF / IS-IS&quot;]
        BGP[&quot;BGP 边界网关协议&lt;br/&gt;iBGP / eBGP&quot;]
    end

    Static --&gt; |&quot;简单场景&quot;| IGP
    IGP --&gt; |&quot;大规模场景&quot;| BGP
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">协议类型</th>
<th style="text-align: left;">代表</th>
<th style="text-align: left;">适用规模</th>
<th style="text-align: left;">特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>静态路由</strong></td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">小型</td>
<td style="text-align: left;">手动配置，简单直观</td>
</tr>
<tr>
<td style="text-align: left;"><strong>IGP</strong></td>
<td style="text-align: left;">OSPF、IS-IS</td>
<td style="text-align: left;">中型园区网</td>
<td style="text-align: left;">自动学习，成百上千条</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BGP</strong></td>
<td style="text-align: left;">iBGP、eBGP</td>
<td style="text-align: left;">大型互联网</td>
<td style="text-align: left;">成千上万条，更灵活</td>
</tr>
</tbody>
</table>
<h4 id="2513-bgp">25.1.3 BGP 定义<a class="headerlink" href="#2513-bgp" title="Permanent link">&para;</a></h4>
<p><strong>BGP（Border Gateway Protocol）</strong>：边界网关协议</p>
<div class="highlight"><pre><span></span><code>graph TB
    AS1[&quot;自治系统 AS 100&lt;br/&gt;（如：电信）&quot;]
    AS2[&quot;自治系统 AS 200&lt;br/&gt;（如：联通）&quot;]

    AS1 &lt;--&gt;|&quot;BGP 邻居&quot;| AS2
</code></pre></div>
<ul>
<li><strong>边界</strong>：用于不同自治系统（AS）之间的路由交换</li>
<li><strong>网关</strong>：运行 BGP 的路由器称为 BGP 网关</li>
<li><strong>协议</strong>：基于 TCP 179 端口通信</li>
</ul>
<h3 id="252">25.2 核心概念<a class="headerlink" href="#252" title="Permanent link">&para;</a></h3>
<h4 id="2521-as">25.2.1 自治系统（AS）<a class="headerlink" href="#2521-as" title="Permanent link">&para;</a></h4>
<p><strong>AS（Autonomous System）</strong>：自治系统号，用于标识一个独立管理的网络域。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph AS123[&quot;AS 123&quot;]
        R1[&quot;Router 1&quot;]
        R2[&quot;Router 2&quot;]
        R3[&quot;Router 3&quot;]
    end

    subgraph AS456[&quot;AS 456&quot;]
        R4[&quot;Router 4&quot;]
        R5[&quot;Router 5&quot;]
    end

    R3 &lt;--&gt;|&quot;eBGP&quot;| R4
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">概念</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>AS 号</strong></td>
<td style="text-align: left;">全局唯一标识符（如 AS 100、AS 65000）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>私有 AS</strong></td>
<td style="text-align: left;">64512 - 65534（类似私有 IP）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>公有 AS</strong></td>
<td style="text-align: left;">需向 IANA 申请</td>
</tr>
</tbody>
</table>
<h4 id="2522-ibgp-ebgp">25.2.2 iBGP 与 eBGP<a class="headerlink" href="#2522-ibgp-ebgp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph AS123[&quot;AS 123&quot;]
        R1[&quot;R1&quot;] &lt;--&gt;|&quot;iBGP&quot;| R2[&quot;R2&quot;]
        R2 &lt;--&gt;|&quot;iBGP&quot;| R3[&quot;R3&quot;]
    end

    subgraph AS456[&quot;AS 456&quot;]
        R4[&quot;R4&quot;]
    end

    R3 &lt;--&gt;|&quot;eBGP&quot;| R4
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">全称</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>iBGP</strong></td>
<td style="text-align: left;">Internal BGP</td>
<td style="text-align: left;">同一 AS 内部的 BGP 邻居</td>
</tr>
<tr>
<td style="text-align: left;"><strong>eBGP</strong></td>
<td style="text-align: left;">External BGP</td>
<td style="text-align: left;">不同 AS 之间的 BGP 邻居</td>
</tr>
</tbody>
</table>
<p><strong>关键区别</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">iBGP</th>
<th style="text-align: left;">eBGP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>AS 号</strong></td>
<td style="text-align: left;">相同</td>
<td style="text-align: left;">不同</td>
</tr>
<tr>
<td style="text-align: left;"><strong>直连要求</strong></td>
<td style="text-align: left;">不需要直连</td>
<td style="text-align: left;">通常需要直连</td>
</tr>
<tr>
<td style="text-align: left;"><strong>TTL</strong></td>
<td style="text-align: left;">大于 1（可跨路由器）</td>
<td style="text-align: left;">默认 1（直连）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Next-Hop</strong></td>
<td style="text-align: left;">不修改</td>
<td style="text-align: left;">修改为自己</td>
</tr>
</tbody>
</table>
<h4 id="2523-bgp">25.2.3 BGP 邻居建立<a class="headerlink" href="#2523-bgp" title="Permanent link">&para;</a></h4>
<p>BGP 使用 <strong>TCP 179 端口</strong>建立邻居关系：</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant R1 as Router 1
    participant R2 as Router 2

    R1-&gt;&gt;R2: TCP 三次握手 (port 179)
    R1-&gt;&gt;R2: Open 消息
    R2-&gt;&gt;R1: Open 消息
    R1--&gt;&gt;R2: Keepalive
    R2--&gt;&gt;R1: Keepalive
    Note over R1,R2: 邻居关系建立 (Established)
</code></pre></div>
<blockquote>
<p>[!TIP]
BGP 邻居不要求物理直连，只要 TCP 179 端口可达即可。这是 BGP 的重要特性。</p>
</blockquote>
<h3 id="253">25.3 水平分割原则<a class="headerlink" href="#253" title="Permanent link">&para;</a></h3>
<h4 id="2531">25.3.1 问题背景<a class="headerlink" href="#2531" title="Permanent link">&para;</a></h4>
<p><strong>水平分割（Split Horizon）</strong>：从 iBGP 对等体学习到的路由，不再通告给其他 iBGP 对等体。</p>
<div class="highlight"><pre><span></span><code>graph LR
    R1[&quot;R1&quot;] &lt;--&gt;|&quot;iBGP&quot;| R2[&quot;R2&quot;]
    R2 &lt;--&gt;|&quot;iBGP&quot;| R3[&quot;R3&quot;]

    R2 -.-&gt;|&quot;❌ 不传递&quot;| R1
</code></pre></div>
<p><strong>目的</strong>：防止路由环路</p>
<p><strong>问题</strong>：R1 无法学习到 R3 的路由</p>
<h4 id="2532">25.3.2 解决方案<a class="headerlink" href="#2532" title="Permanent link">&para;</a></h4>
<p>为了让所有路由器学习到完整路由，需要建立<strong>全互联（Full Mesh）</strong>：</p>
<div class="highlight"><pre><span></span><code>graph TB
    R1[&quot;R1&quot;] &lt;--&gt; R2[&quot;R2&quot;]
    R2 &lt;--&gt; R3[&quot;R3&quot;]
    R1 &lt;--&gt; R3
</code></pre></div>
<p><strong>问题</strong>：邻居数量 = N × (N-1) / 2，规模增大时开销巨大</p>
<h3 id="254">25.4 路由反射器<a class="headerlink" href="#254" title="Permanent link">&para;</a></h3>
<h4 id="2541">25.4.1 概念<a class="headerlink" href="#2541" title="Permanent link">&para;</a></h4>
<p><strong>RR（Route Reflector）</strong>：路由反射器，用于解决 iBGP 全互联问题。</p>
<div class="highlight"><pre><span></span><code>graph TB
    RR[&quot;RR 路由反射器&quot;]

    subgraph &quot;RR Clients&quot;
        C1[&quot;Client 1&quot;]
        C2[&quot;Client 2&quot;]
        C3[&quot;Client 3&quot;]
    end

    NonC[&quot;Non-Client&quot;]

    RR &lt;--&gt; C1
    RR &lt;--&gt; C2
    RR &lt;--&gt; C3
    RR &lt;--&gt; NonC
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">角色</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>RR（Route Reflector）</strong></td>
<td style="text-align: left;">路由反射器</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Client</strong></td>
<td style="text-align: left;">RR 的客户端</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Non-Client</strong></td>
<td style="text-align: left;">非客户端的普通 iBGP 邻居</td>
</tr>
</tbody>
</table>
<h4 id="2542">25.4.2 反射规则<a class="headerlink" href="#2542" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;路由反射规则&quot;
        Rule1[&quot;规则 1：Non-Client → 反射给所有 Client&quot;]
        Rule2[&quot;规则 2：Client → 反射给 Non-Client + 其他 Client&quot;]
        Rule3[&quot;规则 3：eBGP → 反射给所有 Client + Non-Client&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">路由来源</th>
<th style="text-align: left;">反射目标</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Non-Client</strong></td>
<td style="text-align: left;">所有 Client（不包括其他 Non-Client）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Client</strong></td>
<td style="text-align: left;">Non-Client + 其他 Client</td>
</tr>
<tr>
<td style="text-align: left;"><strong>eBGP Peer</strong></td>
<td style="text-align: left;">所有 Client + Non-Client</td>
</tr>
</tbody>
</table>
<h4 id="2543">25.4.3 反射示例<a class="headerlink" href="#2543" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;AS 100&quot;
        R2[&quot;R2&lt;br/&gt;RR&quot;]
        R3[&quot;R3&lt;br/&gt;Client&quot;]
        R4[&quot;R4&lt;br/&gt;Client&quot;]
        R5[&quot;R5&lt;br/&gt;Non-Client&quot;]
    end

    subgraph &quot;AS 200&quot;
        R1[&quot;R1&quot;]
    end

    R1 &lt;--&gt;|&quot;eBGP&quot;| R2
    R2 &lt;--&gt;|&quot;iBGP&quot;| R3
    R2 &lt;--&gt;|&quot;iBGP&quot;| R4
    R2 &lt;--&gt;|&quot;iBGP&quot;| R5
</code></pre></div>
<p><strong>路由流向</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">路由来源</th>
<th style="text-align: left;">反射目标</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">R5 → R2</td>
<td style="text-align: left;">Non-Client</td>
<td style="text-align: left;">R3、R4（Client）</td>
</tr>
<tr>
<td style="text-align: left;">R3 → R2</td>
<td style="text-align: left;">Client</td>
<td style="text-align: left;">R4（Client）+ R5（Non-Client）</td>
</tr>
<tr>
<td style="text-align: left;">R1 → R2</td>
<td style="text-align: left;">eBGP</td>
<td style="text-align: left;">R3、R4、R5（所有）</td>
</tr>
</tbody>
</table>
<h4 id="2544">25.4.4 理解技巧<a class="headerlink" href="#2544" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!TIP]
<strong>记忆技巧</strong>：</p>
<ul>
<li><strong>Client = RR 的一部分</strong>（对内分彼此，对外是整体）</li>
<li><strong>Non-Client = 普通邻居</strong>（遵守水平分割）</li>
<li><strong>eBGP = 外部来源</strong>（无水平分割限制）</li>
</ul>
</blockquote>
<h3 id="255-bgp-kubernetes">25.5 BGP 在 Kubernetes 中的应用<a class="headerlink" href="#255-bgp-kubernetes" title="Permanent link">&para;</a></h3>
<h4 id="2551">25.5.1 典型拓扑<a class="headerlink" href="#2551" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;数据中心&quot;
        ToR1[&quot;ToR Switch 1&lt;br/&gt;AS 65001&quot;]
        ToR2[&quot;ToR Switch 2&lt;br/&gt;AS 65002&quot;]

        subgraph &quot;Kubernetes Cluster&quot;
            Node1[&quot;Node 1&lt;br/&gt;AS 65010&quot;]
            Node2[&quot;Node 2&lt;br/&gt;AS 65010&quot;]
            Node3[&quot;Node 3&lt;br/&gt;AS 65010&quot;]
        end
    end

    ToR1 &lt;--&gt;|&quot;eBGP&quot;| Node1
    ToR1 &lt;--&gt;|&quot;eBGP&quot;| Node2
    ToR2 &lt;--&gt;|&quot;eBGP&quot;| Node3
</code></pre></div>
<h4 id="2552-cilium-bgp">25.5.2 Cilium BGP 实现<a class="headerlink" href="#2552-cilium-bgp" title="Permanent link">&para;</a></h4>
<p>Cilium 支持多种 BGP 后端：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">后端</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>GoBGP</strong></td>
<td style="text-align: left;">当前推荐，原生 Go 实现</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BIRD</strong></td>
<td style="text-align: left;">早期版本使用</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MetalLB BGP</strong></td>
<td style="text-align: left;">与 MetalLB 集成</td>
</tr>
</tbody>
</table>
<h3 id="256">25.6 章节小结<a class="headerlink" href="#256" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((BGP 基础))
    概念
      边界网关协议
      TCP 179 端口
    自治系统
      AS 号
      私有/公有
    邻居类型
      iBGP 内部
      eBGP 外部
    水平分割
      防止环路
      全互联问题
    路由反射器
      RR
      Client
      Non-Client
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>什么是 BGP</strong>：</li>
<li>边界网关协议，用于大规模路由管理</li>
<li>
<p>基于 TCP 179 端口</p>
</li>
<li>
<p><strong>AS 自治系统</strong>：</p>
</li>
<li>独立管理的网络域</li>
<li>
<p>私有 AS：64512 - 65534</p>
</li>
<li>
<p><strong>iBGP vs eBGP</strong>：</p>
</li>
<li>iBGP：同一 AS 内部</li>
<li>
<p>eBGP：不同 AS 之间</p>
</li>
<li>
<p><strong>水平分割</strong>：</p>
</li>
<li>防止路由环路</li>
<li>
<p>导致全互联问题</p>
</li>
<li>
<p><strong>路由反射器</strong>：</p>
</li>
<li>解决全互联问题</li>
<li>Client 和 Non-Client 角色区分</li>
<li>
<p>三条反射规则</p>
</li>
<li>
<p><strong>Kubernetes 应用</strong>：</p>
</li>
<li>用于 Pod/Service IP 通告</li>
<li>Cilium 使用 GoBGP 实现</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium-bgp-control-plane">第二十六章 Cilium BGP Control Plane<a class="headerlink" href="#cilium-bgp-control-plane" title="Permanent link">&para;</a></h2>
<p>本章介绍 Cilium BGP Control Plane 的配置与实践。通过 Kind + ContainerLab 构建完整的 BGP 测试环境，实现 Kubernetes Pod 网络与数据中心网络的互通。</p>
<h3 id="261">26.1 背景与架构<a class="headerlink" href="#261" title="Permanent link">&para;</a></h3>
<h4 id="2611-spine-leaf">26.1.1 Spine-Leaf 网络架构<a class="headerlink" href="#2611-spine-leaf" title="Permanent link">&para;</a></h4>
<p>现代数据中心普遍采用 Spine-Leaf 架构：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Spine 层&quot;
        Spine0[&quot;Spine 0&lt;br/&gt;AS 500&quot;]
        Spine1[&quot;Spine 1&lt;br/&gt;AS 800&quot;]
    end

    subgraph &quot;Leaf 层&quot;
        Leaf0[&quot;Leaf 0&lt;br/&gt;AS 65005&quot;]
        Leaf1[&quot;Leaf 1&lt;br/&gt;AS 65008&quot;]
    end

    subgraph &quot;Kubernetes Nodes&quot;
        Node0[&quot;Node 0&lt;br/&gt;10.1.5.10&quot;]
        Node1[&quot;Node 1&lt;br/&gt;10.1.5.11&quot;]
        Node2[&quot;Node 2&lt;br/&gt;10.1.8.10&quot;]
        Node3[&quot;Node 3&lt;br/&gt;10.1.8.11&quot;]
    end

    Spine0 &lt;--&gt;|&quot;eBGP&quot;| Leaf0
    Spine0 &lt;--&gt;|&quot;eBGP&quot;| Leaf1
    Spine1 &lt;--&gt;|&quot;eBGP&quot;| Leaf0
    Spine1 &lt;--&gt;|&quot;eBGP&quot;| Leaf1

    Leaf0 &lt;--&gt;|&quot;iBGP&quot;| Node0
    Leaf0 &lt;--&gt;|&quot;iBGP&quot;| Node1
    Leaf1 &lt;--&gt;|&quot;iBGP&quot;| Node2
    Leaf1 &lt;--&gt;|&quot;iBGP&quot;| Node3
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">层级</th>
<th style="text-align: left;">角色</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Spine</strong></td>
<td style="text-align: left;">核心交换机</td>
<td style="text-align: left;">负责跨 Leaf 流量转发</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Leaf</strong></td>
<td style="text-align: left;">接入交换机</td>
<td style="text-align: left;">连接服务器、充当 BGP RR</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Node</strong></td>
<td style="text-align: left;">K8s 节点</td>
<td style="text-align: left;">运行 Cilium BGP</td>
</tr>
</tbody>
</table>
<h4 id="2612-bgp">26.1.2 BGP 邻居关系<a class="headerlink" href="#2612-bgp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;AS 65005&quot;
        Leaf0[&quot;Leaf 0&lt;br/&gt;RR&quot;]
        Node0[&quot;Node 0&quot;]
        Node1[&quot;Node 1&quot;]
    end

    subgraph &quot;AS 500&quot;
        Spine0[&quot;Spine 0&quot;]
    end

    Leaf0 &lt;--&gt;|&quot;iBGP&quot;| Node0
    Leaf0 &lt;--&gt;|&quot;iBGP&quot;| Node1
    Leaf0 &lt;--&gt;|&quot;eBGP&quot;| Spine0
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">邻居类型</th>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">AS 关系</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>iBGP</strong></td>
<td style="text-align: left;">Leaf ↔ Node</td>
<td style="text-align: left;">同一 AS</td>
</tr>
<tr>
<td style="text-align: left;"><strong>eBGP</strong></td>
<td style="text-align: left;">Spine ↔ Leaf</td>
<td style="text-align: left;">不同 AS</td>
</tr>
</tbody>
</table>
<h3 id="262">26.2 环境搭建<a class="headerlink" href="#262" title="Permanent link">&para;</a></h3>
<h4 id="2621">26.2.1 整体架构<a class="headerlink" href="#2621" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;ContainerLab&quot;
        Spine[&quot;Spine 交换机&quot;]
        Leaf[&quot;Leaf 交换机&quot;]
    end

    subgraph &quot;Kind Cluster&quot;
        CP[&quot;Control Plane&quot;]
        Worker[&quot;Worker Nodes&quot;]
    end

    subgraph &quot;网络桥接&quot;
        BR[&quot;Linux Bridge&quot;]
    end

    Leaf &lt;--&gt; BR
    BR &lt;--&gt; CP
    BR &lt;--&gt; Worker
</code></pre></div>
<h4 id="2622">26.2.2 网络复用原理<a class="headerlink" href="#2622" title="Permanent link">&para;</a></h4>
<p>Kind 创建的容器通过网络复用方式与 ContainerLab 连接：</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Kind as Kind 容器
    participant Server as ContainerLab Server
    participant Leaf as Leaf 交换机

    Note over Kind: eth0: 172.18.0.x&lt;br/&gt;（管理网络）
    Server-&gt;&gt;Kind: 共享网络命名空间
    Server-&gt;&gt;Kind: 添加 net0 网卡
    Note over Kind: net0: 10.1.5.x&lt;br/&gt;（业务网络）
    Kind-&gt;&gt;Leaf: 通过 net0 通信
</code></pre></div>
<p><strong>关键配置</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ContainerLab Server 配置</span>
<span class="nt">network-mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">container:clab-bgp-control-plane</span>
<span class="nt">exec</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip route replace default via 10.1.5.1</span><span class="w">  </span><span class="c1"># 替换默认路由</span>
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>核心原理</strong>：通过 <code>container</code> 网络模式复用 Kind 容器的网络命名空间，再添加新网卡并替换默认路由，实现流量从 Kind 到 ContainerLab 的引导。</p>
</blockquote>
<h3 id="263-cilium-bgp">26.3 Cilium BGP 配置<a class="headerlink" href="#263-cilium-bgp" title="Permanent link">&para;</a></h3>
<h4 id="2631-helm">26.3.1 Helm 安装参数<a class="headerlink" href="#2631-helm" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>cilium<span class="w"> </span>cilium/cilium<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>bgpControlPlane.enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>ipam.mode<span class="o">=</span>kubernetes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span><span class="m">10</span>.0.0.0/8<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span><span class="nv">tunnel</span><span class="o">=</span>disabled
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>bgpControlPlane.enabled=true</code></td>
<td style="text-align: left;">启用 BGP Control Plane</td>
</tr>
<tr>
<td style="text-align: left;"><code>ipam.mode=kubernetes</code></td>
<td style="text-align: left;">使用 Kubernetes IPAM</td>
</tr>
<tr>
<td style="text-align: left;"><code>ipv4NativeRoutingCIDR</code></td>
<td style="text-align: left;">直接路由的 CIDR</td>
</tr>
<tr>
<td style="text-align: left;"><code>tunnel=disabled</code></td>
<td style="text-align: left;">禁用隧道模式</td>
</tr>
</tbody>
</table>
<h4 id="2632-ciliumbgppeeringpolicy">26.3.2 CiliumBGPPeeringPolicy<a class="headerlink" href="#2632-ciliumbgppeeringpolicy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium.io/v2alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CiliumBGPPeeringPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bgp-peering-policy</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">rack</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rack0</span><span class="w">                      </span><span class="c1"># 选择节点</span>
<span class="w">  </span><span class="nt">virtualRouters</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">localASN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65005</span><span class="w">                   </span><span class="c1"># 本地 AS 号</span>
<span class="w">      </span><span class="nt">exportPodCIDR</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">               </span><span class="c1"># 宣告 Pod CIDR</span>
<span class="w">      </span><span class="nt">neighbors</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">peerAddress</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.1.5.1/32</span><span class="w">      </span><span class="c1"># 邻居地址</span>
<span class="w">          </span><span class="nt">peerASN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65005</span><span class="w">                </span><span class="c1"># 邻居 AS 号</span>
</code></pre></div>
<p><strong>关键字段说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>nodeSelector</code></td>
<td style="text-align: left;">选择应用策略的节点</td>
</tr>
<tr>
<td style="text-align: left;"><code>localASN</code></td>
<td style="text-align: left;">本节点的 AS 号</td>
</tr>
<tr>
<td style="text-align: left;"><code>exportPodCIDR</code></td>
<td style="text-align: left;">是否宣告 Pod CIDR</td>
</tr>
<tr>
<td style="text-align: left;"><code>peerAddress</code></td>
<td style="text-align: left;">BGP 邻居地址</td>
</tr>
<tr>
<td style="text-align: left;"><code>peerASN</code></td>
<td style="text-align: left;">BGP 邻居的 AS 号</td>
</tr>
</tbody>
</table>
<h3 id="264">26.4 交换机配置<a class="headerlink" href="#264" title="Permanent link">&para;</a></h3>
<h4 id="2641-leaf">26.4.1 Leaf 交换机（路由反射器）<a class="headerlink" href="#2641-leaf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Leaf 0 配置示例</span>
router<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span>
<span class="w">  </span>router-id<span class="w"> </span><span class="m">10</span>.1.5.1

<span class="w">  </span><span class="c1"># iBGP 邻居 - K8s 节点（作为 RR Client）</span>
<span class="w">  </span>neighbor<span class="w"> </span><span class="m">10</span>.1.5.10<span class="w"> </span>remote-as<span class="w"> </span><span class="m">65005</span>
<span class="w">  </span>neighbor<span class="w"> </span><span class="m">10</span>.1.5.10<span class="w"> </span>route-reflector-client

<span class="w">  </span>neighbor<span class="w"> </span><span class="m">10</span>.1.5.11<span class="w"> </span>remote-as<span class="w"> </span><span class="m">65005</span>
<span class="w">  </span>neighbor<span class="w"> </span><span class="m">10</span>.1.5.11<span class="w"> </span>route-reflector-client

<span class="w">  </span><span class="c1"># eBGP 邻居 - Spine 交换机</span>
<span class="w">  </span>neighbor<span class="w"> </span><span class="m">10</span>.1.10.2<span class="w"> </span>remote-as<span class="w"> </span><span class="m">500</span>
<span class="w">  </span>neighbor<span class="w"> </span><span class="m">10</span>.1.12.2<span class="w"> </span>remote-as<span class="w"> </span><span class="m">800</span>
</code></pre></div>
<h4 id="2642-spine">26.4.2 Spine 交换机<a class="headerlink" href="#2642-spine" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Spine 0 配置示例</span>
router<span class="w"> </span>bgp<span class="w"> </span><span class="m">500</span>
<span class="w">  </span>router-id<span class="w"> </span><span class="m">10</span>.1.10.1

<span class="w">  </span><span class="c1"># eBGP 邻居 - Leaf 交换机</span>
<span class="w">  </span>neighbor<span class="w"> </span><span class="m">10</span>.1.10.1<span class="w"> </span>remote-as<span class="w"> </span><span class="m">65005</span>
<span class="w">  </span>neighbor<span class="w"> </span><span class="m">10</span>.1.11.1<span class="w"> </span>remote-as<span class="w"> </span><span class="m">65008</span>
</code></pre></div>
<h3 id="265-ecmp">26.5 ECMP 负载分担<a class="headerlink" href="#265-ecmp" title="Permanent link">&para;</a></h3>
<h4 id="2651">26.5.1 工作原理<a class="headerlink" href="#2651" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Leaf 0&quot;
        L0[&quot;Leaf 0&quot;]
    end

    subgraph &quot;Spine 层&quot;
        S0[&quot;Spine 0&quot;]
        S1[&quot;Spine 1&quot;]
    end

    subgraph &quot;Leaf 1&quot;
        L1[&quot;Leaf 1&quot;]
    end

    L0 --&gt;|&quot;路径 1&quot;| S0
    L0 --&gt;|&quot;路径 2&quot;| S1
    S0 --&gt; L1
    S1 --&gt; L1
</code></pre></div>
<p><strong>ECMP（Equal-Cost Multi-Path）</strong>：当有多条等价路径时，进行负载分担。</p>
<h4 id="2652">26.5.2 配置启用<a class="headerlink" href="#2652" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Leaf 交换机上启用</span>
router<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span>
<span class="w">  </span>maximum-paths<span class="w"> </span><span class="m">2</span>
<span class="w">  </span>bestpath<span class="w"> </span>as-path<span class="w"> </span>multipath-relax
</code></pre></div>
<h4 id="2653-ecmp">26.5.3 验证 ECMP<a class="headerlink" href="#2653-ecmp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看路由表</span>
ip<span class="w"> </span>route<span class="w"> </span>show

<span class="c1"># 输出示例 - 多个 nexthop</span>
<span class="m">10</span>.98.1.0/24<span class="w"> </span>proto<span class="w"> </span>bgp<span class="w"> </span>
<span class="w">    </span>nexthop<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.10.2<span class="w"> </span>dev<span class="w"> </span>eth1<span class="w"> </span>weight<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>nexthop<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.12.2<span class="w"> </span>dev<span class="w"> </span>eth2<span class="w"> </span>weight<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<h3 id="266">26.6 验证与测试<a class="headerlink" href="#266" title="Permanent link">&para;</a></h3>
<h4 id="2661-bgp">26.6.1 查看 BGP 邻居状态<a class="headerlink" href="#2661-bgp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Leaf 交换机上</span>
show<span class="w"> </span>ip<span class="w"> </span>bgp<span class="w"> </span>summary

<span class="c1"># 或在 K8s 节点上</span>
cilium<span class="w"> </span>bgp<span class="w"> </span>peers
</code></pre></div>
<h4 id="2662">26.6.2 查看路由表<a class="headerlink" href="#2662" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 BGP 路由</span>
show<span class="w"> </span>ip<span class="w"> </span>bgp

<span class="c1"># 验证 Pod 网络路由</span>
ip<span class="w"> </span>route<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">10</span>.98
</code></pre></div>
<h4 id="2663-pod">26.6.3 跨节点 Pod 通信测试<a class="headerlink" href="#2663-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 从一个节点的 Pod ping 另一个节点的 Pod</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>test-pod<span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span>&lt;target-pod-ip&gt;
</code></pre></div>
<h3 id="267">26.7 生产环境考量<a class="headerlink" href="#267" title="Permanent link">&para;</a></h3>
<h4 id="2671">26.7.1 网络规划<a class="headerlink" href="#2671" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;网络分离&quot;
        Mgmt[&quot;管理网络&lt;br/&gt;eth0: 172.x.x.x&quot;]
        Data[&quot;业务网络&lt;br/&gt;net0: 10.x.x.x&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">网络类型</th>
<th style="text-align: left;">用途</th>
<th style="text-align: left;">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>管理网络</strong></td>
<td style="text-align: left;">SSH、监控</td>
<td style="text-align: left;">172.18.0.0/16</td>
</tr>
<tr>
<td style="text-align: left;"><strong>业务网络</strong></td>
<td style="text-align: left;">Pod 流量</td>
<td style="text-align: left;">10.1.0.0/16</td>
</tr>
</tbody>
</table>
<h4 id="2672">26.7.2 高可用设计<a class="headerlink" href="#2672" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    Node[&quot;K8s Node&quot;]
    L0[&quot;Leaf 0&quot;]
    L1[&quot;Leaf 1&quot;]
    S0[&quot;Spine 0&quot;]
    S1[&quot;Spine 1&quot;]

    Node --&gt;|&quot;主路径&quot;| L0
    Node --&gt;|&quot;备路径&quot;| L1
    L0 --&gt; S0
    L0 --&gt; S1
    L1 --&gt; S0
    L1 --&gt; S1
</code></pre></div>
<h3 id="268">26.8 章节小结<a class="headerlink" href="#268" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((BGP Control Plane))
    架构
      Spine-Leaf
      iBGP/eBGP
    环境
      Kind + ContainerLab
      网络复用
    配置
      CiliumBGPPeeringPolicy
      localASN/peerASN
    交换机
      RR 路由反射器
      ECMP 多路径
    验证
      BGP 邻居状态
      路由表检查
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>Spine-Leaf 架构</strong>：</li>
<li>Spine 负责跨 Leaf 转发</li>
<li>
<p>Leaf 作为 BGP RR</p>
</li>
<li>
<p><strong>环境搭建</strong>：</p>
</li>
<li>Kind + ContainerLab 联合</li>
<li>
<p>网络复用实现流量引导</p>
</li>
<li>
<p><strong>Cilium 配置</strong>：</p>
</li>
<li><code>bgpControlPlane.enabled=true</code></li>
<li>
<p><code>CiliumBGPPeeringPolicy</code> 定义邻居</p>
</li>
<li>
<p><strong>关键参数</strong>：</p>
</li>
<li><code>localASN</code>：本地 AS 号</li>
<li><code>peerASN</code>：邻居 AS 号</li>
<li>
<p><code>exportPodCIDR</code>：宣告 Pod 网络</p>
</li>
<li>
<p><strong>交换机配置</strong>：</p>
</li>
<li>Leaf 作为 RR，配置 <code>route-reflector-client</code></li>
<li>
<p>启用 <code>maximum-paths</code> 实现 ECMP</p>
</li>
<li>
<p><strong>生产考量</strong>：</p>
</li>
<li>管理网络与业务网络分离</li>
<li>多路径高可用设计</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium-bgp-with-lb-ipam">第二十七章 Cilium BGP with LB-IPAM<a class="headerlink" href="#cilium-bgp-with-lb-ipam" title="Permanent link">&para;</a></h2>
<p>本章介绍如何将 Cilium BGP Control Plane 与 LoadBalancer IPAM 结合，实现 Service 的 External IP 可路由，从而让外部网络能够直接访问 Kubernetes 集群内的服务。</p>
<h3 id="271">27.1 背景与问题<a class="headerlink" href="#271" title="Permanent link">&para;</a></h3>
<h4 id="2711">27.1.1 问题场景<a class="headerlink" href="#2711" title="Permanent link">&para;</a></h4>
<p>在生产环境中，外部客户端需要访问 Kubernetes 集群内的服务：</p>
<div class="highlight"><pre><span></span><code>graph LR
    Client[&quot;外部客户端&quot;] --&gt; |&quot;访问 LB IP&quot;| Router[&quot;网络设备&quot;]
    Router --&gt; |&quot;?????&quot;| Service[&quot;K8s Service&quot;]
    Service --&gt; Pod[&quot;Pod&quot;]
</code></pre></div>
<p><strong>核心问题</strong>：外部网络设备如何知道 Service 的 LB IP 在哪里？</p>
<h4 id="2712">27.1.2 传统方案对比<a class="headerlink" href="#2712" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">方案</th>
<th style="text-align: left;">工作层级</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>MetalLB L2</strong></td>
<td style="text-align: left;">二层</td>
<td style="text-align: left;">ARP 响应，仅限同一子网</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MetalLB BGP</strong></td>
<td style="text-align: left;">三层</td>
<td style="text-align: left;">需要额外部署</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cilium BGP</strong></td>
<td style="text-align: left;">三层</td>
<td style="text-align: left;">CNI 原生集成</td>
</tr>
</tbody>
</table>
<h3 id="272-service-announcement">27.2 Service Announcement 原理<a class="headerlink" href="#272-service-announcement" title="Permanent link">&para;</a></h3>
<h4 id="2721">27.2.1 工作流程<a class="headerlink" href="#2721" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Svc as LoadBalancer Service
    participant Cilium as Cilium Agent
    participant BGP as BGP 邻居
    participant Router as 外部路由器

    Svc-&gt;&gt;Svc: 分配 External IP
    Cilium-&gt;&gt;Cilium: 检测 Service 变化
    Cilium-&gt;&gt;BGP: 宣告 LB IP 路由
    BGP-&gt;&gt;Router: 路由传播
    Note over Router: 现在知道&lt;br/&gt;LB IP 怎么走了！
</code></pre></div>
<h4 id="2722">27.2.2 核心概念<a class="headerlink" href="#2722" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">概念</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Service Announcement</strong></td>
<td style="text-align: left;">将 Service 的 LB IP 通过 BGP 宣告</td>
</tr>
<tr>
<td style="text-align: left;"><strong>serviceSelector</strong></td>
<td style="text-align: left;">选择哪些 Service 进行宣告</td>
</tr>
<tr>
<td style="text-align: left;"><strong>exportPodCIDR</strong></td>
<td style="text-align: left;">宣告 Pod 网段（已在 26 章介绍）</td>
</tr>
</tbody>
</table>
<h3 id="273-ciliumbgppeeringpolicy">27.3 CiliumBGPPeeringPolicy 配置<a class="headerlink" href="#273-ciliumbgppeeringpolicy" title="Permanent link">&para;</a></h3>
<h4 id="2731">27.3.1 完整配置示例<a class="headerlink" href="#2731" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium.io/v2alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CiliumBGPPeeringPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bgp-peering-policy</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">rack</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rack0</span>
<span class="w">  </span><span class="nt">virtualRouters</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">localASN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65005</span>
<span class="w">      </span><span class="nt">exportPodCIDR</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">      </span><span class="c1"># 服务宣告配置（1.13+ 新增）</span>
<span class="w">      </span><span class="nt">serviceSelector</span><span class="p">:</span>
<span class="w">        </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">somekey</span>
<span class="w">            </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NotIn</span>
<span class="w">            </span><span class="nt">values</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">never-used-value</span>

<span class="w">      </span><span class="nt">neighbors</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">peerAddress</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.1.5.1/32</span>
<span class="w">          </span><span class="nt">peerASN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65005</span>
</code></pre></div>
<h4 id="2732-serviceselector">27.3.2 serviceSelector 详解<a class="headerlink" href="#2732-serviceselector" title="Permanent link">&para;</a></h4>
<p><strong>宣告所有 LoadBalancer Service</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">serviceSelector</span><span class="p">:</span>
<span class="w">  </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">somekey</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NotIn</span>
<span class="w">      </span><span class="nt">values</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">never-used-value</span>
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>原理解释</strong>：使用一个不存在的 key-value 组合，<code>NotIn</code> 表示"不在列表中"，由于没有 Service 有这个标签，所以所有 Service 都满足条件。</p>
</blockquote>
<p><strong>只宣告特定 Service</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">serviceSelector</span><span class="p">:</span>
<span class="w">  </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">expose-bgp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w">    </span><span class="c1"># 只宣告带此标签的 Service</span>
</code></pre></div>
<h3 id="274-metallb">27.4 MetalLB 集成方案<a class="headerlink" href="#274-metallb" title="Permanent link">&para;</a></h3>
<h4 id="2741">27.4.1 架构图<a class="headerlink" href="#2741" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;IP 分配&quot;
        MetalLB[&quot;MetalLB&lt;br/&gt;分配 LB IP&quot;]
    end

    subgraph &quot;路由宣告&quot;
        Cilium[&quot;Cilium BGP&lt;br/&gt;宣告路由&quot;]
    end

    subgraph &quot;外部网络&quot;
        Router[&quot;路由器&lt;br/&gt;学习路由&quot;]
    end

    MetalLB --&gt;|&quot;分配 172.18.0.200&quot;| Service[&quot;LoadBalancer&lt;br/&gt;Service&quot;]
    Service --&gt;|&quot;通知&quot;| Cilium
    Cilium --&gt;|&quot;BGP Update&quot;| Router
</code></pre></div>
<h4 id="2742">27.4.2 配置步骤<a class="headerlink" href="#2742" title="Permanent link">&para;</a></h4>
<p><strong>1. 安装 MetalLB</strong>：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/metallb/metallb/main/config/manifests/metallb-native.yaml
</code></pre></div>
<p><strong>2. 配置 IP 池</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPAddressPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">addresses</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.18.0.200-172.18.0.254</span>
</code></pre></div>
<p><strong>3. 创建 LoadBalancer Service</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-app</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div>
<p><strong>4. 应用 BGP Peering Policy</strong>（包含 serviceSelector）</p>
<h4 id="2743">27.4.3 验证路由宣告<a class="headerlink" href="#2743" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在路由器上查看路由表</span>
show<span class="w"> </span>ip<span class="w"> </span>route

<span class="c1"># 应能看到类似输出</span>
B<span class="w">    </span><span class="m">172</span>.18.0.200/32<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.5.10<span class="w"> </span>...
</code></pre></div>
<h3 id="275-cilium-lb-ipam">27.5 Cilium LB-IPAM 方案<a class="headerlink" href="#275-cilium-lb-ipam" title="Permanent link">&para;</a></h3>
<h4 id="2751-metallb">27.5.1 与 MetalLB 的区别<a class="headerlink" href="#2751-metallb" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;MetalLB 方案&quot;
        ML[&quot;MetalLB&quot;] --&gt;|&quot;分配 IP&quot;| Svc1[&quot;Service&quot;]
        ML --&gt;|&quot;ARP/BGP&quot;| Net1[&quot;网络&quot;]
    end

    subgraph &quot;Cilium LB-IPAM 方案&quot;
        IPAM[&quot;Cilium LB-IPAM&quot;] --&gt;|&quot;分配 IP&quot;| Svc2[&quot;Service&quot;]
        BGP[&quot;Cilium BGP&quot;] --&gt;|&quot;宣告路由&quot;| Net2[&quot;网络&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">MetalLB</th>
<th style="text-align: left;">Cilium LB-IPAM</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>IP 分配</strong></td>
<td style="text-align: left;">MetalLB 管理</td>
<td style="text-align: left;">Cilium 管理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>路由宣告</strong></td>
<td style="text-align: left;">MetalLB BGP 或 Cilium</td>
<td style="text-align: left;">Cilium BGP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>组件数量</strong></td>
<td style="text-align: left;">需要额外部署</td>
<td style="text-align: left;">CNI 原生</td>
</tr>
</tbody>
</table>
<h4 id="2752-cilium-lb-ipam">27.5.2 配置 Cilium LB-IPAM<a class="headerlink" href="#2752-cilium-lb-ipam" title="Permanent link">&para;</a></h4>
<p><strong>1. 创建 IP Pool</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium.io/v2alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CiliumLoadBalancerIPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">blocks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0.10.0/24</span>
<span class="w">  </span><span class="nt">serviceSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
</code></pre></div>
<p><strong>2. 创建 Service 使用指定池</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-service</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span><span class="w">    </span><span class="c1"># 匹配 IP Pool 的 serviceSelector</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<p><strong>3. BGP 自动宣告</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在路由器上验证</span>
show<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">30</span>.0

<span class="c1"># 输出示例</span>
B<span class="w">    </span><span class="m">30</span>.0.10.22/32<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.5.10<span class="w"> </span>...
</code></pre></div>
<h3 id="276">27.6 完整流程演示<a class="headerlink" href="#276" title="Permanent link">&para;</a></h3>
<h4 id="2761">27.6.1 从创建到访问<a class="headerlink" href="#2761" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Admin as 管理员
    participant K8s as Kubernetes
    participant Cilium as Cilium
    participant Router as 路由器
    participant Client as 客户端

    Admin-&gt;&gt;K8s: 创建 LoadBalancer Service
    K8s-&gt;&gt;Cilium: 通知 Service 创建
    Note over Cilium: LB-IPAM 分配 IP&lt;br/&gt;30.0.10.22
    Cilium-&gt;&gt;Router: BGP Update&lt;br/&gt;宣告 30.0.10.22/32
    Router-&gt;&gt;Router: 更新路由表
    Client-&gt;&gt;Router: 访问 30.0.10.22:80
    Router-&gt;&gt;Cilium: 根据路由转发
    Cilium-&gt;&gt;K8s: 到达 Service
    K8s-&gt;&gt;Client: 返回响应
</code></pre></div>
<h4 id="2762">27.6.2 验证命令<a class="headerlink" href="#2762" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 查看 Service External IP</span>
kubectl<span class="w"> </span>get<span class="w"> </span>svc

<span class="c1"># 输出示例</span>
NAME<span class="w">         </span>TYPE<span class="w">           </span>EXTERNAL-IP<span class="w">    </span>PORT<span class="o">(</span>S<span class="o">)</span>
my-service<span class="w">   </span>LoadBalancer<span class="w">   </span><span class="m">30</span>.0.10.22<span class="w">     </span><span class="m">80</span>:31234/TCP

<span class="c1"># 2. 在路由器上验证路由</span>
show<span class="w"> </span>ip<span class="w"> </span>bgp

<span class="c1"># 3. 从外部访问测试</span>
curl<span class="w"> </span>http://30.0.10.22/
</code></pre></div>
<h3 id="277">27.7 生产环境考量<a class="headerlink" href="#277" title="Permanent link">&para;</a></h3>
<h4 id="2771">27.7.1 宣告策略选择<a class="headerlink" href="#2771" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    Q1[&quot;需要对外暴露?&quot;]
    Q2[&quot;需要精细控制?&quot;]
    A1[&quot;不配置 serviceSelector&quot;]
    A2[&quot;配置 matchLabels&quot;]
    A3[&quot;配置 matchExpressions&lt;br/&gt;宣告所有 LB&quot;]

    Q1 --&gt;|&quot;否&quot;| A1
    Q1 --&gt;|&quot;是&quot;| Q2
    Q2 --&gt;|&quot;是&quot;| A2
    Q2 --&gt;|&quot;否&quot;| A3
</code></pre></div>
<h4 id="2772">27.7.2 安全建议<a class="headerlink" href="#2772" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">建议</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>精准宣告</strong></td>
<td style="text-align: left;">只宣告需要对外的 Service</td>
</tr>
<tr>
<td style="text-align: left;"><strong>网络隔离</strong></td>
<td style="text-align: left;">LB IP 与内部 IP 分开规划</td>
</tr>
<tr>
<td style="text-align: left;"><strong>访问控制</strong></td>
<td style="text-align: left;">配合防火墙/NetworkPolicy</td>
</tr>
</tbody>
</table>
<h3 id="278-cluster-ip-vs-lb-ip">27.8 Cluster IP vs LB IP 宣告对比<a class="headerlink" href="#278-cluster-ip-vs-lb-ip" title="Permanent link">&para;</a></h3>
<h4 id="2781">27.8.1 两种方式对比<a class="headerlink" href="#2781" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">项目</th>
<th style="text-align: left;">Calico 方式</th>
<th style="text-align: left;">Cilium 方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>宣告内容</strong></td>
<td style="text-align: left;">Cluster IP</td>
<td style="text-align: left;">LoadBalancer IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>适用场景</strong></td>
<td style="text-align: left;">内部互通</td>
<td style="text-align: left;">对外服务</td>
</tr>
<tr>
<td style="text-align: left;"><strong>安全性</strong></td>
<td style="text-align: left;">较低</td>
<td style="text-align: left;">较高</td>
</tr>
<tr>
<td style="text-align: left;"><strong>推荐程度</strong></td>
<td style="text-align: left;">⭐⭐</td>
<td style="text-align: left;">⭐⭐⭐⭐</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
Cluster IP 本身是集群内部 IP，将其通过 BGP 宣告到外部网络存在安全隐患，不推荐在生产环境使用。</p>
</blockquote>
<h3 id="279">27.9 章节小结<a class="headerlink" href="#279" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((BGP + LB-IPAM))
    问题
      LB IP 不可路由
      外部无法访问
    方案
      Service Announcement
      BGP 宣告
    配置
      serviceSelector
      matchExpressions
    集成
      MetalLB
      Cilium LB-IPAM
    验证
      路由表检查
      外部访问测试
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>问题本质</strong>：</li>
<li>LoadBalancer IP 默认只在集群内有效</li>
<li>
<p>外部网络设备不知道如何路由</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
</li>
<li>使用 BGP 将 LB IP 宣告到网络</li>
<li>
<p>Cilium 1.13+ 支持 Service Announcement</p>
</li>
<li>
<p><strong>配置要点</strong>：</p>
</li>
<li><code>serviceSelector</code> 控制宣告哪些 Service</li>
<li>
<p>使用 <code>NotIn</code> + 不存在的值宣告所有</p>
</li>
<li>
<p><strong>两种集成</strong>：</p>
</li>
<li>MetalLB（分配 IP）+ Cilium BGP（宣告）</li>
<li>
<p>Cilium LB-IPAM（分配）+ Cilium BGP（宣告）</p>
</li>
<li>
<p><strong>验证方法</strong>：</p>
</li>
<li>路由器查看 <code>show ip route</code></li>
<li>
<p>外部 <code>curl</code> 测试访问</p>
</li>
<li>
<p><strong>最佳实践</strong>：</p>
</li>
<li>宣告 LB IP 而非 Cluster IP</li>
<li>配合标签精细控制宣告范围</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium-clustermesh">第二十八章 Cilium ClusterMesh<a class="headerlink" href="#cilium-clustermesh" title="Permanent link">&para;</a></h2>
<p>本章介绍 Cilium ClusterMesh 多集群网络互联功能。通过 ClusterMesh，多个 Kubernetes 集群可以形成逻辑上的统一集群，实现跨集群的服务发现、负载均衡和故障切换。</p>
<h3 id="281">28.1 背景与概念<a class="headerlink" href="#281" title="Permanent link">&para;</a></h3>
<h4 id="2811-clustermesh">28.1.1 什么是 ClusterMesh<a class="headerlink" href="#2811-clustermesh" title="Permanent link">&para;</a></h4>
<p>ClusterMesh 是 Cilium 提供的多集群连接方案：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Cluster 1&quot;
        Pod1A[&quot;Pod A&quot;]
        Pod1B[&quot;Pod B&quot;]
        Svc1[&quot;Service&quot;]
    end

    subgraph &quot;Cluster 2&quot;
        Pod2A[&quot;Pod A&quot;]
        Pod2B[&quot;Pod B&quot;]
        Svc2[&quot;Service&quot;]
    end

    Svc1 &lt;--&gt;|&quot;ClusterMesh&quot;| Svc2
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>多集群连接</strong></td>
<td style="text-align: left;">多个物理集群形成逻辑统一</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨集群服务发现</strong></td>
<td style="text-align: left;">Service 可发现其他集群的 Pod</td>
</tr>
<tr>
<td style="text-align: left;"><strong>统一负载均衡</strong></td>
<td style="text-align: left;">请求可负载到多集群的 Pod</td>
</tr>
</tbody>
</table>
<h4 id="2812">28.1.2 应用场景<a class="headerlink" href="#2812" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;场景&quot;
        HA[&quot;高可用容灾&quot;]
        GEO[&quot;地理分布&quot;]
        SCALE[&quot;水平扩展&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>高可用容灾</strong></td>
<td style="text-align: left;">一个集群故障，自动切换到另一个</td>
</tr>
<tr>
<td style="text-align: left;"><strong>地理分布</strong></td>
<td style="text-align: left;">多地域部署，就近访问</td>
</tr>
<tr>
<td style="text-align: left;"><strong>水平扩展</strong></td>
<td style="text-align: left;">突破单集群规模限制</td>
</tr>
</tbody>
</table>
<h3 id="282">28.2 架构原理<a class="headerlink" href="#282" title="Permanent link">&para;</a></h3>
<h4 id="2821">28.2.1 核心组件<a class="headerlink" href="#2821" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Cluster 1&quot;
        API1[&quot;ClusterMesh API Server&quot;]
        ETCD1[&quot;etcd&quot;]
        Agent1[&quot;Cilium Agent&quot;]
        Operator1[&quot;Cilium Operator&quot;]
    end

    subgraph &quot;Cluster 2&quot;
        API2[&quot;ClusterMesh API Server&quot;]
        ETCD2[&quot;etcd&quot;]
        Agent2[&quot;Cilium Agent&quot;]
        Operator2[&quot;Cilium Operator&quot;]
    end

    Agent1 &lt;--&gt;|&quot;NodePort/LB&quot;| API2
    Agent2 &lt;--&gt;|&quot;NodePort/LB&quot;| API1
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">组件</th>
<th style="text-align: left;">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>ClusterMesh API Server</strong></td>
<td style="text-align: left;">提供跨集群状态同步接口</td>
</tr>
<tr>
<td style="text-align: left;"><strong>etcd</strong></td>
<td style="text-align: left;">存储集群状态信息</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cilium Agent</strong></td>
<td style="text-align: left;">同步信息到本地</td>
</tr>
</tbody>
</table>
<h4 id="2822">28.2.2 信息同步原理<a class="headerlink" href="#2822" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Agent1 as Cluster1 Agent
    participant API1 as Cluster1 API
    participant API2 as Cluster2 API
    participant Agent2 as Cluster2 Agent

    Note over Agent2: 创建 Pod/Service
    Agent2-&gt;&gt;API2: 上报状态
    API2-&gt;&gt;API1: 同步信息
    API1-&gt;&gt;Agent1: 推送更新
    Note over Agent1: 更新本地 Endpoint 列表
</code></pre></div>
<p><strong>核心要点</strong>：</p>
<ul>
<li>每个集群的 Agent 将本地 Pod/Service 信息上报到 ClusterMesh API</li>
<li>API Server 之间相互同步</li>
<li>Service 因此能"知道"其他集群的后端 Pod</li>
</ul>
<h3 id="283-global-service">28.3 Global Service<a class="headerlink" href="#283-global-service" title="Permanent link">&para;</a></h3>
<h4 id="2831-service-vs-global-service">28.3.1 普通 Service vs Global Service<a class="headerlink" href="#2831-service-vs-global-service" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;普通 Service&quot;
        LocalSvc[&quot;Service&quot;]
        LocalPod1[&quot;Pod 1&quot;]
        LocalPod2[&quot;Pod 2&quot;]
        LocalSvc --&gt; LocalPod1
        LocalSvc --&gt; LocalPod2
    end

    subgraph &quot;Global Service&quot;
        GlobalSvc[&quot;Service&quot;]
        GlobalPod1[&quot;Cluster1 Pod&quot;]
        GlobalPod2[&quot;Cluster2 Pod&quot;]
        GlobalSvc --&gt; GlobalPod1
        GlobalSvc --&gt; GlobalPod2
    end
</code></pre></div>
<h4 id="2832">28.3.2 配置方式<a class="headerlink" href="#2832" title="Permanent link">&para;</a></h4>
<p>只需在 Service 上添加注解：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-service</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 标记为 Global Service</span>
<span class="w">    </span><span class="nt">io.cilium/global-service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-app</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<blockquote>
<p>[!NOTE]
只有添加了 <code>io.cilium/global-service: "true"</code> 注解的 Service 才会享有跨集群能力。普通 Service 仍然只在本集群内有效。</p>
</blockquote>
<h3 id="284-service-affinity">28.4 Service Affinity（服务亲和性）<a class="headerlink" href="#284-service-affinity" title="Permanent link">&para;</a></h3>
<h4 id="2841">28.4.1 三种模式<a class="headerlink" href="#2841" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Affinity 模式&quot;
        Local[&quot;local&lt;br/&gt;本地优先&quot;]
        Remote[&quot;remote&lt;br/&gt;远端优先&quot;]
        None[&quot;无标注&lt;br/&gt;随机负载&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">注解值</th>
<th style="text-align: left;">行为</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Local</strong></td>
<td style="text-align: left;"><code>local</code></td>
<td style="text-align: left;">优先访问本集群 Pod</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Remote</strong></td>
<td style="text-align: left;"><code>remote</code></td>
<td style="text-align: left;">优先访问远端集群 Pod</td>
</tr>
<tr>
<td style="text-align: left;"><strong>无标注</strong></td>
<td style="text-align: left;">不设置</td>
<td style="text-align: left;">所有 Pod 随机负载</td>
</tr>
</tbody>
</table>
<h4 id="2842">28.4.2 配置示例<a class="headerlink" href="#2842" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo-local</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">io.cilium/global-service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="w">    </span><span class="nt">io.cilium/service-affinity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;local&quot;</span><span class="w">    </span><span class="c1"># 本地优先</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo-remote</span><span class="w">  </span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">io.cilium/global-service</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="w">    </span><span class="nt">io.cilium/service-affinity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;remote&quot;</span><span class="w">   </span><span class="c1"># 远端优先</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<h4 id="2843">28.4.3 应用场景<a class="headerlink" href="#2843" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    Q1[&quot;需要降低延迟?&quot;]
    Q2[&quot;需要测试远端?&quot;]
    A1[&quot;使用 local&quot;]
    A2[&quot;使用 remote&quot;]
    A3[&quot;不设置（随机）&quot;]

    Q1 --&gt;|&quot;是&quot;| A1
    Q1 --&gt;|&quot;否&quot;| Q2
    Q2 --&gt;|&quot;是&quot;| A2
    Q2 --&gt;|&quot;否&quot;| A3
</code></pre></div>
<h3 id="285-failover">28.5 故障切换（Failover）<a class="headerlink" href="#285-failover" title="Permanent link">&para;</a></h3>
<h4 id="2851">28.5.1 工作原理<a class="headerlink" href="#2851" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as 客户端
    participant Svc as Global Service
    participant C1 as Cluster1 Pods
    participant C2 as Cluster2 Pods

    Note over C1, C2: 正常状态：两集群都有 Pod
    Client-&gt;&gt;Svc: 请求
    Svc-&gt;&gt;C1: 负载到 Cluster1
    Svc-&gt;&gt;C2: 负载到 Cluster2

    Note over C1: Cluster1 故障！
    Client-&gt;&gt;Svc: 请求
    Svc-&gt;&gt;C2: 全部负载到 Cluster2
</code></pre></div>
<h4 id="2852">28.5.2 测试验证<a class="headerlink" href="#2852" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 正常状态 - 两个集群都响应</span>
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..10<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>curl<span class="w"> </span>http://service<span class="p">;</span><span class="w"> </span><span class="k">done</span>
<span class="c1"># 输出: Cluster1, Cluster2, Cluster1, Cluster2...</span>

<span class="c1"># 2. 模拟 Cluster2 故障（缩容到 0）</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>cluster2<span class="w"> </span>scale<span class="w"> </span>deploy<span class="w"> </span>backend<span class="w"> </span>--replicas<span class="o">=</span><span class="m">0</span>

<span class="c1"># 3. 再次测试 - 只有 Cluster1 响应</span>
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..10<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>curl<span class="w"> </span>http://service<span class="p">;</span><span class="w"> </span><span class="k">done</span>
<span class="c1"># 输出: Cluster1, Cluster1, Cluster1...</span>
</code></pre></div>
<h3 id="286">28.6 环境搭建<a class="headerlink" href="#286" title="Permanent link">&para;</a></h3>
<h4 id="2861">28.6.1 前置条件<a class="headerlink" href="#2861" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">要求</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Pod CIDR</strong></td>
<td style="text-align: left;">各集群不能重叠</td>
</tr>
<tr>
<td style="text-align: left;"><strong>网络互通</strong></td>
<td style="text-align: left;">集群间需能相互访问</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CA 证书</strong></td>
<td style="text-align: left;">需共享或继承</td>
</tr>
</tbody>
</table>
<h4 id="2862">28.6.2 安装步骤<a class="headerlink" href="#2862" title="Permanent link">&para;</a></h4>
<p><strong>1. 安装 Cluster 1</strong>：</p>
<div class="highlight"><pre><span></span><code>cilium<span class="w"> </span>install<span class="w"> </span>--context<span class="w"> </span>kind-cluster1<span class="w"> </span>--cluster-name<span class="w"> </span>cluster1<span class="w"> </span>--cluster-id<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<p><strong>2. 安装 Cluster 2（继承 CA）</strong>：</p>
<div class="highlight"><pre><span></span><code>cilium<span class="w"> </span>install<span class="w"> </span>--context<span class="w"> </span>kind-cluster2<span class="w"> </span>--cluster-name<span class="w"> </span>cluster2<span class="w"> </span>--cluster-id<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--inherit-ca<span class="w"> </span>kind-cluster1
</code></pre></div>
<blockquote>
<p>[!NOTE]
<code>--inherit-ca</code> 参数让 Cluster2 继承 Cluster1 的 CA 证书，这是最简单的方式。如果使用 Helm 安装则需要手动配置证书。</p>
</blockquote>
<p><strong>3. 启用 ClusterMesh</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在两个集群上启用</span>
cilium<span class="w"> </span>clustermesh<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--context<span class="w"> </span>kind-cluster1<span class="w"> </span>--service-type<span class="w"> </span>NodePort
cilium<span class="w"> </span>clustermesh<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--context<span class="w"> </span>kind-cluster2<span class="w"> </span>--service-type<span class="w"> </span>NodePort
</code></pre></div>
<p><strong>4. 连接集群</strong>：</p>
<div class="highlight"><pre><span></span><code>cilium<span class="w"> </span>clustermesh<span class="w"> </span>connect<span class="w"> </span>--context<span class="w"> </span>kind-cluster1<span class="w"> </span>--destination-context<span class="w"> </span>kind-cluster2
</code></pre></div>
<p><strong>5. 验证状态</strong>：</p>
<div class="highlight"><pre><span></span><code>cilium<span class="w"> </span>clustermesh<span class="w"> </span>status<span class="w"> </span>--context<span class="w"> </span>kind-cluster1
</code></pre></div>
<h4 id="2863">28.6.3 连接方式<a class="headerlink" href="#2863" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">方式</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>NodePort</strong></td>
<td style="text-align: left;">开发测试环境</td>
</tr>
<tr>
<td style="text-align: left;"><strong>LoadBalancer</strong></td>
<td style="text-align: left;">生产环境（需要 MetalLB 等）</td>
</tr>
</tbody>
</table>
<h3 id="287">28.7 网络通信模式<a class="headerlink" href="#287" title="Permanent link">&para;</a></h3>
<h4 id="2871">28.7.1 两种模式<a class="headerlink" href="#2871" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;隧道模式&quot;
        T1[&quot;Pod A&quot;] --&gt;|&quot;VXLAN 封装&quot;| T2[&quot;Pod B&quot;]
    end

    subgraph &quot;直接路由&quot;
        R1[&quot;Pod A&quot;] --&gt;|&quot;BGP/静态路由&quot;| R2[&quot;Pod B&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">说明</th>
<th style="text-align: left;">适用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>VXLAN</strong></td>
<td style="text-align: left;">Overlay 封装</td>
<td style="text-align: left;">网络设备无法配置</td>
</tr>
<tr>
<td style="text-align: left;"><strong>直接路由</strong></td>
<td style="text-align: left;">需要底层路由支持</td>
<td style="text-align: left;">可控制网络设备</td>
</tr>
</tbody>
</table>
<h4 id="2872">28.7.2 跨集群通信<a class="headerlink" href="#2872" title="Permanent link">&para;</a></h4>
<p>从 ClusterMesh 角度看，两个集群相当于一个逻辑集群，Pod 间通信与单集群内跨节点通信类似。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 tunnel 信息</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>tunnel<span class="w"> </span>list

<span class="c1"># 会显示所有节点（包括其他集群的节点）</span>
</code></pre></div>
<h3 id="288">28.8 验证与调试<a class="headerlink" href="#288" title="Permanent link">&para;</a></h3>
<h4 id="2881-clustermesh">28.8.1 查看 ClusterMesh 状态<a class="headerlink" href="#2881-clustermesh" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看连接状态</span>
cilium<span class="w"> </span>clustermesh<span class="w"> </span>status

<span class="c1"># 查看节点列表（包含所有集群）</span>
cilium<span class="w"> </span>node<span class="w"> </span>list
</code></pre></div>
<h4 id="2882-service">28.8.2 查看 Service 后端<a class="headerlink" href="#2882-service" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 登录 Cilium Pod</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>cilium-xxx<span class="w"> </span>--<span class="w"> </span>bash

<span class="c1"># 查看 Service 后端列表</span>
cilium<span class="w"> </span>service<span class="w"> </span>list

<span class="c1"># 查看 Endpoint 详情（会显示 preferred 状态）</span>
cilium<span class="w"> </span>bpf<span class="w"> </span>lb<span class="w"> </span>list
</code></pre></div>
<h4 id="2883">28.8.3 验证输出示例<a class="headerlink" href="#2883" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># preferred = 本集群的 Pod（affinity=local 时优先）
Backend         State
10.1.1.1:80     active, preferred
10.1.1.2:80     active, preferred
10.2.1.1:80     active              # 其他集群的 Pod
10.2.1.2:80     active
</code></pre></div>
<h3 id="289">28.9 限制与注意事项<a class="headerlink" href="#289" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">限制</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>集群数量</strong></td>
<td style="text-align: left;">最多 255 个集群</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Pod CIDR</strong></td>
<td style="text-align: left;">不能重叠</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cluster ID</strong></td>
<td style="text-align: left;">每个集群需唯一</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CNI 要求</strong></td>
<td style="text-align: left;">必须使用 Cilium</td>
</tr>
</tbody>
</table>
<h3 id="2810">28.10 章节小结<a class="headerlink" href="#2810" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((ClusterMesh))
    概念
      多集群融合
      逻辑统一
    配置
      Global Service 注解
      Service Affinity
    功能
      跨集群发现
      故障切换
    部署
      inherit-ca
      clustermesh enable/connect
    模式
      VXLAN
      直接路由
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>ClusterMesh 本质</strong>：</li>
<li>多个物理集群 → 一个逻辑集群</li>
<li>
<p>Service 能发现所有集群的 Pod</p>
</li>
<li>
<p><strong>Global Service</strong>：</p>
</li>
<li>注解：<code>io.cilium/global-service: "true"</code></li>
<li>
<p>必须添加才有跨集群能力</p>
</li>
<li>
<p><strong>Service Affinity</strong>：</p>
</li>
<li><code>local</code>：本地优先，降低延迟</li>
<li><code>remote</code>：远端优先，测试用途</li>
<li>
<p>无标注：随机负载</p>
</li>
<li>
<p><strong>故障切换</strong>：</p>
</li>
<li>一个集群 Pod 消失</li>
<li>
<p>自动切换到其他集群</p>
</li>
<li>
<p><strong>部署关键</strong>：</p>
</li>
<li>Pod CIDR 不能重叠</li>
<li>使用 <code>--inherit-ca</code> 共享证书</li>
<li>
<p><code>clustermesh enable</code> + <code>connect</code></p>
</li>
<li>
<p><strong>Cilium 独有</strong>：</p>
</li>
<li>ClusterMesh 是 Cilium CNI 特有功能</li>
<li>其他 CNI 不具备此能力</li>
</ol>
</blockquote>
<hr />
<h2 id="cilium-cni_2">Cilium CNI 部分总结<a class="headerlink" href="#cilium-cni_2" title="Permanent link">&para;</a></h2>
<p>至此，Cilium CNI 的全部章节已完成。以下是 Cilium 各功能模块的概览：</p>
<div class="highlight"><pre><span></span><code>mindmap
  root((Cilium CNI))
    基础
      eBPF 原理
      安装配置
      kube-proxy 替代
    网络模式
      VXLAN 隧道
      直接路由
      Native Routing
    Service
      ClusterIP
      NodePort
      LoadBalancer
      ExternalIPs
    高级功能
      Network Policy
      Hubble 可观测性
      带宽管理
      XDP 加速
    七层功能
      Ingress Controller
      Gateway API
    BGP
      BGP 基础
      Control Plane
      LB-IPAM 集成
    多集群
      ClusterMesh
</code></pre></div>
<hr />
<h1 id="calico-cni">第三部分：Calico-CNI<a class="headerlink" href="#calico-cni" title="Permanent link">&para;</a></h1>
<h2 id="calico_2">第二十九章 Calico 基础介绍<a class="headerlink" href="#calico_2" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico CNI 的基础知识，包括其支持的多种网络模式、核心组件和架构设计。Calico 是目前使用最广泛的 Kubernetes CNI 之一，在生产环境中积累了大量经验。</p>
<h3 id="291-calico">29.1 Calico 概述<a class="headerlink" href="#291-calico" title="Permanent link">&para;</a></h3>
<h4 id="2911-calico">29.1.1 什么是 Calico<a class="headerlink" href="#2911-calico" title="Permanent link">&para;</a></h4>
<p>Calico 是一个开源的网络和安全解决方案，提供：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Calico 功能&quot;
        Net[&quot;网络功能&quot;]
        Policy[&quot;网络策略&quot;]
        IPAM[&quot;IP 地址管理&quot;]
    end

    Net --&gt; IPIP[&quot;IPIP 隧道&quot;]
    Net --&gt; VXLAN[&quot;VXLAN 隧道&quot;]
    Net --&gt; BGP[&quot;BGP 路由&quot;]
    Policy --&gt; NP[&quot;Network Policy&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>多种网络模式</strong></td>
<td style="text-align: left;">IPIP、VXLAN、BGP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>网络策略</strong></td>
<td style="text-align: left;">支持 Kubernetes NetworkPolicy</td>
</tr>
<tr>
<td style="text-align: left;"><strong>自有 IPAM</strong></td>
<td style="text-align: left;">calico-ipam，支持 IP 池管理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>成熟稳定</strong></td>
<td style="text-align: left;">在 OpenStack 时代即已存在</td>
</tr>
</tbody>
</table>
<h4 id="2912">29.1.2 官方资源<a class="headerlink" href="#2912" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">资源</th>
<th style="text-align: left;">地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>官网</strong></td>
<td style="text-align: left;"><a href="https://www.tigera.io/project-calico/">https://www.tigera.io/project-calico/</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>文档</strong></td>
<td style="text-align: left;"><a href="https://docs.tigera.io/">https://docs.tigera.io/</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>版本</strong></td>
<td style="text-align: left;">社区版 3.25+，企业版另有</td>
</tr>
</tbody>
</table>
<h3 id="292">29.2 网络模式对比<a class="headerlink" href="#292" title="Permanent link">&para;</a></h3>
<h4 id="2921">29.2.1 支持的网络模式<a class="headerlink" href="#2921" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Overlay 模式&quot;
        IPIP[&quot;IPIP&lt;br/&gt;IP-in-IP&quot;]
        VXLAN[&quot;VXLAN&lt;br/&gt;MAC-in-UDP&quot;]
    end

    subgraph &quot;路由模式&quot;
        BGP[&quot;BGP&lt;br/&gt;Full Mesh / RR&quot;]
    end

    subgraph &quot;高性能&quot;
        eBPF[&quot;eBPF&lt;br/&gt;加速&quot;]
        VPP[&quot;VPP&lt;br/&gt;用户态协议栈&quot;]
    end
</code></pre></div>
<h4 id="2922">29.2.2 模式对比<a class="headerlink" href="#2922" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">封装方式</th>
<th style="text-align: left;">额外开销</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>IPIP</strong></td>
<td style="text-align: left;">IP 包封装在 IP 中</td>
<td style="text-align: left;">20 字节</td>
<td style="text-align: left;">跨子网通信</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VXLAN</strong></td>
<td style="text-align: left;">MAC 包封装在 UDP 中</td>
<td style="text-align: left;">50 字节</td>
<td style="text-align: left;">大二层网络</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BGP</strong></td>
<td style="text-align: left;">无封装，纯路由</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">同子网或可控网络</td>
</tr>
</tbody>
</table>
<h4 id="2923-cross-subnet">29.2.3 Cross Subnet 模式<a class="headerlink" href="#2923-cross-subnet" title="Permanent link">&para;</a></h4>
<p>Calico 支持智能选择封装方式：</p>
<div class="highlight"><pre><span></span><code>graph TB
    Q[&quot;节点间通信&quot;]
    Same[&quot;同子网?&quot;]
    Route[&quot;直接路由&lt;br/&gt;无封装&quot;]
    Encap[&quot;Overlay 封装&lt;br/&gt;IPIP/VXLAN&quot;]

    Q --&gt; Same
    Same --&gt;|&quot;是&quot;| Route
    Same --&gt;|&quot;否&quot;| Encap
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>Cross Subnet 模式</strong>：节点在同一子网时使用直接路由（节省开销），跨子网时使用 Overlay 封装（保证连通）。这是生产环境常见的配置方式。</p>
</blockquote>
<h3 id="293">29.3 核心组件<a class="headerlink" href="#293" title="Permanent link">&para;</a></h3>
<h4 id="2931">29.3.1 组件架构<a class="headerlink" href="#2931" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Calico 组件&quot;
        Felix[&quot;Felix&lt;br/&gt;数据平面代理&quot;]
        Bird[&quot;BIRD&lt;br/&gt;BGP 守护进程&quot;]
        Confd[&quot;Confd&lt;br/&gt;配置管理&quot;]
        IPAM[&quot;calico-ipam&lt;br/&gt;IP 地址管理&quot;]
        Typha[&quot;Typha&lt;br/&gt;数据缓存（可选）&quot;]
    end

    subgraph &quot;数据存储&quot;
        Etcd[&quot;etcd&quot;]
        K8sAPI[&quot;Kubernetes API&quot;]
    end

    Felix --&gt; Bird
    Felix --&gt; Confd
    Confd --&gt; K8sAPI
    Felix --&gt; K8sAPI
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">组件</th>
<th style="text-align: left;">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Felix</strong></td>
<td style="text-align: left;">核心代理，管理路由、ACL、接口</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BIRD</strong></td>
<td style="text-align: left;">BGP 守护进程，路由交换</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Confd</strong></td>
<td style="text-align: left;">监听配置变化，生成 BIRD 配置</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Typha</strong></td>
<td style="text-align: left;">大规模集群数据缓存</td>
</tr>
</tbody>
</table>
<h4 id="2932-bird">29.3.2 BIRD 进程<a class="headerlink" href="#2932-bird" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;BGP 实现&quot;
        Calico[&quot;Calico&quot;]
        Bird[&quot;BIRD&quot;]
        GoBGP[&quot;GoBGP&quot;]
    end

    Calico --&gt;|&quot;原生支持&quot;| Bird
    Cilium --&gt;|&quot;使用&quot;| GoBGP
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">BIRD（Calico）</th>
<th style="text-align: left;">GoBGP（Cilium）</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>语言</strong></td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">Go</td>
</tr>
<tr>
<td style="text-align: left;"><strong>成熟度</strong></td>
<td style="text-align: left;">非常成熟</td>
<td style="text-align: left;">较新</td>
</tr>
<tr>
<td style="text-align: left;"><strong>资源占用</strong></td>
<td style="text-align: left;">较低</td>
<td style="text-align: left;">适中</td>
</tr>
</tbody>
</table>
<h3 id="294-bgp">29.4 BGP 网络架构<a class="headerlink" href="#294-bgp" title="Permanent link">&para;</a></h3>
<h4 id="2941-as-per-rack">29.4.1 AS per Rack 模式<a class="headerlink" href="#2941-as-per-rack" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Spine 层&quot;
        Spine0[&quot;Spine 0&quot;]
        Spine1[&quot;Spine 1&quot;]
    end

    subgraph &quot;Rack 0 (AS 65001)&quot;
        ToR0[&quot;ToR Switch 0&quot;]
        Node0[&quot;Node 0&quot;]
        Node1[&quot;Node 1&quot;]
    end

    subgraph &quot;Rack 1 (AS 65002)&quot;
        ToR1[&quot;ToR Switch 1&quot;]
        Node2[&quot;Node 2&quot;]
        Node3[&quot;Node 3&quot;]
    end

    Spine0 &lt;--&gt;|&quot;eBGP&quot;| ToR0
    Spine0 &lt;--&gt;|&quot;eBGP&quot;| ToR1
    Spine1 &lt;--&gt;|&quot;eBGP&quot;| ToR0
    Spine1 &lt;--&gt;|&quot;eBGP&quot;| ToR1

    ToR0 &lt;--&gt;|&quot;iBGP&quot;| Node0
    ToR0 &lt;--&gt;|&quot;iBGP&quot;| Node1
    ToR1 &lt;--&gt;|&quot;iBGP&quot;| Node2
    ToR1 &lt;--&gt;|&quot;iBGP&quot;| Node3
</code></pre></div>
<p><strong>特点</strong>：</p>
<ul>
<li>同一机架的节点共享同一 AS 号</li>
<li>ToR 交换机作为 BGP 路由反射器（RR）</li>
<li>Spine 与 ToR 之间建立 eBGP</li>
</ul>
<h4 id="2942-as-per-node">29.4.2 AS per Node 模式<a class="headerlink" href="#2942-as-per-node" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;ToR Switch&quot;
        ToR[&quot;ToR&quot;]
    end

    subgraph &quot;Nodes&quot;
        N1[&quot;Node 1&lt;br/&gt;AS 65001&quot;]
        N2[&quot;Node 2&lt;br/&gt;AS 65002&quot;]
        N3[&quot;Node 3&lt;br/&gt;AS 65003&quot;]
    end

    ToR &lt;--&gt;|&quot;eBGP&quot;| N1
    ToR &lt;--&gt;|&quot;eBGP&quot;| N2
    ToR &lt;--&gt;|&quot;eBGP&quot;| N3
</code></pre></div>
<p><strong>特点</strong>：</p>
<ul>
<li>每个节点都是独立的 AS</li>
<li>节点间都是 eBGP 关系</li>
<li>配置更简单，适合小规模</li>
</ul>
<h4 id="2943-downward-default">29.4.3 Downward Default 模式<a class="headerlink" href="#2943-downward-default" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    Spine[&quot;Spine&lt;br/&gt;掌握全网路由&quot;]
    ToR[&quot;ToR&quot;]
    Node[&quot;Node&quot;]

    Node --&gt;|&quot;通告: 默认路由&quot;| ToR
    ToR --&gt;|&quot;转发&quot;| Spine

    Note[&quot;节点只通告默认路由&lt;br/&gt;减轻负载&quot;]
</code></pre></div>
<p><strong>特点</strong>：</p>
<ul>
<li>节点只向上通告默认路由</li>
<li>降低端侧设备压力</li>
<li>全网路由集中在 Spine 层</li>
</ul>
<h3 id="295-vpp">29.5 VPP 高性能方案<a class="headerlink" href="#295-vpp" title="Permanent link">&para;</a></h3>
<h4 id="2951-vpp">29.5.1 VPP 简介<a class="headerlink" href="#2951-vpp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;传统路径&quot;
        App1[&quot;应用&quot;]
        Kernel[&quot;内核协议栈&quot;]
        NIC1[&quot;网卡&quot;]
    end

    subgraph &quot;VPP 路径&quot;
        App2[&quot;应用&quot;]
        VPP[&quot;VPP 用户态协议栈&quot;]
        DPDK[&quot;DPDK&quot;]
        NIC2[&quot;网卡&quot;]
    end

    App1 --&gt; Kernel --&gt; NIC1
    App2 --&gt; VPP --&gt; DPDK --&gt; NIC2
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">概念</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>VPP</strong></td>
<td style="text-align: left;">用户态协议栈，等价于内核协议栈</td>
</tr>
<tr>
<td style="text-align: left;"><strong>DPDK</strong></td>
<td style="text-align: left;">绕过内核直接访问网卡</td>
</tr>
<tr>
<td style="text-align: left;"><strong>用途</strong></td>
<td style="text-align: left;">高带宽场景（10G/25G/40G+）</td>
</tr>
</tbody>
</table>
<h4 id="2952-vpp-calico">29.5.2 VPP 与 Calico 集成<a class="headerlink" href="#2952-vpp-calico" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># VPP 支持的功能</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">路由 (Routing)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">负载均衡 (Load Balancing)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">策略 (Policy)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VXLAN / IPIP / IPsec / MPLS</span>
</code></pre></div>
<blockquote>
<p>[!WARNING]
VPP 方案门槛较高，需要深入理解用户态协议栈和 DPDK。目前主要用于电信/媒体处理等高带宽行业。</p>
</blockquote>
<h3 id="296-calicoctl">29.6 calicoctl 工具<a class="headerlink" href="#296-calicoctl" title="Permanent link">&para;</a></h3>
<h4 id="2961">29.6.1 基本用法<a class="headerlink" href="#2961" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 安装</span>
curl<span class="w"> </span>-O<span class="w"> </span>-L<span class="w"> </span>https://github.com/projectcalico/calico/releases/download/v3.25.0/calicoctl-linux-amd64
mv<span class="w"> </span>calicoctl-linux-amd64<span class="w"> </span>/usr/local/bin/calicoctl
chmod<span class="w"> </span>+x<span class="w"> </span>/usr/local/bin/calicoctl

<span class="c1"># 常用命令</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>nodes
calicoctl<span class="w"> </span>get<span class="w"> </span>ippool
calicoctl<span class="w"> </span>get<span class="w"> </span>bgpconfig
calicoctl<span class="w"> </span>get<span class="w"> </span>bgppeer
</code></pre></div>
<h4 id="2962">29.6.2 功能对比<a class="headerlink" href="#2962" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">工具</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>calicoctl</strong></td>
<td style="text-align: left;">Calico 资源管理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>cilium</strong></td>
<td style="text-align: left;">Cilium 资源管理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>kubectl</strong></td>
<td style="text-align: left;">通用 K8s 资源</td>
</tr>
</tbody>
</table>
<h3 id="297-ip">29.7 IP 池管理<a class="headerlink" href="#297-ip" title="Permanent link">&para;</a></h3>
<h4 id="2971-ip-pool">29.7.1 IP Pool 配置<a class="headerlink" href="#2971-ip-pool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CrossSubnet</span>
<span class="w">  </span><span class="nt">vxlanMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>cidr</code></td>
<td style="text-align: left;">Pod 使用的 IP 段</td>
</tr>
<tr>
<td style="text-align: left;"><code>ipipMode</code></td>
<td style="text-align: left;">IPIP 模式：Always/CrossSubnet/Never</td>
</tr>
<tr>
<td style="text-align: left;"><code>vxlanMode</code></td>
<td style="text-align: left;">VXLAN 模式：Always/CrossSubnet/Never</td>
</tr>
<tr>
<td style="text-align: left;"><code>nodeSelector</code></td>
<td style="text-align: left;">哪些节点使用此池</td>
</tr>
</tbody>
</table>
<h4 id="2972-pod-ip">29.7.2 指定 Pod IP<a class="headerlink" href="#2972-pod-ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 指定 Pod 使用特定 IP</span>
<span class="w">    </span><span class="nt">cni.projectcalico.org/ipAddrs</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[&quot;172.16.0.2&quot;]&#39;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<h3 id="298-ipip-vs-vxlan">29.8 IPIP vs VXLAN 的区别<a class="headerlink" href="#298-ipip-vs-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="2981-flannel">29.8.1 与 Flannel 迁移<a class="headerlink" href="#2981-flannel" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    Flannel[&quot;Flannel&quot;] --&gt;|&quot;迁移&quot;| Calico[&quot;Calico&quot;]

    subgraph &quot;Calico IPIP&quot;
        IPIP[&quot;IPIP + BIRD&quot;]
    end

    subgraph &quot;Calico VXLAN&quot;
        VXLAN[&quot;VXLAN (无 BIRD)&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">BIRD 进程</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>IPIP</strong></td>
<td style="text-align: left;">需要</td>
<td style="text-align: left;">使用 BGP 分发路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VXLAN</strong></td>
<td style="text-align: left;">不需要</td>
<td style="text-align: left;">兼容 Flannel 迁移</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
VXLAN 模式不使用 BIRD 进程，是为了支持从 Flannel 迁移。因为 Flannel 的 VXLAN 模式也不使用 BGP。</p>
</blockquote>
<h3 id="299-cilium">29.9 与 Cilium 对比<a class="headerlink" href="#299-cilium" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Calico</th>
<th style="text-align: left;">Cilium</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>BGP 实现</strong></td>
<td style="text-align: left;">BIRD</td>
<td style="text-align: left;">GoBGP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>eBPF 支持</strong></td>
<td style="text-align: left;">有（可选）</td>
<td style="text-align: left;">原生</td>
</tr>
<tr>
<td style="text-align: left;"><strong>高性能方案</strong></td>
<td style="text-align: left;">VPP/DPDK</td>
<td style="text-align: left;">XDP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>多集群</strong></td>
<td style="text-align: left;">Federation</td>
<td style="text-align: left;">ClusterMesh</td>
</tr>
<tr>
<td style="text-align: left;"><strong>成熟度</strong></td>
<td style="text-align: left;">非常成熟</td>
<td style="text-align: left;">较新但活跃</td>
</tr>
</tbody>
</table>
<h3 id="2910">29.10 章节小结<a class="headerlink" href="#2910" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Calico 基础))
    网络模式
      IPIP
      VXLAN
      BGP
    组件
      Felix
      BIRD
      Confd
    架构
      AS per Rack
      AS per Node
      Downward Default
    高级
      VPP/DPDK
      eBPF
    工具
      calicoctl
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>网络模式</strong>：</li>
<li>IPIP：IP 封装，20 字节开销</li>
<li>VXLAN：MAC 封装，50 字节开销</li>
<li>
<p>BGP：纯路由，无开销</p>
</li>
<li>
<p><strong>Cross Subnet</strong>：</p>
</li>
<li>同子网走路由</li>
<li>跨子网走 Overlay</li>
<li>
<p>智能选择，兼顾性能</p>
</li>
<li>
<p><strong>BGP 架构</strong>：</p>
</li>
<li>AS per Rack：机架共享 AS</li>
<li>AS per Node：节点独立 AS</li>
<li>
<p>Downward Default：减轻端侧压力</p>
</li>
<li>
<p><strong>BIRD vs 无 BIRD</strong>：</p>
</li>
<li>IPIP 模式需要 BIRD</li>
<li>
<p>VXLAN 模式不需要 BIRD</p>
</li>
<li>
<p><strong>高性能方案</strong>：</p>
</li>
<li>VPP：用户态协议栈</li>
<li>DPDK：绕过内核</li>
<li>
<p>适用于高带宽场景</p>
</li>
<li>
<p><strong>工具</strong>：</p>
</li>
<li>calicoctl 管理 Calico 资源</li>
<li>类似 Cilium CLI</li>
</ol>
</blockquote>
<hr />
<h2 id="calico_3">第三十章 Calico 环境准备<a class="headerlink" href="#calico_3" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico CNI 的环境准备工作，包括集群创建、Calico 安装、管理工具配置和环境验证。这是后续学习 Calico 各种网络模式的基础。</p>
<h3 id="301">30.1 背景与目标<a class="headerlink" href="#301" title="Permanent link">&para;</a></h3>
<h4 id="3011">30.1.1 学习环境需求<a class="headerlink" href="#3011" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;环境组成&quot;
        K8s[&quot;Kubernetes 集群&quot;]
        Calico[&quot;Calico CNI&quot;]
        CLI[&quot;calicoctl 工具&quot;]
        Lab[&quot;ContainerLab (可选)&quot;]
    end

    K8s --&gt; Calico
    CLI --&gt; Calico
    Lab --&gt; K8s
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">组件</th>
<th style="text-align: left;">版本</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Kubernetes</strong></td>
<td style="text-align: left;">1.25+</td>
<td style="text-align: left;">使用 kind 创建</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Calico</strong></td>
<td style="text-align: left;">3.23.x</td>
<td style="text-align: left;">默认 IPIP 模式</td>
</tr>
<tr>
<td style="text-align: left;"><strong>calicoctl</strong></td>
<td style="text-align: left;">与 Calico 版本匹配</td>
<td style="text-align: left;">管理 Calico 资源</td>
</tr>
</tbody>
</table>
<h4 id="3012">30.1.2 环境目标<a class="headerlink" href="#3012" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">目标</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Pod 互通</strong></td>
<td style="text-align: left;">Pod 之间可以相互 ping 通</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Service 可达</strong></td>
<td style="text-align: left;">Service 可正常访问</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨节点通信</strong></td>
<td style="text-align: left;">不同节点的 Pod 可互通</td>
</tr>
</tbody>
</table>
<h3 id="302">30.2 集群创建<a class="headerlink" href="#302" title="Permanent link">&para;</a></h3>
<h4 id="3021-kind">30.2.1 使用 kind 创建集群<a class="headerlink" href="#3021-kind" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># calico-cluster.yaml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cluster</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kind.x-k8s.io/v1alpha4</span>
<span class="nt">networking</span><span class="p">:</span>
<span class="w">  </span><span class="nt">disableDefaultCNI</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">    </span><span class="c1"># 禁用默认 CNI</span>
<span class="w">  </span><span class="nt">podSubnet</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.244.0.0/16&quot;</span><span class="w"> </span><span class="c1"># Pod CIDR</span>
<span class="nt">nodes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">control-plane</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建集群</span>
kind<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>calico-demo<span class="w"> </span>--config<span class="w"> </span>calico-cluster.yaml

<span class="c1"># 去除 master 节点污点（可选）</span>
kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>--all<span class="w"> </span>node-role.kubernetes.io/control-plane-
</code></pre></div>
<h4 id="3022">30.2.2 创建流程<a class="headerlink" href="#3022" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant User as 用户
    participant Kind as kind
    participant K8s as Kubernetes
    participant CNI as CNI 插件

    User-&gt;&gt;Kind: kind create cluster
    Kind-&gt;&gt;K8s: 创建集群
    Note over K8s: 默认 CNI 禁用
    Note over K8s: Pod CIDR: 10.244.0.0/16
    User-&gt;&gt;K8s: 安装 Calico
    K8s-&gt;&gt;CNI: Calico 就绪
    Note over K8s: Pod 网络可用
</code></pre></div>
<h3 id="303-calico">30.3 安装 Calico<a class="headerlink" href="#303-calico" title="Permanent link">&para;</a></h3>
<h4 id="3031">30.3.1 安装方式对比<a class="headerlink" href="#3031" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">方式</th>
<th style="text-align: left;">适用场景</th>
<th style="text-align: left;">特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Quick Start</strong></td>
<td style="text-align: left;">快速体验</td>
<td style="text-align: left;">使用 YAML Manifest</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Helm</strong></td>
<td style="text-align: left;">生产环境</td>
<td style="text-align: left;">更灵活的配置</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Operator</strong></td>
<td style="text-align: left;">企业环境</td>
<td style="text-align: left;">声明式管理</td>
</tr>
</tbody>
</table>
<h4 id="3032-quick-start">30.3.2 Quick Start 安装<a class="headerlink" href="#3032-quick-start" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 安装 Calico Operator 和 CRD</span>
kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/projectcalico/calico/v3.23.2/manifests/tigera-operator.yaml

<span class="c1"># 安装 Calico 自定义资源</span>
kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/projectcalico/calico/v3.23.2/manifests/custom-resources.yaml

<span class="c1"># 等待 Pod 就绪</span>
kubectl<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready<span class="w"> </span>pods<span class="w"> </span>--all<span class="w"> </span>-n<span class="w"> </span>calico-system<span class="w"> </span>--timeout<span class="o">=</span>300s
kubectl<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready<span class="w"> </span>pods<span class="w"> </span>--all<span class="w"> </span>-n<span class="w"> </span>calico-apiserver<span class="w"> </span>--timeout<span class="o">=</span>300s
</code></pre></div>
<h4 id="3033">30.3.3 查看安装结果<a class="headerlink" href="#3033" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Calico Pod</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>calico-system
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>calico-apiserver

<span class="c1"># 输出示例</span>
NAME<span class="w">                                       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
calico-kube-controllers-xxx<span class="w">                </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>5m
calico-node-xxx<span class="w">                            </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>5m
calico-typha-xxx<span class="w">                           </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>5m
</code></pre></div>
<h3 id="304-calicoctl">30.4 calicoctl 工具<a class="headerlink" href="#304-calicoctl" title="Permanent link">&para;</a></h3>
<h4 id="3041-calicoctl">30.4.1 安装 calicoctl<a class="headerlink" href="#3041-calicoctl" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 下载 calicoctl（需与 Calico 版本匹配）</span>
curl<span class="w"> </span>-L<span class="w"> </span>https://github.com/projectcalico/calico/releases/download/v3.23.2/calicoctl-linux-amd64<span class="w"> </span>-o<span class="w"> </span>calicoctl

<span class="c1"># 添加执行权限</span>
chmod<span class="w"> </span>+x<span class="w"> </span>calicoctl
mv<span class="w"> </span>calicoctl<span class="w"> </span>/usr/local/bin/

<span class="c1"># 验证版本</span>
calicoctl<span class="w"> </span>version
</code></pre></div>
<h4 id="3042">30.4.2 版本匹配重要性<a class="headerlink" href="#3042" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    Client[&quot;calicoctl v3.23.5&quot;]
    Cluster[&quot;Cluster v3.23.2&quot;]

    Client --&gt;|&quot;版本不匹配&quot;| Warning[&quot;WARNING: mismatched versions&quot;]

    Client2[&quot;calicoctl v3.23.2&quot;]
    Cluster2[&quot;Cluster v3.23.2&quot;]

    Client2 --&gt;|&quot;版本匹配&quot;| OK[&quot;正常工作&quot;]
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>版本匹配非常重要！</strong> calicoctl 版本必须与集群中 Calico 版本一致，否则会出现 <code>mismatched versions</code> 警告。虽然可以使用 <code>--allow-version-mismatch</code> 强制运行，但不推荐在生产环境中这样做。</p>
</blockquote>
<h4 id="3043">30.4.3 常用命令<a class="headerlink" href="#3043" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看节点</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>nodes

<span class="c1"># 查看 IP 池</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>ippool<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1"># 查看 BGP 配置</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>bgpconfig

<span class="c1"># 查看 BGP Peer</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>bgppeer
</code></pre></div>
<h3 id="305-ippool">30.5 IPPool 配置详解<a class="headerlink" href="#305-ippool" title="Permanent link">&para;</a></h3>
<h4 id="3051-ippool">30.5.1 默认 IPPool<a class="headerlink" href="#3051-ippool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 IPPool</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>ippool<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-ipv4-ippool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span><span class="w">           </span><span class="c1"># Pod CIDR</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span><span class="w">              </span><span class="c1"># IPIP 模式</span>
<span class="w">  </span><span class="nt">vxlanMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w">              </span><span class="c1"># 不使用 VXLAN</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">             </span><span class="c1"># 出站 NAT</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all()</span><span class="w">           </span><span class="c1"># 所有节点</span>
<span class="w">  </span><span class="nt">disabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">               </span><span class="c1"># 启用状态</span>
</code></pre></div>
<h4 id="3052">30.5.2 关键字段说明<a class="headerlink" href="#3052" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;IPPool 字段&quot;
        CIDR[&quot;cidr&lt;br/&gt;Pod 网段&quot;]
        IPIP[&quot;ipipMode&lt;br/&gt;IPIP 封装模式&quot;]
        VXLAN[&quot;vxlanMode&lt;br/&gt;VXLAN 封装模式&quot;]
        NAT[&quot;natOutgoing&lt;br/&gt;出站 NAT&quot;]
        Selector[&quot;nodeSelector&lt;br/&gt;节点选择器&quot;]
        Disabled[&quot;disabled&lt;br/&gt;是否禁用&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">可选值</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>ipipMode</code></td>
<td style="text-align: left;">Always/CrossSubnet/Never</td>
<td style="text-align: left;">IPIP 封装策略</td>
</tr>
<tr>
<td style="text-align: left;"><code>vxlanMode</code></td>
<td style="text-align: left;">Always/CrossSubnet/Never</td>
<td style="text-align: left;">VXLAN 封装策略</td>
</tr>
<tr>
<td style="text-align: left;"><code>natOutgoing</code></td>
<td style="text-align: left;">true/false</td>
<td style="text-align: left;">Pod 出站是否 NAT</td>
</tr>
<tr>
<td style="text-align: left;"><code>nodeSelector</code></td>
<td style="text-align: left;">all()/标签表达式</td>
<td style="text-align: left;">哪些节点使用此池</td>
</tr>
<tr>
<td style="text-align: left;"><code>disabled</code></td>
<td style="text-align: left;">true/false</td>
<td style="text-align: left;">是否禁用此池</td>
</tr>
</tbody>
</table>
<h4 id="3053">30.5.3 封装模式对比<a class="headerlink" href="#3053" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;ipipMode/vxlanMode 值&quot;
        Always[&quot;Always&lt;br/&gt;始终封装&quot;]
        Cross[&quot;CrossSubnet&lt;br/&gt;跨子网封装&quot;]
        Never[&quot;Never&lt;br/&gt;不封装&quot;]
    end

    Always --&gt; A1[&quot;所有跨节点通信都封装&quot;]
    Cross --&gt; C1[&quot;同子网路由，跨子网封装&quot;]
    Never --&gt; N1[&quot;纯路由，不封装&quot;]
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>IPIP 和 VXLAN 互斥</strong>：不能同时设置 <code>ipipMode: Always</code> 和 <code>vxlanMode: Always</code>。通常只启用其中一种，另一种设为 <code>Never</code>。</p>
</blockquote>
<h3 id="306">30.6 环境验证<a class="headerlink" href="#306" title="Permanent link">&para;</a></h3>
<h4 id="3061">30.6.1 验证流程<a class="headerlink" href="#3061" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    Deploy[&quot;部署测试 Pod&quot;]
    PodPing[&quot;Pod 间 ping 测试&quot;]
    SvcTest[&quot;Service 访问测试&quot;]
    Result[&quot;验证通过&quot;]

    Deploy --&gt; PodPing --&gt; SvcTest --&gt; Result
</code></pre></div>
<h4 id="3062">30.6.2 部署测试资源<a class="headerlink" href="#3062" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># test-pods.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod1</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;3600&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod2</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;3600&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-svc</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建测试资源</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>test-pods.yaml

<span class="c1"># 等待 Pod 就绪</span>
kubectl<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready<span class="w"> </span>pods<span class="w"> </span>--all<span class="w"> </span>--timeout<span class="o">=</span>120s
</code></pre></div>
<h4 id="3063">30.6.3 执行验证<a class="headerlink" href="#3063" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 获取 Pod IP</span>
<span class="nv">POD1_IP</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>pod1<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.podIP}&#39;</span><span class="k">)</span>
<span class="nv">POD2_IP</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>pod2<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.podIP}&#39;</span><span class="k">)</span>

<span class="c1"># Pod 间 ping 测试</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>pod1<span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span>-c<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="nv">$POD2_IP</span>

<span class="c1"># Service 访问测试</span>
<span class="nv">SVC_IP</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>test-svc<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.clusterIP}&#39;</span><span class="k">)</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>pod1<span class="w"> </span>--<span class="w"> </span>wget<span class="w"> </span>-qO-<span class="w"> </span>http://<span class="nv">$SVC_IP</span><span class="w"> </span>--timeout<span class="o">=</span><span class="m">5</span>

<span class="c1"># 验证成功标志</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Pod 互通: OK&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Service 可达: OK&quot;</span>
</code></pre></div>
<h3 id="307-containerlab">30.7 ContainerLab 拓扑规划<a class="headerlink" href="#307-containerlab" title="Permanent link">&para;</a></h3>
<h4 id="3071-ipip">30.7.1 IPIP 学习拓扑<a class="headerlink" href="#3071-ipip" title="Permanent link">&para;</a></h4>
<p>为后续学习 IPIP 模式，建议搭建以下拓扑：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Router&quot;
        GW[&quot;网关路由器&lt;br/&gt;192.168.1.1&quot;]
    end

    subgraph &quot;子网 1: 192.168.1.0/24&quot;
        Node1[&quot;Node 1&lt;br/&gt;192.168.1.10&quot;]
        Node2[&quot;Node 2&lt;br/&gt;192.168.1.11&quot;]
    end

    subgraph &quot;子网 2: 192.168.2.0/24&quot;
        Node3[&quot;Node 3&lt;br/&gt;192.168.2.10&quot;]
    end

    Node1 --- Node2
    Node1 &lt;--&gt; GW
    Node2 &lt;--&gt; GW
    GW &lt;--&gt; Node3
</code></pre></div>
<h4 id="3072">30.7.2 拓扑说明<a class="headerlink" href="#3072" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">节点</th>
<th style="text-align: left;">子网</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Node 1</td>
<td style="text-align: left;">192.168.1.0/24</td>
<td style="text-align: left;">与 Node 2 同子网</td>
</tr>
<tr>
<td style="text-align: left;">Node 2</td>
<td style="text-align: left;">192.168.1.0/24</td>
<td style="text-align: left;">与 Node 1 同子网</td>
</tr>
<tr>
<td style="text-align: left;">Node 3</td>
<td style="text-align: left;">192.168.2.0/24</td>
<td style="text-align: left;">跨子网，需 IPIP</td>
</tr>
</tbody>
</table>
<p><strong>通信路径</strong>：</p>
<ul>
<li>Node 1 ↔ Node 2：同子网，可直接路由</li>
<li>Node 1 ↔ Node 3：跨子网，经过网关，需要 IPIP 封装</li>
</ul>
<h3 id="308-ipam">30.8 IPAM 问题排查<a class="headerlink" href="#308-ipam" title="Permanent link">&para;</a></h3>
<h4 id="3081">30.8.1 常见问题<a class="headerlink" href="#3081" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">原因</th>
<th style="text-align: left;">解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>IP 重复</strong></td>
<td style="text-align: left;">IPAM 数据库不一致</td>
<td style="text-align: left;">使用 calicoctl ipam check</td>
</tr>
<tr>
<td style="text-align: left;"><strong>无法分配 IP</strong></td>
<td style="text-align: left;">IPPool 禁用或耗尽</td>
<td style="text-align: left;">检查 IPPool 状态</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Pod 无 IP</strong></td>
<td style="text-align: left;">CNI 配置错误</td>
<td style="text-align: left;">检查 /etc/cni/net.d/</td>
</tr>
</tbody>
</table>
<h4 id="3082-ipam">30.8.2 IPAM 命令<a class="headerlink" href="#3082-ipam" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 IPAM 状态</span>
calicoctl<span class="w"> </span>ipam<span class="w"> </span>check

<span class="c1"># 释放未使用的 IP</span>
calicoctl<span class="w"> </span>ipam<span class="w"> </span>release<span class="w"> </span>--ip<span class="o">=</span><span class="m">10</span>.244.x.x

<span class="c1"># 显示 IPAM 使用情况</span>
calicoctl<span class="w"> </span>ipam<span class="w"> </span>show

<span class="c1"># 显示某个 IP 的分配信息</span>
calicoctl<span class="w"> </span>ipam<span class="w"> </span>show<span class="w"> </span>--ip<span class="o">=</span><span class="m">10</span>.244.x.x
</code></pre></div>
<blockquote>
<p>[!TIP]
IBM 文档中有详细的 Calico IPAM 故障排查指南，搜索 "IBM Calico IPAM" 可以找到更多实用信息。</p>
</blockquote>
<h3 id="309">30.9 章节小结<a class="headerlink" href="#309" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((环境准备))
    集群创建
      kind
      禁用默认 CNI
    安装 Calico
      Quick Start
      Helm
      Operator
    calicoctl
      版本匹配
      常用命令
    IPPool
      ipipMode
      vxlanMode
      nodeSelector
    验证
      Pod 互通
      Service 可达
    拓扑规划
      同子网节点
      跨子网节点
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>集群创建</strong>：</li>
<li>使用 kind 创建集群</li>
<li>禁用默认 CNI：<code>disableDefaultCNI: true</code></li>
<li>
<p>指定 Pod CIDR</p>
</li>
<li>
<p><strong>Calico 安装</strong>：</p>
</li>
<li>Quick Start 适合快速体验</li>
<li>安装 Operator + CustomResources</li>
<li>
<p>等待所有 Pod 就绪</p>
</li>
<li>
<p><strong>calicoctl 工具</strong>：</p>
</li>
<li>版本必须与 Calico 匹配</li>
<li>避免使用 <code>--allow-version-mismatch</code></li>
<li>
<p>可用于查看/管理 Calico 资源</p>
</li>
<li>
<p><strong>IPPool 配置</strong>：</p>
</li>
<li><code>ipipMode</code>：Always/CrossSubnet/Never</li>
<li><code>vxlanMode</code>：与 ipipMode 互斥</li>
<li>
<p><code>nodeSelector</code>：all() 表示全部节点</p>
</li>
<li>
<p><strong>环境验证</strong>：</p>
</li>
<li>Pod 间 ping 测试</li>
<li>Service 访问测试</li>
<li>
<p>两项都通过 = CNI 工作正常</p>
</li>
<li>
<p><strong>后续学习</strong>：</p>
</li>
<li>搭建 ContainerLab 拓扑</li>
<li>准备同子网/跨子网场景</li>
<li>实践 IPIP/CrossSubnet 模式</li>
</ol>
</blockquote>
<hr />
<h2 id="calico_4">第三十一章 Calico 同节点通信<a class="headerlink" href="#calico_4" title="Permanent link">&para;</a></h2>
<p>本章深入分析 Calico 同节点 Pod 之间的通信原理，这是所有 Calico 网络模式（IPIP/VXLAN/BGP）的共同基础。同节点通信采用 L3 路由转发方式，核心技术是 Proxy ARP。</p>
<h3 id="311">31.1 背景与概述<a class="headerlink" href="#311" title="Permanent link">&para;</a></h3>
<h4 id="3111">31.1.1 同节点通信的重要性<a class="headerlink" href="#3111" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特点</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>模式通用</strong></td>
<td style="text-align: left;">IPIP、VXLAN、BGP 同节点通信方式相同</td>
</tr>
<tr>
<td style="text-align: left;"><strong>L3 转发</strong></td>
<td style="text-align: left;">采用三层路由方式，非二层交换</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Proxy ARP</strong></td>
<td style="text-align: left;">核心技术，打通 Pod 与 Root Namespace</td>
</tr>
</tbody>
</table>
<h4 id="3112-cni">31.1.2 与其他 CNI 对比<a class="headerlink" href="#3112-cni" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Calico 方式&quot;
        P1[&quot;Pod 1&quot;] --&gt; Router[&quot;Host 路由器&quot;]
        Router --&gt; P2[&quot;Pod 2&quot;]
    end

    subgraph &quot;Flannel 方式&quot;
        F1[&quot;Pod 1&quot;] --&gt; Bridge[&quot;Linux Bridge&quot;]
        Bridge --&gt; F2[&quot;Pod 2&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">CNI</th>
<th style="text-align: left;">转发层级</th>
<th style="text-align: left;">设备</th>
<th style="text-align: left;">特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Calico</strong></td>
<td style="text-align: left;">L3 路由</td>
<td style="text-align: left;">Host 作为路由器</td>
<td style="text-align: left;">无广播，效率高</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Flannel</strong></td>
<td style="text-align: left;">L2 交换</td>
<td style="text-align: left;">Linux Bridge</td>
<td style="text-align: left;">有广播，传统方式</td>
</tr>
</tbody>
</table>
<h3 id="312">31.2 网络拓扑结构<a class="headerlink" href="#312" title="Permanent link">&para;</a></h3>
<h4 id="3121-veth-pair">31.2.1 veth pair 连接<a class="headerlink" href="#3121-veth-pair" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Pod 1 (10.244.x.66/32)&quot;
        eth0_1[&quot;eth0&quot;]
    end

    subgraph &quot;Host (Root Namespace)&quot;
        cali1[&quot;cali-xxx1&quot;]
        cali2[&quot;cali-xxx2&quot;]
        Routing[&quot;路由表&quot;]
    end

    subgraph &quot;Pod 2 (10.244.x.65/32)&quot;
        eth0_2[&quot;eth0&quot;]
    end

    eth0_1 ---|&quot;veth pair&quot;| cali1
    eth0_2 ---|&quot;veth pair&quot;| cali2
    cali1 --&gt; Routing
    cali2 --&gt; Routing
</code></pre></div>
<p><strong>关键点</strong>：</p>
<ul>
<li>每个 Pod 的 eth0 通过 veth pair 连接到 Host</li>
<li>Host 端的网卡名为 <code>cali-xxx</code> 格式</li>
<li>Pod IP 使用 <code>/32</code> 掩码（与任何地址都不同网段）</li>
</ul>
<h4 id="3122">31.2.2 网卡特征<a class="headerlink" href="#3122" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Pod 内查看网卡</span>
ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>eth0
<span class="c1"># eth0@if5: ...</span>

<span class="c1"># 在 Host 上查看对应的 cali 网卡</span>
ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^5:&quot;</span>
<span class="c1"># 5: cali-xxx@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; ...</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">网卡</th>
<th style="text-align: left;">位置</th>
<th style="text-align: left;">MAC 地址</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>eth0</code></td>
<td style="text-align: left;">Pod 内</td>
<td style="text-align: left;">随机 MAC</td>
<td style="text-align: left;">Pod 的主网卡</td>
</tr>
<tr>
<td style="text-align: left;"><code>cali-xxx</code></td>
<td style="text-align: left;">Host</td>
<td style="text-align: left;"><code>ee:ee:ee:ee:ee:ee</code></td>
<td style="text-align: left;">全 1 固定 MAC</td>
</tr>
</tbody>
</table>
<h3 id="313">31.3 路由转发原理<a class="headerlink" href="#313" title="Permanent link">&para;</a></h3>
<h4 id="3131-pod">31.3.1 Pod 内路由表<a class="headerlink" href="#3131-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Pod 内查看路由</span>
ip<span class="w"> </span>route

<span class="c1"># 输出示例</span>
default<span class="w"> </span>via<span class="w"> </span><span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>scope<span class="w"> </span>link
</code></pre></div>
<p><strong>路由表解读</strong>：</p>
<ul>
<li><strong>默认路由</strong>：所有流量发往 <code>169.254.1.1</code>（网关）</li>
<li><strong>出接口</strong>：通过 <code>eth0</code> 发出</li>
<li><strong>scope link</strong>：本地链路范围</li>
</ul>
<h4 id="3132-32">31.3.2 为什么使用 /32 掩码<a class="headerlink" href="#3132-32" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Pod IP: 10.244.66.66/32&quot;
        Any[&quot;任何其他 IP&quot;]
    end

    Any --&gt;|&quot;不同网段&quot;| L3[&quot;必须走 L3 路由&quot;]
    L3 --&gt;|&quot;查询路由表&quot;| Gateway[&quot;发往网关 169.254.1.1&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">掩码</th>
<th style="text-align: left;">含义</th>
<th style="text-align: left;">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>/32</code></td>
<td style="text-align: left;">只有自己在网段内</td>
<td style="text-align: left;">任何目的 IP 都走 L3</td>
</tr>
<tr>
<td style="text-align: left;"><code>/24</code></td>
<td style="text-align: left;">256 个地址同网段</td>
<td style="text-align: left;">同网段走 L2 交换</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
使用 <code>/32</code> 掩码强制所有流量走三层路由，这是 Calico L3 网络模型的核心设计。</p>
</blockquote>
<h4 id="3133-host">31.3.3 Host 路由表<a class="headerlink" href="#3133-host" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Host 上查看路由</span>
ip<span class="w"> </span>route<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">10</span>.244

<span class="c1"># 输出示例</span>
<span class="m">10</span>.244.66.65<span class="w"> </span>dev<span class="w"> </span>cali-xxx1<span class="w"> </span>scope<span class="w"> </span>link
<span class="m">10</span>.244.66.66<span class="w"> </span>dev<span class="w"> </span>cali-xxx2<span class="w"> </span>scope<span class="w"> </span>link
</code></pre></div>
<p><strong>解读</strong>：到达每个 Pod IP 的路由，出接口就是连接该 Pod 的 cali 网卡。</p>
<h3 id="314">31.4 数据包转发流程<a class="headerlink" href="#314" title="Permanent link">&para;</a></h3>
<h4 id="3141">31.4.1 同节点通信流程<a class="headerlink" href="#3141" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod 1 (10.244.66.66)
    participant Cali1 as cali-xxx1
    participant Host as Host 路由表
    participant Cali2 as cali-xxx2
    participant Pod2 as Pod 2 (10.244.66.65)

    Pod1-&gt;&gt;Pod1: 1. 查路由表，找到网关 169.254.1.1
    Pod1-&gt;&gt;Pod1: 2. ARP 请求网关 MAC
    Note over Pod1: Proxy ARP 返回全 1 MAC
    Pod1-&gt;&gt;Cali1: 3. 封包发送 (dst MAC: ee:ee:ee:ee:ee:ee)
    Cali1-&gt;&gt;Host: 4. 进入 Host 路由表查询
    Host-&gt;&gt;Host: 5. 查到 10.244.66.65 出口是 cali-xxx2
    Host-&gt;&gt;Cali2: 6. 从 cali-xxx2 发出
    Cali2-&gt;&gt;Pod2: 7. 到达 Pod 2
</code></pre></div>
<h4 id="3142">31.4.2 数据包封装详解<a class="headerlink" href="#3142" title="Permanent link">&para;</a></h4>
<p><strong>第一跳（Pod → Host）</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">值</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Src IP</td>
<td style="text-align: left;">10.244.66.66</td>
<td style="text-align: left;">源 Pod IP</td>
</tr>
<tr>
<td style="text-align: left;">Dst IP</td>
<td style="text-align: left;">10.244.66.65</td>
<td style="text-align: left;">目的 Pod IP</td>
</tr>
<tr>
<td style="text-align: left;">Src MAC</td>
<td style="text-align: left;">Pod 1 的 MAC</td>
<td style="text-align: left;">eth0 的 MAC</td>
</tr>
<tr>
<td style="text-align: left;">Dst MAC</td>
<td style="text-align: left;"><code>ee:ee:ee:ee:ee:ee</code></td>
<td style="text-align: left;">网关（Proxy ARP 返回）</td>
</tr>
</tbody>
</table>
<p><strong>第二跳（Host → Pod 2）</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">值</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Src IP</td>
<td style="text-align: left;">10.244.66.66</td>
<td style="text-align: left;">保持不变</td>
</tr>
<tr>
<td style="text-align: left;">Dst IP</td>
<td style="text-align: left;">10.244.66.65</td>
<td style="text-align: left;">保持不变</td>
</tr>
<tr>
<td style="text-align: left;">Src MAC</td>
<td style="text-align: left;"><code>ee:ee:ee:ee:ee:ee</code></td>
<td style="text-align: left;">cali-xxx2 的 MAC</td>
</tr>
<tr>
<td style="text-align: left;">Dst MAC</td>
<td style="text-align: left;">Pod 2 的 MAC</td>
<td style="text-align: left;">目的 Pod 的 MAC</td>
</tr>
</tbody>
</table>
<h3 id="315-proxy-arp">31.5 Proxy ARP 机制<a class="headerlink" href="#315-proxy-arp" title="Permanent link">&para;</a></h3>
<h4 id="3151-proxy-arp">31.5.1 什么是 Proxy ARP<a class="headerlink" href="#3151-proxy-arp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Pod&quot;
        ARP[&quot;ARP Request&lt;br/&gt;Who has 169.254.1.1?&quot;]
    end

    subgraph &quot;Host cali 网卡&quot;
        Proxy[&quot;Proxy ARP&lt;br/&gt;启用 proxy_arp&quot;]
    end

    ARP --&gt;|&quot;请求&quot;| Proxy
    Proxy --&gt;|&quot;用自己的 MAC 回复&quot;| ARP
</code></pre></div>
<p><strong>Proxy ARP 原理</strong>：</p>
<ol>
<li>Pod 发送 ARP 请求查询 <code>169.254.1.1</code> 的 MAC</li>
<li>cali 网卡开启了 <code>proxy_arp</code> 功能</li>
<li>cali 网卡用自己的 MAC 地址（全 1）回复</li>
<li>Pod 得到 MAC 后即可封装数据包</li>
</ol>
<h4 id="3152-16925411">31.5.2 169.254.1.1 的意义<a class="headerlink" href="#3152-16925411" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 这个地址在 Host 上找不到</span>
ip<span class="w"> </span>addr<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">169</span>.254
<span class="c1"># 无输出</span>

<span class="c1"># 但 ARP 可以获得响应</span>
arping<span class="w"> </span>-I<span class="w"> </span>eth0<span class="w"> </span><span class="m">169</span>.254.1.1
<span class="c1"># ARPING 169.254.1.1</span>
<span class="c1"># 60 bytes from ee:ee:ee:ee:ee:ee: index=0 ...</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">答案</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">为什么找不到 169.254.1.1？</td>
<td style="text-align: left;">这个 IP 从未分配给任何接口</td>
</tr>
<tr>
<td style="text-align: left;">为什么 ARP 能成功？</td>
<td style="text-align: left;">Proxy ARP 代为响应</td>
</tr>
<tr>
<td style="text-align: left;">为什么用链路本地地址？</td>
<td style="text-align: left;">避免与其他 IP 冲突</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>169.254.0.0/16 是链路本地地址（Link-Local）</strong>，RFC 3927 规定这个网段用于无 DHCP 时的自动配置。Calico 使用它作为虚拟网关，因为：</p>
<ol>
<li>不会与真实 IP 冲突</li>
<li>不需要实际分配给接口</li>
<li>通过 Proxy ARP 即可工作</li>
</ol>
</blockquote>
<h4 id="3153-proxy-arp">31.5.3 查看 Proxy ARP 配置<a class="headerlink" href="#3153-proxy-arp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 cali 网卡的 proxy_arp 设置</span>
cat<span class="w"> </span>/proc/sys/net/ipv4/conf/cali*/proxy_arp
<span class="c1"># 1   (启用状态)</span>

<span class="c1"># 或使用 sysctl</span>
sysctl<span class="w"> </span>net.ipv4.conf.cali*.proxy_arp
</code></pre></div>
<h3 id="316-1-mac">31.6 全 1 MAC 地址的原因<a class="headerlink" href="#316-1-mac" title="Permanent link">&para;</a></h3>
<h4 id="3161-eeeeeeeeeeee">31.6.1 为什么使用 ee:ee:ee:ee:ee:ee<a class="headerlink" href="#3161-eeeeeeeeeeee" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;设计考虑&quot;
        Stable[&quot;稳定性&lt;br/&gt;内核无法生成持久 MAC&quot;]
        Unique[&quot;唯一性&lt;br/&gt;不与厂商 OUI 冲突&quot;]
        Simple[&quot;简单性&lt;br/&gt;点对点链路不需唯一&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">原因</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>内核限制</strong></td>
<td style="text-align: left;">内核不能为 veth 生成持久稳定的 MAC</td>
</tr>
<tr>
<td style="text-align: left;"><strong>不冲突</strong></td>
<td style="text-align: left;">全 1 不会与任何厂商 OUI 冲突</td>
</tr>
<tr>
<td style="text-align: left;"><strong>点对点</strong></td>
<td style="text-align: left;">veth pair 是点对点，MAC 只需本地有效</td>
</tr>
</tbody>
</table>
<h4 id="3162-mac">31.6.2 MAC 地址作用域<a class="headerlink" href="#3162-mac" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Pod 1 广播域&quot;
        P1[&quot;Pod 1 eth0&quot;]
        C1[&quot;cali-xxx1&quot;]
        P1 &lt;--&gt; C1
    end

    subgraph &quot;Pod 2 广播域&quot;
        P2[&quot;Pod 2 eth0&quot;]
        C2[&quot;cali-xxx2&quot;]
        P2 &lt;--&gt; C2
    end

    subgraph &quot;Host&quot;
        Router[&quot;路由转发 (L3)&quot;]
    end

    C1 --&gt; Router
    Router --&gt; C2
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>MAC 地址只需在冲突域/广播域内唯一</strong>。每个 Pod 与其 cali 网卡组成独立的点对点链路，所以全部使用相同的 MAC 地址不会冲突。</p>
</blockquote>
<h4 id="3163-calico-faq">31.6.3 Calico 官方 FAQ<a class="headerlink" href="#3163-calico-faq" title="Permanent link">&para;</a></h4>
<p>Calico 官网 FAQ 解答了这些常见疑问：</p>
<ol>
<li><strong>Why do my containers have a route to 169.254.1.1?</strong></li>
<li>
<p>这是虚拟网关，通过 Proxy ARP 工作</p>
</li>
<li>
<p><strong>Why can't I see 169.254.1.1 on my host?</strong></p>
</li>
<li>
<p>不需要实际配置，Proxy ARP 代为响应</p>
</li>
<li>
<p><strong>Why do all cali* interfaces have the same MAC?</strong></p>
</li>
<li>点对点链路，无需唯一 MAC</li>
</ol>
<h3 id="317-flannel">31.7 与 Flannel 对比<a class="headerlink" href="#317-flannel" title="Permanent link">&para;</a></h3>
<h4 id="3171">31.7.1 架构对比<a class="headerlink" href="#3171" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Calico L3 模式&quot;
        CP1[&quot;Pod 1&quot;] --&gt; CR[&quot;Host (Router)&quot;]
        CR --&gt; CP2[&quot;Pod 2&quot;]
        Note1[&quot;无广播&lt;br/&gt;路由转发&quot;]
    end

    subgraph &quot;Flannel Bridge 模式&quot;
        FP1[&quot;Pod 1&quot;] --&gt; FB[&quot;Linux Bridge&quot;]
        FB --&gt; FP2[&quot;Pod 2&quot;]
        Note2[&quot;有广播&lt;br/&gt;交换转发&quot;]
    end
</code></pre></div>
<h4 id="3172">31.7.2 特性对比<a class="headerlink" href="#3172" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Calico</th>
<th style="text-align: left;">Flannel</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>转发层级</strong></td>
<td style="text-align: left;">L3（路由）</td>
<td style="text-align: left;">L2（交换）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>广播域</strong></td>
<td style="text-align: left;">隔离（每 Pod 独立）</td>
<td style="text-align: left;">共享（同节点共享）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ARP 广播</strong></td>
<td style="text-align: left;">无（Proxy ARP）</td>
<td style="text-align: left;">有</td>
</tr>
<tr>
<td style="text-align: left;"><strong>效率</strong></td>
<td style="text-align: left;">高（无广播开销）</td>
<td style="text-align: left;">较低</td>
</tr>
<tr>
<td style="text-align: left;"><strong>隔离性</strong></td>
<td style="text-align: left;">强</td>
<td style="text-align: left;">弱</td>
</tr>
</tbody>
</table>
<h3 id="318">31.8 抓包验证<a class="headerlink" href="#318" title="Permanent link">&para;</a></h3>
<h4 id="3181-pod">31.8.1 在 Pod 内抓包<a class="headerlink" href="#3181-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 进入 Pod</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>pod1<span class="w"> </span>--<span class="w"> </span>sh

<span class="c1"># 安装 tcpdump（如果没有）</span>
apk<span class="w"> </span>add<span class="w"> </span>tcpdump

<span class="c1"># 抓取 ICMP 包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>icmp<span class="w"> </span>-n
</code></pre></div>
<h4 id="3182-host">31.8.2 在 Host 抓包<a class="headerlink" href="#3182-host" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 找到对应的 cali 网卡</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>cali

<span class="c1"># 抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>cali-xxx<span class="w"> </span>-n<span class="w"> </span>icmp
</code></pre></div>
<h4 id="3183-mac">31.8.3 验证 MAC 地址<a class="headerlink" href="#3183-mac" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Ping 测试后查看 ARP 缓存</span>
ip<span class="w"> </span>neigh

<span class="c1"># 示例输出</span>
<span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>lladdr<span class="w"> </span>ee:ee:ee:ee:ee:ee<span class="w"> </span>REACHABLE
</code></pre></div>
<h3 id="319">31.9 章节小结<a class="headerlink" href="#319" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((同节点通信))
    网络拓扑
      veth pair
      cali 网卡
      /32 掩码
    路由转发
      Pod 路由表
      Host 路由表
      L3 处理
    Proxy ARP
      169.254.1.1
      全 1 MAC
      代理响应
    设计优势
      无广播
      效率高
      隔离性强
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>网络拓扑</strong>：</li>
<li>Pod eth0 ↔ Host cali 网卡（veth pair）</li>
<li>Pod IP 使用 /32 掩码</li>
<li>
<p>强制所有流量走 L3</p>
</li>
<li>
<p><strong>路由转发</strong>：</p>
</li>
<li>Pod 默认路由指向 169.254.1.1</li>
<li>Host 路由表有到每个 Pod 的明细路由</li>
<li>
<p>出接口就是对应的 cali 网卡</p>
</li>
<li>
<p><strong>Proxy ARP</strong>：</p>
</li>
<li>cali 网卡开启 proxy_arp</li>
<li>代替 169.254.1.1 响应 ARP</li>
<li>
<p>返回自己的 MAC（全 1）</p>
</li>
<li>
<p><strong>全 1 MAC</strong>：</p>
</li>
<li>所有 cali 网卡使用相同 MAC</li>
<li>点对点链路，本地有效</li>
<li>
<p>不与厂商 OUI 冲突</p>
</li>
<li>
<p><strong>与 Flannel 对比</strong>：</p>
</li>
<li>Calico: L3 路由，无广播</li>
<li>
<p>Flannel: L2 交换，有广播</p>
</li>
<li>
<p><strong>排查技巧</strong>：</p>
</li>
<li>不懂就查路由表 <code>ip route</code></li>
<li>确认 ARP 缓存 <code>ip neigh</code></li>
<li>抓包验证 <code>tcpdump</code></li>
</ol>
</blockquote>
<hr />
<h2 id="calico-proxy-arp">第三十二章 Calico-Proxy-ARP 实践<a class="headerlink" href="#calico-proxy-arp" title="Permanent link">&para;</a></h2>
<p>本章通过手工实现 Proxy ARP 来深入理解 Calico 同节点通信的核心机制。通过实践，你将掌握 veth pair、路由配置、Proxy ARP 开关等关键技术点。</p>
<h3 id="321">32.1 背景与目标<a class="headerlink" href="#321" title="Permanent link">&para;</a></h3>
<h4 id="3211">32.1.1 实验目标<a class="headerlink" href="#3211" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Namespace (ns1)&quot;
        Pod[&quot;1.1.1.2/24&quot;]
    end

    subgraph &quot;Root Namespace&quot;
        Host[&quot;Host&quot;]
    end

    subgraph &quot;External&quot;
        Internet[&quot;外网&quot;]
    end

    Pod --&gt;|&quot;1. Proxy ARP&quot;| Host
    Host --&gt;|&quot;2. 路由转发&quot;| Internet
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">目标</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>理解 Proxy ARP</strong></td>
<td style="text-align: left;">手工实现虚拟网关 169.254.1.1</td>
</tr>
<tr>
<td style="text-align: left;"><strong>掌握路由配置</strong></td>
<td style="text-align: left;">先配网关路由，再配默认路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>解决回程问题</strong></td>
<td style="text-align: left;">添加回程路由确保双向通信</td>
</tr>
<tr>
<td style="text-align: left;"><strong>外网访问</strong></td>
<td style="text-align: left;">通过 SNAT 实现出公网</td>
</tr>
</tbody>
</table>
<h4 id="3212">32.1.2 实验拓扑<a class="headerlink" href="#3212" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Namespace: ns1&quot;
        NS1[&quot;c-eth0&lt;br/&gt;1.1.1.2/24&quot;]
    end

    subgraph &quot;Root Namespace&quot;
        Veth[&quot;veth&quot;]
        Route[&quot;路由表&quot;]
        SNAT[&quot;SNAT&quot;]
    end

    subgraph &quot;External&quot;
        GW[&quot;网关&quot;]
        Ext[&quot;外网 114.114.114.114&quot;]
    end

    NS1 ---|&quot;veth pair&quot;| Veth
    Veth --&gt; Route
    Route --&gt; SNAT
    SNAT --&gt; GW
    GW --&gt; Ext
</code></pre></div>
<h3 id="322-calico-proxy-arp">32.2 查看 Calico Proxy ARP 配置<a class="headerlink" href="#322-calico-proxy-arp" title="Permanent link">&para;</a></h3>
<h4 id="3221-proxy-arp">32.2.1 Proxy ARP 开关位置<a class="headerlink" href="#3221-proxy-arp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 cali 网卡的 proxy_arp 状态</span>
cat<span class="w"> </span>/proc/sys/net/ipv4/conf/cali*/proxy_arp
<span class="c1"># 输出: 1  (已启用)</span>

<span class="c1"># 查看 eth0 的 proxy_arp 状态</span>
cat<span class="w"> </span>/proc/sys/net/ipv4/conf/eth0/proxy_arp
<span class="c1"># 输出: 0  (未启用)</span>
</code></pre></div>
<blockquote>
<p>[!NOTE]
Proxy ARP 是针对<strong>单个网卡</strong>的配置：</p>
<ul>
<li><code>cali*</code> 网卡开启了 proxy_arp（值为 1）</li>
<li><code>eth0</code> 等其他网卡默认关闭</li>
</ul>
</blockquote>
<h4 id="3222">32.2.2 开关含义<a class="headerlink" href="#3222" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">值</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>0</code></td>
<td style="text-align: left;">禁用 Proxy ARP</td>
</tr>
<tr>
<td style="text-align: left;"><code>1</code></td>
<td style="text-align: left;">启用 Proxy ARP</td>
</tr>
</tbody>
</table>
<h3 id="323-proxy-arp">32.3 手工实现 Proxy ARP<a class="headerlink" href="#323-proxy-arp" title="Permanent link">&para;</a></h3>
<h4 id="3231">32.3.1 第一步：创建网络命名空间<a class="headerlink" href="#3231" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建命名空间 ns1</span>
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>ns1

<span class="c1"># 验证</span>
ip<span class="w"> </span>netns<span class="w"> </span>list
</code></pre></div>
<h4 id="3232-veth-pair">32.3.2 第二步：创建 veth pair<a class="headerlink" href="#3232-veth-pair" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建 veth pair</span>
<span class="c1"># 一端: veth (留在 root namespace)</span>
<span class="c1"># 另一端: c-eth0 (放入 ns1)</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>veth<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>c-eth0

<span class="c1"># 启用两端网卡</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>c-eth0<span class="w"> </span>up
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth<span class="w"> </span>up

<span class="c1"># 将 c-eth0 移入 ns1</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>c-eth0<span class="w"> </span>netns<span class="w"> </span>ns1

<span class="c1"># 在 ns1 中启用并配置 IP</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>c-eth0<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.2/24<span class="w"> </span>dev<span class="w"> </span>c-eth0
</code></pre></div>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Root as Root Namespace
    participant NS1 as ns1 Namespace

    Root-&gt;&gt;Root: 创建 veth pair (veth + c-eth0)
    Root-&gt;&gt;NS1: 移动 c-eth0 到 ns1
    Root-&gt;&gt;Root: 启用 veth
    NS1-&gt;&gt;NS1: 启用 c-eth0
    NS1-&gt;&gt;NS1: 配置 IP 1.1.1.2/24
</code></pre></div>
<h4 id="3233">32.3.3 第三步：配置路由（关键！）<a class="headerlink" href="#3233" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!IMPORTANT]
<strong>路由配置顺序非常重要</strong>：必须先配置到网关的路由，再配置默认路由！</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># 进入 ns1</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>bash

<span class="c1"># 第一步：配置到网关 169.254.1.1 的路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>c-eth0<span class="w"> </span>scope<span class="w"> </span>link

<span class="c1"># 第二步：配置默认路由，指向网关</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>c-eth0

<span class="c1"># 查看路由表</span>
ip<span class="w"> </span>route
<span class="c1"># default via 169.254.1.1 dev c-eth0</span>
<span class="c1"># 169.254.1.1 dev c-eth0 scope link</span>
</code></pre></div>
<p><strong>为什么必须先配置网关路由？</strong></p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;正确顺序&quot;
        A1[&quot;1. 配置 169.254.1.1 路由&quot;] --&gt; B1[&quot;系统知道如何到达网关&quot;]
        B1 --&gt; C1[&quot;2. 配置 default via 169.254.1.1&quot;]
        C1 --&gt; D1[&quot;成功！&quot;]
    end

    subgraph &quot;错误顺序&quot;
        A2[&quot;1. 直接配置 default via 169.254.1.1&quot;] --&gt; B2[&quot;系统不知道如何到达网关&quot;]
        B2 --&gt; C2[&quot;报错！&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">错误示例</th>
<th style="text-align: left;">原因</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>ip route add default via 169.254.1.1</code></td>
<td style="text-align: left;">系统不知道 169.254.1.1 怎么走</td>
</tr>
</tbody>
</table>
<h4 id="3234-proxy-arp">32.3.4 第四步：启用 Proxy ARP<a class="headerlink" href="#3234-proxy-arp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 root namespace 中对 veth 启用 proxy_arp</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/net/ipv4/conf/veth/proxy_arp

<span class="c1"># 验证</span>
cat<span class="w"> </span>/proc/sys/net/ipv4/conf/veth/proxy_arp
<span class="c1"># 输出: 1</span>
</code></pre></div>
<h4 id="3235-arp">32.3.5 第五步：验证 ARP 响应<a class="headerlink" href="#3235-arp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 ns1 中测试 ARP</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>arping<span class="w"> </span>-I<span class="w"> </span>c-eth0<span class="w"> </span><span class="m">169</span>.254.1.1

<span class="c1"># 输出示例</span>
<span class="c1"># ARPING 169.254.1.1 from 1.1.1.2 c-eth0</span>
<span class="c1"># Unicast reply from 169.254.1.1 [9B:12:0C:xx:xx:xx] ...</span>
</code></pre></div>
<p>至此，第一跳（Pod → Host）已经打通！</p>
<h3 id="324">32.4 解决回程路由问题<a class="headerlink" href="#324" title="Permanent link">&para;</a></h3>
<h4 id="3241">32.4.1 问题现象<a class="headerlink" href="#3241" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 ns1 中 ping Host 地址</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ping<span class="w"> </span>-I<span class="w"> </span><span class="m">1</span>.1.1.2<span class="w"> </span><span class="m">192</span>.168.2.66

<span class="c1"># 结果：不通！</span>
</code></pre></div>
<h4 id="3242">32.4.2 抓包分析<a class="headerlink" href="#3242" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 veth 上抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>veth<span class="w"> </span>icmp<span class="w"> </span>-n

<span class="c1"># 输出</span>
<span class="c1"># ICMP echo request 1.1.1.2 -&gt; 192.168.2.66</span>
<span class="c1"># (无 reply)</span>

<span class="c1"># 在 eth0 上抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>icmp<span class="w"> </span>-n

<span class="c1"># 输出</span>
<span class="c1"># ICMP echo request 1.1.1.2 -&gt; 192.168.2.66</span>
<span class="c1"># ICMP echo reply 192.168.2.66 -&gt; 1.1.1.2  (发往默认网关！)</span>
</code></pre></div>
<h4 id="3243">32.4.3 问题原因<a class="headerlink" href="#3243" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    NS1[&quot;ns1&lt;br/&gt;1.1.1.2&quot;] --&gt;|&quot;request&quot;| Host[&quot;Host&lt;br/&gt;192.168.2.66&quot;]
    Host --&gt;|&quot;reply&quot;| GW[&quot;默认网关&quot;]
    GW --&gt;|&quot;???&quot;| Lost[&quot;包丢失&quot;]
</code></pre></div>
<p><strong>原因</strong>：Host 收到包后，要回复给 <code>1.1.1.2</code>，但 Host 路由表没有到 <code>1.1.1.2</code> 的路由，匹配默认路由发给了外部网关。</p>
<h4 id="3244">32.4.4 解决方案：添加回程路由<a class="headerlink" href="#3244" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 root namespace 添加到 1.1.1.2 的路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.2<span class="w"> </span>dev<span class="w"> </span>veth<span class="w"> </span>scope<span class="w"> </span>link

<span class="c1"># 或添加整个网段</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span>dev<span class="w"> </span>veth<span class="w"> </span>scope<span class="w"> </span>link

<span class="c1"># 验证路由表</span>
ip<span class="w"> </span>route<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">1</span>.1.1
<span class="c1"># 1.1.1.2 dev veth scope link</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># 再次测试</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ping<span class="w"> </span>-I<span class="w"> </span><span class="m">1</span>.1.1.2<span class="w"> </span><span class="m">192</span>.168.2.66

<span class="c1"># 结果：通了！</span>
</code></pre></div>
<h3 id="325">32.5 实现外网访问<a class="headerlink" href="#325" title="Permanent link">&para;</a></h3>
<h4 id="3251">32.5.1 问题：无法访问外网<a class="headerlink" href="#3251" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ping<span class="w"> </span><span class="m">114</span>.114.114.114
<span class="c1"># 不通</span>
</code></pre></div>
<p><strong>原因</strong>：缺少 SNAT，外部网络不知道如何回复私有 IP <code>1.1.1.2</code></p>
<h4 id="3252-snat">32.5.2 解决方案：配置 SNAT<a class="headerlink" href="#3252-snat" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 启用 IP 转发</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/net/ipv4/ip_forward

<span class="c1"># 添加 SNAT 规则</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span>-j<span class="w"> </span>MASQUERADE

<span class="c1"># 或指定出接口</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span>-o<span class="w"> </span>eth0<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># 测试外网访问</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ping<span class="w"> </span><span class="m">114</span>.114.114.114
<span class="c1"># 通了！</span>
</code></pre></div>
<h3 id="326">32.6 完整实现脚本<a class="headerlink" href="#326" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># proxy-arp-demo.sh - 手工实现 Proxy ARP</span>

<span class="c1"># 1. 创建命名空间</span>
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>ns1

<span class="c1"># 2. 创建 veth pair</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>veth<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>c-eth0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth<span class="w"> </span>up
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>c-eth0<span class="w"> </span>netns<span class="w"> </span>ns1
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>c-eth0<span class="w"> </span>up
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.2/24<span class="w"> </span>dev<span class="w"> </span>c-eth0

<span class="c1"># 3. 配置路由（顺序重要！）</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>c-eth0<span class="w"> </span>scope<span class="w"> </span>link
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ns1<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>c-eth0

<span class="c1"># 4. 启用 Proxy ARP</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/net/ipv4/conf/veth/proxy_arp

<span class="c1"># 5. 添加回程路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.2<span class="w"> </span>dev<span class="w"> </span>veth<span class="w"> </span>scope<span class="w"> </span>link

<span class="c1"># 6. 启用 IP 转发和 SNAT（如需外网访问）</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/net/ipv4/ip_forward
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span>-j<span class="w"> </span>MASQUERADE

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Proxy ARP 配置完成！&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;测试：ip netns exec ns1 ping 114.114.114.114&quot;</span>
</code></pre></div>
<h3 id="327-calico">32.7 与 Calico 实现对比<a class="headerlink" href="#327-calico" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;手工实现&quot;
        M1[&quot;创建 veth pair&quot;] --&gt; M2[&quot;配置路由&quot;]
        M2 --&gt; M3[&quot;启用 proxy_arp&quot;]
        M3 --&gt; M4[&quot;添加回程路由&quot;]
        M4 --&gt; M5[&quot;配置 SNAT&quot;]
    end

    subgraph &quot;Calico 自动实现&quot;
        C1[&quot;CNI 创建 cali* 网卡&quot;] --&gt; C2[&quot;注入 Pod 路由&quot;]
        C2 --&gt; C3[&quot;Felix 启用 proxy_arp&quot;]
        C3 --&gt; C4[&quot;自动维护路由表&quot;]
        C4 --&gt; C5[&quot;iptables 规则&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">步骤</th>
<th style="text-align: left;">手工实现</th>
<th style="text-align: left;">Calico 实现</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>创建 veth</strong></td>
<td style="text-align: left;"><code>ip link add</code></td>
<td style="text-align: left;">CNI 插件自动创建</td>
</tr>
<tr>
<td style="text-align: left;"><strong>配置路由</strong></td>
<td style="text-align: left;"><code>ip route add</code></td>
<td style="text-align: left;">Felix 自动注入</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Proxy ARP</strong></td>
<td style="text-align: left;">写 <code>/proc/sys</code></td>
<td style="text-align: left;">Felix 自动配置</td>
</tr>
<tr>
<td style="text-align: left;"><strong>回程路由</strong></td>
<td style="text-align: left;">手动添加</td>
<td style="text-align: left;">Felix 监听并维护</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SNAT</strong></td>
<td style="text-align: left;">iptables 规则</td>
<td style="text-align: left;">Felix 管理 iptables</td>
</tr>
</tbody>
</table>
<h3 id="328">32.8 扩展：东西向流量<a class="headerlink" href="#328" title="Permanent link">&para;</a></h3>
<h4 id="3281">32.8.1 实验思路<a class="headerlink" href="#3281" title="Permanent link">&para;</a></h4>
<p>要实现两个节点上的命名空间互通（东西向流量）：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Node 1&quot;
        NS1[&quot;ns1&lt;br/&gt;1.1.1.2/24&quot;]
    end

    subgraph &quot;Node 2&quot;
        NS2[&quot;ns1&lt;br/&gt;1.1.2.2/24&quot;]
    end

    NS1 &lt;--&gt;|&quot;跨节点通信&quot;| NS2
</code></pre></div>
<p><strong>需要添加的配置</strong>：</p>
<ol>
<li><strong>Node 1</strong>：添加到 <code>1.1.2.0/24</code> 的路由，下一跳为 Node 2</li>
<li><strong>Node 2</strong>：添加到 <code>1.1.1.0/24</code> 的路由，下一跳为 Node 1</li>
<li>两边都配置 Proxy ARP</li>
</ol>
<blockquote>
<p>[!TIP]
这就是 Calico Host-GW 模式的原理！通过路由表实现跨节点通信。</p>
</blockquote>
<h3 id="329">32.9 关键技术总结<a class="headerlink" href="#329" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">技术</th>
<th style="text-align: left;">作用</th>
<th style="text-align: left;">命令</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>veth pair</strong></td>
<td style="text-align: left;">连接命名空间</td>
<td style="text-align: left;"><code>ip link add type veth peer</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>网关路由</strong></td>
<td style="text-align: left;">定义如何到达网关</td>
<td style="text-align: left;"><code>ip route add 169.254.1.1 dev xxx scope link</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>默认路由</strong></td>
<td style="text-align: left;">定义默认出口</td>
<td style="text-align: left;"><code>ip route add default via 169.254.1.1</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Proxy ARP</strong></td>
<td style="text-align: left;">代理 ARP 响应</td>
<td style="text-align: left;"><code>echo 1 &gt; /proc/sys/.../proxy_arp</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>回程路由</strong></td>
<td style="text-align: left;">解决回包问题</td>
<td style="text-align: left;"><code>ip route add x.x.x.x dev xxx</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>SNAT</strong></td>
<td style="text-align: left;">外网访问</td>
<td style="text-align: left;"><code>iptables -t nat -A POSTROUTING -j MASQUERADE</code></td>
</tr>
</tbody>
</table>
<h3 id="3210">32.10 章节小结<a class="headerlink" href="#3210" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Proxy ARP 实践))
    基础配置
      创建 netns
      创建 veth pair
      配置 IP
    路由配置
      先配网关路由
      再配默认路由
      添加回程路由
    Proxy ARP
      /proc/sys 开关
      针对单个网卡
      返回自己 MAC
    外网访问
      IP 转发
      SNAT/MASQUERADE
    扩展
      东西向流量
      Host-GW 原理
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>Proxy ARP 开关</strong>：</li>
<li>位置：<code>/proc/sys/net/ipv4/conf/&lt;iface&gt;/proxy_arp</code></li>
<li>值 1 启用，值 0 禁用</li>
<li>
<p>针对单个网卡配置</p>
</li>
<li>
<p><strong>路由配置顺序</strong>：</p>
</li>
<li><strong>必须先配置网关路由</strong>：<code>ip route add 169.254.1.1 dev xxx scope link</code></li>
<li><strong>再配置默认路由</strong>：<code>ip route add default via 169.254.1.1</code></li>
<li>
<p>顺序错误会报错！</p>
</li>
<li>
<p><strong>回程路由</strong>：</p>
</li>
<li>Host 需要知道如何回到 Pod</li>
<li>否则包会走默认路由发到外部网关</li>
<li>
<p>解决：添加到 Pod IP 的明细路由</p>
</li>
<li>
<p><strong>外网访问四要素</strong>：</p>
</li>
<li>veth pair 连接</li>
<li>Proxy ARP 响应</li>
<li>路由表配置</li>
<li>
<p>SNAT 地址转换</p>
</li>
<li>
<p><strong>与 Calico 对比</strong>：</p>
</li>
<li>手工实现帮助理解原理</li>
<li>Calico 通过 Felix 自动化这些配置</li>
<li>核心技术完全相同</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-ipip">第三十三章 Calico-IPIP 跨节点通信<a class="headerlink" href="#calico-ipip" title="Permanent link">&para;</a></h2>
<p>本章详细讲解 Calico 在 IPIP 模式下如何实现跨节点 Pod 通信。IPIP 是一种 IP-in-IP 的 Overlay 封装技术，通过在原始 IP 包外再封装一层 IP 头来实现隧道传输。</p>
<h3 id="331">33.1 背景与概述<a class="headerlink" href="#331" title="Permanent link">&para;</a></h3>
<h4 id="3311-ipip">33.1.1 为什么需要 IPIP<a class="headerlink" href="#3311-ipip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Node 1 (172.18.0.4)&quot;
        Pod1[&quot;Pod A&lt;br/&gt;10.24.197.x&quot;]
    end

    subgraph &quot;Node 2 (172.18.0.2)&quot;
        Pod2[&quot;Pod B&lt;br/&gt;10.24.79.x&quot;]
    end

    Pod1 --&gt;|&quot;跨节点通信&quot;| Pod2
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>同节点</strong></td>
<td style="text-align: left;">L3 路由 + Proxy ARP</td>
<td style="text-align: left;">直接转发</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨节点</strong></td>
<td style="text-align: left;">节点间网络不认识 Pod IP</td>
<td style="text-align: left;">IPIP 隧道封装</td>
</tr>
</tbody>
</table>
<h4 id="3312-ipip">33.1.2 IPIP 模式特点<a class="headerlink" href="#3312-ipip" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>封装方式</strong></td>
<td style="text-align: left;">IP-in-IP（协议号 4）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>额外开销</strong></td>
<td style="text-align: left;">20 字节（外层 IP 头）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>二层信息</strong></td>
<td style="text-align: left;">无（只有 IP 头）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>隧道设备</strong></td>
<td style="text-align: left;"><code>tunl0</code></td>
</tr>
</tbody>
</table>
<h3 id="332">33.2 跨节点通信流程<a class="headerlink" href="#332" title="Permanent link">&para;</a></h3>
<h4 id="3321">33.2.1 整体数据流<a class="headerlink" href="#3321" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A (10.24.197.x)
    participant Node1 as Node 1 (172.18.0.4)
    participant tunl0_1 as tunl0
    participant Network as 物理网络
    participant tunl0_2 as tunl0
    participant Node2 as Node 2 (172.18.0.2)
    participant PodB as Pod B (10.24.79.x)

    PodA-&gt;&gt;Node1: 1. 原始包发送
    Note over PodA,Node1: SRC: 10.24.197.x&lt;br/&gt;DST: 10.24.79.x
    Node1-&gt;&gt;tunl0_1: 2. 查路由表匹配 tunl0
    tunl0_1-&gt;&gt;Network: 3. IPIP 封装
    Note over tunl0_1,Network: 外层: 172.18.0.4 -&gt; 172.18.0.2&lt;br/&gt;内层: 10.24.197.x -&gt; 10.24.79.x
    Network-&gt;&gt;tunl0_2: 4. 物理网络传输
    tunl0_2-&gt;&gt;Node2: 5. IPIP 解封装
    Node2-&gt;&gt;PodB: 6. 原始包送达
</code></pre></div>
<h4 id="3322">33.2.2 详细步骤<a class="headerlink" href="#3322" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">步骤</th>
<th style="text-align: left;">位置</th>
<th style="text-align: left;">动作</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1</td>
<td style="text-align: left;">Pod A</td>
<td style="text-align: left;">发送 ICMP 包，DST 为 Pod B IP</td>
</tr>
<tr>
<td style="text-align: left;">2</td>
<td style="text-align: left;">Node 1 路由表</td>
<td style="text-align: left;">匹配到 Pod B 网段，下一跳 172.18.0.2，出接口 tunl0</td>
</tr>
<tr>
<td style="text-align: left;">3</td>
<td style="text-align: left;">tunl0 设备</td>
<td style="text-align: left;">IPIP 封装，外层 IP: 172.18.0.4 → 172.18.0.2</td>
</tr>
<tr>
<td style="text-align: left;">4</td>
<td style="text-align: left;">eth0</td>
<td style="text-align: left;">二层封装 MAC，发送到物理网络</td>
</tr>
<tr>
<td style="text-align: left;">5</td>
<td style="text-align: left;">Node 2 eth0</td>
<td style="text-align: left;">接收 IPIP 包</td>
</tr>
<tr>
<td style="text-align: left;">6</td>
<td style="text-align: left;">Node 2 tunl0</td>
<td style="text-align: left;">解封装，露出原始包</td>
</tr>
<tr>
<td style="text-align: left;">7</td>
<td style="text-align: left;">Node 2 路由表</td>
<td style="text-align: left;">匹配 Pod B 的 /32 路由，转发到 cali 网卡</td>
</tr>
<tr>
<td style="text-align: left;">8</td>
<td style="text-align: left;">Pod B</td>
<td style="text-align: left;">收到原始包</td>
</tr>
</tbody>
</table>
<h3 id="333">33.3 路由表分析<a class="headerlink" href="#333" title="Permanent link">&para;</a></h3>
<h4 id="3331-node-1">33.3.1 Node 1 路由表<a class="headerlink" href="#3331-node-1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Node 1 路由表</span>
ip<span class="w"> </span>route

<span class="c1"># 输出示例</span>
<span class="m">10</span>.24.79.0/26<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.2<span class="w"> </span>dev<span class="w"> </span>tunl0<span class="w"> </span>proto<span class="w"> </span>bird<span class="w"> </span>onlink
<span class="m">10</span>.24.197.0/26<span class="w"> </span>dev<span class="w"> </span>cali-xxx<span class="w"> </span>scope<span class="w"> </span>link
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">路由条目</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>10.24.79.0/26 via 172.18.0.2 dev tunl0</code></td>
<td style="text-align: left;">到 Node 2 Pod 网段，下一跳 172.18.0.2，出接口 tunl0</td>
</tr>
<tr>
<td style="text-align: left;"><code>proto bird</code></td>
<td style="text-align: left;">由 BIRD 协议注入</td>
</tr>
<tr>
<td style="text-align: left;"><code>onlink</code></td>
<td style="text-align: left;">下一跳在链路上（不需 ARP）</td>
</tr>
</tbody>
</table>
<h4 id="3332">33.3.2 路由匹配流程<a class="headerlink" href="#3332" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    Start[&quot;Pod A 发包&lt;br/&gt;DST: 10.24.79.1&quot;] --&gt; Route[&quot;查路由表&quot;]
    Route --&gt; Match[&quot;匹配 10.24.79.0/26&quot;]
    Match --&gt; Gateway[&quot;下一跳: 172.18.0.2&quot;]
    Gateway --&gt; Dev[&quot;出接口: tunl0&quot;]
    Dev --&gt; IPIP[&quot;IPIP 封装&quot;]
</code></pre></div>
<h3 id="334-tunl0">33.4 tunl0 设备详解<a class="headerlink" href="#334-tunl0" title="Permanent link">&para;</a></h3>
<h4 id="3341-tunl0">33.4.1 查看 tunl0 设备<a class="headerlink" href="#3341-tunl0" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>tunl0

<span class="c1"># 输出示例</span>
tunl0@NONE:<span class="w"> </span>&lt;NOARP,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1480</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UNKNOWN
<span class="w">    </span>link/ipip<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span>brd<span class="w"> </span><span class="m">0</span>.0.0.0
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">属性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>NOARP</code></td>
<td style="text-align: left;">不处理 ARP（三层设备）</td>
</tr>
<tr>
<td style="text-align: left;"><code>link/ipip</code></td>
<td style="text-align: left;">IPIP 类型隧道</td>
</tr>
<tr>
<td style="text-align: left;"><code>mtu 1480</code></td>
<td style="text-align: left;">MTU = 1500 - 20（IPIP 头）</td>
</tr>
</tbody>
</table>
<h4 id="3342-tunl0">33.4.2 tunl0 配置<a class="headerlink" href="#3342-tunl0" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>tunl0

<span class="c1"># 输出示例</span>
tunl0@NONE:<span class="w"> </span>...
<span class="w">    </span>ipip<span class="w"> </span>remote<span class="w"> </span>any<span class="w"> </span><span class="nb">local</span><span class="w"> </span>any<span class="w"> </span>ttl<span class="w"> </span>inherit<span class="w"> </span>nopmtudisc
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>remote any</code></td>
<td style="text-align: left;">远端 IP 不固定（动态）</td>
</tr>
<tr>
<td style="text-align: left;"><code>local any</code></td>
<td style="text-align: left;">本端 IP 不固定（使用默认路由出接口 IP）</td>
</tr>
<tr>
<td style="text-align: left;"><code>ttl inherit</code></td>
<td style="text-align: left;">TTL 继承自原始包</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
当 <code>local</code> 和 <code>remote</code> 为 <code>any</code> 时，实际使用的 IP 由路由表决定：</p>
<ul>
<li><strong>local</strong>: 默认路由对应的接口 IP（如 eth0 的 IP）</li>
<li><strong>remote</strong>: 路由条目中指定的下一跳 IP</li>
</ul>
</blockquote>
<h3 id="335-ipip">33.5 IPIP 封装原理<a class="headerlink" href="#335-ipip" title="Permanent link">&para;</a></h3>
<h4 id="3351-ip-in-ip">33.5.1 IP-in-IP 结构<a class="headerlink" href="#3351-ip-in-ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;IPIP 封装后&quot;
        subgraph &quot;外层 IP 头&quot;
            OuterIP[&quot;SRC: 172.18.0.4&lt;br/&gt;DST: 172.18.0.2&lt;br/&gt;Protocol: 4 (IPIP)&quot;]
        end
        subgraph &quot;内层 IP 头&quot;
            InnerIP[&quot;SRC: 10.24.197.x&lt;br/&gt;DST: 10.24.79.x&lt;br/&gt;Protocol: ICMP&quot;]
        end
        subgraph &quot;Payload&quot;
            Data[&quot;ICMP 数据&quot;]
        end
    end

    OuterIP --&gt; InnerIP --&gt; Data
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">外层 IP</th>
<th style="text-align: left;">内层 IP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Source IP</strong></td>
<td style="text-align: left;">172.18.0.4（Node 1）</td>
<td style="text-align: left;">10.24.197.x（Pod A）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Dest IP</strong></td>
<td style="text-align: left;">172.18.0.2（Node 2）</td>
<td style="text-align: left;">10.24.79.x（Pod B）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Protocol</strong></td>
<td style="text-align: left;">4（IPIP）</td>
<td style="text-align: left;">1（ICMP）等</td>
</tr>
</tbody>
</table>
<h4 id="3352">33.5.2 协议号<a class="headerlink" href="#3352" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">协议号</th>
<th style="text-align: left;">协议名</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1</td>
<td style="text-align: left;">ICMP</td>
</tr>
<tr>
<td style="text-align: left;">4</td>
<td style="text-align: left;">IPIP</td>
</tr>
<tr>
<td style="text-align: left;">6</td>
<td style="text-align: left;">TCP</td>
</tr>
<tr>
<td style="text-align: left;">17</td>
<td style="text-align: left;">UDP</td>
</tr>
</tbody>
</table>
<h3 id="336">33.6 抓包验证<a class="headerlink" href="#336" title="Permanent link">&para;</a></h3>
<h4 id="3361-tunl0">33.6.1 在 tunl0 上抓包<a class="headerlink" href="#3361-tunl0" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 tunl0 上抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>tunl0<span class="w"> </span>-nn<span class="w"> </span>-e

<span class="c1"># 输出示例</span>
IP<span class="w"> </span><span class="m">10</span>.24.197.x<span class="w"> </span>&gt;<span class="w"> </span><span class="m">10</span>.24.79.x:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request
</code></pre></div>
<blockquote>
<p>[!NOTE]
在 tunl0 上抓包显示的是 <strong>Raw IP</strong>（裸 IP），没有 MAC 地址。
这是因为 tunl0 是三层设备，不处理二层信息。</p>
</blockquote>
<h4 id="3362-eth0">33.6.2 在 eth0 上抓包<a class="headerlink" href="#3362-eth0" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 过滤 IPIP 协议</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span><span class="s1">&#39;ip proto 4&#39;</span>

<span class="c1"># 输出示例</span>
IP<span class="w"> </span><span class="m">172</span>.18.0.4<span class="w"> </span>&gt;<span class="w"> </span><span class="m">172</span>.18.0.2:<span class="w"> </span>IP<span class="w"> </span><span class="m">10</span>.24.197.x<span class="w"> </span>&gt;<span class="w"> </span><span class="m">10</span>.24.79.x:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request
</code></pre></div>
<p><strong>抓包结果说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">层次</th>
<th style="text-align: left;">源地址</th>
<th style="text-align: left;">目的地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>外层 IP</strong></td>
<td style="text-align: left;">172.18.0.4（Node 1）</td>
<td style="text-align: left;">172.18.0.2（Node 2）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>内层 IP</strong></td>
<td style="text-align: left;">10.24.197.x（Pod A）</td>
<td style="text-align: left;">10.24.79.x（Pod B）</td>
</tr>
</tbody>
</table>
<h4 id="3363-wireshark">33.6.3 Wireshark 分析<a class="headerlink" href="#3363-wireshark" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 导出抓包文件</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span><span class="s1">&#39;ip proto 4&#39;</span><span class="w"> </span>-w<span class="w"> </span>ipip.pcap
</code></pre></div>
<p>在 Wireshark 中可以看到：</p>
<div class="highlight"><pre><span></span><code>Ethernet II
  ├── IPv4 (外层): 172.18.0.4 -&gt; 172.18.0.2, Protocol: IPIP (4)
  │     └── IPv4 (内层): 10.24.197.x -&gt; 10.24.79.x, Protocol: ICMP
  │           └── ICMP: Echo request
</code></pre></div>
<h3 id="337-ipip-vs-vxlan">33.7 IPIP vs VXLAN<a class="headerlink" href="#337-ipip-vs-vxlan" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;IPIP 封装 (20 字节开销)&quot;
        IPIP_Outer[&quot;外层 IP 头&lt;br/&gt;20 bytes&quot;]
        IPIP_Inner[&quot;内层 IP 头&quot;]
        IPIP_Data[&quot;Payload&quot;]
        IPIP_Outer --&gt; IPIP_Inner --&gt; IPIP_Data
    end

    subgraph &quot;VXLAN 封装 (50 字节开销)&quot;
        VXLAN_Outer[&quot;外层 IP 头&lt;br/&gt;20 bytes&quot;]
        VXLAN_UDP[&quot;UDP 头&lt;br/&gt;8 bytes&quot;]
        VXLAN_Header[&quot;VXLAN 头&lt;br/&gt;8 bytes&quot;]
        VXLAN_Inner[&quot;内层 MAC&lt;br/&gt;14 bytes&quot;]
        VXLAN_InnerIP[&quot;内层 IP 头&quot;]
        VXLAN_Data[&quot;Payload&quot;]
        VXLAN_Outer --&gt; VXLAN_UDP --&gt; VXLAN_Header --&gt; VXLAN_Inner --&gt; VXLAN_InnerIP --&gt; VXLAN_Data
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">IPIP</th>
<th style="text-align: left;">VXLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>额外开销</strong></td>
<td style="text-align: left;">20 字节</td>
<td style="text-align: left;">50 字节</td>
</tr>
<tr>
<td style="text-align: left;"><strong>二层信息</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">有（内层 MAC）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VNI 隔离</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">有</td>
</tr>
<tr>
<td style="text-align: left;"><strong>协议类型</strong></td>
<td style="text-align: left;">IP 协议 4</td>
<td style="text-align: left;">UDP 端口 4789</td>
</tr>
<tr>
<td style="text-align: left;"><strong>适用场景</strong></td>
<td style="text-align: left;">简单隧道</td>
<td style="text-align: left;">多租户隔离</td>
</tr>
</tbody>
</table>
<h3 id="338-ipip">33.8 手工创建 IPIP 设备<a class="headerlink" href="#338-ipip" title="Permanent link">&para;</a></h3>
<h4 id="3381-ipip">33.8.1 创建 IPIP 隧道<a class="headerlink" href="#3381-ipip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Node 1 上创建</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>ipip0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>ipip<span class="w"> </span><span class="nb">local</span><span class="w"> </span><span class="m">172</span>.18.0.4<span class="w"> </span>remote<span class="w"> </span><span class="m">172</span>.18.0.2
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>ipip0<span class="w"> </span>up
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.1/24<span class="w"> </span>dev<span class="w"> </span>ipip0

<span class="c1"># 在 Node 2 上创建</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>ipip0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>ipip<span class="w"> </span><span class="nb">local</span><span class="w"> </span><span class="m">172</span>.18.0.2<span class="w"> </span>remote<span class="w"> </span><span class="m">172</span>.18.0.4
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>ipip0<span class="w"> </span>up
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.2/24<span class="w"> </span>dev<span class="w"> </span>ipip0
</code></pre></div>
<h4 id="3382">33.8.2 验证<a class="headerlink" href="#3382" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看设备</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>ipip0

<span class="c1"># 输出示例</span>
ipip0@NONE:<span class="w"> </span>&lt;NOARP,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1480</span>
<span class="w">    </span>link/ipip<span class="w"> </span><span class="m">172</span>.18.0.4<span class="w"> </span>peer<span class="w"> </span><span class="m">172</span>.18.0.2

<span class="c1"># 测试连通性</span>
ping<span class="w"> </span><span class="m">1</span>.1.1.2
</code></pre></div>
<h4 id="3383-calico-tunl0">33.8.3 与 Calico tunl0 对比<a class="headerlink" href="#3383-calico-tunl0" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">手工创建</th>
<th style="text-align: left;">Calico tunl0</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>local/remote</strong></td>
<td style="text-align: left;">指定固定 IP</td>
<td style="text-align: left;">any（动态）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>路由</strong></td>
<td style="text-align: left;">手动添加</td>
<td style="text-align: left;">BIRD 自动注入</td>
</tr>
<tr>
<td style="text-align: left;"><strong>管理</strong></td>
<td style="text-align: left;">手动</td>
<td style="text-align: left;">Felix 自动</td>
</tr>
</tbody>
</table>
<h3 id="339-kind-mac">33.9 kind 环境 MAC 地址规律<a class="headerlink" href="#339-kind-mac" title="Permanent link">&para;</a></h3>
<blockquote>
<p>[!TIP]
在 kind 创建的集群中，容器的 MAC 地址有规律：</p>
<ul>
<li>格式：<code>02:42:ac:xx:xx:xx</code></li>
<li>最后一位与 IP 地址最后一位相同</li>
<li>例如：IP <code>172.18.0.4</code> 对应 MAC <code>02:42:ac:xx:xx:04</code></li>
</ul>
</blockquote>
<h3 id="3310">33.10 章节小结<a class="headerlink" href="#3310" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((IPIP 跨节点通信))
    路由表
      目标网段匹配
      下一跳为对端节点 IP
      出接口为 tunl0
    tunl0 设备
      NOARP 三层设备
      local/remote any
      MTU 1480
    IPIP 封装
      外层 IP 头 20 字节
      协议号 4
      无二层信息
    抓包验证
      tunl0 显示 Raw IP
      eth0 过滤 ip proto 4
      两层 IP 地址
    对比 VXLAN
      开销更小
      无 VNI 隔离
      无内层 MAC
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>IPIP 封装原理</strong>：</li>
<li>IP-in-IP，在原始 IP 包外再封装一层 IP 头</li>
<li>外层 IP：Node IP（local → remote）</li>
<li>内层 IP：Pod IP（src → dst）</li>
<li>
<p>协议号 4 表示 IPIP</p>
</li>
<li>
<p><strong>tunl0 设备</strong>：</p>
</li>
<li>Calico 自动创建的 IPIP 隧道设备</li>
<li><code>NOARP</code>：三层设备，不处理 ARP</li>
<li><code>local any remote any</code>：动态选择 IP</li>
<li>
<p>MTU 1480（1500 - 20）</p>
</li>
<li>
<p><strong>路由决策</strong>：</p>
</li>
<li>目标 Pod 网段匹配对应路由</li>
<li>下一跳为目标节点 IP</li>
<li>
<p>出接口为 tunl0 触发 IPIP 封装</p>
</li>
<li>
<p><strong>抓包技巧</strong>：</p>
</li>
<li><code>tcpdump -i tunl0</code>：显示 Raw IP</li>
<li><code>tcpdump -i eth0 'ip proto 4'</code>：过滤 IPIP 包</li>
<li>
<p>Wireshark 可看到两层 IP</p>
</li>
<li>
<p><strong>与 VXLAN 对比</strong>：</p>
</li>
<li>IPIP 开销 20 字节 &lt; VXLAN 50 字节</li>
<li>IPIP 无二层信息、无 VNI</li>
<li>IPIP 更简单，VXLAN 支持多租户</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-ipip-crosssubnet">第三十四章 Calico-IPIP CrossSubnet 模式<a class="headerlink" href="#calico-ipip-crosssubnet" title="Permanent link">&para;</a></h2>
<p>本章详细讲解 Calico IPIP 的 CrossSubnet 模式，这是一种智能混合模式：<strong>同网段节点间走纯路由</strong>，<strong>跨网段节点间走 IPIP 封装</strong>，从而在性能和兼容性之间取得平衡。</p>
<h3 id="341">34.1 背景与概述<a class="headerlink" href="#341" title="Permanent link">&para;</a></h3>
<h4 id="3411-crosssubnet">34.1.1 什么是 CrossSubnet<a class="headerlink" href="#3411-crosssubnet" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;子网 1: 10.1.5.0/24&quot;
        Node1[&quot;Node 1&lt;br/&gt;10.1.5.10&quot;]
        Node2[&quot;Node 2&lt;br/&gt;10.1.5.11&quot;]
        SW1[&quot;交换机 br-pro0&quot;]
    end

    subgraph &quot;子网 2: 10.1.8.0/24&quot;
        Node3[&quot;Node 3&lt;br/&gt;10.1.8.10&quot;]
        Node4[&quot;Node 4&lt;br/&gt;10.1.8.11&quot;]
        SW2[&quot;交换机 br-pro1&quot;]
    end

    GW[&quot;网关 Gateway&lt;br/&gt;eth1: 10.1.5.1&lt;br/&gt;eth2: 10.1.8.1&quot;]

    Node1 --- SW1
    Node2 --- SW1
    Node3 --- SW2
    Node4 --- SW2
    SW1 --- GW
    SW2 --- GW

    Node1 -.-&gt;|&quot;同网段: 纯路由&quot;| Node2
    Node1 ==&gt;|&quot;跨网段: IPIP 封装&quot;| Node3
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">通信场景</th>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">性能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>同网段节点</strong></td>
<td style="text-align: left;">纯路由转发</td>
<td style="text-align: left;">高（无封装开销）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨网段节点</strong></td>
<td style="text-align: left;">IPIP 封装</td>
<td style="text-align: left;">中（20 字节开销）</td>
</tr>
</tbody>
</table>
<h4 id="3412-ipipmode">34.1.2 三种 ipipMode 对比<a class="headerlink" href="#3412-ipipmode" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">ipipMode</th>
<th style="text-align: left;">同网段</th>
<th style="text-align: left;">跨网段</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Never</strong></td>
<td style="text-align: left;">路由</td>
<td style="text-align: left;">路由</td>
<td style="text-align: left;">底层网络支持 Pod IP 路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Always</strong></td>
<td style="text-align: left;">IPIP</td>
<td style="text-align: left;">IPIP</td>
<td style="text-align: left;">所有场景都封装</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CrossSubnet</strong></td>
<td style="text-align: left;">路由</td>
<td style="text-align: left;">IPIP</td>
<td style="text-align: left;">混合场景，性能优化</td>
</tr>
</tbody>
</table>
<h3 id="342-crosssubnet">34.2 CrossSubnet 工作原理<a class="headerlink" href="#342-crosssubnet" title="Permanent link">&para;</a></h3>
<h4 id="3421">34.2.1 决策流程<a class="headerlink" href="#3421" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TD
    Start[&quot;Pod A 发送数据包&quot;] --&gt; Check[&quot;检查目标 Pod 所在节点&quot;]
    Check --&gt; Same{&quot;源节点与目标节点&lt;br/&gt;在同一子网？&quot;}
    Same --&gt;|&quot;是&quot;| Route[&quot;纯路由转发&lt;br/&gt;无 Overlay&quot;]
    Same --&gt;|&quot;否&quot;| IPIP[&quot;IPIP 封装&lt;br/&gt;通过 tunl0&quot;]
    Route --&gt; Dest[&quot;目标 Pod&quot;]
    IPIP --&gt; Dest
</code></pre></div>
<h4 id="3422">34.2.2 路由表差异<a class="headerlink" href="#3422" title="Permanent link">&para;</a></h4>
<p><strong>同网段路由条目</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Node 1 (10.1.5.10) 到 Node 2 (10.1.5.11) 的 Pod 网段</span>
<span class="m">10</span>.24.x.x/26<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.5.11<span class="w"> </span>dev<span class="w"> </span>net0
</code></pre></div>
<p><strong>跨网段路由条目</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Node 1 (10.1.5.10) 到 Node 3 (10.1.8.10) 的 Pod 网段</span>
<span class="m">10</span>.24.x.x/26<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.8.10<span class="w"> </span>dev<span class="w"> </span>tunl0<span class="w"> </span>onlink
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">关键差异</th>
<th style="text-align: left;">同网段</th>
<th style="text-align: left;">跨网段</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>出接口</strong></td>
<td style="text-align: left;"><code>net0</code>（物理网卡）</td>
<td style="text-align: left;"><code>tunl0</code>（IPIP 隧道）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>封装</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">IPIP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>下一跳可达性</strong></td>
<td style="text-align: left;">直接可达</td>
<td style="text-align: left;"><code>onlink</code>（不检查）</td>
</tr>
</tbody>
</table>
<h3 id="343-crosssubnet">34.3 配置 CrossSubnet 模式<a class="headerlink" href="#343-crosssubnet" title="Permanent link">&para;</a></h3>
<h4 id="3431-ippool">34.3.1 IPPool 配置<a class="headerlink" href="#3431-ippool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-ipv4-ippool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.24.0.0/16</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CrossSubnet</span><span class="w">    </span><span class="c1"># 关键配置</span>
<span class="w">  </span><span class="nt">vxlanMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">值</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>ipipMode</code></td>
<td style="text-align: left;"><code>CrossSubnet</code></td>
<td style="text-align: left;">跨网段时使用 IPIP</td>
</tr>
<tr>
<td style="text-align: left;"><code>vxlanMode</code></td>
<td style="text-align: left;"><code>Never</code></td>
<td style="text-align: left;">不使用 VXLAN</td>
</tr>
</tbody>
</table>
<h4 id="3432-ippool">34.3.2 修改现有 IPPool<a class="headerlink" href="#3432-ippool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看当前配置</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>ippool<span class="w"> </span>default-ipv4-ippool<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1"># 修改 ipipMode</span>
calicoctl<span class="w"> </span>patch<span class="w"> </span>ippool<span class="w"> </span>default-ipv4-ippool<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;{&quot;spec&quot;:{&quot;ipipMode&quot;:&quot;CrossSubnet&quot;}}&#39;</span>
</code></pre></div>
<h3 id="344-containerlab">34.4 ContainerLab 跨网段拓扑<a class="headerlink" href="#344-containerlab" title="Permanent link">&para;</a></h3>
<h4 id="3441">34.4.1 拓扑架构<a class="headerlink" href="#3441" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Kind 集群&quot;
        subgraph &quot;子网 10.1.5.0/24&quot;
            Control[&quot;control-plane&lt;br/&gt;10.1.5.10&quot;]
            Worker1[&quot;worker&lt;br/&gt;10.1.5.11&quot;]
        end
        subgraph &quot;子网 10.1.8.0/24&quot;
            Worker2[&quot;worker2&lt;br/&gt;10.1.8.10&quot;]
            Worker3[&quot;worker3&lt;br/&gt;10.1.8.11&quot;]
        end
    end

    subgraph &quot;ContainerLab&quot;
        BR0[&quot;br-pro0&lt;br/&gt;Linux Bridge&quot;]
        BR1[&quot;br-pro1&lt;br/&gt;Linux Bridge&quot;]
        GW[&quot;Gateway (VyOS)&lt;br/&gt;eth1: 10.1.5.1&lt;br/&gt;eth2: 10.1.8.1&quot;]
    end

    Control --- BR0
    Worker1 --- BR0
    Worker2 --- BR1
    Worker3 --- BR1
    BR0 --- GW
    BR1 --- GW
</code></pre></div>
<h4 id="3442-kind">34.4.2 Kind 集群配置<a class="headerlink" href="#3442-kind" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cluster</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kind.x-k8s.io/v1alpha4</span>
<span class="nt">nodes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">control-plane</span>
<span class="w">  </span><span class="nt">kubeadmConfigPatches</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">kind: InitConfiguration</span>
<span class="w">    </span><span class="no">nodeRegistration:</span>
<span class="w">      </span><span class="no">kubeletExtraArgs:</span>
<span class="w">        </span><span class="no">node-ip: 10.1.5.10</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="w">  </span><span class="nt">kubeadmConfigPatches</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">kind: JoinConfiguration</span>
<span class="w">    </span><span class="no">nodeRegistration:</span>
<span class="w">      </span><span class="no">kubeletExtraArgs:</span>
<span class="w">        </span><span class="no">node-ip: 10.1.5.11</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="w">  </span><span class="nt">kubeadmConfigPatches</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">kind: JoinConfiguration</span>
<span class="w">    </span><span class="no">nodeRegistration:</span>
<span class="w">      </span><span class="no">kubeletExtraArgs:</span>
<span class="w">        </span><span class="no">node-ip: 10.1.8.10</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="w">  </span><span class="nt">kubeadmConfigPatches</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">kind: JoinConfiguration</span>
<span class="w">    </span><span class="no">nodeRegistration:</span>
<span class="w">      </span><span class="no">kubeletExtraArgs:</span>
<span class="w">        </span><span class="no">node-ip: 10.1.8.11</span>
</code></pre></div>
<h4 id="3443">34.4.3 网关配置要点<a class="headerlink" href="#3443" title="Permanent link">&para;</a></h4>
<p>网关需要配置 SNAT 以确保集群能访问外网：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># VyOS 网关配置</span>
<span class="nb">set</span><span class="w"> </span>interfaces<span class="w"> </span>ethernet<span class="w"> </span>eth1<span class="w"> </span>address<span class="w"> </span><span class="s1">&#39;10.1.5.1/24&#39;</span>
<span class="nb">set</span><span class="w"> </span>interfaces<span class="w"> </span>ethernet<span class="w"> </span>eth2<span class="w"> </span>address<span class="w"> </span><span class="s1">&#39;10.1.8.1/24&#39;</span>

<span class="c1"># SNAT 配置</span>
<span class="nb">set</span><span class="w"> </span>nat<span class="w"> </span><span class="nb">source</span><span class="w"> </span>rule<span class="w"> </span><span class="m">100</span><span class="w"> </span>outbound-interface<span class="w"> </span><span class="s1">&#39;eth0&#39;</span>
<span class="nb">set</span><span class="w"> </span>nat<span class="w"> </span><span class="nb">source</span><span class="w"> </span>rule<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>address<span class="w"> </span><span class="s1">&#39;10.1.0.0/16&#39;</span>
<span class="nb">set</span><span class="w"> </span>nat<span class="w"> </span><span class="nb">source</span><span class="w"> </span>rule<span class="w"> </span><span class="m">100</span><span class="w"> </span>translation<span class="w"> </span>address<span class="w"> </span><span class="s1">&#39;masquerade&#39;</span>
</code></pre></div>
<h3 id="345">34.5 通信验证<a class="headerlink" href="#345" title="Permanent link">&para;</a></h3>
<h4 id="3451">34.5.1 同网段通信（纯路由）<a class="headerlink" href="#3451" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Node 1 (10.1.5.10) 上的 Pod 访问 Node 2 (10.1.5.11) 上的 Pod</span>

<span class="c1"># 查看路由表</span>
ip<span class="w"> </span>route<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;10.1.5.11&quot;</span>
<span class="c1"># 10.24.x.x/26 via 10.1.5.11 dev net0  &lt;- 出接口是 net0</span>

<span class="c1"># 抓包验证</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>net0<span class="w"> </span>-nn<span class="w"> </span>icmp
</code></pre></div>
<p><strong>抓包结果</strong>：</p>
<div class="highlight"><pre><span></span><code>IP 10.24.x.x &gt; 10.24.y.y: ICMP echo request
</code></pre></div>
<blockquote>
<p>[!NOTE]
同网段通信时，数据包是普通的 IP 包，<strong>没有 IPIP 封装</strong>。
MAC 地址会逐跳变化，IP 地址保持不变。</p>
</blockquote>
<h4 id="3452-ipip">34.5.2 跨网段通信（IPIP 封装）<a class="headerlink" href="#3452-ipip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Node 1 (10.1.5.10) 上的 Pod 访问 Node 3 (10.1.8.10) 上的 Pod</span>

<span class="c1"># 查看路由表</span>
ip<span class="w"> </span>route<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;10.1.8.10&quot;</span>
<span class="c1"># 10.24.x.x/26 via 10.1.8.10 dev tunl0 onlink  &lt;- 出接口是 tunl0</span>

<span class="c1"># 抓包验证</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>net0<span class="w"> </span>-nn<span class="w"> </span><span class="s1">&#39;ip proto 4&#39;</span>
</code></pre></div>
<p><strong>抓包结果</strong>：</p>
<div class="highlight"><pre><span></span><code>IP 10.1.5.10 &gt; 10.1.8.10: IP 10.24.x.x &gt; 10.24.y.y: ICMP echo request
</code></pre></div>
<blockquote>
<p>[!NOTE]
跨网段通信时，数据包有两层 IP：</p>
<ul>
<li><strong>外层 IP</strong>：10.1.5.10 → 10.1.8.10（Node IP）</li>
<li><strong>内层 IP</strong>：10.24.x.x → 10.24.y.y（Pod IP）</li>
</ul>
</blockquote>
<h3 id="346-mac">34.6 MAC 地址变化分析<a class="headerlink" href="#346-mac" title="Permanent link">&para;</a></h3>
<h4 id="3461-mac">34.6.1 跨网段通信的 MAC 地址<a class="headerlink" href="#3461-mac" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod as Pod A
    participant Node1 as Node 1 (10.1.5.10)
    participant GW as Gateway
    participant Node3 as Node 3 (10.1.8.10)
    participant PodB as Pod B

    Pod-&gt;&gt;Node1: IPIP 封装
    Note over Node1: SRC MAC: Node1 net0&lt;br/&gt;DST MAC: 10.1.5.1 (GW)
    Node1-&gt;&gt;GW: 包发往网关
    Note over GW: SRC MAC: GW eth1&lt;br/&gt;DST MAC: 10.1.8.10
    GW-&gt;&gt;Node3: 包发往 Node 3
    Node3-&gt;&gt;PodB: IPIP 解封装
</code></pre></div>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>Node 1 发包时</strong>：</li>
<li>SRC MAC：Node 1 net0 的 MAC</li>
<li>
<p>DST MAC：网关 10.1.5.1 的 MAC（因为 10.1.8.10 不在同网段）</p>
</li>
<li>
<p><strong>网关转发时</strong>：</p>
</li>
<li>SRC MAC：网关 eth2 的 MAC</li>
<li>
<p>DST MAC：Node 3 net0 的 MAC</p>
</li>
<li>
<p><strong>IP 地址不变</strong>：外层 IP 始终是 10.1.5.10 → 10.1.8.10</p>
</li>
</ol>
<h4 id="3462-arp-ip">34.6.2 为什么 ARP 表没有对端 IP<a class="headerlink" href="#3462-arp-ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Node 1 上查看 ARP 表</span>
arp<span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">10</span>.1.8.10
<span class="c1"># 无结果！</span>
</code></pre></div>
<p><strong>原因</strong>：Node 1 (10.1.5.10) 和 Node 3 (10.1.8.10) 不在同一子网，无法直接 ARP 解析。</p>
<p>实际过程：</p>
<ol>
<li>Node 1 查路由，发现 10.1.8.10 的下一跳是网关 10.1.5.1</li>
<li>Node 1 ARP 解析 10.1.5.1 的 MAC</li>
<li>数据包发给网关，由网关负责后续转发</li>
</ol>
<h3 id="347-always-vs-crosssubnet">34.7 Always vs CrossSubnet<a class="headerlink" href="#347-always-vs-crosssubnet" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Always 模式&quot;
        A1[&quot;Node 1&quot;] --&gt;|&quot;IPIP&quot;| A2[&quot;Node 2&quot;]
        A1 --&gt;|&quot;IPIP&quot;| A3[&quot;Node 3&quot;]
    end

    subgraph &quot;CrossSubnet 模式&quot;
        C1[&quot;Node 1&quot;] --&gt;|&quot;路由&quot;| C2[&quot;Node 2 (同网段)&quot;]
        C1 --&gt;|&quot;IPIP&quot;| C3[&quot;Node 3 (跨网段)&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">Always</th>
<th style="text-align: left;">CrossSubnet</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>同网段开销</strong></td>
<td style="text-align: left;">20 字节</td>
<td style="text-align: left;">0 字节</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨网段开销</strong></td>
<td style="text-align: left;">20 字节</td>
<td style="text-align: left;">20 字节</td>
</tr>
<tr>
<td style="text-align: left;"><strong>配置复杂度</strong></td>
<td style="text-align: left;">低</td>
<td style="text-align: left;">中</td>
</tr>
<tr>
<td style="text-align: left;"><strong>适用场景</strong></td>
<td style="text-align: left;">简单环境</td>
<td style="text-align: left;">大规模混合环境</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能</strong></td>
<td style="text-align: left;">一般</td>
<td style="text-align: left;">同网段更优</td>
</tr>
</tbody>
</table>
<h3 id="348">34.8 章节小结<a class="headerlink" href="#348" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((IPIP CrossSubnet))
    模式原理
      同网段走路由
      跨网段走 IPIP
      智能判断子网
    配置方式
      ipipMode: CrossSubnet
      IPPool 资源配置
    路由表特征
      同网段: dev net0
      跨网段: dev tunl0 onlink
    抓包验证
      同网段: 普通 IP 包
      跨网段: 两层 IP
      过滤: ip proto 4
    MAC 地址
      跨网段先发给网关
      逐跳 MAC 变化
      IP 地址不变
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心要点总结</strong>：</p>
<ol>
<li><strong>CrossSubnet 模式</strong>：</li>
<li>同网段节点：纯路由转发，无封装开销</li>
<li>跨网段节点：IPIP 封装，20 字节开销</li>
<li>
<p>配置：<code>ipipMode: CrossSubnet</code></p>
</li>
<li>
<p><strong>路由表识别</strong>：</p>
</li>
<li>同网段：<code>dev net0</code>（物理网卡）</li>
<li>
<p>跨网段：<code>dev tunl0 onlink</code>（隧道设备）</p>
</li>
<li>
<p><strong>抓包验证</strong>：</p>
</li>
<li>同网段：<code>tcpdump -i net0 icmp</code></li>
<li>
<p>跨网段：<code>tcpdump -i net0 'ip proto 4'</code></p>
</li>
<li>
<p><strong>MAC 地址规律</strong>：</p>
</li>
<li>跨网段时，DST MAC 是<strong>网关的 MAC</strong></li>
<li>ARP 表中不会有对端节点的 MAC</li>
<li>
<p>每一跳 MAC 变化，IP 不变</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
</li>
<li>大规模集群，节点分布在多个子网</li>
<li>同机房节点走高速路由</li>
<li>跨机房节点走 IPIP 穿透</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-ipip_1">第三十五章 Calico-IPIP 手工实践<a class="headerlink" href="#calico-ipip_1" title="Permanent link">&para;</a></h2>
<p>本章通过手工创建 IPIP 隧道设备，深入理解 IPIP 封装的底层原理。同时介绍 SBR（Source-Based Routing）策略路由的概念，为理解复杂网络场景打下基础。</p>
<h3 id="351">35.1 背景与目标<a class="headerlink" href="#351" title="Permanent link">&para;</a></h3>
<h4 id="3511">35.1.1 为什么要手工实践<a class="headerlink" href="#3511" title="Permanent link">&para;</a></h4>
<p>手工创建 IPIP 隧道的目的：</p>
<ol>
<li><strong>加深理解</strong>：通过亲手操作，理解 Calico 自动创建 <code>tunl0</code> 设备的底层机制</li>
<li><strong>排障能力</strong>：掌握 IPIP 设备的配置方式，便于问题排查</li>
<li><strong>扩展思维</strong>：理解如何将 Pod 流量引导至 Overlay 设备</li>
</ol>
<h4 id="3512">35.1.2 实验拓扑<a class="headerlink" href="#3512" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Node 1 (172.18.0.4)&quot;
        IPIP1[&quot;ipip0&lt;br/&gt;1.1.1.1/24&quot;]
    end

    subgraph &quot;Node 2 (172.18.0.2)&quot;
        IPIP2[&quot;ipip0&lt;br/&gt;1.1.2.1/24&quot;]
    end

    IPIP1 &lt;--&gt;|&quot;IPIP Tunnel&lt;br/&gt;Outer: 172.18.0.x&quot;| IPIP2
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">节点</th>
<th style="text-align: left;">物理 IP</th>
<th style="text-align: left;">IPIP 接口地址</th>
<th style="text-align: left;">Local</th>
<th style="text-align: left;">Remote</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Node 1</td>
<td style="text-align: left;">172.18.0.4</td>
<td style="text-align: left;">1.1.1.1/24</td>
<td style="text-align: left;">172.18.0.4</td>
<td style="text-align: left;">172.18.0.2</td>
</tr>
<tr>
<td style="text-align: left;">Node 2</td>
<td style="text-align: left;">172.18.0.2</td>
<td style="text-align: left;">1.1.2.1/24</td>
<td style="text-align: left;">172.18.0.2</td>
<td style="text-align: left;">172.18.0.4</td>
</tr>
</tbody>
</table>
<h3 id="352-ipip">35.2 手工创建 IPIP 隧道<a class="headerlink" href="#352-ipip" title="Permanent link">&para;</a></h3>
<h4 id="3521-node-1">35.2.1 Node 1 配置<a class="headerlink" href="#3521-node-1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 创建 IPIP 设备</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>ipip0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>ipip<span class="w"> </span><span class="nb">local</span><span class="w"> </span><span class="m">172</span>.18.0.4<span class="w"> </span>remote<span class="w"> </span><span class="m">172</span>.18.0.2

<span class="c1"># 2. 启用接口</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>ipip0<span class="w"> </span>up

<span class="c1"># 3. 配置隧道内部地址</span>
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.1/24<span class="w"> </span>dev<span class="w"> </span>ipip0

<span class="c1"># 4. 添加到对端网段的路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.2.0/24<span class="w"> </span>dev<span class="w"> </span>ipip0
</code></pre></div>
<h4 id="3522-node-2">35.2.2 Node 2 配置<a class="headerlink" href="#3522-node-2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 创建 IPIP 设备（local/remote 互换）</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>ipip0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>ipip<span class="w"> </span><span class="nb">local</span><span class="w"> </span><span class="m">172</span>.18.0.2<span class="w"> </span>remote<span class="w"> </span><span class="m">172</span>.18.0.4

<span class="c1"># 2. 启用接口</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>ipip0<span class="w"> </span>up

<span class="c1"># 3. 配置隧道内部地址</span>
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.2.1/24<span class="w"> </span>dev<span class="w"> </span>ipip0

<span class="c1"># 4. 添加到对端网段的路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">1</span>.1.1.0/24<span class="w"> </span>dev<span class="w"> </span>ipip0
</code></pre></div>
<h4 id="3523">35.2.3 配置命令详解<a class="headerlink" href="#3523" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
<th style="text-align: left;">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>type ipip</code></td>
<td style="text-align: left;">设备类型为 IPIP</td>
<td style="text-align: left;">-</td>
</tr>
<tr>
<td style="text-align: left;"><code>local</code></td>
<td style="text-align: left;">本端物理 IP</td>
<td style="text-align: left;">172.18.0.4</td>
</tr>
<tr>
<td style="text-align: left;"><code>remote</code></td>
<td style="text-align: left;">对端物理 IP</td>
<td style="text-align: left;">172.18.0.2</td>
</tr>
<tr>
<td style="text-align: left;">隧道地址</td>
<td style="text-align: left;">隧道内部通信地址</td>
<td style="text-align: left;">1.1.1.1/24</td>
</tr>
<tr>
<td style="text-align: left;">路由</td>
<td style="text-align: left;">指向对端隧道网段</td>
<td style="text-align: left;">1.1.2.0/24</td>
</tr>
</tbody>
</table>
<h3 id="353">35.3 验证与抓包<a class="headerlink" href="#353" title="Permanent link">&para;</a></h3>
<h4 id="3531">35.3.1 连通性测试<a class="headerlink" href="#3531" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Node 1 上 ping Node 2 的隧道地址</span>
ping<span class="w"> </span>-I<span class="w"> </span><span class="m">1</span>.1.1.1<span class="w"> </span><span class="m">1</span>.1.2.1
</code></pre></div>
<h4 id="3532">35.3.2 抓包验证<a class="headerlink" href="#3532" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Node 1 的物理网卡上抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span><span class="s1">&#39;ip proto 4&#39;</span>
</code></pre></div>
<p><strong>抓包结果</strong>：</p>
<div class="highlight"><pre><span></span><code>IP 172.18.0.4 &gt; 172.18.0.2: IP 1.1.1.1 &gt; 1.1.2.1: ICMP echo request
IP 172.18.0.2 &gt; 172.18.0.4: IP 1.1.2.1 &gt; 1.1.1.1: ICMP echo reply
</code></pre></div>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;IPIP 封装包结构&quot;
        Outer[&quot;外层 IP&lt;br/&gt;SRC: 172.18.0.4&lt;br/&gt;DST: 172.18.0.2&lt;br/&gt;Protocol: 4&quot;]
        Inner[&quot;内层 IP&lt;br/&gt;SRC: 1.1.1.1&lt;br/&gt;DST: 1.1.2.1&quot;]
        Payload[&quot;ICMP Data&quot;]
    end
    Outer --&gt; Inner --&gt; Payload
</code></pre></div>
<h4 id="3533">35.3.3 查看设备信息<a class="headerlink" href="#3533" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 IPIP 设备详情</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>ipip0

<span class="c1"># 输出示例</span>
<span class="c1"># ipip0@NONE: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1480 ...</span>
<span class="c1">#     link/ipip 172.18.0.4 peer 172.18.0.2</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">属性</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>link/ipip</code></td>
<td style="text-align: left;">设备类型为 IPIP</td>
</tr>
<tr>
<td style="text-align: left;"><code>172.18.0.4 peer 172.18.0.2</code></td>
<td style="text-align: left;">Local 和 Remote IP</td>
</tr>
<tr>
<td style="text-align: left;"><code>mtu 1480</code></td>
<td style="text-align: left;">MTU = 1500 - 20 (IPIP Header)</td>
</tr>
<tr>
<td style="text-align: left;"><code>NOARP</code></td>
<td style="text-align: left;">三层设备，无 ARP</td>
</tr>
</tbody>
</table>
<h3 id="354-ipip-vs-vxlan">35.4 IPIP vs VXLAN 配置对比<a class="headerlink" href="#354-ipip-vs-vxlan" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;IPIP 配置&quot;
        I1[&quot;ip link add ipip0 type ipip&quot;]
        I2[&quot;local/remote&quot;]
        I3[&quot;完成！&quot;]
        I1 --&gt; I2 --&gt; I3
    end

    subgraph &quot;VXLAN 配置&quot;
        V1[&quot;ip link add vxlan0 type vxlan&quot;]
        V2[&quot;id (VNI)&quot;]
        V3[&quot;dstport 4789&quot;]
        V4[&quot;local/remote&quot;]
        V5[&quot;FDB 表&quot;]
        V6[&quot;完成！&quot;]
        V1 --&gt; V2 --&gt; V3 --&gt; V4 --&gt; V5 --&gt; V6
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">IPIP</th>
<th style="text-align: left;">VXLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>配置复杂度</strong></td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">较复杂</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VNI</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">需要</td>
</tr>
<tr>
<td style="text-align: left;"><strong>端口</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">4789/8472</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FDB 表</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">需要</td>
</tr>
<tr>
<td style="text-align: left;"><strong>封装开销</strong></td>
<td style="text-align: left;">20 字节</td>
<td style="text-align: left;">50 字节</td>
</tr>
<tr>
<td style="text-align: left;"><strong>多租户</strong></td>
<td style="text-align: left;">不支持</td>
<td style="text-align: left;">支持</td>
</tr>
</tbody>
</table>
<h3 id="355">35.5 生产环境扩展思考<a class="headerlink" href="#355" title="Permanent link">&para;</a></h3>
<h4 id="3551-pod-ipip">35.5.1 Pod 流量如何到达 IPIP 设备<a class="headerlink" href="#3551-pod-ipip" title="Permanent link">&para;</a></h4>
<p>在实际生产环境中，Pod 的流量需要被引导到 IPIP 设备进行封装：</p>
<div class="highlight"><pre><span></span><code>flowchart LR
    Pod[&quot;Pod&lt;br/&gt;(Network NS)&quot;]
    VethPod[&quot;veth (Pod 端)&quot;]
    VethHost[&quot;veth (Host 端)&quot;]
    Route[&quot;路由表&quot;]
    IPIP[&quot;IPIP 设备&quot;]
    Physical[&quot;物理网卡&quot;]

    Pod --&gt; VethPod
    VethPod --&gt; VethHost
    VethHost --&gt; Route
    Route --&gt;|&quot;目标 Pod CIDR&quot;| IPIP
    IPIP --&gt;|&quot;封装&quot;| Physical
</code></pre></div>
<p><strong>关键步骤</strong>：</p>
<ol>
<li><strong>Pod 到 Host</strong>：通过 veth pair + Proxy ARP</li>
<li><strong>Host 到 IPIP</strong>：通过路由表（Calico 自动注入）</li>
<li><strong>IPIP 封装</strong>：设备自动封装外层 IP</li>
</ol>
<h4 id="3552-calico">35.5.2 Calico 的自动化<a class="headerlink" href="#3552-calico" title="Permanent link">&para;</a></h4>
<p>Calico 自动完成的工作：</p>
<ul>
<li>创建 <code>tunl0</code> 设备（<code>remote any local any</code>）</li>
<li>通过 BGP 学习其他节点的 Pod CIDR</li>
<li>注入路由：<code>10.24.x.x/26 via &lt;Node IP&gt; dev tunl0 onlink</code></li>
<li>根据 <code>ipipMode</code> 决定是否走隧道</li>
</ul>
<h3 id="356-sbr-source-based-routing">35.6 SBR (Source-Based Routing) 策略路由<a class="headerlink" href="#356-sbr-source-based-routing" title="Permanent link">&para;</a></h3>
<h4 id="3561-sbr">35.6.1 什么是 SBR<a class="headerlink" href="#3561-sbr" title="Permanent link">&para;</a></h4>
<p>传统路由基于<strong>目的地址 (DST)</strong>，而 SBR 基于<strong>源地址 (SRC)</strong>：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;传统路由 (DST-Based)&quot;
        D1[&quot;查目的 IP&quot;] --&gt; D2[&quot;查路由表&quot;] --&gt; D3[&quot;转发&quot;]
    end

    subgraph &quot;策略路由 (SRC-Based)&quot;
        S1[&quot;查源 IP&quot;] --&gt; S2[&quot;匹配 Rule&quot;] --&gt; S3[&quot;选择路由表&quot;] --&gt; S4[&quot;转发&quot;]
    end
</code></pre></div>
<h4 id="3562-sbr">35.6.2 SBR 配置示例<a class="headerlink" href="#3562-sbr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建策略路由规则</span>
ip<span class="w"> </span>rule<span class="w"> </span>add<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.0/24<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>

<span class="c1"># 在表 100 中添加默认路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.0.1<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>

<span class="c1"># 查看规则</span>
ip<span class="w"> </span>rule<span class="w"> </span>show
</code></pre></div>
<p><strong>输出示例</strong>：</p>
<div class="highlight"><pre><span></span><code>0:      from all lookup local
32765:  from 192.168.1.0/24 lookup 100
32766:  from all lookup main
32767:  from all lookup default
</code></pre></div>
<h4 id="3563-sbr">35.6.3 SBR 应用场景<a class="headerlink" href="#3563-sbr" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>多网卡 (Multi-Homing)</strong></td>
<td style="text-align: left;">不同网卡的流量走不同出口</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cilium CNI</strong></td>
<td style="text-align: left;">使用 SBR 实现复杂策略</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VPN 分流</strong></td>
<td style="text-align: left;">特定源走 VPN 隧道</td>
</tr>
<tr>
<td style="text-align: left;"><strong>多 ISP</strong></td>
<td style="text-align: left;">根据源选择出口</td>
</tr>
</tbody>
</table>
<h4 id="3564">35.6.4 多网卡场景的回程路由问题<a class="headerlink" href="#3564" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as 客户端
    participant eth0 as eth0 (192.168.1.10)
    participant eth1 as eth1 (10.0.0.10)

    Note over Client,eth1: 请求从 eth0 进来
    Client-&gt;&gt;eth0: 请求 192.168.1.10

    Note over eth0,eth1: 没有 SBR 时，可能从 eth1 回复
    eth1--xClient: 回复可能走错接口！

    Note over eth0,eth1: 有 SBR 时，确保从 eth0 回复
    eth0-&gt;&gt;Client: 回复走正确接口 ✓
</code></pre></div>
<p><strong>问题</strong>：没有 SBR 时，回复包可能从错误的接口发出</p>
<p><strong>解决</strong>：为每个接口配置 SBR，确保回程路径正确</p>
<h3 id="357-cni">35.7 CNI 网络实现套路总结<a class="headerlink" href="#357-cni" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((CNI 网络套路))
    设备创建
      veth pair
      bridge
      ipip/vxlan
      tun/tap
    流量引导
      路由表 DST
      策略路由 SBR
      iptables/nftables
      eBPF
    封装方式
      IPIP
      VXLAN
      GRE
      Geneve
      WireGuard
    路由协议
      BGP
      OSPF
      静态路由
    网关机制
      Proxy ARP
      Bridge
      L3 Routing
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>核心套路</strong>：</p>
<ol>
<li><strong>创建设备</strong>：赋予封装能力（IPIP/VXLAN/GRE）</li>
<li><strong>引导流量</strong>：通过路由表将流量导向设备</li>
<li><strong>封装转发</strong>：设备自动封装 Overlay 包</li>
<li><strong>对端解封</strong>：对端设备解封装后路由到目标</li>
</ol>
</blockquote>
<h3 id="358">35.8 章节小结<a class="headerlink" href="#358" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((IPIP 手工实践))
    创建设备
      ip link add type ipip
      local/remote 参数
      MTU 自动 1480
    配置流程
      创建设备
      启用接口
      配置地址
      添加路由
    抓包验证
      ip proto 4
      两层 IP 头
    对比 VXLAN
      IPIP 更简单
      无 VNI/Port/FDB
    SBR 策略路由
      基于源地址
      多网卡场景
      回程路由问题
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>实践要点总结</strong>：</p>
<ol>
<li><strong>IPIP 设备创建</strong>：</li>
</ol>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>ipip0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>ipip<span class="w"> </span><span class="nb">local</span><span class="w"> </span>&lt;本端IP&gt;<span class="w"> </span>remote<span class="w"> </span>&lt;对端IP&gt;
</code></pre></div>
<ol>
<li><strong>三步配置</strong>：</li>
<li>启用接口：<code>ip link set ipip0 up</code></li>
<li>配置地址：<code>ip addr add x.x.x.x/24 dev ipip0</code></li>
<li>
<p>添加路由：<code>ip route add &lt;对端网段&gt; dev ipip0</code></p>
</li>
<li>
<p><strong>抓包验证</strong>：<code>tcpdump -i eth0 'ip proto 4'</code></p>
</li>
<li>
<p><strong>生产扩展</strong>：</p>
</li>
<li>Pod → veth → 路由表 → IPIP 设备</li>
<li>
<p>Calico 自动完成设备创建和路由注入</p>
</li>
<li>
<p><strong>SBR 策略路由</strong>：</p>
</li>
<li>基于源地址选择路由表</li>
<li>解决多网卡回程路由问题</li>
<li>Cilium 中有广泛应用</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-vxlan">第三十六章 Calico-VxLAN 模式<a class="headerlink" href="#calico-vxlan" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico 的 VxLAN 封装模式，重点讲解 FDB（Forwarding Database）表机制以及与 IPIP 模式的区别。</p>
<h3 id="361">36.1 背景与概述<a class="headerlink" href="#361" title="Permanent link">&para;</a></h3>
<h4 id="3611-vxlan-vs-ipip">36.1.1 VxLAN vs IPIP<a class="headerlink" href="#3611-vxlan-vs-ipip" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">IPIP</th>
<th style="text-align: left;">VxLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>封装层级</strong></td>
<td style="text-align: left;">Layer 3 (IP-in-IP)</td>
<td style="text-align: left;">Layer 2 over Layer 3</td>
</tr>
<tr>
<td style="text-align: left;"><strong>协议号</strong></td>
<td style="text-align: left;">IP Protocol 4</td>
<td style="text-align: left;">UDP 4789</td>
</tr>
<tr>
<td style="text-align: left;"><strong>封装开销</strong></td>
<td style="text-align: left;">20 字节</td>
<td style="text-align: left;">50 字节</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BGP 依赖</strong></td>
<td style="text-align: left;">需要（bird 组件）</td>
<td style="text-align: left;">不需要</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FDB 表</strong></td>
<td style="text-align: left;">不需要</td>
<td style="text-align: left;">需要</td>
</tr>
<tr>
<td style="text-align: left;"><strong>多租户</strong></td>
<td style="text-align: left;">不支持</td>
<td style="text-align: left;">支持（VNI）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>防火墙友好</strong></td>
<td style="text-align: left;">可能被阻挡</td>
<td style="text-align: left;">UDP 更易穿透</td>
</tr>
</tbody>
</table>
<h4 id="3612-vxlan">36.1.2 何时选择 VxLAN<a class="headerlink" href="#3612-vxlan" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>网络限制</strong>：底层网络不支持 IP Protocol 4</li>
<li><strong>防火墙穿透</strong>：UDP 端口更易开放</li>
<li><strong>无 BGP 需求</strong>：不想维护 BGP 组件</li>
<li><strong>大二层网络</strong>：需要二层可达的场景</li>
</ul>
<h3 id="362-vxlan">36.2 VxLAN 模式配置<a class="headerlink" href="#362-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="3621-ippool">36.2.1 IPPool 配置<a class="headerlink" href="#3621-ippool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w">          </span><span class="c1"># 禁用 IPIP</span>
<span class="w">  </span><span class="nt">vxlanMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span><span class="w">        </span><span class="c1"># 启用 VxLAN</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>关键配置</strong>：</p>
<ul>
<li><code>ipipMode</code> 和 <code>vxlanMode</code> 只能选一个</li>
<li>VxLAN 模式下需禁用 bird 相关组件</li>
</ul>
</blockquote>
<h4 id="3622-bgpbird">36.2.2 禁用 BGP/bird 组件<a class="headerlink" href="#3622-bgpbird" title="Permanent link">&para;</a></h4>
<p>VxLAN 模式不依赖 BGP，需要修改 Calico 部署配置：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># calico-node DaemonSet 中</span>
<span class="nt">env</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CALICO_NETWORKING_BACKEND</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;vxlan&quot;</span><span class="w">  </span><span class="c1"># 原来是 &quot;bird&quot;</span>

<span class="c1"># 移除或注释 bird 相关探针</span>
<span class="nt">livenessProbe</span><span class="p">:</span>
<span class="w">  </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># - /bin/calico-node</span>
<span class="w">      </span><span class="c1"># - -bird-live</span>
<span class="nt">readinessProbe</span><span class="p">:</span>
<span class="w">  </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># - /bin/calico-node  </span>
<span class="w">      </span><span class="c1"># - -bird-ready</span>
</code></pre></div>
<h4 id="3623-auto-detect">36.2.3 网卡自动检测（Auto-Detect）<a class="headerlink" href="#3623-auto-detect" title="Permanent link">&para;</a></h4>
<p>多网卡环境需指定业务网卡：</p>
<div class="highlight"><pre><span></span><code><span class="nt">env</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IP_AUTODETECTION_METHOD</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;interface=eth1&quot;</span><span class="w">  </span><span class="c1"># 指定网卡</span>
<span class="w">    </span><span class="c1"># 或使用 CIDR</span>
<span class="w">    </span><span class="c1"># value: &quot;cidr=10.1.0.0/16&quot;</span>
</code></pre></div>
<p><strong>检测方法</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">方法</th>
<th style="text-align: left;">示例</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>first-found</code></td>
<td style="text-align: left;">默认</td>
<td style="text-align: left;">自动选择默认路由网卡</td>
</tr>
<tr>
<td style="text-align: left;"><code>interface=</code></td>
<td style="text-align: left;"><code>eth1</code></td>
<td style="text-align: left;">指定网卡名</td>
</tr>
<tr>
<td style="text-align: left;"><code>cidr=</code></td>
<td style="text-align: left;"><code>10.1.0.0/16</code></td>
<td style="text-align: left;">匹配 CIDR</td>
</tr>
<tr>
<td style="text-align: left;"><code>can-reach=</code></td>
<td style="text-align: left;"><code>8.8.8.8</code></td>
<td style="text-align: left;">能到达的地址</td>
</tr>
</tbody>
</table>
<h3 id="363-mtu">36.3 MTU 配置<a class="headerlink" href="#363-mtu" title="Permanent link">&para;</a></h3>
<h4 id="3631-mtu">36.3.1 不同模式的 MTU<a class="headerlink" href="#3631-mtu" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;物理网卡 MTU 1500&quot;
        IPIP[&quot;IPIP&lt;br/&gt;MTU 1480&lt;br/&gt;(-20 字节)&quot;]
        VxLAN[&quot;VxLAN&lt;br/&gt;MTU 1450&lt;br/&gt;(-50 字节)&quot;]
        WG[&quot;WireGuard&lt;br/&gt;MTU 1440&lt;br/&gt;(-60 字节)&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">MTU 计算</th>
<th style="text-align: left;">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">IPIP</td>
<td style="text-align: left;">1500 - 20</td>
<td style="text-align: left;">1480</td>
</tr>
<tr>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;">1500 - 50</td>
<td style="text-align: left;">1450</td>
</tr>
<tr>
<td style="text-align: left;">WireGuard + VxLAN</td>
<td style="text-align: left;">1500 - 60</td>
<td style="text-align: left;">1440</td>
</tr>
<tr>
<td style="text-align: left;">IPv6 + VxLAN</td>
<td style="text-align: left;">1500 - 70</td>
<td style="text-align: left;">1430</td>
</tr>
</tbody>
</table>
<h4 id="3632">36.3.2 巨型帧环境<a class="headerlink" href="#3632" title="Permanent link">&para;</a></h4>
<p>数据中心常用 9000 MTU 巨型帧：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 通过 calicoctl 修改 MTU</span>
calicoctl<span class="w"> </span>patch<span class="w"> </span>felixconfiguration<span class="w"> </span>default<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--patch<span class="o">=</span><span class="s1">&#39;{&quot;spec&quot;: {&quot;mtu&quot;: 8981}}&#39;</span>

<span class="c1"># 验证</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>vxlan.calico
<span class="c1"># mtu 8950 ...</span>
</code></pre></div>
<h3 id="364-vxlan-fdb">36.4 VxLAN 设备与 FDB 表<a class="headerlink" href="#364-vxlan-fdb" title="Permanent link">&para;</a></h3>
<h4 id="3641-vxlancalico">36.4.1 vxlan.calico 设备<a class="headerlink" href="#3641-vxlancalico" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 VxLAN 设备</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>vxlan.calico

<span class="c1"># 输出示例</span>
<span class="c1"># vxlan.calico: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 ...</span>
<span class="c1">#     link/ether 66:c0:d0:7a:17:07 brd ff:ff:ff:ff:ff:ff</span>
<span class="c1">#     vxlan id 4096 local 172.18.0.3 dev eth0 srcport 0 0 dstport 4789 ...</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">属性</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>vxlan id 4096</code></td>
<td style="text-align: left;">VNI (VxLAN Network Identifier)</td>
</tr>
<tr>
<td style="text-align: left;"><code>local 172.18.0.3</code></td>
<td style="text-align: left;">本端 VTEP IP</td>
</tr>
<tr>
<td style="text-align: left;"><code>dstport 4789</code></td>
<td style="text-align: left;">VxLAN UDP 端口</td>
</tr>
<tr>
<td style="text-align: left;"><code>mtu 1450</code></td>
<td style="text-align: left;">1500 - 50</td>
</tr>
</tbody>
</table>
<h4 id="3642-fdb">36.4.2 FDB 表详解<a class="headerlink" href="#3642-fdb" title="Permanent link">&para;</a></h4>
<p><strong>FDB (Forwarding Database)</strong> 是 VxLAN 的核心机制，用于解决 <strong>外层目的 IP</strong> 的问题：</p>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;路由表&quot;
        Route[&quot;10.244.17.64/26 via 10.244.17.64&lt;br/&gt;dev vxlan.calico onlink&quot;]
    end

    subgraph &quot;ARP 表&quot;
        ARP[&quot;10.244.17.64 -&gt; 66:c0:d0:7a:xx:xx&quot;]
    end

    subgraph &quot;FDB 表&quot;
        FDB[&quot;66:c0:d0:7a:xx:xx -&gt; 172.18.0.4&lt;br/&gt;(outer dst IP)&quot;]
    end

    Route --&gt; ARP --&gt; FDB
    FDB --&gt;|&quot;封装外层 IP&quot;| VxLAN[&quot;VxLAN 封装&quot;]
</code></pre></div>
<p><strong>查看 FDB 表</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 方法 1: bridge fdb show</span>
bridge<span class="w"> </span>fdb<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>vxlan.calico<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>permanent

<span class="c1"># 方法 2: ip monitor 观察动态添加</span>
ip<span class="w"> </span>monitor<span class="w"> </span>all

<span class="c1"># 输出示例</span>
<span class="c1"># 66:c0:d0:7a:17:07 dev vxlan.calico dst 172.18.0.4 self permanent</span>
</code></pre></div>
<h4 id="3643-fdb">36.4.3 FDB 表的核心含义<a class="headerlink" href="#3643-fdb" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    MAC[&quot;MAC 地址&lt;br/&gt;66:c0:d0:7a:xx:xx&quot;] --&gt;|&quot;belongs to&quot;| Host[&quot;Host IP&lt;br/&gt;172.18.0.4&quot;]

    subgraph &quot;VxLAN 封装&quot;
        Inner[&quot;内层 DST MAC&quot;]
        Outer[&quot;外层 DST IP&quot;]
    end

    MAC --&gt; Inner
    Host --&gt; Outer
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>FDB 表的作用</strong>：</p>
<ol>
<li><strong>回答问题</strong>：这个 MAC 地址属于哪个主机？</li>
<li><strong>解决问题</strong>：VxLAN 封装时，外层 DST IP 用谁？</li>
<li><strong>自动学习</strong>：类似 ARP，系统自动维护</li>
</ol>
</blockquote>
<p><strong>两层理解</strong>：</p>
<ol>
<li><strong>深层理解</strong>：FDB 表示 MAC 地址与主机的映射，该 MAC 不一定是主机物理网卡的 MAC，只要在该主机的任意网卡上存在即可</li>
<li><strong>简单理解</strong>：FDB 是自动维护的，可通过 <code>ip monitor all</code> 观察添加过程</li>
</ol>
<h3 id="365-vxlan">36.5 VxLAN 包封装分析<a class="headerlink" href="#365-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="3651">36.5.1 完整封装结构<a class="headerlink" href="#3651" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;外层 Ethernet&quot;
        OMac[&quot;Outer MAC&lt;br/&gt;SRC: Node1 eth0&lt;br/&gt;DST: Node2 eth0&quot;]
    end

    subgraph &quot;外层 IP&quot;
        OIP[&quot;Outer IP&lt;br/&gt;SRC: 172.18.0.3&lt;br/&gt;DST: 172.18.0.4&quot;]
    end

    subgraph &quot;UDP&quot;
        UDP[&quot;UDP&lt;br/&gt;SRC: random&lt;br/&gt;DST: 4789&quot;]
    end

    subgraph &quot;VxLAN Header&quot;
        VH[&quot;VNI: 4096&quot;]
    end

    subgraph &quot;内层 Ethernet&quot;
        IMac[&quot;Inner MAC&lt;br/&gt;SRC: vxlan.calico local&lt;br/&gt;DST: vxlan.calico remote&quot;]
    end

    subgraph &quot;内层 IP&quot;
        IIP[&quot;Inner IP&lt;br/&gt;SRC: Pod1 IP&lt;br/&gt;DST: Pod2 IP&quot;]
    end

    OMac --&gt; OIP --&gt; UDP --&gt; VH --&gt; IMac --&gt; IIP
</code></pre></div>
<h4 id="3652-mac">36.5.2 内层 MAC 地址变化<a class="headerlink" href="#3652-mac" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod as Pod (10.244.1.69)
    participant Veth as veth (Host 端)
    participant Route as 路由表
    participant VxLAN as vxlan.calico
    participant Eth as eth0

    Pod-&gt;&gt;Veth: SRC MAC: Pod MAC&lt;br/&gt;DST MAC: 网关 MAC (ee:ee:ee...)
    Veth-&gt;&gt;Route: 查路由表
    Route-&gt;&gt;VxLAN: 下一跳: 10.244.17.64&lt;br/&gt;dev vxlan.calico
    Note over VxLAN: MAC 地址重写！
    VxLAN-&gt;&gt;Eth: Inner SRC MAC: 本地 vxlan.calico MAC&lt;br/&gt;Inner DST MAC: 远端 vxlan.calico MAC
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>关键点</strong>：内层 MAC 地址不是原始 Pod 的 MAC！</p>
<ul>
<li><strong>Inner SRC MAC</strong>：本地 <code>vxlan.calico</code> 接口的 MAC</li>
<li><strong>Inner DST MAC</strong>：远端 <code>vxlan.calico</code> 接口的 MAC（通过 ARP 表获取）</li>
</ul>
</blockquote>
<h4 id="3653">36.5.3 抓包验证<a class="headerlink" href="#3653" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 eth0 上抓 VxLAN 包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">4789</span><span class="w"> </span>-w<span class="w"> </span>vxlan.pcap

<span class="c1"># 或直接查看</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>-e<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">4789</span>

<span class="c1"># 输出示例</span>
<span class="c1"># 02:42:ac:12:00:03 &gt; 02:42:ac:12:00:04, IP 172.18.0.3.random &gt; 172.18.0.4.4789: VXLAN...</span>
<span class="c1">#   66:c0:d0:xx &gt; 66:c0:d0:yy, IP 10.244.1.69 &gt; 10.244.17.65: ICMP...</span>
</code></pre></div>
<h3 id="366-vxlan-vs-ipip">36.6 VxLAN vs IPIP 路由表对比<a class="headerlink" href="#366-vxlan-vs-ipip" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># IPIP 模式</span>
<span class="m">10</span>.244.17.64/26<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.4<span class="w"> </span>dev<span class="w"> </span>tunl0<span class="w"> </span>proto<span class="w"> </span>bird<span class="w"> </span>onlink

<span class="c1"># VxLAN 模式  </span>
<span class="m">10</span>.244.17.64/26<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.244.17.64<span class="w"> </span>dev<span class="w"> </span>vxlan.calico<span class="w"> </span>onlink
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">IPIP</th>
<th style="text-align: left;">VxLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>下一跳</strong></td>
<td style="text-align: left;">物理节点 IP</td>
<td style="text-align: left;">Pod CIDR 网关</td>
</tr>
<tr>
<td style="text-align: left;"><strong>设备</strong></td>
<td style="text-align: left;">tunl0</td>
<td style="text-align: left;">vxlan.calico</td>
</tr>
<tr>
<td style="text-align: left;"><strong>extern IP 来源</strong></td>
<td style="text-align: left;">路由表直接给出</td>
<td style="text-align: left;">FDB 表查询</td>
</tr>
<tr>
<td style="text-align: left;"><strong>proto</strong></td>
<td style="text-align: left;">bird (BGP)</td>
<td style="text-align: left;">无</td>
</tr>
</tbody>
</table>
<h3 id="367">36.7 同节点通信<a class="headerlink" href="#367" title="Permanent link">&para;</a></h3>
<p>VxLAN 模式下，<strong>同节点 Pod 通信与 IPIP 模式完全相同</strong>：</p>
<div class="highlight"><pre><span></span><code>flowchart LR
    Pod1[&quot;Pod1&quot;] --&gt; Veth1[&quot;veth&quot;]
    Veth1 --&gt; Route[&quot;路由表&quot;]
    Route --&gt;|&quot;目的 Pod 在本机&quot;| Veth2[&quot;veth&quot;]
    Veth2 --&gt; Pod2[&quot;Pod2&quot;]
</code></pre></div>
<ul>
<li>无 VxLAN 封装</li>
<li>纯三层路由 + Proxy ARP</li>
</ul>
<h3 id="368">36.8 章节小结<a class="headerlink" href="#368" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Calico VxLAN 模式))
    配置
      vxlanMode Always
      ipipMode Never
      禁用 bird
    FDB 表
      MAC to Host IP
      自动学习
      bridge fdb show
    封装
      50 字节开销
      UDP 4789
      VNI 4096
    内层 MAC
      不是 Pod MAC
      vxlan.calico MAC
    MTU
      1500 - 50 = 1450
      巨型帧 9000
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>VxLAN 模式要点总结</strong>：</p>
<ol>
<li><strong>配置</strong>：</li>
<li><code>vxlanMode: Always</code>，<code>ipipMode: Never</code></li>
<li>
<p>需禁用 bird 相关组件</p>
</li>
<li>
<p><strong>FDB 表核心</strong>：</p>
</li>
<li>解决：外层 DST IP 用谁？</li>
<li>查询：<code>bridge fdb show dev vxlan.calico</code></li>
<li>
<p>机制：MAC 地址 → 主机 IP</p>
</li>
<li>
<p><strong>内层 MAC 变化</strong>：</p>
</li>
<li>不是原始 Pod MAC</li>
<li>SRC: 本地 <code>vxlan.calico</code> MAC</li>
<li>
<p>DST: 远端 <code>vxlan.calico</code> MAC</p>
</li>
<li>
<p><strong>抓包</strong>：<code>tcpdump -i eth0 udp port 4789</code></p>
</li>
<li>
<p><strong>MTU</strong>：1500 - 50 = 1450</p>
</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-vxlan-crosssubnet">第三十七章 Calico-VxLAN-CrossSubnet 模式<a class="headerlink" href="#calico-vxlan-crosssubnet" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico VxLAN 的 CrossSubnet 模式，这是生产环境中最推荐的混合部署方案——同网段走高性能路由，跨网段走 overlay 封装。</p>
<h3 id="371">37.1 背景与概述<a class="headerlink" href="#371" title="Permanent link">&para;</a></h3>
<h4 id="3711-crosssubnet">37.1.1 为什么需要 CrossSubnet<a class="headerlink" href="#3711-crosssubnet" title="Permanent link">&para;</a></h4>
<p>在大型数据中心中，节点通常分布在不同的网段：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;机架 A (10.1.5.0/24)&quot;
        Node1[&quot;Node1&lt;br/&gt;10.1.5.10&quot;]
        Node2[&quot;Node2&lt;br/&gt;10.1.5.11&quot;]
    end

    subgraph &quot;机架 B (10.1.8.0/24)&quot;
        Node3[&quot;Node3&lt;br/&gt;10.1.8.10&quot;]
        Node4[&quot;Node4&lt;br/&gt;10.1.8.11&quot;]
    end

    Router[&quot;路由器/三层交换机&quot;]

    Node1 &amp; Node2 --&gt; Router
    Router --&gt; Node3 &amp; Node4
</code></pre></div>
<ul>
<li><strong>同机架</strong>：节点在同一二层，可直接路由</li>
<li><strong>跨机架</strong>：节点在不同网段，需要三层转发</li>
</ul>
<h4 id="3712-crosssubnet">37.1.2 CrossSubnet 模式原理<a class="headerlink" href="#3712-crosssubnet" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;同网段通信&quot;
        Pod1A[&quot;Pod1&quot;] --&gt;|&quot;直接路由&quot;| Pod2A[&quot;Pod2&quot;]
        Note1[&quot;无封装&lt;br/&gt;高性能&quot;]
    end

    subgraph &quot;跨网段通信&quot;
        Pod1B[&quot;Pod1&quot;] --&gt;|&quot;VxLAN 封装&quot;| Pod2B[&quot;Pod2&quot;]
        Note2[&quot;overlay&lt;br/&gt;兼容性好&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">封装方式</th>
<th style="text-align: left;">性能</th>
<th style="text-align: left;">依赖</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>同网段</strong></td>
<td style="text-align: left;">无（纯路由）</td>
<td style="text-align: left;">高</td>
<td style="text-align: left;">-</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨网段</strong></td>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;">较低</td>
<td style="text-align: left;">FDB 表</td>
</tr>
</tbody>
</table>
<h4 id="3713-always-vs-crosssubnet">37.1.3 Always vs CrossSubnet<a class="headerlink" href="#3713-always-vs-crosssubnet" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">同网段</th>
<th style="text-align: left;">跨网段</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>Always</code></td>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;">统一封装，简单</td>
</tr>
<tr>
<td style="text-align: left;"><code>CrossSubnet</code></td>
<td style="text-align: left;">路由</td>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;">混合环境，性能优先</td>
</tr>
<tr>
<td style="text-align: left;"><code>Never</code></td>
<td style="text-align: left;">路由</td>
<td style="text-align: left;">路由</td>
<td style="text-align: left;">需要 BGP + 外部路由</td>
</tr>
</tbody>
</table>
<h3 id="372">37.2 配置详解<a class="headerlink" href="#372" title="Permanent link">&para;</a></h3>
<h4 id="3721-ippool">37.2.1 IPPool 配置<a class="headerlink" href="#3721-ippool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w">              </span><span class="c1"># 禁用 IPIP</span>
<span class="w">  </span><span class="nt">vxlanMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CrossSubnet</span><span class="w">       </span><span class="c1"># 跨网段 VxLAN</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>关键配置项</strong>：</p>
<ul>
<li><code>vxlanMode: CrossSubnet</code> — 只在跨网段时封装</li>
<li><code>ipipMode: Never</code> — 必须禁用 IPIP（二者互斥）</li>
<li>仍需禁用 bird 相关组件</li>
</ul>
</blockquote>
<h4 id="3722-calico">37.2.2 Calico 如何判断"同网段"<a class="headerlink" href="#3722-calico" title="Permanent link">&para;</a></h4>
<p>Calico 根据节点 IP 和网络掩码判断：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 假设节点 IP</span>
Node1:<span class="w"> </span><span class="m">10</span>.1.5.10/24
Node2:<span class="w"> </span><span class="m">10</span>.1.5.11/24<span class="w">  </span><span class="c1"># 同网段</span>
Node3:<span class="w"> </span><span class="m">10</span>.1.8.10/24<span class="w">  </span><span class="c1"># 不同网段</span>

<span class="c1"># Calico 判断逻辑</span>
<span class="m">10</span>.1.5.10/24<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="m">10</span>.1.5.11/24<span class="w"> </span>→<span class="w"> </span>同网段<span class="w"> </span><span class="o">(</span><span class="m">10</span>.1.5.0<span class="o">)</span><span class="w"> </span>→<span class="w"> </span>路由
<span class="m">10</span>.1.5.10/24<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="m">10</span>.1.8.10/24<span class="w"> </span>→<span class="w"> </span>不同网段<span class="w"> </span>→<span class="w"> </span>VxLAN
</code></pre></div>
<h3 id="373">37.3 实验拓扑<a class="headerlink" href="#373" title="Permanent link">&para;</a></h3>
<h4 id="3731-containerlab">37.3.1 ContainerLab 跨网段环境<a class="headerlink" href="#3731-containerlab" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Kind 集群&quot;
        Control[&quot;control-plane&lt;br/&gt;10.1.5.10&quot;]
        Worker1[&quot;worker1&lt;br/&gt;10.1.5.11&quot;]
        Worker2[&quot;worker2&lt;br/&gt;10.1.8.10&quot;]
        Worker3[&quot;worker3&lt;br/&gt;10.1.8.11&quot;]
    end

    subgraph &quot;ContainerLab&quot;
        BR1[&quot;bridge1&lt;br/&gt;10.1.5.0/24&quot;]
        BR2[&quot;bridge2&lt;br/&gt;10.1.8.0/24&quot;]
        Router[&quot;clab-gw0&lt;br/&gt;路由器&quot;]
    end

    Control &amp; Worker1 --&gt; BR1
    Worker2 &amp; Worker3 --&gt; BR2
    BR1 --&gt; Router
    Router --&gt; BR2
</code></pre></div>
<h4 id="3732">37.3.2 路由器配置<a class="headerlink" href="#3732" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># ContainerLab 路由器配置</span>
interface<span class="w"> </span>net0
<span class="w">  </span>ip<span class="w"> </span>address<span class="w"> </span><span class="m">10</span>.1.5.1/24

interface<span class="w"> </span>net1<span class="w">  </span>
<span class="w">  </span>ip<span class="w"> </span>address<span class="w"> </span><span class="m">10</span>.1.8.1/24

<span class="c1"># SNAT for internet access</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-o<span class="w"> </span>eth0<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
</code></pre></div>
<h3 id="374">37.4 同网段通信验证<a class="headerlink" href="#374" title="Permanent link">&para;</a></h3>
<h4 id="3741">37.4.1 测试场景<a class="headerlink" href="#3741" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 从 control-plane (10.1.5.10) 上的 Pod</span>
<span class="c1"># ping worker1 (10.1.5.11) 上的 Pod</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>pod-on-control<span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span>&lt;pod-on-worker1-ip&gt;
</code></pre></div>
<h4 id="3742">37.4.2 抓包分析<a class="headerlink" href="#3742" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 control-plane 节点的 net0 接口抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>net0<span class="w"> </span>-nn<span class="w"> </span>icmp

<span class="c1"># 输出示例</span>
<span class="c1"># 10.244.1.69 &gt; 10.244.175.1: ICMP echo request</span>
<span class="c1"># 10.244.175.1 &gt; 10.244.1.69: ICMP echo reply</span>
</code></pre></div>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>无 VxLAN 封装</strong></li>
<li><strong>裸 ICMP 包</strong></li>
<li><strong>MAC 地址逐跳变化</strong>（标准路由行为）</li>
</ul>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1 (10.244.1.69)
    participant Node1 as Node1 (10.1.5.10)
    participant Node2 as Node2 (10.1.5.11)
    participant Pod2 as Pod2 (10.244.175.1)

    Pod1-&gt;&gt;Node1: SRC MAC: Pod1&lt;br/&gt;DST MAC: 网关(ee:ee...)
    Node1-&gt;&gt;Node2: SRC MAC: Node1 net0&lt;br/&gt;DST MAC: Node2 net0
    Node2-&gt;&gt;Pod2: DST MAC: Pod2 veth
</code></pre></div>
<h3 id="375">37.5 跨网段通信验证<a class="headerlink" href="#375" title="Permanent link">&para;</a></h3>
<h4 id="3751">37.5.1 测试场景<a class="headerlink" href="#3751" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 从 control-plane (10.1.5.10) 上的 Pod</span>
<span class="c1"># ping worker2 (10.1.8.10) 上的 Pod</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>pod-on-control<span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span>&lt;pod-on-worker2-ip&gt;
</code></pre></div>
<h4 id="3752">37.5.2 抓包分析<a class="headerlink" href="#3752" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 抓 VxLAN 包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>net0<span class="w"> </span>-nn<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">4789</span><span class="w"> </span>-w<span class="w"> </span>vxlan-cross.pcap
</code></pre></div>
<p><strong>Wireshark 分析</strong>：</p>
<div class="highlight"><pre><span></span><code>Frame: 外层 Ethernet
├── SRC MAC: control-plane net0
├── DST MAC: router interface
├── Outer IP Header
│   ├── SRC: 10.1.5.10 (control-plane)
│   └── DST: 10.1.8.10 (worker2)
├── UDP Header
│   ├── SRC Port: random
│   └── DST Port: 4789
├── VxLAN Header
│   └── VNI: 4096
└── Inner Frame
    ├── Inner Ethernet
    │   ├── SRC MAC: vxlan.calico (local)
    │   └── DST MAC: vxlan.calico (remote)
    └── Inner IP
        ├── SRC: 10.244.1.69 (Pod1)
        └── DST: 10.244.73.x (Pod2)
</code></pre></div>
<h3 id="376-ipip-crosssubnet">37.6 与 IPIP CrossSubnet 对比<a class="headerlink" href="#376-ipip-crosssubnet" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">IPIP CrossSubnet</th>
<th style="text-align: left;">VxLAN CrossSubnet</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>同网段</strong></td>
<td style="text-align: left;">路由</td>
<td style="text-align: left;">路由</td>
</tr>
<tr>
<td style="text-align: left;"><strong>跨网段</strong></td>
<td style="text-align: left;">IP-in-IP 封装</td>
<td style="text-align: left;">VxLAN 封装</td>
</tr>
<tr>
<td style="text-align: left;"><strong>封装开销</strong></td>
<td style="text-align: left;">20 字节</td>
<td style="text-align: left;">50 字节</td>
</tr>
<tr>
<td style="text-align: left;"><strong>协议</strong></td>
<td style="text-align: left;">IP Protocol 4</td>
<td style="text-align: left;">UDP 4789</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BGP 依赖</strong></td>
<td style="text-align: left;">需要 bird</td>
<td style="text-align: left;">不需要</td>
</tr>
<tr>
<td style="text-align: left;"><strong>FDB 表</strong></td>
<td style="text-align: left;">不需要</td>
<td style="text-align: left;">需要</td>
</tr>
<tr>
<td style="text-align: left;"><strong>防火墙</strong></td>
<td style="text-align: left;">可能受阻</td>
<td style="text-align: left;">UDP 易穿透</td>
</tr>
</tbody>
</table>
<h3 id="377-overlay">37.7 Overlay 的安全性优势<a class="headerlink" href="#377-overlay" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;路由模式&quot;
        Pod1R[&quot;Pod&lt;br/&gt;10.244.1.69&quot;] --&gt;|&quot;IP 暴露&quot;| Net1[&quot;外部网络&quot;]
    end

    subgraph &quot;Overlay 模式&quot;
        Pod1O[&quot;Pod&lt;br/&gt;10.244.1.69&quot;] --&gt;|&quot;封装在节点 IP 内&quot;| Net2[&quot;外部网络&quot;]
        Note[&quot;外部只看到&lt;br/&gt;节点 IP&quot;]
    end
</code></pre></div>
<p><strong>Overlay 安全优势</strong>：</p>
<ol>
<li><strong>Pod IP 隐藏</strong>：外部设备只看到节点 IP，不知道内部 Pod IP</li>
<li><strong>网络隔离</strong>：中间网络设备无法直接访问 Pod</li>
<li><strong>零改造成本</strong>：无需在外部网络配置 Pod 网段路由</li>
</ol>
<h3 id="378">37.8 故障排查<a class="headerlink" href="#378" title="Permanent link">&para;</a></h3>
<h4 id="3781">37.8.1 确认模式生效<a class="headerlink" href="#3781" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 IPPool 配置</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>ippool<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1"># 确认 vxlanMode</span>
spec:
<span class="w">  </span>vxlanMode:<span class="w"> </span>CrossSubnet
</code></pre></div>
<h4 id="3782">37.8.2 验证路由表<a class="headerlink" href="#3782" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 同网段节点 - 直接路由</span>
ip<span class="w"> </span>route<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>&lt;same-subnet-node-pod-cidr&gt;
<span class="c1"># 10.244.175.0/26 via 10.1.5.11 dev net0</span>

<span class="c1"># 跨网段节点 - VxLAN 路由</span>
ip<span class="w"> </span>route<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>&lt;cross-subnet-node-pod-cidr&gt;<span class="w">  </span>
<span class="c1"># 10.244.73.0/26 via 10.244.73.0 dev vxlan.calico onlink</span>
</code></pre></div>
<h4 id="3783">37.8.3 常见问题<a class="headerlink" href="#3783" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">原因</th>
<th style="text-align: left;">解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">跨网段不通</td>
<td style="text-align: left;">路由器未配置</td>
<td style="text-align: left;">确保三层设备能转发</td>
</tr>
<tr>
<td style="text-align: left;">FDB 表为空</td>
<td style="text-align: left;">CNI 未正常启动</td>
<td style="text-align: left;">重启 calico-node</td>
</tr>
<tr>
<td style="text-align: left;">同网段走 VxLAN</td>
<td style="text-align: left;">掩码配置错误</td>
<td style="text-align: left;">检查节点 IP/掩码</td>
</tr>
</tbody>
</table>
<h3 id="379">37.9 章节小结<a class="headerlink" href="#379" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((VxLAN CrossSubnet))
    原理
      同网段 直接路由
      跨网段 VxLAN
      自动判断
    配置
      vxlanMode CrossSubnet
      ipipMode Never
      禁用 bird
    验证
      同网段 普通 ICMP
      跨网段 UDP 4789
      Wireshark 分析
    优势
      性能与兼容平衡
      overlay 安全
      零改造成本
    对比
      vs Always
      vs IPIP CrossSubnet
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>VxLAN CrossSubnet 要点总结</strong>：</p>
<ol>
<li><strong>核心原理</strong>：</li>
<li>同网段走路由（高性能）</li>
<li>跨网段走 VxLAN（兼容性好）</li>
<li>
<p>Calico 根据节点 IP/掩码自动判断</p>
</li>
<li>
<p><strong>配置</strong>：<code>vxlanMode: CrossSubnet</code></p>
</li>
<li>
<p><strong>验证方法</strong>：</p>
</li>
<li>同网段：<code>tcpdump -i net0 icmp</code>（普通包）</li>
<li>
<p>跨网段：<code>tcpdump -i net0 udp port 4789</code>（VxLAN 包）</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
</li>
<li>多机架/多网段的生产环境</li>
<li>追求性能与兼容性平衡</li>
<li>
<p>不想改造外部网络</p>
</li>
<li>
<p><strong>生产建议</strong>：节点数 &lt;200 时推荐使用</p>
</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-bgp-fullmesh">第三十八章 Calico-BGP-Fullmesh 模式<a class="headerlink" href="#calico-bgp-fullmesh" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico 的 BGP Fullmesh 模式，这是 Calico 最"原生"的网络方案——不使用任何 overlay 封装，完全依赖 BGP 协议进行路由通告。</p>
<h3 id="381">38.1 背景与概述<a class="headerlink" href="#381" title="Permanent link">&para;</a></h3>
<h4 id="3811-bgp">38.1.1 BGP 基础回顾<a class="headerlink" href="#3811-bgp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;AS 64512&quot;
        Node1[&quot;Node1&quot;]
        Node2[&quot;Node2&quot;]
        Node3[&quot;Node3&quot;]
    end

    Node1 &lt;--&gt;|&quot;iBGP&quot;| Node2
    Node2 &lt;--&gt;|&quot;iBGP&quot;| Node3
    Node1 &lt;--&gt;|&quot;iBGP&quot;| Node3
</code></pre></div>
<p><strong>BGP 核心概念</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">概念</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>AS (自治系统)</strong></td>
<td style="text-align: left;">统一管理的网络域</td>
</tr>
<tr>
<td style="text-align: left;"><strong>iBGP</strong></td>
<td style="text-align: left;">同一 AS 内的 BGP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>eBGP</strong></td>
<td style="text-align: left;">不同 AS 间的 BGP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>水平分割</strong></td>
<td style="text-align: left;">iBGP 学到的路由不再通告给其他 iBGP peer</td>
</tr>
<tr>
<td style="text-align: left;"><strong>TCP 179</strong></td>
<td style="text-align: left;">BGP 使用 TCP 179 端口建立会话</td>
</tr>
</tbody>
</table>
<h4 id="3812-fullmesh">38.1.2 为什么需要 Fullmesh<a class="headerlink" href="#3812-fullmesh" title="Permanent link">&para;</a></h4>
<p>由于 <strong>BGP 水平分割规则</strong>：</p>
<ul>
<li>iBGP peer 学到的路由不会通告给其他 iBGP peer</li>
<li>要让所有节点学到完整路由，必须<strong>两两建立 BGP 邻居关系</strong></li>
<li>这就是 <strong>Fullmesh（全网状连接）</strong></li>
</ul>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;3 节点 Fullmesh&quot;
        A[&quot;Node A&quot;] &lt;--&gt;|&quot;BGP&quot;| B[&quot;Node B&quot;]
        B &lt;--&gt;|&quot;BGP&quot;| C[&quot;Node C&quot;]
        A &lt;--&gt;|&quot;BGP&quot;| C
    end

    subgraph &quot;连接数计算&quot;
        Formula[&quot;N*(N-1)/2&lt;br/&gt;3 节点 = 3 条连接&quot;]
    end
</code></pre></div>
<h4 id="3813-fullmesh">38.1.3 Fullmesh 的适用场景<a class="headerlink" href="#3813-fullmesh" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">节点数</th>
<th style="text-align: left;">连接数</th>
<th style="text-align: left;">推荐方案</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">10</td>
<td style="text-align: left;">45</td>
<td style="text-align: left;">Fullmesh ✅</td>
</tr>
<tr>
<td style="text-align: left;">50</td>
<td style="text-align: left;">1,225</td>
<td style="text-align: left;">Fullmesh ✅</td>
</tr>
<tr>
<td style="text-align: left;">100</td>
<td style="text-align: left;">4,950</td>
<td style="text-align: left;">Fullmesh ✅</td>
</tr>
<tr>
<td style="text-align: left;"><strong>200</strong></td>
<td style="text-align: left;">19,900</td>
<td style="text-align: left;"><strong>边界</strong></td>
</tr>
<tr>
<td style="text-align: left;">500</td>
<td style="text-align: left;">124,750</td>
<td style="text-align: left;">Route Reflector ✅</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>官方建议</strong>：</p>
<ul>
<li>节点数 <strong>&lt; 200</strong>：使用 Fullmesh</li>
<li>节点数 <strong>≥ 200</strong>：使用 Route Reflector (RR)</li>
</ul>
</blockquote>
<h3 id="382-fullmesh-vs-overlay">38.2 Fullmesh vs Overlay<a class="headerlink" href="#382-fullmesh-vs-overlay" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">BGP Fullmesh</th>
<th style="text-align: left;">IPIP/VxLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>封装</strong></td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">有</td>
</tr>
<tr>
<td style="text-align: left;"><strong>性能</strong></td>
<td style="text-align: left;">最高</td>
<td style="text-align: left;">有开销</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MTU</strong></td>
<td style="text-align: left;">无损失</td>
<td style="text-align: left;">有损失</td>
</tr>
<tr>
<td style="text-align: left;"><strong>外部路由</strong></td>
<td style="text-align: left;">需要配合</td>
<td style="text-align: left;">无需</td>
</tr>
<tr>
<td style="text-align: left;"><strong>复杂度</strong></td>
<td style="text-align: left;">高</td>
<td style="text-align: left;">低</td>
</tr>
<tr>
<td style="text-align: left;"><strong>调试</strong></td>
<td style="text-align: left;">需了解 BGP</td>
<td style="text-align: left;">相对简单</td>
</tr>
</tbody>
</table>
<h3 id="383">38.3 配置详解<a class="headerlink" href="#383" title="Permanent link">&para;</a></h3>
<h4 id="3831-ippool">38.3.1 IPPool 配置<a class="headerlink" href="#3831-ippool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w">              </span><span class="c1"># 禁用 IPIP</span>
<span class="w">  </span><span class="nt">vxlanMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w">             </span><span class="c1"># 禁用 VxLAN</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>关键配置</strong>：</p>
<ul>
<li><code>ipipMode: Never</code> — 禁用 IPIP 封装</li>
<li><code>vxlanMode: Never</code> — 禁用 VxLAN 封装</li>
<li>禁用 overlay 后，Calico 自动使用 BGP 路由</li>
</ul>
</blockquote>
<h4 id="3832-bgp">38.3.2 BGP 配置（默认）<a class="headerlink" href="#3832-bgp" title="Permanent link">&para;</a></h4>
<p>Calico 默认启用 BGP Fullmesh：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BGPConfiguration</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeToNodeMeshEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">   </span><span class="c1"># 启用 Fullmesh</span>
<span class="w">  </span><span class="nt">asNumber</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64512</span><span class="w">               </span><span class="c1"># 默认 AS 号</span>
</code></pre></div>
<h3 id="384">38.4 路由分析<a class="headerlink" href="#384" title="Permanent link">&para;</a></h3>
<h4 id="3841">38.4.1 路由表特征<a class="headerlink" href="#3841" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看路由表</span>
ip<span class="w"> </span>route<span class="w"> </span>show

<span class="c1"># 输出示例</span>
<span class="m">10</span>.244.73.128/26<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.2<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>bird
<span class="m">10</span>.244.83.128/26<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.3<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>bird
</code></pre></div>
<p><strong>关键特征</strong>：</p>
<ul>
<li><strong>proto bird</strong>：路由由 bird 进程（BGP daemon）维护</li>
<li><strong>下一跳是 peer 节点 IP</strong>：直接路由到对端节点</li>
<li><strong>无 tunl0/vxlan.calico</strong>：不使用隧道设备</li>
</ul>
<h4 id="3842-overlay">38.4.2 与 Overlay 路由对比<a class="headerlink" href="#3842-overlay" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">路由示例</th>
<th style="text-align: left;">设备</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">BGP</td>
<td style="text-align: left;"><code>via 172.18.0.2 dev eth0 proto bird</code></td>
<td style="text-align: left;">eth0</td>
</tr>
<tr>
<td style="text-align: left;">IPIP</td>
<td style="text-align: left;"><code>via 172.18.0.2 dev tunl0 proto bird onlink</code></td>
<td style="text-align: left;">tunl0</td>
</tr>
<tr>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;"><code>via 10.244.73.0 dev vxlan.calico onlink</code></td>
<td style="text-align: left;">vxlan.calico</td>
</tr>
</tbody>
</table>
<h3 id="385-bgp">38.5 BGP 状态查看<a class="headerlink" href="#385-bgp" title="Permanent link">&para;</a></h3>
<h4 id="3851-calicoctl-node-status">38.5.1 calicoctl node status<a class="headerlink" href="#3851-calicoctl-node-status" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 BGP peer 状态</span>
calicoctl<span class="w"> </span>node<span class="w"> </span>status

<span class="c1"># 输出示例</span>
Calico<span class="w"> </span>process<span class="w"> </span>is<span class="w"> </span>running.

IPv4<span class="w"> </span>BGP<span class="w"> </span>status
+----------------+-------------------+-------+----------+-------------+
<span class="p">|</span><span class="w"> </span>PEER<span class="w"> </span>ADDRESS<span class="w">   </span><span class="p">|</span><span class="w"> </span>PEER<span class="w"> </span>TYPE<span class="w">         </span><span class="p">|</span><span class="w"> </span>STATE<span class="w"> </span><span class="p">|</span><span class="w"> </span>SINCE<span class="w">    </span><span class="p">|</span><span class="w"> </span>INFO<span class="w">        </span><span class="p">|</span>
+----------------+-------------------+-------+----------+-------------+
<span class="p">|</span><span class="w"> </span><span class="m">172</span>.18.0.2<span class="w">     </span><span class="p">|</span><span class="w"> </span>node-to-node<span class="w"> </span>mesh<span class="w"> </span><span class="p">|</span><span class="w"> </span>up<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="m">10</span>:30:00<span class="w"> </span><span class="p">|</span><span class="w"> </span>Established<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">172</span>.18.0.3<span class="w">     </span><span class="p">|</span><span class="w"> </span>node-to-node<span class="w"> </span>mesh<span class="w"> </span><span class="p">|</span><span class="w"> </span>up<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="m">10</span>:30:00<span class="w"> </span><span class="p">|</span><span class="w"> </span>Established<span class="w"> </span><span class="p">|</span>
+----------------+-------------------+-------+----------+-------------+
</code></pre></div>
<p><strong>字段说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">PEER ADDRESS</td>
<td style="text-align: left;">BGP 邻居 IP</td>
</tr>
<tr>
<td style="text-align: left;">PEER TYPE</td>
<td style="text-align: left;"><code>node-to-node mesh</code> = Fullmesh</td>
</tr>
<tr>
<td style="text-align: left;">STATE</td>
<td style="text-align: left;"><code>up</code> = 正常</td>
</tr>
<tr>
<td style="text-align: left;">INFO</td>
<td style="text-align: left;"><code>Established</code> = TCP 179 连接已建立</td>
</tr>
</tbody>
</table>
<h4 id="3852-tcp-179">38.5.2 验证 TCP 179 连接<a class="headerlink" href="#3852-tcp-179" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 BGP 端口连接</span>
netstat<span class="w"> </span>-an<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">179</span>

<span class="c1"># 输出</span>
tcp<span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w"> </span><span class="m">172</span>.18.0.4:179<span class="w">   </span><span class="m">172</span>.18.0.2:xxxxx<span class="w">   </span>ESTABLISHED
tcp<span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w"> </span><span class="m">172</span>.18.0.4:179<span class="w">   </span><span class="m">172</span>.18.0.3:xxxxx<span class="w">   </span>ESTABLISHED
</code></pre></div>
<h3 id="386-bird">38.6 bird 命令详解<a class="headerlink" href="#386-bird" title="Permanent link">&para;</a></h3>
<h4 id="3861-bird">38.6.1 进入 bird 控制台<a class="headerlink" href="#3861-bird" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 进入 calico-node Pod</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>calico-node-xxxxx<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>--<span class="w"> </span>/bin/sh

<span class="c1"># 进入 bird 控制台</span>
birdcl
<span class="c1"># 或</span>
birdc
</code></pre></div>
<h4 id="3862-bird">38.6.2 常用 bird 命令<a class="headerlink" href="#3862-bird" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看接口</span>
birdc&gt;<span class="w"> </span>show<span class="w"> </span>interfaces

<span class="c1"># 查看路由表</span>
birdc&gt;<span class="w"> </span>show<span class="w"> </span>route

<span class="c1"># 查看 BGP 协议路由</span>
birdc&gt;<span class="w"> </span>show<span class="w"> </span>route<span class="w"> </span>protocol<span class="w"> </span>Mesh_172_18_0_2

<span class="c1"># 查看协议状态</span>
birdc&gt;<span class="w"> </span>show<span class="w"> </span>protocols
</code></pre></div>
<p><strong>show route 输出示例</strong>：</p>
<div class="highlight"><pre><span></span><code>10.244.73.128/26   via 172.18.0.2 on eth0 [Mesh_172_18_0_2 10:30:00] * (100/0) [i]
10.244.83.128/26   via 172.18.0.3 on eth0 [Mesh_172_18_0_3 10:30:00] * (100/0) [i]
</code></pre></div>
<h3 id="387-as-number">38.7 AS Number 与配置文件<a class="headerlink" href="#387-as-number" title="Permanent link">&para;</a></h3>
<h4 id="3871-as-number">38.7.1 查看 AS Number<a class="headerlink" href="#3871-as-number" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 通过 calicoctl</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>asNumber

<span class="c1"># 或查看 BGPConfiguration</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>bgpconfig<span class="w"> </span>default<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<h4 id="3872-bird">38.7.2 bird 配置文件<a class="headerlink" href="#3872-bird" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 配置文件位置</span>
cat<span class="w"> </span>/etc/calico/confd/config/bird.cfg
</code></pre></div>
<div class="highlight"><pre><span></span><code># bird.cfg 示例
router id 172.18.0.4;

protocol bgp Mesh_172_18_0_2 {
  local as 64512;
  neighbor 172.18.0.2 as 64512;
  # ... 
}

protocol bgp Mesh_172_18_0_3 {
  local as 64512;
  neighbor 172.18.0.3 as 64512;
  # ...
}
</code></pre></div>
<h3 id="388">38.8 抓包验证<a class="headerlink" href="#388" title="Permanent link">&para;</a></h3>
<h4 id="3881-pod">38.8.1 跨节点 Pod 通信<a class="headerlink" href="#3881-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>icmp

<span class="c1"># 输出示例</span>
<span class="m">172</span>.18.0.4<span class="w"> </span>&gt;<span class="w"> </span><span class="m">172</span>.18.0.2:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request
<span class="c1"># 注意：这是节点 IP，不是 Pod IP！</span>
</code></pre></div>
<p><strong>实际抓包</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod 间 ping</span>
<span class="m">10</span>.244.140.132<span class="w"> </span>&gt;<span class="w"> </span><span class="m">10</span>.244.88.128:<span class="w"> </span>ICMP<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>request
</code></pre></div>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>无封装</strong>：直接看到 Pod IP</li>
<li><strong>MAC 地址变化</strong>：每跳变化</li>
<li><strong>纯三层转发</strong></li>
</ul>
<h3 id="389-route-reflector">38.9 Route Reflector 简介<a class="headerlink" href="#389-route-reflector" title="Permanent link">&para;</a></h3>
<p>当节点数超过 200 时，应使用 Route Reflector：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Route Reflector 模式&quot;
        RR1[&quot;RR1&quot;]
        RR2[&quot;RR2&quot;]
        RR1 &lt;--&gt;|&quot;Mesh&quot;| RR2

        Client1[&quot;Node1&quot;] --&gt; RR1
        Client2[&quot;Node2&quot;] --&gt; RR1
        Client3[&quot;Node3&quot;] --&gt; RR2
        Client4[&quot;Node4&quot;] --&gt; RR2
    end
</code></pre></div>
<p><strong>RR 优势</strong>：</p>
<ul>
<li>RR 之间 Fullmesh（少量连接）</li>
<li>普通节点只连接 RR（减少连接数）</li>
<li>多 RR 保证高可用</li>
</ul>
<h3 id="3810">38.10 章节小结<a class="headerlink" href="#3810" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((BGP Fullmesh))
    原理
      水平分割
      两两建立 peer
      N*(N-1)/2
    配置
      ipipMode Never
      vxlanMode Never
      nodeToNodeMesh true
    验证
      calicoctl node status
      ip route proto bird
      birdc show route
    特点
      无封装
      最高性能
      无 MTU 损失
    限制
      小于 200 节点
      超过用 RR
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>BGP Fullmesh 要点总结</strong>：</p>
<ol>
<li><strong>核心原理</strong>：</li>
<li>BGP 水平分割 → 需要 Fullmesh</li>
<li>连接数：N*(N-1)/2</li>
<li>
<p>官方建议：&lt;200 节点</p>
</li>
<li>
<p><strong>配置</strong>：禁用 IPIP/VxLAN，默认启用 BGP</p>
</li>
<li>
<p><strong>关键命令</strong>：</p>
</li>
<li><code>calicoctl node status</code> — 查看 BGP peer</li>
<li><code>ip route</code> — 看到 <code>proto bird</code></li>
<li>
<p><code>birdc show route</code> — BGP 路由详情</p>
</li>
<li>
<p><strong>抓包特点</strong>：无封装，直接看到 Pod IP</p>
</li>
<li>
<p><strong>生产建议</strong>：</p>
</li>
<li>小集群：Fullmesh</li>
<li>大集群：Route Reflector</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-bgp-rr">第三十九章 Calico-BGP-RR 模式<a class="headerlink" href="#calico-bgp-rr" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico 的 BGP Route Reflector (RR) 模式，这是大规模集群（&gt;200 节点）的推荐 BGP 方案，采用 AS per Rack 拓扑设计。</p>
<h3 id="391">39.1 背景与概述<a class="headerlink" href="#391" title="Permanent link">&para;</a></h3>
<h4 id="3911-route-reflector">39.1.1 为什么需要 Route Reflector<a class="headerlink" href="#3911-route-reflector" title="Permanent link">&para;</a></h4>
<p>回顾 Fullmesh 的问题：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">节点数</th>
<th style="text-align: left;">Fullmesh 连接数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">100</td>
<td style="text-align: left;">4,950</td>
</tr>
<tr>
<td style="text-align: left;">200</td>
<td style="text-align: left;">19,900</td>
</tr>
<tr>
<td style="text-align: left;">500</td>
<td style="text-align: left;">124,750</td>
</tr>
<tr>
<td style="text-align: left;">1000</td>
<td style="text-align: left;">499,500</td>
</tr>
</tbody>
</table>
<p><strong>Route Reflector 解决方案</strong>：</p>
<ul>
<li><strong>RR 节点</strong>：接收所有路由，反射给所有客户端</li>
<li><strong>客户端</strong>：只与 RR 建立连接</li>
<li><strong>连接数</strong>：从 N*(N-1)/2 降低到 N</li>
</ul>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Route Reflector 模式&quot;
        RR[&quot;Route Reflector&lt;br/&gt;Leaf Switch&quot;]

        Client1[&quot;Node1&lt;br/&gt;RR Client&quot;] --&gt; RR
        Client2[&quot;Node2&lt;br/&gt;RR Client&quot;] --&gt; RR
        Client3[&quot;Node3&lt;br/&gt;RR Client&quot;] --&gt; RR
        Client4[&quot;Node4&lt;br/&gt;RR Client&quot;] --&gt; RR
    end
</code></pre></div>
<h4 id="3912-as-per-rack">39.1.2 AS per Rack 拓扑<a class="headerlink" href="#3912-as-per-rack" title="Permanent link">&para;</a></h4>
<p>生产环境推荐的 Leaf-Spine 架构：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Spine Layer&quot;
        Spine0[&quot;Spine0&lt;br/&gt;AS 500&quot;]
        Spine1[&quot;Spine1&lt;br/&gt;AS 800&quot;]
    end

    subgraph &quot;Leaf Layer&quot;
        Leaf0[&quot;Leaf0&lt;br/&gt;AS 65005&quot;]
        Leaf1[&quot;Leaf1&lt;br/&gt;AS 65008&quot;]
    end

    subgraph &quot;Rack0 - 10.1.5.0/24&quot;
        Node1[&quot;Node1&lt;br/&gt;10.1.5.10&quot;]
        Node2[&quot;Node2&lt;br/&gt;10.1.5.11&quot;]
    end

    subgraph &quot;Rack1 - 10.1.8.0/24&quot;
        Node3[&quot;Node3&lt;br/&gt;10.1.8.10&quot;]
        Node4[&quot;Node4&lt;br/&gt;10.1.8.11&quot;]
    end

    Spine0 &lt;--&gt;|&quot;eBGP&quot;| Leaf0
    Spine0 &lt;--&gt;|&quot;eBGP&quot;| Leaf1
    Spine1 &lt;--&gt;|&quot;eBGP&quot;| Leaf0
    Spine1 &lt;--&gt;|&quot;eBGP&quot;| Leaf1

    Node1 --&gt;|&quot;iBGP&quot;| Leaf0
    Node2 --&gt;|&quot;iBGP&quot;| Leaf0
    Node3 --&gt;|&quot;iBGP&quot;| Leaf1
    Node4 --&gt;|&quot;iBGP&quot;| Leaf1
</code></pre></div>
<p><strong>架构说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">层级</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Spine</strong></td>
<td style="text-align: left;">核心交换机，eBGP 互联</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Leaf</strong></td>
<td style="text-align: left;">接入交换机，作为 RR</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Node</strong></td>
<td style="text-align: left;">K8s 节点，RR Client</td>
</tr>
<tr>
<td style="text-align: left;"><strong>iBGP</strong></td>
<td style="text-align: left;">同 AS 内部（Node ↔ Leaf）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>eBGP</strong></td>
<td style="text-align: left;">不同 AS 之间（Leaf ↔ Spine）</td>
</tr>
</tbody>
</table>
<h3 id="392">39.2 配置详解<a class="headerlink" href="#392" title="Permanent link">&para;</a></h3>
<h4 id="3921-node-to-node-mesh">39.2.1 禁用 Node-to-Node Mesh<a class="headerlink" href="#3921-node-to-node-mesh" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BGPConfiguration</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeToNodeMeshEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">    </span><span class="c1"># 关闭 Fullmesh！</span>
<span class="w">  </span><span class="nt">asNumber</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65005</span>
</code></pre></div>
<p>或通过命令：</p>
<div class="highlight"><pre><span></span><code>calicoctl<span class="w"> </span>patch<span class="w"> </span>bgpconfig<span class="w"> </span>default<span class="w"> </span>-p<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;{&quot;spec&quot;: {&quot;nodeToNodeMeshEnabled&quot;: false}}&#39;</span>
</code></pre></div>
<h4 id="3922-bgp">39.2.2 配置节点 BGP 属性<a class="headerlink" href="#3922-bgp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Node</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rack</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rack0</span><span class="w">    </span><span class="c1"># 机架标签</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bgp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ipv4Address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.1.5.10/24</span>
<span class="w">    </span><span class="nt">asNumber</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65005</span>
</code></pre></div>
<h4 id="3923-bgp-peer">39.2.3 创建 BGP Peer<a class="headerlink" href="#3923-bgp-peer" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BGPPeer</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rack0-to-leaf0</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">peerIP</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.1.5.1</span><span class="w">              </span><span class="c1"># Leaf 交换机 IP</span>
<span class="w">  </span><span class="nt">asNumber</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65005</span><span class="w">               </span><span class="c1"># 同 AS = iBGP</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rack == &#39;rack0&#39;</span><span class="w"> </span><span class="c1"># 只匹配 rack0 的节点</span>
</code></pre></div>
<p><strong>nodeSelector 机制</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看节点标签</span>
kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>--show-labels<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>rack

<span class="c1"># 输出</span>
node1<span class="w">  </span><span class="nv">rack</span><span class="o">=</span>rack0
node2<span class="w">  </span><span class="nv">rack</span><span class="o">=</span>rack0
node3<span class="w">  </span><span class="nv">rack</span><span class="o">=</span>rack1
node4<span class="w">  </span><span class="nv">rack</span><span class="o">=</span>rack1
</code></pre></div>
<h3 id="393-leaf">39.3 Leaf 交换机配置<a class="headerlink" href="#393-leaf" title="Permanent link">&para;</a></h3>
<h4 id="3931-vyos">39.3.1 VyOS 配置示例<a class="headerlink" href="#3931-vyos" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Leaf0 配置</span>
<span class="nb">set</span><span class="w"> </span>interfaces<span class="w"> </span>ethernet<span class="w"> </span>eth0<span class="w"> </span>address<span class="w"> </span><span class="m">10</span>.1.5.1/24
<span class="nb">set</span><span class="w"> </span>interfaces<span class="w"> </span>ethernet<span class="w"> </span>eth1<span class="w"> </span>address<span class="w"> </span><span class="m">10</span>.1.10.2/24<span class="w">  </span><span class="c1"># to Spine0</span>
<span class="nb">set</span><span class="w"> </span>interfaces<span class="w"> </span>ethernet<span class="w"> </span>eth2<span class="w"> </span>address<span class="w"> </span><span class="m">10</span>.1.12.2/24<span class="w">  </span><span class="c1"># to Spine1</span>

<span class="c1"># BGP 配置</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>router-id<span class="w"> </span><span class="m">10</span>.1.5.1

<span class="c1"># 宣告本地网段</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>network<span class="w"> </span><span class="m">10</span>.1.5.0/24

<span class="c1"># 配置 RR Client (iBGP)</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>neighbor<span class="w"> </span><span class="m">10</span>.1.5.10<span class="w"> </span>remote-as<span class="w"> </span><span class="m">65005</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>neighbor<span class="w"> </span><span class="m">10</span>.1.5.10<span class="w"> </span>route-reflector-client
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>neighbor<span class="w"> </span><span class="m">10</span>.1.5.11<span class="w"> </span>remote-as<span class="w"> </span><span class="m">65005</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>neighbor<span class="w"> </span><span class="m">10</span>.1.5.11<span class="w"> </span>route-reflector-client

<span class="c1"># 配置 eBGP (to Spine)</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>neighbor<span class="w"> </span><span class="m">10</span>.1.10.1<span class="w"> </span>remote-as<span class="w"> </span><span class="m">500</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>neighbor<span class="w"> </span><span class="m">10</span>.1.12.1<span class="w"> </span>remote-as<span class="w"> </span><span class="m">800</span>

<span class="c1"># SNAT for Internet</span>
<span class="nb">set</span><span class="w"> </span>nat<span class="w"> </span><span class="nb">source</span><span class="w"> </span>rule<span class="w"> </span><span class="m">10</span><span class="w"> </span>outbound-interface<span class="w"> </span>eth0
<span class="nb">set</span><span class="w"> </span>nat<span class="w"> </span><span class="nb">source</span><span class="w"> </span>rule<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>address<span class="w"> </span><span class="m">10</span>.1.5.0/24
<span class="nb">set</span><span class="w"> </span>nat<span class="w"> </span><span class="nb">source</span><span class="w"> </span>rule<span class="w"> </span><span class="m">10</span><span class="w"> </span>translation<span class="w"> </span>address<span class="w"> </span>masquerade
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>关键配置</strong>：</p>
<ul>
<li><code>route-reflector-client</code>：指定节点为 RR 客户端</li>
<li>同 AS（65005）= iBGP</li>
<li>不同 AS（500, 800）= eBGP</li>
</ul>
</blockquote>
<h3 id="394-ecmp">39.4 ECMP 等价多路径<a class="headerlink" href="#394-ecmp" title="Permanent link">&para;</a></h3>
<h4 id="3941-ecmp">39.4.1 什么是 ECMP<a class="headerlink" href="#3941-ecmp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Rack0&quot;
        Pod1[&quot;Pod&quot;]
    end

    subgraph &quot;Spine&quot;
        Spine0[&quot;Spine0&quot;]
        Spine1[&quot;Spine1&quot;]
    end

    subgraph &quot;Rack1&quot;
        Pod2[&quot;Pod&quot;]
    end

    Pod1 --&gt;|&quot;Path1&quot;| Spine0 --&gt; Pod2
    Pod1 --&gt;|&quot;Path2&quot;| Spine1 --&gt; Pod2
</code></pre></div>
<p><strong>ECMP (Equal Cost Multi-Path)</strong>：</p>
<ul>
<li>等价开销多路径</li>
<li>多条路径同时使用</li>
<li>负载分担 + 故障备份</li>
</ul>
<h4 id="3942-vyos-ecmp">39.4.2 VyOS ECMP 配置<a class="headerlink" href="#3942-vyos-ecmp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 启用 ECMP</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>maximum-paths<span class="w"> </span>ebgp<span class="w"> </span><span class="m">2</span>
<span class="nb">set</span><span class="w"> </span>protocols<span class="w"> </span>bgp<span class="w"> </span><span class="m">65005</span><span class="w"> </span>maximum-paths<span class="w"> </span>ibgp<span class="w"> </span><span class="m">2</span>
</code></pre></div>
<h4 id="3943-ecmp">39.4.3 验证 ECMP<a class="headerlink" href="#3943-ecmp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看路由表</span>
show<span class="w"> </span>ip<span class="w"> </span>bgp

<span class="c1"># 输出示例</span>
<span class="w">   </span>Network<span class="w">          </span>Next<span class="w"> </span>Hop<span class="w">       </span>Metric<span class="w">  </span>Path
*&gt;<span class="w"> </span><span class="m">10</span>.1.8.0/24<span class="w">      </span><span class="m">10</span>.1.10.1<span class="w">      </span><span class="m">0</span><span class="w">       </span><span class="m">500</span><span class="w"> </span><span class="m">65008</span><span class="w"> </span>i
*<span class="o">=</span><span class="w">                  </span><span class="m">10</span>.1.12.1<span class="w">      </span><span class="m">0</span><span class="w">       </span><span class="m">800</span><span class="w"> </span><span class="m">65008</span><span class="w"> </span>i
</code></pre></div>
<ul>
<li><code>*&gt;</code> = 有效且最佳</li>
<li><code>*=</code> = 有效且等价（ECMP）</li>
</ul>
<h3 id="395">39.5 验证步骤<a class="headerlink" href="#395" title="Permanent link">&para;</a></h3>
<h4 id="3951-calicoctl-node-status">39.5.1 calicoctl node status<a class="headerlink" href="#3951-calicoctl-node-status" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>calicoctl<span class="w"> </span>node<span class="w"> </span>status

<span class="c1"># 输出</span>
IPv4<span class="w"> </span>BGP<span class="w"> </span>status
+----------------+---------------+-------+----------+-------------+
<span class="p">|</span><span class="w"> </span>PEER<span class="w"> </span>ADDRESS<span class="w">   </span><span class="p">|</span><span class="w"> </span>PEER<span class="w"> </span>TYPE<span class="w">     </span><span class="p">|</span><span class="w"> </span>STATE<span class="w"> </span><span class="p">|</span><span class="w"> </span>SINCE<span class="w">    </span><span class="p">|</span><span class="w"> </span>INFO<span class="w">        </span><span class="p">|</span>
+----------------+---------------+-------+----------+-------------+
<span class="p">|</span><span class="w"> </span><span class="m">10</span>.1.5.1<span class="w">       </span><span class="p">|</span><span class="w"> </span>node<span class="w"> </span>specific<span class="w"> </span><span class="p">|</span><span class="w"> </span>up<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="m">10</span>:30:00<span class="w"> </span><span class="p">|</span><span class="w"> </span>Established<span class="w"> </span><span class="p">|</span>
+----------------+---------------+-------+----------+-------------+
</code></pre></div>
<p><strong>关键变化</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Fullmesh</th>
<th style="text-align: left;">Route Reflector</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>node-to-node mesh</code></td>
<td style="text-align: left;"><code>node specific</code></td>
</tr>
<tr>
<td style="text-align: left;">多个 peer（所有节点）</td>
<td style="text-align: left;">单个 peer（仅 RR）</td>
</tr>
</tbody>
</table>
<h4 id="3952-tcp-179">39.5.2 验证 TCP 179<a class="headerlink" href="#3952-tcp-179" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>netstat<span class="w"> </span>-an<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">179</span>

<span class="c1"># 输出</span>
tcp<span class="w">  </span><span class="m">0</span><span class="w">  </span><span class="m">0</span><span class="w"> </span><span class="m">10</span>.1.5.10:xxxxx<span class="w">  </span><span class="m">10</span>.1.5.1:179<span class="w">  </span>ESTABLISHED
</code></pre></div>
<h4 id="3953-leaf-bgp">39.5.3 查看 Leaf 上的 BGP 状态<a class="headerlink" href="#3953-leaf-bgp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># VyOS</span>
show<span class="w"> </span>ip<span class="w"> </span>bgp<span class="w"> </span>summary

<span class="c1"># 输出</span>
Neighbor<span class="w">        </span>AS<span class="w">   </span>MsgRcvd<span class="w">  </span>MsgSent<span class="w">  </span>State/PfxRcd
<span class="m">10</span>.1.5.10<span class="w">    </span><span class="m">65005</span><span class="w">       </span><span class="m">100</span><span class="w">      </span><span class="m">100</span><span class="w">  </span>Established
<span class="m">10</span>.1.5.11<span class="w">    </span><span class="m">65005</span><span class="w">        </span><span class="m">98</span><span class="w">       </span><span class="m">98</span><span class="w">  </span>Established
<span class="m">10</span>.1.10.1<span class="w">      </span><span class="m">500</span><span class="w">       </span><span class="m">200</span><span class="w">      </span><span class="m">200</span><span class="w">  </span>Established
<span class="m">10</span>.1.12.1<span class="w">      </span><span class="m">800</span><span class="w">       </span><span class="m">195</span><span class="w">      </span><span class="m">195</span><span class="w">  </span>Established
</code></pre></div>
<h3 id="396-service-ip-advertisement">39.6 Service IP Advertisement<a class="headerlink" href="#396-service-ip-advertisement" title="Permanent link">&para;</a></h3>
<h4 id="3961-clusterip">39.6.1 宣告 ClusterIP<a class="headerlink" href="#3961-clusterip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BGPConfiguration</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeToNodeMeshEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">asNumber</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65005</span>
<span class="w">  </span><span class="nt">serviceClusterIPs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.96.0.0/16</span><span class="w">    </span><span class="c1"># ClusterIP 范围</span>
</code></pre></div>
<p>或通过命令：</p>
<div class="highlight"><pre><span></span><code>calicoctl<span class="w"> </span>patch<span class="w"> </span>bgpconfig<span class="w"> </span>default<span class="w"> </span>-p<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;{&quot;spec&quot;: {&quot;serviceClusterIPs&quot;: [{&quot;cidr&quot;: &quot;10.96.0.0/16&quot;}]}}&#39;</span>
</code></pre></div>
<h4 id="3962">39.6.2 验证路由传播<a class="headerlink" href="#3962" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Leaf 上查看</span>
show<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>bgp

<span class="c1"># 输出</span>
B<span class="w">    </span><span class="m">10</span>.96.0.0/16<span class="w"> </span><span class="o">[</span><span class="m">200</span>/0<span class="o">]</span><span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.5.10,<span class="w"> </span>eth0,<span class="w"> </span>...
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Spine 上查看</span>
show<span class="w"> </span>ip<span class="w"> </span>bgp<span class="w"> </span><span class="m">10</span>.96.0.0/16

<span class="c1"># 路由已传播</span>
</code></pre></div>
<p><strong>效果</strong>：外部设备可以直接通过 BGP 路由访问 ClusterIP！</p>
<h3 id="397">39.7 故障排查<a class="headerlink" href="#397" title="Permanent link">&para;</a></h3>
<h4 id="3971">39.7.1 常见问题<a class="headerlink" href="#3971" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">排查命令</th>
<th style="text-align: left;">解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">BGP 未建立</td>
<td style="text-align: left;"><code>calicoctl node status</code></td>
<td style="text-align: left;">检查 IP/AS 配置</td>
</tr>
<tr>
<td style="text-align: left;">路由缺失</td>
<td style="text-align: left;"><code>ip route</code></td>
<td style="text-align: left;">检查 BGP 宣告</td>
</tr>
<tr>
<td style="text-align: left;">ECMP 不生效</td>
<td style="text-align: left;"><code>show ip bgp</code></td>
<td style="text-align: left;">检查 maximum-paths</td>
</tr>
<tr>
<td style="text-align: left;">跨机架不通</td>
<td style="text-align: left;"><code>tcpdump</code></td>
<td style="text-align: left;">检查 Spine 转发</td>
</tr>
</tbody>
</table>
<h4 id="3972">39.7.2 调试命令<a class="headerlink" href="#3972" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 bird 日志</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>calico-node-xxxxx<span class="w"> </span>-c<span class="w"> </span>bird

<span class="c1"># 进入 bird 控制台</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>calico-node-xxxxx<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>--<span class="w"> </span>birdcl

<span class="c1"># 查看 BGP 路由</span>
birdc&gt;<span class="w"> </span>show<span class="w"> </span>route<span class="w"> </span>protocol<span class="w"> </span>Mesh_10_1_5_1
</code></pre></div>
<h3 id="398">39.8 二层隔离的安全优势<a class="headerlink" href="#398" title="Permanent link">&para;</a></h3>
<p>为什么使用不同网段（跨机架）：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Rack0 - 10.1.5.0/24&quot;
        Infected[&quot;感染节点&quot;]
        Healthy1[&quot;正常节点&quot;]
    end

    subgraph &quot;三层路由器&quot;
        Router[&quot;Router&lt;br/&gt;隔离广播&quot;]
    end

    subgraph &quot;Rack1 - 10.1.8.0/24&quot;
        Healthy2[&quot;正常节点&quot;]
        Healthy3[&quot;正常节点&quot;]
    end

    Infected -.-&gt;|&quot;广播风暴&quot;| Healthy1
    Infected -.-&gt;|&quot;被路由器阻断&quot;| Router
    Router -.-&gt;|&quot;隔离保护&quot;| Healthy2
</code></pre></div>
<p><strong>优势</strong>：</p>
<ul>
<li>广播域隔离</li>
<li>故障范围控制</li>
<li>安全性增强</li>
</ul>
<h3 id="399">39.9 章节小结<a class="headerlink" href="#399" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((BGP RR 模式))
    原理
      解决 Fullmesh 复杂度
      Leaf 作为 RR
      Node 作为 RR Client
    拓扑
      Leaf-Spine
      AS per Rack
      iBGP + eBGP
    配置
      nodeToNodeMesh false
      BGPPeer nodeSelector
      route-reflector-client
    ECMP
      等价多路径
      负载分担
      故障备份
    宣告
      Service ClusterIP
      外部可访问
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>BGP RR 模式要点总结</strong>：</p>
<ol>
<li><strong>核心原理</strong>：</li>
<li>Leaf 交换机作为 Route Reflector</li>
<li>K8s 节点作为 RR Client</li>
<li>
<p>连接数从 N² 降低到 N</p>
</li>
<li>
<p><strong>拓扑设计</strong>：</p>
</li>
<li>Leaf-Spine 架构</li>
<li>AS per Rack（每机架一个 AS）</li>
<li>
<p>iBGP（Node ↔ Leaf）+ eBGP（Leaf ↔ Spine）</p>
</li>
<li>
<p><strong>关键配置</strong>：</p>
</li>
<li><code>nodeToNodeMeshEnabled: false</code> — 禁用 Fullmesh</li>
<li><code>BGPPeer</code> + <code>nodeSelector</code> — 按机架配置</li>
<li>
<p><code>route-reflector-client</code> — Leaf 配置</p>
</li>
<li>
<p><strong>ECMP</strong>：等价多路径，实现负载分担和高可用</p>
</li>
<li>
<p><strong>Service 宣告</strong>：ClusterIP 可通过 BGP 向外宣告</p>
</li>
<li>
<p><strong>适用场景</strong>：大规模集群（&gt;200 节点）</p>
</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-ebpf-with-dsr">第四十章 Calico-eBPF-with-DSR 模式<a class="headerlink" href="#calico-ebpf-with-dsr" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico 的 eBPF 数据平面模式及 DSR（Direct Server Return）功能，这是一种高性能的替代方案，可以绑过 iptables 和 kube-proxy。</p>
<h3 id="401">40.1 背景与概述<a class="headerlink" href="#401" title="Permanent link">&para;</a></h3>
<h4 id="4011-ebpf">40.1.1 什么是 eBPF<a class="headerlink" href="#4011-ebpf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;传统方式&quot;
        App1[&quot;应用&quot;] --&gt; Kernel1[&quot;内核&quot;]
        Kernel1 --&gt; |&quot;修改需重编内核&quot;| Hardware1[&quot;硬件&quot;]
    end

    subgraph &quot;eBPF 方式&quot;
        App2[&quot;应用&quot;] --&gt; eBPF[&quot;eBPF 程序&quot;]
        eBPF --&gt; Kernel2[&quot;内核虚拟机&quot;]
        Kernel2 --&gt; Hardware2[&quot;硬件&quot;]
    end
</code></pre></div>
<p><strong>eBPF (extended Berkeley Packet Filter)</strong>：</p>
<ul>
<li>内核中安全运行的虚拟机</li>
<li>无需修改或重编内核</li>
<li>动态加载/卸载程序</li>
<li>广泛用于：网络、监控、安全、存储</li>
</ul>
<h4 id="4012-calico-ebpf">40.1.2 Calico 与 eBPF 的结合<a class="headerlink" href="#4012-calico-ebpf" title="Permanent link">&para;</a></h4>
<p><strong>背景</strong>：</p>
<ul>
<li>早期 Calico 不支持 eBPF</li>
<li>随着 Cilium 的崛起和 eBPF 技术火热</li>
<li>Calico 3.x 版本引入 eBPF 数据平面</li>
</ul>
<p><strong>eBPF 数据平面优势</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">传统 iptables</th>
<th style="text-align: left;">eBPF 数据平面</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Service 实现</td>
<td style="text-align: left;">kube-proxy + iptables</td>
<td style="text-align: left;">eBPF map</td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;">O(n) 规则匹配</td>
<td style="text-align: left;">O(1) hash 查找</td>
</tr>
<tr>
<td style="text-align: left;">conntrack</td>
<td style="text-align: left;">内核 conntrack</td>
<td style="text-align: left;">eBPF conntrack</td>
</tr>
<tr>
<td style="text-align: left;">CPU 开销</td>
<td style="text-align: left;">较高</td>
<td style="text-align: left;">较低</td>
</tr>
<tr>
<td style="text-align: left;">功能</td>
<td style="text-align: left;">完整</td>
<td style="text-align: left;">部分限制</td>
</tr>
</tbody>
</table>
<h3 id="402-ebpf">40.2 eBPF 数据平面原理<a class="headerlink" href="#402-ebpf" title="Permanent link">&para;</a></h3>
<h4 id="4021-bypass-kube-proxy">40.2.1 Bypass kube-proxy<a class="headerlink" href="#4021-bypass-kube-proxy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;传统模式&quot;
        Client1[&quot;Client&quot;] --&gt; KubeProxy[&quot;kube-proxy&quot;]
        KubeProxy --&gt; |&quot;iptables 规则&quot;| Pod1[&quot;Pod&quot;]
    end

    subgraph &quot;eBPF 模式&quot;
        Client2[&quot;Client&quot;] --&gt; eBPFProg[&quot;eBPF 程序&quot;]
        eBPFProg --&gt; |&quot;eBPF map 查找&quot;| Pod2[&quot;Pod&quot;]
    end
</code></pre></div>
<p><strong>工作机制</strong>：</p>
<ul>
<li>Service ClusterIP → eBPF map</li>
<li>直接查找后端 Pod</li>
<li>绕过 iptables/IPVS</li>
</ul>
<h4 id="4022">40.2.2 限制与适用场景<a class="headerlink" href="#4022" title="Permanent link">&para;</a></h4>
<p><strong>不推荐使用 eBPF 的场景</strong>：</p>
<ul>
<li>Service Mesh control plane（仍需 iptables）</li>
<li>Packet-by-packet 处理</li>
<li>需要完整 iptables 功能</li>
</ul>
<p><strong>推荐使用 eBPF 的场景</strong>：</p>
<ul>
<li>Connect-time Load Balancing</li>
<li>XDP 加速</li>
<li>高性能需求</li>
</ul>
<p><strong>平台兼容性</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">支持</th>
<th style="text-align: left;">不支持</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">OpenShift, AKS, EKS</td>
<td style="text-align: left;">GKE, RKE</td>
</tr>
<tr>
<td style="text-align: left;">Ubuntu 20.04+ (5.4+ 内核)</td>
<td style="text-align: left;">旧内核 (&lt;4.18)</td>
</tr>
<tr>
<td style="text-align: left;">kubeadm 安装</td>
<td style="text-align: left;">IPv6, SCTP</td>
</tr>
</tbody>
</table>
<h3 id="403-dsr">40.3 DSR 模式原理<a class="headerlink" href="#403-dsr" title="Permanent link">&para;</a></h3>
<h4 id="4031-dsr">40.3.1 什么是 DSR<a class="headerlink" href="#4031-dsr" title="Permanent link">&para;</a></h4>
<p><strong>DSR (Direct Server Return)</strong>：</p>
<ul>
<li>响应包不经过 Load Balancer</li>
<li>后端直接返回给客户端</li>
<li>减少 LB 负载，提升性能</li>
</ul>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;传统模式 (Tunnel)&quot;
        C1[&quot;Client&quot;] --&gt;|&quot;1.请求&quot;| LB1[&quot;LB/Node&quot;]
        LB1 --&gt;|&quot;2.转发&quot;| Backend1[&quot;Backend&quot;]
        Backend1 --&gt;|&quot;3.响应&quot;| LB1
        LB1 --&gt;|&quot;4.返回&quot;| C1
    end
</code></pre></div>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;DSR 模式&quot;
        C2[&quot;Client&quot;] --&gt;|&quot;1.请求&quot;| LB2[&quot;LB/Node&quot;]
        LB2 --&gt;|&quot;2.转发&quot;| Backend2[&quot;Backend&quot;]
        Backend2 --&gt;|&quot;3.直接返回&quot;| C2
    end
</code></pre></div>
<h4 id="4032-tunnel-vs-dsr">40.3.2 Tunnel vs DSR 对比<a class="headerlink" href="#4032-tunnel-vs-dsr" title="Permanent link">&para;</a></h4>
<p><strong>TCP 三次握手流程对比</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">步骤</th>
<th style="text-align: left;">Tunnel 模式</th>
<th style="text-align: left;">DSR 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">SYN</td>
<td style="text-align: left;">Client → LB → Backend</td>
<td style="text-align: left;">Client → LB → Backend</td>
</tr>
<tr>
<td style="text-align: left;">SYN-ACK</td>
<td style="text-align: left;">Backend → LB → Client</td>
<td style="text-align: left;">Backend → Client (直接)</td>
</tr>
<tr>
<td style="text-align: left;">ACK</td>
<td style="text-align: left;">Client → LB → Backend</td>
<td style="text-align: left;">Client → LB → Backend</td>
</tr>
<tr>
<td style="text-align: left;">总包数</td>
<td style="text-align: left;">6 个</td>
<td style="text-align: left;">4 个</td>
</tr>
</tbody>
</table>
<h3 id="404">40.4 配置与实现<a class="headerlink" href="#404" title="Permanent link">&para;</a></h3>
<h4 id="4041-ebpf">40.4.1 启用 eBPF 数据平面<a class="headerlink" href="#4041-ebpf" title="Permanent link">&para;</a></h4>
<p><strong>步骤 1：创建 ConfigMap</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-services-endpoint</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">KUBERNETES_SERVICE_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;API_SERVER_IP&gt;&quot;</span>
<span class="w">  </span><span class="nt">KUBERNETES_SERVICE_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;6443&quot;</span>
</code></pre></div>
<p><strong>步骤 2：禁用 kube-proxy</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Kind 集群：创建时设置</span>
kubeProxyMode:<span class="w"> </span>none

<span class="c1"># 现有集群：scale down</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>kube-proxy<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>--replicas<span class="o">=</span><span class="m">0</span>
</code></pre></div>
<p><strong>步骤 3：启用 eBPF</strong></p>
<div class="highlight"><pre><span></span><code>calicoctl<span class="w"> </span>patch<span class="w"> </span>felixconfiguration<span class="w"> </span>default<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--patch<span class="o">=</span><span class="s1">&#39;{&quot;spec&quot;: {&quot;bpfEnabled&quot;: true}}&#39;</span>
</code></pre></div>
<h4 id="4042-dsr">40.4.2 启用 DSR 模式<a class="headerlink" href="#4042-dsr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>calicoctl<span class="w"> </span>patch<span class="w"> </span>felixconfiguration<span class="w"> </span>default<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--patch<span class="o">=</span><span class="s1">&#39;{&quot;spec&quot;: {&quot;bpfExternalServiceMode&quot;: &quot;DSR&quot;}}&#39;</span>
</code></pre></div>
<p><strong>DSR 模式值</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>Tunnel</code></td>
<td style="text-align: left;">默认，VxLAN 封装双向</td>
</tr>
<tr>
<td style="text-align: left;"><code>DSR</code></td>
<td style="text-align: left;">响应直接返回</td>
</tr>
</tbody>
</table>
<h4 id="4043">40.4.3 验证配置<a class="headerlink" href="#4043" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 Felix 配置</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>felixconfiguration<span class="w"> </span>default<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1"># 检查 BPF 状态</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>calico-node-xxx<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>calico-node<span class="w"> </span>-bpf<span class="w"> </span>conntrack<span class="w"> </span>dump
</code></pre></div>
<h3 id="405">40.5 抓包分析<a class="headerlink" href="#405" title="Permanent link">&para;</a></h3>
<h4 id="4051-tunnel">40.5.1 Tunnel 模式抓包<a class="headerlink" href="#4051-tunnel" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant C as Client (172.18.0.1)
    participant LB as LB Node (172.18.0.2)
    participant B as Backend (172.18.0.3)

    C-&gt;&gt;LB: SYN (端口 32000)
    LB-&gt;&gt;B: VxLAN封装 SYN
    B-&gt;&gt;LB: VxLAN封装 SYN-ACK
    LB-&gt;&gt;C: SYN-ACK
    C-&gt;&gt;LB: ACK
    LB-&gt;&gt;B: VxLAN封装 ACK
</code></pre></div>
<p><strong>特点</strong>：</p>
<ul>
<li>中间节点进行 VxLAN 封装</li>
<li>所有流量经过 LB 节点</li>
<li>共 6 个包完成握手</li>
</ul>
<h4 id="4052-dsr">40.5.2 DSR 模式抓包<a class="headerlink" href="#4052-dsr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant C as Client (172.18.0.1)
    participant LB as LB Node (172.18.0.2)
    participant B as Backend (172.18.0.3)

    C-&gt;&gt;LB: SYN (端口 32000)
    LB-&gt;&gt;B: VxLAN封装 SYN
    B--&gt;&gt;C: SYN-ACK (直接返回！)
    C-&gt;&gt;LB: ACK
    LB-&gt;&gt;B: VxLAN封装 ACK
</code></pre></div>
<p><strong>特点</strong>：</p>
<ul>
<li>SYN-ACK 从 Backend 直接返回 Client</li>
<li>减少 LB 负载</li>
<li>共 4 个包完成握手</li>
</ul>
<h4 id="4053-vxlan">40.5.3 VxLAN 封装分析<a class="headerlink" href="#4053-vxlan" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># 外层 IP 头
Src: 172.18.0.2 (LB)
Dst: 172.18.0.3 (Backend)

# VxLAN 头
Port: 4789
VNI: xxx

# 内层 IP 头 (原始包)
Src: 172.18.0.1 (Client)
Dst: 172.18.0.2 (Service ClusterIP)
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>DSR 如何实现直接返回</strong>：</p>
<ul>
<li>VxLAN 内层包含原始 Client IP</li>
<li>Backend 解封装后获取 Client 地址</li>
<li>直接构造响应包发送给 Client</li>
<li>响应包源 IP 为 Service IP（非 Backend IP）</li>
</ul>
</blockquote>
<h3 id="406">40.6 验证步骤<a class="headerlink" href="#406" title="Permanent link">&para;</a></h3>
<h4 id="4061-ebpf">40.6.1 检查 eBPF 启用状态<a class="headerlink" href="#4061-ebpf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Felix 配置</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>felixconfiguration<span class="w"> </span>default<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>bpf

<span class="c1"># 输出</span>
bpfEnabled:<span class="w"> </span><span class="nb">true</span>
bpfExternalServiceMode:<span class="w"> </span>DSR
</code></pre></div>
<h4 id="4062-kube-proxy">40.6.2 验证无 kube-proxy<a class="headerlink" href="#4062-kube-proxy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 iptables 规则（应该没有 Service 规则）</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-L<span class="w"> </span>KUBE-SERVICES

<span class="c1"># 检查 conntrack（eBPF 模式下为空）</span>
conntrack<span class="w"> </span>-L<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>&lt;service-port&gt;
</code></pre></div>
<h4 id="4063-bpf">40.6.3 使用 BPF 工具查看<a class="headerlink" href="#4063-bpf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 进入 calico-node Pod</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>calico-node-xxx<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>--<span class="w"> </span>sh

<span class="c1"># 使用 calico-node 内置 BPF 工具</span>
calico-node<span class="w"> </span>-bpf<span class="w"> </span>conntrack<span class="w"> </span>dump
calico-node<span class="w"> </span>-bpf<span class="w"> </span>routes<span class="w"> </span>dump
calico-node<span class="w"> </span>-bpf<span class="w"> </span>arp<span class="w"> </span>dump
</code></pre></div>
<h3 id="407">40.7 故障排查<a class="headerlink" href="#407" title="Permanent link">&para;</a></h3>
<h4 id="4071">40.7.1 常见问题<a class="headerlink" href="#4071" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">原因</th>
<th style="text-align: left;">解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Service 不通</td>
<td style="text-align: left;">eBPF 未正确加载</td>
<td style="text-align: left;">检查 Felix 日志</td>
</tr>
<tr>
<td style="text-align: left;">性能没提升</td>
<td style="text-align: left;">kube-proxy 仍运行</td>
<td style="text-align: left;">禁用 kube-proxy</td>
</tr>
<tr>
<td style="text-align: left;">部分功能失效</td>
<td style="text-align: left;">平台不支持</td>
<td style="text-align: left;">检查兼容性列表</td>
</tr>
<tr>
<td style="text-align: left;">conntrack 查不到</td>
<td style="text-align: left;">正常现象</td>
<td style="text-align: left;">eBPF 有自己的 conntrack</td>
</tr>
</tbody>
</table>
<h4 id="4072">40.7.2 调试命令<a class="headerlink" href="#4072" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 BPF 程序加载情况</span>
tc<span class="w"> </span>-s<span class="w"> </span>qdisc<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>eth0

<span class="c1"># 查看丢包统计</span>
tc<span class="w"> </span>-s<span class="w"> </span>filter<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>eth0

<span class="c1"># 查看 Felix 日志</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>calico-node-xxx<span class="w"> </span>-c<span class="w"> </span>felix<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>bpf
</code></pre></div>
<h3 id="408">40.8 章节小结<a class="headerlink" href="#408" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((eBPF + DSR))
    eBPF
      内核虚拟机
      无需重编内核
      bypass iptables
      性能提升
    DSR
      Direct Server Return
      减少 LB 负载
      响应直接返回
    配置
      bpfEnabled true
      bpfExternalServiceMode DSR
      禁用 kube-proxy
    验证
      calico-node bpf
      conntrack 为空
      抓包分析
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>eBPF + DSR 模式要点总结</strong>：</p>
<ol>
<li><strong>eBPF 优势</strong>：</li>
<li>绕过 iptables/kube-proxy</li>
<li>O(1) 查找性能</li>
<li>
<p>降低 CPU 开销</p>
</li>
<li>
<p><strong>DSR 原理</strong>：</p>
</li>
<li>响应包直接从 Backend 返回 Client</li>
<li>减少 LB 节点负载</li>
<li>
<p>TCP 握手从 6 包减少到 4 包</p>
</li>
<li>
<p><strong>关键配置</strong>：</p>
</li>
<li><code>bpfEnabled: true</code></li>
<li><code>bpfExternalServiceMode: DSR</code></li>
<li>
<p>禁用 kube-proxy</p>
</li>
<li>
<p><strong>验证方法</strong>：</p>
</li>
<li><code>calico-node -bpf</code> 命令</li>
<li>抓包分析 TCP 握手流程</li>
<li>
<p>conntrack 表为空（eBPF 管理）</p>
</li>
<li>
<p><strong>注意限制</strong>：</p>
</li>
<li>内核版本要求 (&gt;= 5.4)</li>
<li>部分平台不支持</li>
<li>功能不如 iptables 完整</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-vpp">第四十一章 Calico-VPP 模式<a class="headerlink" href="#calico-vpp" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico 的 VPP（Vector Packet Processing）数据平面模式，这是一种高性能的用户态协议栈方案。</p>
<h3 id="411">41.1 背景与概述<a class="headerlink" href="#411" title="Permanent link">&para;</a></h3>
<h4 id="4111-vpp">41.1.1 什么是 VPP<a class="headerlink" href="#4111-vpp" title="Permanent link">&para;</a></h4>
<p><strong>VPP (Vector Packet Processing)</strong>：</p>
<ul>
<li>矢量包处理框架</li>
<li>用户态协议栈</li>
<li>思科开源项目 (fd.io)</li>
<li>高性能网络处理</li>
</ul>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;传统处理&quot;
        P1[&quot;Packet 1&quot;] --&gt; K1[&quot;内核协议栈&quot;]
        P2[&quot;Packet 2&quot;] --&gt; K1
        P3[&quot;Packet 3&quot;] --&gt; K1
    end

    subgraph &quot;VPP 矢量处理&quot;
        PV1[&quot;Packet Vector&quot;] --&gt; N1[&quot;Node 1&quot;]
        N1 --&gt; N2[&quot;Node 2&quot;]
        N2 --&gt; N3[&quot;Node 3&quot;]
    end
</code></pre></div>
<p><strong>矢量处理优势</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">传统逐包处理</th>
<th style="text-align: left;">VPP 矢量处理</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">处理方式</td>
<td style="text-align: left;">单包遍历所有层</td>
<td style="text-align: left;">批量处理同类包</td>
</tr>
<tr>
<td style="text-align: left;">Cache 命中</td>
<td style="text-align: left;">低（频繁切换）</td>
<td style="text-align: left;">高（连续访问）</td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;">较低</td>
<td style="text-align: left;">极高（百万 pps）</td>
</tr>
<tr>
<td style="text-align: left;">扩展性</td>
<td style="text-align: left;">内核态修改</td>
<td style="text-align: left;">Plugin 机制</td>
</tr>
</tbody>
</table>
<h4 id="4112-vpp-dpdk">41.1.2 VPP 与 DPDK 的关系<a class="headerlink" href="#4112-vpp-dpdk" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;VPP 架构&quot;
        App[&quot;应用层&lt;br/&gt;Calico/Plugin&quot;]
        VPP[&quot;VPP 协议栈&lt;br/&gt;L2/L3/L4&quot;]
        Driver[&quot;数据平面驱动&quot;]
        NIC[&quot;网卡&quot;]
    end

    App --&gt; VPP
    VPP --&gt; Driver
    Driver --&gt; NIC

    subgraph &quot;数据平面选项&quot;
        D1[&quot;DPDK - 高性能&quot;]
        D2[&quot;AF_PACKET - 兼容性&quot;]
        D3[&quot;RDMA - 低延迟&quot;]
        D4[&quot;Virtio - 虚拟化&quot;]
    end

    Driver -.-&gt; D1
    Driver -.-&gt; D2
    Driver -.-&gt; D3
    Driver -.-&gt; D4
</code></pre></div>
<p><strong>组合说明</strong>：</p>
<ul>
<li><strong>VPP</strong>：提供用户态协议栈</li>
<li><strong>DPDK</strong>：提供快速数据通道</li>
<li><strong>SR-IOV + DPDK</strong>：生产环境最强组合</li>
</ul>
<h3 id="412-vpp">41.2 VPP 工作原理<a class="headerlink" href="#412-vpp" title="Permanent link">&para;</a></h3>
<h4 id="4121-node-graph">41.2.1 Node Graph 处理模型<a class="headerlink" href="#4121-node-graph" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    Input[&quot;DPDK Input&quot;] --&gt; ARP[&quot;ARP Input&quot;]
    Input --&gt; IP4[&quot;IP4 Input&quot;]
    IP4 --&gt; IP4Lookup[&quot;IP4 Lookup&quot;]
    IP4Lookup --&gt; IP4Rewrite[&quot;IP4 Rewrite&quot;]
    IP4Rewrite --&gt; Interface[&quot;Interface Output&quot;]
    Interface --&gt; TX[&quot;DPDK TX&quot;]
</code></pre></div>
<p><strong>每个 Node 代表一个处理单元</strong>：</p>
<ul>
<li><code>dpdk-input</code>：从网卡接收</li>
<li><code>ip4-input</code>：IPv4 处理</li>
<li><code>ip4-lookup</code>：路由查找</li>
<li><code>interface-output</code>：发送</li>
</ul>
<h4 id="4122-vs-vpp">41.2.2 传统模式 vs VPP 模式<a class="headerlink" href="#4122-vs-vpp" title="Permanent link">&para;</a></h4>
<p><strong>传统模式（内核协议栈）</strong>：</p>
<div class="highlight"><pre><span></span><code>Pod → veth → Bridge/Route → 内核协议栈 → NIC → 交换机
</code></pre></div>
<p><strong>VPP 模式（用户态协议栈）</strong>：</p>
<div class="highlight"><pre><span></span><code>Pod → tun/tap → VPP 协议栈 → DPDK/驱动 → NIC → 交换机
</code></pre></div>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Host Kernel&quot;
        BGP[&quot;BIRD BGP&quot;]
        Kubelet[&quot;kubelet&quot;]
        Felix[&quot;Felix&quot;]
        TUN[&quot;tun 设备&quot;]
    end

    subgraph &quot;VPP 用户态&quot;
        VPPCore[&quot;VPP Core&quot;]
        Routing[&quot;Routing&quot;]
        LB[&quot;Load Balancing&quot;]
        Policy[&quot;Policy&quot;]
        DataPlane[&quot;Data Plane&lt;br/&gt;(DPDK/AF_PACKET)&quot;]
    end

    subgraph &quot;Pod&quot;
        PodApp[&quot;应用&quot;]
        PodTUN[&quot;tun 设备&quot;]
    end

    PodApp --&gt; PodTUN
    PodTUN --&gt; VPPCore
    VPPCore --&gt; DataPlane
    DataPlane --&gt; NIC[&quot;物理网卡&quot;]

    TUN &lt;-.-&gt; VPPCore
    BGP &lt;-.-&gt; TUN
</code></pre></div>
<h3 id="413">41.3 环境配置<a class="headerlink" href="#413" title="Permanent link">&para;</a></h3>
<h4 id="4131">41.3.1 前置要求<a class="headerlink" href="#4131" title="Permanent link">&para;</a></h4>
<p><strong>HugePages（大页内存）</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看当前配置</span>
cat<span class="w"> </span>/proc/meminfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Huge

<span class="c1"># 配置 HugePages（2MB）</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1024</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages

<span class="c1"># 或配置 1GB HugePages</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages
</code></pre></div>
<p><strong>Kubernetes 中查看 HugePages</strong>：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>describe<span class="w"> </span>node<span class="w"> </span>&lt;node-name&gt;<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>hugepages
<span class="c1"># 输出</span>
<span class="c1">#   hugepages-1Gi: 0</span>
<span class="c1">#   hugepages-2Mi: 0</span>
</code></pre></div>
<h4 id="4132">41.3.2 网卡驱动绑定<a class="headerlink" href="#4132" title="Permanent link">&para;</a></h4>
<p><strong>驱动类型对比</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">驱动</th>
<th style="text-align: left;">性能</th>
<th style="text-align: left;">HugePages</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>af_packet</code></td>
<td style="text-align: left;">低</td>
<td style="text-align: left;">不需要</td>
<td style="text-align: left;">测试/兼容</td>
</tr>
<tr>
<td style="text-align: left;"><code>uio_pci_generic</code></td>
<td style="text-align: left;">中</td>
<td style="text-align: left;">需要</td>
<td style="text-align: left;">通用</td>
</tr>
<tr>
<td style="text-align: left;"><code>igb_uio</code></td>
<td style="text-align: left;">高</td>
<td style="text-align: left;">需要</td>
<td style="text-align: left;">已淘汰</td>
</tr>
<tr>
<td style="text-align: left;"><code>vfio-pci</code></td>
<td style="text-align: left;">高</td>
<td style="text-align: left;">需要</td>
<td style="text-align: left;">生产推荐</td>
</tr>
</tbody>
</table>
<p><strong>绑定网卡到 DPDK</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看当前状态</span>
dpdk-devbind.py<span class="w"> </span>--status

<span class="c1"># 绑定到 vfio-pci</span>
dpdk-devbind.py<span class="w"> </span>--bind<span class="o">=</span>vfio-pci<span class="w"> </span><span class="m">0000</span>:82:00.0

<span class="c1"># 绑定后，网卡在内核中不可见</span>
ip<span class="w"> </span>link<span class="w"> </span>show<span class="w">  </span><span class="c1"># 看不到该网卡</span>
</code></pre></div>
<blockquote>
<p>[!WARNING]
网卡绑定到 DPDK 后，将从内核中消失。需要 VPP 创建 tap 设备维持 SSH 连接。</p>
</blockquote>
<h3 id="414">41.4 安装与配置<a class="headerlink" href="#414" title="Permanent link">&para;</a></h3>
<h4 id="4141-calico-vpp">41.4.1 Calico VPP 安装<a class="headerlink" href="#4141-calico-vpp" title="Permanent link">&para;</a></h4>
<p><strong>步骤 1：准备空集群</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># kubeadm init 后，不安装 CNI</span>
kubeadm<span class="w"> </span>init<span class="w"> </span>--pod-network-cidr<span class="o">=</span><span class="m">192</span>.168.0.0/16
</code></pre></div>
<p><strong>步骤 2：安装 Calico Operator</strong></p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://docs.projectcalico.org/manifests/calico.yaml
</code></pre></div>
<p><strong>步骤 3：安装 VPP 数据平面</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># vpp-dataplane.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">calico-vpp-config</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">calico-vpp-dataplane</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">CALICOVPP_INTERFACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eth0</span>
<span class="w">  </span><span class="nt">CALICOVPP_NATIVE_DRIVER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">af_packet</span><span class="w">  </span><span class="c1"># 或 dpdk</span>
<span class="w">  </span><span class="nt">SERVICE_PREFIX</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.96.0.0/16</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>vpp-dataplane.yaml
</code></pre></div>
<h4 id="4142-vpp">41.4.2 VPP 启动配置<a class="headerlink" href="#4142-vpp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># /etc/vpp/startup.conf
unix {
  nodaemon
  full-coredump
}

cpu {
  workers 1
  main-core 0
}

dpdk {
  dev 0000:82:00.0
}

plugins {
  plugin dpdk_plugin.so { enable }
  plugin ping_plugin.so { enable }
}

buffers {
  buffers-per-numa 131072
}
</code></pre></div>
<p><strong>关键配置说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">配置项</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>cpu.workers</code></td>
<td style="text-align: left;">转发线程数</td>
</tr>
<tr>
<td style="text-align: left;"><code>dpdk.dev</code></td>
<td style="text-align: left;">网卡 PCI 地址</td>
</tr>
<tr>
<td style="text-align: left;"><code>plugins</code></td>
<td style="text-align: left;">启用的插件</td>
</tr>
<tr>
<td style="text-align: left;"><code>buffers</code></td>
<td style="text-align: left;">内存缓冲区</td>
</tr>
</tbody>
</table>
<h3 id="415">41.5 调试与验证<a class="headerlink" href="#415" title="Permanent link">&para;</a></h3>
<h4 id="4151-vpp">41.5.1 进入 VPP 控制台<a class="headerlink" href="#4151-vpp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Calico VPP 环境</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>calico-vpp-node-xxx<span class="w"> </span>-n<span class="w"> </span>calico-vpp-dataplane<span class="w"> </span>--<span class="w"> </span>vppctl

<span class="c1"># 或直接执行命令</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>calico-vpp-node-xxx<span class="w"> </span>-n<span class="w"> </span>calico-vpp-dataplane<span class="w"> </span>--<span class="w"> </span>vppctl<span class="w"> </span>show<span class="w"> </span>interface
</code></pre></div>
<h4 id="4152-vppctl">41.5.2 常用 vppctl 命令<a class="headerlink" href="#4152-vppctl" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看接口</span>
vppctl<span class="w"> </span>show<span class="w"> </span>interface

<span class="c1"># 查看接口统计</span>
vppctl<span class="w"> </span>show<span class="w"> </span>interface<span class="w"> </span>addr

<span class="c1"># 查看路由表</span>
vppctl<span class="w"> </span>show<span class="w"> </span>ip<span class="w"> </span>fib

<span class="c1"># 查看 ARP 表</span>
vppctl<span class="w"> </span>show<span class="w"> </span>ip<span class="w"> </span>neighbor

<span class="c1"># 查看隧道</span>
vppctl<span class="w"> </span>show<span class="w"> </span>vxlan<span class="w"> </span>tunnel
vppctl<span class="w"> </span>show<span class="w"> </span>ipip<span class="w"> </span>tunnel

<span class="c1"># 查看运行状态</span>
vppctl<span class="w"> </span>show<span class="w"> </span>runtime
</code></pre></div>
<p><strong>输出示例</strong>：</p>
<div class="highlight"><pre><span></span><code>vpp# show interface
              Name               Idx    State  MTU     RX packets     TX packets
GigabitEthernet82/0/0             1      up     9000     12345678       87654321
tap0                              2      up     1500        54321          12345
tun0                              3      up     1500        11111          22222
</code></pre></div>
<h3 id="416-pod">41.6 Pod 通信原理<a class="headerlink" href="#416-pod" title="Permanent link">&para;</a></h3>
<h4 id="4161-pod-vpp">41.6.1 Pod 到 VPP 的连接<a class="headerlink" href="#4161-pod-vpp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Pod&quot;
        App[&quot;应用进程&quot;]
        NS[&quot;Network Namespace&quot;]
        TUN[&quot;tun 设备&quot;]
    end

    subgraph &quot;VPP&quot;
        VPPTun[&quot;VPP tun&quot;]
        Route[&quot;路由处理&quot;]
        Output[&quot;接口输出&quot;]
    end

    App --&gt; NS
    NS --&gt; TUN
    TUN &lt;--&gt; VPPTun
    VPPTun --&gt; Route
    Route --&gt; Output
</code></pre></div>
<p><strong>tun vs tap 设备</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">层级</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">tun</td>
<td style="text-align: left;">L3（IP）</td>
<td style="text-align: left;">Pod 连接 VPP</td>
</tr>
<tr>
<td style="text-align: left;">tap</td>
<td style="text-align: left;">L2（Ethernet）</td>
<td style="text-align: left;">需要 MAC 地址场景</td>
</tr>
</tbody>
</table>
<h4 id="4162">41.6.2 跨节点通信<a class="headerlink" href="#4162" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1 (Node1)
    participant VPP1 as VPP (Node1)
    participant NIC1 as NIC (Node1)
    participant NIC2 as NIC (Node2)
    participant VPP2 as VPP (Node2)
    participant Pod2 as Pod2 (Node2)

    Pod1-&gt;&gt;VPP1: tun 设备
    VPP1-&gt;&gt;NIC1: DPDK 发送
    NIC1-&gt;&gt;NIC2: 物理网络(VxLAN/IPIP)
    NIC2-&gt;&gt;VPP2: DPDK 接收
    VPP2-&gt;&gt;Pod2: tun 设备
</code></pre></div>
<h3 id="417">41.7 限制与注意事项<a class="headerlink" href="#417" title="Permanent link">&para;</a></h3>
<h4 id="4171">41.7.1 已知限制<a class="headerlink" href="#4171" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">功能</th>
<th style="text-align: left;">状态</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">BGP</td>
<td style="text-align: left;">必须启用</td>
</tr>
<tr>
<td style="text-align: left;">Service Affinity</td>
<td style="text-align: left;">不支持</td>
</tr>
<tr>
<td style="text-align: left;">EndpointSlice</td>
<td style="text-align: left;">不支持</td>
</tr>
<tr>
<td style="text-align: left;">WireGuard</td>
<td style="text-align: left;">部分限制</td>
</tr>
<tr>
<td style="text-align: left;">IPv6</td>
<td style="text-align: left;">支持</td>
</tr>
</tbody>
</table>
<h4 id="4172">41.7.2 生产建议<a class="headerlink" href="#4172" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!CAUTION]
<strong>VPP 模式仍为实验性功能</strong>：</p>
<ul>
<li>官方标记为 "Not Production Ready"</li>
<li>建议在测试环境充分验证</li>
<li>生产环境考虑使用 Multus + VPP</li>
</ul>
</blockquote>
<p><strong>适用场景</strong>：</p>
<ul>
<li>高性能网络需求（流媒体、AI/ML）</li>
<li>SR-IOV 环境</li>
<li>专用硬件加速</li>
</ul>
<h3 id="418">41.8 章节小结<a class="headerlink" href="#418" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Calico VPP))
    VPP 概念
      矢量包处理
      用户态协议栈
      fd.io 开源
    数据平面
      DPDK 高性能
      AF_PACKET 兼容
      RDMA/Virtio
    配置
      HugePages
      网卡驱动绑定
      startup.conf
    架构
      Pod via tun
      VPP 协议栈
      快速转发
    验证
      vppctl
      show interface
      show ip fib
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>VPP 模式要点总结</strong>：</p>
<ol>
<li><strong>VPP 是什么</strong>：</li>
<li>矢量包处理框架</li>
<li>用户态高性能协议栈</li>
<li>
<p>通过 Plugin 扩展功能</p>
</li>
<li>
<p><strong>与 DPDK 关系</strong>：</p>
</li>
<li>VPP 提供协议栈</li>
<li>DPDK 提供快速数据通道</li>
<li>
<p>生产推荐：SR-IOV + DPDK</p>
</li>
<li>
<p><strong>关键配置</strong>：</p>
</li>
<li>HugePages 内存</li>
<li>网卡驱动绑定（vfio-pci）</li>
<li>
<p>VPP startup.conf</p>
</li>
<li>
<p><strong>Pod 连接方式</strong>：</p>
</li>
<li>通过 tun 设备连接到 VPP</li>
<li>
<p>VPP 替代内核协议栈转发</p>
</li>
<li>
<p><strong>限制注意</strong>：</p>
</li>
<li>必须启用 BGP</li>
<li>实验性功能，非生产就绪</li>
<li>需要物理机或虚拟机（非容器化）</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-service-datapath">第四十二章 Calico-Service-DataPath<a class="headerlink" href="#calico-service-datapath" title="Permanent link">&para;</a></h2>
<p>本章深入分析 Calico 环境下 Kubernetes Service 的数据路径，包括 ClusterIP、NodePort、LoadBalancer 三种类型的 NAT 转换过程。</p>
<h3 id="421">42.1 背景与概述<a class="headerlink" href="#421" title="Permanent link">&para;</a></h3>
<h4 id="4211-service">42.1.1 Service 类型回顾<a class="headerlink" href="#4211-service" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">访问范围</th>
<th style="text-align: left;">使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">ClusterIP</td>
<td style="text-align: left;">集群内部</td>
<td style="text-align: left;">默认类型，微服务通信</td>
</tr>
<tr>
<td style="text-align: left;">NodePort</td>
<td style="text-align: left;">集群外部</td>
<td style="text-align: left;">通过节点端口访问</td>
</tr>
<tr>
<td style="text-align: left;">LoadBalancer</td>
<td style="text-align: left;">外部 LB</td>
<td style="text-align: left;">云环境，生产推荐</td>
</tr>
<tr>
<td style="text-align: left;">Headless</td>
<td style="text-align: left;">集群内部</td>
<td style="text-align: left;">StatefulSet，直连 Pod</td>
</tr>
</tbody>
</table>
<h4 id="4212-nat">42.1.2 NAT 转换基础<a class="headerlink" href="#4212-nat" title="Permanent link">&para;</a></h4>
<p><strong>NAT 类型说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">NAT 类型</th>
<th style="text-align: left;">说明</th>
<th style="text-align: left;">场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">SNAT</td>
<td style="text-align: left;">修改源地址</td>
<td style="text-align: left;">内网访问外网</td>
</tr>
<tr>
<td style="text-align: left;">DNAT</td>
<td style="text-align: left;">修改目的地址</td>
<td style="text-align: left;">外网访问内网</td>
</tr>
<tr>
<td style="text-align: left;">Reverse NAT</td>
<td style="text-align: left;">反向还原</td>
<td style="text-align: left;">响应包还原地址</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;SNAT 场景&quot;
        A[&quot;内网 IP&quot;] --&gt; |修改源| B[&quot;公网 IP&quot;]
    end

    subgraph &quot;DNAT 场景&quot;
        C[&quot;Service IP&quot;] --&gt; |修改目的| D[&quot;Pod IP&quot;]
    end
</code></pre></div>
<h3 id="422-clusterip">42.2 ClusterIP 数据路径<a class="headerlink" href="#422-clusterip" title="Permanent link">&para;</a></h3>
<h4 id="4221">42.2.1 工作原理<a class="headerlink" href="#4221" title="Permanent link">&para;</a></h4>
<p>ClusterIP 是 Kubernetes 默认的 Service 类型，只能在集群内部访问。</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A (Client)
    participant VethA as veth pair
    participant Host as Node (iptables)
    participant PodB as Pod B (Backend)

    Note over PodA,PodB: 第一阶段: 发送请求
    PodA-&gt;&gt;VethA: SRC: PodA IP&lt;br/&gt;DST: ClusterIP
    VethA-&gt;&gt;Host: 进入 root namespace
    Note over Host: iptables 执行 DNAT&lt;br/&gt;ClusterIP → PodB IP
    Host-&gt;&gt;PodB: SRC: PodA IP&lt;br/&gt;DST: PodB IP

    Note over PodA,PodB: 第二阶段: 返回响应
    PodB-&gt;&gt;Host: SRC: PodB IP&lt;br/&gt;DST: PodA IP
    Note over Host: conntrack 执行 Reverse DNAT&lt;br/&gt;PodB IP → ClusterIP
    Host-&gt;&gt;VethA: SRC: ClusterIP&lt;br/&gt;DST: PodA IP
    VethA-&gt;&gt;PodA: 响应到达
</code></pre></div>
<h4 id="4222-dnat">42.2.2 DNAT 详解<a class="headerlink" href="#4222-dnat" title="Permanent link">&para;</a></h4>
<p><strong>请求阶段</strong>：</p>
<div class="highlight"><pre><span></span><code>Pod A 发送请求:
  原始包: SRC=10.244.1.10 (PodA), DST=10.96.0.100 (ClusterIP)

经过 iptables DNAT:
  转换后: SRC=10.244.1.10 (PodA), DST=10.244.2.20 (PodB)
</code></pre></div>
<p><strong>响应阶段</strong>：</p>
<div class="highlight"><pre><span></span><code>Pod B 返回响应:
  原始包: SRC=10.244.2.20 (PodB), DST=10.244.1.10 (PodA)

经过 conntrack Reverse DNAT:
  转换后: SRC=10.96.0.100 (ClusterIP), DST=10.244.1.10 (PodA)
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>为什么需要 Reverse DNAT？</strong>
Pod A 发送的请求目的是 ClusterIP，如果响应的源地址是 PodB IP，Pod A 会因为地址不匹配而丢弃该包。</p>
</blockquote>
<h4 id="4223">42.2.3 抓包验证<a class="headerlink" href="#4223" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Client Pod 网卡抓包</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>client-pod<span class="w"> </span>--<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn

<span class="c1"># 观察第一个 SYN 包</span>
<span class="c1"># SRC: 10.244.1.10 (PodA)</span>
<span class="c1"># DST: 10.96.0.100 (ClusterIP)</span>

<span class="c1"># 在 Host 网卡抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>host<span class="w"> </span><span class="m">10</span>.244.2.20

<span class="c1"># 观察同一个 SYN 包 (DNAT 已完成)</span>
<span class="c1"># SRC: 10.244.1.10 (PodA)  </span>
<span class="c1"># DST: 10.244.2.20 (PodB) ← 目的地址已变化</span>
</code></pre></div>
<h3 id="423-nodeport">42.3 NodePort 数据路径<a class="headerlink" href="#423-nodeport" title="Permanent link">&para;</a></h3>
<h4 id="4231">42.3.1 工作原理<a class="headerlink" href="#4231" title="Permanent link">&para;</a></h4>
<p>NodePort 允许从集群外部通过节点 IP + 端口访问服务。</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as 外部客户端
    participant Node1 as Node1 (入口)
    participant Node2 as Node2
    participant PodB as Pod B (Backend)

    Note over Client,PodB: 第一阶段: 外部请求进入
    Client-&gt;&gt;Node1: SRC: ClientIP&lt;br/&gt;DST: Node1:30000
    Note over Node1: SNAT + DNAT&lt;br/&gt;ClientIP→Node1IP&lt;br/&gt;Node1:30000→PodB:80
    Node1-&gt;&gt;Node2: SRC: Node1 IP&lt;br/&gt;DST: PodB IP
    Node2-&gt;&gt;PodB: 转发到 Pod

    Note over Client,PodB: 第二阶段: 响应返回
    PodB-&gt;&gt;Node2: SRC: PodB IP&lt;br/&gt;DST: Node1 IP
    Node2-&gt;&gt;Node1: 路由回 Node1
    Note over Node1: Reverse SNAT + DNAT&lt;br/&gt;还原所有地址
    Node1-&gt;&gt;Client: SRC: Node1:30000&lt;br/&gt;DST: ClientIP
</code></pre></div>
<h4 id="4232-snat">42.3.2 为什么需要 SNAT？<a class="headerlink" href="#4232-snat" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;问题场景 (不做 SNAT)&quot;
        C1[&quot;Client: 172.18.0.1&quot;] --&gt; N1[&quot;Node1: 172.18.0.2&quot;]
        N1 --&gt; |&quot;DST=PodB&quot;| P1[&quot;PodB: 10.244.2.20&quot;]
        P1 --&gt; |&quot;SRC=PodB&lt;br/&gt;DST=Client&quot;| C1
        style P1 fill:#f66
        Note1[&quot;❌ Client 收到 PodB 的响应&lt;br/&gt;但它期望的是 Node1 的响应&quot;]
    end
</code></pre></div>
<p><strong>解决方案：SNAT</strong></p>
<ul>
<li>请求时：将源地址改为 Node1 IP</li>
<li>响应时：PodB 将响应发回 Node1</li>
<li>Node1 再做 Reverse NAT 发回 Client</li>
</ul>
<h4 id="4233-nat">42.3.3 完整 NAT 过程<a class="headerlink" href="#4233-nat" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">阶段</th>
<th style="text-align: left;">源地址</th>
<th style="text-align: left;">目的地址</th>
<th style="text-align: left;">NAT 操作</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Client→Node1</td>
<td style="text-align: left;">ClientIP</td>
<td style="text-align: left;">Node1:30000</td>
<td style="text-align: left;">-</td>
</tr>
<tr>
<td style="text-align: left;">Node1→PodB</td>
<td style="text-align: left;">Node1 IP</td>
<td style="text-align: left;">PodB:80</td>
<td style="text-align: left;">SNAT + DNAT</td>
</tr>
<tr>
<td style="text-align: left;">PodB→Node1</td>
<td style="text-align: left;">PodB IP</td>
<td style="text-align: left;">Node1 IP</td>
<td style="text-align: left;">-</td>
</tr>
<tr>
<td style="text-align: left;">Node1→Client</td>
<td style="text-align: left;">Node1:30000</td>
<td style="text-align: left;">ClientIP</td>
<td style="text-align: left;">Reverse NAT</td>
</tr>
</tbody>
</table>
<h4 id="4234">42.3.4 抓包验证<a class="headerlink" href="#4234" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Node1 上抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>port<span class="w"> </span><span class="m">30000</span><span class="w"> </span>-w<span class="w"> </span>nodeport.pcap

<span class="c1"># 从外部访问</span>
curl<span class="w"> </span><span class="m">172</span>.18.0.2:30000

<span class="c1"># 分析 pcap 文件</span>
<span class="c1"># 可以看到 4 种不同的地址组合</span>
</code></pre></div>
<h3 id="424-loadbalancer">42.4 LoadBalancer 数据路径<a class="headerlink" href="#424-loadbalancer" title="Permanent link">&para;</a></h3>
<h4 id="4241">42.4.1 工作原理<a class="headerlink" href="#4241" title="Permanent link">&para;</a></h4>
<p>LoadBalancer 在 NodePort 基础上增加了外部负载均衡器。</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Client as 外部客户端
    participant LB as L4 LoadBalancer
    participant Node1 as Node1
    participant PodB as Pod B (Backend)

    Client-&gt;&gt;LB: SRC: ClientIP&lt;br/&gt;DST: LB IP
    Note over LB: DNAT: 选择后端节点&lt;br/&gt;LB IP → Node1 IP
    LB-&gt;&gt;Node1: SRC: ClientIP&lt;br/&gt;DST: Node1:30000
    Note over Node1: 等同于 NodePort 流程
    Node1-&gt;&gt;PodB: SNAT + DNAT
    PodB-&gt;&gt;Node1: 响应
    Node1-&gt;&gt;LB: Reverse NAT
    LB-&gt;&gt;Client: 返回响应
</code></pre></div>
<h4 id="4242-nodeport">42.4.2 与 NodePort 的关系<a class="headerlink" href="#4242-nodeport" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>LoadBalancer = 外部 L4 LB + NodePort

数据流:
Client → L4 LB (DNAT选择节点) → NodePort (SNAT+DNAT) → Pod
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>L4 LB 的作用</strong>：</p>
<ul>
<li>隐藏后端节点 IP</li>
<li>负载均衡到多个节点</li>
<li>提供统一入口（外部 IP/VIP）</li>
</ul>
</blockquote>
<h3 id="425-iptables">42.5 iptables 规则分析<a class="headerlink" href="#425-iptables" title="Permanent link">&para;</a></h3>
<h4 id="4251-service">42.5.1 Service 相关规则链<a class="headerlink" href="#4251-service" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Service 规则</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-L<span class="w"> </span>KUBE-SERVICES<span class="w"> </span>-n<span class="w"> </span>--line-numbers

<span class="c1"># 查看特定 Service 的规则链</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-L<span class="w"> </span>KUBE-SVC-XXXXX<span class="w"> </span>-n
</code></pre></div>
<p><strong>规则链结构</strong>：</p>
<div class="highlight"><pre><span></span><code>graph TD
    A[&quot;PREROUTING/OUTPUT&quot;] --&gt; B[&quot;KUBE-SERVICES&quot;]
    B --&gt; C[&quot;KUBE-SVC-xxx&lt;br/&gt;(Service 入口)&quot;]
    C --&gt; D[&quot;KUBE-SEP-xxx&lt;br/&gt;(Endpoint 1)&quot;]
    C --&gt; E[&quot;KUBE-SEP-yyy&lt;br/&gt;(Endpoint 2)&quot;]
    D --&gt; F[&quot;DNAT 到 Pod1&quot;]
    E --&gt; G[&quot;DNAT 到 Pod2&quot;]
</code></pre></div>
<h4 id="4252-iptables-trace">42.5.2 iptables trace 调试<a class="headerlink" href="#4252-iptables-trace" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 添加 trace 规则</span>
iptables<span class="w"> </span>-t<span class="w"> </span>raw<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>TRACE
iptables<span class="w"> </span>-t<span class="w"> </span>raw<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>TRACE

<span class="c1"># 查看 trace 日志</span>
dmesg<span class="w"> </span>-T<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>TRACE

<span class="c1"># 清除 trace 规则</span>
iptables<span class="w"> </span>-t<span class="w"> </span>raw<span class="w"> </span>-D<span class="w"> </span>PREROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>TRACE
iptables<span class="w"> </span>-t<span class="w"> </span>raw<span class="w"> </span>-D<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>-j<span class="w"> </span>TRACE
</code></pre></div>
<h3 id="426-conntrack">42.6 conntrack 连接跟踪<a class="headerlink" href="#426-conntrack" title="Permanent link">&para;</a></h3>
<h4 id="4261">42.6.1 查看连接表<a class="headerlink" href="#4261" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看所有连接</span>
conntrack<span class="w"> </span>-L

<span class="c1"># 过滤特定端口</span>
conntrack<span class="w"> </span>-L<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span>

<span class="c1"># 查看 NAT 连接</span>
conntrack<span class="w"> </span>-L<span class="w"> </span>-n
</code></pre></div>
<h4 id="4262-conntrack">42.6.2 conntrack 表项解读<a class="headerlink" href="#4262-conntrack" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>tcp  6 117 TIME_WAIT 
  src=10.244.1.10 dst=10.96.0.100 sport=45678 dport=80 
  src=10.244.2.20 dst=10.244.1.10 sport=80 dport=45678

解读:
- 原始方向: PodA(10.244.1.10) → ClusterIP(10.96.0.100)
- 回复方向: PodB(10.244.2.20) → PodA(10.244.1.10)
- DNAT 映射: ClusterIP → PodB
</code></pre></div>
<h3 id="427">42.7 实验环境搭建<a class="headerlink" href="#427" title="Permanent link">&para;</a></h3>
<h4 id="4271-pod">42.7.1 测试 Pod 部署<a class="headerlink" href="#4271-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># test-pods.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client-pod</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span><span class="w">  </span><span class="c1"># 固定到 node1</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">curlimages/curl</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;infinity&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend-pod</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node2</span><span class="w">  </span><span class="c1"># 固定到 node2，跨节点测试</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend-svc</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000</span>
</code></pre></div>
<h4 id="4272">42.7.2 验证步骤<a class="headerlink" href="#4272" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. ClusterIP 测试</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>client-pod<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>backend-svc

<span class="c1"># 2. NodePort 测试 (从集群外)</span>
curl<span class="w"> </span>&lt;node-ip&gt;:30000

<span class="c1"># 3. 抓包分析</span>
<span class="c1"># 在不同位置抓包对比</span>
</code></pre></div>
<h3 id="428">42.8 章节小结<a class="headerlink" href="#428" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Service DataPath))
    ClusterIP
      仅 DNAT
      集群内访问
      Reverse DNAT 还原
    NodePort
      SNAT + DNAT
      外部访问
      跨节点需 SNAT
    LoadBalancer
      L4 LB + NodePort
      负载均衡
      隐藏后端
    调试
      tcpdump 抓包
      iptables trace
      conntrack 查看
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Service DataPath 要点总结</strong>：</p>
<ol>
<li><strong>ClusterIP</strong>：</li>
<li>仅做 DNAT（ClusterIP → PodIP）</li>
<li>
<p>conntrack 记录映射，响应时 Reverse DNAT</p>
</li>
<li>
<p><strong>NodePort</strong>：</p>
</li>
<li>SNAT + DNAT 双重转换</li>
<li>
<p>SNAT 确保响应能回到入口节点</p>
</li>
<li>
<p><strong>LoadBalancer</strong>：</p>
</li>
<li>L4 LB 选择后端节点</li>
<li>
<p>后续流程等同 NodePort</p>
</li>
<li>
<p><strong>调试技巧</strong>：</p>
</li>
<li><code>tcpdump</code> 抓包：注意抓包位置影响看到的地址</li>
<li><code>iptables trace</code>：追踪规则命中</li>
<li>
<p><code>conntrack -L</code>：查看 NAT 映射关系</p>
</li>
<li>
<p><strong>注意事项</strong>：</p>
</li>
<li>抓包时 iptables 已处理完成</li>
<li>生产环境谨慎修改 iptables 规则</li>
<li>使用 BGP Fullmesh 简化分析（无 overlay）</li>
</ol>
</blockquote>
<hr />
<h2 id="calico_5">第四十三章 Calico 生产实践<a class="headerlink" href="#calico_5" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico 在生产环境中的网络设计和最佳实践，包括数据中心网络拓扑、BGP 架构选型、AS 模式对比。</p>
<h3 id="431">43.1 背景与概述<a class="headerlink" href="#431" title="Permanent link">&para;</a></h3>
<h4 id="4311">43.1.1 参考文档<a class="headerlink" href="#4311" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!IMPORTANT]
<strong>生产环境必读文档</strong>：</p>
<ul>
<li>Calico 官方文档：<code>Reference → Architecture → Calico IP Fabric</code></li>
<li>IETF RFC 7938：<em>Use of BGP for Routing in Large-Scale Data Centers</em></li>
</ul>
<p><strong>建议</strong>：生产环境至少阅读 10 遍，理解每一句话的含义和技术依据。</p>
</blockquote>
<h4 id="4312">43.1.2 数据中心网络演进<a class="headerlink" href="#4312" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">时代</th>
<th style="text-align: left;">架构</th>
<th style="text-align: left;">特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">传统</td>
<td style="text-align: left;">接入-汇聚-核心</td>
<td style="text-align: left;">生成树 + VRRP + BFD</td>
</tr>
<tr>
<td style="text-align: left;">现代</td>
<td style="text-align: left;">Spine-Leaf (Clos)</td>
<td style="text-align: left;">BGP 路由 + ECMP</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;传统三层架构&quot;
        C1[&quot;核心层 Core&quot;]
        A1[&quot;汇聚层 Aggregation&quot;]
        A2[&quot;汇聚层 Aggregation&quot;]
        S1[&quot;接入层 Access&quot;]
        S2[&quot;接入层 Access&quot;]
        S3[&quot;接入层 Access&quot;]

        C1 --- A1
        C1 --- A2
        A1 --- S1
        A1 --- S2
        A2 --- S2
        A2 --- S3
    end
</code></pre></div>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Spine-Leaf 架构&quot;
        SP1[&quot;Spine 1&quot;]
        SP2[&quot;Spine 2&quot;]
        L1[&quot;Leaf/ToR 1&quot;]
        L2[&quot;Leaf/ToR 2&quot;]
        L3[&quot;Leaf/ToR 3&quot;]

        SP1 --- L1
        SP1 --- L2
        SP1 --- L3
        SP2 --- L1
        SP2 --- L2
        SP2 --- L3
    end
</code></pre></div>
<h3 id="432-bgp">43.2 BGP 网络拓扑模式<a class="headerlink" href="#432-bgp" title="Permanent link">&para;</a></h3>
<p>Calico 支持三种主要的 BGP 网络拓扑模式：</p>
<h4 id="4321">43.2.1 模式对比<a class="headerlink" href="#4321" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">AS 分配</th>
<th style="text-align: left;">复杂度</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">AS Per Rack</td>
<td style="text-align: left;">每机架一个 AS</td>
<td style="text-align: left;">中</td>
<td style="text-align: left;">大型数据中心</td>
</tr>
<tr>
<td style="text-align: left;">AS Per Node</td>
<td style="text-align: left;">每节点一个 AS</td>
<td style="text-align: left;">高</td>
<td style="text-align: left;">特殊需求</td>
</tr>
<tr>
<td style="text-align: left;">Downward Default</td>
<td style="text-align: left;">默认路由下发</td>
<td style="text-align: left;">低</td>
<td style="text-align: left;">推荐生产</td>
</tr>
</tbody>
</table>
<h3 id="433-as-per-rack">43.3 AS Per Rack 模式<a class="headerlink" href="#433-as-per-rack" title="Permanent link">&para;</a></h3>
<h4 id="4331">43.3.1 架构原理<a class="headerlink" href="#4331" title="Permanent link">&para;</a></h4>
<p>每个机架（Rack）作为一个独立的自治系统（AS）。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Spine 层&quot;
        SP[&quot;Spine Switch&lt;br/&gt;AS 65000&quot;]
    end

    subgraph &quot;Rack A - AS 65001&quot;
        ToR_A[&quot;ToR Switch&lt;br/&gt;Route Reflector&quot;]
        N1[&quot;Node 1&quot;]
        N2[&quot;Node 2&quot;]
        N3[&quot;Node 3&quot;]
    end

    subgraph &quot;Rack B - AS 65002&quot;
        ToR_B[&quot;ToR Switch&lt;br/&gt;Route Reflector&quot;]
        N4[&quot;Node 4&quot;]
        N5[&quot;Node 5&quot;]
        N6[&quot;Node 6&quot;]
    end

    SP ---|eBGP| ToR_A
    SP ---|eBGP| ToR_B
    ToR_A ---|iBGP| N1
    ToR_A ---|iBGP| N2
    ToR_A ---|iBGP| N3
    ToR_B ---|iBGP| N4
    ToR_B ---|iBGP| N5
    ToR_B ---|iBGP| N6
</code></pre></div>
<h4 id="4332">43.3.2 工作原理<a class="headerlink" href="#4332" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>机架内部（iBGP）</strong>：</li>
<li>ToR 交换机作为 Route Reflector</li>
<li>计算节点与 ToR 建立 iBGP</li>
<li>
<p>同机架节点共享同一 AS 号</p>
</li>
<li>
<p><strong>机架之间（eBGP）</strong>：</p>
</li>
<li>ToR 与 Spine 建立 eBGP</li>
<li>不同机架使用不同 AS 号</li>
<li>Spine 交换机汇聚全网路由</li>
</ol>
<h4 id="4333">43.3.3 优势与劣势<a class="headerlink" href="#4333" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">方面</th>
<th style="text-align: left;">优势</th>
<th style="text-align: left;">劣势</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">扩展性</td>
<td style="text-align: left;">机架级隔离</td>
<td style="text-align: left;">需要规划 AS 号</td>
</tr>
<tr>
<td style="text-align: left;">故障域</td>
<td style="text-align: left;">故障隔离在机架</td>
<td style="text-align: left;">ToR 压力较大</td>
</tr>
<tr>
<td style="text-align: left;">管理</td>
<td style="text-align: left;">结构清晰</td>
<td style="text-align: left;">配置复杂</td>
</tr>
</tbody>
</table>
<h3 id="434-as-per-node">43.4 AS Per Node 模式<a class="headerlink" href="#434-as-per-node" title="Permanent link">&para;</a></h3>
<h4 id="4341">43.4.1 架构原理<a class="headerlink" href="#4341" title="Permanent link">&para;</a></h4>
<p>每个计算节点作为一个独立的自治系统。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Spine 层&quot;
        SP[&quot;Spine Switch&quot;]
    end

    subgraph &quot;Leaf 层&quot;
        ToR[&quot;ToR Switch&quot;]
    end

    subgraph &quot;Node 层&quot;
        N1[&quot;Node 1&lt;br/&gt;AS 65001&quot;]
        N2[&quot;Node 2&lt;br/&gt;AS 65002&quot;]
        N3[&quot;Node 3&lt;br/&gt;AS 65003&quot;]
    end

    SP ---|eBGP| ToR
    ToR ---|eBGP| N1
    ToR ---|eBGP| N2
    ToR ---|eBGP| N3
</code></pre></div>
<h4 id="4342">43.4.2 特点分析<a class="headerlink" href="#4342" title="Permanent link">&para;</a></h4>
<p><strong>优点</strong>：</p>
<ul>
<li>每个节点完全独立</li>
<li>路由隔离彻底</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>节点 BGP 压力大（Bird 进程）</li>
<li>AS 号管理复杂</li>
<li>开源 BGP 实现不如商业设备稳定</li>
</ul>
<blockquote>
<p>[!WARNING]
<strong>不推荐在生产环境使用</strong></p>
<p>计算节点使用 Bird 提供 BGP 能力，其稳定性和性能不如商业路由设备。每个节点最多 200 个 Pod，路由条目有限，没必要每节点独立 AS。</p>
</blockquote>
<h3 id="435-downward-default">43.5 Downward Default 模式（推荐）<a class="headerlink" href="#435-downward-default" title="Permanent link">&para;</a></h3>
<h4 id="4351">43.5.1 架构原理<a class="headerlink" href="#4351" title="Permanent link">&para;</a></h4>
<p>下级设备只向上级通告默认路由，全网路由只在 Spine 维护。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Spine 层 - 全网路由&quot;
        SP[&quot;Spine Switch&lt;br/&gt;掌握所有路由&quot;]
    end

    subgraph &quot;Leaf 层 - 默认路由&quot;
        ToR1[&quot;ToR 1&lt;br/&gt;默认路由指向 Spine&quot;]
        ToR2[&quot;ToR 2&lt;br/&gt;默认路由指向 Spine&quot;]
    end

    subgraph &quot;Node 层 - 默认路由&quot;
        N1[&quot;Node 1&quot;]
        N2[&quot;Node 2&quot;]
        N3[&quot;Node 3&quot;]
        N4[&quot;Node 4&quot;]
    end

    SP --&gt; |&quot;下发默认路由&quot;| ToR1
    SP --&gt; |&quot;下发默认路由&quot;| ToR2
    ToR1 --&gt; |&quot;下发默认路由&quot;| N1
    ToR1 --&gt; |&quot;下发默认路由&quot;| N2
    ToR2 --&gt; |&quot;下发默认路由&quot;| N3
    ToR2 --&gt; |&quot;下发默认路由&quot;| N4

    N1 -.-&gt; |&quot;通告 Pod 网段&quot;| ToR1
    N2 -.-&gt; |&quot;通告 Pod 网段&quot;| ToR1
    ToR1 -.-&gt; |&quot;汇聚上报&quot;| SP
</code></pre></div>
<h4 id="4352">43.5.2 工作原理<a class="headerlink" href="#4352" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>路由通告方向（上行）：
Node → ToR → Spine
每级只通告本级路由，汇聚后上报

默认路由方向（下行）：
Spine → ToR → Node
每级下发默认路由，指向上级
</code></pre></div>
<h4 id="4353">43.5.3 优势分析<a class="headerlink" href="#4353" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">方面</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">设备负载</td>
<td style="text-align: left;">专业设备做专业的事，Spine 处理复杂路由</td>
</tr>
<tr>
<td style="text-align: left;">节点压力</td>
<td style="text-align: left;">计算节点只维护少量路由，释放资源</td>
</tr>
<tr>
<td style="text-align: left;">配置简化</td>
<td style="text-align: left;">下级设备配置简单，默认路由即可</td>
</tr>
<tr>
<td style="text-align: left;">可扩展性</td>
<td style="text-align: left;">Spine 交换机能力强，支持大规模路由表</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>生产环境推荐使用 Downward Default 模式</strong></p>
<p>这种模式让专业设备处理复杂的 BGP 路由，计算节点专注于运行工作负载，是最合理的分工。</p>
</blockquote>
<h3 id="436-route-reflector">43.6 Route Reflector 配置策略<a class="headerlink" href="#436-route-reflector" title="Permanent link">&para;</a></h3>
<h4 id="4361-route-reflector">43.6.1 选择 Route Reflector<a class="headerlink" href="#4361-route-reflector" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;方案1: ToR 作为 RR&quot;
        ToR1[&quot;ToR Switch&lt;br/&gt;性能好&quot;]
    end

    subgraph &quot;方案2: 专用 RR 节点&quot;
        RR1[&quot;RR Node 1&quot;]
        RR2[&quot;RR Node 2&quot;]
    end

    subgraph &quot;方案3: 控制节点作为 RR&quot;
        CP[&quot;Control Plane Node&quot;]
    end
</code></pre></div>
<p><strong>选择建议</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">方案</th>
<th style="text-align: left;">适用场景</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">ToR 交换机</td>
<td style="text-align: left;">大型数据中心</td>
<td style="text-align: left;">性能最好，需交换机支持</td>
</tr>
<tr>
<td style="text-align: left;">专用 RR 节点</td>
<td style="text-align: left;">中型集群</td>
<td style="text-align: left;">灵活，需额外资源</td>
</tr>
<tr>
<td style="text-align: left;">控制节点</td>
<td style="text-align: left;">小型集群</td>
<td style="text-align: left;">简单，复用现有资源</td>
</tr>
</tbody>
</table>
<h4 id="4362-route-reflector">43.6.2 Route Reflector 数量<a class="headerlink" href="#4362-route-reflector" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 推荐配置: 至少 2 个 RR 实现高可用</span>
<span class="c1"># 使用 calicoctl 配置 RR</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BGPConfiguration</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeToNodeMeshEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># 禁用 Full Mesh</span>
<span class="w">  </span><span class="nt">asNumber</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65001</span>
</code></pre></div>
<h3 id="437-as">43.7 AS 号规划<a class="headerlink" href="#437-as" title="Permanent link">&para;</a></h3>
<h4 id="4371-as">43.7.1 私有 AS 号范围<a class="headerlink" href="#4371-as" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">范围</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">2 字节私有</td>
<td style="text-align: left;">64512-65534</td>
<td style="text-align: left;">常用，1023 个</td>
</tr>
<tr>
<td style="text-align: left;">4 字节私有</td>
<td style="text-align: left;">4200000000-4294967294</td>
<td style="text-align: left;">扩展，约 9500 万个</td>
</tr>
</tbody>
</table>
<h4 id="4372">43.7.2 规划示例<a class="headerlink" href="#4372" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>数据中心 AS 规划示例：

Spine 层:
  - Spine-1: AS 65000
  - Spine-2: AS 65000 (同 AS，iBGP)

Leaf/ToR 层:
  - Rack-A: AS 65001
  - Rack-B: AS 65002
  - Rack-C: AS 65003
  ...
  - Rack-N: AS 6500N

注意: 每个 Rack 使用不同 AS 号
</code></pre></div>
<h3 id="438">43.8 生产环境选型建议<a class="headerlink" href="#438" title="Permanent link">&para;</a></h3>
<h4 id="4381">43.8.1 决策流程<a class="headerlink" href="#4381" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[&quot;开始选型&quot;] --&gt; B{&quot;集群规模&quot;}
    B --&gt; |&quot;小型 &lt;50 节点&quot;| C[&quot;Full Mesh&quot;]
    B --&gt; |&quot;中型 50-200 节点&quot;| D[&quot;AS Per Rack&lt;br/&gt;+ Route Reflector&quot;]
    B --&gt; |&quot;大型 &gt;200 节点&quot;| E[&quot;Downward Default&lt;br/&gt;+ Spine Leaf&quot;]

    C --&gt; F[&quot;控制节点作为 RR&quot;]
    D --&gt; G[&quot;ToR 作为 RR&quot;]
    E --&gt; H[&quot;Spine 承担路由&quot;]
</code></pre></div>
<h4 id="4382">43.8.2 模式选型建议<a class="headerlink" href="#4382" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">规模</th>
<th style="text-align: left;">推荐模式</th>
<th style="text-align: left;">理由</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">小型 (&lt;50)</td>
<td style="text-align: left;">Full Mesh</td>
<td style="text-align: left;">简单，无需额外配置</td>
</tr>
<tr>
<td style="text-align: left;">中型 (50-200)</td>
<td style="text-align: left;">AS Per Rack + RR</td>
<td style="text-align: left;">平衡复杂度和扩展性</td>
</tr>
<tr>
<td style="text-align: left;">大型 (&gt;200)</td>
<td style="text-align: left;">Downward Default</td>
<td style="text-align: left;">专业设备处理路由</td>
</tr>
</tbody>
</table>
<h3 id="439-containerlab">43.9 ContainerLab 实验<a class="headerlink" href="#439-containerlab" title="Permanent link">&para;</a></h3>
<h4 id="4391-bgp">43.9.1 验证不同 BGP 架构<a class="headerlink" href="#4391-bgp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用 ContainerLab 模拟 Spine-Leaf 架构</span>
<span class="c1"># 可以验证：</span>
<span class="c1"># 1. AS Per Rack 模式</span>
<span class="c1"># 2. AS Per Node 模式  </span>
<span class="c1"># 3. Downward Default 模式</span>

<span class="c1"># 查看 BGP 邻居</span>
calicoctl<span class="w"> </span>node<span class="w"> </span>status

<span class="c1"># 查看路由表</span>
ip<span class="w"> </span>route<span class="w"> </span>show
</code></pre></div>
<h3 id="4310">43.10 章节小结<a class="headerlink" href="#4310" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Calico 生产实践))
    网络拓扑
      传统三层
      Spine-Leaf
      Clos 架构
    BGP 模式
      AS Per Rack
      AS Per Node
      Downward Default
    Route Reflector
      ToR 交换机
      专用 RR 节点
      控制节点
    选型建议
      小型: Full Mesh
      中型: AS Per Rack
      大型: Downward Default
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Calico 生产实践要点总结</strong>：</p>
<ol>
<li><strong>必读文档</strong>：</li>
<li>Calico IP Fabric 设计文档</li>
<li>
<p>RFC 7938 数据中心 BGP 路由</p>
</li>
<li>
<p><strong>架构选型</strong>：</p>
</li>
<li><strong>Downward Default</strong>：推荐生产使用</li>
<li><strong>AS Per Rack</strong>：大型数据中心</li>
<li>
<p><strong>AS Per Node</strong>：不推荐</p>
</li>
<li>
<p><strong>设计原则</strong>：</p>
</li>
<li>专业设备做专业的事</li>
<li>Spine 处理复杂路由</li>
<li>
<p>计算节点专注工作负载</p>
</li>
<li>
<p><strong>Route Reflector</strong>：</p>
</li>
<li>小型：控制节点兼任</li>
<li>中大型：ToR 或专用节点</li>
<li>
<p>至少 2 个实现高可用</p>
</li>
<li>
<p><strong>验证测试</strong>：</p>
</li>
<li>使用 ContainerLab 模拟</li>
<li>理解每种模式的路由流向</li>
<li>生产上线前充分测试</li>
</ol>
</blockquote>
<hr />
<h2 id="calico-ipam">第四十四章 Calico-IPAM 高级用法<a class="headerlink" href="#calico-ipam" title="Permanent link">&para;</a></h2>
<p>本章介绍 Calico IPAM（IP Address Management）的高级配置，包括基于拓扑分配 IP、固定 IP、IP 池迁移、CNI 插件链等。</p>
<h3 id="441">44.1 背景与概述<a class="headerlink" href="#441" title="Permanent link">&para;</a></h3>
<h4 id="4411-cni">44.1.1 CNI 的两大核心组件<a class="headerlink" href="#4411-cni" title="Permanent link">&para;</a></h4>
<p>一个完备的 CNI 包含两大核心组件：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;CNI 核心组件&quot;
        IPAM[&quot;IPAM&lt;br/&gt;IP 地址管理&quot;]
        Network[&quot;Network&lt;br/&gt;网络通路&quot;]
    end

    IPAM --&gt; Pod[&quot;Pod 获取 IP&quot;]
    Network --&gt; Connectivity[&quot;Pod 互通&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">组件</th>
<th style="text-align: left;">职责</th>
<th style="text-align: left;">重要性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">IPAM</td>
<td style="text-align: left;">IP 地址分配和管理</td>
<td style="text-align: left;">⭐⭐⭐⭐⭐</td>
</tr>
<tr>
<td style="text-align: left;">Network</td>
<td style="text-align: left;">网络连通性</td>
<td style="text-align: left;">⭐⭐⭐⭐⭐</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>两者并重</strong>：不要只关注网络通路，IPAM 在生产环境中同样重要！</p>
</blockquote>
<h4 id="4412-calico-ipam">44.1.2 Calico IPAM 类型<a class="headerlink" href="#4412-calico-ipam" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">说明</th>
<th style="text-align: left;">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">calico-ipam</td>
<td style="text-align: left;">Calico 原生 IPAM</td>
<td style="text-align: left;">支持高级特性</td>
</tr>
<tr>
<td style="text-align: left;">host-local</td>
<td style="text-align: left;">主机本地 IPAM</td>
<td style="text-align: left;">功能有限</td>
</tr>
</tbody>
</table>
<h3 id="442-ipnode-selector">44.2 基于拓扑分配 IP（Node Selector）<a class="headerlink" href="#442-ipnode-selector" title="Permanent link">&para;</a></h3>
<h4 id="4421">44.2.1 背景<a class="headerlink" href="#4421" title="Permanent link">&para;</a></h4>
<p>在大型数据中心，需要根据物理拓扑（如机架/Rack）分配 IP 地址，便于管理和路由汇聚。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Rack 0 - 192.168.0.0/24&quot;
        Node1[&quot;Node 1&quot;]
        Node2[&quot;Node 2&quot;]
        Pod1[&quot;Pod: 192.168.0.x&quot;]
        Pod2[&quot;Pod: 192.168.0.y&quot;]
    end

    subgraph &quot;Rack 1 - 192.168.1.0/24&quot;
        Node3[&quot;Node 3&quot;]
        Node4[&quot;Node 4&quot;]
        Pod3[&quot;Pod: 192.168.1.x&quot;]
        Pod4[&quot;Pod: 192.168.1.y&quot;]
    end

    Node1 --&gt; Pod1
    Node2 --&gt; Pod2
    Node3 --&gt; Pod3
    Node4 --&gt; Pod4
</code></pre></div>
<h4 id="4422">44.2.2 原理<a class="headerlink" href="#4422" title="Permanent link">&para;</a></h4>
<p>通过 IPPool 的 <code>nodeSelector</code> 字段，限制 IP 池只能在特定节点上使用。</p>
<p><strong>默认配置</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 默认 IPPool - 所有节点</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all()</span><span class="w">  </span><span class="c1"># 所有节点都使用此池</span>
</code></pre></div>
<h4 id="4423">44.2.3 实现步骤<a class="headerlink" href="#4423" title="Permanent link">&para;</a></h4>
<p><strong>步骤 1：为节点打标签</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 标记机架</span>
kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>node1<span class="w"> </span><span class="nv">rack</span><span class="o">=</span>rack-0
kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>node2<span class="w"> </span><span class="nv">rack</span><span class="o">=</span>rack-0
kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>node3<span class="w"> </span><span class="nv">rack</span><span class="o">=</span>rack-1
kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>node4<span class="w"> </span><span class="nv">rack</span><span class="o">=</span>rack-1
</code></pre></div>
<p><strong>步骤 2：创建基于拓扑的 IP 池</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Rack 0 的 IP 池</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rack-0-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.0/24</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rack == &quot;rack-0&quot;</span>
<span class="nn">---</span>
<span class="c1"># Rack 1 的 IP 池</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rack-1-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.0/24</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rack == &quot;rack-1&quot;</span>
</code></pre></div>
<p><strong>步骤 3：验证</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建测试 Pod</span>
kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>--replicas<span class="o">=</span><span class="m">4</span>

<span class="c1"># 查看 Pod IP 分配</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>wide

<span class="c1"># 预期结果:</span>
<span class="c1"># node1/node2 上的 Pod: 192.168.0.x</span>
<span class="c1"># node3/node4 上的 Pod: 192.168.1.x</span>
</code></pre></div>
<h4 id="4424">44.2.4 关键点<a class="headerlink" href="#4424" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">要点</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">标签一致性</td>
<td style="text-align: left;">节点标签必须与 nodeSelector 匹配</td>
</tr>
<tr>
<td style="text-align: left;">路由汇聚</td>
<td style="text-align: left;">同机架 IP 相同网段，便于路由聚合</td>
</tr>
<tr>
<td style="text-align: left;">管理清晰</td>
<td style="text-align: left;">根据 IP 可快速定位物理位置</td>
</tr>
<tr>
<td style="text-align: left;">故障隔离</td>
<td style="text-align: left;">网段隔离有助于故障排查</td>
</tr>
</tbody>
</table>
<h3 id="443-ip-static-ip">44.3 固定 IP 地址（Static IP）<a class="headerlink" href="#443-ip-static-ip" title="Permanent link">&para;</a></h3>
<h4 id="4431">44.3.1 背景<a class="headerlink" href="#4431" title="Permanent link">&para;</a></h4>
<p>某些应用（如数据库）需要固定 IP，即使 Pod 重建也保持相同 IP。</p>
<h4 id="4432">44.3.2 原理<a class="headerlink" href="#4432" title="Permanent link">&para;</a></h4>
<p>通过 Pod 注解指定固定 IP 地址。</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant User as 用户
    participant K8s as Kubernetes
    participant IPAM as Calico IPAM

    User-&gt;&gt;K8s: 创建 Pod (带 IP 注解)
    K8s-&gt;&gt;IPAM: 请求分配 IP
    IPAM-&gt;&gt;IPAM: 检查注解中的 IP
    IPAM-&gt;&gt;IPAM: 分配指定 IP
    IPAM-&gt;&gt;K8s: 返回固定 IP
    K8s-&gt;&gt;User: Pod 启动完成
</code></pre></div>
<h4 id="4433">44.3.3 实现<a class="headerlink" href="#4433" title="Permanent link">&para;</a></h4>
<p><strong>创建带固定 IP 的 Pod</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static-ip-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cni.projectcalico.org/ipAddrs</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[&quot;192.168.0.100&quot;]&#39;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<p><strong>验证</strong>：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>static-ip-pod<span class="w"> </span>-o<span class="w"> </span>wide
<span class="c1"># NAME            READY   STATUS    IP              NODE</span>
<span class="c1"># static-ip-pod   1/1     Running   192.168.0.100   node1</span>
</code></pre></div>
<h4 id="4434-ip">44.3.4 固定 IP 的局限性<a class="headerlink" href="#4434-ip" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!WARNING]
<strong>Pod 重建时的 IP 冲突问题</strong></p>
<p>当 Pod 重建时，旧 Pod 的 IP 可能尚未释放，导致新 Pod 无法获取相同 IP。</p>
</blockquote>
<p><strong>解决方案</strong>：使用 IP 池（多个 IP）</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 为有状态应用分配 IP 范围</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.100.0/28</span><span class="w">  </span><span class="c1"># 16 个 IP</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app == &quot;database&quot;</span>
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Spiderpool 项目</strong></p>
<p>DaoCloud 开源的 <a href="https://github.com/spidernet-io/spiderpool">Spiderpool</a> 项目对 Calico 的静态 IP 功能进行了增强，支持：</p>
<ul>
<li>IP 池绑定到 Deployment</li>
<li>Pod 重建时自动复用 IP</li>
<li>双栈 IP 地址管理</li>
</ul>
</blockquote>
<h3 id="444-ip-migration">44.4 IP 池迁移（Migration）<a class="headerlink" href="#444-ip-migration" title="Permanent link">&para;</a></h3>
<h4 id="4441">44.4.1 背景<a class="headerlink" href="#4441" title="Permanent link">&para;</a></h4>
<p>当需要更换 Pod 网段时，需要从旧 IP 池迁移到新 IP 池。</p>
<h4 id="4442">44.4.2 原理<a class="headerlink" href="#4442" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    A[&quot;创建新 IP 池&quot;] --&gt; B[&quot;禁用旧 IP 池&quot;]
    B --&gt; C[&quot;重启 Pod&quot;]
    C --&gt; D[&quot;Pod 获取新 IP&quot;]
</code></pre></div>
<h4 id="4443">44.4.3 实现步骤<a class="headerlink" href="#4443" title="Permanent link">&para;</a></h4>
<p><strong>步骤 1：创建新 IP 池</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">new-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0.0.0/16</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<p><strong>步骤 2：禁用旧 IP 池</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看当前 IP 池</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>ippool<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1"># 编辑旧池，添加 disabled: true</span>
calicoctl<span class="w"> </span>patch<span class="w"> </span>ippool<span class="w"> </span>old-pool<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;{&quot;spec&quot;: {&quot;disabled&quot;: true}}&#39;</span>

<span class="c1"># 验证</span>
calicoctl<span class="w"> </span>get<span class="w"> </span>ippool
<span class="c1"># NAME       CIDR            SELECTOR   DISABLED</span>
<span class="c1"># old-pool   10.244.0.0/16   all()      true</span>
<span class="c1"># new-pool   10.0.0.0/16     all()      false</span>
</code></pre></div>
<p><strong>步骤 3：重启 Pod</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 方法1: 滚动更新</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deployment<span class="w"> </span>&lt;name&gt;

<span class="c1"># 方法2: 删除 Pod</span>
kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>--all<span class="w"> </span>-n<span class="w"> </span>&lt;namespace&gt;

<span class="c1"># 方法3: 使用 drain 节点</span>
kubectl<span class="w"> </span>drain<span class="w"> </span>&lt;node&gt;<span class="w"> </span>--ignore-daemonsets<span class="w"> </span>--delete-emptydir-data
</code></pre></div>
<p><strong>步骤 4：验证新 IP</strong></p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>wide
<span class="c1"># Pod IP 现在应该是 10.0.x.x</span>
</code></pre></div>
<h4 id="4444">44.4.4 关键点<a class="headerlink" href="#4444" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">要点</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">不可回滚</td>
<td style="text-align: left;">迁移后旧 IP 池已禁用</td>
</tr>
<tr>
<td style="text-align: left;">需重启 Pod</td>
<td style="text-align: left;">需要 Pod 重建才能获取新 IP</td>
</tr>
<tr>
<td style="text-align: left;">类似 DHCP</td>
<td style="text-align: left;">类似 DHCP Server 更换后重新获取 IP</td>
</tr>
</tbody>
</table>
<h3 id="445-ip-specific-pool">44.5 指定 IP 池（Specific Pool）<a class="headerlink" href="#445-ip-specific-pool" title="Permanent link">&para;</a></h3>
<h4 id="4451">44.5.1 背景<a class="headerlink" href="#4451" title="Permanent link">&para;</a></h4>
<p>在同一机架内，不同应用需要从不同 IP 池分配地址。</p>
<h4 id="4452">44.5.2 原理<a class="headerlink" href="#4452" title="Permanent link">&para;</a></h4>
<p>通过 Pod 注解指定从哪个 IP 池分配地址。</p>
<div class="highlight"><pre><span></span><code>graph TD
    subgraph &quot;同一节点&quot;
        DB[&quot;DB Pod&lt;br/&gt;注解: db-pool&quot;]
        App[&quot;App Pod&lt;br/&gt;注解: app-pool&quot;]
    end

    subgraph &quot;IP 池&quot;
        DBPool[&quot;db-pool&lt;br/&gt;192.168.100.0/28&quot;]
        AppPool[&quot;app-pool&lt;br/&gt;192.168.200.0/24&quot;]
    end

    DB --&gt; DBPool
    App --&gt; AppPool
</code></pre></div>
<h4 id="4453">44.5.3 实现<a class="headerlink" href="#4453" title="Permanent link">&para;</a></h4>
<p><strong>创建多个 IP 池</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 数据库专用池</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.100.0/28</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">---</span>
<span class="c1"># 应用专用池</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.200.0/24</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<p><strong>使用注解指定 IP 池</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cni.projectcalico.org/ipv4pools</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[&quot;db-pool&quot;]&#39;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql:8.0</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cni.projectcalico.org/ipv4pools</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[&quot;app-pool&quot;]&#39;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<h4 id="4454-node-selector">44.5.4 与 Node Selector 的区别<a class="headerlink" href="#4454-node-selector" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">功能</th>
<th style="text-align: left;">Node Selector</th>
<th style="text-align: left;">指定 IP 池</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">粒度</td>
<td style="text-align: left;">节点级别</td>
<td style="text-align: left;">Pod 级别</td>
</tr>
<tr>
<td style="text-align: left;">配置位置</td>
<td style="text-align: left;">IPPool</td>
<td style="text-align: left;">Pod 注解</td>
</tr>
<tr>
<td style="text-align: left;">用途</td>
<td style="text-align: left;">机架隔离</td>
<td style="text-align: left;">应用隔离</td>
</tr>
<tr>
<td style="text-align: left;">灵活性</td>
<td style="text-align: left;">较低</td>
<td style="text-align: left;">较高</td>
</tr>
</tbody>
</table>
<h3 id="446-cni">44.6 CNI 插件链<a class="headerlink" href="#446-cni" title="Permanent link">&para;</a></h3>
<h4 id="4461">44.6.1 背景<a class="headerlink" href="#4461" title="Permanent link">&para;</a></h4>
<p>Calico 支持 CNI 插件链，可以组合多个插件实现更多功能。</p>
<h4 id="4462">44.6.2 插件链架构<a class="headerlink" href="#4462" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    Main[&quot;主插件&lt;br/&gt;Calico&quot;]
    PM[&quot;Port Mapping&lt;br/&gt;端口映射&quot;]
    BW[&quot;Bandwidth&lt;br/&gt;带宽限制&quot;]
    SBR[&quot;SBR&lt;br/&gt;源路由&quot;]
    Tuning[&quot;Tuning&lt;br/&gt;内核参数&quot;]

    Main --&gt; PM
    PM --&gt; BW
    BW --&gt; SBR
    SBR --&gt; Tuning
</code></pre></div>
<h4 id="4463">44.6.3 常用辅助插件<a class="headerlink" href="#4463" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">插件</th>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">portmap</td>
<td style="text-align: left;">端口映射</td>
<td style="text-align: left;">支持 hostPort</td>
</tr>
<tr>
<td style="text-align: left;">bandwidth</td>
<td style="text-align: left;">带宽限制</td>
<td style="text-align: left;">QoS 流量控制</td>
</tr>
<tr>
<td style="text-align: left;">sbr</td>
<td style="text-align: left;">源路由</td>
<td style="text-align: left;">Source Based Routing</td>
</tr>
<tr>
<td style="text-align: left;">tuning</td>
<td style="text-align: left;">内核调优</td>
<td style="text-align: left;">设置 sysctl 参数</td>
</tr>
</tbody>
</table>
<h4 id="4464">44.6.4 配置示例<a class="headerlink" href="#4464" title="Permanent link">&para;</a></h4>
<p><strong>查看 CNI 配置</strong>：</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>/etc/cni/net.d/10-calico.conflist
</code></pre></div>
<p><strong>带插件链的配置</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;k8s-pod-network&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;cniVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.3.1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;plugins&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;calico&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;ipam&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;calico-ipam&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;portmap&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;capabilities&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;portMappings&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bandwidth&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;capabilities&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;bandwidth&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tuning&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;sysctl&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;net.core.somaxconn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1024&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="4465">44.6.5 带宽限制示例<a class="headerlink" href="#4465" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bandwidth-limited-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kubernetes.io/ingress-bandwidth</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10M&quot;</span>
<span class="w">    </span><span class="nt">kubernetes.io/egress-bandwidth</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10M&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<h3 id="447-ipam">44.7 IPAM 配置参考<a class="headerlink" href="#447-ipam" title="Permanent link">&para;</a></h3>
<h4 id="4471-ippool">44.7.1 IPPool 完整字段<a class="headerlink" href="#4471-ippool" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectcalico.org/v3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-pool</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 必填字段</span>
<span class="w">  </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.0/24</span>

<span class="w">  </span><span class="c1"># 可选字段</span>
<span class="w">  </span><span class="nt">blockSize</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">26</span><span class="w">              </span><span class="c1"># 每节点分配的子网大小</span>
<span class="w">  </span><span class="nt">ipipMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span><span class="w">           </span><span class="c1"># IPIP 模式: Always/CrossSubnet/Never</span>
<span class="w">  </span><span class="nt">vxlanMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w">           </span><span class="c1"># VxLAN 模式</span>
<span class="w">  </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">          </span><span class="c1"># 出站 SNAT</span>
<span class="w">  </span><span class="nt">disabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">            </span><span class="c1"># 是否禁用</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all()</span><span class="w">        </span><span class="c1"># 节点选择器</span>
<span class="w">  </span><span class="nt">allowedUses</span><span class="p">:</span><span class="w">               </span><span class="c1"># 允许的用途</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Workload</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tunnel</span>
</code></pre></div>
<h4 id="4472">44.7.2 常用注解<a class="headerlink" href="#4472" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">注解</th>
<th style="text-align: left;">用途</th>
<th style="text-align: left;">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>cni.projectcalico.org/ipAddrs</code></td>
<td style="text-align: left;">指定固定 IP</td>
<td style="text-align: left;"><code>["192.168.0.100"]</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>cni.projectcalico.org/ipv4pools</code></td>
<td style="text-align: left;">指定 IPv4 池</td>
<td style="text-align: left;"><code>["my-pool"]</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>cni.projectcalico.org/ipv6pools</code></td>
<td style="text-align: left;">指定 IPv6 池</td>
<td style="text-align: left;"><code>["my-ipv6-pool"]</code></td>
</tr>
</tbody>
</table>
<h3 id="448">44.8 章节小结<a class="headerlink" href="#448" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Calico IPAM 高级用法))
    基于拓扑分配
      Node Selector
      机架隔离
      路由汇聚
    固定 IP
      Pod 注解
      静态 IP
      Spiderpool 增强
    IP 池迁移
      禁用旧池
      重启 Pod
      获取新 IP
    指定 IP 池
      Pod 级别
      应用隔离
      更灵活
    CNI 插件链
      Port Mapping
      Bandwidth
      SBR
      Tuning
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Calico IPAM 高级用法要点总结</strong>：</p>
<ol>
<li><strong>CNI 两大核心</strong>：</li>
<li>IPAM：IP 地址管理</li>
<li>
<p>Network：网络通路</p>
</li>
<li>
<p><strong>基于拓扑分配（Node Selector）</strong>：</p>
</li>
<li>节点打标签 + IPPool nodeSelector</li>
<li>
<p>同机架使用同网段，便于管理</p>
</li>
<li>
<p><strong>固定 IP</strong>：</p>
</li>
<li>使用 <code>cni.projectcalico.org/ipAddrs</code> 注解</li>
<li>
<p>注意 Pod 重建时的 IP 冲突问题</p>
</li>
<li>
<p><strong>IP 池迁移</strong>：</p>
</li>
<li>创建新池 → 禁用旧池 → 重启 Pod</li>
<li>
<p>类似 DHCP Server 更换</p>
</li>
<li>
<p><strong>指定 IP 池</strong>：</p>
</li>
<li>使用 <code>cni.projectcalico.org/ipv4pools</code> 注解</li>
<li>
<p>Pod 级别的精细控制</p>
</li>
<li>
<p><strong>CNI 插件链</strong>：</p>
</li>
<li>多个插件组合使用</li>
<li>扩展功能：端口映射、带宽限制、内核调优</li>
</ol>
</blockquote>
<hr />
<h1 id="flannel-cni_1">第四部分：Flannel-CNI<a class="headerlink" href="#flannel-cni_1" title="Permanent link">&para;</a></h1>
<h2 id="flannel-tun-tap">第四十五章 Flannel-TUN-TAP 精讲<a class="headerlink" href="#flannel-tun-tap" title="Permanent link">&para;</a></h2>
<p>本章深入讲解 Linux TUN/TAP 虚拟网络设备，这是理解 Flannel UDP 模式等网络方案的基础。</p>
<h3 id="451">45.1 背景与概述<a class="headerlink" href="#451" title="Permanent link">&para;</a></h3>
<h4 id="4511-flannel">45.1.1 Flannel 简介<a class="headerlink" href="#4511-flannel" title="Permanent link">&para;</a></h4>
<p>Flannel 是由 CoreOS 开源的轻量级 CNI 方案，适合快速部署 Kubernetes 网络。</p>
<p><strong>资源获取</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">资源</th>
<th style="text-align: left;">地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">GitHub</td>
<td style="text-align: left;"><a href="https://github.com/flannel-io/flannel">https://github.com/flannel-io/flannel</a></td>
</tr>
<tr>
<td style="text-align: left;">Slack</td>
<td style="text-align: left;">Kubernetes Slack #flannel 频道</td>
</tr>
</tbody>
</table>
<h4 id="4512-flannel-calico">45.1.2 Flannel 与 Calico 的核心区别<a class="headerlink" href="#4512-flannel-calico" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Flannel</th>
<th style="text-align: left;">Calico</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">同节点通信</td>
<td style="text-align: left;">L2 交换（Bridge）</td>
<td style="text-align: left;">L3 路由</td>
</tr>
<tr>
<td style="text-align: left;">Pod 网络</td>
<td style="text-align: left;">挂在交换机上</td>
<td style="text-align: left;">挂在路由器上</td>
</tr>
<tr>
<td style="text-align: left;">Pod 掩码</td>
<td style="text-align: left;">/24（同网段）</td>
<td style="text-align: left;">/32（独立主机路由）</td>
</tr>
<tr>
<td style="text-align: left;">复杂度</td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">较复杂</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Flannel 同节点通信&quot;
        Pod1F[&quot;Pod A&lt;br/&gt;10.244.1.2/24&quot;]
        Pod2F[&quot;Pod B&lt;br/&gt;10.244.1.3/24&quot;]
        Bridge[&quot;cni0 Bridge&lt;br/&gt;L2 交换&quot;]
    end

    subgraph &quot;Calico 同节点通信&quot;
        Pod1C[&quot;Pod A&lt;br/&gt;10.244.1.2/32&quot;]
        Pod2C[&quot;Pod B&lt;br/&gt;10.244.1.3/32&quot;]
        Router[&quot;L3 路由&quot;]
    end

    Pod1F --&gt; Bridge
    Pod2F --&gt; Bridge
    Pod1C --&gt; Router
    Pod2C --&gt; Router
</code></pre></div>
<h3 id="452-tuntap">45.2 TUN/TAP 设备原理<a class="headerlink" href="#452-tuntap" title="Permanent link">&para;</a></h3>
<h4 id="4521-tuntap">45.2.1 什么是 TUN/TAP 设备<a class="headerlink" href="#4521-tuntap" title="Permanent link">&para;</a></h4>
<p>TUN/TAP 是 Linux 内核提供的虚拟网络设备，用于在<strong>用户空间</strong>和<strong>内核空间</strong>之间传递网络数据。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;用户空间 User Space&quot;
        App[&quot;应用程序&lt;br/&gt;如 flanneld&quot;]
        FD[&quot;/dev/net/tun&lt;br/&gt;字符设备&quot;]
    end

    subgraph &quot;内核空间 Kernel Space&quot;
        Stack[&quot;TCP/IP 协议栈&quot;]
        TUN[&quot;TUN/TAP 设备&lt;br/&gt;flannel0&quot;]
        NIC[&quot;物理网卡&lt;br/&gt;eth0&quot;]
    end

    App &lt;--&gt;|&quot;read/write&quot;| FD
    FD &lt;--&gt;|&quot;数据传递&quot;| TUN
    TUN &lt;--&gt;|&quot;L3/L2&quot;| Stack
    Stack &lt;--&gt; NIC
</code></pre></div>
<h4 id="4522-tun-tap">45.2.2 TUN 与 TAP 的区别<a class="headerlink" href="#4522-tun-tap" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">TUN 设备</th>
<th style="text-align: left;">TAP 设备</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">工作层次</td>
<td style="text-align: left;">L3 网络层</td>
<td style="text-align: left;">L2 数据链路层</td>
</tr>
<tr>
<td style="text-align: left;">处理数据</td>
<td style="text-align: left;">IP 包（裸 IP）</td>
<td style="text-align: left;">以太网帧（含 MAC）</td>
</tr>
<tr>
<td style="text-align: left;">MAC 地址</td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">有</td>
</tr>
<tr>
<td style="text-align: left;">典型应用</td>
<td style="text-align: left;">VPN、Flannel UDP</td>
<td style="text-align: left;">虚拟机网桥、OpenVPN TAP</td>
</tr>
<tr>
<td style="text-align: left;">抓包格式</td>
<td style="text-align: left;">raw IP packet</td>
<td style="text-align: left;">完整以太网帧</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;TUN 设备 - L3&quot;
        TUN[&quot;flannel0&lt;br/&gt;TUN&quot;]
        IP[&quot;IP 包&lt;br/&gt;无 MAC&quot;]
    end

    subgraph &quot;TAP 设备 - L2&quot;
        TAP[&quot;tap0&lt;br/&gt;TAP&quot;]
        ETH[&quot;以太网帧&lt;br/&gt;有 MAC&quot;]
    end

    TUN --&gt; IP
    TAP --&gt; ETH
</code></pre></div>
<h4 id="4523-tuntap">45.2.3 TUN/TAP 数据传输流程<a class="headerlink" href="#4523-tuntap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant App as 应用程序 A
    participant Stack as TCP/IP 协议栈
    participant TUN as TUN 设备
    participant DEV as /dev/net/tun
    participant Proc as flanneld 进程
    participant NIC as 物理网卡

    App-&gt;&gt;Stack: 1. 发送数据包
    Stack-&gt;&gt;TUN: 2. 路由到 TUN 设备
    TUN-&gt;&gt;DEV: 3. 写入字符设备
    DEV-&gt;&gt;Proc: 4. 用户空间读取
    Proc-&gt;&gt;Proc: 5. 封装处理
    Proc-&gt;&gt;Stack: 6. 重新发送
    Stack-&gt;&gt;NIC: 7. 物理网卡发出
</code></pre></div>
<p><strong>数据流经过程说明</strong>：</p>
<ol>
<li><strong>应用发包</strong>：用户空间应用产生数据包</li>
<li><strong>协议栈处理</strong>：经过 TCP/IP 协议栈</li>
<li><strong>路由到 TUN</strong>：根据路由表转发到 TUN 设备</li>
<li><strong>字符设备读取</strong>：数据写入 <code>/dev/net/tun</code></li>
<li><strong>用户空间处理</strong>：flanneld 进程读取数据</li>
<li><strong>封装转发</strong>：flanneld 封装后重新发送</li>
<li><strong>物理发送</strong>：通过物理网卡发出</li>
</ol>
<h3 id="453-tuntap">45.3 TUN/TAP 与内核模块的效率对比<a class="headerlink" href="#453-tuntap" title="Permanent link">&para;</a></h3>
<h4 id="4531">45.3.1 效率差异<a class="headerlink" href="#4531" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;TUN/TAP 方式 - 效率较低&quot;
        U1[&quot;用户空间&quot;] --&gt; K1[&quot;内核空间&quot;]
        K1 --&gt; U1
        U1 --&gt; K2[&quot;内核空间&quot;]
        K2 --&gt; Out1[&quot;物理网卡&quot;]
    end

    subgraph &quot;内核模块方式 - 效率较高&quot;
        KM[&quot;内核模块&lt;br/&gt;VxLAN&quot;]
        KM --&gt; Out2[&quot;物理网卡&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">方式</th>
<th style="text-align: left;">数据路径</th>
<th style="text-align: left;">上下文切换</th>
<th style="text-align: left;">效率</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">TUN/TAP</td>
<td style="text-align: left;">用户空间 ↔ 内核空间 多次</td>
<td style="text-align: left;">多次</td>
<td style="text-align: left;">较低</td>
</tr>
<tr>
<td style="text-align: left;">内核模块</td>
<td style="text-align: left;">全程内核空间</td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">较高</td>
</tr>
</tbody>
</table>
<h4 id="4532-tuntap">45.3.2 为什么 TUN/TAP 效率低<a class="headerlink" href="#4532-tuntap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    A[&quot;内核空间&lt;br/&gt;原始数据&quot;] --&gt; B[&quot;用户空间&lt;br/&gt;数据拷贝&quot;]
    B --&gt; C[&quot;用户空间处理&quot;]
    C --&gt; D[&quot;内核空间&lt;br/&gt;数据拷贝&quot;]
    D --&gt; E[&quot;物理网卡&quot;]

    style B fill:#f9f,stroke:#333
    style D fill:#f9f,stroke:#333
</code></pre></div>
<p><strong>效率低的原因</strong>：</p>
<ol>
<li><strong>数据拷贝开销</strong>：内核 ↔ 用户空间多次拷贝</li>
<li><strong>上下文切换</strong>：用户态/内核态切换消耗 CPU</li>
<li><strong>中断处理</strong>：额外的中断开销</li>
<li><strong>调度延迟</strong>：用户空间进程调度不确定</li>
</ol>
<blockquote>
<p>[!NOTE]
<strong>典型案例</strong>：OpenVPN 使用 TUN/TAP 设备，效率低于 WireGuard（内核模块实现）</p>
</blockquote>
<h3 id="454-flannel-tun">45.4 Flannel 中的 TUN 设备实践<a class="headerlink" href="#454-flannel-tun" title="Permanent link">&para;</a></h3>
<h4 id="4541-tun">45.4.1 查看 TUN 设备<a class="headerlink" href="#4541-tun" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看网络设备详情</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>flannel0

<span class="c1"># 输出示例</span>
<span class="c1"># flannel0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1472 qdisc pfifo_fast</span>
<span class="c1">#     link/none</span>
<span class="c1">#     tun type tun pi off vnet_hdr off persist off</span>
</code></pre></div>
<p><strong>关键信息解读</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>link/none</code></td>
<td style="text-align: left;">无 MAC 地址（TUN 设备特征）</td>
</tr>
<tr>
<td style="text-align: left;"><code>tun type tun</code></td>
<td style="text-align: left;">TUN 类型设备</td>
</tr>
<tr>
<td style="text-align: left;"><code>POINTOPOINT</code></td>
<td style="text-align: left;">点对点连接</td>
</tr>
</tbody>
</table>
<h4 id="4542-tuntap">45.4.2 查看 TUN/TAP 设备类型<a class="headerlink" href="#4542-tuntap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 列出所有 TUN/TAP 设备</span>
ip<span class="w"> </span>tuntap<span class="w"> </span>list

<span class="c1"># 输出示例</span>
<span class="c1"># flannel0: tun</span>
</code></pre></div>
<h4 id="4543">45.4.3 查看设备关联进程<a class="headerlink" href="#4543" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 TUN 设备关联的进程</span>
ip<span class="w"> </span>-d<span class="w"> </span>tuntap<span class="w"> </span>show

<span class="c1"># 输出示例</span>
<span class="c1"># flannel0: tun persist</span>
<span class="c1">#   Attached to processes: flanneld(1220)</span>
</code></pre></div>
<p><strong>这说明</strong>：</p>
<ul>
<li><code>flannel0</code> 设备一端连接 TCP/IP 协议栈</li>
<li>另一端连接用户空间的 <code>flanneld</code> 进程</li>
</ul>
<h4 id="4544">45.4.4 验证进程<a class="headerlink" href="#4544" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 flanneld 进程</span>
ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>flanneld

<span class="c1"># 输出示例</span>
<span class="c1"># root  1220  0.0  0.5 1234567 12345 ?  Sl  10:00  0:01 /opt/bin/flanneld</span>

<span class="c1"># 查看网络连接</span>
netstat<span class="w"> </span>-anp<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>flanneld
</code></pre></div>
<h3 id="455-flannel-udp">45.5 Flannel UDP 模式配置<a class="headerlink" href="#455-flannel-udp" title="Permanent link">&para;</a></h3>
<h4 id="4551">45.5.1 配置示例<a class="headerlink" href="#4551" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># ConfigMap 配置</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-cfg</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">net-conf.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<span class="w">      </span><span class="no">&quot;Backend&quot;: {</span>
<span class="w">        </span><span class="no">&quot;Type&quot;: &quot;udp&quot;</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<h4 id="4552-tun">45.5.2 挂载 TUN 设备<a class="headerlink" href="#4552-tun" title="Permanent link">&para;</a></h4>
<p>在非特权模式下，需要显式挂载 <code>/dev/net/tun</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-ds</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev-net-tun</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/net/tun</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev-net-tun</span>
<span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/net/tun</span>
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>非特权模式注意事项</strong></p>
<p>在非特权模式（<code>privileged: false</code>）下：</p>
<ul>
<li>必须显式挂载 <code>/dev/net/tun</code></li>
<li>需要添加 <code>NET_ADMIN</code> 和 <code>NET_RAW</code> capabilities</li>
<li>特权模式下无需额外配置</li>
</ul>
</blockquote>
<h4 id="4553-udp">45.5.3 验证 UDP 模式<a class="headerlink" href="#4553-udp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 flanneld 日志</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>kube-flannel<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>flannel

<span class="c1"># 应该看到</span>
<span class="c1"># Found network config - Backend type: udp</span>
</code></pre></div>
<h3 id="456-tuntap">45.6 其他 TUN/TAP 应用场景<a class="headerlink" href="#456-tuntap" title="Permanent link">&para;</a></h3>
<h4 id="4561">45.6.1 常见应用<a class="headerlink" href="#4561" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">应用</th>
<th style="text-align: left;">设备类型</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">OpenVPN</td>
<td style="text-align: left;">TUN/TAP</td>
<td style="text-align: left;">VPN 隧道</td>
</tr>
<tr>
<td style="text-align: left;">Flannel UDP</td>
<td style="text-align: left;">TUN</td>
<td style="text-align: left;">容器网络</td>
</tr>
<tr>
<td style="text-align: left;">Calico VPP</td>
<td style="text-align: left;">TUN</td>
<td style="text-align: left;">高性能转发</td>
</tr>
<tr>
<td style="text-align: left;">虚拟机网桥</td>
<td style="text-align: left;">TAP</td>
<td style="text-align: left;">VM 网络</td>
</tr>
<tr>
<td style="text-align: left;">WireGuard</td>
<td style="text-align: left;">内核模块</td>
<td style="text-align: left;">高效 VPN</td>
</tr>
</tbody>
</table>
<h4 id="4562-tun-calico-vpp">45.6.2 TUN 设备在 Calico VPP 中的应用<a class="headerlink" href="#4562-tun-calico-vpp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    Pod[&quot;Pod&quot;] --&gt; TUN[&quot;TUN 设备&quot;]
    TUN --&gt;|&quot;点对点&quot;| VPP[&quot;VPP&lt;br/&gt;用户空间&quot;]
    VPP --&gt; DPDK[&quot;DPDK&quot;]
    DPDK --&gt; NIC[&quot;物理网卡&quot;]
</code></pre></div>
<h3 id="457">45.7 章节小结<a class="headerlink" href="#457" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((TUN/TAP 精讲))
    设备类型
      TUN - L3 网络层
      TAP - L2 数据链路层
    工作原理
      用户空间 ↔ 内核空间
      字符设备 /dev/net/tun
      一端协议栈 一端进程
    效率对比
      TUN/TAP 多次拷贝
      内核模块 全程内核
    应用场景
      Flannel UDP
      OpenVPN
      Calico VPP
    实践验证
      ip tuntap list
      ip -d tuntap show
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>TUN/TAP 设备要点总结</strong>：</p>
<ol>
<li><strong>设备类型</strong>：</li>
<li>TUN：L3 网络层，处理 IP 包，无 MAC 地址</li>
<li>
<p>TAP：L2 数据链路层，处理以太网帧，有 MAC 地址</p>
</li>
<li>
<p><strong>工作原理</strong>：</p>
</li>
<li>一端连接 TCP/IP 协议栈（内核空间）</li>
<li>一端连接用户空间进程（如 flanneld）</li>
<li>
<p>通过 <code>/dev/net/tun</code> 字符设备通信</p>
</li>
<li>
<p><strong>效率对比</strong>：</p>
</li>
<li>TUN/TAP：用户空间处理，效率较低</li>
<li>
<p>内核模块（VxLAN）：全程内核处理，效率较高</p>
</li>
<li>
<p><strong>Flannel 配置</strong>：</p>
</li>
<li>UDP 模式使用 TUN 设备</li>
<li>非特权模式需挂载 <code>/dev/net/tun</code></li>
<li>
<p>需要 <code>NET_ADMIN</code> 和 <code>NET_RAW</code> 权限</p>
</li>
<li>
<p><strong>验证命令</strong>：</p>
</li>
<li><code>ip tuntap list</code>：列出 TUN/TAP 设备</li>
<li><code>ip -d tuntap show</code>：查看设备关联进程</li>
</ol>
</blockquote>
<hr />
<h2 id="flannel-udp">第四十六章 Flannel-UDP 模式<a class="headerlink" href="#flannel-udp" title="Permanent link">&para;</a></h2>
<p>本章深入讲解 Flannel 的 UDP 封装模式，包括同节点和跨节点的 Pod 通信原理及数据包封装机制。</p>
<h3 id="461">46.1 背景与概述<a class="headerlink" href="#461" title="Permanent link">&para;</a></h3>
<h4 id="4611-flannel">46.1.1 Flannel 后端类型<a class="headerlink" href="#4611-flannel" title="Permanent link">&para;</a></h4>
<p>Flannel 支持多种后端（Backend）类型：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">后端类型</th>
<th style="text-align: left;">封装方式</th>
<th style="text-align: left;">性能</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>UDP</strong></td>
<td style="text-align: left;">TUN + UDP 封装</td>
<td style="text-align: left;">较低</td>
<td style="text-align: left;">通用/测试</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VxLAN</strong></td>
<td style="text-align: left;">内核 VxLAN</td>
<td style="text-align: left;">较高</td>
<td style="text-align: left;">生产推荐</td>
</tr>
<tr>
<td style="text-align: left;"><strong>host-gw</strong></td>
<td style="text-align: left;">主机路由</td>
<td style="text-align: left;">最高</td>
<td style="text-align: left;">同子网</td>
</tr>
<tr>
<td style="text-align: left;"><strong>IPIP</strong></td>
<td style="text-align: left;">IP-in-IP</td>
<td style="text-align: left;">中等</td>
<td style="text-align: left;">跨子网</td>
</tr>
</tbody>
</table>
<h4 id="4612-udp">46.1.2 UDP 模式特点<a class="headerlink" href="#4612-udp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;UDP 模式架构&quot;
        Pod[&quot;Pod&quot;] --&gt; TUN[&quot;flannel0&lt;br/&gt;TUN 设备&quot;]
        TUN --&gt; FD[&quot;flanneld 进程&lt;br/&gt;用户空间&quot;]
        FD --&gt;|&quot;UDP 封装&quot;| ETH[&quot;eth0&lt;br/&gt;物理网卡&quot;]
    end
</code></pre></div>
<p><strong>UDP 模式核心特点</strong>：</p>
<ul>
<li>使用 TUN 设备连接内核与用户空间</li>
<li>flanneld 进程在<strong>用户空间</strong>处理封装</li>
<li>通过 UDP 协议封装原始 IP 包</li>
<li>监听端口：<strong>8285</strong></li>
</ul>
<h3 id="462-pod">46.2 同节点 Pod 通信<a class="headerlink" href="#462-pod" title="Permanent link">&para;</a></h3>
<h4 id="4621">46.2.1 通信架构<a class="headerlink" href="#4621" title="Permanent link">&para;</a></h4>
<p>同节点 Pod 通信通过 <strong>Linux Bridge</strong> 实现 L2 交换。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Worker 节点&quot;
        subgraph &quot;Pod A&quot;
            PodA[&quot;10.244.2.2/24&quot;]
            EthA[&quot;eth0&quot;]
        end

        subgraph &quot;Pod B&quot;
            PodB[&quot;10.244.2.3/24&quot;]
            EthB[&quot;eth0&quot;]
        end

        CNI0[&quot;cni0&lt;br/&gt;Linux Bridge&quot;]
        VethA[&quot;veth-podA&quot;]
        VethB[&quot;veth-podB&quot;]
    end

    EthA --&gt; VethA
    EthB --&gt; VethB
    VethA --&gt; CNI0
    VethB --&gt; CNI0
</code></pre></div>
<h4 id="4622">46.2.2 通信原理<a class="headerlink" href="#4622" title="Permanent link">&para;</a></h4>
<p><strong>路由表分析</strong>（Pod 内部）：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod 内查看路由</span>
ip<span class="w"> </span>route

<span class="c1"># 输出示例</span>
<span class="m">10</span>.244.2.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>scope<span class="w"> </span>link<span class="w">  </span><span class="c1"># 同网段走 L2</span>
default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.244.2.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w">     </span><span class="c1"># 跨网段走网关</span>
</code></pre></div>
<p><strong>关键点</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特征</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">掩码</td>
<td style="text-align: left;">/24（同网段）</td>
</tr>
<tr>
<td style="text-align: left;">网关</td>
<td style="text-align: left;">0.0.0.0（无网关）</td>
</tr>
<tr>
<td style="text-align: left;">通信层次</td>
<td style="text-align: left;">L2 交换</td>
</tr>
<tr>
<td style="text-align: left;">设备</td>
<td style="text-align: left;">cni0 Bridge</td>
</tr>
</tbody>
</table>
<h4 id="4623-bridge-mac">46.2.3 Bridge MAC 地址学习<a class="headerlink" href="#4623-bridge-mac" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看网卡所属 Bridge</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>veth-pod

<span class="c1"># 输出示例</span>
<span class="c1"># veth-pod: ... master cni0 ...</span>

<span class="c1"># 查看 Bridge MAC 表</span>
bridge<span class="w"> </span>fdb<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>cni0

<span class="c1"># 输出示例</span>
<span class="c1"># 8e:b1:82:xx:xx:xx dev veth-podA master cni0</span>
<span class="c1"># 7a:c3:91:xx:xx:xx dev veth-podB master cni0</span>
</code></pre></div>
<h3 id="463-pod">46.3 跨节点 Pod 通信<a class="headerlink" href="#463-pod" title="Permanent link">&para;</a></h3>
<h4 id="4631">46.3.1 通信架构<a class="headerlink" href="#4631" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;10.244.2.3
    participant TUN as flannel0&lt;br/&gt;TUN
    participant FD as flanneld
    participant ETH as eth0
    participant Net as 物理网络
    participant ETH2 as eth0
    participant FD2 as flanneld
    participant TUN2 as flannel0
    participant PodB as Pod B&lt;br/&gt;10.244.0.27

    PodA-&gt;&gt;TUN: 1. IP 包发送
    TUN-&gt;&gt;FD: 2. 读取数据
    FD-&gt;&gt;FD: 3. 查询目标节点
    FD-&gt;&gt;ETH: 4. UDP 封装发送
    ETH-&gt;&gt;Net: 5. 物理传输
    Net-&gt;&gt;ETH2: 6. 到达目标节点
    ETH2-&gt;&gt;FD2: 7. 接收 UDP
    FD2-&gt;&gt;TUN2: 8. 解封装写入
    TUN2-&gt;&gt;PodB: 9. 交付目标 Pod
</code></pre></div>
<h4 id="4632">46.3.2 路由表分析<a class="headerlink" href="#4632" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 宿主机路由表</span>
ip<span class="w"> </span>route

<span class="c1"># 输出示例</span>
<span class="m">10</span>.244.0.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.244.2.1<span class="w"> </span>dev<span class="w"> </span>flannel0<span class="w">  </span><span class="c1"># 目标网段走 flannel0</span>
<span class="m">10</span>.244.2.0/24<span class="w"> </span>dev<span class="w"> </span>cni0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w">        </span><span class="c1"># 本地网段走 cni0</span>
</code></pre></div>
<p><strong>路由匹配过程</strong>：</p>
<ol>
<li>目标地址 <code>10.244.0.27</code></li>
<li>匹配路由 <code>10.244.0.0/24 via 10.244.2.1 dev flannel0</code></li>
<li>数据包发送到 <code>flannel0</code> TUN 设备</li>
</ol>
<h4 id="4633-tun-flanneld">46.3.3 TUN 设备与 flanneld<a class="headerlink" href="#4633-tun-flanneld" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 flannel0 设备</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>flannel0

<span class="c1"># 输出示例</span>
<span class="c1"># flannel0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt;</span>
<span class="c1">#     link/none</span>
<span class="c1">#     tun type tun pi off</span>

<span class="c1"># 查看关联进程</span>
ip<span class="w"> </span>-d<span class="w"> </span>tuntap<span class="w"> </span>show

<span class="c1"># 输出示例</span>
<span class="c1"># flannel0: tun persist</span>
<span class="c1">#   Attached to processes: flanneld(1220)</span>
</code></pre></div>
<h4 id="4634-flanneld">46.3.4 flanneld 工作原理<a class="headerlink" href="#4634-flanneld" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;flanneld 进程&quot;
        Read[&quot;读取 TUN 数据&quot;]
        Query[&quot;查询 API Server&lt;br/&gt;获取目标节点信息&quot;]
        Encap[&quot;UDP 封装&quot;]
        Send[&quot;发送到目标节点&quot;]
    end

    TUN[&quot;flannel0&quot;] --&gt; Read
    Read --&gt; Query
    Query --&gt; Encap
    Encap --&gt; Send
    Send --&gt; ETH[&quot;eth0&quot;]
</code></pre></div>
<p><strong>flanneld 职责</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">职责</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">监听 TUN</td>
<td style="text-align: left;">从 flannel0 读取原始 IP 包</td>
</tr>
<tr>
<td style="text-align: left;">查询路由</td>
<td style="text-align: left;">从 API Server/etcd 获取 Pod 所在节点</td>
</tr>
<tr>
<td style="text-align: left;">UDP 封装</td>
<td style="text-align: left;">将原始包封装为 UDP 数据</td>
</tr>
<tr>
<td style="text-align: left;">发送数据</td>
<td style="text-align: left;">通过 8285 端口发送到目标节点</td>
</tr>
</tbody>
</table>
<h3 id="464">46.4 数据包封装分析<a class="headerlink" href="#464" title="Permanent link">&para;</a></h3>
<h4 id="4641">46.4.1 封装结构<a class="headerlink" href="#4641" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;原始包&quot;
        IP1[&quot;IP Header&lt;br/&gt;Src: 10.244.2.3&lt;br/&gt;Dst: 10.244.0.27&quot;]
        Data[&quot;Payload&lt;br/&gt;ICMP/TCP/...&quot;]
    end

    subgraph &quot;封装后&quot;
        IP2[&quot;外层 IP&lt;br/&gt;Src: 172.18.0.3&lt;br/&gt;Dst: 172.18.0.2&quot;]
        UDP[&quot;UDP Header&lt;br/&gt;Port: 8285&quot;]
        IP1_2[&quot;原始 IP&quot;]
        Data_2[&quot;原始 Payload&quot;]
    end

    IP1 --&gt; IP1_2
    Data --&gt; Data_2
</code></pre></div>
<h4 id="4642">46.4.2 封装字段详解<a class="headerlink" href="#4642" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">层次</th>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>外层 IP</strong></td>
<td style="text-align: left;">Src IP</td>
<td style="text-align: left;">源节点物理 IP</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">Dst IP</td>
<td style="text-align: left;">目标节点物理 IP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>UDP</strong></td>
<td style="text-align: left;">Src Port</td>
<td style="text-align: left;">随机高端口</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">Dst Port</td>
<td style="text-align: left;">8285（flanneld）</td>
</tr>
<tr>
<td style="text-align: left;"><strong>内层（原始）</strong></td>
<td style="text-align: left;">Src IP</td>
<td style="text-align: left;">源 Pod IP</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">Dst IP</td>
<td style="text-align: left;">目标 Pod IP</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">Payload</td>
<td style="text-align: left;">原始数据</td>
</tr>
</tbody>
</table>
<h4 id="4643">46.4.3 抓包验证<a class="headerlink" href="#4643" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 flannel0 上抓包（裸 IP）</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>flannel0<span class="w"> </span>-nn

<span class="c1"># 输出示例（raw IP，无 MAC）</span>
<span class="c1"># IP 10.244.2.3 &gt; 10.244.0.27: ICMP echo request</span>

<span class="c1"># 在 eth0 上抓包（UDP 封装）</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>port<span class="w"> </span><span class="m">8285</span>

<span class="c1"># 输出示例</span>
<span class="c1"># IP 172.18.0.3.xxxxx &gt; 172.18.0.2.8285: UDP, length xxx</span>
</code></pre></div>
<p><strong>Wireshark 解码技巧</strong>：</p>
<div class="highlight"><pre><span></span><code># 将 8285 端口的 UDP 数据解码为 IPv4
Analyze -&gt; Decode As -&gt; UDP port 8285 -&gt; IPv4
</code></pre></div>
<h3 id="465-mtu">46.5 MTU 设置<a class="headerlink" href="#465-mtu" title="Permanent link">&para;</a></h3>
<h4 id="4651-mtu-1472">46.5.1 为什么 MTU 是 1472<a class="headerlink" href="#4651-mtu-1472" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    ETH[&quot;eth0 MTU&lt;br/&gt;1500&quot;] --&gt; UDP[&quot;UDP Header&lt;br/&gt;8 bytes&quot;]
    UDP --&gt; IP[&quot;IP Header&lt;br/&gt;20 bytes&quot;]
    IP --&gt; Payload[&quot;Payload&lt;br/&gt;1472 bytes&quot;]
</code></pre></div>
<p><strong>MTU 计算</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">组成</th>
<th style="text-align: left;">大小</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">物理网卡 MTU</td>
<td style="text-align: left;">1500 bytes</td>
</tr>
<tr>
<td style="text-align: left;">- 外层 IP Header</td>
<td style="text-align: left;">20 bytes</td>
</tr>
<tr>
<td style="text-align: left;">- UDP Header</td>
<td style="text-align: left;">8 bytes</td>
</tr>
<tr>
<td style="text-align: left;">= flannel0 MTU</td>
<td style="text-align: left;"><strong>1472 bytes</strong></td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
<strong>MTU 不匹配问题</strong></p>
<p>如果内层 MTU 设置过大，会导致：</p>
<ul>
<li>数据包分片</li>
<li>传输效率降低</li>
<li>可能出现通信失败</li>
</ul>
</blockquote>
<h3 id="466-udp">46.6 UDP 模式配置<a class="headerlink" href="#466-udp" title="Permanent link">&para;</a></h3>
<h4 id="4661-configmap">46.6.1 ConfigMap 配置<a class="headerlink" href="#4661-configmap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-cfg</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">net-conf.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<span class="w">      </span><span class="no">&quot;Backend&quot;: {</span>
<span class="w">        </span><span class="no">&quot;Type&quot;: &quot;udp&quot;</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<h4 id="4662-daemonset">46.6.2 DaemonSet 配置（非特权模式）<a class="headerlink" href="#4662-daemonset" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-ds</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">          </span><span class="nt">capabilities</span><span class="p">:</span>
<span class="w">            </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;NET_ADMIN&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;NET_RAW&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev-net-tun</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/net/tun</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev-net-tun</span>
<span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/net/tun</span>
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>非特权模式必须挂载 /dev/net/tun</strong></p>
<p>否则 flanneld 无法创建 flannel0 TUN 设备，Pod 会 CrashLoopBackOff</p>
</blockquote>
<h3 id="467-udp-vs-vxlan">46.7 UDP 模式 vs VxLAN 模式<a class="headerlink" href="#467-udp-vs-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="4671">46.7.1 效率对比<a class="headerlink" href="#4671" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;UDP 模式 - 效率较低&quot;
        U1[&quot;内核空间&quot;] --&gt;|&quot;数据拷贝&quot;| U2[&quot;用户空间&lt;br/&gt;flanneld&quot;]
        U2 --&gt;|&quot;数据拷贝&quot;| U3[&quot;内核空间&quot;]
        U3 --&gt; U4[&quot;eth0&quot;]
    end

    subgraph &quot;VxLAN 模式 - 效率较高&quot;
        V1[&quot;内核空间&quot;] --&gt; V2[&quot;VxLAN 模块&lt;br/&gt;内核&quot;]
        V2 --&gt; V3[&quot;eth0&quot;]
    end
</code></pre></div>
<h4 id="4672">46.7.2 对比表<a class="headerlink" href="#4672" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">UDP 模式</th>
<th style="text-align: left;">VxLAN 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">封装位置</td>
<td style="text-align: left;">用户空间（flanneld）</td>
<td style="text-align: left;">内核空间</td>
</tr>
<tr>
<td style="text-align: left;">数据拷贝</td>
<td style="text-align: left;">多次（内核↔用户）</td>
<td style="text-align: left;">少（内核内）</td>
</tr>
<tr>
<td style="text-align: left;">上下文切换</td>
<td style="text-align: left;">有</td>
<td style="text-align: left;">无</td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;">较低</td>
<td style="text-align: left;">较高</td>
</tr>
<tr>
<td style="text-align: left;">调试难度</td>
<td style="text-align: left;">较易</td>
<td style="text-align: left;">较难</td>
</tr>
<tr>
<td style="text-align: left;">生产推荐</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">✅</td>
</tr>
</tbody>
</table>
<h3 id="468">46.8 章节小结<a class="headerlink" href="#468" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Flannel UDP 模式))
    同节点通信
      cni0 Bridge
      L2 交换
      veth pair
    跨节点通信
      flannel0 TUN
      flanneld 用户空间
      UDP 封装 Port 8285
    数据封装
      外层 IP 节点地址
      UDP Header
      内层 IP Pod 地址
    配置要点
      Backend Type udp
      挂载 /dev/net/tun
      MTU 1472
    效率对比
      低于 VxLAN
      用户空间处理
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Flannel UDP 模式要点总结</strong>：</p>
<ol>
<li><strong>同节点通信</strong>：</li>
<li>通过 <code>cni0</code> Linux Bridge 实现 L2 交换</li>
<li>Pod 使用 /24 掩码，在同一网段</li>
<li>
<p>无需封装，直接二层转发</p>
</li>
<li>
<p><strong>跨节点通信</strong>：</p>
</li>
<li>数据包发送到 <code>flannel0</code> TUN 设备</li>
<li>flanneld 进程读取并 UDP 封装</li>
<li>
<p>通过 8285 端口发送到目标节点</p>
</li>
<li>
<p><strong>封装机制</strong>：</p>
</li>
<li>外层：节点 IP + UDP 8285</li>
<li>内层：原始 Pod IP + 数据</li>
<li>
<p>MTU 设置为 1472（1500-20-8）</p>
</li>
<li>
<p><strong>配置要点</strong>：</p>
</li>
<li>Backend Type 设置为 <code>udp</code></li>
<li>非特权模式需挂载 <code>/dev/net/tun</code></li>
<li>
<p>需要 <code>NET_ADMIN</code> 和 <code>NET_RAW</code> 权限</p>
</li>
<li>
<p><strong>生产建议</strong>：</p>
</li>
<li>UDP 模式效率低于 VxLAN</li>
<li>生产环境推荐使用 VxLAN 或 host-gw</li>
</ol>
</blockquote>
<hr />
<h2 id="flannel-vxlan">第四十七章 Flannel-VxLAN 模式<a class="headerlink" href="#flannel-vxlan" title="Permanent link">&para;</a></h2>
<p>本章深入讲解 Flannel 的 VxLAN 封装模式，包括配置方法、内核封装机制、ARP/FDB 表工作原理，以及 DirectRouting 优化模式。</p>
<h3 id="471">47.1 背景与概述<a class="headerlink" href="#471" title="Permanent link">&para;</a></h3>
<h4 id="4711-vxlan">47.1.1 VxLAN 模式定位<a class="headerlink" href="#4711-vxlan" title="Permanent link">&para;</a></h4>
<p>Flannel VxLAN 模式是<strong>生产环境推荐</strong>的后端类型：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Flannel 后端选择&quot;
        UDP[&quot;UDP 模式&lt;br/&gt;❌ 不推荐&quot;]
        VxLAN[&quot;VxLAN 模式&lt;br/&gt;✅ 生产推荐&quot;]
        HostGW[&quot;host-gw 模式&lt;br/&gt;✅ 同子网最优&quot;]
    end

    VxLAN --&gt;|&quot;跨子网&quot;| Best[&quot;最佳选择&quot;]
    HostGW --&gt;|&quot;同子网&quot;| Best
</code></pre></div>
<h4 id="4712-calico-vxlan">47.1.2 与 Calico VxLAN 的关系<a class="headerlink" href="#4712-calico-vxlan" title="Permanent link">&para;</a></h4>
<p>Flannel 官方明确表示 VxLAN 模式设计目标是支持从 Calico 迁移：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Flannel VxLAN</th>
<th style="text-align: left;">Calico VxLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">封装机制</td>
<td style="text-align: left;">相同</td>
<td style="text-align: left;">相同</td>
</tr>
<tr>
<td style="text-align: left;">FDB 表</td>
<td style="text-align: left;">相同</td>
<td style="text-align: left;">相同</td>
</tr>
<tr>
<td style="text-align: left;">VNI</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">4096</td>
</tr>
<tr>
<td style="text-align: left;">端口</td>
<td style="text-align: left;">8472</td>
<td style="text-align: left;">4789</td>
</tr>
<tr>
<td style="text-align: left;">网络策略</td>
<td style="text-align: left;">不支持</td>
<td style="text-align: left;">支持</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>生产建议</strong></p>
<ul>
<li>如需<strong>网络策略</strong>功能，使用 Calico</li>
<li>如追求<strong>简单稳定</strong>，使用 Flannel</li>
<li>可使用 <strong>Flannel + Calico 组合</strong>：Flannel 负责网络，Calico 负责策略</li>
</ul>
</blockquote>
<h3 id="472-vxlan">47.2 VxLAN 配置<a class="headerlink" href="#472-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="4721-configmap">47.2.1 ConfigMap 配置<a class="headerlink" href="#4721-configmap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-cfg</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">net-conf.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<span class="w">      </span><span class="no">&quot;Backend&quot;: {</span>
<span class="w">        </span><span class="no">&quot;Type&quot;: &quot;vxlan&quot;</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<h4 id="4722-vxlan">47.2.2 验证 VxLAN 设备<a class="headerlink" href="#4722-vxlan" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 flannel.1 VxLAN 设备</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>flannel.1

<span class="c1"># 输出示例</span>
<span class="c1"># flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span>
<span class="c1">#     link/ether 7c:a2:9a:xx:xx:xx brd ff:ff:ff:ff:ff:ff</span>
<span class="c1">#     vxlan id 1 local 172.18.0.2 dev eth0 srcport 0 0 dstport 8472 ...</span>

<span class="c1"># 查看 FDB 表</span>
bridge<span class="w"> </span>fdb<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>flannel.1
</code></pre></div>
<h3 id="473-vxlan">47.3 VxLAN 通信原理<a class="headerlink" href="#473-vxlan" title="Permanent link">&para;</a></h3>
<h4 id="4731">47.3.1 通信架构<a class="headerlink" href="#4731" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;10.244.0.5
    participant CNI as cni0
    participant FL as flannel.1
    participant Kernel as 内核 VxLAN
    participant ETH as eth0
    participant Net as 物理网络
    participant ETH2 as eth0
    participant Kernel2 as 内核 VxLAN
    participant FL2 as flannel.1
    participant CNI2 as cni0
    participant PodB as Pod B&lt;br/&gt;10.244.2.2

    PodA-&gt;&gt;CNI: 1. 发送 IP 包
    CNI-&gt;&gt;FL: 2. 路由转发
    FL-&gt;&gt;Kernel: 3. VxLAN 封装
    Kernel-&gt;&gt;ETH: 4. UDP:8472
    ETH-&gt;&gt;Net: 5. 物理传输
    Net-&gt;&gt;ETH2: 6. 到达目标
    ETH2-&gt;&gt;Kernel2: 7. 接收 UDP
    Kernel2-&gt;&gt;FL2: 8. VxLAN 解封装
    FL2-&gt;&gt;CNI2: 9. 路由转发
    CNI2-&gt;&gt;PodB: 10. 交付 Pod
</code></pre></div>
<h4 id="4732">47.3.2 路由表分析<a class="headerlink" href="#4732" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 宿主机路由表</span>
ip<span class="w"> </span>route

<span class="c1"># 输出示例</span>
<span class="m">10</span>.244.0.0/24<span class="w"> </span>dev<span class="w"> </span>cni0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w">  </span><span class="c1"># 本地网段</span>
<span class="m">10</span>.244.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.244.2.0<span class="w"> </span>dev<span class="w"> </span>flannel.1<span class="w">      </span><span class="c1"># 远端网段走 flannel.1</span>
</code></pre></div>
<p><strong>路由决策过程</strong>：</p>
<ol>
<li>Pod 发送数据包到 <code>10.244.2.2</code></li>
<li>匹配路由 <code>10.244.2.0/24 via 10.244.2.0 dev flannel.1</code></li>
<li>下一跳 <code>10.244.2.0</code>，出接口 <code>flannel.1</code></li>
</ol>
<h3 id="474-arp-fdb">47.4 ARP 与 FDB 表机制<a class="headerlink" href="#474-arp-fdb" title="Permanent link">&para;</a></h3>
<h4 id="4741">47.4.1 工作流程<a class="headerlink" href="#4741" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;封装过程&quot;
        Route[&quot;查询路由表&lt;br/&gt;确定下一跳&quot;]
        ARP[&quot;查询 ARP 表&lt;br/&gt;获取下一跳 MAC&quot;]
        FDB[&quot;查询 FDB 表&lt;br/&gt;获取目标节点 IP&quot;]
        Encap[&quot;VxLAN 封装&lt;br/&gt;发送到目标节点&quot;]
    end

    Route --&gt; ARP
    ARP --&gt; FDB
    FDB --&gt; Encap
</code></pre></div>
<h4 id="4742-arp">47.4.2 ARP 表作用<a class="headerlink" href="#4742-arp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 ARP 缓存</span>
arp<span class="w"> </span>-n

<span class="c1"># 或在 Pod 内查看</span>
ip<span class="w"> </span>neigh

<span class="c1"># 输出示例</span>
<span class="m">10</span>.244.2.0<span class="w"> </span>dev<span class="w"> </span>flannel.1<span class="w"> </span>lladdr<span class="w"> </span><span class="m">24</span>:81:58:xx:xx:xx<span class="w"> </span>PERMANENT
</code></pre></div>
<p><strong>ARP 表功能</strong>：</p>
<ul>
<li>存储下一跳 IP 对应的 MAC 地址</li>
<li>用于封装内层以太网帧</li>
</ul>
<h4 id="4743-fdb">47.4.3 FDB 表作用<a class="headerlink" href="#4743-fdb" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 FDB 表</span>
bridge<span class="w"> </span>fdb<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>flannel.1

<span class="c1"># 输出示例</span>
<span class="m">24</span>:81:58:xx:xx:xx<span class="w"> </span>dev<span class="w"> </span>flannel.1<span class="w"> </span>dst<span class="w"> </span><span class="m">172</span>.18.0.4<span class="w"> </span>self<span class="w"> </span>permanent
</code></pre></div>
<p><strong>FDB 表功能</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">作用</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">MAC → Node IP</td>
<td style="text-align: left;">将目标 MAC 映射到节点 IP</td>
</tr>
<tr>
<td style="text-align: left;">确定封装目标</td>
<td style="text-align: left;">外层 IP 的目标地址</td>
</tr>
<tr>
<td style="text-align: left;">由 flanneld 维护</td>
<td style="text-align: left;">通过 API Server 同步</td>
</tr>
</tbody>
</table>
<h3 id="475">47.5 内核空间封装优势<a class="headerlink" href="#475" title="Permanent link">&para;</a></h3>
<h4 id="4751-vxlan-vs-udp">47.5.1 VxLAN vs UDP 模式<a class="headerlink" href="#4751-vxlan-vs-udp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;VxLAN 模式 - 内核空间&quot;
        V1[&quot;Pod 数据&quot;] --&gt; V2[&quot;内核路由&quot;]
        V2 --&gt; V3[&quot;VxLAN 模块&lt;br/&gt;内核封装&quot;]
        V3 --&gt; V4[&quot;eth0 发送&quot;]
    end

    subgraph &quot;UDP 模式 - 用户空间&quot;
        U1[&quot;Pod 数据&quot;] --&gt; U2[&quot;内核路由&quot;]
        U2 --&gt; U3[&quot;TUN 设备&quot;]
        U3 --&gt;|&quot;上下文切换&quot;| U4[&quot;flanneld&lt;br/&gt;用户空间封装&quot;]
        U4 --&gt;|&quot;上下文切换&quot;| U5[&quot;eth0 发送&quot;]
    end
</code></pre></div>
<h4 id="4752">47.5.2 性能对比<a class="headerlink" href="#4752" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">指标</th>
<th style="text-align: left;">VxLAN 模式</th>
<th style="text-align: left;">UDP 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">封装位置</td>
<td style="text-align: left;">内核空间</td>
<td style="text-align: left;">用户空间</td>
</tr>
<tr>
<td style="text-align: left;">上下文切换</td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">有</td>
</tr>
<tr>
<td style="text-align: left;">数据拷贝</td>
<td style="text-align: left;">少</td>
<td style="text-align: left;">多</td>
</tr>
<tr>
<td style="text-align: left;">CPU 开销</td>
<td style="text-align: left;">低</td>
<td style="text-align: left;">高</td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;"><strong>高</strong></td>
<td style="text-align: left;">低</td>
</tr>
<tr>
<td style="text-align: left;">端口</td>
<td style="text-align: left;">8472</td>
<td style="text-align: left;">8285</td>
</tr>
</tbody>
</table>
<h4 id="4753">47.5.3 识别内核进程<a class="headerlink" href="#4753" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 8472 端口</span>
netstat<span class="w"> </span>-anp<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">8472</span>

<span class="c1"># 输出示例</span>
udp<span class="w">        </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>.0.0.0:8472<span class="w">    </span><span class="m">0</span>.0.0.0:*<span class="w">      </span>-

<span class="c1"># 注意: 进程名为 &quot;-&quot; 表示内核空间进程</span>
<span class="c1"># 用户空间进程会显示如: flanneld(1220)</span>
</code></pre></div>
<h3 id="476">47.6 抓包分析<a class="headerlink" href="#476" title="Permanent link">&para;</a></h3>
<h4 id="4761">47.6.1 抓包命令<a class="headerlink" href="#4761" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 eth0 上抓取 VxLAN 流量</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>port<span class="w"> </span><span class="m">8472</span><span class="w"> </span>-w<span class="w"> </span>vxlan.pcap

<span class="c1"># 测试跨节点通信</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>test-pod<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://10.244.2.2:80
</code></pre></div>
<h4 id="4762-wireshark">47.6.2 Wireshark 解码<a class="headerlink" href="#4762-wireshark" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># 将 8472 端口解码为 VxLAN
Analyze -&gt; Decode As -&gt; UDP port 8472 -&gt; VxLAN
</code></pre></div>
<h4 id="4763">47.6.3 封装结构<a class="headerlink" href="#4763" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;VxLAN 封装&quot;
        L2_Out[&quot;外层 MAC&quot;]
        IP_Out[&quot;外层 IP&lt;br/&gt;节点 IP&quot;]
        UDP[&quot;UDP:8472&quot;]
        VXLAN[&quot;VxLAN Header&lt;br/&gt;VNI=1&quot;]
        L2_In[&quot;内层 MAC&quot;]
        IP_In[&quot;内层 IP&lt;br/&gt;Pod IP&quot;]
        Data[&quot;TCP/HTTP...&quot;]
    end

    L2_Out --&gt; IP_Out --&gt; UDP --&gt; VXLAN --&gt; L2_In --&gt; IP_In --&gt; Data
</code></pre></div>
<h3 id="477-directrouting">47.7 DirectRouting 模式<a class="headerlink" href="#477-directrouting" title="Permanent link">&para;</a></h3>
<h4 id="4771">47.7.1 概念说明<a class="headerlink" href="#4771" title="Permanent link">&para;</a></h4>
<p>DirectRouting 是 VxLAN 模式的优化选项：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">通信方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">节点在<strong>同一二层</strong></td>
<td style="text-align: left;">直接路由（无封装）</td>
</tr>
<tr>
<td style="text-align: left;">节点<strong>跨二层</strong></td>
<td style="text-align: left;">VxLAN 封装</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>与 Calico CrossSubnet 相同</strong></p>
<p>DirectRouting 功能等同于 Calico 的 <code>ipipMode: CrossSubnet</code> 或 <code>vxlanMode: CrossSubnet</code></p>
</blockquote>
<h4 id="4772">47.7.2 配置方法<a class="headerlink" href="#4772" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-cfg</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">net-conf.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<span class="w">      </span><span class="no">&quot;Backend&quot;: {</span>
<span class="w">        </span><span class="no">&quot;Type&quot;: &quot;vxlan&quot;,</span>
<span class="w">        </span><span class="no">&quot;DirectRouting&quot;: true</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<h4 id="4773">47.7.3 路由表变化<a class="headerlink" href="#4773" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 启用 DirectRouting 后的路由表</span>
ip<span class="w"> </span>route

<span class="c1"># 同二层节点 - 直接路由</span>
<span class="m">10</span>.244.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.5.11<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w">   </span><span class="c1"># 下一跳是节点 IP</span>

<span class="c1"># 跨二层节点 - VxLAN 封装</span>
<span class="m">10</span>.244.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.244.2.0<span class="w"> </span>dev<span class="w"> </span>flannel.1<span class="w">  </span><span class="c1"># 走 flannel.1</span>
</code></pre></div>
<h4 id="4774">47.7.4 拓扑示例<a class="headerlink" href="#4774" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;二层域 A (10.1.5.0/24)&quot;
        N1[&quot;Node1&lt;br/&gt;10.1.5.10&quot;]
        N2[&quot;Node2&lt;br/&gt;10.1.5.11&quot;]
    end

    subgraph &quot;二层域 B (10.1.8.0/24)&quot;
        N3[&quot;Node3&lt;br/&gt;10.1.8.10&quot;]
        N4[&quot;Node4&lt;br/&gt;10.1.8.11&quot;]
    end

    GW[&quot;网关/路由器&quot;]

    N1 &lt;--&gt;|&quot;直接路由&quot;| N2
    N3 &lt;--&gt;|&quot;直接路由&quot;| N4
    N1 &lt;--&gt;|&quot;VxLAN&quot;| GW
    GW &lt;--&gt;|&quot;VxLAN&quot;| N3
</code></pre></div>
<h4 id="4775">47.7.5 抓包验证<a class="headerlink" href="#4775" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 同二层通信 - 抓 eth0</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>host<span class="w"> </span><span class="m">10</span>.244.1.2<span class="w"> </span>-w<span class="w"> </span>direct.pcap
<span class="c1"># 结果: 无 VxLAN 封装，直接 IP 路由</span>

<span class="c1"># 跨二层通信 - 抓 flannel.1 或 eth0</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>port<span class="w"> </span><span class="m">8472</span><span class="w"> </span>-w<span class="w"> </span>vxlan.pcap
<span class="c1"># 结果: VxLAN 封装</span>
</code></pre></div>
<h3 id="478-vxlan-mtu">47.8 VxLAN MTU 设置<a class="headerlink" href="#478-vxlan-mtu" title="Permanent link">&para;</a></h3>
<h4 id="4781-mtu">47.8.1 MTU 计算<a class="headerlink" href="#4781-mtu" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    ETH[&quot;eth0 MTU&lt;br/&gt;1500&quot;] --&gt; VXLAN[&quot;VxLAN Header&lt;br/&gt;50 bytes&quot;]
    VXLAN --&gt; Payload[&quot;flannel.1 MTU&lt;br/&gt;1450 bytes&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">组成</th>
<th style="text-align: left;">大小</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">物理网卡 MTU</td>
<td style="text-align: left;">1500 bytes</td>
</tr>
<tr>
<td style="text-align: left;">- 外层 IP Header</td>
<td style="text-align: left;">20 bytes</td>
</tr>
<tr>
<td style="text-align: left;">- UDP Header</td>
<td style="text-align: left;">8 bytes</td>
</tr>
<tr>
<td style="text-align: left;">- VxLAN Header</td>
<td style="text-align: left;">8 bytes</td>
</tr>
<tr>
<td style="text-align: left;">- 外层 MAC</td>
<td style="text-align: left;">14 bytes</td>
</tr>
<tr>
<td style="text-align: left;">= flannel.1 MTU</td>
<td style="text-align: left;"><strong>1450 bytes</strong></td>
</tr>
</tbody>
</table>
<h3 id="479">47.9 章节小结<a class="headerlink" href="#479" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Flannel VxLAN 模式))
    配置
      Backend Type vxlan
      DirectRouting true
    设备
      flannel.1 VxLAN
      端口 8472
      VNI 1
    机制
      ARP 表
      FDB 表
      内核封装
    DirectRouting
      同二层走路由
      跨二层走VxLAN
    优势
      内核空间处理
      无上下文切换
      生产推荐
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Flannel VxLAN 模式要点总结</strong>：</p>
<ol>
<li><strong>配置方式</strong>：</li>
<li><code>Backend.Type: "vxlan"</code></li>
<li>
<p>可选 <code>DirectRouting: true</code> 优化同二层通信</p>
</li>
<li>
<p><strong>核心机制</strong>：</p>
</li>
<li><strong>ARP 表</strong>：下一跳 IP → MAC 地址</li>
<li><strong>FDB 表</strong>：MAC 地址 → 目标节点 IP</li>
<li>
<p><strong>内核封装</strong>：UDP 8472 端口</p>
</li>
<li>
<p><strong>与 UDP 模式对比</strong>：</p>
</li>
<li>VxLAN 在内核空间封装，效率更高</li>
<li>无上下文切换，无多次数据拷贝</li>
<li>
<p>端口 8472（vs UDP 的 8285）</p>
</li>
<li>
<p><strong>DirectRouting 模式</strong>：</p>
</li>
<li>同二层节点：直接路由，不封装</li>
<li>跨二层节点：VxLAN 封装</li>
<li>
<p>等同于 Calico CrossSubnet</p>
</li>
<li>
<p><strong>生产建议</strong>：</p>
</li>
<li>VxLAN 是 Flannel 生产推荐模式</li>
<li>如需网络策略，可结合 Calico 使用</li>
</ol>
</blockquote>
<hr />
<h2 id="flannel-ipip">第四十八章 Flannel-IPIP 模式<a class="headerlink" href="#flannel-ipip" title="Permanent link">&para;</a></h2>
<p>本章深入讲解 Flannel 的 IPIP 封装模式，包括配置方法、裸 IP 设备特性、NOARP 标志原理，以及 DirectRouting 优化模式。</p>
<h3 id="481">48.1 背景与概述<a class="headerlink" href="#481" title="Permanent link">&para;</a></h3>
<h4 id="4811-ipip">48.1.1 IPIP 模式定位<a class="headerlink" href="#4811-ipip" title="Permanent link">&para;</a></h4>
<p>IPIP（IP-in-IP）是一种轻量级的隧道封装方式：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;封装方式对比&quot;
        VxLAN[&quot;VxLAN&lt;br/&gt;UDP + VxLAN Header&lt;br/&gt;50 bytes 开销&quot;]
        IPIP[&quot;IPIP&lt;br/&gt;IP Header&lt;br/&gt;20 bytes 开销&quot;]
        HostGW[&quot;host-gw&lt;br/&gt;无封装&lt;br/&gt;0 bytes 开销&quot;]
    end

    VxLAN --&gt;|&quot;跨子网&quot;| Use[&quot;适用场景&quot;]
    IPIP --&gt;|&quot;跨子网&quot;| Use
    HostGW --&gt;|&quot;同子网&quot;| Use
</code></pre></div>
<h4 id="4812-calico-ipip">48.1.2 与 Calico IPIP 的关系<a class="headerlink" href="#4812-calico-ipip" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Flannel IPIP</th>
<th style="text-align: left;">Calico IPIP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">封装机制</td>
<td style="text-align: left;">IP-in-IP</td>
<td style="text-align: left;">IP-in-IP</td>
</tr>
<tr>
<td style="text-align: left;">默认模式</td>
<td style="text-align: left;">需手动配置</td>
<td style="text-align: left;">默认开启</td>
</tr>
<tr>
<td style="text-align: left;">BGP 路由</td>
<td style="text-align: left;">不支持</td>
<td style="text-align: left;">支持</td>
</tr>
<tr>
<td style="text-align: left;">网络策略</td>
<td style="text-align: left;">不支持</td>
<td style="text-align: left;">支持</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>Flannel vs Calico IPIP</strong></p>
<ul>
<li>Calico IPIP 模式结合了 BGP 路由宣告</li>
<li>Flannel IPIP 仅做封装，路由由 flanneld 静态维护</li>
</ul>
</blockquote>
<h3 id="482-ipip">48.2 IPIP 配置<a class="headerlink" href="#482-ipip" title="Permanent link">&para;</a></h3>
<h4 id="4821-configmap">48.2.1 ConfigMap 配置<a class="headerlink" href="#4821-configmap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-cfg</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">net-conf.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<span class="w">      </span><span class="no">&quot;Backend&quot;: {</span>
<span class="w">        </span><span class="no">&quot;Type&quot;: &quot;ipip&quot;</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<h4 id="4822-ipip">48.2.2 验证 IPIP 设备<a class="headerlink" href="#4822-ipip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 flannel.ipip 设备</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>flannel.ipip

<span class="c1"># 输出示例</span>
<span class="c1"># flannel.ipip: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt;</span>
<span class="c1">#     link/ipip 172.18.0.3 brd 0.0.0.0</span>
<span class="c1">#     ipip remote any local 172.18.0.3 ...</span>

<span class="c1"># 查看路由表</span>
ip<span class="w"> </span>route<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>flannel.ipip
<span class="c1"># 10.244.1.0/24 via 172.18.0.4 dev flannel.ipip</span>
</code></pre></div>
<h3 id="483-ipip">48.3 IPIP 通信原理<a class="headerlink" href="#483-ipip" title="Permanent link">&para;</a></h3>
<h4 id="4831">48.3.1 通信架构<a class="headerlink" href="#4831" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;10.244.0.5
    participant CNI as cni0
    participant IPIP as flannel.ipip
    participant Kernel as 内核 IPIP
    participant ETH as eth0
    participant Net as 物理网络
    participant ETH2 as eth0
    participant Kernel2 as 内核 IPIP
    participant IPIP2 as flannel.ipip
    participant CNI2 as cni0
    participant PodB as Pod B&lt;br/&gt;10.244.1.2

    PodA-&gt;&gt;CNI: 1. 发送 IP 包
    CNI-&gt;&gt;IPIP: 2. 路由转发
    IPIP-&gt;&gt;Kernel: 3. IPIP 封装
    Kernel-&gt;&gt;ETH: 4. 外层 IP
    ETH-&gt;&gt;Net: 5. 物理传输
    Net-&gt;&gt;ETH2: 6. 到达目标
    ETH2-&gt;&gt;Kernel2: 7. 接收
    Kernel2-&gt;&gt;IPIP2: 8. IPIP 解封装
    IPIP2-&gt;&gt;CNI2: 9. 路由转发
    CNI2-&gt;&gt;PodB: 10. 交付 Pod
</code></pre></div>
<h4 id="4832">48.3.2 路由表分析<a class="headerlink" href="#4832" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 宿主机路由表</span>
ip<span class="w"> </span>route

<span class="c1"># 输出示例</span>
<span class="m">10</span>.244.0.0/24<span class="w"> </span>dev<span class="w"> </span>cni0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w">      </span><span class="c1"># 本地网段</span>
<span class="m">10</span>.244.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.4<span class="w"> </span>dev<span class="w"> </span>flannel.ipip<span class="w">       </span><span class="c1"># 远端走 IPIP</span>
</code></pre></div>
<p><strong>路由决策过程</strong>：</p>
<ol>
<li>Pod 发送数据包到 <code>10.244.1.2</code></li>
<li>匹配路由 <code>10.244.1.0/24 via 172.18.0.4 dev flannel.ipip</code></li>
<li>下一跳 <code>172.18.0.4</code>（目标节点），出接口 <code>flannel.ipip</code></li>
</ol>
<h3 id="484-ip">48.4 裸 IP 设备特性<a class="headerlink" href="#484-ip" title="Permanent link">&para;</a></h3>
<h4 id="4841-raw">48.4.1 Raw 设备说明<a class="headerlink" href="#4841-raw" title="Permanent link">&para;</a></h4>
<p>flannel.ipip 是一个 <strong>裸 IP（Raw IP）</strong> 设备：</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;普通以太网设备&quot;
        E1[&quot;MAC Header&quot;]
        E2[&quot;IP Header&quot;]
        E3[&quot;Payload&quot;]
    end

    subgraph &quot;Raw IP 设备&quot;
        R1[&quot;IP Header&quot;]
        R2[&quot;Payload&quot;]
    end

    E1 --&gt; E2 --&gt; E3
    R1 --&gt; R2
</code></pre></div>
<p><strong>特点</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">普通网卡 (eth0)</th>
<th style="text-align: left;">Raw 设备 (flannel.ipip)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">MAC 层</td>
<td style="text-align: left;">有</td>
<td style="text-align: left;">无</td>
</tr>
<tr>
<td style="text-align: left;">抓包显示</td>
<td style="text-align: left;">有 MAC 地址</td>
<td style="text-align: left;">无 MAC 地址</td>
</tr>
<tr>
<td style="text-align: left;">tcpdump 类型</td>
<td style="text-align: left;">LINUX_SLL</td>
<td style="text-align: left;">Raw</td>
</tr>
</tbody>
</table>
<h4 id="4842">48.4.2 抓包验证<a class="headerlink" href="#4842" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 flannel.ipip 上抓包 - 无 MAC 层</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>flannel.ipip<span class="w"> </span>-nn

<span class="c1"># 输出示例 - 只有 IP 信息，无 MAC</span>
<span class="c1"># IP 10.244.0.5 &gt; 10.244.1.2: ICMP echo request</span>

<span class="c1"># 在 eth0 上抓包 - 有完整 MAC 层</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>ip<span class="w"> </span>proto<span class="w"> </span><span class="m">4</span>

<span class="c1"># 输出示例 - IPIP 封装</span>
<span class="c1"># IP 172.18.0.3 &gt; 172.18.0.4: IP 10.244.0.5 &gt; 10.244.1.2 ...</span>
</code></pre></div>
<h3 id="485-noarp">48.5 NOARP 标志详解<a class="headerlink" href="#485-noarp" title="Permanent link">&para;</a></h3>
<h4 id="4851">48.5.1 标志含义<a class="headerlink" href="#4851" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看设备标志</span>
ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>flannel.ipip

<span class="c1"># 输出示例</span>
<span class="c1"># flannel.ipip: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt;</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">标志</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">POINTOPOINT</td>
<td style="text-align: left;">点对点设备</td>
</tr>
<tr>
<td style="text-align: left;"><strong>NOARP</strong></td>
<td style="text-align: left;">禁用 ARP 协议</td>
</tr>
<tr>
<td style="text-align: left;">UP</td>
<td style="text-align: left;">设备启用</td>
</tr>
<tr>
<td style="text-align: left;">LOWER_UP</td>
<td style="text-align: left;">底层链路可用</td>
</tr>
</tbody>
</table>
<h4 id="4852-arp">48.5.2 为什么禁用 ARP<a class="headerlink" href="#4852-arp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;ARP 功能&quot;
        ARP[&quot;ARP 协议&lt;br/&gt;解析 IP → MAC&quot;]
        GARP[&quot;GARP 消息&lt;br/&gt;地址冲突检测&quot;]
    end

    subgraph &quot;NOARP 原因&quot;
        R1[&quot;裸 IP 设备无 MAC 层&quot;]
        R2[&quot;避免地址冲突告警&quot;]
        R3[&quot;隧道封装不需要 MAC&quot;]
    end

    ARP --&gt; R1
    GARP --&gt; R2
</code></pre></div>
<p><strong>禁用 ARP 的场景</strong>：</p>
<ol>
<li><strong>裸 IP 设备</strong>：flannel.ipip 没有 MAC 层，ARP 无意义</li>
<li><strong>避免 GARP 冲突</strong>：多节点配置相同隧道网段时，避免 GARP 告警</li>
<li><strong>隧道封装</strong>：IPIP/GRE 隧道直接使用 IP 封装，不需要 MAC 解析</li>
</ol>
<blockquote>
<p>[!TIP]
<strong>NOARP 实际应用</strong></p>
<p>在 FE/BE（前端/后端）负载均衡架构中，BE 节点可能需要配置与 VIP 相同的地址用于响应。
此时需要设置 NOARP 避免 GARP 冲突告警。</p>
</blockquote>
<h3 id="486">48.6 封装结构对比<a class="headerlink" href="#486" title="Permanent link">&para;</a></h3>
<h4 id="4861-ipip-vs-vxlan">48.6.1 IPIP vs VxLAN<a class="headerlink" href="#4861-ipip-vs-vxlan" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;IPIP 封装&quot;
        I1[&quot;外层 IP&lt;br/&gt;20 bytes&quot;]
        I2[&quot;内层 IP&lt;br/&gt;Pod 地址&quot;]
        I3[&quot;Payload&quot;]
    end

    subgraph &quot;VxLAN 封装&quot;
        V1[&quot;外层 MAC&lt;br/&gt;14 bytes&quot;]
        V2[&quot;外层 IP&lt;br/&gt;20 bytes&quot;]
        V3[&quot;UDP&lt;br/&gt;8 bytes&quot;]
        V4[&quot;VxLAN&lt;br/&gt;8 bytes&quot;]
        V5[&quot;内层 MAC&lt;br/&gt;14 bytes&quot;]
        V6[&quot;内层 IP&quot;]
        V7[&quot;Payload&quot;]
    end

    I1 --&gt; I2 --&gt; I3
    V1 --&gt; V2 --&gt; V3 --&gt; V4 --&gt; V5 --&gt; V6 --&gt; V7
</code></pre></div>
<h4 id="4862">48.6.2 开销对比<a class="headerlink" href="#4862" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">封装方式</th>
<th style="text-align: left;">额外开销</th>
<th style="text-align: left;">MTU (1500基础)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">IPIP</td>
<td style="text-align: left;">20 bytes</td>
<td style="text-align: left;">1480</td>
</tr>
<tr>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;">50 bytes</td>
<td style="text-align: left;">1450</td>
</tr>
<tr>
<td style="text-align: left;">host-gw</td>
<td style="text-align: left;">0 bytes</td>
<td style="text-align: left;">1500</td>
</tr>
</tbody>
</table>
<h3 id="487-directrouting">48.7 DirectRouting 模式<a class="headerlink" href="#487-directrouting" title="Permanent link">&para;</a></h3>
<h4 id="4871">48.7.1 配置方法<a class="headerlink" href="#4871" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-cfg</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">net-conf.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<span class="w">      </span><span class="no">&quot;Backend&quot;: {</span>
<span class="w">        </span><span class="no">&quot;Type&quot;: &quot;ipip&quot;,</span>
<span class="w">        </span><span class="no">&quot;DirectRouting&quot;: true</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<h4 id="4872">48.7.2 工作原理<a class="headerlink" href="#4872" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;节点 A (10.1.5.10)&quot;
        PodA[&quot;Pod A&quot;]
    end

    subgraph &quot;节点 B (10.1.5.11) - 同二层&quot;
        PodB[&quot;Pod B&quot;]
    end

    subgraph &quot;节点 C (10.1.8.10) - 跨二层&quot;
        PodC[&quot;Pod C&quot;]
    end

    PodA --&gt;|&quot;直接路由&lt;br/&gt;无封装&quot;| PodB
    PodA --&gt;|&quot;IPIP 封装&quot;| PodC
</code></pre></div>
<h4 id="4873">48.7.3 路由表变化<a class="headerlink" href="#4873" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 启用 DirectRouting 后的路由表</span>
ip<span class="w"> </span>route

<span class="c1"># 同二层节点 - 直接路由</span>
<span class="m">10</span>.244.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.5.11<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w">    </span><span class="c1"># 下一跳是节点 IP，走 eth0</span>

<span class="c1"># 跨二层节点 - IPIP 封装</span>
<span class="m">10</span>.244.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.1.8.10<span class="w"> </span>dev<span class="w"> </span>flannel.ipip<span class="w">  </span><span class="c1"># 走 flannel.ipip</span>
</code></pre></div>
<h4 id="4874">48.7.4 抓包验证<a class="headerlink" href="#4874" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 同二层通信 - 抓 eth0，port 80</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>port<span class="w"> </span><span class="m">80</span><span class="w"> </span>-nn<span class="w"> </span>-w<span class="w"> </span>direct.pcap
<span class="c1"># 结果: 普通 TCP 包，无 IPIP 封装</span>

<span class="c1"># 跨二层通信 - 抓 IPIP 协议</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>ip<span class="w"> </span>proto<span class="w"> </span><span class="m">4</span><span class="w"> </span>-w<span class="w"> </span>ipip.pcap
<span class="c1"># 结果: IPIP 封装包</span>
</code></pre></div>
<h3 id="488">48.8 抓包分析技巧<a class="headerlink" href="#488" title="Permanent link">&para;</a></h3>
<h4 id="4881-ipip">48.8.1 IPIP 协议过滤<a class="headerlink" href="#4881-ipip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># IPIP 协议号为 4</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>ip<span class="w"> </span>proto<span class="w"> </span><span class="m">4</span>

<span class="c1"># 或使用协议名</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>ipip
</code></pre></div>
<h4 id="4882-http">48.8.2 查看 HTTP 内容<a class="headerlink" href="#4882-http" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用 -X 或 -A 查看内容</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>-A<span class="w"> </span>port<span class="w"> </span><span class="m">80</span>

<span class="c1"># 输出示例</span>
<span class="c1"># GET / HTTP/1.1</span>
<span class="c1"># Host: 10.244.1.2</span>
<span class="c1"># ...</span>
<span class="c1"># HTTP/1.1 200 OK</span>
<span class="c1"># flannel-pod-name: xxx</span>
</code></pre></div>
<h3 id="489">48.9 章节小结<a class="headerlink" href="#489" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Flannel IPIP 模式))
    配置
      Backend Type ipip
      DirectRouting true
    设备
      flannel.ipip
      Raw IP 裸设备
      NOARP 标志
    封装
      20 bytes 开销
      MTU 1480
      轻量高效
    DirectRouting
      同二层走路由
      跨二层走IPIP
    与VxLAN对比
      开销更小
      无MAC层
      内核封装
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Flannel IPIP 模式要点总结</strong>：</p>
<ol>
<li><strong>配置方式</strong>：</li>
<li><code>Backend.Type: "ipip"</code></li>
<li>
<p>可选 <code>DirectRouting: true</code> 优化同二层通信</p>
</li>
<li>
<p><strong>设备特性</strong>：</p>
</li>
<li><code>flannel.ipip</code> 是 Raw IP 裸设备</li>
<li>无 MAC 层，抓包只有 IP 信息</li>
<li>
<p>NOARP 标志禁用 ARP 协议</p>
</li>
<li>
<p><strong>封装开销</strong>：</p>
</li>
<li>仅 20 bytes（外层 IP Header）</li>
<li>比 VxLAN 少 30 bytes</li>
<li>
<p>MTU = 1500 - 20 = 1480</p>
</li>
<li>
<p><strong>DirectRouting 模式</strong>：</p>
</li>
<li>同二层节点：直接路由，走 eth0</li>
<li>跨二层节点：IPIP 封装，走 flannel.ipip</li>
<li>
<p>等同于 Calico CrossSubnet</p>
</li>
<li>
<p><strong>抓包技巧</strong>：</p>
</li>
<li>IPIP 协议：<code>tcpdump ip proto 4</code></li>
<li>flannel.ipip 上只能看到裸 IP，无 MAC</li>
</ol>
</blockquote>
<hr />
<h2 id="flannel-hostgw">第四十九章 Flannel-HostGW 模式<a class="headerlink" href="#flannel-hostgw" title="Permanent link">&para;</a></h2>
<p>本章深入讲解 Flannel 的 Host-Gateway 模式，包括配置方法、纯路由通信原理、MAC 地址变化规律，以及为什么只能在同二层网络中使用。</p>
<h3 id="491">49.1 背景与概述<a class="headerlink" href="#491" title="Permanent link">&para;</a></h3>
<h4 id="4911-hostgw">49.1.1 HostGW 模式定位<a class="headerlink" href="#4911-hostgw" title="Permanent link">&para;</a></h4>
<p>Host-Gateway 是 Flannel 中<strong>性能最高</strong>的后端类型：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Flannel 后端性能对比&quot;
        UDP[&quot;UDP 模式&lt;br/&gt;❌ 性能最低&quot;]
        VxLAN[&quot;VxLAN 模式&lt;br/&gt;⭐ 中等&quot;]
        IPIP[&quot;IPIP 模式&lt;br/&gt;⭐⭐ 较高&quot;]
        HostGW[&quot;host-gw 模式&lt;br/&gt;⭐⭐⭐ 最高&quot;]
    end

    UDP --&gt;|&quot;封装开销大&quot;| Low[&quot;低效&quot;]
    VxLAN --&gt;|&quot;50 bytes 开销&quot;| Mid[&quot;中等&quot;]
    IPIP --&gt;|&quot;20 bytes 开销&quot;| High[&quot;较高&quot;]
    HostGW --&gt;|&quot;无封装&quot;| Best[&quot;最优&quot;]
</code></pre></div>
<h4 id="4912">49.1.2 核心特点<a class="headerlink" href="#4912" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">封装方式</td>
<td style="text-align: left;"><strong>无封装</strong></td>
</tr>
<tr>
<td style="text-align: left;">MTU</td>
<td style="text-align: left;"><strong>1500</strong>（无损耗）</td>
</tr>
<tr>
<td style="text-align: left;">通信方式</td>
<td style="text-align: left;">纯三层路由</td>
</tr>
<tr>
<td style="text-align: left;">适用场景</td>
<td style="text-align: left;"><strong>同二层网络</strong></td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;"><strong>最高</strong></td>
</tr>
</tbody>
</table>
<h3 id="492-hostgw">49.2 HostGW 配置<a class="headerlink" href="#492-hostgw" title="Permanent link">&para;</a></h3>
<h4 id="4921-configmap">49.2.1 ConfigMap 配置<a class="headerlink" href="#4921-configmap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-cfg</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">net-conf.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<span class="w">      </span><span class="no">&quot;Backend&quot;: {</span>
<span class="w">        </span><span class="no">&quot;Type&quot;: &quot;host-gw&quot;</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<h4 id="4922">49.2.2 路由表验证<a class="headerlink" href="#4922" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看宿主机路由表</span>
ip<span class="w"> </span>route

<span class="c1"># 输出示例</span>
<span class="m">10</span>.244.0.0/24<span class="w"> </span>dev<span class="w"> </span>cni0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w">           </span><span class="c1"># 本地网段</span>
<span class="m">10</span>.244.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.4<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w">                    </span><span class="c1"># 远端走物理网卡</span>
<span class="m">10</span>.244.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.5<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w">                    </span><span class="c1"># 远端走物理网卡</span>
</code></pre></div>
<p><strong>关键观察</strong>：</p>
<ul>
<li>远端网段的出接口是 <code>eth0</code>（物理网卡）</li>
<li>下一跳是<strong>目标节点的物理 IP</strong></li>
<li>没有 <code>flannel.1</code>、<code>flannel.ipip</code> 等隧道设备</li>
</ul>
<h3 id="493-hostgw">49.3 HostGW 通信原理<a class="headerlink" href="#493-hostgw" title="Permanent link">&para;</a></h3>
<h4 id="4931">49.3.1 通信架构<a class="headerlink" href="#4931" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;10.244.0.5
    participant CNI as cni0
    participant Host1 as 宿主机 1&lt;br/&gt;172.18.0.3
    participant Net as 物理网络&lt;br/&gt;二层交换
    participant Host2 as 宿主机 2&lt;br/&gt;172.18.0.4
    participant CNI2 as cni0
    participant PodB as Pod B&lt;br/&gt;10.244.1.2

    PodA-&gt;&gt;CNI: 1. 发送 IP 包
    CNI-&gt;&gt;Host1: 2. 查路由表
    Host1-&gt;&gt;Net: 3. 直接转发&lt;br/&gt;无封装
    Net-&gt;&gt;Host2: 4. 二层交换
    Host2-&gt;&gt;CNI2: 5. 查路由表
    CNI2-&gt;&gt;PodB: 6. 交付 Pod
</code></pre></div>
<h4 id="4932">49.3.2 路由核心原则<a class="headerlink" href="#4932" title="Permanent link">&para;</a></h4>
<blockquote>
<p>[!IMPORTANT]
<strong>纯路由转发的黄金法则</strong></p>
<p>在没有 NAT 和 Overlay 封装的路由网络中：</p>
<ul>
<li><strong>IP 地址不变</strong>：源 IP 和目标 IP 全程不变</li>
<li><strong>MAC 地址变化</strong>：每经过一跳，MAC 地址都会改变</li>
</ul>
</blockquote>
<h4 id="4933">49.3.3 数据包变化过程<a class="headerlink" href="#4933" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;第一跳：Pod → 宿主机&quot;
        P1[&quot;Src IP: 10.244.0.5&quot;]
        P2[&quot;Dst IP: 10.244.1.2&quot;]
        P3[&quot;Src MAC: Pod eth0&quot;]
        P4[&quot;Dst MAC: cni0 网关&quot;]
    end

    subgraph &quot;第二跳：宿主机 → 目标宿主机&quot;
        Q1[&quot;Src IP: 10.244.0.5&quot;]
        Q2[&quot;Dst IP: 10.244.1.2&quot;]
        Q3[&quot;Src MAC: eth0&quot;]
        Q4[&quot;Dst MAC: 目标节点 eth0&quot;]
    end

    P1 --&gt; Q1
    P2 --&gt; Q2
</code></pre></div>
<p><strong>变化规律</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">变化情况</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">源 IP</td>
<td style="text-align: left;">❌ 不变</td>
</tr>
<tr>
<td style="text-align: left;">目标 IP</td>
<td style="text-align: left;">❌ 不变</td>
</tr>
<tr>
<td style="text-align: left;">源 MAC</td>
<td style="text-align: left;">✅ 变为出接口 MAC</td>
</tr>
<tr>
<td style="text-align: left;">目标 MAC</td>
<td style="text-align: left;">✅ 变为下一跳 MAC</td>
</tr>
</tbody>
</table>
<h3 id="494">49.4 为什么只能在同二层使用<a class="headerlink" href="#494" title="Permanent link">&para;</a></h3>
<h4 id="4941">49.4.1 同二层场景<a class="headerlink" href="#4941" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;同二层网络 - ✅ 可用 host-gw&quot;
        N1[&quot;Node1&lt;br/&gt;172.18.0.3&quot;]
        N2[&quot;Node2&lt;br/&gt;172.18.0.4&quot;]
        SW[&quot;二层交换机&quot;]
    end

    N1 &lt;--&gt;|&quot;直接可达&quot;| SW
    SW &lt;--&gt;|&quot;直接可达&quot;| N2
</code></pre></div>
<p><strong>同二层时</strong>：</p>
<ul>
<li>节点之间可以直接通过 MAC 地址转发</li>
<li>只需要配置静态路由，无需封装</li>
<li>每个节点都知道如何到达其他节点</li>
</ul>
<h4 id="4942">49.4.2 跨二层场景<a class="headerlink" href="#4942" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;域 A&quot;
        N1[&quot;Node1&lt;br/&gt;172.18.0.3&quot;]
    end

    subgraph &quot;路由器&quot;
        R1[&quot;Router A&quot;]
        R2[&quot;Router B&quot;]
    end

    subgraph &quot;域 B&quot;
        N2[&quot;Node2&lt;br/&gt;10.1.8.10&quot;]
    end

    N1 --&gt; R1
    R1 --&gt; R2
    R2 --&gt; N2
</code></pre></div>
<p><strong>跨二层时的问题</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">路由器不知道 Pod 网段</td>
<td style="text-align: left;">中间路由器没有 <code>10.244.x.0/24</code> 的路由</td>
</tr>
<tr>
<td style="text-align: left;">无法转发</td>
<td style="text-align: left;">数据包到达路由器后会被丢弃或走默认路由</td>
</tr>
<tr>
<td style="text-align: left;">需要动态路由协议</td>
<td style="text-align: left;">必须使用 BGP 等协议宣告 Pod 网段</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!CAUTION]
<strong>host-gw 限制</strong></p>
<p>如果节点不在同一二层网络，host-gw 模式<strong>不能工作</strong>！</p>
<p>跨二层场景请使用：</p>
<ul>
<li>VxLAN 模式（推荐）</li>
<li>IPIP 模式</li>
<li>VxLAN/IPIP + DirectRouting 混合模式</li>
</ul>
</blockquote>
<h3 id="495">49.5 抓包分析<a class="headerlink" href="#495" title="Permanent link">&para;</a></h3>
<h4 id="4951">49.5.1 抓包验证<a class="headerlink" href="#4951" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 eth0 上抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>port<span class="w"> </span><span class="m">80</span>

<span class="c1"># 输出示例 - 无封装，直接是原始 IP 包</span>
<span class="c1"># 10.244.0.5.xxxxx &gt; 10.244.1.2.80: Flags [S], ...</span>
<span class="c1"># 10.244.1.2.80 &gt; 10.244.0.5.xxxxx: Flags [S.], ...</span>
</code></pre></div>
<h4 id="4952">49.5.2 包结构对比<a class="headerlink" href="#4952" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;host-gw 模式&quot;
        H1[&quot;MAC Header&quot;]
        H2[&quot;IP Header&lt;br/&gt;Pod IP&quot;]
        H3[&quot;TCP/Payload&quot;]
    end

    subgraph &quot;VxLAN 模式&quot;
        V1[&quot;外层 MAC&quot;]
        V2[&quot;外层 IP&quot;]
        V3[&quot;UDP + VxLAN&quot;]
        V4[&quot;内层 MAC&quot;]
        V5[&quot;内层 IP&quot;]
        V6[&quot;TCP/Payload&quot;]
    end

    H1 --&gt; H2 --&gt; H3
    V1 --&gt; V2 --&gt; V3 --&gt; V4 --&gt; V5 --&gt; V6
</code></pre></div>
<h3 id="496">49.6 性能对比<a class="headerlink" href="#496" title="Permanent link">&para;</a></h3>
<h4 id="4961">49.6.1 各模式对比<a class="headerlink" href="#4961" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">封装开销</th>
<th style="text-align: left;">MTU</th>
<th style="text-align: left;">性能</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">host-gw</td>
<td style="text-align: left;">0 bytes</td>
<td style="text-align: left;">1500</td>
<td style="text-align: left;">⭐⭐⭐</td>
<td style="text-align: left;">同二层</td>
</tr>
<tr>
<td style="text-align: left;">IPIP</td>
<td style="text-align: left;">20 bytes</td>
<td style="text-align: left;">1480</td>
<td style="text-align: left;">⭐⭐</td>
<td style="text-align: left;">跨二层</td>
</tr>
<tr>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;">50 bytes</td>
<td style="text-align: left;">1450</td>
<td style="text-align: left;">⭐</td>
<td style="text-align: left;">跨二层</td>
</tr>
<tr>
<td style="text-align: left;">UDP</td>
<td style="text-align: left;">28 bytes</td>
<td style="text-align: left;">1472</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">不推荐</td>
</tr>
</tbody>
</table>
<h4 id="4962">49.6.2 性能优势原因<a class="headerlink" href="#4962" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;host-gw 优势&quot;
        A[&quot;无封装&quot;] --&gt; B[&quot;无额外 Header&quot;]
        B --&gt; C[&quot;MTU 无损耗&quot;]
        C --&gt; D[&quot;CPU 开销最小&quot;]
        D --&gt; E[&quot;延迟最低&quot;]
    end
</code></pre></div>
<h3 id="497-calico">49.7 与 Calico 对比<a class="headerlink" href="#497-calico" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Flannel host-gw</th>
<th style="text-align: left;">Calico (无封装)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">路由方式</td>
<td style="text-align: left;">静态路由</td>
<td style="text-align: left;">BGP 动态路由</td>
</tr>
<tr>
<td style="text-align: left;">跨子网支持</td>
<td style="text-align: left;">❌ 不支持</td>
<td style="text-align: left;">✅ 支持</td>
</tr>
<tr>
<td style="text-align: left;">网络策略</td>
<td style="text-align: left;">❌ 不支持</td>
<td style="text-align: left;">✅ 支持</td>
</tr>
<tr>
<td style="text-align: left;">复杂度</td>
<td style="text-align: left;">简单</td>
<td style="text-align: left;">较复杂</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>选择建议</strong></p>
<ul>
<li>如果节点在同二层且不需要网络策略：<strong>Flannel host-gw</strong></li>
<li>如果需要跨子网或网络策略：<strong>Calico</strong></li>
</ul>
</blockquote>
<h3 id="498">49.8 章节小结<a class="headerlink" href="#498" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Flannel host-gw 模式))
    配置
      Backend Type host-gw
      无封装
    原理
      纯路由转发
      IP 不变 MAC 变
      下一跳是节点 IP
    限制
      只能同二层
      跨二层需封装
    优势
      MTU 1500
      零封装开销
      性能最高
    对比
      VxLAN 跨子网
      IPIP 轻量封装
      Calico BGP
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Flannel host-gw 模式要点总结</strong>：</p>
<ol>
<li><strong>配置方式</strong>：</li>
<li><code>Backend.Type: "host-gw"</code></li>
<li>
<p>路由表直接指向目标节点 IP</p>
</li>
<li>
<p><strong>核心原理</strong>：</p>
</li>
<li><strong>无封装</strong>：直接三层路由转发</li>
<li><strong>IP 不变 MAC 变</strong>：每跳 MAC 地址更新</li>
<li>
<p>出接口是物理网卡 <code>eth0</code></p>
</li>
<li>
<p><strong>使用限制</strong>：</p>
</li>
<li><strong>只能在同二层网络使用</strong></li>
<li>跨二层需要封装（VxLAN/IPIP）</li>
<li>
<p>或使用 BGP 宣告路由（Calico）</p>
</li>
<li>
<p><strong>性能优势</strong>：</p>
</li>
<li>MTU 1500，无损耗</li>
<li>零封装开销</li>
<li>
<p>CPU 开销最小</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
</li>
<li>所有节点在同一二层网络</li>
<li>追求最高网络性能</li>
<li>不需要跨子网通信</li>
</ol>
</blockquote>
<hr />
<h2 id="flannel-ipsec">第五十章 Flannel-IPsec 模式<a class="headerlink" href="#flannel-ipsec" title="Permanent link">&para;</a></h2>
<p>本章深入讲解 Flannel 的 IPsec 模式，包括预共享密钥（PSK）配置、ESP 封装原理、xfrm 状态与策略、Wireshark 解密技巧，以及与其他模式的对比。</p>
<h3 id="501">50.1 背景与概述<a class="headerlink" href="#501" title="Permanent link">&para;</a></h3>
<h4 id="5011-ipsec">50.1.1 IPsec 模式定位<a class="headerlink" href="#5011-ipsec" title="Permanent link">&para;</a></h4>
<p>IPsec（IP Security）是 Flannel 中提供<strong>加密传输</strong>的后端类型：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Flannel 后端功能对比&quot;
        UDP[&quot;UDP 模式&lt;br/&gt;🔓 不加密&quot;]
        VxLAN[&quot;VxLAN 模式&lt;br/&gt;🔓 不加密&quot;]
        IPIP[&quot;IPIP 模式&lt;br/&gt;🔓 不加密&quot;]
        HostGW[&quot;host-gw 模式&lt;br/&gt;🔓 不加密&quot;]
        IPsec[&quot;IPsec 模式&lt;br/&gt;🔐 加密&quot;]
        WireGuard[&quot;WireGuard 模式&lt;br/&gt;🔐 加密&quot;]
    end

    IPsec --&gt;|&quot;ESP 封装+加密&quot;| Secure[&quot;安全传输&quot;]
    WireGuard --&gt;|&quot;现代加密&quot;| Secure
</code></pre></div>
<h4 id="5012">50.1.2 核心特点<a class="headerlink" href="#5012" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">加密协议</td>
<td style="text-align: left;">ESP（Encapsulating Security Payload）</td>
</tr>
<tr>
<td style="text-align: left;">密钥类型</td>
<td style="text-align: left;">PSK（Pre-Shared Key）</td>
</tr>
<tr>
<td style="text-align: left;">封装模式</td>
<td style="text-align: left;"><strong>Tunnel Mode</strong></td>
</tr>
<tr>
<td style="text-align: left;">适用场景</td>
<td style="text-align: left;">跨不可信网络的安全通信</td>
</tr>
<tr>
<td style="text-align: left;">性能开销</td>
<td style="text-align: left;">加解密消耗 CPU</td>
</tr>
</tbody>
</table>
<h3 id="502-ipsec">50.2 IPsec 配置<a class="headerlink" href="#502-ipsec" title="Permanent link">&para;</a></h3>
<h4 id="5021-psk">50.2.1 生成 PSK<a class="headerlink" href="#5021-psk" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 生成 96 位（12 字节）预共享密钥</span>
dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/urandom<span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">12</span><span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>base64
<span class="c1"># 输出示例：iVzSdJHgXWNqpuJE</span>
</code></pre></div>
<h4 id="5022-configmap">50.2.2 ConfigMap 配置<a class="headerlink" href="#5022-configmap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-cfg</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">net-conf.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<span class="w">      </span><span class="no">&quot;Backend&quot;: {</span>
<span class="w">        </span><span class="no">&quot;Type&quot;: &quot;ipsec&quot;,</span>
<span class="w">        </span><span class="no">&quot;PSK&quot;: &quot;iVzSdJHgXWNqpuJE&quot;</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>PSK 配置要点</strong></p>
<ul>
<li>PSK 是<strong>必选参数</strong>，至少 96 位（12 字节 Base64）</li>
<li>所有节点必须使用相同的 PSK</li>
<li>生产环境建议使用更长的密钥</li>
</ul>
</blockquote>
<h3 id="503-ipsec">50.3 IPsec 工作原理<a class="headerlink" href="#503-ipsec" title="Permanent link">&para;</a></h3>
<h4 id="5031-ipsec-tunnel">50.3.1 IPsec Tunnel 模式架构<a class="headerlink" href="#5031-ipsec-tunnel" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;10.244.0.5
    participant Kernel1 as Node1 内核&lt;br/&gt;ESP 封装
    participant Network as 物理网络&lt;br/&gt;加密传输
    participant Kernel2 as Node2 内核&lt;br/&gt;ESP 解封
    participant PodB as Pod B&lt;br/&gt;10.244.1.2

    PodA-&gt;&gt;Kernel1: 1. 原始 IP 包
    Kernel1-&gt;&gt;Kernel1: 2. xfrm policy 匹配
    Kernel1-&gt;&gt;Kernel1: 3. ESP 加密+封装
    Kernel1-&gt;&gt;Network: 4. 加密数据包
    Network-&gt;&gt;Kernel2: 5. 传输
    Kernel2-&gt;&gt;Kernel2: 6. ESP 解密+解封
    Kernel2-&gt;&gt;PodB: 7. 原始 IP 包
</code></pre></div>
<h4 id="5032-esp">50.3.2 ESP 包结构<a class="headerlink" href="#5032-esp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;IPsec ESP Tunnel 模式&quot;
        A[&quot;外层 MAC&lt;br/&gt;节点 MAC&quot;]
        B[&quot;外层 IP&lt;br/&gt;节点 IP&quot;]
        C[&quot;ESP Header&lt;br/&gt;SPI + 序列号&quot;]
        D[&quot;加密载荷&lt;br/&gt;内层 IP + 数据&quot;]
        E[&quot;ESP Trailer&lt;br/&gt;填充 + 认证&quot;]
    end

    A --&gt; B --&gt; C --&gt; D --&gt; E
</code></pre></div>
<p><strong>关键特点</strong>：</p>
<ul>
<li><strong>内层无 MAC</strong>：IPsec 是三层协议，封装时不包含内层 MAC</li>
<li><strong>整体加密</strong>：内层 IP 包被完全加密</li>
<li><strong>完整性校验</strong>：ESP 提供认证功能</li>
</ul>
<h3 id="504-xfrm">50.4 xfrm 状态与策略<a class="headerlink" href="#504-xfrm" title="Permanent link">&para;</a></h3>
<h4 id="5041-xfrm">50.4.1 查看 xfrm 状态<a class="headerlink" href="#5041-xfrm" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 IPsec SA（Security Association）</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>state

<span class="c1"># 输出示例</span>
src<span class="w"> </span><span class="m">172</span>.18.0.3<span class="w"> </span>dst<span class="w"> </span><span class="m">172</span>.18.0.4
<span class="w">    </span>proto<span class="w"> </span>esp<span class="w"> </span>spi<span class="w"> </span>0x0000a1b2<span class="w"> </span>reqid<span class="w"> </span><span class="m">1</span><span class="w"> </span>mode<span class="w"> </span>tunnel
<span class="w">    </span>replay-window<span class="w"> </span><span class="m">0</span><span class="w"> </span>
<span class="w">    </span>auth-trunc<span class="w"> </span>hmac<span class="o">(</span>sha256<span class="o">)</span><span class="w"> </span>0x...<span class="w"> </span><span class="m">128</span>
<span class="w">    </span>enc<span class="w"> </span>cbc<span class="o">(</span>aes<span class="o">)</span><span class="w"> </span>0x...
</code></pre></div>
<h4 id="5042-xfrm">50.4.2 查看 xfrm 策略<a class="headerlink" href="#5042-xfrm" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 IPsec 策略</span>
ip<span class="w"> </span>xfrm<span class="w"> </span>policy

<span class="c1"># 输出示例</span>
src<span class="w"> </span><span class="m">10</span>.244.0.0/24<span class="w"> </span>dst<span class="w"> </span><span class="m">10</span>.244.1.0/24<span class="w"> </span>
<span class="w">    </span>dir<span class="w"> </span>out<span class="w"> </span>priority<span class="w"> </span><span class="m">100</span>
<span class="w">    </span>tmpl<span class="w"> </span>src<span class="w"> </span><span class="m">172</span>.18.0.3<span class="w"> </span>dst<span class="w"> </span><span class="m">172</span>.18.0.4
<span class="w">        </span>proto<span class="w"> </span>esp<span class="w"> </span>reqid<span class="w"> </span><span class="m">1</span><span class="w"> </span>mode<span class="w"> </span>tunnel
</code></pre></div>
<h4 id="5043-xfrm">50.4.3 xfrm 工作流程<a class="headerlink" href="#5043-xfrm" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    A[&quot;数据包到达内核&quot;] --&gt; B{&quot;匹配 xfrm policy?&quot;}
    B --&gt;|&quot;是&quot;| C[&quot;查找对应 xfrm state&quot;]
    B --&gt;|&quot;否&quot;| D[&quot;普通路由转发&quot;]
    C --&gt; E[&quot;获取加密算法和密钥&quot;]
    E --&gt; F[&quot;ESP 封装+加密&quot;]
    F --&gt; G[&quot;添加外层 IP&quot;]
    G --&gt; H[&quot;发送到物理网络&quot;]
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>IPsec 不依赖路由表</strong></p>
<p>与 host-gw 不同，IPsec Tunnel 模式通过 <code>xfrm policy</code> 决定转发，不需要在路由表中配置到远端 Pod 网段的路由。</p>
</blockquote>
<h3 id="505">50.5 抓包与解密<a class="headerlink" href="#505" title="Permanent link">&para;</a></h3>
<h4 id="5051-esp">50.5.1 抓取 ESP 包<a class="headerlink" href="#5051-esp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 eth0 上抓取 ESP 协议包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-nn<span class="w"> </span>esp<span class="w"> </span>-w<span class="w"> </span>ipsec.pcap
</code></pre></div>
<h4 id="5052-wireshark">50.5.2 Wireshark 解密配置<a class="headerlink" href="#5052-wireshark" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    A[&quot;打开 Wireshark&quot;] --&gt; B[&quot;Edit → Preferences&quot;]
    B --&gt; C[&quot;Protocols → ESP&quot;]
    C --&gt; D[&quot;添加 SA&quot;]
    D --&gt; E[&quot;填写 SPI/算法/密钥&quot;]
    E --&gt; F[&quot;解密成功&quot;]
</code></pre></div>
<p><strong>解密步骤</strong>：</p>
<ol>
<li>从 <code>ip xfrm state</code> 获取 SPI、算法、密钥</li>
<li>在 Wireshark 中：<code>Edit → Preferences → Protocols → ESP</code></li>
<li>添加 SA 条目：</li>
<li>Source/Destination IP</li>
<li>SPI 值</li>
<li>加密算法（如 AES-GCM-128）</li>
<li>密钥</li>
</ol>
<h3 id="506">50.6 与其他模式对比<a class="headerlink" href="#506" title="Permanent link">&para;</a></h3>
<h4 id="5061">50.6.1 封装方式对比<a class="headerlink" href="#5061" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">封装</th>
<th style="text-align: left;">加密</th>
<th style="text-align: left;">MTU</th>
<th style="text-align: left;">CPU 开销</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">host-gw</td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">1500</td>
<td style="text-align: left;">最低</td>
</tr>
<tr>
<td style="text-align: left;">IPIP</td>
<td style="text-align: left;">IP-in-IP</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">1480</td>
<td style="text-align: left;">低</td>
</tr>
<tr>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;">UDP+VxLAN</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">1450</td>
<td style="text-align: left;">中</td>
</tr>
<tr>
<td style="text-align: left;"><strong>IPsec</strong></td>
<td style="text-align: left;"><strong>ESP+Tunnel</strong></td>
<td style="text-align: left;"><strong>✅</strong></td>
<td style="text-align: left;"><strong>~1400</strong></td>
<td style="text-align: left;"><strong>高</strong></td>
</tr>
<tr>
<td style="text-align: left;">WireGuard</td>
<td style="text-align: left;">UDP</td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">~1420</td>
<td style="text-align: left;">中</td>
</tr>
</tbody>
</table>
<h4 id="5062-ipsec-vs-wireguard">50.6.2 IPsec vs WireGuard<a class="headerlink" href="#5062-ipsec-vs-wireguard" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;IPsec&quot;
        I1[&quot;复杂配置&quot;]
        I2[&quot;成熟稳定&quot;]
        I3[&quot;多种算法&quot;]
        I4[&quot;较高 CPU&quot;]
    end

    subgraph &quot;WireGuard&quot;
        W1[&quot;简单配置&quot;]
        W2[&quot;现代设计&quot;]
        W3[&quot;固定算法&quot;]
        W4[&quot;较低 CPU&quot;]
    end

    I1 -.-&gt;|&quot;对比&quot;| W1
    I4 -.-&gt;|&quot;对比&quot;| W4
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">IPsec</th>
<th style="text-align: left;">WireGuard</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">复杂度</td>
<td style="text-align: left;">高</td>
<td style="text-align: left;">低</td>
</tr>
<tr>
<td style="text-align: left;">密钥管理</td>
<td style="text-align: left;">PSK/证书</td>
<td style="text-align: left;">公钥</td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;">中等</td>
<td style="text-align: left;">较高</td>
</tr>
<tr>
<td style="text-align: left;">内核集成</td>
<td style="text-align: left;">传统</td>
<td style="text-align: left;">Linux 5.6+ 原生</td>
</tr>
</tbody>
</table>
<h3 id="507">50.7 生产注意事项<a class="headerlink" href="#507" title="Permanent link">&para;</a></h3>
<blockquote>
<p>[!CAUTION]
<strong>IPsec 生产使用注意</strong></p>
<ol>
<li><strong>性能开销</strong>：每个数据包都需要加解密，高流量场景下 CPU 消耗显著</li>
<li><strong>MTU 调整</strong>：ESP 封装会减少可用 MTU，注意调整应用配置</li>
<li><strong>密钥安全</strong>：PSK 需要安全分发和存储</li>
<li><strong>调试复杂</strong>：加密后的数据包难以直接分析</li>
</ol>
</blockquote>
<h3 id="508">50.8 章节小结<a class="headerlink" href="#508" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Flannel IPsec 模式))
    配置
      Type ipsec
      PSK 预共享密钥
    原理
      Tunnel 模式
      ESP 封装+加密
      xfrm state/policy
    特点
      三层协议
      内层无 MAC
      不依赖路由表
    解密
      ip xfrm state
      Wireshark ESP
    对比
      比 WireGuard 复杂
      CPU 开销高
      成熟稳定
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Flannel IPsec 模式要点总结</strong>：</p>
<ol>
<li><strong>配置方式</strong>：</li>
<li><code>Backend.Type: "ipsec"</code></li>
<li>
<p>PSK 是必选参数（至少 96 位）</p>
</li>
<li>
<p><strong>核心原理</strong>：</p>
</li>
<li>使用 <strong>ESP Tunnel 模式</strong>封装和加密</li>
<li>通过 <strong>xfrm policy</strong> 决定转发（不依赖路由表）</li>
<li>
<p>三层协议，封装时不包含内层 MAC</p>
</li>
<li>
<p><strong>xfrm 命令</strong>：</p>
</li>
<li><code>ip xfrm state</code>：查看 SA（密钥、算法）</li>
<li>
<p><code>ip xfrm policy</code>：查看转发策略</p>
</li>
<li>
<p><strong>抓包解密</strong>：</p>
</li>
<li>抓包：<code>tcpdump esp</code></li>
<li>
<p>Wireshark 需配置 ESP SA 才能解密</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
</li>
<li>跨不可信网络的安全通信</li>
<li>对数据传输有加密要求的场景</li>
</ol>
</blockquote>
<hr />
<h2 id="flannel-wireguard">第五十一章 Flannel-WireGuard 模式<a class="headerlink" href="#flannel-wireguard" title="Permanent link">&para;</a></h2>
<p>本章深入讲解 Flannel 的 WireGuard 模式，包括配置方法、公钥/私钥加密机制、flannel-wg 设备原理、peer 概念，以及与 IPsec 的对比。</p>
<h3 id="511">51.1 背景与概述<a class="headerlink" href="#511" title="Permanent link">&para;</a></h3>
<h4 id="5111-wireguard">51.1.1 WireGuard 模式定位<a class="headerlink" href="#5111-wireguard" title="Permanent link">&para;</a></h4>
<p>WireGuard 是 Flannel 中提供<strong>现代加密传输</strong>的后端类型：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;加密后端对比&quot;
        IPsec[&quot;IPsec 模式&lt;br/&gt;🔐 传统加密&lt;br/&gt;复杂配置&quot;]
        WireGuard[&quot;WireGuard 模式&lt;br/&gt;🔐 现代加密&lt;br/&gt;简单高效&quot;]
    end

    IPsec --&gt;|&quot;ESP + PSK&quot;| Encrypt[&quot;加密传输&quot;]
    WireGuard --&gt;|&quot;ChaCha20 + 公钥&quot;| Encrypt
</code></pre></div>
<h4 id="5112">51.1.2 核心特点<a class="headerlink" href="#5112" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">加密算法</td>
<td style="text-align: left;">ChaCha20-Poly1305</td>
</tr>
<tr>
<td style="text-align: left;">密钥类型</td>
<td style="text-align: left;">公钥/私钥对</td>
</tr>
<tr>
<td style="text-align: left;">传输协议</td>
<td style="text-align: left;">UDP</td>
</tr>
<tr>
<td style="text-align: left;">默认端口</td>
<td style="text-align: left;"><strong>51820</strong></td>
</tr>
<tr>
<td style="text-align: left;">内核集成</td>
<td style="text-align: left;">Linux 5.6+ 原生支持</td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;">优于 IPsec</td>
</tr>
</tbody>
</table>
<h3 id="512-wireguard">51.2 WireGuard 配置<a class="headerlink" href="#512-wireguard" title="Permanent link">&para;</a></h3>
<h4 id="5121-configmap">51.2.1 ConfigMap 配置<a class="headerlink" href="#5121-configmap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel-cfg</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-flannel</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">net-conf.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<span class="w">      </span><span class="no">&quot;Backend&quot;: {</span>
<span class="w">        </span><span class="no">&quot;Type&quot;: &quot;wireguard&quot;</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>最简配置</strong></p>
<p>WireGuard 后端只需要指定 <code>Type: "wireguard"</code>，无需像 IPsec 那样手动配置 PSK。密钥对由 Flannel 自动生成和分发。</p>
</blockquote>
<h4 id="5122">51.2.2 可选参数<a class="headerlink" href="#5122" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">PSK</td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">可选的预共享密钥</td>
</tr>
<tr>
<td style="text-align: left;">ListenPort</td>
<td style="text-align: left;">int</td>
<td style="text-align: left;">监听端口（默认 51820）</td>
</tr>
<tr>
<td style="text-align: left;">MTU</td>
<td style="text-align: left;">int</td>
<td style="text-align: left;">自动协商</td>
</tr>
</tbody>
</table>
<h3 id="513-wireguard">51.3 WireGuard 工作原理<a class="headerlink" href="#513-wireguard" title="Permanent link">&para;</a></h3>
<h4 id="5131">51.3.1 设备与路由<a class="headerlink" href="#5131" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 WireGuard 设备</span>
ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span><span class="nb">type</span><span class="w"> </span>wireguard

<span class="c1"># 输出示例</span>
<span class="m">5</span>:<span class="w"> </span>flannel-wg:<span class="w"> </span>&lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1420</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue
<span class="w">    </span>link/none
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># 路由表</span>
ip<span class="w"> </span>route

<span class="c1"># 输出示例</span>
<span class="m">10</span>.244.0.0/16<span class="w"> </span>dev<span class="w"> </span>flannel-wg
</code></pre></div>
<h4 id="5132">51.3.2 通信架构<a class="headerlink" href="#5132" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant PodA as Pod A&lt;br/&gt;10.244.0.5
    participant CNI as cni0
    participant WG as flannel-wg&lt;br/&gt;WireGuard 设备
    participant Network as 物理网络&lt;br/&gt;UDP 51820
    participant WG2 as flannel-wg
    participant CNI2 as cni0
    participant PodB as Pod B&lt;br/&gt;10.244.1.2

    PodA-&gt;&gt;CNI: 1. 原始 IP 包
    CNI-&gt;&gt;WG: 2. 路由匹配
    WG-&gt;&gt;WG: 3. 加密+封装
    WG-&gt;&gt;Network: 4. UDP 51820
    Network-&gt;&gt;WG2: 5. 传输
    WG2-&gt;&gt;WG2: 6. 解密+解封
    WG2-&gt;&gt;CNI2: 7. 路由
    CNI2-&gt;&gt;PodB: 8. 交付
</code></pre></div>
<h4 id="5133-peer">51.3.3 Peer 概念<a class="headerlink" href="#5133-peer" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Node1 172.18.0.3&quot;
        WG1[&quot;flannel-wg&lt;br/&gt;Private Key: xxx&quot;]
        Peer1A[&quot;Peer: Node2&lt;br/&gt;Public Key: yyy&lt;br/&gt;Endpoint: 172.18.0.4:51820&lt;br/&gt;AllowedIPs: 10.244.1.0/24&quot;]
        Peer1B[&quot;Peer: Node3&lt;br/&gt;Public Key: zzz&lt;br/&gt;Endpoint: 172.18.0.5:51820&lt;br/&gt;AllowedIPs: 10.244.2.0/24&quot;]
    end

    WG1 --&gt; Peer1A
    WG1 --&gt; Peer1B
</code></pre></div>
<p><strong>Peer 配置说明</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Public Key</td>
<td style="text-align: left;">对端的公钥（用于加密）</td>
</tr>
<tr>
<td style="text-align: left;">Endpoint</td>
<td style="text-align: left;">对端的 IP:Port</td>
</tr>
<tr>
<td style="text-align: left;">AllowedIPs</td>
<td style="text-align: left;">允许通过此 Peer 的 Pod 网段</td>
</tr>
</tbody>
</table>
<h3 id="514-wg">51.4 wg 命令详解<a class="headerlink" href="#514-wg" title="Permanent link">&para;</a></h3>
<h4 id="5141">51.4.1 安装工具<a class="headerlink" href="#5141" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Debian/Ubuntu</span>
apt-get<span class="w"> </span>install<span class="w"> </span>wireguard-tools

<span class="c1"># CentOS/RHEL</span>
yum<span class="w"> </span>install<span class="w"> </span>wireguard-tools
</code></pre></div>
<h4 id="5142">51.4.2 查看配置<a class="headerlink" href="#5142" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 WireGuard 接口配置</span>
wg<span class="w"> </span>show<span class="w"> </span>flannel-wg

<span class="c1"># 输出示例</span>
interface:<span class="w"> </span>flannel-wg
<span class="w">  </span>public<span class="w"> </span>key:<span class="w"> </span>ABC123...
<span class="w">  </span>private<span class="w"> </span>key:<span class="w"> </span><span class="o">(</span>hidden<span class="o">)</span>
<span class="w">  </span>listening<span class="w"> </span>port:<span class="w"> </span><span class="m">51820</span>

peer:<span class="w"> </span>XYZ789...
<span class="w">  </span>endpoint:<span class="w"> </span><span class="m">172</span>.18.0.4:51820
<span class="w">  </span>allowed<span class="w"> </span>ips:<span class="w"> </span><span class="m">10</span>.244.1.0/24
<span class="w">  </span>latest<span class="w"> </span>handshake:<span class="w"> </span><span class="m">5</span><span class="w"> </span>seconds<span class="w"> </span>ago
<span class="w">  </span>transfer:<span class="w"> </span><span class="m">1</span>.2<span class="w"> </span>MiB<span class="w"> </span>received,<span class="w"> </span><span class="m">800</span><span class="w"> </span>KiB<span class="w"> </span>sent
</code></pre></div>
<h4 id="5143">51.4.3 关键字段解读<a class="headerlink" href="#5143" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;wg show 输出&quot;
        A[&quot;listening port&lt;br/&gt;监听端口&quot;]
        B[&quot;public key&lt;br/&gt;本端公钥&quot;]
        C[&quot;peer&lt;br/&gt;对端公钥&quot;]
        D[&quot;endpoint&lt;br/&gt;对端地址&quot;]
        E[&quot;allowed ips&lt;br/&gt;允许的网段&quot;]
        F[&quot;handshake&lt;br/&gt;握手状态&quot;]
    end

    A --&gt; B --&gt; C --&gt; D --&gt; E --&gt; F
</code></pre></div>
<h3 id="515">51.5 加密机制<a class="headerlink" href="#515" title="Permanent link">&para;</a></h3>
<h4 id="5151">51.5.1 公钥/私钥<a class="headerlink" href="#5151" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Node1&quot;
        Priv1[&quot;私钥 (保密)&quot;]
        Pub1[&quot;公钥 (公开)&quot;]
        Priv1 --&gt;|&quot;生成&quot;| Pub1
    end

    subgraph &quot;Node2&quot;
        Priv2[&quot;私钥 (保密)&quot;]
        Pub2[&quot;公钥 (公开)&quot;]
        Priv2 --&gt;|&quot;生成&quot;| Pub2
    end

    Pub1 -.-&gt;|&quot;交换&quot;| Node2
    Pub2 -.-&gt;|&quot;交换&quot;| Node1
</code></pre></div>
<p><strong>加密过程</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">步骤</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1</td>
<td style="text-align: left;">Node1 用 <strong>Node2 的公钥</strong>加密数据</td>
</tr>
<tr>
<td style="text-align: left;">2</td>
<td style="text-align: left;">数据通过网络传输</td>
</tr>
<tr>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Node2 用 <strong>自己的私钥</strong>解密数据</td>
</tr>
</tbody>
</table>
<h4 id="5152">51.5.2 内核态处理<a class="headerlink" href="#5152" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查端口监听</span>
ss<span class="w"> </span>-ulnp<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">51820</span>

<span class="c1"># 输出示例</span>
udp<span class="w">  </span>UNCONN<span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="m">0</span><span class="w">  </span><span class="m">0</span>.0.0.0:51820<span class="w">  </span><span class="m">0</span>.0.0.0:*
<span class="w">                           </span>users:<span class="o">((</span><span class="s2">&quot;kernel&quot;</span>,pid<span class="o">=</span>-<span class="o">))</span>
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>内核态进程</strong></p>
<p>WireGuard 是 in-kernel 实现，端口由内核直接监听（pid 显示为 <code>-</code> 或 <code>kernel</code>），无用户态进程，性能更高。</p>
</blockquote>
<h3 id="516">51.6 与其他模式对比<a class="headerlink" href="#516" title="Permanent link">&para;</a></h3>
<h4 id="5161">51.6.1 加密模式对比<a class="headerlink" href="#5161" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">IPsec</th>
<th style="text-align: left;">WireGuard</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">配置复杂度</td>
<td style="text-align: left;">高（需手动 PSK）</td>
<td style="text-align: left;">低（自动密钥）</td>
</tr>
<tr>
<td style="text-align: left;">加密协议</td>
<td style="text-align: left;">ESP (AES-GCM)</td>
<td style="text-align: left;">ChaCha20-Poly1305</td>
</tr>
<tr>
<td style="text-align: left;">内核支持</td>
<td style="text-align: left;">传统模块</td>
<td style="text-align: left;">5.6+ 原生</td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;">中等</td>
<td style="text-align: left;">较高</td>
</tr>
<tr>
<td style="text-align: left;">代码行数</td>
<td style="text-align: left;">~400,000</td>
<td style="text-align: left;">~4,000</td>
</tr>
</tbody>
</table>
<h4 id="5162-flannel">51.6.2 Flannel 后端总结<a class="headerlink" href="#5162-flannel" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;无加密&quot;
        UDP[&quot;UDP&lt;br/&gt;❌ 废弃&quot;]
        VxLAN[&quot;VxLAN&lt;br/&gt;⭐ 推荐&quot;]
        IPIP[&quot;IPIP&lt;br/&gt;轻量&quot;]
        HostGW[&quot;host-gw&lt;br/&gt;最快&quot;]
    end

    subgraph &quot;有加密&quot;
        IPsec[&quot;IPsec&lt;br/&gt;传统&quot;]
        WireGuard[&quot;WireGuard&lt;br/&gt;⭐ 现代&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">封装</th>
<th style="text-align: left;">加密</th>
<th style="text-align: left;">推荐场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">VxLAN</td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">通用场景</td>
</tr>
<tr>
<td style="text-align: left;">host-gw</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">同二层高性能</td>
</tr>
<tr>
<td style="text-align: left;">IPIP</td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">❌</td>
<td style="text-align: left;">轻量跨子网</td>
</tr>
<tr>
<td style="text-align: left;">IPsec</td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">传统安全需求</td>
</tr>
<tr>
<td style="text-align: left;"><strong>WireGuard</strong></td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;">✅</td>
<td style="text-align: left;"><strong>现代安全需求</strong></td>
</tr>
</tbody>
</table>
<h3 id="517">51.7 章节小结<a class="headerlink" href="#517" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Flannel WireGuard 模式))
    配置
      Type wireguard
      自动密钥管理
      端口 51820
    原理
      公钥/私钥
      Peer 概念
      UDP 封装
    设备
      flannel-wg
      内核态
      in-kernel
    命令
      wg show
      wg showconf
    优势
      配置简单
      性能高
      代码精简
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Flannel WireGuard 模式要点总结</strong>：</p>
<ol>
<li><strong>配置方式</strong>：</li>
<li><code>Backend.Type: "wireguard"</code></li>
<li>
<p>密钥自动生成，无需手动配置 PSK</p>
</li>
<li>
<p><strong>核心原理</strong>：</p>
</li>
<li>使用 <strong>公钥/私钥</strong>加密</li>
<li>通过 <strong>Peer</strong> 概念管理对端信息</li>
<li>
<p><strong>UDP 51820</strong> 端口传输</p>
</li>
<li>
<p><strong>关键设备</strong>：</p>
</li>
<li><code>flannel-wg</code>：WireGuard 虚拟接口</li>
<li>
<p>内核态运行，无用户态进程</p>
</li>
<li>
<p><strong>核心命令</strong>：</p>
</li>
<li><code>wg show flannel-wg</code>：查看配置</li>
<li>
<p><code>ip link show type wireguard</code>：查看设备</p>
</li>
<li>
<p><strong>与 IPsec 对比</strong>：</p>
</li>
<li>配置更简单</li>
<li>性能更高</li>
<li>Linux 5.6+ 原生支持</li>
</ol>
</blockquote>
<hr />
<h2 id="multus">第五十二章 Multus 多网卡方案<a class="headerlink" href="#multus" title="Permanent link">&para;</a></h2>
<p>本章深入讲解 Multus CNI 多网卡方案，包括核心架构、组件体系、NetworkAttachmentDefinition 配置、Pod 注解使用方式，以及典型应用场景。</p>
<h3 id="521">52.1 背景与概述<a class="headerlink" href="#521" title="Permanent link">&para;</a></h3>
<h4 id="5211">52.1.1 为什么需要多网卡<a class="headerlink" href="#5211" title="Permanent link">&para;</a></h4>
<p>传统 Pod 只有一个网卡（eth0），在以下场景存在局限：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;单网卡限制&quot;
        A[&quot;所有流量混合&quot;] --&gt; B[&quot;控制面 + 数据面&quot;]
        B --&gt; C[&quot;无法隔离&quot;]
        C --&gt; D[&quot;性能瓶颈&quot;]
    end
</code></pre></div>
<p><strong>多网卡需求场景</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">转控分离</td>
<td style="text-align: left;">控制平面和数据平面使用不同网卡</td>
</tr>
<tr>
<td style="text-align: left;">高性能网络</td>
<td style="text-align: left;">SR-IOV/DPDK 直通网卡</td>
</tr>
<tr>
<td style="text-align: left;">多租户隔离</td>
<td style="text-align: left;">不同业务使用不同网络</td>
</tr>
<tr>
<td style="text-align: left;">电信/金融</td>
<td style="text-align: left;">NFV、流媒体处理</td>
</tr>
</tbody>
</table>
<h4 id="5212-multus">52.1.2 Multus 定位<a class="headerlink" href="#5212-multus" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Multus CNI 架构&quot;
        Pod[&quot;Pod&quot;]
        eth0[&quot;eth0&lt;br/&gt;默认 CNI&quot;]
        eth1[&quot;net1&lt;br/&gt;IPVLAN&quot;]
        eth2[&quot;net2&lt;br/&gt;MACVLAN&quot;]
        eth3[&quot;net3&lt;br/&gt;SR-IOV&quot;]

        Pod --&gt; eth0
        Pod --&gt; eth1
        Pod --&gt; eth2
        Pod --&gt; eth3
    end

    Calico[&quot;Calico/Flannel&quot;] --&gt; eth0
    Multus[&quot;Multus CNI&quot;] --&gt; eth1
    Multus --&gt; eth2
    Multus --&gt; eth3
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>Multus 核心功能</strong></p>
<p>Multus CNI 是一个 <strong>Meta CNI</strong>，不直接提供网络功能，而是协调多个 CNI 插件为 Pod 添加多张网卡。</p>
</blockquote>
<h3 id="522">52.2 核心组件<a class="headerlink" href="#522" title="Permanent link">&para;</a></h3>
<h4 id="5221">52.2.1 组件架构<a class="headerlink" href="#5221" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;k8s-network-plumbing-wg 项目&quot;
        Multus[&quot;Multus CNI&lt;br/&gt;多网卡编排&quot;]
        SRIOV_DP[&quot;SR-IOV Device Plugin&lt;br/&gt;VF 资源管理&quot;]
        SRIOV_CNI[&quot;SR-IOV CNI&lt;br/&gt;网络通路搭建&quot;]
        WhereAbouts[&quot;WhereAbouts&lt;br/&gt;集群级 IPAM&quot;]
    end

    Multus --&gt; |&quot;调用&quot;| SRIOV_CNI
    Multus --&gt; |&quot;调用&quot;| MACVlan[&quot;macvlan/ipvlan&quot;]
    SRIOV_DP --&gt; |&quot;分配 VF&quot;| Pod
    WhereAbouts --&gt; |&quot;分配 IP&quot;| Pod
</code></pre></div>
<h4 id="5222">52.2.2 组件职责<a class="headerlink" href="#5222" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">组件</th>
<th style="text-align: left;">职责</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Multus CNI</strong></td>
<td style="text-align: left;">多网卡编排</td>
<td style="text-align: left;">Meta CNI，协调多个 CNI 插件</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SR-IOV Device Plugin</strong></td>
<td style="text-align: left;">VF 资源管理</td>
<td style="text-align: left;">发现和通告 VF/PF 资源</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SR-IOV CNI</strong></td>
<td style="text-align: left;">网络通路搭建</td>
<td style="text-align: left;">构建 SR-IOV 网络连接</td>
</tr>
<tr>
<td style="text-align: left;"><strong>WhereAbouts</strong></td>
<td style="text-align: left;">集群级 IPAM</td>
<td style="text-align: left;">跨节点 IP 地址管理</td>
</tr>
</tbody>
</table>
<h4 id="5223-sr-iov">52.2.3 SR-IOV 概念<a class="headerlink" href="#5223-sr-iov" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;物理网卡&quot;
        PF[&quot;PF (Physical Function)&lt;br/&gt;物理功能&lt;br/&gt;真实网口&quot;]
        VF1[&quot;VF0&quot;]
        VF2[&quot;VF1&quot;]
        VF3[&quot;VF2&quot;]
        VFn[&quot;VF...&quot;]
    end

    PF --&gt; VF1
    PF --&gt; VF2
    PF --&gt; VF3
    PF --&gt; VFn

    VF1 --&gt; Pod1[&quot;Pod 1&quot;]
    VF2 --&gt; Pod2[&quot;Pod 2&quot;]
    VF3 --&gt; Pod3[&quot;Pod 3&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">术语</th>
<th style="text-align: left;">全称</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">PF</td>
<td style="text-align: left;">Physical Function</td>
<td style="text-align: left;">物理网卡功能</td>
</tr>
<tr>
<td style="text-align: left;">VF</td>
<td style="text-align: left;">Virtual Function</td>
<td style="text-align: left;">虚拟化子网卡</td>
</tr>
</tbody>
</table>
<h3 id="523-networkattachmentdefinition">52.3 NetworkAttachmentDefinition<a class="headerlink" href="#523-networkattachmentdefinition" title="Permanent link">&para;</a></h3>
<h4 id="5231-nad">52.3.1 NAD 概念<a class="headerlink" href="#5231-nad" title="Permanent link">&para;</a></h4>
<p>NetworkAttachmentDefinition（NAD）是 Multus 的核心 CRD：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-conf</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;macvlan&quot;,</span>
<span class="w">    </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth0&quot;,</span>
<span class="w">    </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;bridge&quot;,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">      </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;192.168.1.0/24&quot;</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<h4 id="5232-nad">52.3.2 NAD 结构解析<a class="headerlink" href="#5232-nad" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;NetworkAttachmentDefinition&quot;
        A[&quot;metadata.name&lt;br/&gt;网络名称&quot;]
        B[&quot;spec.config&lt;br/&gt;CNI 配置&quot;]
    end

    subgraph &quot;CNI 配置内容&quot;
        C[&quot;type&lt;br/&gt;CNI 类型&quot;]
        D[&quot;master&lt;br/&gt;父接口&quot;]
        E[&quot;mode&lt;br/&gt;模式&quot;]
        F[&quot;ipam&lt;br/&gt;IP 分配&quot;]
    end

    B --&gt; C
    B --&gt; D
    B --&gt; E
    B --&gt; F
</code></pre></div>
<h3 id="524-pod">52.4 Pod 多网卡配置<a class="headerlink" href="#524-pod" title="Permanent link">&para;</a></h3>
<h4 id="5241">52.4.1 注解方式<a class="headerlink" href="#5241" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multi-net-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-conf</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<h4 id="5242">52.4.2 多网卡配置<a class="headerlink" href="#5242" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multi-net-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 添加多张网卡</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">[</span>
<span class="w">        </span><span class="no">{&quot;name&quot;: &quot;macvlan-conf&quot;},</span>
<span class="w">        </span><span class="no">{&quot;name&quot;: &quot;ipvlan-conf&quot;, &quot;interface&quot;: &quot;net2&quot;}</span>
<span class="w">      </span><span class="no">]</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<h4 id="5243-pod">52.4.3 Pod 网络结构<a class="headerlink" href="#5243-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;Pod multi-net-pod&quot;
        lo[&quot;lo&lt;br/&gt;127.0.0.1&quot;]
        eth0[&quot;eth0&lt;br/&gt;10.244.0.5&lt;br/&gt;默认 CNI&quot;]
        net1[&quot;net1&lt;br/&gt;192.168.1.10&lt;br/&gt;macvlan&quot;]
        net2[&quot;net2&lt;br/&gt;192.168.2.10&lt;br/&gt;ipvlan&quot;]
    end

    Calico[&quot;默认 CNI&lt;br/&gt;(Calico/Flannel)&quot;] --&gt; eth0
    NAD1[&quot;NAD: macvlan-conf&quot;] --&gt; net1
    NAD2[&quot;NAD: ipvlan-conf&quot;] --&gt; net2
</code></pre></div>
<h3 id="525">52.5 安装部署<a class="headerlink" href="#525" title="Permanent link">&para;</a></h3>
<h4 id="5251-multus">52.5.1 安装 Multus<a class="headerlink" href="#5251-multus" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 克隆项目</span>
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/k8snetworkplumbingwg/multus-cni.git
<span class="nb">cd</span><span class="w"> </span>multus-cni

<span class="c1"># 安装</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>deployments/multus-daemonset.yml
</code></pre></div>
<h4 id="5252-whereabouts">52.5.2 安装 WhereAbouts<a class="headerlink" href="#5252-whereabouts" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 安装 WhereAbouts IPAM</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/k8snetworkplumbingwg/whereabouts/master/doc/crds/whereabouts.cni.cncf.io_ippools.yaml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/k8snetworkplumbingwg/whereabouts/master/doc/crds/whereabouts.cni.cncf.io_overlappingrangeipreservations.yaml
</code></pre></div>
<h4 id="5253">52.5.3 验证安装<a class="headerlink" href="#5253" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 Multus DaemonSet</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>multus

<span class="c1"># 检查 CNI 插件</span>
ls<span class="w"> </span>/opt/cni/bin/<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;macvlan|ipvlan|multus&quot;</span>
</code></pre></div>
<h3 id="526">52.6 使用场景<a class="headerlink" href="#526" title="Permanent link">&para;</a></h3>
<h4 id="5261-cni">52.6.1 常用后端 CNI<a class="headerlink" href="#5261-cni" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">CNI 类型</th>
<th style="text-align: left;">特点</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>macvlan</strong></td>
<td style="text-align: left;">虚拟 MAC 地址</td>
<td style="text-align: left;">裸机环境</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ipvlan</strong></td>
<td style="text-align: left;">共享 MAC 地址</td>
<td style="text-align: left;">云环境/OpenStack</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SR-IOV</strong></td>
<td style="text-align: left;">硬件直通</td>
<td style="text-align: left;">高性能/DPDK</td>
</tr>
<tr>
<td style="text-align: left;"><strong>bridge</strong></td>
<td style="text-align: left;">软件桥接</td>
<td style="text-align: left;">通用场景</td>
</tr>
</tbody>
</table>
<h4 id="5262-macvlan-vs-ipvlan">52.6.2 macvlan vs ipvlan<a class="headerlink" href="#5262-macvlan-vs-ipvlan" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;macvlan&quot;
        M_Parent[&quot;父接口 eth0&lt;br/&gt;MAC: aa:bb:cc:dd:ee:ff&quot;]
        M_Sub1[&quot;子接口 1&lt;br/&gt;MAC: 11:22:33:44:55:66&quot;]
        M_Sub2[&quot;子接口 2&lt;br/&gt;MAC: aa:bb:cc:11:22:33&quot;]
        M_Parent --&gt; M_Sub1
        M_Parent --&gt; M_Sub2
    end

    subgraph &quot;ipvlan&quot;
        I_Parent[&quot;父接口 eth0&lt;br/&gt;MAC: aa:bb:cc:dd:ee:ff&quot;]
        I_Sub1[&quot;子接口 1&lt;br/&gt;MAC: 共享父接口&quot;]
        I_Sub2[&quot;子接口 2&lt;br/&gt;MAC: 共享父接口&quot;]
        I_Parent --&gt; I_Sub1
        I_Parent --&gt; I_Sub2
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">macvlan</th>
<th style="text-align: left;">ipvlan</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">MAC 地址</td>
<td style="text-align: left;">每个子接口独立 MAC</td>
<td style="text-align: left;">共享父接口 MAC</td>
</tr>
<tr>
<td style="text-align: left;">云环境</td>
<td style="text-align: left;">❌ 可能被拦截</td>
<td style="text-align: left;">✅ 推荐</td>
</tr>
<tr>
<td style="text-align: left;">裸机环境</td>
<td style="text-align: left;">✅ 推荐</td>
<td style="text-align: left;">✅ 可用</td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;">高</td>
<td style="text-align: left;">更高</td>
</tr>
</tbody>
</table>
<h3 id="527">52.7 章节小结<a class="headerlink" href="#527" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((Multus 多网卡))
    定位
      Meta CNI
      多网卡编排
      英特尔开源
    组件
      Multus CNI
      SR-IOV Device Plugin
      SR-IOV CNI
      WhereAbouts IPAM
    配置
      NetworkAttachmentDefinition
      Pod 注解
      多网卡列表
    后端
      macvlan
      ipvlan
      SR-IOV
      bridge
    场景
      转控分离
      高性能网络
      电信/金融
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Multus 多网卡方案要点总结</strong>：</p>
<ol>
<li><strong>核心概念</strong>：</li>
<li>Multus 是 <strong>Meta CNI</strong>，协调多个 CNI 插件</li>
<li>
<p>为 Pod 添加除 eth0 外的额外网卡</p>
</li>
<li>
<p><strong>核心组件</strong>：</p>
</li>
<li><strong>Multus CNI</strong>：多网卡编排</li>
<li><strong>SR-IOV Device Plugin</strong>：VF 资源管理</li>
<li>
<p><strong>WhereAbouts</strong>：集群级 IPAM</p>
</li>
<li>
<p><strong>配置方式</strong>：</p>
</li>
<li>创建 <strong>NetworkAttachmentDefinition</strong> CRD</li>
<li>
<p>Pod 通过 <strong>注解</strong> 引用 NAD</p>
</li>
<li>
<p><strong>常用后端</strong>：</p>
</li>
<li><strong>macvlan</strong>：裸机环境</li>
<li><strong>ipvlan</strong>：云环境（共享 MAC）</li>
<li>
<p><strong>SR-IOV</strong>：高性能直通</p>
</li>
<li>
<p><strong>典型场景</strong>：</p>
</li>
<li>转控分离（控制面/数据面隔离）</li>
<li>电信 NFV、金融高频交易</li>
<li>流媒体处理</li>
</ol>
</blockquote>
<hr />
<h2 id="multus-ipvlan-l2">第五十三章 Multus IPVLAN L2 模式<a class="headerlink" href="#multus-ipvlan-l2" title="Permanent link">&para;</a></h2>
<p>本章深入讲解 IPVLAN L2 模式的工作原理、配置方法、适用场景，以及与 MACVLAN 的区别。</p>
<h3 id="531">53.1 背景与概述<a class="headerlink" href="#531" title="Permanent link">&para;</a></h3>
<h4 id="5311-ipvlan">53.1.1 IPVLAN 简介<a class="headerlink" href="#5311-ipvlan" title="Permanent link">&para;</a></h4>
<p>IPVLAN 是一种网卡复用技术，区别于 MACVLAN 的核心特点是：<strong>子接口与父接口共享同一 MAC 地址</strong>。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;IPVLAN 特性&quot;
        Parent[&quot;父接口 eth0&lt;br/&gt;MAC: aa:bb:cc:dd:ee:ff&quot;]
        Sub1[&quot;子接口 ipvl0&lt;br/&gt;MAC: aa:bb:cc:dd:ee:ff&lt;br/&gt;IP: 172.18.0.200&quot;]
        Sub2[&quot;子接口 ipvl1&lt;br/&gt;MAC: aa:bb:cc:dd:ee:ff&lt;br/&gt;IP: 172.18.0.201&quot;]

        Parent --&gt; Sub1
        Parent --&gt; Sub2
    end
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>IPVLAN 核心特性</strong></p>
<ul>
<li>子接口与父接口 <strong>MAC 地址相同</strong></li>
<li>不同子接口通过 <strong>IP 地址</strong> 区分</li>
<li>内核要求：<strong>Linux 4.18+</strong></li>
</ul>
</blockquote>
<h4 id="5312-ipvlan">53.1.2 IPVLAN 命名由来<a class="headerlink" href="#5312-ipvlan" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">类型</th>
<th style="text-align: left;">区分方式</th>
<th style="text-align: left;">MAC 地址</th>
<th style="text-align: left;">IP 地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>IPVLAN</strong></td>
<td style="text-align: left;">IP 区分</td>
<td style="text-align: left;">相同</td>
<td style="text-align: left;">不同</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MACVLAN</strong></td>
<td style="text-align: left;">MAC 区分</td>
<td style="text-align: left;">不同</td>
<td style="text-align: left;">不同</td>
</tr>
</tbody>
</table>
<h4 id="5313">53.1.3 云环境适配<a class="headerlink" href="#5313" title="Permanent link">&para;</a></h4>
<p>IPVLAN 在 <strong>公有云/OpenStack</strong> 环境中特别适用：</p>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;OpenStack 安全机制&quot;
        Port[&quot;虚拟机端口&quot;]
        Security[&quot;安全组&lt;br/&gt;allow_address_pair&quot;]
        Check[&quot;MAC 地址校验&quot;]
    end

    Port --&gt; Security
    Security --&gt; Check

    subgraph &quot;IPVLAN 优势&quot;
        Same[&quot;子接口 MAC = 父接口 MAC&quot;]
        Pass[&quot;无需修改 allow_address_pair&quot;]
        Work[&quot;正常通信&quot;]
    end

    Same --&gt; Pass --&gt; Work
    Check -.-&gt;|&quot;不拦截&quot;| Same
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>云环境兼容性</strong></p>
<p>OpenStack 默认只允许与端口 MAC 匹配的流量通过。IPVLAN 由于 MAC 相同，无需额外配置即可正常工作。MACVLAN 则需要设置 <code>allow_address_pair</code> 为 <code>0.0.0.0/0</code>。</p>
</blockquote>
<h3 id="532-l2">53.2 L2 模式原理<a class="headerlink" href="#532-l2" title="Permanent link">&para;</a></h3>
<h4 id="5321-l2">53.2.1 L2 模式工作方式<a class="headerlink" href="#5321-l2" title="Permanent link">&para;</a></h4>
<p>在 L2 模式下，父接口相当于一个 <strong>虚拟交换机</strong>：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;节点 Node1&quot;
        eth0[&quot;父接口 eth0&lt;br/&gt;(虚拟交换机)&quot;]
        pod1[&quot;Pod1&lt;br/&gt;ipvl0&lt;br/&gt;172.18.0.200&quot;]
        pod2[&quot;Pod2&lt;br/&gt;ipvl1&lt;br/&gt;172.18.0.201&quot;]

        eth0 --&gt; pod1
        eth0 --&gt; pod2
    end

    subgraph &quot;节点 Node2&quot;
        eth0_2[&quot;父接口 eth0&lt;br/&gt;(虚拟交换机)&quot;]
        pod3[&quot;Pod3&lt;br/&gt;ipvl0&lt;br/&gt;172.18.0.202&quot;]

        eth0_2 --&gt; pod3
    end

    eth0 &lt;--&gt;|&quot;二层交换&quot;| eth0_2
</code></pre></div>
<h4 id="5322-l2-vs-l3">53.2.2 L2 vs L3 模式<a class="headerlink" href="#5322-l2-vs-l3" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">L2 模式</th>
<th style="text-align: left;">L3 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">工作层级</td>
<td style="text-align: left;">二层（交换）</td>
<td style="text-align: left;">三层（路由）</td>
</tr>
<tr>
<td style="text-align: left;">父接口角色</td>
<td style="text-align: left;">虚拟交换机</td>
<td style="text-align: left;">虚拟路由器</td>
</tr>
<tr>
<td style="text-align: left;">广播域</td>
<td style="text-align: left;">共享</td>
<td style="text-align: left;">隔离</td>
</tr>
<tr>
<td style="text-align: left;">适用场景</td>
<td style="text-align: left;">同子网通信</td>
<td style="text-align: left;">跨子网通信</td>
</tr>
</tbody>
</table>
<h3 id="533">53.3 配置实现<a class="headerlink" href="#533" title="Permanent link">&para;</a></h3>
<h4 id="5331-networkattachmentdefinition">53.3.1 NetworkAttachmentDefinition<a class="headerlink" href="#5331-networkattachmentdefinition" title="Permanent link">&para;</a></h4>
<p>创建 IPVLAN L2 模式的 NAD：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-l2-whereabouts-conf</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;ipvlan-l2-whereabouts&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;ipvlan&quot;,</span>
<span class="w">    </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth0&quot;,</span>
<span class="w">    </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;l2&quot;,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">      </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;172.18.0.200/24&quot;,</span>
<span class="w">      </span><span class="s">&quot;range_start&quot;:</span><span class="nv"> </span><span class="s">&quot;172.18.0.200&quot;,</span>
<span class="w">      </span><span class="s">&quot;range_end&quot;:</span><span class="nv"> </span><span class="s">&quot;172.18.0.205&quot;</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<h4 id="5332-nad">53.3.2 NAD 配置解析<a class="headerlink" href="#5332-nad" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;网络配置&quot;
        type[&quot;type: ipvlan&lt;br/&gt;网络类型&quot;]
        master[&quot;master: eth0&lt;br/&gt;父接口&quot;]
        mode[&quot;mode: l2&lt;br/&gt;L2 模式&quot;]
    end

    subgraph &quot;IPAM 配置&quot;
        ipam_type[&quot;type: whereabouts&lt;br/&gt;集群级 IPAM&quot;]
        range[&quot;range: 172.18.0.200/24&lt;br/&gt;地址范围&quot;]
    end

    type --&gt; master --&gt; mode
    ipam_type --&gt; range
</code></pre></div>
<h4 id="5333-pod">53.3.3 Pod 配置<a class="headerlink" href="#5333-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-pod1</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-l2-whereabouts-conf@eth1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;3600&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h4 id="5334">53.3.4 注解语法<a class="headerlink" href="#5334" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    A[&quot;k8s.v1.cni.cncf.io/networks&quot;] --&gt; B[&quot;NAD 名称&quot;]
    B --&gt; C[&quot;@&quot;]
    C --&gt; D[&quot;接口名称&lt;br/&gt;(可选)&quot;]

    E[&quot;示例&quot;] --&gt; F[&quot;ipvlan-l2-conf@eth1&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">语法</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>nad-name</code></td>
<td style="text-align: left;">使用默认接口名（net0, net1...）</td>
</tr>
<tr>
<td style="text-align: left;"><code>nad-name@eth1</code></td>
<td style="text-align: left;">指定接口名为 eth1</td>
</tr>
</tbody>
</table>
<h3 id="534">53.4 通信验证<a class="headerlink" href="#534" title="Permanent link">&para;</a></h3>
<h4 id="5341-mac">53.4.1 验证 MAC 地址<a class="headerlink" href="#5341-mac" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看节点 eth0 的 MAC</span>
ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>eth0
<span class="c1"># 输出: link/ether 02:42:ac:12:00:02</span>

<span class="c1"># 进入 Pod 查看 eth1 的 MAC</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ipvlan-pod1<span class="w"> </span>--<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>eth1
<span class="c1"># 输出: link/ether 02:42:ac:12:00:02  (与父接口相同)</span>
</code></pre></div>
<h4 id="5342">53.4.2 同节点通信<a class="headerlink" href="#5342" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod1 ping Pod2 (同节点)</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ipvlan-pod1<span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span>-I<span class="w"> </span>eth1<span class="w"> </span><span class="m">172</span>.18.0.201
</code></pre></div>
<h4 id="5343">53.4.3 跨节点通信<a class="headerlink" href="#5343" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod1 ping Pod3 (跨节点)</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ipvlan-pod1<span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span>-I<span class="w"> </span>eth1<span class="w"> </span><span class="m">172</span>.18.0.202
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>多网卡环境下的 ping 命令</strong></p>
<p>在多网卡环境中，务必使用 <code>-I &lt;interface&gt;</code> 指定源接口，否则可能走错网络路径。</p>
</blockquote>
<h4 id="5344-arp">53.4.4 ARP 表验证<a class="headerlink" href="#5344-arp" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 ARP 表</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ipvlan-pod1<span class="w"> </span>--<span class="w"> </span>arp<span class="w"> </span>-n

<span class="c1"># 同节点 Pod：MAC 相同</span>
<span class="c1"># 172.18.0.201  02:42:ac:12:00:02</span>

<span class="c1"># 跨节点 Pod：MAC 为对端节点的父接口</span>
<span class="c1"># 172.18.0.202  02:42:ac:12:00:03</span>
</code></pre></div>
<h3 id="535-ipvlan-vs-macvlan">53.5 IPVLAN vs MACVLAN<a class="headerlink" href="#535-ipvlan-vs-macvlan" title="Permanent link">&para;</a></h3>
<h4 id="5351">53.5.1 对比总结<a class="headerlink" href="#5351" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;MACVLAN&quot;
        M_Parent[&quot;父接口&lt;br/&gt;MAC: aa:bb:cc:dd&quot;]
        M_Sub1[&quot;子接口&lt;br/&gt;MAC: 11:22:33:44&quot;]
        M_Sub2[&quot;子接口&lt;br/&gt;MAC: 55:66:77:88&quot;]
        M_Parent --&gt; M_Sub1
        M_Parent --&gt; M_Sub2
    end

    subgraph &quot;IPVLAN&quot;
        I_Parent[&quot;父接口&lt;br/&gt;MAC: aa:bb:cc:dd&quot;]
        I_Sub1[&quot;子接口&lt;br/&gt;MAC: aa:bb:cc:dd&quot;]
        I_Sub2[&quot;子接口&lt;br/&gt;MAC: aa:bb:cc:dd&quot;]
        I_Parent --&gt; I_Sub1
        I_Parent --&gt; I_Sub2
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">MACVLAN</th>
<th style="text-align: left;">IPVLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">MAC 地址</td>
<td style="text-align: left;">子接口独立</td>
<td style="text-align: left;">子接口相同</td>
</tr>
<tr>
<td style="text-align: left;">云环境</td>
<td style="text-align: left;">可能被拦截</td>
<td style="text-align: left;">✅ 兼容</td>
</tr>
<tr>
<td style="text-align: left;">适用场景</td>
<td style="text-align: left;">裸机环境</td>
<td style="text-align: left;">云/虚拟化环境</td>
</tr>
<tr>
<td style="text-align: left;">内核要求</td>
<td style="text-align: left;">3.x+</td>
<td style="text-align: left;">4.18+</td>
</tr>
<tr>
<td style="text-align: left;">区分方式</td>
<td style="text-align: left;">MAC</td>
<td style="text-align: left;">IP</td>
</tr>
</tbody>
</table>
<h3 id="536">53.6 章节小结<a class="headerlink" href="#536" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((IPVLAN L2 模式))
    核心特性
      MAC 相同
      IP 区分
      内核 4.18+
    适用场景
      公有云
      OpenStack
      虚拟化环境
    L2 模式
      二层交换
      父接口=交换机
      同子网通信
    配置
      NAD 定义
      type=ipvlan
      mode=l2
      master=父接口
    验证
      MAC 检查
      ARP 表
      指定源接口 ping
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>IPVLAN L2 模式要点总结</strong>：</p>
<ol>
<li><strong>核心特性</strong>：</li>
<li>子接口与父接口 <strong>MAC 地址相同</strong></li>
<li>
<p>通过 <strong>IP 地址</strong> 区分不同子接口</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
</li>
<li><strong>云环境</strong>（OpenStack、公有云）</li>
<li>
<p>避免 MAC 地址被安全策略拦截</p>
</li>
<li>
<p><strong>L2 模式</strong>：</p>
</li>
<li>父接口充当 <strong>虚拟交换机</strong></li>
<li>
<p>子接口在同一广播域</p>
</li>
<li>
<p><strong>配置要点</strong>：</p>
</li>
<li><code>type: ipvlan</code></li>
<li><code>mode: l2</code></li>
<li>
<p><code>master: eth0</code>（父接口）</p>
</li>
<li>
<p><strong>注意事项</strong>：</p>
</li>
<li>多网卡环境下 ping 需指定 <code>-I &lt;interface&gt;</code></li>
<li>内核版本要求 <strong>Linux 4.18+</strong></li>
</ol>
</blockquote>
<hr />
<h2 id="multus-ipvlan-l3">第五十四章 Multus IPVLAN L3 模式<a class="headerlink" href="#multus-ipvlan-l3" title="Permanent link">&para;</a></h2>
<p>本章讲解 IPVLAN L3 模式的工作原理、配置方法、回程路由设置，以及与 L2 模式的区别。</p>
<h3 id="541">54.1 背景与概述<a class="headerlink" href="#541" title="Permanent link">&para;</a></h3>
<h4 id="5411-l3">54.1.1 L3 模式简介<a class="headerlink" href="#5411-l3" title="Permanent link">&para;</a></h4>
<p>在 L3 模式下，父接口充当 <strong>虚拟路由器</strong>，子接口可以配置 <strong>不同子网</strong> 的 IP 地址。</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;L3 模式架构&quot;
        Parent[&quot;父接口 eth0&lt;br/&gt;(虚拟路由器)&quot;]
        Sub1[&quot;子接口 ipvl0&lt;br/&gt;15.1.1.10/24&quot;]
        Sub2[&quot;子接口 ipvl1&lt;br/&gt;15.1.2.20/24&quot;]

        Parent --&gt; Sub1
        Parent --&gt; Sub2
    end
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>L3 模式核心特性</strong></p>
<ul>
<li>父接口充当 <strong>路由器</strong>（L2 模式是交换机）</li>
<li>子接口可配置 <strong>不同子网</strong> 的地址</li>
<li>需要添加 <strong>回程路由</strong> 实现跨子网通信</li>
</ul>
</blockquote>
<h4 id="5412-l2-vs-l3">54.1.2 L2 vs L3 模式对比<a class="headerlink" href="#5412-l2-vs-l3" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">L2 模式</th>
<th style="text-align: left;">L3 模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">父接口角色</td>
<td style="text-align: left;">虚拟交换机</td>
<td style="text-align: left;">虚拟路由器</td>
</tr>
<tr>
<td style="text-align: left;">子接口子网</td>
<td style="text-align: left;">必须相同</td>
<td style="text-align: left;">可以不同</td>
</tr>
<tr>
<td style="text-align: left;">通信方式</td>
<td style="text-align: left;">二层交换</td>
<td style="text-align: left;">三层路由</td>
</tr>
<tr>
<td style="text-align: left;">广播域</td>
<td style="text-align: left;">共享</td>
<td style="text-align: left;">隔离</td>
</tr>
<tr>
<td style="text-align: left;">路由配置</td>
<td style="text-align: left;">无需</td>
<td style="text-align: left;">需要回程路由</td>
</tr>
</tbody>
</table>
<h3 id="542-l3">54.2 L3 模式原理<a class="headerlink" href="#542-l3" title="Permanent link">&para;</a></h3>
<h4 id="5421">54.2.1 工作方式<a class="headerlink" href="#5421" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;节点 Node1&quot;
        eth0[&quot;父接口 eth0&lt;br/&gt;(路由器)&quot;]
        pod1[&quot;Pod1&lt;br/&gt;15.1.1.10/24&quot;]
        pod2[&quot;Pod2&lt;br/&gt;15.1.2.20/24&quot;]

        eth0 --&gt; pod1
        eth0 --&gt; pod2

        pod1 -.-&gt;|&quot;回程路由&quot;| pod2
    end
</code></pre></div>
<h4 id="5422">54.2.2 路由查找过程<a class="headerlink" href="#5422" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1&lt;br/&gt;15.1.1.10
    participant Router as 父接口&lt;br/&gt;(路由器)
    participant Pod2 as Pod2&lt;br/&gt;15.1.2.20

    Pod1-&gt;&gt;Pod1: 查路由表
    Note over Pod1: 目的: 15.1.2.20
    Pod1-&gt;&gt;Router: 从 eth1 出接口发出
    Router-&gt;&gt;Router: 三层路由转发
    Router-&gt;&gt;Pod2: 送达目的 Pod
</code></pre></div>
<h4 id="5423">54.2.3 无网关路由<a class="headerlink" href="#5423" title="Permanent link">&para;</a></h4>
<p>L3 模式的一个关键特性是 <strong>无网关路由</strong>（仅指定出接口）：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 传统路由（带网关）</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">15</span>.1.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">15</span>.1.1.1<span class="w"> </span>dev<span class="w"> </span>eth1

<span class="c1"># 无网关路由（仅出接口）</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">15</span>.1.2.0/24<span class="w"> </span>dev<span class="w"> </span>eth1
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>无网关路由原理</strong></p>
<p>当出接口直连路由器时，只需指定出接口，无需指定下一跳网关。数据包从出接口发出后，直接到达路由器进行转发。</p>
</blockquote>
<h3 id="543">54.3 配置实现<a class="headerlink" href="#543" title="Permanent link">&para;</a></h3>
<h4 id="5431-networkattachmentdefinition">54.3.1 NetworkAttachmentDefinition<a class="headerlink" href="#5431-networkattachmentdefinition" title="Permanent link">&para;</a></h4>
<p>创建 IPVLAN L3 模式的 NAD：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-l3-conf-1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;ipvlan-l3-net1&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;ipvlan&quot;,</span>
<span class="w">    </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth0&quot;,</span>
<span class="w">    </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;l3&quot;,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">      </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;15.1.1.0/24&quot;,</span>
<span class="w">      </span><span class="s">&quot;range_start&quot;:</span><span class="nv"> </span><span class="s">&quot;15.1.1.10&quot;,</span>
<span class="w">      </span><span class="s">&quot;range_end&quot;:</span><span class="nv"> </span><span class="s">&quot;15.1.1.20&quot;</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">  </span><span class="s">}&#39;</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-l3-conf-2</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;ipvlan-l3-net2&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;ipvlan&quot;,</span>
<span class="w">    </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth0&quot;,</span>
<span class="w">    </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;l3&quot;,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">      </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;15.1.2.0/24&quot;,</span>
<span class="w">      </span><span class="s">&quot;range_start&quot;:</span><span class="nv"> </span><span class="s">&quot;15.1.2.10&quot;,</span>
<span class="w">      </span><span class="s">&quot;range_end&quot;:</span><span class="nv"> </span><span class="s">&quot;15.1.2.20&quot;</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<h4 id="5432">54.3.2 配置要点<a class="headerlink" href="#5432" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;L3 模式配置&quot;
        mode[&quot;mode: l3&lt;br/&gt;三层模式&quot;]
        net1[&quot;NAD-1: 15.1.1.0/24&quot;]
        net2[&quot;NAD-2: 15.1.2.0/24&quot;]
    end

    mode --&gt; net1
    mode --&gt; net2
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">配置项</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>mode: l3</code></td>
<td style="text-align: left;">启用 L3 路由模式</td>
</tr>
<tr>
<td style="text-align: left;">不同 NAD</td>
<td style="text-align: left;">配置不同子网</td>
</tr>
<tr>
<td style="text-align: left;">同一 master</td>
<td style="text-align: left;">共享父接口</td>
</tr>
</tbody>
</table>
<h4 id="5433-pod">54.3.3 Pod 配置<a class="headerlink" href="#5433-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-l3-pod1</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-l3-conf-1@eth1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span><span class="w">  </span><span class="c1"># 确保同节点</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;3600&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-l3-pod2</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-l3-conf-2@eth1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span><span class="w">  </span><span class="c1"># 确保同节点</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;3600&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h3 id="544">54.4 回程路由配置<a class="headerlink" href="#544" title="Permanent link">&para;</a></h3>
<h4 id="5441">54.4.1 为什么需要回程路由<a class="headerlink" href="#5441" title="Permanent link">&para;</a></h4>
<p>默认情况下，Pod 只知道自己所在子网的路由：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod1 (15.1.1.10) 默认路由表</span>
<span class="m">15</span>.1.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth1<span class="w">  </span><span class="c1"># 只知道本子网</span>

<span class="c1"># Pod2 (15.1.2.20) 默认路由表</span>
<span class="m">15</span>.1.2.0/24<span class="w"> </span>dev<span class="w"> </span>eth1<span class="w">  </span><span class="c1"># 只知道本子网</span>
</code></pre></div>
<p>Pod1 无法直接访问 Pod2，因为没有去往 <code>15.1.2.0/24</code> 的路由。</p>
<h4 id="5442">54.4.2 添加回程路由<a class="headerlink" href="#5442" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 Pod1 中添加去往 Pod2 子网的路由</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ipvlan-l3-pod1<span class="w"> </span>--<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">15</span>.1.2.0/24<span class="w"> </span>dev<span class="w"> </span>eth1

<span class="c1"># 在 Pod2 中添加去往 Pod1 子网的路由</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ipvlan-l3-pod2<span class="w"> </span>--<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">15</span>.1.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth1
</code></pre></div>
<h4 id="5443">54.4.3 验证通信<a class="headerlink" href="#5443" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod1 ping Pod2（需指定源接口）</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ipvlan-l3-pod1<span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span>-I<span class="w"> </span>eth1<span class="w"> </span><span class="m">15</span>.1.2.20
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>关键注意事项</strong></p>
<ol>
<li>必须使用 <code>-I eth1</code> 指定源接口</li>
<li>L3 模式需要 <strong>手动添加回程路由</strong></li>
<li><strong>同节点</strong> 才可通过回程路由互通</li>
</ol>
</blockquote>
<h3 id="545-vs">54.5 同节点 vs 跨节点<a class="headerlink" href="#545-vs" title="Permanent link">&para;</a></h3>
<h4 id="5451">54.5.1 限制说明<a class="headerlink" href="#5451" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;同节点 ✅&quot;
        N1_eth0[&quot;Node1 eth0&lt;br/&gt;(共享路由器)&quot;]
        N1_Pod1[&quot;Pod1&lt;br/&gt;15.1.1.10&quot;]
        N1_Pod2[&quot;Pod2&lt;br/&gt;15.1.2.20&quot;]

        N1_eth0 --&gt; N1_Pod1
        N1_eth0 --&gt; N1_Pod2
        N1_Pod1 &lt;--&gt;|&quot;回程路由&quot;| N1_Pod2
    end

    subgraph &quot;跨节点 ❌&quot;
        N2_eth0[&quot;Node2 eth0&lt;br/&gt;(独立路由器)&quot;]
        N2_Pod3[&quot;Pod3&lt;br/&gt;15.1.3.30&quot;]

        N2_eth0 --&gt; N2_Pod3
    end

    N1_Pod1 -.-&gt;|&quot;无法通信&quot;| N2_Pod3
</code></pre></div>
<blockquote>
<p>[!CAUTION]
<strong>跨节点限制</strong></p>
<p>L3 模式下，不同节点的 Pod <strong>无法直接通过回程路由通信</strong>，因为：</p>
<ul>
<li>每个节点的父接口是独立的路由器</li>
<li>没有统一的路由平面</li>
</ul>
<p>如需跨节点通信，需要额外的 <strong>Underlay 网络</strong> 或 <strong>BGP 路由宣告</strong>。</p>
</blockquote>
<h4 id="5452">54.5.2 适用场景<a class="headerlink" href="#5452" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">是否支持</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">同节点不同子网 Pod</td>
<td style="text-align: left;">✅ 支持（需回程路由）</td>
</tr>
<tr>
<td style="text-align: left;">跨节点不同子网 Pod</td>
<td style="text-align: left;">❌ 不支持（需额外配置）</td>
</tr>
<tr>
<td style="text-align: left;">同节点同子网 Pod</td>
<td style="text-align: left;">✅ 支持（使用 L2 模式更佳）</td>
</tr>
</tbody>
</table>
<h3 id="546">54.6 章节小结<a class="headerlink" href="#546" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((IPVLAN L3 模式))
    核心特性
      父接口=路由器
      子接口可跨子网
      需回程路由
    配置要点
      mode=l3
      不同 NAD 不同子网
      同一 master
    回程路由
      ip route add
      仅出接口即可
      无需指定网关
    限制
      仅同节点有效
      跨节点不通
      需额外 Underlay
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>IPVLAN L3 模式要点总结</strong>：</p>
<ol>
<li><strong>核心原理</strong>：</li>
<li>父接口充当 <strong>虚拟路由器</strong></li>
<li>
<p>子接口可配置 <strong>不同子网</strong> IP</p>
</li>
<li>
<p><strong>回程路由</strong>：</p>
</li>
<li>必须手动添加 <code>ip route add &lt;对端子网&gt; dev eth1</code></li>
<li>
<p>无需指定网关，仅需出接口</p>
</li>
<li>
<p><strong>限制</strong>：</p>
</li>
<li>仅 <strong>同节点</strong> Pod 可通过回程路由通信</li>
<li>
<p>跨节点需要额外网络配置</p>
</li>
<li>
<p><strong>与 L2 对比</strong>：</p>
</li>
<li>L2：交换机，同子网</li>
<li>L3：路由器，跨子网</li>
</ol>
</blockquote>
<hr />
<h2 id="multus-ipvlan-sbr">第五十五章 Multus IPVLAN SBR 模式<a class="headerlink" href="#multus-ipvlan-sbr" title="Permanent link">&para;</a></h2>
<p>本章讲解 IPVLAN 的 SBR（Source-Based Routing，源地址路由）模式，实现多网卡同时访问外网的场景。</p>
<h3 id="551">55.1 背景与概述<a class="headerlink" href="#551" title="Permanent link">&para;</a></h3>
<h4 id="5511-sbr">55.1.1 什么是 SBR<a class="headerlink" href="#5511-sbr" title="Permanent link">&para;</a></h4>
<p><strong>SBR（Source-Based Routing）</strong> 是一种基于 <strong>源地址</strong> 进行路由决策的技术，也称为"原地路由"或"策略路由"。</p>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;传统路由&quot;
        Dst[&quot;基于目的地址&quot;]
    end

    subgraph &quot;SBR 路由&quot;
        Src[&quot;基于源地址&quot;]
    end

    Dst --&gt; D1[&quot;所有流量走默认网关&quot;]
    Src --&gt; S1[&quot;不同源地址走不同网关&quot;]
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>SBR 核心价值</strong></p>
<ul>
<li>允许 Pod 拥有 <strong>多张网卡同时访问外网</strong></li>
<li>根据 <strong>源 IP</strong> 决定出口路由</li>
<li>适用于 <strong>多网络接入</strong> 场景</li>
</ul>
</blockquote>
<h4 id="5512">55.1.2 应用场景<a class="headerlink" href="#5512" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">多网卡上网</td>
<td style="text-align: left;">不同网卡走不同出口</td>
</tr>
<tr>
<td style="text-align: left;">网络隔离</td>
<td style="text-align: left;">内网/外网分离访问</td>
</tr>
<tr>
<td style="text-align: left;">流量分流</td>
<td style="text-align: left;">按源地址分配带宽</td>
</tr>
</tbody>
</table>
<h3 id="552-sbr">55.2 SBR 原理<a class="headerlink" href="#552-sbr" title="Permanent link">&para;</a></h3>
<h4 id="5521">55.2.1 核心组件<a class="headerlink" href="#5521" title="Permanent link">&para;</a></h4>
<p>SBR 依赖 Linux 的 <strong>策略路由</strong> 机制，包含两个关键组件：</p>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;SBR 组件&quot;
        Rule[&quot;ip rule&lt;br/&gt;路由策略&quot;]
        Table[&quot;ip route table&lt;br/&gt;路由表&quot;]
    end

    Rule --&gt; Table
    Table --&gt; GW[&quot;网关出口&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">组件</th>
<th style="text-align: left;">命令</th>
<th style="text-align: left;">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">ip rule</td>
<td style="text-align: left;"><code>ip rule add from &lt;src&gt; table &lt;n&gt;</code></td>
<td style="text-align: left;">定义策略：源地址 → 路由表</td>
</tr>
<tr>
<td style="text-align: left;">ip route table</td>
<td style="text-align: left;"><code>ip route add default via &lt;gw&gt; table &lt;n&gt;</code></td>
<td style="text-align: left;">定义路由表内容</td>
</tr>
</tbody>
</table>
<h4 id="5522">55.2.2 工作流程<a class="headerlink" href="#5522" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod as Pod&lt;br/&gt;172.18.0.200
    participant Rule as ip rule
    participant Table as table 100
    participant GW as 网关&lt;br/&gt;172.18.0.1

    Pod-&gt;&gt;Rule: 发包 src=172.18.0.200
    Rule-&gt;&gt;Rule: 匹配 from 172.18.0.0/24
    Rule-&gt;&gt;Table: 查询 table 100
    Table-&gt;&gt;Table: default via 172.18.0.1
    Table-&gt;&gt;GW: 发送到网关
    GW-&gt;&gt;Pod: SNAT 后访问外网
</code></pre></div>
<h4 id="5523">55.2.3 优先级机制<a class="headerlink" href="#5523" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;路由查找顺序&quot;
        Step1[&quot;1. 检查 ip rule&quot;]
        Step2[&quot;2. SBR 匹配则走对应 table&quot;]
        Step3[&quot;3. 否则走默认路由表 main&quot;]
    end

    Step1 --&gt; Step2
    Step2 --&gt; Step3
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>SBR 优先级更高</strong></p>
<p>当配置了 SBR 后，即使目的地址在 <strong>同一子网</strong>，也会优先走 SBR 指定的网关，而非直接二层通信。</p>
</blockquote>
<h3 id="553">55.3 配置实现<a class="headerlink" href="#553" title="Permanent link">&para;</a></h3>
<h4 id="5531-sbr">55.3.1 手动配置 SBR<a class="headerlink" href="#5531-sbr" title="Permanent link">&para;</a></h4>
<p>在 Pod 内手动添加 SBR 规则：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 添加路由表（table 100）</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">172</span>.18.0.1<span class="w"> </span>dev<span class="w"> </span>eth1<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>

<span class="c1"># 2. 添加路由策略（从 172.18.0.0/24 来的包走 table 100）</span>
ip<span class="w"> </span>rule<span class="w"> </span>add<span class="w"> </span>from<span class="w"> </span><span class="m">172</span>.18.0.0/24<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>
</code></pre></div>
<p>验证配置：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看路由策略</span>
ip<span class="w"> </span>rule<span class="w"> </span>show
<span class="c1"># 输出: from 172.18.0.0/24 lookup 100</span>

<span class="c1"># 查看路由表</span>
ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>
<span class="c1"># 输出: default via 172.18.0.1 dev eth1</span>
</code></pre></div>
<h4 id="5532-nad-sbr">55.3.2 NAD 自动配置 SBR<a class="headerlink" href="#5532-nad-sbr" title="Permanent link">&para;</a></h4>
<p>通过 NetworkAttachmentDefinition 自动配置 SBR：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipvlan-sbr</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;ipvlan-sbr-net&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;ipvlan&quot;,</span>
<span class="w">    </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth0&quot;,</span>
<span class="w">    </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;l2&quot;,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">      </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;172.18.0.0/24&quot;</span>
<span class="w">    </span><span class="s">},</span>
<span class="w">    </span><span class="s">&quot;plugins&quot;:</span><span class="nv"> </span><span class="s">[</span>
<span class="w">      </span><span class="s">{</span>
<span class="w">        </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;sbr&quot;</span>
<span class="w">      </span><span class="s">}</span>
<span class="w">    </span><span class="s">]</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<h4 id="5533">55.3.3 配置对比<a class="headerlink" href="#5533" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;手动配置&quot;
        M1[&quot;ip route add&quot;]
        M2[&quot;ip rule add&quot;]
    end

    subgraph &quot;自动配置(NAD)&quot;
        A1[&quot;plugins: sbr&quot;]
    end

    M1 --&gt; Result[&quot;Pod 多网卡上外网&quot;]
    M2 --&gt; Result
    A1 --&gt; Result
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">方式</th>
<th style="text-align: left;">优点</th>
<th style="text-align: left;">缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">手动配置</td>
<td style="text-align: left;">灵活可控</td>
<td style="text-align: left;">需要 init 容器或手动执行</td>
</tr>
<tr>
<td style="text-align: left;">NAD 自动</td>
<td style="text-align: left;">自动化，无需干预</td>
<td style="text-align: left;">需要 SBR CNI 插件支持</td>
</tr>
</tbody>
</table>
<h3 id="554">55.4 多网卡上外网验证<a class="headerlink" href="#554" title="Permanent link">&para;</a></h3>
<h4 id="5541">55.4.1 场景说明<a class="headerlink" href="#5541" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Pod&quot;
        eth0[&quot;eth0&lt;br/&gt;默认网卡&quot;]
        eth1[&quot;eth1&lt;br/&gt;IPVLAN 网卡&quot;]
    end

    subgraph &quot;网关&quot;
        GW0[&quot;默认网关&quot;]
        GW1[&quot;IPVLAN 网关&lt;br/&gt;172.18.0.1&quot;]
    end

    eth0 --&gt; GW0
    eth1 --&gt; GW1

    GW0 --&gt; Internet[&quot;互联网&quot;]
    GW1 --&gt; Internet
</code></pre></div>
<h4 id="5542">55.4.2 验证步骤<a class="headerlink" href="#5542" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 从 eth0 访问外网（默认路由）</span>
ping<span class="w"> </span><span class="m">114</span>.114.114.114

<span class="c1"># 2. 从 eth1 访问外网（SBR 路由）</span>
ping<span class="w"> </span>-I<span class="w"> </span><span class="m">172</span>.18.0.200<span class="w"> </span><span class="m">114</span>.114.114.114

<span class="c1"># 3. 抓包验证</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth1<span class="w"> </span>icmp
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>指定源地址的重要性</strong></p>
<p>使用 <code>ping -I &lt;IP地址&gt;</code> 而非 <code>ping -I &lt;接口名&gt;</code>，确保 SBR 规则正确匹配。</p>
</blockquote>
<h4 id="5543">55.4.3 抓包分析<a class="headerlink" href="#5543" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 eth1 上抓包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth1<span class="w"> </span>-n<span class="w"> </span>icmp

<span class="c1"># 预期输出（走 SBR）：</span>
<span class="c1"># 172.18.0.200 &gt; 114.114.114.114: ICMP echo request</span>
<span class="c1"># 114.114.114.114 &gt; 172.18.0.200: ICMP echo reply</span>
</code></pre></div>
<h3 id="555-sbr-arp">55.5 SBR 与 ARP 缓存交互<a class="headerlink" href="#555-sbr-arp" title="Permanent link">&para;</a></h3>
<h4 id="5551">55.5.1 首包行为<a class="headerlink" href="#5551" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1&lt;br/&gt;172.18.0.200
    participant SBR as SBR 规则
    participant GW as 网关&lt;br/&gt;172.18.0.1
    participant Pod2 as Pod2&lt;br/&gt;172.18.0.201

    Note over Pod1: 无 ARP 缓存
    Pod1-&gt;&gt;SBR: 发包 dst=172.18.0.201
    SBR-&gt;&gt;GW: 优先走网关
    GW-&gt;&gt;Pod2: 转发
    Pod2-&gt;&gt;Pod1: 回包（携带真实 MAC）
    Note over Pod1: 学习到 Pod2 MAC
</code></pre></div>
<h4 id="5552">55.5.2 后续包行为<a class="headerlink" href="#5552" title="Permanent link">&para;</a></h4>
<p>当 ARP 缓存存在后，行为可能改变：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">情况</th>
<th style="text-align: left;">首包</th>
<th style="text-align: left;">后续包</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">无 ARP 缓存</td>
<td style="text-align: left;">走 SBR → 网关</td>
<td style="text-align: left;">走 SBR → 网关</td>
</tr>
<tr>
<td style="text-align: left;">有 ARP 缓存</td>
<td style="text-align: left;">走 SBR → 网关</td>
<td style="text-align: left;">可能直接二层（ARP 优先级更高）</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
<strong>ARP 缓存影响</strong></p>
<p>当 Pod 学习到对端的真实 MAC 地址后，后续包可能 <strong>绕过 SBR</strong> 直接走二层。这是因为：</p>
<ul>
<li>本地 ARP 缓存优先级高于 SBR</li>
<li>已知 MAC 时无需查询路由策略</li>
</ul>
<p><strong>清除 ARP 缓存验证</strong>：</p>
<div class="highlight"><pre><span></span><code>ip<span class="w"> </span>neigh<span class="w"> </span>del<span class="w"> </span><span class="m">172</span>.18.0.201<span class="w"> </span>dev<span class="w"> </span>eth1
</code></pre></div>
</blockquote>
<h4 id="5553-sbr">55.5.3 双端 SBR 配置<a class="headerlink" href="#5553-sbr" title="Permanent link">&para;</a></h4>
<p>当两端都配置 SBR 时：</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1&lt;br/&gt;172.18.0.200
    participant GW as 网关
    participant Pod2 as Pod2&lt;br/&gt;172.18.0.201

    Pod1-&gt;&gt;GW: SBR → 网关
    GW-&gt;&gt;Pod2: 转发
    Pod2-&gt;&gt;GW: SBR → 网关
    GW-&gt;&gt;Pod1: 转发
</code></pre></div>
<p>两端都会经过网关，确保 SBR 策略生效。</p>
<h3 id="556">55.6 章节小结<a class="headerlink" href="#556" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((IPVLAN SBR))
    核心概念
      Source-Based Routing
      基于源地址路由
      策略路由
    关键命令
      ip rule add
      ip route table
    配置方式
      手动配置
      NAD 自动配置
    应用场景
      多网卡上外网
      网络隔离
      流量分流
    注意事项
      SBR 优先级高
      ARP 缓存影响
      指定源 IP
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>IPVLAN SBR 模式要点总结</strong>：</p>
<ol>
<li><strong>SBR 机制</strong>：</li>
<li><code>ip rule</code>：定义源地址 → 路由表映射</li>
<li>
<p><code>ip route table</code>：定义路由表内容</p>
</li>
<li>
<p><strong>配置方式</strong>：</p>
</li>
<li>手动：<code>ip route add</code> + <code>ip rule add</code></li>
<li>
<p>自动：NAD 中 <code>plugins: [{"type": "sbr"}]</code></p>
</li>
<li>
<p><strong>验证方法</strong>：</p>
</li>
<li><code>ping -I &lt;源IP&gt;</code> 指定源地址</li>
<li>
<p><code>tcpdump -i eth1</code> 抓包确认</p>
</li>
<li>
<p><strong>注意事项</strong>：</p>
</li>
<li>SBR 优先级高于普通路由</li>
<li>ARP 缓存可能影响后续包路径</li>
<li>双端配置 SBR 可确保策略生效</li>
</ol>
</blockquote>
<hr />
<h2 id="ipvlan-sbr">第五十六章 IPVLAN-SBR 深度解析<a class="headerlink" href="#ipvlan-sbr" title="Permanent link">&para;</a></h2>
<p>本章深入分析 SBR 的底层行为机制，包括首包处理、ICMP Redirect、单边与双边 SBR 差异，以及典型应用场景。</p>
<h3 id="561">56.1 背景与问题<a class="headerlink" href="#561" title="Permanent link">&para;</a></h3>
<h4 id="5611">56.1.1 上章回顾<a class="headerlink" href="#5611" title="Permanent link">&para;</a></h4>
<p>上一章介绍了 SBR 的基本配置和使用，但在实际抓包分析中发现了一些 <strong>意外行为</strong>：</p>
<ul>
<li>首包发往网关，但后续包可能直接二层通信</li>
<li>存在 ICMP Redirect 消息</li>
<li>不同网络环境行为不同</li>
</ul>
<h4 id="5612">56.1.2 本章目标<a class="headerlink" href="#5612" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>mindmap
  root((SBR 深度解析))
    首包行为
      为什么走网关
      MAC 地址封装
    ICMP Redirect
      什么是重定向
      何时触发
    单边 vs 双边
      行为差异
      抓包分析
    环境差异
      Linux Bridge
      真实交换机
    应用场景
      多网卡多网关
      管理/业务分离
</code></pre></div>
<h3 id="562-sbr">56.2 SBR 首包行为分析<a class="headerlink" href="#562-sbr" title="Permanent link">&para;</a></h3>
<h4 id="5621">56.2.1 首包封装过程<a class="headerlink" href="#5621" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1&lt;br/&gt;172.18.0.200
    participant SBR as SBR 规则
    participant GW as 网关&lt;br/&gt;172.18.0.1
    participant Pod2 as Pod2&lt;br/&gt;172.18.0.201

    Note over Pod1: 查路由：dst=172.18.0.201
    Pod1-&gt;&gt;SBR: 匹配 from 172.18.0.0/24
    SBR-&gt;&gt;Pod1: 走 table 100 → via 172.18.0.1
    Pod1-&gt;&gt;Pod1: 发 ARP 请求网关 MAC
    Pod1-&gt;&gt;GW: 封装: dst_mac=网关MAC
    GW-&gt;&gt;Pod2: 转发到 Pod2
</code></pre></div>
<h4 id="5622">56.2.2 为什么首包走网关<a class="headerlink" href="#5622" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">阶段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">无 ARP 缓存</td>
<td style="text-align: left;">Pod1 不知道 Pod2 的 MAC</td>
</tr>
<tr>
<td style="text-align: left;">SBR 规则生效</td>
<td style="text-align: left;">指向 via 172.18.0.1</td>
</tr>
<tr>
<td style="text-align: left;">ARP 请求网关</td>
<td style="text-align: left;">而非请求 Pod2</td>
</tr>
<tr>
<td style="text-align: left;">封装网关 MAC</td>
<td style="text-align: left;">dst_mac = 网关 MAC</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>关键点</strong></p>
<p>SBR 规则指定了下一跳网关，因此 Pod1 会 <strong>ARP 解析网关的 MAC</strong>，而非目的 Pod 的 MAC。</p>
</blockquote>
<h4 id="5623">56.2.3 抓包验证<a class="headerlink" href="#5623" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Pod1 发送首包</span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>eth1<span class="w"> </span>-en

<span class="c1"># 首包内容：</span>
<span class="c1"># src_mac: 12:00:00:02 (Pod1)</span>
<span class="c1"># dst_mac: dc:cd:40:xx (网关)</span>
<span class="c1"># src_ip: 172.18.0.200</span>
<span class="c1"># dst_ip: 172.18.0.201</span>
</code></pre></div>
<h3 id="563-icmp-redirect">56.3 ICMP Redirect 机制<a class="headerlink" href="#563-icmp-redirect" title="Permanent link">&para;</a></h3>
<h4 id="5631-icmp-redirect">56.3.1 什么是 ICMP Redirect<a class="headerlink" href="#5631-icmp-redirect" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1
    participant GW as 网关
    participant Pod2 as Pod2

    Pod1-&gt;&gt;GW: ICMP Echo Request
    GW-&gt;&gt;Pod2: 转发
    GW--&gt;&gt;Pod1: ICMP Redirect
    Note over GW: 告诉 Pod1：以后直接发给 Pod2
    Pod2-&gt;&gt;Pod1: ICMP Echo Reply
</code></pre></div>
<p><strong>ICMP Redirect</strong>（重定向）是网关发送的一种通知消息：</p>
<blockquote>
<p>"你发给我的包，目的地和你在同一网段，你应该直接发给它，不需要经过我。"</p>
</blockquote>
<h4 id="5632-redirect">56.3.2 Redirect 消息格式<a class="headerlink" href="#5632-redirect" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>ICMP Type: 5 (Redirect)
Code: 1 (Redirect for Host)
Message: Redirect to 172.18.0.201
</code></pre></div>
<h4 id="5633-redirect">56.3.3 Redirect 触发条件<a class="headerlink" href="#5633-redirect" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">条件</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">源和目的同子网</td>
<td style="text-align: left;">172.18.0.200 ↔ 172.18.0.201</td>
</tr>
<tr>
<td style="text-align: left;">包经过网关</td>
<td style="text-align: left;">网关发现"绕路"</td>
</tr>
<tr>
<td style="text-align: left;">网关启用 Redirect</td>
<td style="text-align: left;">Linux Bridge 默认启用</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!WARNING]
<strong>ICMP Redirect 对 SBR 的影响</strong></p>
<p>收到 Redirect 后，Pod 可能 <strong>绕过 SBR 策略</strong>，直接二层通信。这可能不是期望的行为！</p>
</blockquote>
<h3 id="564-vs-sbr">56.4 单边 vs 双边 SBR<a class="headerlink" href="#564-vs-sbr" title="Permanent link">&para;</a></h3>
<h4 id="5641-sbr-pod1">56.4.1 单边 SBR（仅 Pod1 配置）<a class="headerlink" href="#5641-sbr-pod1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1&lt;br/&gt;有 SBR
    participant GW as 网关
    participant Pod2 as Pod2&lt;br/&gt;无 SBR

    Pod1-&gt;&gt;GW: ① 首包走网关
    GW-&gt;&gt;Pod2: 转发
    GW--&gt;&gt;Pod1: ② ICMP Redirect
    Pod2-&gt;&gt;Pod1: ③ 回包（直接二层）
    Note over Pod2: 发 ARP 请求 Pod1 MAC
    Note over Pod1: 后续包直接二层
</code></pre></div>
<p><strong>行为特点</strong>：</p>
<ul>
<li>首包：Pod1 → 网关 → Pod2</li>
<li>回包：Pod2 直接发给 Pod1（无 SBR）</li>
<li>后续：可能绕过 SBR</li>
</ul>
<h4 id="5642-sbr">56.4.2 双边 SBR（两端都配置）<a class="headerlink" href="#5642-sbr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1&lt;br/&gt;有 SBR
    participant GW as 网关
    participant Pod2 as Pod2&lt;br/&gt;有 SBR

    Pod1-&gt;&gt;GW: ① 首包走网关
    GW-&gt;&gt;Pod2: 转发
    GW--&gt;&gt;Pod1: ② Redirect #1
    Pod2-&gt;&gt;GW: ③ 回包也走网关
    GW-&gt;&gt;Pod1: 转发
    GW--&gt;&gt;Pod2: ④ Redirect #2
    Note over Pod1,Pod2: 两次 Redirect 后恢复直接通信
</code></pre></div>
<p><strong>行为特点</strong>：</p>
<ul>
<li>首包：双方都走网关</li>
<li>两次 Redirect：各触发一次</li>
<li>后续：恢复直接通信</li>
</ul>
<h4 id="5643">56.4.3 对比总结<a class="headerlink" href="#5643" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">首包路径</th>
<th style="text-align: left;">Redirect 次数</th>
<th style="text-align: left;">后续包路径</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">单边 SBR</td>
<td style="text-align: left;">Pod1→GW→Pod2</td>
<td style="text-align: left;">1 次</td>
<td style="text-align: left;">可能直接二层</td>
</tr>
<tr>
<td style="text-align: left;">双边 SBR</td>
<td style="text-align: left;">双方都走网关</td>
<td style="text-align: left;">2 次</td>
<td style="text-align: left;">恢复直接通信</td>
</tr>
</tbody>
</table>
<h3 id="565-linux-bridge-vs">56.5 Linux Bridge vs 真实交换机<a class="headerlink" href="#565-linux-bridge-vs" title="Permanent link">&para;</a></h3>
<h4 id="5651">56.5.1 行为差异<a class="headerlink" href="#5651" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Linux Bridge&quot;
        LB_GW[&quot;网关&quot;]
        LB_R[&quot;发送 ICMP Redirect&quot;]
        LB_D[&quot;后续包直接二层&quot;]

        LB_GW --&gt; LB_R
        LB_R --&gt; LB_D
    end

    subgraph &quot;真实交换机(H3C等)&quot;
        HW_GW[&quot;网关&quot;]
        HW_F[&quot;每包都转发&quot;]
        HW_N[&quot;无 Redirect&quot;]

        HW_GW --&gt; HW_F
        HW_F --&gt; HW_N
    end
</code></pre></div>
<h4 id="5652">56.5.2 差异对比<a class="headerlink" href="#5652" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">Linux Bridge</th>
<th style="text-align: left;">真实交换机（H3C）</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">ICMP Redirect</td>
<td style="text-align: left;">✅ 启用</td>
<td style="text-align: left;">❌ 通常不发</td>
</tr>
<tr>
<td style="text-align: left;">SBR 首包</td>
<td style="text-align: left;">走网关</td>
<td style="text-align: left;">走网关</td>
</tr>
<tr>
<td style="text-align: left;">SBR 后续包</td>
<td style="text-align: left;">可能绕过</td>
<td style="text-align: left;">始终走网关</td>
</tr>
<tr>
<td style="text-align: left;">行为一致性</td>
<td style="text-align: left;">可能变化</td>
<td style="text-align: left;">稳定可预期</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!CAUTION]
<strong>生产环境注意</strong></p>
<p>Linux Bridge 环境下的 SBR 行为可能与真实交换机不同。测试时需要在 <strong>目标生产环境</strong> 中验证！</p>
</blockquote>
<h3 id="566-sbr">56.6 SBR 典型应用场景<a class="headerlink" href="#566-sbr" title="Permanent link">&para;</a></h3>
<h4 id="5661">56.6.1 多网卡多网关<a class="headerlink" href="#5661" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Pod/虚拟机&quot;
        eth0[&quot;eth0&lt;br/&gt;管理网卡&quot;]
        eth1[&quot;eth1&lt;br/&gt;业务网卡&quot;]
    end

    subgraph &quot;网关&quot;
        GW0[&quot;管理网关&lt;br/&gt;10.0.0.1&quot;]
        GW1[&quot;业务网关&lt;br/&gt;192.168.0.1&quot;]
    end

    eth0 --&gt; GW0
    eth1 --&gt; GW1

    GW0 --&gt; OM[&quot;SSH/运维管理&quot;]
    GW1 --&gt; BIZ[&quot;业务流量&quot;]
</code></pre></div>
<h4 id="5662">56.6.2 问题：多网关冲突<a class="headerlink" href="#5662" title="Permanent link">&para;</a></h4>
<p><strong>场景</strong>：一台机器有两张网卡，只能配置一个默认路由。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 默认路由只能有一个出接口</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.0.1<span class="w"> </span>dev<span class="w"> </span>eth1

<span class="c1"># SSH 从 eth0 进来，回包却走 eth1</span>
<span class="c1"># 导致：非对称路由，连接失败！</span>
</code></pre></div>
<h4 id="5663-sbr">56.6.3 SBR 解决方案<a class="headerlink" href="#5663-sbr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. eth0（管理网）使用 SBR</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.0.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>
ip<span class="w"> </span>rule<span class="w"> </span>add<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.0.0/24<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>

<span class="c1"># 2. eth1（业务网）使用默认路由</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.0.1<span class="w"> </span>dev<span class="w"> </span>eth1
</code></pre></div>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;SBR 路由策略&quot;
        SSH[&quot;SSH 请求&lt;br/&gt;from 10.0.0.x&quot;]
        BIZ[&quot;业务请求&lt;br/&gt;from 192.168.x&quot;]
    end

    SSH --&gt; T100[&quot;table 100&quot;]
    BIZ --&gt; Main[&quot;default route&quot;]

    T100 --&gt; GW0[&quot;eth0 网关&quot;]
    Main --&gt; GW1[&quot;eth1 网关&quot;]
</code></pre></div>
<h4 id="5664">56.6.4 典型使用场景<a class="headerlink" href="#5664" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">eth0 (管理网)</th>
<th style="text-align: left;">eth1 (业务网)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">运维管理</td>
<td style="text-align: left;">SSH、监控</td>
<td style="text-align: left;">-</td>
</tr>
<tr>
<td style="text-align: left;">业务流量</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">应用数据</td>
</tr>
<tr>
<td style="text-align: left;">告警上报</td>
<td style="text-align: left;">SBR 路由</td>
<td style="text-align: left;">-</td>
</tr>
<tr>
<td style="text-align: left;">外网访问</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">默认路由</td>
</tr>
</tbody>
</table>
<h3 id="567">56.7 章节小结<a class="headerlink" href="#567" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((SBR 深度解析))
    首包行为
      SBR 优先
      ARP 解析网关
      封装网关 MAC
    ICMP Redirect
      网关发送
      通知直连
      可能绕过 SBR
    单边 vs 双边
      单边=1 次 Redirect
      双边=2 次 Redirect
      后续恢复直连
    环境差异
      Linux Bridge 有 Redirect
      真实交换机无 Redirect
    应用场景
      多网卡多网关
      管理/业务分离
      解决非对称路由
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>IPVLAN-SBR 深度解析要点总结</strong>：</p>
<ol>
<li><strong>首包行为</strong>：</li>
<li>SBR 优先于普通路由</li>
<li>
<p>首包 ARP 解析网关 MAC</p>
</li>
<li>
<p><strong>ICMP Redirect</strong>：</p>
</li>
<li>网关发现同子网绕路时发送</li>
<li>
<p>可能导致后续包绕过 SBR</p>
</li>
<li>
<p><strong>单边 vs 双边</strong>：</p>
</li>
<li>单边 SBR：1 次 Redirect</li>
<li>
<p>双边 SBR：2 次 Redirect</p>
</li>
<li>
<p><strong>环境差异</strong>：</p>
</li>
<li>Linux Bridge：有 Redirect</li>
<li>
<p>真实交换机：通常无 Redirect</p>
</li>
<li>
<p><strong>应用场景</strong>：</p>
</li>
<li>多网卡多网关</li>
<li>SSH 管理 + 业务分离</li>
<li>解决非对称路由问题</li>
</ol>
</blockquote>
<hr />
<h2 id="macvlan-sbr">第五十七章 MACVLAN-SBR 实践<a class="headerlink" href="#macvlan-sbr" title="Permanent link">&para;</a></h2>
<p>本章介绍 MACVLAN 与 SBR 结合的实践配置，包括 MACVLAN 与 IPVLAN 的差异、NAD 配置方法、以及生产级多网卡环境的搭建。</p>
<h3 id="571">57.1 背景与概述<a class="headerlink" href="#571" title="Permanent link">&para;</a></h3>
<h4 id="5711-macvlan-vs-ipvlan">57.1.1 MACVLAN vs IPVLAN 核心差异<a class="headerlink" href="#5711-macvlan-vs-ipvlan" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;MACVLAN&quot;
        MV_M[&quot;Master 接口&quot;]
        MV_S1[&quot;子接口1&lt;br/&gt;MAC: AA:BB:CC:01&quot;]
        MV_S2[&quot;子接口2&lt;br/&gt;MAC: AA:BB:CC:02&quot;]
        MV_M --&gt; MV_S1
        MV_M --&gt; MV_S2
    end

    subgraph &quot;IPVLAN&quot;
        IV_M[&quot;Master 接口&lt;br/&gt;MAC: AA:BB:CC:00&quot;]
        IV_S1[&quot;子接口1&lt;br/&gt;MAC: AA:BB:CC:00&quot;]
        IV_S2[&quot;子接口2&lt;br/&gt;MAC: AA:BB:CC:00&quot;]
        IV_M --&gt; IV_S1
        IV_M --&gt; IV_S2
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">MACVLAN</th>
<th style="text-align: left;">IPVLAN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">MAC 地址</td>
<td style="text-align: left;"><strong>各不相同</strong></td>
<td style="text-align: left;">共享父接口 MAC</td>
</tr>
<tr>
<td style="text-align: left;">内核支持</td>
<td style="text-align: left;">3.x 早期版本</td>
<td style="text-align: left;">4.x+</td>
</tr>
<tr>
<td style="text-align: left;">理解难度</td>
<td style="text-align: left;">简单（传统模式）</td>
<td style="text-align: left;">需理解共享 MAC</td>
</tr>
<tr>
<td style="text-align: left;">公有云兼容</td>
<td style="text-align: left;">可能受限（MAC 检查）</td>
<td style="text-align: left;">更友好</td>
</tr>
<tr>
<td style="text-align: left;">典型场景</td>
<td style="text-align: left;">传统网卡复用</td>
<td style="text-align: left;">云原生环境</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!NOTE]
<strong>关键区别</strong></p>
<ul>
<li>MACVLAN：每个子接口有 <strong>独立的 MAC 地址</strong></li>
<li>IPVLAN：所有子接口 <strong>共享父接口的 MAC 地址</strong></li>
</ul>
</blockquote>
<h4 id="5712-macvlan">57.1.2 MACVLAN 工作模式<a class="headerlink" href="#5712-macvlan" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">说明</th>
<th style="text-align: left;">使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>bridge</strong></td>
<td style="text-align: left;">子接口间可直接通信（最常用）</td>
<td style="text-align: left;">生产环境默认</td>
</tr>
<tr>
<td style="text-align: left;">private</td>
<td style="text-align: left;">子接口间完全隔离</td>
<td style="text-align: left;">安全隔离</td>
</tr>
<tr>
<td style="text-align: left;">vepa</td>
<td style="text-align: left;">流量必须经过外部交换机</td>
<td style="text-align: left;">硬件卸载</td>
</tr>
<tr>
<td style="text-align: left;">passthrough</td>
<td style="text-align: left;">直通模式</td>
<td style="text-align: left;">SR-IOV</td>
</tr>
</tbody>
</table>
<h3 id="572-macvlan">57.2 基础 MACVLAN 配置<a class="headerlink" href="#572-macvlan" title="Permanent link">&para;</a></h3>
<h4 id="5721-nad">57.2.1 NAD 配置示例<a class="headerlink" href="#5721-nad" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-basic</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;macvlan-net&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;macvlan&quot;,</span>
<span class="w">    </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth0&quot;,</span>
<span class="w">    </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;bridge&quot;,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">      </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;15.15.1.0/24&quot;</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<h4 id="5722">57.2.2 配置要点<a class="headerlink" href="#5722" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;NAD 配置&quot;
        type[&quot;type: macvlan&quot;]
        master[&quot;master: eth0&quot;]
        mode[&quot;mode: bridge&quot;]
    end

    type --&gt; |网卡复用类型| macvlan[&quot;MACVLAN&quot;]
    master --&gt; |父接口| eth0[&quot;物理/虚拟网卡&quot;]
    mode --&gt; |工作模式| bridge[&quot;Bridge 模式&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">type</td>
<td style="text-align: left;"><code>macvlan</code> - 网卡复用类型</td>
</tr>
<tr>
<td style="text-align: left;">master</td>
<td style="text-align: left;">父接口名称（复用哪张网卡）</td>
</tr>
<tr>
<td style="text-align: left;">mode</td>
<td style="text-align: left;">工作模式，通常用 <code>bridge</code></td>
</tr>
<tr>
<td style="text-align: left;">ipam</td>
<td style="text-align: left;">IP 地址管理，通常用 whereabouts</td>
</tr>
</tbody>
</table>
<h3 id="573-macvlan">57.3 MACVLAN 基础验证<a class="headerlink" href="#573-macvlan" title="Permanent link">&para;</a></h3>
<h4 id="5731-pod">57.3.1 创建测试 Pod<a class="headerlink" href="#5731-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-pod1</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-basic</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nicolaka/netshoot</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;infinity&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h4 id="5732">57.3.2 验证网络<a class="headerlink" href="#5732" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Pod 网卡</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>macvlan-pod1<span class="w"> </span>--<span class="w"> </span>ip<span class="w"> </span>a

<span class="c1"># 输出示例：</span>
<span class="c1"># eth1: &lt;BROADCAST,MULTICAST,UP&gt;</span>
<span class="c1">#   link/ether 2a:b7:78:7c:xx:xx</span>
<span class="c1">#   inet 15.15.1.20/24</span>

<span class="c1"># MACVLAN 的 MAC 地址与父接口不同！</span>
</code></pre></div>
<h4 id="5733">57.3.3 同网段通信验证<a class="headerlink" href="#5733" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod1 as Pod1&lt;br/&gt;15.15.1.20
    participant Pod2 as Pod2&lt;br/&gt;15.15.1.21

    Pod1-&gt;&gt;Pod1: ARP: 谁是 15.15.1.21?
    Pod2-&gt;&gt;Pod1: ARP Reply: 我是 2a:99:66:xx
    Pod1-&gt;&gt;Pod2: ICMP Echo Request
    Pod2-&gt;&gt;Pod1: ICMP Echo Reply
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>MACVLAN 同网段通信</strong></p>
<p>MACVLAN 子接口之间的通信走 <strong>二层直连</strong>，因为 MAC 地址不同，可以正常 ARP 解析。</p>
</blockquote>
<h3 id="574-macvlan-sbr">57.4 MACVLAN + SBR 高级配置<a class="headerlink" href="#574-macvlan-sbr" title="Permanent link">&para;</a></h3>
<h4 id="5741-sbr">57.4.1 为什么需要 SBR<a class="headerlink" href="#5741-sbr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;问题场景&quot;
        Pod[&quot;Pod&lt;br/&gt;eth0: 默认网卡&lt;br/&gt;eth1: MACVLAN&quot;]
        Default[&quot;默认路由 - eth0&quot;]
        External[&quot;外网 114.114.114.114&quot;]

        Pod --&gt; Default
        Default -.-&gt; |&quot;eth1 无法上外网&quot;| External
    end
</code></pre></div>
<p><strong>问题</strong>：MACVLAN 接口默认没有默认路由，无法访问外网。</p>
<p><strong>解决</strong>：使用 SBR 为 MACVLAN 接口添加专属路由表。</p>
<h4 id="5742-nad-sbr">57.4.2 NAD + SBR 插件配置<a class="headerlink" href="#5742-nad-sbr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-sbr</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;macvlan-sbr-net&quot;,</span>
<span class="w">    </span><span class="s">&quot;plugins&quot;:</span><span class="nv"> </span><span class="s">[</span>
<span class="w">      </span><span class="s">{</span>
<span class="w">        </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;macvlan&quot;,</span>
<span class="w">        </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth1&quot;,</span>
<span class="w">        </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;bridge&quot;,</span>
<span class="w">        </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">          </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">          </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;15.15.1.0/24&quot;,</span>
<span class="w">          </span><span class="s">&quot;gateway&quot;:</span><span class="nv"> </span><span class="s">&quot;15.15.1.1&quot;,</span>
<span class="w">          </span><span class="s">&quot;routes&quot;:</span><span class="nv"> </span><span class="s">[</span>
<span class="w">            </span><span class="s">{&quot;dst&quot;:</span><span class="nv"> </span><span class="s">&quot;0.0.0.0/0&quot;}</span>
<span class="w">          </span><span class="s">]</span>
<span class="w">        </span><span class="s">}</span>
<span class="w">      </span><span class="s">},</span>
<span class="w">      </span><span class="s">{</span>
<span class="w">        </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;sbr&quot;</span>
<span class="w">      </span><span class="s">}</span>
<span class="w">    </span><span class="s">]</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<h4 id="5743-plugins">57.4.3 plugins 链式配置<a class="headerlink" href="#5743-plugins" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;plugins 链式调用&quot;
        P1[&quot;Plugin 1&lt;br/&gt;macvlan&quot;]
        P2[&quot;Plugin 2&lt;br/&gt;sbr&quot;]
    end

    P1 --&gt; |创建网卡| P2
    P2 --&gt; |添加原地路由| Result[&quot;完成配置&quot;]
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">插件</th>
<th style="text-align: left;">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">macvlan</td>
<td style="text-align: left;">创建 MACVLAN 子接口</td>
</tr>
<tr>
<td style="text-align: left;">sbr</td>
<td style="text-align: left;">自动添加 <code>ip rule</code> + <code>ip route table</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>自动化 SBR</strong></p>
<p>通过 <code>plugins</code> 数组配置 <code>sbr</code> 插件，Pod 启动时 <strong>自动</strong> 添加原地路由，无需手动配置！</p>
</blockquote>
<h3 id="575-kind-containerlab">57.5 Kind + ContainerLab 多网卡环境<a class="headerlink" href="#575-kind-containerlab" title="Permanent link">&para;</a></h3>
<h4 id="5751">57.5.1 架构设计<a class="headerlink" href="#5751" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;ContainerLab&quot;
        GW[&quot;Gateway&lt;br/&gt;VyOS 路由器&quot;]
        BR[&quot;Bridge&quot;]

        GW --&gt; BR
    end

    subgraph &quot;Kind K8s 集群&quot;
        M[&quot;Master&lt;br/&gt;eth0 + eth1&quot;]
        W1[&quot;Worker1&lt;br/&gt;eth0 + eth1&quot;]
        W2[&quot;Worker2&lt;br/&gt;eth0 + eth1&quot;]
    end

    BR --&gt; M
    BR --&gt; W1
    BR --&gt; W2

    subgraph &quot;网卡来源&quot;
        eth0_src[&quot;eth0 - Kind 网络&quot;]
        eth1_src[&quot;eth1 - ContainerLab&quot;]
    end
</code></pre></div>
<h4 id="5752">57.5.2 多网段设计<a class="headerlink" href="#5752" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">网卡</th>
<th style="text-align: left;">网段</th>
<th style="text-align: left;">网关</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">eth0</td>
<td style="text-align: left;">172.20.20.0/24</td>
<td style="text-align: left;">Kind 默认</td>
<td style="text-align: left;">K8s 集群通信</td>
</tr>
<tr>
<td style="text-align: left;">eth1</td>
<td style="text-align: left;">15.15.1.0/24</td>
<td style="text-align: left;">15.15.1.1</td>
<td style="text-align: left;">MACVLAN 网络1</td>
</tr>
<tr>
<td style="text-align: left;">eth2</td>
<td style="text-align: left;">16.16.1.0/24</td>
<td style="text-align: left;">16.16.1.1</td>
<td style="text-align: left;">MACVLAN 网络2</td>
</tr>
</tbody>
</table>
<h3 id="576-pod">57.6 多网卡 Pod 配置<a class="headerlink" href="#576-pod" title="Permanent link">&para;</a></h3>
<h4 id="5761-pod">57.6.1 三网卡 Pod 示例<a class="headerlink" href="#5761-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multi-nic-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-sbr-net1, macvlan-sbr-net2</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nicolaka/netshoot</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;infinity&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h4 id="5762-pod">57.6.2 Pod 网络结构<a class="headerlink" href="#5762-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Pod: multi-nic-pod&quot;
        eth0[&quot;eth0&lt;br/&gt;K8s 默认网络&lt;br/&gt;10.244.x.x&quot;]
        eth1[&quot;eth1&lt;br/&gt;MACVLAN 网络1&lt;br/&gt;15.15.1.2&quot;]
        eth2[&quot;eth2&lt;br/&gt;MACVLAN 网络2&lt;br/&gt;16.16.1.2&quot;]
    end

    eth0 --&gt; K8s[&quot;K8s 集群通信&quot;]
    eth1 --&gt; Net1[&quot;业务网络1&quot;]
    eth2 --&gt; Net2[&quot;业务网络2&quot;]
</code></pre></div>
<h4 id="5763-sbr">57.6.3 验证 SBR 自动配置<a class="headerlink" href="#5763-sbr" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看路由规则</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>multi-nic-pod<span class="w"> </span>--<span class="w"> </span>ip<span class="w"> </span>rule
<span class="c1"># 输出：</span>
<span class="c1"># 0:     from all lookup local</span>
<span class="c1"># 100:   from 15.15.1.0/24 lookup 100</span>
<span class="c1"># 101:   from 16.16.1.0/24 lookup 101</span>
<span class="c1"># 32766: from all lookup main</span>
<span class="c1"># 32767: from all lookup default</span>

<span class="c1"># 查看路由表</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>multi-nic-pod<span class="w"> </span>--<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span><span class="m">100</span>
<span class="c1"># 输出：</span>
<span class="c1"># 15.15.1.0/24 dev eth1 scope link</span>
<span class="c1"># default via 15.15.1.1 dev eth1</span>
</code></pre></div>
<h3 id="577">57.7 多网卡通信验证<a class="headerlink" href="#577" title="Permanent link">&para;</a></h3>
<h4 id="5771">57.7.1 验证场景<a class="headerlink" href="#5771" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TB
    subgraph &quot;验证项目&quot;
        T1[&quot;同网段 Pod 互通&quot;]
        T2[&quot;跨网段 Pod 互通&quot;]
        T3[&quot;每张网卡上外网&quot;]
        T4[&quot;网关可达性&quot;]
    end
</code></pre></div>
<h4 id="5772">57.7.2 验证命令<a class="headerlink" href="#5772" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 同网段 Pod 互通</span>
ping<span class="w"> </span>-I<span class="w"> </span><span class="m">15</span>.15.1.2<span class="w"> </span><span class="m">15</span>.15.1.3

<span class="c1"># 跨网段 Pod 互通（通过网关）</span>
ping<span class="w"> </span>-I<span class="w"> </span><span class="m">15</span>.15.1.2<span class="w"> </span><span class="m">16</span>.16.1.3

<span class="c1"># 每张网卡上外网</span>
ping<span class="w"> </span>-I<span class="w"> </span><span class="m">15</span>.15.1.2<span class="w"> </span><span class="m">114</span>.114.114.114
ping<span class="w"> </span>-I<span class="w"> </span><span class="m">16</span>.16.1.2<span class="w"> </span><span class="m">114</span>.114.114.114
</code></pre></div>
<h3 id="578">57.8 生产应用场景<a class="headerlink" href="#578" title="Permanent link">&para;</a></h3>
<h4 id="5781">57.8.1 网卡功能分离<a class="headerlink" href="#5781" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;Pod 多网卡&quot;
        eth0[&quot;eth0&lt;br/&gt;O&amp;M 管理&quot;]
        eth1[&quot;eth1&lt;br/&gt;Data 业务&quot;]
        eth2[&quot;eth2&lt;br/&gt;Media 媒体&quot;]
    end

    eth0 --&gt; OM[&quot;SSH/监控/运维&quot;]
    eth1 --&gt; Data[&quot;数据处理&quot;]
    eth2 --&gt; Media[&quot;流媒体传输&quot;]
</code></pre></div>
<h4 id="5782">57.8.2 典型行业应用<a class="headerlink" href="#5782" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">行业</th>
<th style="text-align: left;">网卡用途</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">电信</td>
<td style="text-align: left;">Control/Data 分离</td>
<td style="text-align: left;">控制面与数据面隔离</td>
</tr>
<tr>
<td style="text-align: left;">流媒体</td>
<td style="text-align: left;">Media/Signal 分离</td>
<td style="text-align: left;">媒体流与信令分离</td>
</tr>
<tr>
<td style="text-align: left;">金融</td>
<td style="text-align: left;">Trade/Admin 分离</td>
<td style="text-align: left;">交易网络与管理网络隔离</td>
</tr>
</tbody>
</table>
<h3 id="579">57.9 性能对比<a class="headerlink" href="#579" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">方案</th>
<th style="text-align: left;">性能级别</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">MACVLAN Bridge</td>
<td style="text-align: left;">⭐⭐⭐⭐</td>
<td style="text-align: left;">接近物理网卡性能</td>
</tr>
<tr>
<td style="text-align: left;">IPVLAN L2</td>
<td style="text-align: left;">⭐⭐⭐⭐</td>
<td style="text-align: left;">与 MACVLAN 相当</td>
</tr>
<tr>
<td style="text-align: left;">SR-IOV + DPDK</td>
<td style="text-align: left;">⭐⭐⭐⭐⭐</td>
<td style="text-align: left;">最高性能（硬件虚拟化）</td>
</tr>
<tr>
<td style="text-align: left;">Overlay (VxLAN)</td>
<td style="text-align: left;">⭐⭐</td>
<td style="text-align: left;">封装开销较大</td>
</tr>
</tbody>
</table>
<h3 id="5710">57.10 章节小结<a class="headerlink" href="#5710" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((MACVLAN-SBR 实践))
    MACVLAN 特点
      独立 MAC 地址
      早期内核支持
      Bridge 模式最常用
    与 IPVLAN 对比
      MAC 独立 vs 共享
      理解难度
      云环境兼容性
    SBR 配置
      plugins 链式调用
      sbr 插件自动配置
      无需手动添加路由
    多网卡环境
      Kind + ContainerLab
      VyOS 网关
      多网段设计
    生产应用
      O&amp;M/Data/Media 分离
      电信/流媒体/金融
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>MACVLAN-SBR 实践要点总结</strong>：</p>
<ol>
<li>
<p><strong>MACVLAN 特点</strong>：每个子接口有独立 MAC 地址，Bridge 模式最常用</p>
</li>
<li>
<p><strong>与 IPVLAN 区别</strong>：MACVLAN MAC 独立，IPVLAN MAC 共享</p>
</li>
<li>
<p><strong>SBR 自动配置</strong>：使用 <code>plugins</code> 数组添加 <code>{"type": "sbr"}</code></p>
</li>
<li>
<p><strong>多网卡环境</strong>：Kind + ContainerLab 集成，多网卡可同时上外网</p>
</li>
<li>
<p><strong>生产应用</strong>：网卡功能分离（管理/业务/媒体），电信、流媒体、金融行业常用</p>
</li>
</ol>
</blockquote>
<hr />
<h2 id="multus-with-sriov-kernel">第五十八章 Multus-with-SRIOV-Kernel<a class="headerlink" href="#multus-with-sriov-kernel" title="Permanent link">&para;</a></h2>
<p>本章介绍 SR-IOV Kernel 模式在 Kubernetes 中的应用，包括 SR-IOV 原理、硬件虚拟化技术、组件配置及与 Multus 的集成。</p>
<h3 id="581">58.1 背景与概述<a class="headerlink" href="#581" title="Permanent link">&para;</a></h3>
<h4 id="5811">58.1.1 高性能网络需求<a class="headerlink" href="#5811" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;传统网络路径&quot;
        App[&quot;应用&quot;]
        Socket[&quot;Socket 层&quot;]
        TCPIP[&quot;TCP/IP 协议栈&quot;]
        Driver[&quot;网卡驱动&quot;]
        NIC[&quot;物理网卡&quot;]

        App --&gt; Socket --&gt; TCPIP --&gt; Driver --&gt; NIC
    end
</code></pre></div>
<p><strong>问题</strong>：当网卡带宽超过 10G 时，传统内核协议栈成为性能瓶颈。</p>
<p><strong>解决方案</strong>：Kernel Bypass（内核旁路）技术。</p>
<h4 id="5812-sr-iov">58.1.2 SR-IOV 核心概念<a class="headerlink" href="#5812-sr-iov" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">术语</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>PF (Physical Function)</strong></td>
<td style="text-align: left;">物理网卡，完整的 PCIe 功能</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VF (Virtual Function)</strong></td>
<td style="text-align: left;">虚拟网卡，PF 划分出的轻量级功能</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SR-IOV</strong></td>
<td style="text-align: left;">Single Root I/O Virtualization，硬件虚拟化标准</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;SR-IOV 架构&quot;
        PF[&quot;PF - 物理网卡&lt;br/&gt;10G/25G/40G&quot;]
        VF1[&quot;VF0&quot;]
        VF2[&quot;VF1&quot;]
        VF3[&quot;VF2&quot;]
        VFn[&quot;VF...&quot;]

        PF --&gt; VF1
        PF --&gt; VF2
        PF --&gt; VF3
        PF --&gt; VFn
    end

    subgraph &quot;Pod&quot;
        Pod1[&quot;Pod1&lt;br/&gt;使用 VF0&quot;]
        Pod2[&quot;Pod2&lt;br/&gt;使用 VF1&quot;]
    end

    VF1 --&gt; Pod1
    VF2 --&gt; Pod2
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>SR-IOV 优势</strong></p>
<ul>
<li><strong>硬件虚拟化</strong>：VF 直接由硬件提供，不经过 Host OS 协议栈</li>
<li><strong>高性能</strong>：接近物理网卡性能</li>
<li><strong>资源隔离</strong>：每个 VF 独立的带宽和资源</li>
</ul>
</blockquote>
<h3 id="582-sr-iov-vs-dpdk">58.2 SR-IOV vs DPDK<a class="headerlink" href="#582-sr-iov-vs-dpdk" title="Permanent link">&para;</a></h3>
<h4 id="5821-kernel-bypass">58.2.1 Kernel Bypass 层次<a class="headerlink" href="#5821-kernel-bypass" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;裸机环境 - 双层 Bypass&quot;
        Pod[&quot;Pod&quot;]
        PodStack[&quot;Pod 协议栈&quot;]
        HostStack[&quot;Host OS 协议栈&quot;]
        HW[&quot;物理网卡&quot;]

        Pod --&gt; |&quot;DPDK/VPP Bypass&quot;| PodStack
        PodStack -.-&gt; |&quot;SR-IOV Bypass&quot;| HostStack
        HostStack --&gt; HW
    end

    style PodStack stroke-dasharray: 5 5
    style HostStack stroke-dasharray: 5 5
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">技术</th>
<th style="text-align: left;">Bypass 层级</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SR-IOV Kernel</strong></td>
<td style="text-align: left;">Host OS 协议栈</td>
<td style="text-align: left;">VF 直通到 Pod</td>
</tr>
<tr>
<td style="text-align: left;"><strong>DPDK/VPP</strong></td>
<td style="text-align: left;">Pod 协议栈</td>
<td style="text-align: left;">用户态协议栈处理</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SR-IOV + DPDK</strong></td>
<td style="text-align: left;">双层 Bypass</td>
<td style="text-align: left;">最高性能</td>
</tr>
</tbody>
</table>
<h4 id="5822">58.2.2 适用场景<a class="headerlink" href="#5822" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;SR-IOV Kernel&quot;
        K1[&quot;通用高性能场景&quot;]
        K2[&quot;简单配置&quot;]
        K3[&quot;保留内核协议栈&quot;]
    end

    subgraph &quot;SR-IOV + DPDK&quot;
        D1[&quot;极致性能场景&quot;]
        D2[&quot;流媒体处理&quot;]
        D3[&quot;电信 NFV&quot;]
    end
</code></pre></div>
<h3 id="583-bios">58.3 BIOS/内核预设置<a class="headerlink" href="#583-bios" title="Permanent link">&para;</a></h3>
<h4 id="5831-bios">58.3.1 BIOS 设置<a class="headerlink" href="#5831-bios" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">设置项</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>VT-d</strong></td>
<td style="text-align: left;">Intel 虚拟化技术，必须开启</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SR-IOV</strong></td>
<td style="text-align: left;">网卡 SR-IOV 功能，必须开启</td>
</tr>
</tbody>
</table>
<h4 id="5832">58.3.2 内核参数<a class="headerlink" href="#5832" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 编辑 GRUB 配置</span>
vi<span class="w"> </span>/etc/default/grub

<span class="c1"># 添加内核参数</span>
<span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;intel_iommu=on iommu=pt&quot;</span>

<span class="c1"># 更新 GRUB</span>
grub2-mkconfig<span class="w"> </span>-o<span class="w"> </span>/boot/grub2/grub.cfg

<span class="c1"># 重启生效</span>
reboot
</code></pre></div>
<h4 id="5833-hugepages">58.3.3 HugePages（大页内存）配置<a class="headerlink" href="#5833-hugepages" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 编辑配置</span>
vi<span class="w"> </span>/etc/sysctl.d/hugepages.conf

<span class="c1"># 添加内容</span>
vm.nr_hugepages<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
vm.hugetlb_shm_group<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="c1"># 应用配置</span>
sysctl<span class="w"> </span>-p<span class="w"> </span>/etc/sysctl.d/hugepages.conf
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">nr_hugepages</td>
<td style="text-align: left;">大页数量（1G 页 x 16 = 16G）</td>
</tr>
<tr>
<td style="text-align: left;">用途</td>
<td style="text-align: left;">提高内存命中率，减少 TLB miss</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>HugePages 注意事项</strong></p>
<ul>
<li>HugePages 是从系统内存中划分的</li>
<li>例如：800G 内存，配置 300G HugePages，剩余 500G 可用</li>
<li>需要根据 Pod 数量和单 Pod 内存需求规划</li>
</ul>
</blockquote>
<h3 id="584-vf">58.4 VF 创建与管理<a class="headerlink" href="#584-vf" title="Permanent link">&para;</a></h3>
<h4 id="5841-vf">58.4.1 创建 VF<a class="headerlink" href="#5841-vf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看网卡</span>
ip<span class="w"> </span>link<span class="w"> </span>show

<span class="c1"># 创建 VF（例如：eth2 创建 8 个 VF）</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">8</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/net/eth2/device/sriov_numvfs

<span class="c1"># 验证</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>eth2
<span class="c1"># 输出会显示 vf 0, vf 1, ..., vf 7</span>
</code></pre></div>
<h4 id="5842-vf">58.4.2 VF 数量规划<a class="headerlink" href="#5842-vf" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">网卡带宽</th>
<th style="text-align: left;">VF 数量</th>
<th style="text-align: left;">单 VF 带宽</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">10G</td>
<td style="text-align: left;">8</td>
<td style="text-align: left;">~1.25G</td>
</tr>
<tr>
<td style="text-align: left;">25G</td>
<td style="text-align: left;">8</td>
<td style="text-align: left;">~3G</td>
</tr>
<tr>
<td style="text-align: left;">40G</td>
<td style="text-align: left;">16</td>
<td style="text-align: left;">~2.5G</td>
</tr>
</tbody>
</table>
<h3 id="585-sr-iov-network-device-plugin">58.5 SR-IOV Network Device Plugin<a class="headerlink" href="#585-sr-iov-network-device-plugin" title="Permanent link">&para;</a></h3>
<h4 id="5851">58.5.1 组件作用<a class="headerlink" href="#5851" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;SR-IOV 组件栈&quot;
        DP[&quot;SR-IOV Network Device Plugin&lt;br/&gt;VF 管理、资源上报&quot;]
        CNI[&quot;SR-IOV CNI&lt;br/&gt;网络通路搭建&quot;]
        Multus[&quot;Multus CNI&lt;br/&gt;多网卡管理&quot;]
    end

    DP --&gt; |&quot;发现 VF&quot;| K8s[&quot;K8s 资源&quot;]
    CNI --&gt; |&quot;注入 VF&quot;| Pod[&quot;Pod&quot;]
    Multus --&gt; |&quot;调度网卡&quot;| CNI
</code></pre></div>
<h4 id="5852-device-plugin">58.5.2 安装 Device Plugin<a class="headerlink" href="#5852-device-plugin" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 部署 SR-IOV Network Device Plugin</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/k8snetworkplumbingwg/sriov-network-device-plugin/master/deployments/k8s-v1.16/sriovdp-daemonset.yaml
</code></pre></div>
<h4 id="5853-configmap">58.5.3 ConfigMap 配置<a class="headerlink" href="#5853-configmap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovdp-config</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;resourceList&quot;: [</span>
<span class="w">        </span><span class="no">{</span>
<span class="w">          </span><span class="no">&quot;resourceName&quot;: &quot;sriov_netdevice&quot;,</span>
<span class="w">          </span><span class="no">&quot;selectors&quot;: {</span>
<span class="w">            </span><span class="no">&quot;vendors&quot;: [&quot;8086&quot;],</span>
<span class="w">            </span><span class="no">&quot;devices&quot;: [&quot;154c&quot;],</span>
<span class="w">            </span><span class="no">&quot;drivers&quot;: [&quot;i40evf&quot;],</span>
<span class="w">            </span><span class="no">&quot;pfNames&quot;: [&quot;eth2&quot;, &quot;eth3&quot;]</span>
<span class="w">          </span><span class="no">}</span>
<span class="w">        </span><span class="no">}</span>
<span class="w">      </span><span class="no">]</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">字段</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">resourceName</td>
<td style="text-align: left;">K8s 资源名称</td>
</tr>
<tr>
<td style="text-align: left;">vendors</td>
<td style="text-align: left;">网卡厂商 ID（如 8086 = Intel）</td>
</tr>
<tr>
<td style="text-align: left;">devices</td>
<td style="text-align: left;">设备 ID</td>
</tr>
<tr>
<td style="text-align: left;">drivers</td>
<td style="text-align: left;">VF 驱动名称</td>
</tr>
<tr>
<td style="text-align: left;">pfNames</td>
<td style="text-align: left;">PF 网卡名称</td>
</tr>
</tbody>
</table>
<h4 id="5854">58.5.4 验证资源<a class="headerlink" href="#5854" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看节点资源</span>
kubectl<span class="w"> </span>describe<span class="w"> </span>node<span class="w"> </span>&lt;node-name&gt;<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="s2">&quot;Allocatable&quot;</span>

<span class="c1"># 输出示例：</span>
<span class="c1"># intel.com/sriov_netdevice: 16</span>
<span class="c1"># hugepages-1Gi: 64Gi</span>
</code></pre></div>
<h3 id="586-sr-iov-cni">58.6 SR-IOV CNI<a class="headerlink" href="#586-sr-iov-cni" title="Permanent link">&para;</a></h3>
<h4 id="5861-sr-iov-cni">58.6.1 安装 SR-IOV CNI<a class="headerlink" href="#5861-sr-iov-cni" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 部署 SR-IOV CNI</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/k8snetworkplumbingwg/sriov-cni/master/images/sriov-cni-daemonset.yaml
</code></pre></div>
<h4 id="5862-cni">58.6.2 CNI 工作原理<a class="headerlink" href="#5862-cni" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Kubelet
    participant Multus
    participant SRIOV_CNI as SR-IOV CNI
    participant Pod

    Kubelet-&gt;&gt;Multus: 创建 Pod 请求
    Multus-&gt;&gt;Multus: 解析 NAD 注解
    Multus-&gt;&gt;SRIOV_CNI: 调用 SR-IOV CNI
    SRIOV_CNI-&gt;&gt;SRIOV_CNI: 分配 VF
    SRIOV_CNI-&gt;&gt;Pod: 注入 VF 网卡
    SRIOV_CNI-&gt;&gt;Multus: 返回结果
    Multus-&gt;&gt;Kubelet: 完成
</code></pre></div>
<h3 id="587-nad">58.7 NAD 配置<a class="headerlink" href="#587-nad" title="Permanent link">&para;</a></h3>
<h4 id="5871-nad">58.7.1 完整 NAD 示例<a class="headerlink" href="#5871-nad" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-net</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">intel.com/sriov_netdevice</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;sriov-network&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;sriov&quot;,</span>
<span class="w">    </span><span class="s">&quot;spoofchk&quot;:</span><span class="nv"> </span><span class="s">&quot;on&quot;,</span>
<span class="w">    </span><span class="s">&quot;trust&quot;:</span><span class="nv"> </span><span class="s">&quot;on&quot;,</span>
<span class="w">    </span><span class="s">&quot;vlan&quot;:</span><span class="nv"> </span><span class="s">100,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">      </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;192.168.100.0/24&quot;,</span>
<span class="w">      </span><span class="s">&quot;range_start&quot;:</span><span class="nv"> </span><span class="s">&quot;192.168.100.10&quot;,</span>
<span class="w">      </span><span class="s">&quot;range_end&quot;:</span><span class="nv"> </span><span class="s">&quot;192.168.100.200&quot;</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<h4 id="5872">58.7.2 关键参数说明<a class="headerlink" href="#5872" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">参数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>spoofchk</strong></td>
<td style="text-align: left;">MAC 欺骗检查，<code>on</code> 开启</td>
</tr>
<tr>
<td style="text-align: left;"><strong>trust</strong></td>
<td style="text-align: left;">信任模式，<code>on</code> 允许接收 GARP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>vlan</strong></td>
<td style="text-align: left;">VLAN ID，可选</td>
</tr>
<tr>
<td style="text-align: left;">resourceName</td>
<td style="text-align: left;">引用 Device Plugin 定义的资源</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>trust 参数</strong></p>
<ul>
<li>开启后 VF 可以接收 GARP（Gratuitous ARP）消息</li>
<li>避免 Pod 重启后因 MAC 地址变化导致的短暂不可达</li>
</ul>
</blockquote>
<h3 id="588-pod">58.8 Pod 配置<a class="headerlink" href="#588-pod" title="Permanent link">&para;</a></h3>
<h4 id="5881-pod">58.8.1 Pod 示例<a class="headerlink" href="#5881-pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-pod</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-net</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nicolaka/netshoot</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;infinity&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">        </span><span class="nt">intel.com/sriov_netdevice</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">        </span><span class="nt">intel.com/sriov_netdevice</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
</code></pre></div>
<h4 id="5882">58.8.2 资源声明<a class="headerlink" href="#5882" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart LR
    subgraph &quot;资源声明&quot;
        A[&quot;resources.requests&quot;]
        B[&quot;intel.com/sriov_netdevice: 1&quot;]
    end

    A --&gt; B
    B --&gt; |&quot;调度器检查&quot;| Node[&quot;有 VF 的节点&quot;]
    Node --&gt; |&quot;分配 VF&quot;| Pod[&quot;Pod&quot;]
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>必须声明资源</strong></p>
<p>与 MACVLAN/IPVLAN 不同，SR-IOV 必须在 Pod 中声明资源请求，否则调度器无法分配 VF。</p>
</blockquote>
<h3 id="589">58.9 验证与调试<a class="headerlink" href="#589" title="Permanent link">&para;</a></h3>
<h4 id="5891">58.9.1 验证命令<a class="headerlink" href="#5891" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 Pod 网卡</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sriov-pod<span class="w"> </span>--<span class="w"> </span>ip<span class="w"> </span>a

<span class="c1"># 查看网卡驱动</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sriov-pod<span class="w"> </span>--<span class="w"> </span>ethtool<span class="w"> </span>-i<span class="w"> </span>net1
<span class="c1"># driver: i40evf</span>

<span class="c1"># 查看 VF 分配</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>eth2<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>vf
</code></pre></div>
<h4 id="5892">58.9.2 常见问题<a class="headerlink" href="#5892" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">问题</th>
<th style="text-align: left;">原因</th>
<th style="text-align: left;">解决</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">VF 数量为 0</td>
<td style="text-align: left;">未创建 VF</td>
<td style="text-align: left;"><code>echo N &gt; sriov_numvfs</code></td>
</tr>
<tr>
<td style="text-align: left;">资源不可见</td>
<td style="text-align: left;">ConfigMap 配置错误</td>
<td style="text-align: left;">检查 pfNames、drivers</td>
</tr>
<tr>
<td style="text-align: left;">Pod 无法调度</td>
<td style="text-align: left;">VF 不足</td>
<td style="text-align: left;">增加 VF 或减少 Pod</td>
</tr>
</tbody>
</table>
<h3 id="5810">58.10 章节小结<a class="headerlink" href="#5810" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((SR-IOV Kernel))
    原理
      PF 到 VF 映射
      硬件虚拟化
      Bypass Host OS
    预设置
      BIOS VT-d
      内核 IOMMU
      HugePages
    组件
      Device Plugin
      SR-IOV CNI
      Multus
    配置
      ConfigMap 资源定义
      NAD 网络配置
      Pod 资源声明
    关键参数
      spoofchk
      trust
      vlan
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>SR-IOV Kernel 要点总结</strong>：</p>
<ol>
<li>
<p><strong>原理</strong>：PF 划分为多个 VF，VF 直通到 Pod，Bypass Host OS 协议栈</p>
</li>
<li>
<p><strong>预设置</strong>：BIOS 开启 VT-d/SR-IOV，内核配置 IOMMU，配置 HugePages</p>
</li>
<li>
<p><strong>组件</strong>：</p>
</li>
<li>Device Plugin：管理 VF，上报资源</li>
<li>SR-IOV CNI：搭建网络通路</li>
<li>
<p>Multus：多网卡管理</p>
</li>
<li>
<p><strong>配置流程</strong>：</p>
</li>
<li>
<p>创建 VF → 部署 Device Plugin → 部署 SR-IOV CNI → 创建 NAD → 创建 Pod</p>
</li>
<li>
<p><strong>关键参数</strong>：<code>spoofchk</code>、<code>trust</code>、<code>vlan</code>、资源请求</p>
</li>
</ol>
</blockquote>
<hr />
<h2 id="multus-with-sriov-dpdk-vpp">第五十九章 Multus-with-SRIOV-DPDK-VPP<a class="headerlink" href="#multus-with-sriov-dpdk-vpp" title="Permanent link">&para;</a></h2>
<p>本章介绍 SR-IOV 结合 DPDK/VPP 的高性能网络方案，涵盖驱动配置、PMD 原理、CPU 绑核隔离等关键技术。</p>
<h3 id="591">59.1 背景与概述<a class="headerlink" href="#591" title="Permanent link">&para;</a></h3>
<h4 id="5911-sr-iov-kernel-vs-sr-iov-dpdk">59.1.1 SR-IOV Kernel vs SR-IOV DPDK<a class="headerlink" href="#5911-sr-iov-kernel-vs-sr-iov-dpdk" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;SR-IOV Kernel&quot;
        K_VF[&quot;VF&quot;]
        K_Kernel[&quot;内核协议栈&quot;]
        K_Pod[&quot;Pod&quot;]

        K_VF --&gt; K_Kernel --&gt; K_Pod
    end

    subgraph &quot;SR-IOV DPDK&quot;
        D_VF[&quot;VF&quot;]
        D_VPP[&quot;VPP 用户态协议栈&quot;]
        D_Pod[&quot;Pod&quot;]

        D_VF --&gt; D_VPP --&gt; D_Pod
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">对比项</th>
<th style="text-align: left;">SR-IOV Kernel</th>
<th style="text-align: left;">SR-IOV DPDK</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">协议栈</td>
<td style="text-align: left;">内核协议栈</td>
<td style="text-align: left;">用户态协议栈（VPP）</td>
</tr>
<tr>
<td style="text-align: left;">Bypass 层级</td>
<td style="text-align: left;">Host OS</td>
<td style="text-align: left;">Host OS + Pod 内核</td>
</tr>
<tr>
<td style="text-align: left;">驱动</td>
<td style="text-align: left;">原生驱动（i40evf, sfc_efx）</td>
<td style="text-align: left;">vfio-pci, igb_uio</td>
</tr>
<tr>
<td style="text-align: left;">性能</td>
<td style="text-align: left;">高</td>
<td style="text-align: left;">极高</td>
</tr>
<tr>
<td style="text-align: left;">复杂度</td>
<td style="text-align: left;">低</td>
<td style="text-align: left;">高</td>
</tr>
</tbody>
</table>
<h4 id="5912-bypass">59.1.2 双层 Bypass 架构<a class="headerlink" href="#5912-bypass" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;裸机 DPDK 完整架构&quot;
        APP[&quot;应用&quot;]
        VPP[&quot;VPP 用户态协议栈&lt;br/&gt;（DPDK Bypass Pod 内核）&quot;]
        VF[&quot;VF（SR-IOV）&lt;br/&gt;（Bypass Host OS 内核）&quot;]
        PF[&quot;物理网卡 PF&quot;]

        APP --&gt; VPP
        VPP --&gt; VF
        VF --&gt; PF
    end
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>双层 Bypass 理解</strong></p>
<ul>
<li><strong>第一层</strong>：SR-IOV VF 直通，Bypass Host OS 内核协议栈</li>
<li><strong>第二层</strong>：DPDK/VPP 用户态协议栈，Bypass Pod 内核协议栈</li>
</ul>
</blockquote>
<h3 id="592-dpdk">59.2 DPDK 驱动类型<a class="headerlink" href="#592-dpdk" title="Permanent link">&para;</a></h3>
<h4 id="5921">59.2.1 驱动对比<a class="headerlink" href="#5921" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">驱动</th>
<th style="text-align: left;">说明</th>
<th style="text-align: left;">推荐</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>vfio-pci</strong></td>
<td style="text-align: left;">现代推荐驱动，安全性好</td>
<td style="text-align: left;">✅ 生产推荐</td>
</tr>
<tr>
<td style="text-align: left;"><strong>igb_uio</strong></td>
<td style="text-align: left;">早期驱动，需要更高权限</td>
<td style="text-align: left;">❌ 不推荐</td>
</tr>
<tr>
<td style="text-align: left;"><strong>uio_generic</strong></td>
<td style="text-align: left;">通用驱动，性能较低</td>
<td style="text-align: left;">❌ 备选</td>
</tr>
</tbody>
</table>
<h4 id="5922">59.2.2 驱动选择原因<a class="headerlink" href="#5922" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[&quot;选择 DPDK 驱动&quot;] --&gt; B{&quot;是否支持非特权模式?&quot;}
    B --&gt;|&quot;是&quot;| C[&quot;vfio-pci ✅&quot;]
    B --&gt;|&quot;否&quot;| D[&quot;igb_uio&quot;]

    C --&gt; E[&quot;安全性好&lt;br/&gt;capabilities 要求少&quot;]
    D --&gt; F[&quot;需要 privileged: true&lt;br/&gt;安全风险&quot;]
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>生产环境驱动选择</strong></p>
<ul>
<li>优先使用 <code>vfio-pci</code>，支持非特权模式运行</li>
<li>避免使用 <code>igb_uio</code>，需要更高权限</li>
<li><code>vfio-pci</code> 对 capabilities 要求更少，更安全</li>
</ul>
</blockquote>
<h3 id="593">59.3 驱动绑定操作<a class="headerlink" href="#593" title="Permanent link">&para;</a></h3>
<h4 id="5931">59.3.1 加载驱动模块<a class="headerlink" href="#5931" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 加载 vfio-pci 驱动</span>
modprobe<span class="w"> </span>vfio-pci
</code></pre></div>
<h4 id="5932-vf-dpdk">59.3.2 绑定 VF 到 DPDK 驱动<a class="headerlink" href="#5932-vf-dpdk" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 VF 的 PCI 地址</span>
lspci<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>ethernet

<span class="c1"># 使用 dpdk-devbind 脚本绑定驱动</span>
<span class="c1"># 解绑原有驱动并绑定到 vfio-pci</span>
<span class="k">for</span><span class="w"> </span>pci_addr<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;VF_PCI_ADDR_LIST&gt;<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>dpdk-devbind.py<span class="w"> </span>-u<span class="w"> </span><span class="nv">$pci_addr</span>
<span class="w">    </span>dpdk-devbind.py<span class="w"> </span>-b<span class="w"> </span>vfio-pci<span class="w"> </span><span class="nv">$pci_addr</span>
<span class="k">done</span>

<span class="c1"># 验证驱动绑定</span>
dpdk-devbind.py<span class="w"> </span>--status
</code></pre></div>
<h4 id="5933-vf">59.3.3 验证 VF 配置<a class="headerlink" href="#5933-vf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看 VF 状态</span>
ip<span class="w"> </span>-d<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>eth6

<span class="c1"># 输出示例：</span>
<span class="c1"># eth6: ... link/ether ...</span>
<span class="c1">#     vf 0 MAC ... spoof check on, trust on</span>
<span class="c1">#     vf 1 MAC ... spoof check on, trust on</span>
<span class="c1">#     ...</span>
</code></pre></div>
<h3 id="594-dpdk-pmd">59.4 DPDK PMD 原理<a class="headerlink" href="#594-dpdk-pmd" title="Permanent link">&para;</a></h3>
<h4 id="5941-vs">59.4.1 中断模式 vs 轮询模式<a class="headerlink" href="#5941-vs" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant NIC as 网卡
    participant Kernel as 内核
    participant App as 应用

    Note over NIC, App: 传统中断模式
    NIC-&gt;&gt;Kernel: 硬中断
    Kernel-&gt;&gt;Kernel: 软中断处理
    Kernel-&gt;&gt;App: 数据包

    Note over NIC, App: DPDK PMD 轮询模式
    loop 持续轮询
        App-&gt;&gt;NIC: 主动查询
        NIC--&gt;&gt;App: 返回数据包
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">模式</th>
<th style="text-align: left;">中断模式</th>
<th style="text-align: left;">PMD 轮询模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">触发方式</td>
<td style="text-align: left;">被动（中断触发）</td>
<td style="text-align: left;">主动（持续轮询）</td>
</tr>
<tr>
<td style="text-align: left;">CPU 使用</td>
<td style="text-align: left;">按需</td>
<td style="text-align: left;">100% 占用</td>
</tr>
<tr>
<td style="text-align: left;">延迟</td>
<td style="text-align: left;">较高</td>
<td style="text-align: left;">极低</td>
</tr>
<tr>
<td style="text-align: left;">适用场景</td>
<td style="text-align: left;">通用场景</td>
<td style="text-align: left;">高性能转发</td>
</tr>
</tbody>
</table>
<h4 id="5942-pmd">59.4.2 PMD 工作原理<a class="headerlink" href="#5942-pmd" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;PMD Poll Mode Driver&quot;
        CPU[&quot;专用 CPU&lt;br/&gt;100% 占用&quot;]
        Ring[&quot;Ring Buffer&quot;]
        VF[&quot;VF 网卡&quot;]

        CPU --&gt; |&quot;持续轮询&quot;| Ring
        VF --&gt; Ring
        Ring --&gt; VF
    end
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>PMD 核心特点</strong></p>
<ul>
<li>CPU 持续轮询，不依赖中断</li>
<li>CPU 显示 100% 使用率（正常现象）</li>
<li>实现纳秒级延迟</li>
</ul>
</blockquote>
<h3 id="595-cpu">59.5 CPU 绑核与隔离<a class="headerlink" href="#595-cpu" title="Permanent link">&para;</a></h3>
<h4 id="5951-cpu">59.5.1 为什么需要 CPU 绑核<a class="headerlink" href="#5951-cpu" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[&quot;PMD 需要 CPU 持续轮询&quot;] --&gt; B[&quot;问题：CPU 被其他进程抢占&quot;]
    B --&gt; C[&quot;后果：数据包丢失/延迟&quot;]
    C --&gt; D[&quot;解决：CPU 绑核隔离&quot;]
</code></pre></div>
<p><strong>问题</strong>：PMD 需要 CPU 24 小时持续轮询，如果 CPU 被其他进程抢占，会导致数据包丢失。</p>
<p><strong>解决</strong>：CPU 绑核隔离，确保 PMD 专用 CPU 不被抢占。</p>
<h4 id="5952-irqbalance">59.5.2 禁用 irqbalance<a class="headerlink" href="#5952-irqbalance" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 停止 irqbalance 服务</span>
systemctl<span class="w"> </span>stop<span class="w"> </span>irqbalance
systemctl<span class="w"> </span>disable<span class="w"> </span>irqbalance
</code></pre></div>
<blockquote>
<p>[!IMPORTANT]
<strong>irqbalance 说明</strong></p>
<ul>
<li>irqbalance 会动态分配中断到不同 CPU</li>
<li>对于 PMD 专用场景，必须禁用</li>
<li>禁用后 CPU 使用更可控</li>
</ul>
</blockquote>
<h4 id="5953-cpu">59.5.3 配置 CPU 隔离<a class="headerlink" href="#5953-cpu" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 编辑 GRUB 配置</span>
vi<span class="w"> </span>/etc/default/grub

<span class="c1"># 添加 isolcpus 参数</span>
<span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;intel_iommu=on iommu=pt isolcpus=4-51,56-103&quot;</span>

<span class="c1"># 更新 GRUB</span>
grub2-mkconfig<span class="w"> </span>-o<span class="w"> </span>/boot/grub2/grub.cfg

<span class="c1"># 重启生效</span>
reboot
</code></pre></div>
<h4 id="5954-cpu">59.5.4 CPU 分配策略<a class="headerlink" href="#5954-cpu" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;NUMA 0&quot;
        SYS0[&quot;CPU 0-3&lt;br/&gt;系统预留&quot;]
        APP0[&quot;CPU 4-51&lt;br/&gt;Pod 专用&quot;]
    end

    subgraph &quot;NUMA 1&quot;
        SYS1[&quot;CPU 52-55&lt;br/&gt;系统预留&quot;]
        APP1[&quot;CPU 56-103&lt;br/&gt;Pod 专用&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">CPU 范围</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">0-3, 52-55</td>
<td style="text-align: left;">系统预留（K8s、基础服务）</td>
</tr>
<tr>
<td style="text-align: left;">4-51, 56-103</td>
<td style="text-align: left;">Pod 专用（PMD、VPP）</td>
</tr>
</tbody>
</table>
<h3 id="596-nad">59.6 NAD 配置差异<a class="headerlink" href="#596-nad" title="Permanent link">&para;</a></h3>
<h4 id="5961-dpdk-nad">59.6.1 DPDK NAD 特点<a class="headerlink" href="#5961-dpdk-nad" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-dpdk-net</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">intel.com/sriov_dpdk</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;sriov-dpdk-network&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;sriov&quot;,</span>
<span class="w">    </span><span class="s">&quot;vlan&quot;:</span><span class="nv"> </span><span class="s">100</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<blockquote>
<p>[!WARNING]
<strong>DPDK 模式 IPAM 注意事项</strong></p>
<ul>
<li>DPDK 模式下，VPP 接管协议栈</li>
<li>传统 IPAM（如 whereabouts）<strong>无法直接使用</strong></li>
<li>IP 配置需通过 VPP 内部机制完成</li>
</ul>
</blockquote>
<h4 id="5962-configmap">59.6.2 ConfigMap 驱动配置<a class="headerlink" href="#5962-configmap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovdp-config</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">      </span><span class="no">&quot;resourceList&quot;: [</span>
<span class="w">        </span><span class="no">{</span>
<span class="w">          </span><span class="no">&quot;resourceName&quot;: &quot;sriov_dpdk&quot;,</span>
<span class="w">          </span><span class="no">&quot;selectors&quot;: {</span>
<span class="w">            </span><span class="no">&quot;vendors&quot;: [&quot;8086&quot;],</span>
<span class="w">            </span><span class="no">&quot;drivers&quot;: [&quot;vfio-pci&quot;],</span>
<span class="w">            </span><span class="no">&quot;pfNames&quot;: [&quot;eth2&quot;, &quot;eth3&quot;]</span>
<span class="w">          </span><span class="no">}</span>
<span class="w">        </span><span class="no">},</span>
<span class="w">        </span><span class="no">{</span>
<span class="w">          </span><span class="no">&quot;resourceName&quot;: &quot;sriov_kernel&quot;,</span>
<span class="w">          </span><span class="no">&quot;selectors&quot;: {</span>
<span class="w">            </span><span class="no">&quot;vendors&quot;: [&quot;8086&quot;],</span>
<span class="w">            </span><span class="no">&quot;drivers&quot;: [&quot;i40evf&quot;],</span>
<span class="w">            </span><span class="no">&quot;pfNames&quot;: [&quot;eth4&quot;, &quot;eth5&quot;]</span>
<span class="w">          </span><span class="no">}</span>
<span class="w">        </span><span class="no">}</span>
<span class="w">      </span><span class="no">]</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<h3 id="597-fast-path-vs-slow-path">59.7 Fast Path vs Slow Path<a class="headerlink" href="#597-fast-path-vs-slow-path" title="Permanent link">&para;</a></h3>
<h4 id="5971">59.7.1 概念对比<a class="headerlink" href="#5971" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Slow Path - 传统路径&quot;
        S_App[&quot;应用&quot;]
        S_Kernel[&quot;内核协议栈&quot;]
        S_Driver[&quot;网卡驱动&quot;]
        S_NIC[&quot;网卡&quot;]

        S_App --&gt; S_Kernel --&gt; S_Driver --&gt; S_NIC
    end

    subgraph &quot;Fast Path - DPDK 路径&quot;
        F_App[&quot;应用&quot;]
        F_VPP[&quot;VPP/DPDK&quot;]
        F_NIC[&quot;网卡 VF&quot;]

        F_App --&gt; F_VPP --&gt; F_NIC
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">路径</th>
<th style="text-align: left;">延迟</th>
<th style="text-align: left;">吞吐量</th>
<th style="text-align: left;">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Slow Path</td>
<td style="text-align: left;">高</td>
<td style="text-align: left;">一般</td>
<td style="text-align: left;">通用场景</td>
</tr>
<tr>
<td style="text-align: left;">Fast Path</td>
<td style="text-align: left;">极低</td>
<td style="text-align: left;">极高</td>
<td style="text-align: left;">NFV、流媒体、金融</td>
</tr>
</tbody>
</table>
<h3 id="598">59.8 生产应用场景<a class="headerlink" href="#598" title="Permanent link">&para;</a></h3>
<h4 id="5981">59.8.1 典型应用领域<a class="headerlink" href="#5981" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>mindmap
  root((SR-IOV DPDK 应用))
    电信 NFV
      虚拟路由器
      虚拟防火墙
      vBNG
    流媒体处理
      视频转码
      CDN 边缘节点
      直播推流
    金融交易
      高频交易
      低延迟网关
      行情分发
    网络安全
      DDoS 防护
      流量清洗
      深度包检测
</code></pre></div>
<h3 id="599">59.9 章节小结<a class="headerlink" href="#599" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((SR-IOV DPDK VPP))
    驱动选择
      vfio-pci 推荐
      igb_uio 不推荐
      dpdk-devbind 绑定
    PMD 原理
      轮询模式
      CPU 100%
      纳秒延迟
    CPU 隔离
      禁用 irqbalance
      isolcpus
      NUMA 感知
    配置差异
      IPAM 不适用
      VPP 配置 IP
      驱动区分资源
    性能优势
      双层 Bypass
      Fast Path
      极致性能
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>SR-IOV DPDK VPP 要点总结</strong>：</p>
<ol>
<li>
<p><strong>驱动选择</strong>：优先 <code>vfio-pci</code>，安全且支持非特权模式</p>
</li>
<li>
<p><strong>PMD 原理</strong>：Poll Mode Driver 持续轮询，CPU 100% 占用但延迟极低</p>
</li>
<li>
<p><strong>CPU 隔离</strong>：</p>
</li>
<li>禁用 irqbalance</li>
<li>配置 isolcpus 参数</li>
<li>
<p>NUMA 感知分配</p>
</li>
<li>
<p><strong>配置差异</strong>：</p>
</li>
<li>DPDK 模式下传统 IPAM 不适用</li>
<li>
<p>驱动类型区分 Kernel 和 DPDK 资源</p>
</li>
<li>
<p><strong>性能优势</strong>：双层 Bypass + Fast Path = 极致性能</p>
</li>
</ol>
</blockquote>
<hr />
<h2 id="k8s-cni-ipam">第六十章 K8s-CNI-IPAM 机制详解<a class="headerlink" href="#k8s-cni-ipam" title="Permanent link">&para;</a></h2>
<p>本章系统介绍 Kubernetes CNI 中的 IPAM（IP Address Management）机制，涵盖各种 IPAM 类型、适用场景和选型建议。</p>
<h3 id="601">60.1 背景与概述<a class="headerlink" href="#601" title="Permanent link">&para;</a></h3>
<h4 id="6011-cni">60.1.1 CNI 的两大核心功能<a class="headerlink" href="#6011-cni" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;CNI 核心功能&quot;
        NL[&quot;Network Links&lt;br/&gt;网络通路搭建&quot;]
        IPAM[&quot;IPAM&lt;br/&gt;IP 地址管理&quot;]
    end

    CNI[&quot;CNI 插件&quot;] --&gt; NL
    CNI --&gt; IPAM
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">功能</th>
<th style="text-align: left;">说明</th>
<th style="text-align: left;">示例技术</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Network Links</td>
<td style="text-align: left;">搭建网络通路</td>
<td style="text-align: left;">VXLAN, IPIP, BGP, VLAN</td>
</tr>
<tr>
<td style="text-align: left;">IPAM</td>
<td style="text-align: left;">IP 地址分配与管理</td>
<td style="text-align: left;">host-local, whereabouts, DHCP</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]
<strong>CNI = Network Links + IPAM</strong></p>
<p>任何 CNI 方案都包含这两部分：</p>
<ul>
<li><strong>Network Links</strong>：解决 Pod 之间如何通信</li>
<li><strong>IPAM</strong>：解决 Pod 如何获取 IP 地址</li>
</ul>
</blockquote>
<h4 id="6012-ipam">60.1.2 为什么需要 IPAM<a class="headerlink" href="#6012-ipam" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[&quot;Pod 创建&quot;] --&gt; B[&quot;需要 IP 地址&quot;]
    B --&gt; C{&quot;如何分配?&quot;}
    C --&gt; D[&quot;IPAM 机制&quot;]
    D --&gt; E[&quot;分配唯一 IP&quot;]
    D --&gt; F[&quot;避免 IP 冲突&quot;]
    D --&gt; G[&quot;管理 IP 生命周期&quot;]
</code></pre></div>
<h3 id="602-ipam">60.2 IPAM 类型概述<a class="headerlink" href="#602-ipam" title="Permanent link">&para;</a></h3>
<h4 id="6021-ipam">60.2.1 四种标准 IPAM<a class="headerlink" href="#6021-ipam" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;CNI 标准 IPAM&quot;
        DHCP[&quot;DHCP&lt;br/&gt;动态主机配置协议&quot;]
        HL[&quot;host-local&lt;br/&gt;节点本地分配&quot;]
        ST[&quot;static&lt;br/&gt;静态 IP&quot;]
        WA[&quot;whereabouts&lt;br/&gt;集群级分配&quot;]
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">IPAM 类型</th>
<th style="text-align: left;">分配范围</th>
<th style="text-align: left;">适用场景</th>
<th style="text-align: left;">使用频率</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>DHCP</strong></td>
<td style="text-align: left;">外部 DHCP 服务器</td>
<td style="text-align: left;">传统网络对接</td>
<td style="text-align: left;">少</td>
</tr>
<tr>
<td style="text-align: left;"><strong>host-local</strong></td>
<td style="text-align: left;">节点本地</td>
<td style="text-align: left;">Flannel 等通用场景</td>
<td style="text-align: left;">高</td>
</tr>
<tr>
<td style="text-align: left;"><strong>static</strong></td>
<td style="text-align: left;">手动指定</td>
<td style="text-align: left;">多网卡固定 IP</td>
<td style="text-align: left;">中</td>
</tr>
<tr>
<td style="text-align: left;"><strong>whereabouts</strong></td>
<td style="text-align: left;">集群级别</td>
<td style="text-align: left;">Multus 多网卡</td>
<td style="text-align: left;">中</td>
</tr>
</tbody>
</table>
<h3 id="603-host-local-ipam">60.3 host-local IPAM<a class="headerlink" href="#603-host-local-ipam" title="Permanent link">&para;</a></h3>
<h4 id="6031">60.3.1 工作原理<a class="headerlink" href="#6031" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Node 1&quot;
        N1_Range[&quot;子网: 10.244.0.0/24&quot;]
        N1_Pod1[&quot;Pod1: 10.244.0.2&quot;]
        N1_Pod2[&quot;Pod2: 10.244.0.3&quot;]
    end

    subgraph &quot;Node 2&quot;
        N2_Range[&quot;子网: 10.244.1.0/24&quot;]
        N2_Pod1[&quot;Pod1: 10.244.1.2&quot;]
        N2_Pod2[&quot;Pod2: 10.244.1.3&quot;]
    end

    subgraph &quot;Node 3&quot;
        N3_Range[&quot;子网: 10.244.2.0/24&quot;]
        N3_Pod1[&quot;Pod1: 10.244.2.2&quot;]
        N3_Pod2[&quot;Pod2: 10.244.2.3&quot;]
    end
</code></pre></div>
<p><strong>核心特点</strong>：</p>
<ul>
<li>每个节点分配一个固定子网（如 /24）</li>
<li>Pod IP 从节点子网中分配</li>
<li>IP 与节点强关联</li>
</ul>
<h4 id="6032">60.3.2 配置示例<a class="headerlink" href="#6032" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;ipam&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;host-local&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;subnet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10.244.0.0/16&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;rangeStart&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10.244.0.10&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;rangeEnd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10.244.0.250&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;dst&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;dataDir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/lib/cni/networks&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="6033">60.3.3 优缺点分析<a class="headerlink" href="#6033" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">优点</th>
<th style="text-align: left;">缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">简单易用</td>
<td style="text-align: left;">IP 与节点绑定</td>
</tr>
<tr>
<td style="text-align: left;">性能好（本地分配）</td>
<td style="text-align: left;">节点故障 IP 不可迁移</td>
</tr>
<tr>
<td style="text-align: left;">无外部依赖</td>
<td style="text-align: left;">每节点 IP 数量有限</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!TIP]
<strong>Flannel 默认使用 host-local</strong></p>
<ul>
<li>每节点分配 /24 子网（254 个可用 IP）</li>
<li>满足大多数场景（K8s 默认每节点最多 110 个 Pod）</li>
</ul>
</blockquote>
<h3 id="604-static-ipam">60.4 static IPAM<a class="headerlink" href="#604-static-ipam" title="Permanent link">&para;</a></h3>
<h4 id="6041">60.4.1 适用场景<a class="headerlink" href="#6041" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[&quot;多网卡场景&quot;] --&gt; B[&quot;Pod 需要固定 IP&quot;]
    B --&gt; C[&quot;使用 static IPAM&quot;]

    D[&quot;重型容器/VM 风格&quot;]
    D --&gt; E[&quot;多容器多进程&quot;]
    E --&gt; F[&quot;固定 IP 便于管理&quot;]
</code></pre></div>
<p><strong>典型场景</strong>：</p>
<ul>
<li>多网卡环境（Multus）</li>
<li>VM 风格的 Pod</li>
<li>需要固定 IP 对接外部系统</li>
</ul>
<h4 id="6042">60.4.2 配置示例<a class="headerlink" href="#6042" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static-ip-net</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;static-network&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;macvlan&quot;,</span>
<span class="w">    </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth0&quot;,</span>
<span class="w">    </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;bridge&quot;,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;static&quot;,</span>
<span class="w">      </span><span class="s">&quot;addresses&quot;:</span><span class="nv"> </span><span class="s">[</span>
<span class="w">        </span><span class="s">{</span>
<span class="w">          </span><span class="s">&quot;address&quot;:</span><span class="nv"> </span><span class="s">&quot;192.168.1.100/24&quot;,</span>
<span class="w">          </span><span class="s">&quot;gateway&quot;:</span><span class="nv"> </span><span class="s">&quot;192.168.1.1&quot;</span>
<span class="w">        </span><span class="s">}</span>
<span class="w">      </span><span class="s">],</span>
<span class="w">      </span><span class="s">&quot;routes&quot;:</span><span class="nv"> </span><span class="s">[</span>
<span class="w">        </span><span class="s">{</span><span class="nv"> </span><span class="s">&quot;dst&quot;:</span><span class="nv"> </span><span class="s">&quot;0.0.0.0/0&quot;</span><span class="nv"> </span><span class="s">}</span>
<span class="w">      </span><span class="s">]</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<h4 id="6043-k8s-static-ip">60.4.3 为什么原生 K8s 不太需要 static IP<a class="headerlink" href="#6043-k8s-static-ip" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[&quot;Pod 重启 IP 变化&quot;] --&gt; B{&quot;影响访问?&quot;}
    B --&gt;|&quot;否&quot;| C[&quot;Service 抽象层&quot;]
    C --&gt; D[&quot;Endpoints 自动更新&quot;]
    D --&gt; E[&quot;iptables/IPVS 规则更新&quot;]
    E --&gt; F[&quot;外部访问不受影响&quot;]
</code></pre></div>
<blockquote>
<p>[!NOTE]
<strong>Service 机制解耦了 IP 变化问题</strong></p>
<ul>
<li>Pod IP 变化 → Endpoints 自动更新</li>
<li>Service ClusterIP/NodePort 保持不变</li>
<li>外部通过 Service 访问，无需关心 Pod IP</li>
</ul>
</blockquote>
<h3 id="605-whereabouts-ipam">60.5 whereabouts IPAM<a class="headerlink" href="#605-whereabouts-ipam" title="Permanent link">&para;</a></h3>
<h4 id="6051-cluster-wide-vs-host-local">60.5.1 Cluster-Wide vs Host-Local<a class="headerlink" href="#6051-cluster-wide-vs-host-local" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;host-local&quot;
        HL_N1[&quot;Node1: 10.244.0.0/24&quot;]
        HL_N2[&quot;Node2: 10.244.1.0/24&quot;]
        HL_N3[&quot;Node3: 10.244.2.0/24&quot;]
    end

    subgraph &quot;whereabouts&quot;
        WA_Pool[&quot;集群 IP 池: 10.10.0.0/16&quot;]
        WA_P1[&quot;Pod1: 10.10.0.1（任意节点）&quot;]
        WA_P2[&quot;Pod2: 10.10.0.2（任意节点）&quot;]
        WA_P3[&quot;Pod3: 10.10.0.3（任意节点）&quot;]

        WA_Pool --&gt; WA_P1
        WA_Pool --&gt; WA_P2
        WA_Pool --&gt; WA_P3
    end
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">host-local</th>
<th style="text-align: left;">whereabouts</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">IP 分配范围</td>
<td style="text-align: left;">单节点</td>
<td style="text-align: left;">整个集群</td>
</tr>
<tr>
<td style="text-align: left;">IP 迁移性</td>
<td style="text-align: left;">不支持</td>
<td style="text-align: left;">支持</td>
</tr>
<tr>
<td style="text-align: left;">实现复杂度</td>
<td style="text-align: left;">低</td>
<td style="text-align: left;">中</td>
</tr>
<tr>
<td style="text-align: left;">外部依赖</td>
<td style="text-align: left;">无</td>
<td style="text-align: left;">需要 CR 存储</td>
</tr>
</tbody>
</table>
<h4 id="6052">60.5.2 配置示例<a class="headerlink" href="#6052" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whereabouts-net</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span>
<span class="w">    </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span>
<span class="w">    </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts-network&quot;,</span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;macvlan&quot;,</span>
<span class="w">    </span><span class="s">&quot;master&quot;:</span><span class="nv"> </span><span class="s">&quot;eth1&quot;,</span>
<span class="w">    </span><span class="s">&quot;mode&quot;:</span><span class="nv"> </span><span class="s">&quot;bridge&quot;,</span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;whereabouts&quot;,</span>
<span class="w">      </span><span class="s">&quot;range&quot;:</span><span class="nv"> </span><span class="s">&quot;192.168.100.0/24&quot;,</span>
<span class="w">      </span><span class="s">&quot;exclude&quot;:</span><span class="nv"> </span><span class="s">[</span>
<span class="w">        </span><span class="s">&quot;192.168.100.0/32&quot;,</span>
<span class="w">        </span><span class="s">&quot;192.168.100.1/32&quot;,</span>
<span class="w">        </span><span class="s">&quot;192.168.100.255/32&quot;</span>
<span class="w">      </span><span class="s">]</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">  </span><span class="s">}&#39;</span>
</code></pre></div>
<h3 id="606-cilium-ipam">60.6 Cilium IPAM<a class="headerlink" href="#606-cilium-ipam" title="Permanent link">&para;</a></h3>
<h4 id="6061">60.6.1 块分配机制<a class="headerlink" href="#6061" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Cilium IPAM&quot;
        Pool[&quot;集群 Pod CIDR: 10.0.0.0/8&quot;]

        B1[&quot;Block 1: 10.0.0.0/26&lt;br/&gt;（64 个 IP）&quot;]
        B2[&quot;Block 2: 10.0.0.64/26&lt;br/&gt;（64 个 IP）&quot;]
        B3[&quot;Block 3: 10.0.0.128/26&lt;br/&gt;（64 个 IP）&quot;]

        Pool --&gt; B1
        Pool --&gt; B2
        Pool --&gt; B3

        B1 --&gt; N1[&quot;Node 1&quot;]
        B2 --&gt; N2[&quot;Node 2&quot;]
        B3 --&gt; N3[&quot;Node 3&quot;]
    end
</code></pre></div>
<p><strong>Cilium 特点</strong>：</p>
<ul>
<li>使用 /26 块（64 个 IP）而非 /24</li>
<li>块可以动态扩展</li>
<li>支持更灵活的 IP 管理</li>
</ul>
<h4 id="6062-host-local">60.6.2 与 host-local 对比<a class="headerlink" href="#6062-host-local" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">特性</th>
<th style="text-align: left;">host-local (/24)</th>
<th style="text-align: left;">Cilium (/26 块)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">每节点 IP 数</td>
<td style="text-align: left;">254</td>
<td style="text-align: left;">可扩展（多块）</td>
</tr>
<tr>
<td style="text-align: left;">IP 利用率</td>
<td style="text-align: left;">可能浪费</td>
<td style="text-align: left;">更高效</td>
</tr>
<tr>
<td style="text-align: left;">灵活性</td>
<td style="text-align: left;">低</td>
<td style="text-align: left;">高</td>
</tr>
</tbody>
</table>
<h3 id="607-vpc-ipam">60.7 公有云 VPC IPAM<a class="headerlink" href="#607-vpc-ipam" title="Permanent link">&para;</a></h3>
<h4 id="6071">60.7.1 云厂商方案<a class="headerlink" href="#6071" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph LR
    subgraph &quot;公有云方案&quot;
        AWS[&quot;AWS VPC CNI&quot;]
        Ali[&quot;阿里云 Terway&quot;]
        GCP[&quot;GCP VPC-native&quot;]
        Tencent[&quot;腾讯云 TKE CNI&quot;]
    end

    VPC[&quot;VPC 网络&quot;] --&gt; AWS
    VPC --&gt; Ali
    VPC --&gt; GCP
    VPC --&gt; Tencent
</code></pre></div>
<p><strong>特点</strong>：</p>
<ul>
<li>直接使用 VPC 子网 IP</li>
<li>Pod IP 与 VPC 路由互通</li>
<li>无需 Overlay 封装</li>
</ul>
<h4 id="6072-terway">60.7.2 阿里云 Terway 示例<a class="headerlink" href="#6072-terway" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TB
    subgraph &quot;Terway 架构&quot;
        VPC[&quot;VPC 网络&quot;]
        ENI[&quot;弹性网卡 ENI&quot;]
        Pod[&quot;Pod&quot;]

        VPC --&gt; ENI
        ENI --&gt; Pod
    end

    subgraph &quot;组件&quot;
        Terway[&quot;Terway CNI&lt;br/&gt;Network Links&quot;]
        Cilium[&quot;Cilium&lt;br/&gt;Network Policy&quot;]
    end
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>Terway = VPC Network Links + Cilium Policy</strong></p>
<ul>
<li>Network Links：基于 ENI 实现 VPC 互通</li>
<li>Policy：使用 Cilium 实现网络策略</li>
</ul>
</blockquote>
<h3 id="608-spiderpool-ipam">60.8 Spiderpool IPAM<a class="headerlink" href="#608-spiderpool-ipam" title="Permanent link">&para;</a></h3>
<h4 id="6081-ipam">60.8.1 新一代集群级 IPAM<a class="headerlink" href="#6081-ipam" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[&quot;Spiderpool&quot;] --&gt; B[&quot;Cluster-Wide IPAM&quot;]
    B --&gt; C[&quot;多 IP 池支持&quot;]
    C --&gt; D[&quot;IP 固定/预留&quot;]
    D --&gt; E[&quot;与 whereabouts 对比增强&quot;]
</code></pre></div>
<p><strong>Spiderpool 特性</strong>：</p>
<ul>
<li>来自 DaoCloud 开源</li>
<li>解决 IP 固定问题</li>
<li>支持多 IP 池定义</li>
<li>与 whereabouts 功能对比增强</li>
</ul>
<h4 id="6082">60.8.2 解决的问题<a class="headerlink" href="#6082" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant Pod as Pod
    participant IPAM as Spiderpool
    participant Pool as IP Pool

    Note over Pod, Pool: 问题场景：IP 未释放时重启
    Pod-&gt;&gt;IPAM: 请求 IP
    IPAM-&gt;&gt;Pool: 从多 IP 池分配
    Pool--&gt;&gt;IPAM: 返回可用 IP
    IPAM--&gt;&gt;Pod: 分配 IP

    Note over Pod, Pool: 支持多 IP 池避免单点问题
</code></pre></div>
<h3 id="609-ipam">60.9 IPAM 选型建议<a class="headerlink" href="#609-ipam" title="Permanent link">&para;</a></h3>
<h4 id="6091">60.9.1 决策流程<a class="headerlink" href="#6091" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[&quot;选择 IPAM&quot;] --&gt; B{&quot;场景类型?&quot;}

    B --&gt;|&quot;通用 K8s&quot;| C[&quot;host-local&quot;]
    B --&gt;|&quot;多网卡 Multus&quot;| D{&quot;需要固定 IP?&quot;}
    B --&gt;|&quot;公有云&quot;| E[&quot;云厂商 VPC IPAM&quot;]

    D --&gt;|&quot;是&quot;| F[&quot;static / Spiderpool&quot;]
    D --&gt;|&quot;否&quot;| G[&quot;whereabouts&quot;]

    C --&gt; H[&quot;简单高效&lt;br/&gt;Flannel 默认&quot;]
    F --&gt; I[&quot;多网卡固定 IP&lt;br/&gt;VM 风格 Pod&quot;]
    G --&gt; J[&quot;集群级 IP 池&lt;br/&gt;跨节点分配&quot;]
    E --&gt; K[&quot;VPC 互通&lt;br/&gt;无 Overlay&quot;]
</code></pre></div>
<h4 id="6092">60.9.2 选型对照表<a class="headerlink" href="#6092" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">场景</th>
<th style="text-align: left;">推荐 IPAM</th>
<th style="text-align: left;">原因</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">通用 K8s 集群</td>
<td style="text-align: left;">host-local</td>
<td style="text-align: left;">简单、稳定、性能好</td>
</tr>
<tr>
<td style="text-align: left;">Multus 多网卡</td>
<td style="text-align: left;">whereabouts</td>
<td style="text-align: left;">集群级 IP 池</td>
</tr>
<tr>
<td style="text-align: left;">固定 IP 需求</td>
<td style="text-align: left;">static / Spiderpool</td>
<td style="text-align: left;">支持 IP 固定</td>
</tr>
<tr>
<td style="text-align: left;">公有云</td>
<td style="text-align: left;">云厂商 IPAM</td>
<td style="text-align: left;">VPC 原生互通</td>
</tr>
<tr>
<td style="text-align: left;">NFV/电信</td>
<td style="text-align: left;">whereabouts + static</td>
<td style="text-align: left;">复杂网络需求</td>
</tr>
</tbody>
</table>
<h3 id="6010">60.10 章节小结<a class="headerlink" href="#6010" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mindmap
  root((CNI IPAM))
    IPAM 类型
      DHCP（少用）
      host-local（常用）
      static（多网卡）
      whereabouts（集群级）
    host-local
      节点子网分配
      简单高效
      Flannel 默认
    whereabouts
      Cluster-Wide
      IP 可迁移
      Multus 推荐
    云厂商
      VPC 互通
      ENI 直通
      Terway 等
    新方案
      Spiderpool
      多 IP 池
      IP 固定
</code></pre></div>
<blockquote>
<p>[!TIP]
<strong>CNI IPAM 要点总结</strong>：</p>
<ol>
<li>
<p><strong>CNI 双核心</strong>：Network Links（网络通路）+ IPAM（地址管理）</p>
</li>
<li>
<p><strong>host-local</strong>：节点级分配，简单高效，Flannel 等通用 CNI 默认使用</p>
</li>
<li>
<p><strong>static</strong>：固定 IP，适用于多网卡、VM 风格 Pod</p>
</li>
<li>
<p><strong>whereabouts</strong>：集群级 IP 池，适用于 Multus 多网卡场景</p>
</li>
<li>
<p><strong>云厂商</strong>：VPC 原生 IPAM，Pod 直接使用 VPC IP，无 Overlay</p>
</li>
<li>
<p><strong>选型原则</strong>：根据场景选择，简单场景用 host-local，复杂多网卡用 whereabouts/Spiderpool</p>
</li>
</ol>
</blockquote>
<hr />

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            回到页面顶部
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../../../basic/9-install-keepalived-cluster/" class="md-footer__link md-footer__link--prev" aria-label="上一页: kubernetes 项目二" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              kubernetes 项目二
            </div>
          </div>
        </a>
      
      
        
        <a href="../../monitoring/2025-12-24-Prometheus_Learning_Notes/" class="md-footer__link md-footer__link--next" aria-label="下一页: kubernetes 监控学习笔记" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              kubernetes 监控学习笔记
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 lixie
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/cnych" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://hub.docker.com/r/cnych/" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/cnych" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://instagram.com/cnych" target="_blank" rel="noopener" title="instagram.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections", "navigation.instant.prefetch", "navigation.prune", "navigation.tabs", "navigation.tabs.sticky", "navigation.expand", "navigation.indexes", "navigation.top", "search.suggest", "search.highlight", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.01824240.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e8a254df.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="../../../js/baidu-tongji.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>